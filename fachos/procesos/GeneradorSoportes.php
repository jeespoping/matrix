<?php
include_once("conex.php"); session_start();if(!isset($_SESSION['user'])){	die('error');}

$caracteres  = array("á","é","í","ó","ú","Á","É","Í","Ó","Ú","ñ","Ñ","ü","Ü",",","/","à","è","ì","ò","ù","À","È","Ì","Ò","Ù","Â","§","®","'","?æ","??", "?£");$caracteres2 = array("a","e","i","o","u","A","E","I","O","U","n","N","u","U","-","-","-","a","e","i","o","u","A","E","I","O","U","A","S"," ","","N","N", "U");$hoy  = date("Y-m-d");$hora = date("H:i:s");DEFINE( "ORIGEN","definicion" );DEFINE( "LOG","000021" );function insertLog( $conex, $wbasedato, $user_session, $accion, $tabla, $err, $descripcion, $identificacion, $sql_error = "", $responsable, $plan, $servicio, $soporte ){    $descripcion = str_replace("'",'"',$descripcion);    $sql_error = ereg_replace('([ ]+)',' ',$sql_error);    $insert = " INSERT INTO ".$wbasedato."_".LOG."                    (Medico, Fecha_data, Hora_data, logori, Logcdu, Logemp, Logpln, Logser, Logsop, Logacc, Logtab, Logerr, Logsqe, Logdes, Loguse, Logest, Seguridad)                VALUES                    ('".$wbasedato."','".date("Y-m-d")."','".date("H:i:s")."', '".ORIGEN."', '".utf8_decode($identificacion)."', '".$responsable."', '".$plan."', '".$servicio."', '".$soporte."', '".utf8_decode($accion)."','".$tabla."','".$err."', '".$sql_error."','".$descripcion."','".$user_session."','on','C-".$user_session."')";	    $res = mysql_query($insert,$conex) or die("Error: " . mysql_errno() . " - en el query (Insertar En Log): " . $insert . " - " . mysql_error());}function buscarFormatos( $id, $fi, $array_formatos ){	$formatos = "<select id='slc_formato_{$id}'>";	foreach($array_formatos as $keyFormato=>$descripcion)	{		($keyFormato == $fi) ?  $selected = "selected" : $selected = "";		$formatos .= "<option value='{$keyFormato}' ".$selected.">{$descripcion}</option>";	}	$formatos .= "<select>";	return($formatos);}function buscarNiveles( $id, $nivel ){	$niveles = "<select id='slc_nivel_{$id}'>";	for( $i = 1 ; $i <= 5 ; $i++ )	{		($i == ($nivel*1) ) ?  $selected = "selected" : $selected = "";		$niveles .= "<option value='{$i}' ".$selected.">{$i}</option>";	}	$niveles .= "<select>";	return($niveles);}function buscarServicios($servicios){	global $conex;	$query = "SELECT sercod codigo, serdes nombre 				FROM fachos_000008			   WHERE serest = 'on'";	$rs = mysql_query( $query, $conex ) or die( mysql_error() );	while( $row = mysql_fetch_array( $rs ) )	{		$servicios[$row['codigo']]['nombre'] = $row['nombre'];	}	return($servicios);}function generarDivSoporte($keySoporte, $soportesActivos, $servicios, $nombre){	$listaServicios = explode( ",", $soportesActivos[$keySoporte]['servicios'] );	$i = 0;	( array_key_exists($keySoporte, $soportesActivos) ) ? $verificarServicios = true : $verificarServicios = false;		$div = "<div id='div_servicios_{$keySoporte}' align='center' style='display:none; cursor:default; background:none; repeat scroll 0 0; position:relative; width:98%; height:98%; overflow:auto;'>";		$div .= "<table id='tbl_servicios_{$keySoporte}' name='tbl_servicios_{$keySoporte}'>";		$div .= "<tr class='encabezadotabla' align='center'><td colspan=3>LISTA DE SERVICIOS</td><tr>";		$div .= "<tr class='encabezadotabla'><td colspan=1>SOPORTE: </td><td colspan=2>({$keySoporte}) - ".$nombre."</td><tr>";		$div .= "<tr class='encabezadotabla'><td align='center'>REQUERIDO</td><td align='center'>CODIGO</td><td>NOMBRE</td><tr>";			foreach ( $servicios as $keyServicio => $datosServicio )			{				$i++;				if( $verificarServicios )				{					$ubicacion = array_search( $keyServicio, $listaServicios );					( $ubicacion !== false ) ? $checked = "checked='checked'" : $checked = "";									}				(is_int($i/2)) ? $wclass=  "fila1" : $wclass = "fila2" ;				$div .= "<tr class='{$wclass}'>"; 					$div .= "<td align='center'><input type='checkbox' ".$checked." id='chk_soporte_servicio_{$keySoporte}_{$keyServicio}' name='chk_soporte_servicio_{$keySoporte}_{$keyServicio}'></td>";					$div .= "<td align='center'>{$keyServicio}</td>";					$div .= "<td>".$datosServicio['nombre']."</td>";				$div .= "<tr>";			}		$div .= "</table>";		$div .= "<br>";		$div .= "<div><input type='button' value='GUARDAR' onclick='guardarServicios(\"{$keySoporte}\")'></div>";	$div .= "</div>";	return($div);}function generarDivResponsables( $keySoporte, $soportesActivos, $responsablesActivos, $responsables, $nombre, $procesosArray ){	$i = 0;	$responsableActivo = 0;		/*echo "<pre>";		print_r( $responsables );	echo "</pre>";*/	//( !isset( $responsablesActivos[$keySoporte] ) ) ? $responsablesActivos[$keySoporte] = array() : $responsablesActivos[$keySoporte] = "";	( array_key_exists($keySoporte, $soportesActivos) ) ? $verificarResponsables = true : $verificarResponsables = false;		$div = "<div class='fila2' id='div_responsables_{$keySoporte}'  align='center' style='display:none; cursor:default; repeat scroll 0 0; position:relative; width:98%; height:98%; overflow:auto;'>";				foreach ( $procesosArray as $keyProceso => $nombreProceso )		{			/*echo $keyProceso."\n-------------------------";				echo "<pre>";					print_r( $responsables[$keyProceso] );				echo "</pre>";*/			$div2 = "";			$participantes  = count( $responsables[$keyProceso] );			foreach ( $responsables[$keyProceso] as $keyResponsable => $datosResponsable )			{				$responsableActivo = 0;				$i++;				if( $verificarResponsables )				{					if( !isset( $responsablesActivos[$keySoporte][$keyProceso] ) ) 						$responsablesActivos[$keySoporte][$keyProceso] = array();					if(array_key_exists( $keyResponsable, $responsablesActivos[$keySoporte][$keyProceso] ) )					{						$checked = "checked='checked'" ;						$responsableActivo = 1;					}else						{							$checked = "";						}									}				(is_int($i/2)) ? $wclass=  "fila2" : $wclass = "fila1" ;				$div2 .= "<tr class='{$wclass}'>"; 					$div2 .= "<td align='center'><input type='radio' ".$checked." id='chk_soporte_responsables_{$keySoporte}_{$keyResponsable}_{$keyProceso}' name='chk_responsable_servicio_{$keySoporte}_{$keyProceso}' onclick='asignarResponsable(\"{$keySoporte}\", \"{$keyResponsable}\", \"{$keyProceso}\")'></td>";					$div2 .= "<td align='center'>{$keyResponsable}</td>";					$div2 .= "<td>".$datosResponsable['nombre']."</td>";				$div2 .= "<tr>";			}			$div .= "<table id='tbl_responsables_{$keySoporte}_{$keyProceso}' name='tbl_responsables_{$keySoporte}' participantes='{$participantes}' style='border:1px solid; border-color:#2A5DB0;' responsableActivo='{$responsableActivo}'>";			$div .= "<tr class='encabezadotabla' align='center'><td colspan=3>LISTA DE RESPONSABLES PROCESO: {$nombreProceso}</td><tr>";			$div .= "<tr class='encabezadotabla'><td colspan=1>SOPORTE: </td><td colspan=2>({$keySoporte}) - ".$nombre."</td><tr>";			$div .= "<tr class='encabezadotabla'><td align='center'>RESPONSABLE</td><td align='center'>CODIGO</td><td>NOMBRE</td><tr>";			$div .= $div2;			$div .= "</table>";			$div .= "<br>";		 }		 		$div .= "<div><input type='button' value='GUARDAR' onclick='guardarResponsables(\"tbl_responsables_{$keySoporte}\")'></div>";		$div .= "<br>";		$div .= "<div><input type='button' value='CERRAR' onclick='quitarSeleccion( \"{$keySoporte}\" );'></div>";	$div .= "</div>";	return($div);}if( $peticionAjax == 'buscarPlanes'){	$planes = array();	$options = "";	$caracteres = array("á","é","í","ó","ú","Á","É","Í","Ó","Ú","ñ","Ñ","ü","Ü",",","/","à","è","ì","ò","ù","À","È","Ì","Ò","Ù","Â","§","®","'");	$caracteres2 = array("a","e","i","o","u","A","E","I","O","U","n","N","u","U","-","-","-","a","e","i","o","u","A","E","I","O","U","A","S"," ","");	$query =  "SELECT plncod codigo, plndes nombre				 FROM fachos_000007, fachos_000009				WHERE pememp = '{$wempresa}'				  AND plncod = pempln				  AND pemest = 'on'				  AND plnest = 'on'";	$rs = mysql_query( $query, $conex );	while( $row = mysql_fetch_array( $rs ) )	{		$row['nombre'] = str_replace( $caracteres, $caracteres2, $row['nombre'] );		array_push( $planes, trim($row['codigo']).", ".trim($row['nombre']) );		$options .= "<option value='".trim($row['codigo']).", ".trim($row['nombre'])."'>".trim($row['codigo']).", ".trim($row['nombre'])."</option>";	}	$planes = json_encode($planes);	$data = array("planes"=>$planes, "options"=>$options);		echo json_encode($data);	return;}if( $peticionAjax == 'generarListado' ){	$soportesActivos = array();		$servicios       = array();	$responsables    = array();	$procesosArray   = array();	$responsablesActivos = array();	$servicios 		 = buscarServicios(&$servicios);	$divsServicios   = "";	$divsSoportes    = "";		if($tipoBusqueda == 'e')	{		$query = "SELECT id pemcod				    FROM fachos_000009				   WHERE pememp = '{$wempresa}'				     AND pempln = '{$wplan}'";		$rs = mysql_query( $query,$conex );		$row = mysql_fetch_array( $rs );		$codigo_empresa_plan = $row[0];				//SOPORTES ACTIVOS PARA LA EMPRESA Y EL PLAN DETERMINADOS		$querySopEmp = "SELECT sessop codigo, sesser servicios						  FROM fachos_000010						 WHERE sesepl = '{$codigo_empresa_plan}'						   AND sesest = 'on'";		$rs = mysql_query( $querySopEmp );		while( $row = mysql_fetch_array( $rs ) )		{			$soportesActivos[$row['codigo']]['servicios'] = $row['servicios'];		}						$query = "SELECT sopcod codigo, sopnom nombre, soptif formato					FROM fachos_000006 				   WHERE sopest = 'on'";		$rs = mysql_query( $query, $conex ) or die( mysql_error() );		while( $row = mysql_fetch_array( $rs ) )		{			$soportes[$row['codigo']]['nombre'] = $row['nombre'];			$soportes[$row['codigo']]['formato'] = $row['formato'];		}				//------------------------------------------------------------CONSULTO LOS DIFERENTES FORMATOS EN LOS QUE SE PUEDE PRESENTAR UN SOPORTE---------------------------------------//		$query = "SELECT Detval					FROM root_000051				   WHERE Detemp = '{$wemp_pmla}'					 AND Detapl = 'formatosSoportesFacturacion'";				$rs = mysql_query( $query, $conex );		while( $row = mysql_fetch_array( $rs ) )		{			$formatos = explode( ",", $row[0] );			foreach( $formatos as $keyFormato=>$datos )			{				$formato = explode( "_", $formatos[$keyFormato] ); 				$formatosArray[$formato[0]] = $formato[1];			}		}				//----------------------------------------------------------------------------CONSULTO LOS DIFERENTES ROLES EXISTENTES -------------------------------------------------------------------------//				$query = "SELECT a.rolcod  codigo, a.roldes nombre, b.dprcod proceso				    FROM {$wfachos}_000015 a						 INNER JOIN 						 {$wfachos}_000018 b ON ( a.rolcod = b.dprori OR a.rolcod = b.dprdes )				   WHERE rolest= 'on'				   GROUP BY codigo, proceso";		$rs = mysql_query( $query, $conex );				while( $row = mysql_fetch_array( $rs ) )		{			$row['nombre'] = str_replace( $caracteres, $caracteres2, $row['nombre'] );			$responsables[$row['proceso']][trim($row['codigo'])]['nombre'] = $row['nombre'];		}				//---------------------------------------------------------------------------------CONSULTO RESPONSABLES ACTIVOS---------------------------------------------------------------------//				$query = "SELECT serpro proceso, sersop soporte, serres codigo				    FROM {$wfachos}_000019				   WHERE seremp = '{$wempresa}'				     AND serpln = '{$wplan}'					 AND serest = 'on'";		$rs = mysql_query( $query, $conex );		while( $row = mysql_fetch_array( $rs ) )		{			$row['nombre'] = str_replace( $caracteres, $caracteres2, $row['nombre'] );			$responsablesActivos[trim($row['soporte'])][$row['proceso']][$row['codigo']] = "";		}				//--------------------------------------------------------------------------------CONSULTO TODOS LOS PROCESOS DEFINIDOS ---------------------------------------------------------------//				$query = "SELECT procod codigo, pronom nombre					FROM {$wfachos}_000014				   WHERE proest = 'on'";				$rs = mysql_query( $query, $conex );		while( $row = mysql_fetch_array( $rs ) )		{ 			$procesosArray[$row[0]] = $row[1];		}		//CONSULTA DE LOS DIFERENTES TIPO DE FORMATO		$tabla = "<span class='subtituloPagina2'>EMPRESA: {$wnombreEmpresa}</span><br>";		$tabla .= "<span class='subtituloPagina2'>PLAN: {$wnombrePlan}</span>";		$tabla .= "<br><br>";		$tabla .= "<table id='tbl_listadoEmpresa' name='tbl_listadoEmpresa'>";		$tabla .= "<tr class='encabezadotabla'><th colspan=6 align='center'>LISTADO DE SOPORTES </th></tr>";		$tabla .= "<tr class='encabezadotabla'>";			$tabla .= "<th align='center'>APLICAR</th>";			$tabla .= "<th align='center'>CODIGO</th>";			$tabla .= "<th align='center'>DESCRIPCION</th>";			$tabla .= "<th align='center'>SERVICIOS</th>";			$tabla .= "<th align='center'>RESPONSABLES</th>";		$tabla .= "</tr>";			$i = 0;			foreach($soportes as $keySoporte=>$datos)			{				$divsSoportes .= generarDivSoporte( $keySoporte, &$soportesActivos, &$servicios, utf8_encode($datos['nombre']) ); //el div con los servicios asociados a dicho soporte				$divsResponsables .= generarDivResponsables ( $keySoporte, &$soportesActivos, &$responsablesActivos, &$responsables, utf8_encode($datos['nombre']), &$procesosArray );				( array_key_exists( $keySoporte, $soportesActivos ) ) ? $checked = "checked" : $checked = "";				$i++;				(is_int($i/2)) ? $wclass = "fila1" : $wclass = "fila2";				$tabla .= "<tr>";					/** 2013-03-12 **/					$tabla .= "<td class='{$wclass}' align='center'><input type='checkbox' ".$checked." id='chk_{$keySoporte}' onclick='actualizarSoporteEmpresa(this)'></td>";					$tabla .= "<td class='{$wclass}' align='center'>{$keySoporte}</td>";					$tabla .= "<td class='{$wclass}'>".utf8_encode($datos['nombre'])."</td>";					if( $checked != "" )						$habilitado = "s";						else							$habilitado = "n";				$tabla .= "<td id='td_{$keySoporte}' style='cursor:pointer' align='center' habilitado='{$habilitado}' onclick='mostrarDivServicios(\"{$keySoporte}\", this)' class='{$wclass}'><font color='blue'> Elegir </font></td>";				$tabla .= "<td id='res_{$keySoporte}' class='{$wclass}'  habilitado='{$habilitado}' style='cursor:pointer' align='center' onclick='mostrarDivResponsables(\"{$keySoporte}\", this)'><font color='blue'>Editar</font></td>";				$tabla .= "</tr>";			}		$tabla .= "</table>";		$tabla .= "<input type=hidden name='wempresa_plan' id='wempresa_plan' value='{$codigo_empresa_plan}'>";		$tabla .= "<input type=hidden name='wservicio' id='wservicio' value='{$wservicio}'>";		$tabla .= "<input type=hidden name='wtipo_generacion' id='wtipo_generacion' value='{$tipoBusqueda}'>";	}	$data = array( 'listado'=>$tabla, 'divs'=>$divsSoportes, 'divResponsables'=>$divsResponsables );	echo json_encode($data);	return;}if( $peticionAjax == 'actualizarSoporteEmpresa' ){		if($wtipo_generacion == 'e')//ACTUALIZANDO REGISTROS DE SOPORTES POR EMPRESAS	{		if($waccion == 'add')		{			$query = "INSERT 						INTO fachos_000010 (Medico, Fecha_data, Hora_data, sessop, sesepl, sesser, sesest, seguridad)					  VALUES ('fachos','{$hoy}','{$hora}','{$wcodigoSoporte}','{$wempresa_plan}','','on', 'usuario')";			$accion = "INSERT";			$descripcion    = "Adicion de un soporte de la lista de requeridos";		}		else			{				$query = "DELETE							FROM fachos_000010						   WHERE sessop = '{$wcodigoSoporte}'							 AND sesepl = '{$wempresa_plan}' 							 AND sesest = 'on'";				$query2 = "DELETE							 FROM fachos_000019							WHERE seremp = '{$wemp}'							  AND serpln = '{$wpln}'							  AND sersop = '{$wcodigoSoporte}'";				$rs2 = mysql_query( $query2, $conex );				$accion = "DELETE";				$descripcion    = "Eliminacion de un soporte de la lista de requeridos";			}	}	//$rs = mysql_query( $query, $conex );	if( $rs    = mysql_query( $query, $conex ) )	{		$identificacion = "";		insertLog( $conex, $wfachos, $usuario, $accion, "000010", $err, $descripcion, $identificacion, $sql_error = '', $wemp, $wpln, '', $wcodigoSoporte );	}	$data = array('rs'=>$query2);	echo json_encode($data);	return;}if( $peticionAjax == 'agregarServicios' ){	$query = "UPDATE fachos_000010			     SET sesser = '{$wservicios}' 			   WHERE sessop = '{$wsoporte}'			     AND sesepl = '{$wempresa_plan}' ";	//$rs = mysql_query( $query, $conex );	if( $rs    = mysql_query( $query, $conex ) )	{		$accion 	    = "UPDATE";		$descripcion    = "Actualizacion de servicios en los que se solicita el soporte";		$identificacion = "";		insertLog( $conex, $wfachos, $usuario, $accion, "000011", $err, $descripcion, $identificacion, $sql_error = '', $wempresa_plan, '', '', $wcodigoSoporte );	}	return;}if( $peticionAjax == 'asignarResponsable' ){	if( $waccion == "add" )	{		$query = " INSERT 					INTO {$wfachos}_000019						 ( Medico, Fecha_data, Hora_data, serpro, sersop, seremp, serpln, serres, serest, Seguridad )				  VALUES ( 'fachos', '{$hoy}', '{$hora}', '{$wproceso}', '{$wsoporte}', '{$wemp}', '{$wpln}', '{$wresponsable}', 'on', '{$usuario}'  )";	}else		{			$query = " UPDATE {$wfachos}_000019						  SET serres = '{$wresponsable}'						WHERE seremp = '{$wemp}'						  AND serpln = '{$wpln}'						  AND serpro = '{$wproceso}'						  AND sersop = '{$wsoporte}'";		}	//$rs = mysql_query( $query, $conex );	if( $rs    = mysql_query( $query, $conex ) )	{		$accion 	    = "UPDATE";		$descripcion    = "Asignacion del rol {$wresponsable}, como reponsable";		$identificacion = "";		insertLog( $conex, $wfachos, $usuario, $accion, "000011", $err, $descripcion, $identificacion, $sql_error = '', $wemp, $wpln, '', $wcodigoSoporte );	}	$data = array( "query"=>$query );	return;}?><html>	<head>		<title> GENERADOR DE SOPORTES PARA FACTURACION POR EMPRESA Y SERVICIO</title>	</head>	<style>		.tabla td{			font-family: Verdana, Arial, Helvetica, sans-serif;			font-size:12px;			nowrap: nowrap;		}			</style>	<script type='text/javascript' src='../../../include/root/jquery-1.3.2.js'></script>	<link rel="stylesheet" href="../../../include/root/jquery_1_7_2/css/themes/base/jquery-ui.css" />	<script src="../../../include/root/jquery_1_7_2/js/jquery-ui.js" type="text/javascript"></script>	<script type='text/javascript' src='../../../include/root/jquery.blockUI.min.js'></script>	<script>	//DECLARACION DE VARIABLES GLOBALES	var empresa;	var plan;	var wemp_pmla;	var wtema;	var wfachos;	var wbd;	var listado;	var contenedor_divs;	var usuario	$(document).ready(function(){		//autocompletar de las empresas		entidades_nombres_array = new Array();		var datosEmpresas = eval( $("#array_empresas").val() );		for( i in datosEmpresas ){			entidades_nombres_array.push( datosEmpresas[i] );		}				 $( "#input_empresa" ).autocomplete({				source: entidades_nombres_array, minLength : 3,				select: function( event, ui ) { buscarPlanes() }		});				empresa   = jQuery("#input_empresa");		plan 	  = jQuery("#input_plan");		wemp_pmla = $("#wemp_pmla").val();		wtema     = $("#wtema").val();		wfachos   = $("#wfachos").val();		wbd 	  = $("#wbasedato").val();		usuario	  = $("#wusuario").val();		listado   = $("#div_listado");		contenedor_divs = $("#div_servicios_soporte");		$('.ui-corner-all').css('fontSize', '11px');	});		function codigoEmpresa()	{		emp = empresa.val();		emp = emp.split(",");		codigo = $.trim(emp[0]);		return(codigo);	}		function nombreEmpresa()	{		emp = empresa.val();		emp = emp.split(",");		codigo = $.trim(emp[2]);		return(codigo);	}		function codigoPlan()	{		pln = plan.val();		pln = pln.split(",");		codigo = $.trim(pln[0]);		return(codigo);	}		function nombrePlan()	{		pln = plan.val();		pln = pln.split(",");		codigo = $.trim(pln[1]);		return(codigo);	}		function generarListado()	{		wempresa = codigoEmpresa();		wnombreEmpresa = nombreEmpresa();		tipoBusqueda = '';		if($.trim(wempresa)=='')		{			alert('Por favor ingrese una empresa');			return;		}		wplan = codigoPlan();		wnombrePlan = nombrePlan();		if(wempresa != '')			tipoBusqueda = 'e';			else				tipoBusqueda = 's';		$.ajax(			{				url: "GeneradorSoportes.php",				type: "POST",				data: {					 peticionAjax: "generarListado",						wbasedato: wbd,						wemp_pmla: wemp_pmla,							wtema: wtema,						  wfachos: wfachos,					 tipoBusqueda: tipoBusqueda,					   	 wempresa: wempresa,				   wnombreEmpresa: wnombreEmpresa,				   	  wnombrePlan: wnombrePlan,							wplan: wplan					  },				success: function(data)				{					if(data.listado=='')					return;					else						listado.html(data.listado);						contenedor_divs.html(data.divs + data.divResponsables);												$("#tbl_listadoEmpresa").addClass("tabla");						$("#tbl_listadoEmpresa td").css("height","40px");						if($("#chk_verActivos").is(":checked"))							ocultarMostrarSoportes();				},				dataType: "json"			}		);					}		function actualizarSoporteEmpresa(soporte)	{		soporte = jQuery(soporte);		tipo_generacion = $("#wtipo_generacion").val();		empresa_plan = $("#wempresa_plan").val();		codigoSoporte = soporte.attr("id").toString().split("_");		codigoSoporte = codigoSoporte[1];		accion = '';		if(soporte.is(":checked"))		{			accion = 'add';			$("#td_"+codigoSoporte).attr("habilitado", "s");			$("#res_"+codigoSoporte).attr("habilitado", "s");		}else{				if(!(confirm("¿ESTÁ SEGURO QUE DESEA CAMBIAR ESTE SOPORTE A NO REQUERIDO?")))				{					soporte.attr("checked","checked");					return;				}				accion = 'rm';				$("#td_"+codigoSoporte).attr("habilitado", "n");				$("#res_"+codigoSoporte).attr("habilitado", "n");			 }		$.ajax({			url: "GeneradorSoportes.php",			type: "POST",			data:{							 peticionAjax: "actualizarSoporteEmpresa",					wbasedato: wbd,					wemp_pmla: wemp_pmla,						wtema: wtema,					  wfachos: wfachos,					  waccion: accion,				wempresa_plan: empresa_plan,						 wemp: codigoEmpresa,						 wpln: codigoPlan,			 wtipo_generacion: tipo_generacion,			   wcodigoSoporte: codigoSoporte			   				 },			success: function(data){				$("#res_"+codigoSoporte).click();			},			dataType: "json"		});			}		function buscarPlanes()	{		setTimeout(function(){			buscarPlanes2();		},300);	}		function buscarPlanes2()	{		empresaAux = codigoEmpresa();		$.ajax		({			url: "GeneradorSoportes.php",				type: "POST",				beforeSend: buscandoPlan(),				data: {								   	 peticionAjax: "buscarPlanes",						wbasedato: wbd,						wemp_pmla: wemp_pmla,							wtema: wtema,						  wfachos: wfachos,						 wempresa: empresaAux					  },				success: function(data)				{					if(data.planes=='')					{						alert("Sin planes asociados");					return;					}else						{							 $( "#input_plan" ).html(data.options);							 $('#img_esperar_plan').hide();							 $('#img_planes_listos').show();						}				},				dataType: "json"		})	}		function mostrarDivServicios(soporte, td)	{		if($(td).attr("habilitado") == "n")			return;		div = "div_servicios_"+soporte;		$.blockUI({ 							message: $("#"+div),							css: { left: '15%',									top: '15%',								  width: '30%',						    	 height: '50%'								 }					  });	}		function guardarServicios(soporte)	{		servicios = "";		empresaAux = codigoEmpresa();		j = 0;		$("#tbl_servicios_"+soporte+" input:checkbox").each(function(){				check = jQuery(this);				if(check.is(":checked"))				{					cod = check.attr("id").split("_");					servicio = cod[4];					if( j == 0 )						codigo = ""+servicio+"";						else							codigo = ","+servicio+"";						servicios = servicios+codigo;						j++;				}		});		$.ajax({			url: "GeneradorSoportes.php",				type: "POST",				data: {									 peticionAjax: "agregarServicios",						wbasedato: wbd,						wemp_pmla: wemp_pmla,						    wtema: wtema,						  wfachos: wfachos,						 wempresa: empresaAux,						 wsoporte: soporte,					   wservicios: servicios,					wempresa_plan: $("#wempresa_plan").val()										  },				success: function(data)				{				}		})		$.unblockUI();	}		function buscandoPlan()	{		$('#img_esperar_plan').show();		$('#img_planes_listos').hide();	}		function ocultarMostrarSoportes()	{		console.log("ocultar inactivos");		if($("#div_listado").html() != "")		{			$("#tbl_listadoEmpresa input[type=checkbox]:not(:checked)").each(function(){				if($("#chk_verActivos").is(":checked"))					$(this).parents("tr").hide();					else						$(this).parents("tr").show();			});		}	}		function mostrarDivResponsables(soporte, td)	{		if($(td).attr("habilitado") == "n")			return;		div = "div_responsables_"+soporte;		$.blockUI({ 					message: $("#"+div),					css: { left: '30%',							top: '20%',						  width: '40%',						 height: '60%'						}		  });	}		function guardarResponsables( nombreTablas, accion )	{		completo = true;		$( "[name="+nombreTablas+"]" ).each( function(){			checkados = $( this ).find( "input[type=radio]:checked" ).length;			if( checkados == 0 )				completo = false;		});		if( !completo )		{			alert("Debe seleccionar un Responsable en cada Proceso");			return;		}		$.unblockUI();	}		function asignarResponsable( soporte, responsable, proceso )	{		estadoActual = $("#tbl_responsables_"+soporte+"_"+proceso).attr("responsableActivo");		if( estadoActual == "0" )		{			accion = 'add';			$("#tbl_responsables_"+soporte+"_"+proceso).attr( "responsableActivo", "1" );		}else{				accion = 'upd';			 }			 		$.ajax({			url: "GeneradorSoportes.php",			type: "POST",			data:{							 peticionAjax: "asignarResponsable",					wbasedato: wbd,					wemp_pmla: wemp_pmla,						wtema: wtema,					  wfachos: wfachos,					  waccion: accion,						 wemp: codigoEmpresa(),					     wpln: codigoPlan(),					 wsoporte: soporte,				 wresponsable: responsable,					  usuario: usuario,				     wproceso: proceso			   				 },			success: function (data){					//console.log( data.query );				 },			dataType: "json"		});	}		function quitarSeleccion( soporte )	{		$.unblockUI();		$( "#chk_"+soporte ).click();	}</script><body><?phpinclude_once('root/comun.php');$user_session = explode('-',$_SESSION['user']);$user_session = $user_session[1];//FUNCIONES INICIALESfunction inicializarArreglos(){	global $empresas;	global $planes;	global $conex;	global $wbasedato;	$caracteres = array("á","é","í","ó","ú","Á","É","Í","Ó","Ú","ñ","Ñ","ü","Ü",",","/","à","è","ì","ò","ù","À","È","Ì","Ò","Ù","Â","§","®","'","?æ","??", "?£");	$caracteres2 = array("a","e","i","o","u","A","E","I","O","U","n","N","u","U","-","-","-","a","e","i","o","u","A","E","I","O","U","A","S"," ","","N","N", "U");	//formación de arreglo de empresas	$query = "	SELECT Epscod as codigo, Epsnit nit, Epsnom as nombre "			."	  FROM 	{$wbasedato}_000049 "			."	 ORDER BY Epsnom";	$rs = mysql_query( $query, $conex ) or die ( mysql_error() );	$i = 0;	while( $row = mysql_fetch_array($rs) )	{		$row['nombre'] = str_replace( $caracteres, $caracteres2, $row['nombre'] );		array_push( $empresas, trim($row['codigo']).", ".trim($row['nit']).", ".trim($row['nombre']) );	}}function consultarTema( $tema ){	global $wfachos, $conex;		$query = "SELECT temcod codigo			    FROM {$wfachos}_000017			   WHERE temnom = '{$tema}'			     AND temest = 'on'";	$rs = mysql_query( $query, $conex );	$row = mysql_fetch_array( $rs );	return( $row['codigo'] );}$wbasedato = consultarAliasPorAplicacion($conex, $wemp_pmla, "movhos");$wfachos   = consultarAliasPorAplicacion($conex, $wemp_pmla, "Facturacion hospitalaria");encabezado("DEFINICION DE SOPORTES REQUERIDOS POR EMPRESA Y SERVICIOS",$wactualiz, "clinica");//DECLARACIÓN DE VARIABLES;$empresas  = array();$planes	   = array();inicializarArreglos();$empresas = json_encode( $empresas );$planes   = json_encode( $planes );$wtema    = consultarTema( 'facturacion' );//VARIABLES EN HTML(INPUTS) ADICIONALES PARA INICIALIZAR VARIABLES JQUERY Y REALIZAR LOS AUTOCOMPLETAR;echo "<input type='hidden' name='array_empresas' id='array_empresas' value='{$empresas}'>";echo "<input type='hidden' name='array_planes' id='array_planes' value='{$planes}'>";echo "<input type='hidden' name='array_servicios' id='array_servicios' value='{$servicios}'>";echo "<input type='hidden' name='wemp_pmla' id='wemp_pmla' value='{$wemp_pmla}'>";echo "<input type='hidden' name='wfachos' id='wfachos' value='{$wfachos}'>";echo "<input type='hidden' name='wbasedato' id='wbasedato' value='{$wbasedato}'>";echo "<input type='hidden' name='wusuario' id='wusuario' value='{$user_session}'>";echo "<input type='hidden' name='wtema' id='wtema' value='{$wtema}'>";function generarMenuPpal(){	$menu = "<span class='subtituloPagina2'>Parámetros de consulta</span>";	$menu .= "<br><br>";	$menu .= "<table>";	$menu .= "<tr><td align='left' class='fila1'>EMPRESA</td><td class='fila2'><input type='text' value='' name='input_empresa' id='input_empresa' size='70'></td></tr>";	$menu .= "<tr><td class='fila1' align='left'>PLAN</td><td class='fila2'>"; 			$menu .= "<table><tr>"; 				$menu .= "<td width='5%'><div><img id='img_esperar_plan' style='display:none' name='img_esperar_plan' src='../../images/medical/ajax-loader7.gif'><img id='img_planes_listos' style='display:none' name='img_planes_listos' src='../../images/medical/iconos/gifs/i.p.next[1].gif'></div></td><td><select id='input_plan' name='input_plan'></select></td></tr>";				$menu .= "</table>"; 			$menu .="</td></tr>";	$menu .= "<tr><td class='fila1' align='left'>SOLO ACTIVOS</td><td class='fila2'><input type='checkbox' id='chk_verActivos' name='chk_verActivos' onclick='ocultarMostrarSoportes()'></td>"; 	$menu .= "</table>";	$menu .= "<br><br>";	$menu .= "<table>";	$menu .= "<tr><td><input type='button' id='btn_generar' name='btn_generar' value='GENERAR' onclick='generarListado()'></td></tr>";	$menu .= "</table>";	return($menu);}$menu = generarMenuPpal();echo "<div align='center'>";	echo $menu;echo "</div>";echo "<br>";echo "<div align='center' id='div_listado' name='div_listado'>";echo "</div>";echo "<div align='center' id='div_servicios_soporte' name='div_servicios_soporte' >";echo "</div>";echo "<br>";echo "<div id='div_cerrar' align='center'>";echo  "<table>";	echo "<tr><td><input type='button' id='btn_cerrar' name='btn_generar' value='CERRAR' onclick='window.close();'></td></tr>";echo "</table>";echo "</div>";?>	</body></html>