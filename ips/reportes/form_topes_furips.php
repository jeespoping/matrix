<?php
include_once("conex.php"); header("Content-Type: text/html;charset=ISO-8859-1"); ?><!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"><html><head>  <meta content="text/html; charset=ISO-8859-1" http-equiv="content-type">  <title>Consulta de topes de facturación</title></head><body><?php
include_once("conex.php");  /******************************************************************   * 	  CONSULTA DE TOPES DE FACTURACIÓN - FURIPS					*   * -------------------------------------------------------------- *   * Formulario que pide identificación del paciente y muestra los	*   * asociados a él, dando la posibilidad de seleccionar el que 	*   * desee para ver la facturación que se ha tenido en la clinica  	*   * con respecto al accidente seleccionado							*   ******************************************************************/	/*	 * Autor: John M. Cadavid. G.	 * Fecha creacion: 2011-10-04	 * Modificado: 	 * 2011-11-24 - El nombre de la seguradora estatal estaba quemado por lo que 	 * se cambia para que consulte en root_000051 la empresa actual encargada	 */  // Consulta los datos de las aplicaciones  function datos_empresa($wemp_pmla)    {  	  global $user;   	  global $conex;	  global $wbasedato;	  global $wtabcco;	  global $winstitucion;	     	  //Traigo TODAS las aplicaciones de la empresa, con su respectivo nombre de Base de Datos    	  $q = " SELECT detapl, detval, empdes "	      ."   FROM root_000050, root_000051 "	      ."  WHERE empcod = '".$wemp_pmla."'"	      ."    AND empest = 'on' "	      ."    AND empcod = detemp "; 	  $res = mysql_query($q,$conex) or die ("Error: ".mysql_errno()." - en el query: ".$q." - ".mysql_error());	  $num = mysql_num_rows($res); 	  	  if ($num > 0 )	     {		  for ($i=1;$i<=$num;$i++)		     {   		      $row = mysql_fetch_array($res);		      		      if ($row[0] == "movhos")		         $wbasedato=$row[1];			  if ($row[0] == "tabcco")		         $wtabcco=$row[1];			 }  	     }	    else	       echo "NO EXISTE NINGUNA APLICACION DEFINIDAD PARA ESTA EMPRESA";	  	  $winstitucion=$row[2];	          }   	function facturacion_matrix($conex,$wbasedato_farm,$doc,$accidente)	{		global $str_fac_matrix;		global $tot_fac_matrix;		global $j;		$total_lista = 0;				/*		// Consulto código del tipo de empresa SOAT		$q = " SELECT Temcod, Temdes "		  ."     FROM ".$wbasedato_farm."_000029 "		  ."  	WHERE Temvau = 'on' "		  ."	  AND Temest = 'on' ";		$res_soat = mysql_query($q,$conex) or die (mysql_errno()." - ".mysql_error());		$row_soat = mysql_fetch_array($res_soat);		$tipo_soat = $row_soat['Temcod']."-".$row_soat['Temdes'];		// Consulto facturas generadas por Matrix		$qlis = "  SELECT Fenfec, Fenfac, Fenffa, Fencco, (fenval+fenabo+fencmo+fencop+fendes) AS total "			  ."     FROM ".$wbasedato_farm."_000018 "			  ."  	WHERE Fendpa = '".$doc."' "			  ."	  AND Fentip LIKE '".$tipo_soat."' "			  ."	  AND Fennac = '".$accidente."' "			  ."	  AND Fenest = 'on' ";		$reslis = mysql_query($qlis,$conex) or die ("Error: ".mysql_errno()." - en el query: ".$qlis." - ".mysql_error());		$numlis = mysql_num_rows($reslis);		$rowlis = mysql_fetch_array($reslis);				// Ciclo para recorrer todos los registros de la consulta de facturas		while($j<=$numlis)		{						if (is_int ($j/2))			   $wcf="fila1";  // color de fondo de la fila			else			   $wcf="fila2"; // color de fondo de la fila						// Consulto notas créditos generadas por Matrix			$qlis2 =   "   SELECT SUM(Rdevca) AS total "					  ."     FROM ".$wbasedato_farm."_000018, ".$wbasedato_farm."_000021, ".$wbasedato_farm."_000040 "					  ."  	WHERE Fendpa = '".$doc."' "					  ."	  AND Fentip LIKE '".$tipo_soat."' "					  ."	  AND Fennac = '".$accidente."' "					  ."	  AND Fenfac = '".$rowlis['Fenfac']."' "					  ."	  AND Fenffa = '".$rowlis['Fenffa']."' "					  ."	  AND Fenest = 'on' "					  ."	  AND Fenfac = Rdefac "					  ."	  AND Fenffa = Rdeffa "					  ."	  AND Rdefue = Carfue "					  ."	  AND Carncr = 'on' "					  ."	  AND Carest = 'on' "					  ."	GROUP BY Fenfac ";			$reslis2 = mysql_query($qlis2,$conex) or die ("Error: ".mysql_errno()." - en el query: ".$qlis2." - ".mysql_error());			$rowlis2 = mysql_fetch_array($reslis2);			if($rowlis2['total'])				$totalnotas = $rowlis2['total'];			else				$totalnotas = 0;			$totalfac = $rowlis['total']-$totalnotas;						$str_fac_matrix .=  "<tr class='".$wcf."'>";			$str_fac_matrix .=  "<td align='center'>";			$str_fac_matrix .=  "<div align='center'> &nbsp; ".$rowlis['Fenfec']." &nbsp; </div>";			$str_fac_matrix .=  "</td>";			$str_fac_matrix .=  "<td align='left'>";			$str_fac_matrix .=  "<div align='left'> &nbsp; Facturación Clínica &nbsp; </div>";			$str_fac_matrix .=  "</td>";			$str_fac_matrix .=  "<td align='center'>";			$str_fac_matrix .=  "<div align='center'> &nbsp; ".$rowlis['Fenfac']." &nbsp; </div>";			$str_fac_matrix .=  "</td>";			$str_fac_matrix .=  "<td align='center'>";			$str_fac_matrix .=  "<div align='center'> &nbsp; ".$rowlis['Fencco']." &nbsp; </div>";			$str_fac_matrix .=  "</td>";			$str_fac_matrix .=  "<td align='right'>";			$str_fac_matrix .=  "<div align='right'> &nbsp; ".number_format($totalfac,0,'.',',')." &nbsp; </div>";			$str_fac_matrix .=  "</td>";			$str_fac_matrix .=  "</tr>";			$total_lista += $totalfac;			$rowlis = mysql_fetch_array($reslis);			$j++;		}				$tot_fac_matrix = $total_lista;		*/				$tot_fac_matrix = 0;			}		function facturacion_clinica($conex_o,$historia,$accidente)	{		global $str_fac_unix;		global $tot_fac_unix;		global $tot_fac_matrix;		global $j;		$total_lista = 0;			// Consulto las facturas en clínica por historia		$query = "SELECT carfec, cardoc, carcco, carval, carfue "				."  FROM inacc, cacar, famovacc, sifue "				." WHERE acchis = '$historia'"				."   AND accacc = '$accidente'"				."   AND acchis = movacchis"				."   AND accacc = movaccacc"			//	."   AND movaccfuo = '01'"						."   AND movaccanu = '0'"				."   AND carfue = movaccfue"				."   AND cardoc = movaccdoc"				."   AND caranu = '0'"				."   AND movaccfue = fuecod"				."   AND fueabr = 'FA'"				." GROUP BY carfec, carfue, cardoc, carcco, carval";		$err_o = odbc_exec($conex_o,$query);		while(odbc_fetch_row($err_o))		{			if (is_int ($j/2))			   $wcf="fila1";  // color de fondo de la fila			else			   $wcf="fila2"; // color de fondo de la fila			// Consulto las notas crédito para la factura			$queryn = "SELECT carfac, SUM(carval) "					."  FROM cacar, catip "					." WHERE carfca = '".odbc_result($err_o,5)."'"					."   AND carfac = '".odbc_result($err_o,2)."'"					."   AND caranu = '0'"					."   AND carfue = tipfue"					."   AND (tiptip = 'NC' OR tipfue = '28')"					." GROUP BY carfac ";			$err_n = odbc_exec($conex_o,$queryn);			odbc_fetch_row($err_n);				$notasc = odbc_result($err_n,2);			$totalfacu = odbc_result($err_o,4);			$totalfacu = $totalfacu-$notasc;						$str_fac_unix .=  "<tr class='".$wcf."'>";			$str_fac_unix .=  "<td align='center'>";			$str_fac_unix .=  "<div align='center'> &nbsp; ".odbc_result($err_o,1)." &nbsp; </div>";			$str_fac_unix .=  "</td>";			$str_fac_unix .=  "<td align='left'>";			$str_fac_unix .=  "<div align='left'> &nbsp; Facturación Clínica &nbsp; </div>";			$str_fac_unix .=  "</td>";			$str_fac_unix .=  "<td align='center'>";			$str_fac_unix .=  "<div align='center'> &nbsp; ".odbc_result($err_o,2)." &nbsp; </div>";			$str_fac_unix .=  "</td>";			$str_fac_unix .=  "<td align='center'>";			$str_fac_unix .=  "<div align='center'> &nbsp; ".odbc_result($err_o,3)." &nbsp; </div>";			$str_fac_unix .=  "</td>";			$str_fac_unix .=  "<td align='right'>";			$str_fac_unix .=  "<div align='right'> &nbsp; ".number_format($totalfacu,0,'.',',')." &nbsp; </div>";			$str_fac_unix .=  "</td>";			$str_fac_unix .=  "</tr>";						$total_lista += $totalfacu;			$j++;		}		/*		// Consulto las facturas en clínica por ayudas diagnósticas		$query = "SELECT carfec, cardoc, carcco, carval, carfue "				."  FROM inacc, cacar, famovacc, sifue "				." WHERE acchis = '$historia'"				."   AND accacc = '$accidente'"				."   AND accfuo != ''"				."   AND accfuo = movaccfuo"				."   AND accdoo = movacchis"				."   AND movaccanu = '0'"				."   AND carfue = movaccfue"				."   AND cardoc = movaccdoc"				."   AND caranu = '0'"				."   AND movaccfue = fuecod"				."   AND fueabr = 'FA'"				." GROUP BY carfec, carfue, cardoc, carcco, carval";		$err_o = odbc_exec($conex_o,$query);		while(odbc_fetch_row($err_o))		{			if (is_int ($j/2))			   $wcf="fila1";  // color de fondo de la fila			else			   $wcf="fila2"; // color de fondo de la fila						// Consulto las notas crédito para la factura			$queryn = "SELECT carfac, SUM(carval) "					."  FROM cacar, catip "					." WHERE carfca = '".odbc_result($err_o,5)."'"					."   AND carfac = '".odbc_result($err_o,2)."'"					."   AND caranu = '0'"					."   AND carfue = tipfue"					."   AND (tiptip = 'NC' OR tipfue = '28')"					." GROUP BY carfac ";			$err_n = odbc_exec($conex_o,$queryn);			odbc_fetch_row($err_n);				$notasc = odbc_result($err_n,2);			$totalfacu = odbc_result($err_o,4);			$totalfacu = $totalfacu-$notasc;			$str_fac_unix .=  "<tr class='".$wcf."'>";			$str_fac_unix .=  "<td align='center'>";			$str_fac_unix .=  "<div align='center'>  &nbsp; ".odbc_result($err_o,1)." &nbsp; </div>";			$str_fac_unix .=  "</td>";			$str_fac_unix .=  "<td align='center'>";			$str_fac_unix .=  "<div align='center'> &nbsp; ".odbc_result($err_o,2)." &nbsp; </div>";			$str_fac_unix .=  "</td>";			$str_fac_unix .=  "<td align='center'>";			$str_fac_unix .=  "<div align='center'> &nbsp; ".odbc_result($err_o,3)." &nbsp; </div>";			$str_fac_unix .=  "</td>";			$str_fac_unix .=  "<td align='center'>";			$str_fac_unix .=  "<div align='center'> &nbsp; ".number_format($totalfacu,0,'.',',')." &nbsp; </div>";			$str_fac_unix .=  "</td>";			$str_fac_unix .=  "</tr>";						$total_lista += $totalfacu;			$j++;		}		*/				// Consulto los cargos pendientes en clínica		$query = "SELECT cardetfec, cardetdoc, cardetcco, SUM(cardettot-cardetvfa) "				."  FROM inacc, facardet "				." WHERE acchis = '$historia'"				."   AND accacc = '$accidente'"				."   AND acchis = cardethis"				."   AND accnum = cardetnum"				."   AND cardetfac = 'S' "				."   AND cardetanu = '0'"				."   AND cardettot-cardetvfa <> 0"				."   AND cardettip = 'R' "				." GROUP BY 1,2,3 ";		$err_o = odbc_exec($conex_o,$query);				//echo $query."<br>";		while(odbc_fetch_row($err_o))		{			if (is_int ($j/2))			   $wcf="fila1";  // color de fondo de la fila			else			   $wcf="fila2"; // color de fondo de la fila						$str_fac_unix .=  "<tr class='".$wcf."'>";			$str_fac_unix .=  "<td align='center'>";			$str_fac_unix .=  "<div align='center'> &nbsp; ".odbc_result($err_o,1)." &nbsp; </div>";			$str_fac_unix .=  "</td>";			$str_fac_unix .=  "<td align='left'>";			$str_fac_unix .=  "<div align='left'> &nbsp; Cargos Pendientes &nbsp; </div>";			$str_fac_unix .=  "</td>";			$str_fac_unix .=  "<td align='center'>";			$str_fac_unix .=  "<div align='center'> &nbsp; ".odbc_result($err_o,2)." &nbsp; </div>";			$str_fac_unix .=  "</td>";			$str_fac_unix .=  "<td align='center'>";			$str_fac_unix .=  "<div align='center'> &nbsp; ".odbc_result($err_o,3)." &nbsp; </div>";			$str_fac_unix .=  "</td>";			$str_fac_unix .=  "<td align='right'>";			$str_fac_unix .=  "<div align='right'> &nbsp; ".number_format(odbc_result($err_o,4),0,'.',',')." &nbsp; </div>";			$str_fac_unix .=  "</td>";			$str_fac_unix .=  "</tr>";						$total_lista += odbc_result($err_o,4);			$j++;		}		// Consulto los cargos pendientes ayudas diagnósticas		$query = "SELECT cardetfec, cardetdoc, cardetcco, SUM(cardettot-cardetvfa) "				."  FROM inacc, aycardet "				." WHERE acchis = '$historia'"				."   AND accacc = '$accidente'"				."   AND accfuo = cardetfue"				."   AND accdoo = cardetdoc"				."   AND cardetfac = 'S' "				."   AND cardetanu = '0'"				."   AND cardettot-cardetvfa <> 0"				."   AND cardettip = 'R' "				." GROUP BY 1,2,3 ";		$err_o = odbc_exec($conex_o,$query);		while(odbc_fetch_row($err_o))		{			if (is_int ($j/2))			   $wcf="fila1";  // color de fondo de la fila			else			   $wcf="fila2"; // color de fondo de la fila						$str_fac_unix .=  "<tr class='".$wcf."'>";			$str_fac_unix .=  "<td align='center'>";			$str_fac_unix .=  "<div align='center'> &nbsp; ".odbc_result($err_o,1)." &nbsp; </div>";			$str_fac_unix .=  "</td>";			$str_fac_unix .=  "<td align='left'>";			$str_fac_unix .=  "<div align='left'> &nbsp; Cargos pendientes &nbsp; </div>";			$str_fac_unix .=  "</td>";			$str_fac_unix .=  "<td align='center'>";			$str_fac_unix .=  "<div align='center'> &nbsp; ".odbc_result($err_o,2)." &nbsp; </div>";			$str_fac_unix .=  "</td>";			$str_fac_unix .=  "<td align='center'>";			$str_fac_unix .=  "<div align='center'> &nbsp; ".odbc_result($err_o,3)." &nbsp; </div>";			$str_fac_unix .=  "</td>";			$str_fac_unix .=  "<td align='right'>";			$str_fac_unix .=  "<div align='right'> &nbsp; ".number_format(odbc_result($err_o,4),0,'.',',')." &nbsp; </div>";			$str_fac_unix .=  "</td>";			$str_fac_unix .=  "</tr>";						$total_lista += odbc_result($err_o,4);			$j++;		}		// Consulto novedades cargadas en clínica		$query = "SELECT novaccfec, novaccfac, '', novaccval, novacchis, novaccacc "				."  FROM inacc, fanovacc "				." WHERE acchis = '$historia'"				."   AND accacc = '$accidente'"				."   AND acchis = novacchis"				."   AND accacc = novaccacc"				."   AND novaccval <> 0 "				." GROUP BY  novaccfec, novacchis, novaccacc, novaccfac, novaccval";		$err_o = odbc_exec($conex_o,$query);		while(odbc_fetch_row($err_o))		{			if (is_int ($j/2))			   $wcf="fila1";  // color de fondo de la fila			else			   $wcf="fila2"; // color de fondo de la fila						$str_fac_unix .=  "<tr class='".$wcf."'>";			$str_fac_unix .=  "<td align='center'>";			$str_fac_unix .=  "<div align='center'> &nbsp; ".odbc_result($err_o,1)." &nbsp; </div>";			$str_fac_unix .=  "</td>";			$str_fac_unix .=  "<td align='left'>";			$str_fac_unix .=  "<div align='left'> &nbsp; Novedades &nbsp; </div>";			$str_fac_unix .=  "</td>";			$str_fac_unix .=  "<td align='center'>";			$str_fac_unix .=  "<div align='center'> &nbsp; ".odbc_result($err_o,2)." &nbsp; </div>";			$str_fac_unix .=  "</td>";			$str_fac_unix .=  "<td align='center'>";			$str_fac_unix .=  "<div align='center'> &nbsp; ".odbc_result($err_o,3)." &nbsp; </div>";			$str_fac_unix .=  "</td>";			$str_fac_unix .=  "<td align='right'>";			$str_fac_unix .=  "<div align='right'> &nbsp; ".number_format(odbc_result($err_o,4),0,'.',',')." &nbsp; </div>";			$str_fac_unix .=  "</td>";			$str_fac_unix .=  "</tr>";						$total_lista += odbc_result($err_o,4);			$j++;		}		$tot_fac_unix = $total_lista;		$total_lista = $tot_fac_unix+$tot_fac_matrix;		$str_fac_unix .=  "<tr class='encabezadoTabla'>";		$str_fac_unix .=  "<td colspan='4' align='center'>";		$str_fac_unix .=  "<div align='left'> &nbsp;&nbsp;&nbsp;&nbsp; TOTAL &nbsp; </div>";		$str_fac_unix .=  "</td>";		$str_fac_unix .=  "<td align='right'>";		$str_fac_unix .=  "<div align='right'> &nbsp; ".number_format($total_lista,0,'.',',')." &nbsp; </div>";		$str_fac_unix .=  "</td>";		$str_fac_unix .=  "</tr>";	}	session_start();// Inicia la sessión del usuarioif (!isset($user))	if(!isset($_SESSION['user']))	  session_register("user");	// Si el usuario no está registrado muestra el mensaje de errorif(!isset($_SESSION['user']))	echo "error";else	// Si el usuario está registrado inicia el programa{	             	  include_once("root/comun.php");  $conex = obtenerConexionBD("matrix");  //$wbasedato = consultarAliasPorAplicacion($conex, $wemp_pmla, "movhos");  $wbasedato_farm = consultarAliasPorAplicacion($conex, $wemp_pmla, "farpmla");  datos_empresa($wemp_pmla);  conexionOdbc($conex, $wbasedato, &$conexUnix, 'facturacion');    // Obtengo los datos del usuario  $pos = strpos($user,"-");  $wusuario = substr($user,$pos+1,strlen($user));   // Aca se coloca la ultima fecha de actualización  $wactualiz = " Nov. 24 de 2011";  //**********************************************//  //********** P R I N C I P A L *****************//  //**********************************************//  // Obtener titulo de la página con base en el concepto  $titulo = "Consulta de topes de facturación";  $wfecha = date("Y-m-d");	  if (!isset($bandera))  {  				$wfecha_ini=$wfecha;	$wfecha_fin=$wfecha;  }  // Se muestra el encabezado del programa  encabezado($titulo,$wactualiz, "clinica");  	// Inicialización de variables globales	$str_fac_unix = '';	$tot_fac_unix = 0;	$str_fac_matrix = '';	$tot_fac_matrix = 0;	$j = 1;	if($conexUnix)	{		// Consulto los datos de la aseguradora estatal actual		$q=  " SELECT Detval "			."	 FROM root_000051  "			."  WHERE Detapl = 'aseguradoraEstatal' "			."	  AND Detemp = '".$wemp_pmla."'";		$res_asest = mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		$row_asest = mysql_fetch_array($res_asest);		$ase_est = explode("-",$row_asest['Detval']);		// Consulto el NIT de la aseguradora estatal		$nit_ase_est = $ase_est[0];		// Consulto el nombre de la aseguradora estatal		$nom_ase_est = $ase_est[1];				if (!isset ($historia))		{			//			if (!isset ($estado))				$empresa = $wbasedato_farm."_000064";			
			$query ="SELECT nombre FROM ".$wbasedato_farm."_000064 WHERE estado='on'";			$result = mysql_query($query);				// Formulario de solicitud de datos para consulta			echo "<table border=0 align=center>";			echo "<tr><td align=center>Ingrese los datos a consultar:</td>";			echo "</table>";			echo "<form NAME='ingreso' ACTION='' METHOD='POST'>";			echo "<table border=0 align=center>";			echo "<tr><td align=center height=31 class='fila2'>Identificación del paciente:</b>&nbsp</td>";			echo "<td align=center class='fila2'><div align=left>&nbsp;<input type='text' name='historia'></td></tr>";			echo "<tr><td align=center height=31 class='fila2'>Tipo de Identificación:&nbsp</td>";			echo "<td align=center class='fila2'><div align=center><input type='radio' name='group1' value='0' checked> Identificación personal";			echo "&nbsp;<input type='radio' name='group1' value='1'>Historia clínica<br></td></tr>";			echo "<input type='hidden' name='wemp_pmla' value='$wemp_pmla'>";			echo "<tr><td align=center height=47 colspan=2><div align=center><input type='submit' name='aceptar' value='INGRESAR' ></td></tr>";						echo "<tr><td align=center height=47 colspan=2><div align=center><input type=button value='Cerrar ventana' onclick='javascript:window.close();'></td></tr></table></form>";						include_once("free.php");			echo "";		}		else		{			$bd='facturacion';			include_once("socket.php");						// Consulto datos del paciente			// Si $group1==0 se buscan datos por documento de identificación			if (isset($group1) && $group1==0)			{				$doc = $historia;				$query="select pachis, pacced, pacnom 						  from inpac						 where pacced='$doc'";				$err_o = odbc_exec($conex_o,$query);				if (odbc_fetch_row($err_o))				{					$historia=odbc_result($err_o,1);					$nombre=odbc_result($err_o,3);				}				else				{					$query="select pachis, pacced, pacnom 							  from inpaci							 where pacced='$doc'";					$err_1 = odbc_exec($conex_o,$query);					if (odbc_fetch_row($err_1))					{						$historia=odbc_result($err_1,1);						$nombre=odbc_result($err_1,3);					}else					{						$historia='';						$nombre='';					}				}				} 			else  			// Si $group1==1 se buscan datos por historia			{				$query="select  pacced, pacnom 						  from inpac						 where pachis='$historia'";				$err_o = odbc_exec($conex_o,$query);				if (odbc_fetch_row($err_o))				{					$doc=odbc_result($err_o,1);					$nombre=odbc_result($err_o,2);				}else				{					$query="select pacced, pacnom 							  from inpaci							 where pachis='$historia'";					$err_1 = odbc_exec($conex_o,$query);					if (odbc_fetch_row($err_1))					{						$doc=odbc_result($err_1,1);						$nombre=odbc_result($err_1,2);					}					else					{						$doc='';						$nombre='';					}				}				}			$query="SELECT COUNT(*) 					  FROM inacc, inaccdet					 WHERE acchis='$historia' 					   AND accind='P' 					   AND accdethis = acchis 					   AND accdetnum = accnum 					   AND accdetacc = accacc 					   AND accdetffi != ''  ";			$err_c = odbc_exec($conex_o,$query);			$detfec_num = odbc_result($err_c,1);							// Consulto datos de accidentes para la historia clínica del paciente			if($detfec_num>0)				$query="SELECT accacc, accfec, accnum, accdetffi 						  FROM inacc, inaccdet						 WHERE acchis='$historia' 						   AND accind='P' 						   AND accdethis = acchis 						   AND accdetnum = accnum 						   AND accdetacc = accacc 						 ORDER BY accacc DESC";			else				$query="SELECT accacc, accfec, accnum, ' ' 						  FROM inacc, inaccdet						 WHERE acchis='$historia' 						   AND accind='P' 						   AND accdethis = acchis 						   AND accdetnum = accnum 						   AND accdetacc = accacc 						 ORDER BY accacc DESC";			$err_o = odbc_exec($conex_o,$query);					$contador=0;			echo "<table align=center>";			echo "<tr class='fila1'><td align=right height=21> &nbsp; <b>Nombre del paciente</b> &nbsp; </td><td> &nbsp; $nombre &nbsp; </font></td></tr>";			echo "<tr class='fila1'><td align=right height=21> &nbsp; <b>Historia</b> &nbsp; </td><td> &nbsp; $historia &nbsp; </font></td></tr>";			echo "<tr class='fila1'><td align=right height=21> &nbsp; <b>Identificaci&oacute;n</b> &nbsp; </td><td> &nbsp; $doc &nbsp; </font></td></tr>";			echo "</table>";						if(!isset($tp) || $tp!='1')			{				echo "<table border=0 align=center>";							echo "<tr><td colspan=4 align=center class='textoMedio' height='37'><b>Selecciones el accidente a consultar: </b></td>";				echo "<tr class='encabezadoTabla'>";				echo "<td nowrap align=center> &nbsp; Fecha &nbsp; </td>";				echo "<td nowrap> &nbsp; Nro. Accidente &nbsp; </td>";				echo "<td nowrap> &nbsp; Nro. Ingreso &nbsp; </td>";				echo "<td nowrap align=center> &nbsp; Detalle &nbsp; </td>";				echo "</tr>";				while (odbc_fetch_row($err_o))				{					if (is_int ($contador/2))					   $wcf="fila1";  // color de fondo de la fila					else					   $wcf="fila2"; // color de fondo de la fila										$contador++;					$accacc=odbc_result($err_o,1);					$accfec=odbc_result($err_o,2);					$accnum=odbc_result($err_o,3);					$accffi=odbc_result($err_o,4);										echo "<tr class='".$wcf."'>";					echo "<td nowrap align=center> &nbsp; $accfec &nbsp; </td>";					echo "<td align=center nowrap> &nbsp; $accacc &nbsp; </td>";					echo "<td align=center nowrap> &nbsp; $accnum &nbsp; </td>";					echo "<td nowrap align=center> &nbsp; <a href='form_topes_furips.php?wemp_pmla=$wemp_pmla&historia=$historia&ingreso=$accnum&accidente=$accacc'>Consultar</a> &nbsp; </td>";					echo "</tr>";				}				echo "</table>";								if ($contador==0)				{ 					//si no se encuentran accidentes para la historia					echo "<table border=0 align=center>";					echo "<tr><td align=center></td></tr>";					echo "<tr><td align=center>No existen accidentes reportados para el paciente ingresado, intente nuevamente</td><tr></table>";				}			}						if(isset($accidente) && $accidente!="")			{				// Consulto datos del accidente				$query="SELECT COUNT(*) 						  FROM inacc, inaccdet 						 WHERE acchis='$historia' 						   AND accacc='$accidente' 						   AND accind='P' 						   AND accdethis = acchis 						   AND accdetnum = accnum 						   AND accdetffi != ''  ";				$err_c = odbc_exec($conex_o,$query);				$detfec_num = odbc_result($err_c,1);									if($detfec_num>0)					$query="SELECT accacc, accfec, accnum, accdetffi 							  FROM inacc, inaccdet 							 WHERE acchis='$historia' 							   AND accacc='$accidente' 							   AND accind='P' 							   AND accdethis = acchis 							   AND accdetnum = accnum 							 ORDER BY accacc DESC";				else					$query="SELECT accacc, accfec, accnum, ' ' 							  FROM inacc, inaccdet 							 WHERE acchis='$historia' 							   AND accacc='$accidente' 							   AND accind='P' 							   AND accdethis = acchis 							   AND accdetnum = accnum 							 ORDER BY accacc DESC";				$err_o = odbc_exec($conex_o,$query);				$accacc=odbc_result($err_o,1);				$accfec=odbc_result($err_o,2);				$accnum=odbc_result($err_o,3);				$accffi=odbc_result($err_o,4);				echo "<table border=0 align=center>";				echo "<tr><td align=center colspan=4 height='41'></td></tr>";				echo "<tr class='encabezadoTabla'><td align=center> &nbsp; &nbsp; DATOS DE FACTURACIÓN DEL ACCIDENTE Nro. ".$accacc." (".$accfec.") &nbsp; &nbsp; </td></tr>";								facturacion_matrix($conex,$wbasedato_farm,$doc,$accidente);				facturacion_clinica($conexUnix,$historia,$accidente);								$total = $tot_fac_matrix+$tot_fac_unix;												/************************************************************/			/*	Comienza el calculo de topes correspondientes a 		*/			/*  la aseguradora del paciente y la aseguradora estatal 	*/			/************************************************************/				$facturado_aseguradora = $total;				$facturado_ase_est = 0;				$tope_aseguradora = 0;				$tope_ase_est = 0;				$query=" SELECT salacctop 						   FROM fasalacc						  WHERE salacchis='$historia' 							AND salaccacc = '$accidente' 							AND salaccnre = '1' ";				$err_o = odbc_do($conexUnix,$query);				$query="SELECT salacctop 						   FROM fasalacc						  WHERE salacchis='$historia' 							AND salaccacc = '$accidente' 							AND salaccnre = '2' ";				$err_f = odbc_do($conexUnix,$query);				if (odbc_fetch_row($err_o) && odbc_fetch_row($err_f))				{ // Si el accidente tiene registro de tope en Unix, obtengo el tope					$tope_aseguradora = odbc_result($err_o,1);					$tope_ase_est = odbc_result($err_f,1);				}				else				{	// Sino obtengo el tope registrado para el año en curso en Matrix					// Consulto los topes de aseguradora del paciente y aseguradora estatal de este año en Matrix					$q = " SELECT cfgcco, Cfgtas, Cfgtfo "						."   FROM ".$wbasedato_farm."_000049 "						."  WHERE cfgtas != '' "						."	  AND cfgtfo != ''";					$res_tope = mysql_query($q,$conex) or die (mysql_errno()." - ".mysql_error());					$row_tope = mysql_fetch_array($res_tope);  					$tope_aseguradora = $row_tope['Cfgtas'];					$tope_ase_est = $row_tope['Cfgtfo'];				}						      if($total > $tope_aseguradora)				  {					$total_facturado = $tope_aseguradora;					  if($total > ($tope_aseguradora+$tope_ase_est))					  {						$total_ase_est = $tope_ase_est;					  }					  else					  {						$total_ase_est = $total - $tope_aseguradora;					  }				  }				  else				  {					$total_facturado = $total;					$total_ase_est = 0;				  }				  $resta_aseguradora = $tope_aseguradora - $total_facturado;				  $resta_ase_est = $tope_ase_est - $total_ase_est;				  $resta_tercero = $total - ($tope_ase_est + $tope_aseguradora);				  if($resta_tercero < 0)					$resta_tercero = 0;								  $saldo_disponible = ($tope_ase_est+$tope_aseguradora)-$total;				  if($saldo_disponible<0)					$saldo_disponible = 0;				  				  // Muestro topes				  echo "<tr>";				  echo "<td colspan=4>";				  echo "<table align=center width=100% border=0>"; 				  echo "<tr>";				  echo "<td class=fila1 align=center><b>&nbsp;Facturado Total&nbsp;</b></td>";				  echo "<td class=fila1 align=center><b>&nbsp;Facturado Aseguradora&nbsp;</b></td>";				  echo "<td class=fila1 align=center><b>&nbsp;Facturado ".$nom_ase_est."&nbsp;</b></td>";				  echo "<td class=fila1 align=center><b>&nbsp;Saldo Disponible&nbsp;</b></td>";				  echo "</tr>";				  echo "<tr>";				  echo "<td class=fila2 align=center>&nbsp; ".number_format($total,0,'.',',')." &nbsp;</td>"; 				  echo "<td class=fila2 align=center>&nbsp; ".number_format($total_facturado,0,'.',',')." &nbsp;</td>";				  echo "<td class=fila2 align=center>&nbsp; ".number_format($total_ase_est,0,'.',',')." &nbsp;</td>";				  echo "<td class=fila2 align=center>&nbsp; ".number_format($saldo_disponible,0,'.',',')." &nbsp;</td>";				  echo "</tr>";				  echo "</table>";				  echo "<table border=0 width=100% align=center>";							  echo "<tr>";				  echo "<td class=fila1 align=center><b> &nbsp; Tope Aseguradora &nbsp; </b></td>"; 				  echo "<td class=fila1 align=center><b> &nbsp; Resta Aseguradora &nbsp; </b></td>";				  echo "<td class=fila1 align=center><b> &nbsp; Tope ".$nom_ase_est." &nbsp; </b></td>"; 				  echo "<td class=fila1 align=center><b> &nbsp; Resta ".$nom_ase_est." &nbsp; </b></td>";				  echo "<td class=fila1 align=center><b> &nbsp; Resta Tercero &nbsp; </b></td>"; 				  echo "</tr>";				  echo "<tr>";				  echo "<td class=fila2 align=center>&nbsp; ".number_format($tope_aseguradora,0,'.',',')." &nbsp;</td>"; 				  echo "<td class=fila2 align=center>&nbsp; ".number_format($resta_aseguradora,0,'.',',')." &nbsp;</td>";				  echo "<td class=fila2 align=center>&nbsp; ".number_format($tope_ase_est,0,'.',',')." &nbsp;</td>";				  echo "<td class=fila2 align=center>&nbsp; ".number_format($resta_ase_est,0,'.',',')." &nbsp;</td>";				  echo "<td class=fila2 align=center>&nbsp; ".number_format($resta_tercero,0,'.',',')." &nbsp;</td>"; 				  echo "</tr>";				  echo "<tr>";				  echo "<td colspan=5>&nbsp;</td>"; 				  echo "</tr>";				  echo "</table>";			// ---------------------------------------------------------------------------------- //				  			/********************************************************************************/			/*	Comienza la consulta y listado de facturas detallado (factura por factura)	*/			/********************************************************************************/				// Titulos de las columnas				echo "<table border='0' width=100% align='center'>";				echo "<tr class='encabezadoTabla'>";				echo "<td colspan=5>";				echo "<div align='left'> &nbsp; Detalle de facturación &nbsp; </div>";				echo "</td>";				echo "</tr>";				echo "<tr class='encabezadoTabla'>";				echo "<td align='center'>";				echo "<div align='center'> &nbsp; Fecha &nbsp; </div>";				echo "</td>";				echo "<td align='center'>";				echo "<div align='center'> &nbsp; Tipo Facturación &nbsp; </div>";				echo "</td>";				echo "<td align='center'>";				echo "<div align='center'> &nbsp; Número Factura &nbsp; </div>";				echo "</td>";				echo "<td align='center'>";				echo "<div align='center'> &nbsp; Centro de Costos &nbsp; </div>";				echo "</td>";				echo "<td align='center'>";				echo "<div align='center'> &nbsp; Total &nbsp; </div>";				echo "</td>";				echo "</tr>";				////////////////////////				// FACTURACIÓN MATRIX //				////////////////////////								echo $str_fac_matrix;								//////////////////////				// FACTURACIÓN UNIX	//				//////////////////////									echo $str_fac_unix;				echo "</table>";				echo "</td></tr></table>";								// ---------------------------------------------------------------------------------- //							}			if(!isset($tp) || $tp!='1')				echo "<br><div align='center'> &nbsp;&nbsp; <a href='form_topes_furips.php?wemp_pmla=$wemp_pmla&estado=1'>Volver</a> &nbsp;&nbsp; </div>";			else				echo "<br><div align='center'><input type=button value='Cerrar ventana' onclick='javascript:window.close();'></div>";		}			} 	else 	{		echo "<br /><div align='center'>NO SE HA ESTABLECIDO CONEXIÓN CON LA BASE DE DATOS. <br> INTENTELO DE NUEVO MAS TARDE.<br /><br /><input type=button value='Cerrar ventana' onclick='javascript:window.close();'></div>";	}}?></body></html>