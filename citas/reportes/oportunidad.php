<html><head><title>INFORME DE OPORTUNIDAD DEL SERVICIO</title><script type="text/javascript">	//Validación de los datos del formulario	function valida_enviar(form)	{		form.submit();	}	//Redirecciona a la pagina inicial	function inicioReporte(TABLA,UNIDAD,wfecini,wfecfin)	{	 	document.location.href='oportunidad.php?TABLA='+TABLA+'&UNIDAD='+UNIDAD+'&wfecini='+wfecini+'&wfecfin='+wfecfin+'&bandera=1';	 			}</script></head><body><?php
include_once("conex.php");/***********************************************************     INFORME DE OPORTUNIDAD DEL SERVICIO				  ***********************************************************/   //==========================================================================================================================================//PROGRAMA				      : INFORME DE OPORTUNIDAD DEL SERVICIO                                                         				|//AUTOR                       : 																											|//FECHA CREACION              : 2008-01-23																									|//FECHA ULTIMA ACTUALIZACION  : 2011-02-01																									|//DESCRIPCION			      : Informe de oportunidad del servicio                                                                        	|//==========================================================================================================================================$wactualiz="Vers. 1.2 | Febrero 1 de 2011";//========================================================================================================================================\\//========================================================================================================================================\\//ACTUALIZACIONES                                                                                                                         \\//========================================================================================================================================\\//________________________________________________________________________________________________________________________________________\\// Autor: John M. Cadavid G.																											  \\// Fecha: 2011-02-01																													  \\// Modificación: Se le colocó calendario a los campos de fecha inicial y final. Se adaptó el diseño a los css del sistema				  \\//________________________________________________________________________________________________________________________________________\\//                                                                                                                                        \\//========================================================================================================================================\\//========================================================================================================================================\\         include_once("root/comun.php");$conex = obtenerConexionBD("matrix");//Validación de usuario$usuarioValidado = true;if (!isset($user) || !isset($_SESSION['user'])){	$usuarioValidado = false;}else {	if (strpos($user, "-") > 0)		$wuser = substr($user, (strpos($user, "-") + 1), strlen($user));}if(empty($wuser) || $wuser == ""){	$usuarioValidado = false;}session_start();//Llamo a la función para formar el encabezado del informe llevándole Título, Fecha e Imagen o logoencabezado("INFORME DE OPORTUNIDAD DEL SERVICIO ",$wactualiz,"clinica");//Si el usuario no es válido se informa y no se abre el reporteif (!$usuarioValidado){	echo '<span class="subtituloPagina2" align="center">';	echo 'Error: Usuario no autenticado';	echo "</span><br><br>";	terminarEjecucion("Por favor cierre esta ventana e ingrese a matrix nuevamente.");} // Fin IF si el usuario no es válidoelse //Si el usuario es válido comenzamos con el reporte{  //Inicio ELSE reporte		//Conexion base de datos	
      	// Inicio del formulario	echo "<form name='form1' action='oportunidad.php' method=post onSubmit='return valida_enviar(this);'>";	echo "<input type='hidden' name='TABLA' value='".$TABLA."'>";	echo "<input type='hidden' name='UNIDAD' value='".$UNIDAD."'>";	// Si no se han ingresado aun los datos muestre el formulario para solicitarlos	if (!isset($wfecini) or !isset($wfecfin) or !isset($resultado))  	{		echo "<center><table border=0>";  		 		//Petición de ingreso de parametros		echo "<tr>";		echo "<td height='37' colspan='2'>";		echo '<p align="left" class="titulo"><strong> &nbsp; Ingrese las fechas a consultar &nbsp;  &nbsp; </strong></p>';		echo "</td></tr>";		//Parámetros de consulta		$wfecha=date("Y-m-d");  		if (!isset ($bandera))  		{  			 			$wfecini=$wfecha;  			$wfecfin=$wfecha;		}	  				//Fecha inicial de consulta	  		echo "<tr>";  		echo "<td class=fila2 align=center> &nbsp; <b>Fecha inicial : &nbsp; </b>";  		campoFechaDefecto("wfecini", $wfecini);  		echo " &nbsp; </td>";  		  		//Fecha final de consulta  		echo "<td class=fila2 align=center> &nbsp; <b>Fecha final : </b> &nbsp; ";  		campoFechaDefecto("wfecfin", $wfecfin );  		echo " &nbsp; </td>";  		echo "</tr>";  		echo "<input type='hidden' name='bandera' value='1'>";  		echo "<input type='hidden' name='resultado' value='1'>";  				//Botones "Consultar" y "Cerrar ventana"		echo "<tr>";		echo "<td align=center colspan=2><br />";		echo "<input type='submit' id='searchsubmit' value='Consultar'>";		echo "&nbsp;|&nbsp;";		echo "<input type='button' value='Cerrar ventana' onclick='javascript:cerrarVentana();'>";		echo "</td>";		echo "</tr>";              	  		echo "</table></center>";			}	else	{		$q = "SELECT Fecha, Fecha_Data 				  FROM ".$TABLA." 				  WHERE fecha 				  BETWEEN '".$wfecini."' and '".$wfecfin."' 				 ";		$res = mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		$num = mysql_num_rows($res);			//Muestro los parámetros que se ingresaron en la consulta		echo "<center><table border=0>";		echo "<tr>";		echo "<td height='37' colspan='2'>";		echo '<p align="left" class="titulo"><strong> &nbsp; DIRECCION DE INFORMATICA &nbsp;  &nbsp; </strong></p>';		echo "</td></tr>";		echo "</table></center><br />";		echo "<center><table border=0 cellspacing=2 cellpadding=0 align=center>"; 		echo "<tr class='fila2'>";		echo "<td align=left><strong>&nbsp;".$UNIDAD."&nbsp;&nbsp;&nbsp;&nbsp;</td>";		echo "</tr>";		echo "<tr class='fila2'>";		echo "<td align=left><strong>&nbsp;ENTRE FECHAS: DESDE </strong>".$wfecini." <strong>HASTA </strong>".$wfecfin."&nbsp;&nbsp;&nbsp;&nbsp;</strong></td>";		echo "</tr>";		echo "</table>";  		echo "</br>";		echo "<table border=0 align=center>";			//Encabezados de columna		echo "<tr class='encabezadotabla'>";		echo "<td align=center><b>FECHA DE SOLICITUD</b></td>";		echo "<td align=center><b>FECHA DE ASIGNACION</b></td>";		echo "<td align=center><b>DIFERENCIA EN DIAS</b></td>";		echo "</tr>"; 		$t=array();		$t[0] = 0;		$t[1] = 0;		$k=0;		$sum=0;		// Ciclo para mostrar los resultados		for ($i=0;$i<$num;$i++)		{			if (is_int ($i/2))			   $wcf="fila1";  // clase de la fila 1			else			   $wcf="fila2"; // clase de la fila 2			$row = mysql_fetch_array($res);			$D1=(integer)substr($row[0],0,4)*360 +(integer)substr($row[0],5,2)*30 + (integer)substr($row[0],8,2);			$D2=(integer)substr($row[1],0,4)*360 +(integer)substr($row[1],5,2)*30 + (integer)substr($row[1],8,2);			if($D1 - $D2 >= 0 and $D1 - $D2 <= 60) //Agosto 16 de 2012 estaba asi: ($D1 - $D2 > 0 y se le adiciona el = asi:($D1 - $D2 >= 0			{				$k++;				$sum += $D1 - $D2;				$DIFF = $D1 - $D2;				echo "<tr class='".$wcf."'>";				echo "<td align=center>".$row[1]."</td>";				echo "<td align=center>".$row[0]."</td>";				echo "<td align=center>".number_format((double)$DIFF,0,'.',',')."</td>";				echo "</tr>"; 			}		}		$o=$sum / $k;		echo "<tr class='encabezadotabla'>";		echo "<td colspan=3 align=center><b> CITAS TOTALES : ".$k."</b></td>";		echo "</tr>";		echo "<tr class='encabezadotabla'>";		echo "<td colspan=3 align=center><b> NUMERO DE DIAS TOTALES : ".$sum." </b></td>";		echo "</tr>";		echo "<tr class='encabezadotabla'>";		echo "<td colspan=3 align=center><b> OPORTUNIDAD EN DIAS : ".number_format((double)$o,2,'.',',')."</b></td>";		echo "</tr>";		echo "</table></center>"; 		//Botones "Retornar" y "Cerrar ventana"		$bandera = 1;		echo "<br />";		echo "<p align='center'>";		echo "<input type='button' value='Retornar' onClick='javascript:inicioReporte(\"$TABLA\",\"$UNIDAD\",\"$wfecini\",\"$wfecfin\");'>";		echo "&nbsp;|&nbsp;";		echo "<input type='button' value='Cerrar ventana' onclick='javascript:cerrarVentana();'>";		echo "</p>";          	}		//Cierre del formulario	echo "</form>";}?></body></html>