<html>
<head>
  	<title>MATRIX Programa de Turnos de Fisioterapia Terminacion de Tratamiento</title>
  	<!-- UTF-8 is the recommended encoding for your pages -->

    <title>Zapatec DHTML Calendar</title>

<!-- Loading Theme file(s) -->
    <link rel="stylesheet" href="../../zpcal/themes/winter.css" />

<!-- Loading Calendar JavaScript files -->
    <script type="text/javascript" src="../../zpcal/src/utils.js"></script>
    <script type="text/javascript" src="../../zpcal/src/calendar.js"></script>
    <script type="text/javascript" src="../../zpcal/src/calendar-setup.js"></script>
    <!-- Loading language definition file -->
    <script type="text/javascript" src="../../zpcal/lang/calendar-sp.js"></script>
    <style type="text/css">
    	//body{background:white url(portal.gif) transparent center no-repeat scroll;}
    	#tipo1{color:#000066;background:#FFFFFF;font-size:7pt;font-family:Tahoma;font-weight:bold;}
    	#tipo2{color:#000066;background:#FFFFFF;font-size:7pt;font-family:Tahoma;font-weight:bold;}
    	.tipo3{color:#000066;background:#FFFFFF;font-size:7pt;font-family:Tahoma;font-weight:bold;text-align:left;}
    	.tipo4{color:#000066;background:#dddddd;font-size:6pt;font-family:Tahoma;font-weight:bold;text-align:center;}
    	#tipo5{color:#000066;background:#FFFFFF;font-size:10pt;font-family:Tahoma;font-weight:bold;border-style:none;}
    	.tipo6{color:#000066;background:#FFFFFF;font-size:10pt;font-family:Tahoma;font-weight:bold;text-align:center;}
    	#tipo7{color:#FFFFFF;background:#000066;font-size:12pt;font-family:Tahoma;font-weight:bold;width:30em;}
    	#tipo8{color:#99CCFF;background:#000066;font-size:6pt;font-family:Tahoma;font-weight:bold;}
    	#tipo9{color:#660000;background:#dddddd;font-size:8pt;font-family:Tahoma;font-weight:bold;text-align:center;}
    	#tipo10{color:#FFFFFF;background:#000066;font-size:10pt;font-family:Tahoma;font-weight:bold;text-align:center;}
    	#tipo11{color:#000066;background:#999999;font-size:7pt;font-family:Tahoma;font-weight:bold;text-align:center;}
    	#tipo12{color:#000066;background:#FFFFFF;font-size:7pt;font-family:Tahoma;font-weight:bold;text-align:left;}
    	#tipo13{color:#000066;background:#99CCFF;font-size:7pt;font-family:Tahoma;font-weight:bold;text-align:left;}
    	#tipo14{color:#FFFFFF;background:#000066;font-size:14pt;font-family:Tahoma;font-weight:bold;text-align:center;}
    	#tipo15{color:#000066;background:#FFFFFF;font-size:7pt;font-family:Tahoma;font-weight:bold;text-align:center;}
    	#tipo16{color:#000066;background:#99CCFF;font-size:7pt;font-family:Tahoma;font-weight:bold;text-align:center;}


    	#tipoG01{color:#000066;background:#FFFFFF;font-size:9pt;font-family:Arial;font-weight:bold;width:9em;text-align:center;height:3em;}
    	#tipoG11{color:#FFFFFF;background:#99CCFF;font-size:9pt;font-family:Arial;font-weight:bold;width:17em;text-align:center;height:15em;}
    	#tipoG54{color:#000066;background:#DDDDDD;font-size:9pt;font-family:Arial;font-weight:bold;width:17em;text-align:center;height:3em;}
    	#tipoG55{color:#000066;background:#DDDDDD;font-size:9pt;font-family:Arial;font-weight:bold;width:9em;text-align:center;height:15em;}
    	#tipoG21A{color:#000066;background:#FFFFFF;font-size:7.5pt;font-family:Arial;font-weight:bold;width:17em;text-align:left;height:15em;}
    	#tipoG21B{color:#000066;background:#C3D9FF;font-size:7.5pt;font-family:Arial;font-weight:bold;width:17em;text-align:left;height:15em;}

    	#tipoG00{color:#000066;background:#FFFFFF;font-size:12pt;font-family:Tahoma;font-weight:bold;table-layout:fixed;text-align:center;}
    	#tipoG54A{color:#000066;background:#DDDDDD;font-size:7pt;font-family:Tahoma;font-weight:bold;width:8.5em;text-align:center;height:3em;}
    	#tipoG11{color:#FFFFFF;background:#99CCFF;font-size:7pt;font-family:Tahoma;font-weight:bold;width:8.5em;text-align:center;height:3em;}
    	#tipoG11A{color:#FFFFFF;background:#9999FF;font-size:7pt;font-family:Tahoma;font-weight:bold;width:8.5em;text-align:center;height:3em;}
    	#tipoG21{color:#FFFFFF;background:#CC3333;font-size:7pt;font-family:Tahoma;font-weight:bold;width:8.5em;text-align:center;height:3em;}

    	#tipoG32{color:#FF0000;background:#FFFF66;font-size:7pt;font-family:Tahoma;font-weight:bold;width:8.5em;text-align:center;height:3em;}
    	#tipoG32A{color:#FF0000;background:#FFCC66;font-size:7pt;font-family:Tahoma;font-weight:bold;width:8.5em;text-align:center;height:3em;}
    	#tipoG33{color:#006600;background:#FFFF66;font-size:7pt;font-family:Tahoma;font-weight:bold;width:8.5em;text-align:center;height:3em;}
    	#tipoG34{color:#000066;background:#FFFF66;font-size:7pt;font-family:Tahoma;font-weight:bold;width:8.5em;text-align:center;height:3em;}
    	#tipoG42{color:#FF0000;background:#00CC66;font-size:7pt;font-family:Tahoma;font-weight:bold;width:8.5em;text-align:center;height:3em;}
    	#tipoG41{color:#FFFFFF;background:#00CC66;font-size:7pt;font-family:Tahoma;font-weight:bold;width:8.5em;text-align:center;height:3em;}
    	#tipoG41A{color:#FFFFFF;background:#66FF00;font-size:7pt;font-family:Tahoma;font-weight:bold;width:8.5em;text-align:center;height:3em;}
    	#tipoG44{color:#000066;background:#00CC66;font-size:7pt;font-family:Tahoma;font-weight:bold;width:8.5em;text-align:center;height:3em;}

    	#tipoM00{color:#000066;background:#FFFFFF;font-size:7pt;font-family:Tahoma;font-weight:bold;table-layout:fixed;text-align:center;}
    	#tipoM01{color:#000066;background:#DDDDDD;font-size:7pt;font-family:Tahoma;font-weight:bold;width:40em;text-align:left;height:3em;}
    	#tipoM02{color:#000066;background:#99CCFF;font-size:7pt;font-family:Tahoma;font-weight:bold;width:40em;text-align:left;height:3em;}


    	#tipoF00{color:#000066;background:#999999;font-size:8pt;font-family:Arial;font-weight:bold;text-align:center;}
    	#tipoF01A{color:#000066;background:#C3D9FF;font-size:8pt;font-family:Arial;font-weight:normal;text-align:left;}
    	#tipoF01B{color:#000066;background:#C3D9FF;font-size:8pt;font-family:Arial;font-weight:normal;text-align:center;}
    	#tipoF02A{color:#000066;background:#E8EEF7;font-size:8pt;font-family:Arial;font-weight:normal;text-align:left;}
    	#tipoF02B{color:#000066;background:#E8EEF7;font-size:8pt;font-family:Arial;font-weight:normal;text-align:center;}
    	#tipoF03A{color:#FFFFFF;background:#FF0000;font-size:8pt;font-family:Arial;font-weight:bold;text-align:left;}
    	#tipoF03B{color:#FFFFFF;background:#FF0000;font-size:8pt;font-family:Arial;font-weight:bold;text-align:center;}

    </style>
</head>
<body BGCOLOR="FFFFFF" oncontextmenu = "return true" onselectstart = "return true" ondragstart = "return true">
<BODY TEXT="#000066">
<script type="text/javascript">
<!--
	function enter()
	{
		document.forms.Turfister.submit();
	}
	function teclado()
	{
		if ((event.keyCode < 48 || event.keyCode > 57  || event.keyCode == 13) & event.keyCode != 46) event.returnValue = false;
	}
	function teclado1()
	{
		if ((event.keyCode < 48 || event.keyCode > 57 ) & event.keyCode != 46 & event.keyCode != 13)  event.returnValue = false;
	}
	function teclado2()
	{
		if ((event.keyCode < 48 || event.keyCode > 57 ) & (event.keyCode < 65 || event.keyCode > 90 ) & (event.keyCode < 97 || event.keyCode > 122 ) & event.keyCode != 13) event.returnValue = false;
	}
	function teclado3()
	{
		if ((event.keyCode < 48 || event.keyCode > 57 ) & (event.keyCode < 65 || event.keyCode > 90 ) & (event.keyCode < 97 || event.keyCode > 122 ) & event.keyCode != 13 & event.keyCode != 45) event.returnValue = false;
	}

//-->
</script>
<?php
include_once("conex.php");
/**********************************************************************************************************************
	   PROGRAMA : Turfister.php
	   Fecha de Liberacion : 2011-06-29
	   Autor : Ing. Pedro Ortiz Tamayo
	   Version Actual : 2022-04-18

	   OBJETIVO GENERAL :Este programa ofrece al usuario una interface grafica que permite visualizar en forma matricial
	   los pacientes que terminan tratamiento en la unidad de Fisiatria y deben ser facturados y los pacientes que
	   que asisteron a la session.

	   REGISTRO DE MODIFICACIONES :
		.2022-04-18
		Se cambia el nombre de la tabla citasfi en sql por el noimbre enviado en la variable $empresa,
		el cual se envia en la url de la aplicaciÃ³n para que funcione como
		multisede ejemplo: turfister.php?empresa=citasfi
	   .2011-08-17
	   		Release de Version Beta.

***********************************************************************************************************************/
function bi($d,$n,$k,$i)
{
	$n--;
	if($n > 0)
	{
		$li=0;
		$ls=$n;
		while ($ls - $li > 1)
		{
			$lm=(integer)(($li + $ls) / 2);
			$val=strncmp(strtoupper($k),strtoupper($d[$lm][$i]),20);
			if($val == 0)
				return $lm;
			elseif($val < 0)
					$ls=$lm;
				else
					$li=$lm;
		}
		if(strtoupper($k) == strtoupper($d[$li][$i]))
			return $li;
		elseif(strtoupper($k) == strtoupper($d[$ls][$i]))
					return $ls;
				else
					return -1;
	}
	else
		return -1;
}
function date_format_fis($fecha)
{
	$dia=substr($fecha,0,strpos($fecha,"/"));
	if(strlen($dia) < 2)
		$dia = "0".$dia;
	$mes=substr($fecha,strpos($fecha,"/")+1,strrpos($fecha,"/") - (strpos($fecha,"/")+1));
	if(strlen($mes) < 2)
		$mes = "0".$mes;
	$ano=substr($fecha,strrpos($fecha,"/")+1);
	$fecha=$ano."-".$mes."-".$dia;
	return $fecha;
}
function ultimoDia($mes,$ano){
    $udia=28;
    while (checkdate($mes,$udia + 1,$ano)){
       $udia++;
    }
    return $udia;
}

function comparacion($vec1,$vec2)
{
	if($vec1[0] > $vec2[0])
		return 1;
	elseif ($vec1[0] < $vec2[0])
				return -1;
			else
				return 0;
}

function ver($chain)
{
	if(strpos($chain,"-") === false)
		return $chain;
	else
		return substr($chain,0,strpos($chain,"-"));
}
function validar1($chain)
{
	// Funcion que permite validar la estructura de un numero Real
	$decimal ="^(\+|-)?([[:digit:]]+)\.([[:digit:]]+)$";
	if (ereg($decimal,$chain,$occur))
		if(substr($occur[2],0,1)==0 and strlen($occur[2])!=1)
			return false;
		else
			return true;
	else
		return false;
}
function validar2($chain)
{
	// Funcion que permite validar la estructura de un numero Entero
	$regular="^(\+|-)?([[:digit:]]+)$";
	if (ereg($regular,$chain,$occur))
		if(substr($occur[2],0,1)==0 and strlen($occur[2])!=1)
			return false;
		else
			return true;
	else
		return false;
}
function validar3($chain)
{
	// Funcion que permite validar la estructura de una fecha
	$fecha="^([[:digit:]]{4})-([[:digit:]]{1,2})-([[:digit:]]{1,2})$";
	if(ereg($fecha,$chain,$occur))
	{
		if($occur[2] < 0 or $occur[2] > 12)
			return false;
		if(($occur[3] < 0 or $occur[3] > 31) or
		  ($occur[2] == 4 and  $occur[3] > 30) or
		  ($occur[2] == 6 and  $occur[3] > 30) or
		  ($occur[2] == 9 and  $occur[3] > 30) or
		  ($occur[2] == 11 and $occur[3] > 30) or
		  ($occur[2] == 2 and  $occur[3] > 29 and bisiesto($occur[1])) or
		  ($occur[2] == 2 and  $occur[3] > 28 and !bisiesto($occur[1])))
			return false;
		return true;
	}
	else
		return false;
}
function validar4($chain)
{
	// Funcion que permite validar la estructura de un dato alfanumerico
	$regular="^([=a-zA-Z0-9' 'ï¿½ï¿½@?/*#-.:;_<>])+$";
	return (ereg($regular,$chain));
}
function validar5($chain)
{
	// Funcion que permite validar la estructura de un dato numerico
	$regular="^([0-9:])+$";
	return (ereg($regular,$chain));
}
function validar6($chain)
{
	// Funcion que permite validar la estructura de un campo Hora
	$hora="^([[:digit:]]{1,2}):([[:digit:]]{1,2}):([[:digit:]]{1,2})$";
	if(ereg($hora,$chain,$occur))
		if($occur[1] < 0 or $occur[1] >23 or $occur[2]<0 or $occur[2]>59)
			return false;
		else
			return true;
	else
		return false;
}
function validar7($chain)
{
	// Funcion que permite validar la estructura de un campo Hora Especial
	$hora="^([[:digit:]]{1,2}):([[:digit:]]{1,2})$";
	if(ereg($hora,$chain,$occur))
		if($occur[1] < 0 or $occur[1] >23 or ($occur[2]!=0 and $occur[2]!=30))
			return false;
		else
			return true;
	else
		return false;
}


@session_start();
if(!isset($_SESSION['user']))
	echo "error";
else
{
	$key = substr($user,2,strlen($user));
	echo "<form name='turfister' action='Turfister.php' method=post>";
	if (!isset($wfecha))
		$wfecha=date("Y-m-d");
	echo "<meta http-equiv='refresh' content='120;url=/matrix/Citas/procesos/Turfister.php?empresa=".$empresa."&wfecha=".$wfecha."'>";
	

	

	$conexo = odbc_connect('admisiones','','')
			or die("No se ralizo Conexion");
	echo "<center><input type='HIDDEN' name= 'empresa' value='".$empresa."'>";
	if(isset($num) and $num > 0)
	{
		for ($i=0;$i<$num;$i++)
		{
			if(isset($sel[$i]))
			{
				$query =  " update ".$empresa."_000017 set Comentarios = CONCAT(Comentarios,' &O:') ";
				$query .=  "  where Terapeuta='".$wpar[$i][0]."'";
				$query .=  "    and Fecha='".$wpar[$i][1]."'";
				$query .=  "    and Hora_Inicial='".$wpar[$i][2]."'";
				$query .=  "    and Cedula='".$wpar[$i][3]."'";
				$err1 = mysql_query($query,$conex) or die("ERROR ACTUALIZANDO TURNOS DE FISIOTERAPEUTAS : ".mysql_errno().":".mysql_error());
			}
		}
	}

	echo "<table border=0 align=center id=tipo5>";

	echo "<tr><td align=center colspan=5><IMG SRC='/matrix/images/medical/citas/logo_".$empresa.".png'></td></tr>";
	echo "<tr><td align=right colspan=5><font size=2>Ver. 2011-08-17</font></td></tr>";
	echo "<tr><td align=center colspan=5 id=tipo14><b>TURNOS DE FISIOTERAPIA TERMINACION DE TRATAMIENTO O ASISTIERON A LA CITA</td></tr>";
	if (!isset($wfecha))
		$wfecha=date("Y-m-d");
	if (!isset($wcedT))
		$wcedT="";
	if (!isset($wnomT))
		$wnomT="";
	if (!isset($wresT))
		$wresT="";
	if (isset($wini))
	{
		$wcedT="";
		$wnomT="";
		$wresT="";
	}
	$year = (integer)substr($wfecha,0,4);
	$month = (integer)substr($wfecha,5,2);
	$day = (integer)substr($wfecha,8,2);
	$nomdia=mktime(0,0,0,$month,$day,$year);
	$nomdia = strftime("%w",$nomdia);
	$wsw=0;
	switch ($nomdia)
	{
		case 0:
			$diasem = "DOMINGO";
			break;
		case 1:
			$diasem = "LUNES";
			break;
		case 2:
			$diasem = "MARTES";
			break;
		case 3:
			$diasem = "MIERCOLES";
			break;
		case 4:
			$diasem = "JUEVES";
			break;
		case 5:
			$diasem = "VIERNES";
			break;
		case 6:
			$diasem = "SABADO";
			break;
	}
	$H=array();
	//                     0      1       2        3            4
	$query  =  "select Terapeuta,Dia,Hora_inicial,tipo,(Personas+Adicionales) from ".$empresa."_000016 ";
	$query .= " where MONTH(fecha_i) = ".$month;
	$query .= "  and YEAR(fecha_f) = ".$year;
	$query .= "  order by 1,2,3,4,5 ";
	$err = mysql_query($query,$conex);
	$numH = mysql_num_rows($err);
	for ($i=0;$i<$numH;$i++)
	{
		$row = mysql_fetch_array($err);
		$H[$i][0] = $row[0].$row[1].$row[2].$row[3];
		$H[$i][1] = $row[4];
	}
	echo "<tr><td bgcolor='#cccccc' align=center><b>FECHA :</b></td>";
	echo "<td bgcolor='#cccccc' align=center>Dia de la Semana<br><b>".$diasem."</b></td>";
	echo "<td bgcolor='#cccccc' align=center valign=bottom>A&ntilde;o - Mes - Dia<br><input type='TEXT' name='wfecha' size=10 maxlength=10 id='wfecha' readonly='readonly' value=".$wfecha." class=tipo6></td><td bgcolor='#cccccc' align=center valign=center><IMG SRC='/matrix/images/medical/TCX/calendario.jpg' id='trigger1'></td>";
	?>
	<script type="text/javascript">//<![CDATA[
		Zapatec.Calendar.setup({weekNumbers:false,showsTime:true,timeFormat:'12',electric:false,inputField:'wfecha',button:'trigger1',ifFormat:'%Y-%m-%d',daFormat:'%Y/%m/%d'});
	//]]></script>
	<?php
	echo "<td bgcolor='#cccccc' align=center><input type='submit' value='IR'></td></tr></table>";
	//                 0          1          2                          3         4         5                            6                            7                                 8                                9                          10                              11
	$query = "SELECT Fecha, Hora_Inicial, Cedula, ".$empresa."_000017.Nombre, Actividad,Comentarios,".$empresa."_000015.Nombre,".$empresa."_000002.Descripcion,".$empresa."_000015.Especialidad, ".$empresa."_000017.Terapeuta,DAYOFWEEK(".$empresa."_000017.Fecha),".$empresa."_000017.Tipo from ".$empresa."_000017,".$empresa."_000015,".$empresa."_000002 ";
	$query .= " where Fecha = '".$wfecha."' ";
	$query .= "   and Actividad = 1 ";
	$query .= "   and Terapeuta = ".$empresa."_000015.Codigo ";
	$query .= "   and Responsable = ".$empresa."_000002.Nit ";
	//$query .= "   and Comentarios like '%&t:%' ";
	$query .= "   order by Fecha, Hora_Inicial";
	$err = mysql_query($query,$conex) or die(mysql_errno().":".mysql_error());
	$num = mysql_num_rows($err);
	if ($num>0)
	{
		echo "<input type='HIDDEN' name= 'num' value='".$num."'>";
		echo "<br><center><table border=0 align=center id=tipoG00>";
		echo "<tr><td id='tipoF00'>Hora Inicial</td><td id='tipoF00'>Historia</td><td id='tipoF00'>Ingreso</td><td id='tipoF00'>Identificacion</td><td id='tipoF00'>Nombre Paciente</td><td id='tipoF00'>% Mejoria</td><td id='tipoF00'>Terapeuta</td><td id='tipoF00'>Especialidad</td><td id='tipoF00'>Responsable</td><td id='tipoF00'>Tipo de<br>Terapia</td><td id='tipoF00'>OK</td></tr>";
		for ($i=0;$i<$num;$i++)
		{
			$row = mysql_fetch_array($err);
			echo "<input type='HIDDEN' name= 'wpar[".$i."][0]' value='".$row[9]."'>";
			echo "<input type='HIDDEN' name= 'wpar[".$i."][1]' value='".$row[0]."'>";
			echo "<input type='HIDDEN' name= 'wpar[".$i."][2]' value='".$row[1]."'>";
			echo "<input type='HIDDEN' name= 'wpar[".$i."][3]' value='".$row[2]."'>";
			$queryo  = "select egrhis,egrnum from inmegr,inpaci ";
			$queryo .= " where pacced = '".$row[2]."'";
			$queryo .= "   and pachis = egrhis ";
			$queryo .= "   and egrsin = '33' ";
			$queryo .= " UNION ALL ";
			$queryo .= " select pachis,pacnum from inpac ";
			$queryo .= " 	where pacced = '".$row[2]."'";
			$queryo .= " 	  and pacser = '33' ";
			$queryo .= " order by 2 desc  ";


			$err1 = odbc_do($conexo,$queryo);
			$campos= odbc_num_fields($err1);
			if (odbc_fetch_row($err1))
			{
				$row1=array();
				$row1[0]="INDETERMINADO";
				$row1[1]="INDETERMINADO";
				for($j=1;$j<=$campos;$j++)
				{
					$row1[$j-1]=odbc_result($err1,$j);
				}
			}
			else
			{
				$row1=array();
				$row1[0]="INDETERMINADO";
				$row1[1]="INDETERMINADO";
			}
			$pos=bi($H,$numH,$row[9].$row[10].$row[1].$row[11],0);
			if($pos == -1)
			{
				$WTIPO = "TN";
			}
			elseif($H[$pos][1] <= 4)
					$WTIPO = "TN";
				else
					$WTIPO = "RC";
			if($i % 2 == 0)
				$color="tipoF01";
			else
				$color="tipoF02";

			if(strpos(strtoupper($row[5]),"&T:") !== false)
			{
				$color1="tipoF03";
				$wpor=substr($row[5],strpos($row[5],":")+1,3);
			}
			else
			{
				$color1=$color;
				$wpor="";
			}
			echo "<tr><td id=".$color1."B>".$row[1]."</td><td id=".$color1."B>".$row1[0]."</td><td id=".$color1."B>".$row1[1]."</td><td id=".$color1."A>".$row[2]."</td><td id=".$color1."A>".$row[3]."</td><td id=".$color1."B>".$wpor."</td><td id=".$color1."A>".$row[6]."</td><td id=".$color1."A>".substr($row[8],strpos($row[8],"-")+1)."</td><td id=".$color1."A>".$row[7]."</td><td id=".$color1."B>".$WTIPO."</td>";
			if(strpos(strtoupper($row[5]),"&O:") !== false)
				echo "<td id=".$color1."B><input type='checkbox' name='sel[".$i."]' checked onclick='enter()'></td>";
			else
				echo "<td id=".$color1."B><input type='checkbox' name='sel[".$i."]' onclick='enter()'></td>";
			echo "</tr>";
		}
		echo "</table></td>";
	}
	odbc_close($conexo);
	odbc_close_all();
}
?>
</body>
</html>
