<html>
<head>
  	<title>MATRIX Mensajes ORU de Pacientes RIS-PACS</title>
  	<!-- UTF-8 is the recommended encoding for your pages -->
 
    <title>Zapatec DHTML Calendar</title>

<!-- Loading Theme file(s) -->
    <link rel="stylesheet" href="../../zpcal/themes/winter.css" />

<!-- Loading Calendar JavaScript files -->
    <script type="text/javascript" src="../../zpcal/src/utils.js"></script>
    <script type="text/javascript" src="../../zpcal/src/calendar.js"></script>
    <script type="text/javascript" src="../../zpcal/src/calendar-setup.js"></script>
    <!-- Loading language definition file -->
    <script type="text/javascript" src="../../zpcal/lang/calendar-sp.js"></script>
    <style type="text/css">
    	//body{background:white url(portal.gif) transparent center no-repeat scroll;}
    	#tipo1{color:#000066;background:#FFFFFF;font-size:7pt;font-family:Tahoma;font-weight:bold;}
    	#tipo2{color:#000066;background:#FFFFFF;font-size:9pt;font-family:Tahoma;font-weight:bold;}
    	.tipo3{color:#000066;background:#FFFFFF;font-size:7pt;font-family:Tahoma;font-weight:bold;text-align:left;}
    	.tipo4{color:#000066;background:#dddddd;font-size:6pt;font-family:Tahoma;font-weight:bold;text-align:center;}
    	#tipo5{color:#000066;background:#FFFFFF;font-size:10pt;font-family:Tahoma;font-weight:bold;}
    	.tipo6{color:#000066;background:#FFFFFF;font-size:10pt;font-family:Tahoma;font-weight:bold;text-align:center;}
    	#tipo7{color:#FFFFFF;background:#000066;font-size:12pt;font-family:Tahoma;font-weight:bold;width:30em;}
    	#tipo8{color:#99CCFF;background:#000066;font-size:6pt;font-family:Tahoma;font-weight:bold;}
    	#tipo9{color:#660000;background:#dddddd;font-size:8pt;font-family:Tahoma;font-weight:bold;text-align:center;}
    	#tipo10{color:#FFFFFF;background:#000066;font-size:10pt;font-family:Tahoma;font-weight:bold;text-align:center;}
    	#tipo11{color:#000066;background:#cccccc;font-size:8pt;font-family:Tahoma;font-weight:bold;width:50em;height:3em;text-align:center;}
    	#tipo11A{color:#000066;background:#999999;font-size:9pt;font-family:Tahoma;font-weight:bold;width:50em;text-align:center;}
    	#tipo11A1{color:#000066;background:#FFFFFF;font-size:10pt;font-family:Arial;font-weight:bold;width:50em;text-align:center;}
    	#tipo11A2{color:#000066;background:#999999;font-size:7pt;font-family:Arial;font-weight:bold;width:50em;text-align:center;}
    	#tipo11A3{color:#000066;background:#FFFFFF;font-size:10pt;font-family:Arial;font-weight:normal;width:50em;text-align:left;}
    	#tipo11B{color:#000066;background:#DDDDDD;font-size:9pt;font-family:Tahoma;font-weight:bold;width:50em;text-align:center;}
    	#tipo12{color:#000066;background:#FFFFFF;font-size:9pt;font-family:Tahoma;font-weight:normal;text-align:left;}
    	#tipo13{color:#000066;background:#99CCFF;font-size:9pt;font-family:Tahoma;font-weight:normal;text-align:left;}
    	#tipo12A{color:#000066;background:#00FF33;font-size:9pt;font-family:Tahoma;font-weight:normal;text-align:left;}
    	#tipo13B{color:#000066;background:#FFFF33;font-size:9pt;font-family:Tahoma;font-weight:normal;text-align:left;}
    	#tipo13A{color:#000066;background:#FFFFFF;font-size:11pt;font-family:Tahoma;font-weight:normal;width:50em;text-align:justify;}
    	#tipo14{color:#FFFFFF;background:#000066;font-size:14pt;font-family:Tahoma;font-weight:bold;text-align:center;}
    	#tipo15{color:#000066;background:#FFFFFF;font-size:7pt;font-family:Tahoma;font-weight:bold;text-align:center;}
    	#tipo16{color:#000066;background:#99CCFF;font-size:7pt;font-family:Tahoma;font-weight:bold;text-align:center;}
    	#tipo17{color:#000066;background:#CC99FF;font-size:7pt;font-family:Tahoma;font-weight:bold;text-align:left;}
    	#tipo18{color:#000066;background:#FFCC66;font-size:7pt;font-family:Tahoma;font-weight:bold;text-align:left;}
    	#tipo19{color:#000066;background:#FFFFFF;font-size:7pt;font-family:Tahoma;font-weight:bold;text-align:center;}
    	
    	#tipoG00{color:#000066;background:#FFFFFF;font-size:7pt;font-family:Tahoma;font-weight:bold;table-layout:fixed;text-align:center;}
    	#tipoG01{color:#FFFFFF;background:#FFFFFF;font-size:5pt;font-family:Tahoma;font-weight:bold;width:6.4em;text-align:center;height:3em;}
    	#tipoG54{color:#000066;background:#DDDDDD;font-size:6pt;font-family:Tahoma;font-weight:bold;width:6.4em;text-align:center;height:3em;}
    	#tipoG11{color:#FFFFFF;background:#99CCFF;font-size:5pt;font-family:Tahoma;font-weight:bold;width:6.4em;text-align:center;height:3em;}
    	#tipoG21{color:#FFFFFF;background:#CC3333;font-size:5pt;font-family:Tahoma;font-weight:bold;width:6.4em;text-align:center;height:3em;}
    	#tipoG32{color:#FF0000;background:#FFFF66;font-size:5pt;font-family:Tahoma;font-weight:bold;width:6.4em;text-align:center;height:3em;}
    	#tipoG33{color:#006600;background:#FFFF66;font-size:5pt;font-family:Tahoma;font-weight:bold;width:6.4em;text-align:center;height:3em;}
    	#tipoG34{color:#000066;background:#FFFF66;font-size:5pt;font-family:Tahoma;font-weight:bold;width:6.4em;text-align:center;height:3em;}
    	#tipoG42{color:#FF0000;background:#00CC66;font-size:5pt;font-family:Tahoma;font-weight:bold;width:6.4em;text-align:center;height:3em;}
    	#tipoG41{color:#FFFFFF;background:#00CC66;font-size:5pt;font-family:Tahoma;font-weight:bold;width:6.4em;text-align:center;height:3em;}
    	#tipoG44{color:#000066;background:#00CC66;font-size:5pt;font-family:Tahoma;font-weight:bold;width:6.4em;text-align:center;height:3em;}
    	
    	#tipoM00{color:#000066;background:#FFFFFF;font-size:7pt;font-family:Tahoma;font-weight:bold;table-layout:fixed;text-align:center;}
    	#tipoM01{color:#000066;background:#DDDDDD;font-size:7pt;font-family:Tahoma;font-weight:bold;width:20em;text-align:left;height:3em;}
    	#tipoM02{color:#000066;background:#99CCFF;font-size:7pt;font-family:Tahoma;font-weight:bold;width:20em;text-align:left;height:3em;}
    	
    </style>
</head>
<body onload=ira() BGCOLOR="FFFFFF" oncontextmenu = "return true" onselectstart = "return true" ondragstart = "return true">
<BODY TEXT="#000066">
<script type="text/javascript">
<!--
	function enter()
	{
		document.forms.ORU_AGFA.submit();
	}
	function printPage()
	{
	    // Do print the page
	    if (typeof(window.print) != 'undefined') 
	    {
	        window.print();
	    }
	}
	function teclado()  
	{ 
		if ((event.keyCode < 48 || event.keyCode > 57  || event.keyCode == 13) & event.keyCode != 46) event.returnValue = false;
	}
	function teclado1()  
	{ 
		if ((event.keyCode < 48 || event.keyCode > 57 ) & event.keyCode != 46 & event.keyCode != 13)  event.returnValue = false;
	}
	function teclado2()  
	{ 
		if ((event.keyCode < 48 || event.keyCode > 57 ) & (event.keyCode < 65 || event.keyCode > 90 ) & (event.keyCode < 97 || event.keyCode > 122 ) & event.keyCode != 13) event.returnValue = false;
	}
	function teclado3()  
	{ 
		if ((event.keyCode < 48 || event.keyCode > 57 ) & (event.keyCode < 65 || event.keyCode > 90 ) & (event.keyCode < 97 || event.keyCode > 122 ) & event.keyCode != 13 & event.keyCode != 45) event.returnValue = false;
	}

//-->
</script>
<?php
include_once("conex.php");
/**********************************************************************************************************************  
	   PROGRAMA : ORU_AGFA.php
	   Fecha de Liberacion : 2009-09-07
	   Autor : Ing. Pedro Ortiz Tamayo
	   Version Actual : 2016-01-20
	   
	   OBJETIVO GENERAL :Este programa ofrece al usuario una interface grafica que permite verificar las lecturas que
	   llegan a MATRIX a traves de mensajeria HL7 (ORU) proveniente de RIS 
	   
	   
	   REGISTRO DE MODIFICACIONES :
	   .2016-01-20
			Se reemplazan tildes circunflejas "^" por espacios en blanco &nbsp;
			
	   .2012-05-08
			Se corrigen los nulos de los querys ODBC
			
	   .2009-11-27
	   		Se modifico el programa para mostrar la fecha del estudio en el tablero de busqueda.
	   			.Amarilla si la fecha no es confiable.
	   			.Verde si es confiable.
	   		
	   .2009-10-01
	   		Se modifico el programa para mostrar solamente los mensajes ORU con Facturable = "on".
	   		Se le agrega al programa busqueda x  el nombre del paciente.
	   		
	   .2009-09-30
	   		Se modifico el programa para mostrar desde Servinte los cargos asociados a la lectura.
	   		
	   .2009-09-07
	   		Release de Versi�n Beta.
	   		
***********************************************************************************************************************/
function ver($chain)
{
	if(strpos($chain,"-") === false)
		return $chain;
	else
		return substr($chain,0,strpos($chain,"-"));
}
function validar1($chain)
{
	// Funcion que permite validar la estructura de un numero Real
	$decimal ="^(\+|-)?([[:digit:]]+)\.([[:digit:]]+)$";
	if (ereg($decimal,$chain,$occur))
		if(substr($occur[2],0,1)==0 and strlen($occur[2])!=1)
			return false;
		else
			return true;
	else
		return false;
}
function validar2($chain)
{
	// Funcion que permite validar la estructura de un numero Entero
	$regular="^(\+|-)?([[:digit:]]+)$";
	if (ereg($regular,$chain,$occur))
		if(substr($occur[2],0,1)==0 and strlen($occur[2])!=1)
			return false;
		else
			return true;
	else
		return false;
}
function validar3($chain)
{
	// Funcion que permite validar la estructura de una fecha
	$fecha="^([[:digit:]]{4})-([[:digit:]]{1,2})-([[:digit:]]{1,2})$";
	if(ereg($fecha,$chain,$occur))
	{
		if($occur[2] < 0 or $occur[2] > 12)
			return false;
		if(($occur[3] < 0 or $occur[3] > 31) or 
		  ($occur[2] == 4 and  $occur[3] > 30) or 
		  ($occur[2] == 6 and  $occur[3] > 30) or 
		  ($occur[2] == 9 and  $occur[3] > 30) or 
		  ($occur[2] == 11 and $occur[3] > 30) or 
		  ($occur[2] == 2 and  $occur[3] > 29 and bisiesto($occur[1])) or 
		  ($occur[2] == 2 and  $occur[3] > 28 and !bisiesto($occur[1])))
			return false;
		return true;
	}
	else
		return false;
}
function validar4($chain)
{
	// Funcion que permite validar la estructura de un dato alfanumerico
	$regular="^([=a-zA-Z0-9' '��@?/*#-.:;_<>])+$";
	return (ereg($regular,$chain));
}
function validar5($chain)
{
	// Funcion que permite validar la estructura de un dato numerico
	$regular="^([0-9:])+$";
	return (ereg($regular,$chain));
}
function validar6($chain)
{
	// Funcion que permite validar la estructura de un campo Hora
	$hora="^([[:digit:]]{1,2}):([[:digit:]]{1,2}):([[:digit:]]{1,2})$";
	if(ereg($hora,$chain,$occur))
		if($occur[1] < 0 or $occur[1] >23 or $occur[2]<0 or $occur[2]>59)
			return false;
		else
			return true;
	else
		return false;
}
function validar7($chain)
{
	// Funcion que permite validar la estructura de un campo Hora Especial
	$hora="^([[:digit:]]{1,2}):([[:digit:]]{1,2})$";
	if(ereg($hora,$chain,$occur))
		if($occur[1] < 0 or $occur[1] >23 or ($occur[2]!=0 and $occur[2]!=30))
			return false;
		else
			return true;
	else
		return false;
}

function valgen($ok,$conex,$wtem,&$werr,&$e)
{
	global $empresa;
	//VALIDACION DE DATOS GENERALES
	if(!validar4($wtem) or $wtem == "0-NO APLICA"  or $wtem == "-" or $wtem == "SELECCIONE")
	{
		$e=$e+1;
		$werr[$e]="ERROR NO ESCOGIO UNIDAD";
	}
	if($e == -1)
		return true;
	else
		return false;
}

function comparacion($vec1,$vec2)
{
	if($vec1[0] > $vec2[0])
		return 1;
	elseif ($vec1[0] < $vec2[0])
				return -1;
			else
				return 0;
}

		
@session_start();
if(!isset($_SESSION['user']))
	echo "error";
else
{
	$key = substr($user,2,strlen($user));
	echo "<form name='ORU_AGFA' action='ORU_AGFA.php' method=post>";
	

	

	echo "<center><input type='HIDDEN' name= 'empresa' value='".$empresa."'>";
	echo "<input type='HIDDEN' name= 'tmensaje' value='".$tmensaje."'>";
	
	$prioridad="off";
	
	switch($ok)
	{
		case 99: 
			echo "<input type='HIDDEN' name= 'ok' value='".$ok."'>";
			echo "<table border=0 align=center>";
			?>
			<script>
				function ira(){document.ORU_AGFA.wfecha.focus();}
			</script>
			<?php
			echo "<tr><td align=center colspan=4><IMG SRC='/matrix/images/medical/INTERFACES/logo_".$empresa.".png'></td></tr>";
			echo "<tr><td align=right colspan=4><font size=2>Ver. 2016-01-20</font></td></tr>";
			echo "<tr><td align=center bgcolor='#000066' colspan=4><font size=4 color=#ffffff FACE=Arial><b>MENSAJES ORU DE PACIENTES RIS-PACS Ver. 2016-01-20</b></font></td></tr>";
			if (!isset($wfecha))
				$wfecha=date("Y-m-d");
			if (!isset($wfechai))
				$wfechai=date("Y-m-d");
			if (!isset($wfechaf))
				$wfechaf=date("Y-m-d");
			if (!isset($wdoci))
				$wdoci="";
			if (!isset($wnom))
				$wnom="";
			if (!isset($wtdo))
				$wtdo="0-SELECCIONE";
			$year = (integer)substr($wfecha,0,4);
			$month = (integer)substr($wfecha,5,2);
			$day = (integer)substr($wfecha,8,2);
			$nomdia=mktime(0,0,0,$month,$day,$year);
			$nomdia = strftime("%w",$nomdia);
			$wsw=0;
			switch ($nomdia)
			{
				case 0:
					$diasem = "DOMINGO";
					break;
				case 1:
					$diasem = "LUNES";
					break;
				case 2:
					$diasem = "MARTES";
					break;
				case 3:
					$diasem = "MIERCOLES";
					break;
				case 4:
					$diasem = "JUEVES";
					break;
				case 5:
					$diasem = "VIERNES";
					break;
				case 6:
					$diasem = "SABADO";
					break;
			}
			echo "<tr><td bgcolor='#cccccc' align=center colspan=4><b>FECHA :</b>";
			echo "<b>".$diasem."</b> ";
			echo "<input type='TEXT' name='wfecha' size=10 maxlength=10 readonly='readonly' value=".$wfecha." class=tipo6></td></tr>";
			echo "<tr><td bgcolor='#cccccc' align=center colspan=4><b>Fecha Inicial : </b><input type='TEXT' name='wfechai' size=10 maxlength=10 id='wfechai' readonly='readonly' value=".$wfechai." class=tipo6>&nbsp;&nbsp;<IMG SRC='/matrix/images/medical/interfaces/calendario.jpg' id='trigger1'>&nbsp;&nbsp;";
			?>
				<script type="text/javascript">//<![CDATA[
					Zapatec.Calendar.setup({weekNumbers:false,showsTime:true,timeFormat:'12',electric:false,inputField:'wfechai',button:'trigger1',ifFormat:'%Y-%m-%d',daFormat:'%Y/%m/%d'});	
				//]]></script>
			<?php
			echo "<b>Fecha Final : </b><input type='TEXT' name='wfechaf' size=10 maxlength=10 id='wfechaf' readonly='readonly' value=".$wfechaf." class=tipo6>&nbsp;&nbsp;<IMG SRC='/matrix/images/medical/interfaces/calendario.jpg' id='trigger2'>";
			?>
				<script type="text/javascript">//<![CDATA[
					Zapatec.Calendar.setup({weekNumbers:false,showsTime:true,timeFormat:'12',electric:false,inputField:'wfechaf',button:'trigger2',ifFormat:'%Y-%m-%d',daFormat:'%Y/%m/%d'});	
				//]]></script>
			<?php
			echo "</td></tr>";
			echo "<tr>";
			echo "<td bgcolor='#cccccc' colspan=4 align=center><b>Tipo de Documento : </b>";
			$query = "SELECT Selcod, Seldes  from clisur_000105 where Seltip='01' and Selest='on' order by Selpri";
			$err = mysql_query($query,$conex) or die(mysql_errno().":".mysql_error());
			$num = mysql_num_rows($err);
			echo "<select name='wtdo' id=tipo1>";
			echo "<option>0-SELECCIONE</option>";
			if ($num>0)
			{
				for ($i=0;$i<$num;$i++)
				{
					$row = mysql_fetch_array($err);
					$wtdo=ver($wtdo);
					if($wtdo == $row[0])
						echo "<option selected>".$row[0]."-".$row[1]."</option>";
					else
						echo "<option>".$row[0]."-".$row[1]."</option>";
				}
			}
			echo "</select>";
			echo "</td>";
			echo "</tr>";
			echo "<tr><td bgcolor='#cccccc' colspan=4 align=center><b>Identificacion : </b><input type='TEXT' name='wdoci' size=15 maxlength=30  value='".$wdoci."' class=tipo6></td></tr>";
			echo "<tr><td bgcolor='#cccccc' colspan=4 align=center><b>Paciente : </b><input type='TEXT' name='wnom' size=30 maxlength=30  value='".$wnom."' class=tipo6></td></tr>";
			echo "<tr><td bgcolor='#999999' colspan=4 align=center><input type='submit' value='IR'></td></tr>";
			echo "</table><br>";
			
			echo "<input type='HIDDEN' name= 'ok' value='".$ok."'>";
			//                  0       1       2              3       4       5            6         7        8           9          10       11
			$query = "select Tipo, Numero, Identificacion, Paciente, Texto, Medico_rx, Facturable, Validado, Anumber, Fecha_data, Hora_data, Fecham  ";
			$query .= " from ".$empresa."_000007 ";
			$query .= " where Tipo = '".$tmensaje."'  ";
			if(!isset($wnom) or $wnom == "")
			{
				$query .= " and Fecha_Data between '".$wfechai."'  and '".$wfechaf."'";
				if($wdoci != "" and $wtdo != "0")
					$query .= " and Identificacion = '".$wtdo.$wdoci."'  ";
			}
			else
			{
				$query .= " and Paciente like '%".$wnom."%' ";
			}
			$query .= " and Validado = 'off'  ";
			$query .= " and Facturable = 'on'  ";
			$query .= " order by Numero ";
			$err = mysql_query($query,$conex) or die(mysql_errno().":".mysql_error());
			$num = mysql_num_rows($err);
			if ($num>0)
			{
				
				echo "<table border=0 align=center id=tipo5>";
				echo "<tr><td bgcolor='#cccccc' align=center colspan=10>".$num." MENSAJES ".$tmensaje." PENDIENTES DE REVISION</td></tr>";
				echo "<tr><td bgcolor='#999999' align=center>ITEM</td><td bgcolor='#999999' align=center>NUMERO</td><td bgcolor='#999999' align=center>FECHA ESTUDIO</td><td bgcolor='#999999' align=center>IDENTIFICACION</td><td bgcolor='#999999' align=center>PACIENTE</td><td bgcolor='#999999' align=center>MEDICO</td><td bgcolor='#999999' align=center>NUMERO DE ACCESO</td><td bgcolor='#999999' align=center>SELECCION</td></tr>";
				for ($i=0;$i<$num;$i++)
				{
					$j = $i + 1;
					$row = mysql_fetch_array($err);
					$fechap=substr($row[9],0,4).substr($row[9],5,2).substr($row[9],8,2).substr($row[10],0,2).substr($row[10],3,2).substr($row[10],6,2);
					$fechai=substr($row[11],6,2)."/".substr($row[11],4,2)."/".substr($row[11],0,4)." ".substr($row[11],8,2).":".substr($row[11],10,2).":".substr($row[11],12,2);
					if($fechap == $row[11])
						$tipo1="tipo13B"; 
					else
						$tipo1="tipo12A"; 
					if($i % 2 == 0)
						$tipo="tipo13";
					else
						$tipo="tipo12";
					$path="/matrix/interfaces/procesos/ORU_AGFA.php?ok=1&empresa=".$empresa."&tmensaje=".$tmensaje."&numeromsj=".$row[1]."&identificacion=".$row[2]."&wfechai=".$wfechai."&wfechaf=".$wfechaf."&wtdo=".$wtdo."&wdoci=".$wdoci."&wan=".$row[8]."&wfechaw=".$row[9]."&wnom=".$wnom." ";
					echo "<tr><td id=".$tipo.">".$j."</td><td id=".$tipo.">".$row[1]."</td><td id=".$tipo1.">".$fechai."</td><td id=".$tipo.">".$row[2]."</td><td id=".$tipo.">".$row[3]."</td><td id=".$tipo.">".$row[5]."</td><td id=".$tipo.">".$row[8]."</td><td id=".$tipo."><A HREF='".$path."'>Editar</A></td></tr>";
				}
			}
			echo "</table></center>";
		break;
		case 1:
			echo "<iframe src='/matrix/interfaces/procesos/ORU_AGFA.php?ok=0&accion=1&empresa=".$empresa."&tmensaje=".$tmensaje."&numeromsj=".$numeromsj."&identificacion=".$identificacion."&wfechai=".$wfechai."&wfechaf=".$wfechaf."&wtdo=".$wtdo."&wdoci=".$wdoci."&wan=".$wan."&wfechaw=".$wfechaw."&wnom=".$wnom."' name='encabezado' marginwidth=0 scrolling='auto' framespacing='0' frameborder='0' border='1' height='500' width='800' marginheiht=1 style='position: absolute; top: 0px; left: 0px;'>";
			echo "</iframe>";
			echo "<iframe src='/matrix/interfaces/procesos/ORU_AGFA.php?ok=0&accion=2&empresa=".$empresa."&tmensaje=".$tmensaje."&numeromsj=".$numeromsj."&identificacion=".$identificacion."&wfechai=".$wfechai."&wfechaf=".$wfechaf."&wtdo=".$wtdo."&wdoci=".$wdoci."&wan=".$wan."&wfechaw=".$wfechaw."&wnom=".$wnom."' name='lectura' marginwidth=0 scrolling='auto' framespacing='0' frameborder='0' border='1' height='1200' width='800' marginheiht=1 style='position: absolute; top: 500px; left: 0px;'>";
			echo "</iframe>";
		break;
		case 0:
			echo "<input type='HIDDEN' name= 'identificacion' value='".$identificacion."'>";
			echo "<input type='HIDDEN' name= 'tmensaje' value='".$tmensaje."'>";
			echo "<input type='HIDDEN' name= 'empresa' value='".$empresa."'>";
			echo "<input type='HIDDEN' name= 'numeromsj' value='".$numeromsj."'>";
			echo "<input type='HIDDEN' name= 'identificacion' value='".$identificacion."'>";
			echo "<input type='HIDDEN' name= 'wfechai' value='".$wfechai."'>";
			echo "<input type='HIDDEN' name= 'wfechaf' value='".$wfechaf."'>";
			echo "<input type='HIDDEN' name= 'wtdo' value='".$wtdo."'>";
			echo "<input type='HIDDEN' name= 'wdoci' value='".$wdoci."'>";
			echo "<input type='HIDDEN' name= 'ok' value='".$ok."'>";
			echo "<input type='HIDDEN' name= 'wan' value='".$wan."'>";
			echo "<input type='HIDDEN' name= 'accion' value='".$accion."'>";
			
			switch($accion)
			{
				case 1:
					$wok=0;
					echo "<table border=0 align=center id=tipo2>";
					echo "<tr><td align=center colspan=6><IMG SRC='/matrix/images/medical/INTERFACES/logo_".$empresa.".png'></td></tr>";
					echo "<tr><td align=right colspan=6><font size=2>Ver. 2009-09-01</font></td></tr>";
					//******* INICIALIZACION DEL SISTEMA *********
					if(isset($ok) and $ok == 9)
						$ok=0;
							
					
					//********************************************************************************************************
					//*                                         DATOS DEL MENSAJE                                            *                                
					//********************************************************************************************************
					
					//                  0       1       2       3       4       5       6       7       8       9      10      11      12      13      14      15      16
					$query = "select Pactdc, Pacdoc, Pacnom, Pacap1, Pacap2, Pacfna, Pacsex, Pacest, Pacdir, Pactel, Pacpai, Pacmun, Pacbar, Paczon, Pacofi, Pacres, Pacmed ";
					$query .= " from ".$empresa."_000002 ";
					$query .= " where Pactdc = '".substr($identificacion,0,2)."'  ";
					$query .= "   and Pacdoc = '".substr($identificacion,2)."' ";
					$err = mysql_query($query,$conex) or die(mysql_errno().":".mysql_error());
					$num = mysql_num_rows($err);
					$row = mysql_fetch_array($err);
					echo "<tr><td align=center bgcolor='#000066'colspan=6><b><font size=4 color=#ffffff FACE=Arial><b>MENSAJES ORU DE PACIENTES RIS-PACS</b></font></b></td></tr>";
					$color="#dddddd";
					$color1="#000099";
					$color2="#006600";
					$color3="#cc0000";
					$color4="#CC99FF";
					$color5="#99CCFF";
					$color6="#FF9966";
					$color7="#cccccc";
					$color8="#FFFFFF";
					echo "<tr><td align=center bgcolor=#999999 colspan=6><b>MENSAJES ".$tmensaje." PENDIENTES DE VALIDACION Ver. 2016-01-20</b></td></tr>";
					
					//PRIMERA LINEA
					echo "<tr>";
					echo "<td bgcolor=".$color." align=center>Tipo doc. : <br>".$row[0]."</td>";
					echo "<td bgcolor=".$color." align=center>Identificacion. :<br>".$row[1]."</td>";
					$nombre=$row[2]." ".$row[3]." ".$row[4];
					echo "<td bgcolor=".$color." align=center>Nombre :<br>".$nombre."</td>";
					echo "<td bgcolor=".$color." align=center>F. Nacimiento :<br>".$row[5]."</td>";
					echo "<td bgcolor=".$color." align=center>Sexo :<br>".$row[6]."</td>";
					switch($row[7])
					{
						case "S": 
							$estado="SOLTERO(a)";
						break;
						case "C": 
							$estado="CASADO(a)";
						break;
						case "V": 
							$estado="VIUDO(a)";
						break;
						case "M": 
							$estado="MENOR";
						break;
						case "D": 
							$estado="DIVORCIADO(a)";
						break;
						case "U": 
							$estado="UNION LIBRE";
						break;
					}
					echo "<td bgcolor=".$color." align=center>Estado Civil :<br>".$estado."</td>";
					echo "</tr>";
					
					//SEGUNDA LINEA
					echo "<tr>";
					echo "<td bgcolor=".$color." align=center>Direccion :<br>".$row[8]."</td>";
					echo "<td bgcolor=".$color." align=center>Telefonos :<br>".$row[9]."</td>";
					$query = "SELECT Nombre  from  root_000006 where Codigo='".$row[10]."' ";
					$err1 = mysql_query($query,$conex) or die(mysql_errno().":".mysql_error());
					$num1 = mysql_num_rows($err1);
					if ($num1 > 0)
					{
						$row1 = mysql_fetch_array($err1);
					}
					else
					{
						$row1=array();
						$row1[0]="";
					}
					echo "<td bgcolor=".$color." align=center>Pais :<br>".$row1[0]."</td>";
					$query = "SELECT Nombre  from  root_000006 where Codigo='".$row[11]."' ";
					$err1 = mysql_query($query,$conex) or die(mysql_errno().":".mysql_error());
					$num1 = mysql_num_rows($err1);
					if ($num1 > 0)
					{
						$row1 = mysql_fetch_array($err1);
					}
					else
					{
						$row1=array();
						$row1[0]="";
					}
					echo "<td bgcolor=".$color." align=center>Municipio :<br>".$row1[0]."</td>";
					$query = "SELECT Bardes  from  root_000034 where Barcod='".$row[11]."' and Barmun='".$row[12]."' ";
					$err1 = mysql_query($query,$conex) or die(mysql_errno().":".mysql_error());
					$num1 = mysql_num_rows($err1);
					if ($num1 > 0)
					{
						$row1 = mysql_fetch_array($err1);
					}
					else
					{
						$row1=array();
						$row1[0]="";
					}
					echo "<td bgcolor=".$color." align=center>Barrio :<br>".$row1[0]."</td>";
					switch($row[13])
					{
						case "R": 
							$zona="RURAL";
						break;
						case "U": 
							$zona="URBANA";
						break;
					}
					echo "<td bgcolor=".$color." align=center>Zona :<br>".$zona."</td>";
					echo "</tr>";
					
					//TERCERA LINEA
					$query = "SELECT Descripcion from  root_000003 where Codigo='".$row[14]."' ";
					$err1 = mysql_query($query,$conex) or die(mysql_errno().":".mysql_error());
					$num1 = mysql_num_rows($err1);
					if ($num1 > 0)
					{
						$row1 = mysql_fetch_array($err1);
					}
					else
					{
						$row1=array();
						$row1[0]="";
					}
					echo "<td bgcolor=".$color." align=center colspan=3>Oficio :<br>".$row1[0]."</td>";
					$query = "SELECT Empdes from ".$empresa."_000005 where Empnit='".$row[14]."' ";
					$err1 = mysql_query($query,$conex) or die(mysql_errno().":".mysql_error());
					$num1 = mysql_num_rows($err1);
					if ($num1 > 0)
					{
						$row1 = mysql_fetch_array($err1);
					}
					else
					{
						$row1=array();
						$row1[0]="";
					}
					echo "<td bgcolor=".$color." align=center colspan=3>Responsable :<br>".$row1[0]."</td>";
					
					
					echo "</tr>";
					
					//PARTE CENTRAL DE LA PANTALLA 
					echo "<tr><td bgcolor=#DDDDDD colspan=6 align=center><A HREF='AgfaHC://impax-client-epr?Domain=Agfa Healthcare&patientid=".$identificacion."&accession=".$wan."&user=sistemas&password=sistemas'>Imagenes</A></td></tr>";
					echo "<tr><td bgcolor=#999999 colspan=6 align=center><input type='submit' value='OK'></td></tr>";
					echo "<tr><td bgcolor=#ffffff colspan=6 align=center><A HREF='/MATRIX/interfaces/Procesos/ORU_AGFA.php?ok=99&empresa=".$empresa."&tmensaje=".$tmensaje."&numeromsj=".$row[1]."&identificacion=".$row[2]."&wfechai=".$wfechai."&wfechaf=".$wfechaf."&wtdo=".$wtdo."&wdoci=".$wdoci."&wnom=".$wnom."' target='_top'><IMG SRC='/matrix/images/medical/INTERFACES/lista.png' alt='Lista'><br>Lista</A></td></tr></table><br><br></center>";
					
					$wfechaw=str_replace("-","/",$wfechaw);
					$query  = "select movdoc, movtip, movhis, movnum from aymov ";
					$query .= " where (movfue = 'RA' ";
					$query .= "    or  movfue = 'RX' ";
					$query .= "    or  movfue = 'SF') ";
					$query .= "   and movtid = '".substr($identificacion,0,2)."'";
					$query .= "   and movced = '".substr($identificacion,2)."'";
					$query .= "   and movfec <= '".$wfechaw."'";
					$query .= "   and movdoc is not null";
					$query .= "   and movtip is not null";
					$query .= "   and movhis is not null";
					$query .= "   and movnum is not null";
					$query .= " order by movdoc desc ";
					$conex_o = odbc_connect('facturacion','','');
					$err_o = odbc_do($conex_o,$query);
					$campos= odbc_num_fields($err_o);
					$count=0;
					if(odbc_fetch_row($err_o))
					{
						$count += 1;
						$odbc=array();
						for($m=1;$m<=$campos;$m++)
						{
							$odbc[$m-1]=odbc_result($err_o,$m);
						}
					}
					if($count > 0 and $odbc[1] == "I")
					{
						$query  = "select movhis,movnum,movfec,movhor,cardetfue,cardetdoc,exacod,exanom ";
						$query .= "  from aymov,facardet,inexa ";
						$query .= "  where movhis = ".$odbc[2];
						$query .= "    and movnum = ".$odbc[3];
						$query .= "    and (movfue = 'RA' ";
						$query .= "     or  movfue = 'RX' ";
						$query .= "     or  movfue = 'SF') ";
						$query .= "    and movfue = cardetfue ";
						$query .= "    and movdoc = cardetdoc ";
						$query .= "    and cardetcod = exacod ";
						$query .= "    and exacod != '0' ";
						$query .= "    and movhis is not null";
						$query .= "    and movnum is not null";
						$query .= "    and movfec is not null";
						$query .= "    and movhor is not null";
						$query .= "    and cardetfue is not null";
						$query .= "    and cardetdoc is not null";
						$query .= "    and exacod is not null";
						$query .= "    and exanom is not null";
						$query .= " order by movfec,movhor ";
						$conex_o = odbc_connect('facturacion','','');
						$err_o = odbc_do($conex_o,$query);
						$campos= odbc_num_fields($err_o);
						$count=-1;
						$data=array();
						while(odbc_fetch_row($err_o))
						{
							$count += 1;
							$odbc=array();
							for($m=1;$m<=$campos;$m++)
							{
								$odbc[$m-1]=odbc_result($err_o,$m);
							}
							$data[$count][0]=$odbc[0];
							$data[$count][1]=$odbc[1];
							$data[$count][2]=$odbc[2];
							$data[$count][3]=$odbc[3];
							$data[$count][4]=$odbc[4];
							$data[$count][5]=$odbc[5];
							$data[$count][6]=$odbc[6];
							$data[$count][7]=$odbc[7];
						}
					
						echo "<br><center><table border=0 aling=center id=tipo2>";
						echo "<tr><td align=center bgcolor=#999999 colspan=8>CARGOS DE IMAGENES DIAGNOSTICAS DEL PACIENTE</td></tr>";
						echo "<tr><td align=center bgcolor=".$color.">HISTORIA</td><td align=center bgcolor=".$color.">INGRESO</td><td align=center bgcolor=".$color.">FECHA</td><td align=center bgcolor=".$color.">HORA</td><td align=center bgcolor=".$color.">FUENTE</td><td align=center bgcolor=".$color.">NRo. CARGO</td><td align=center bgcolor=".$color.">EXAMEN</td><td align=center bgcolor=".$color.">DESCRIPCION</td></tr>";
						for ($i=0;$i<=$count;$i++)
						{
							if($i % 2 == 0)
								$COLOR = $color5;
							else
								$COLOR = $color8;
							echo "<tr><td align=center bgcolor=".$COLOR.">".$data[$i][0]."</td><td align=center bgcolor=".$COLOR.">".$data[$i][1]."</td><td align=center bgcolor=".$COLOR.">".$data[$i][2]."</td><td align=center bgcolor=".$COLOR.">".$data[$i][3]."</td><td align=center bgcolor=".$COLOR.">".$data[$i][4]."</td><td align=center bgcolor=".$COLOR.">".$data[$i][5]."</td><td align=center bgcolor=".$COLOR.">".$data[$i][6]."</td><td align=center bgcolor=".$COLOR.">".$data[$i][7]."</td></tr>";
						}
						echo"</table>";
					}
					
					if(isset($werr) and isset($e) and $e > -1)
					{
						echo "<br><br><center><table border=0 aling=center id=tipo2>";
						for ($i=0;$i<=$e;$i++)
							if(substr($werr[$i],0,3) == "OK!")
								echo "<tr><td align=center bgcolor=".$color5."><IMG SRC='/matrix/images/medical/root/feliz.ico'>&nbsp&nbsp<font color=#000000 face='tahoma'></font></TD><TD bgcolor=".$color5."><font color=#000000 face='tahoma'><b>".$werr[$i]."</b></font></td></tr>";
							else
								echo "<tr><td align=center bgcolor=".$color4."><IMG SRC='/matrix/images/medical/root/Malo.ico'>&nbsp&nbsp<font color=#000000 face='tahoma'></font></TD><TD bgcolor=".$color4."><font color=#000000 face='tahoma'><b>".$werr[$i]."</b></font></td></tr>";
						echo "</table><br><br></center>";
					}
				break;
				case 2:
					//********************************************************************************************************
					//*                             DATOS ASOCIADOS AL MENSAJE                                               *                                                                 
					//********************************************************************************************************
					
					$wfechaw=str_replace("-","/",$wfechaw);
					$query  = "select movdoc, movtip, movhis, movnum from aymov ";
					$query .= " where (movfue = 'RA' ";
					$query .= "    or  movfue = 'RX' ";
					$query .= "    or  movfue = 'SF') ";
					$query .= "   and movtid = '".substr($identificacion,0,2)."'";
					$query .= "   and movced = '".substr($identificacion,2)."'";
					$query .= "   and movfec <= '".$wfechaw."'";
					$query .= "   and movdoc is not null";
					$query .= "   and movtip is not null";
					$query .= "   and movhis is not null";
					$query .= "   and movnum is not null";
					$query .= " order by movdoc desc ";
					$conex_o = odbc_connect('facturacion','','');
					$err_o = odbc_do($conex_o,$query);
					$campos= odbc_num_fields($err_o);
					$count=0;
					if(odbc_fetch_row($err_o))
					{
						$count += 1;
						$odbc=array();
						for($m=1;$m<=$campos;$m++)
						{
							$odbc[$m-1]=odbc_result($err_o,$m);
						}
					}
					if($count > 0)
					{
						if($odbc[1] == "I")
							$tipo="HOSPITALIZADO";
						else
							$tipo="AMBULATORIO";
					}
					$wok=0;
					echo"<center>";
					echo "<table border=0 align=center id=tipo2>";
					echo "<tr><td id=tipo11A1>CLINICA LAS AMERICAS</td></tr>";
					echo "<tr><td id=tipo11A>LECTURA DEL RADIOLOGO EN EL RIS</td></tr>";
					//echo "<tr><td id=tipo11A3><b>Fecha : </b>".date("d/m/Y h:i:s a")."</td></tr>";
					//if($tipo == "HOSPITALIZADO")
						//echo "<tr><td id=tipo11A3><b>Paciente : </b>".$tipo."<b></td></tr>";
					//else
						//echo "<tr><td id=tipo11A3><b>Paciente : </b>".$tipo."<b></td></tr>";
					//echo "<tr><td id=tipo11A3></td></tr>";
					//echo "<tr><td id=tipo11A3></td></tr>";
					//echo "<tr><td id=tipo11A1><input type='button' class='print_ignore' id='print' value='Print' onclick='printPage()' /></td></tr>";
					//echo "<tr><td id=tipo11B><A HREF='AgfaHC://impax-client-epr?Domain=Agfa Healthcare&patientid=".$identificacion."&accession=".$wan."&user=sistemas&password=sistemas'>Imagenes</A></td></tr>";
					$query = "select Texto ";
					$query .= " from ".$empresa."_000007 ";
					$query .= " where Tipo   = '".$tmensaje."' ";
					$query .= "   and Numero = ".$numeromsj;
					$err2 = mysql_query($query,$conex) or die(mysql_errno().":".mysql_error());
					$row2 = mysql_fetch_array($err2);
					$Lectura=$row2[0];
					//$pos=strpos($Lectura,",");
					//$Lectura="Medell&iacute;n ".substr($Lectura,$pos);
					$Lectura=str_replace(".br","<br>",$Lectura);
					$Lectura=str_replace("^","&nbsp;",$Lectura);
					$Lectura=str_replace("Nombre:","<b>Nombre:</b>",$Lectura);
					$Lectura=str_replace("Estudio:","<b>Estudio:</b>",$Lectura);
					$Lectura=str_replace("Medico tratante:","<b>Medico tratante:</b>",$Lectura);
					$Lectura=str_replace("Medico:","<b>Medico:</b>",$Lectura);
					$Lectura=str_replace("DR.","<br>Informe Firmado Electr&oacute;nicamente/ validado Radi&oacute;logo : <br>DR.",$Lectura);
					$Lectura=str_replace("DRA.","<br>Informe Firmado Electr&oacute;nicamente/ validado Radi&oacute;logo : <br>DRA.",$Lectura);
					echo "<tr><td id=tipo13A>".$Lectura."</td></tr>";
					echo "<tr onclick='printPage()'><td id=tipo11A2>Pr.</td></tr>";
					echo "</table>";
					echo"</center>";
				break;
			}
			echo "<input type='HIDDEN' name= 'wok' value='".$wok."'>";
			echo"</form>";
		break;
	}
}
?>
</body>
</html>
