<?phpinclude_once("conex.php"); if(!isset($consultaAjax)){?><html lang="es-ES"><!DOCTYPE html><head><title>MATRIX - [AGENDA AMBULATORIAS]</title><meta charset="utf-8">	<link type="text/css" href="../../../include/root/jquery_1_7_2/css/themes/base/jquery-ui.css" rel="stylesheet"/><link rel="stylesheet" href="../../../include/root/jqueryui_1_9_2/cupertino/jquery-ui-cupertino.css" /><script src="../../../include/root/jquery_1_7_2/js/jquery-1.7.2.min.js" type="text/javascript"></script><script src="../../../include/root/jquery_1_7_2/js/jquery-ui.js" type="text/javascript"></script><link rel="stylesheet" href="../../../include/root/bootstrap.min.css"><!--<link href="../../../include/root/fileinput.min.css" media="all" rel="stylesheet" type="text/css" />--><script src="../../../include/root/jquery.min.js"></script><!--<script src="../../../include/root/fileinput.min.js" type="text/javascript"></script>--><script src="../../../include/root/bootstrap.min.js"></script><script type="text/javascript" src="../../../include/root/jquery.easing.min.js"></script><script src="../../../include/root/jquery.form.js" type="text/javascript"></script><link type="text/css" href="../../../include/root/jqueryalert.css" rel="stylesheet" /></script><script type="text/javascript" src="../../../include/root/jqueryalert.js"></script><script type='text/javascript' src='../../../include/root/jquery.quicksearch.js'></script><script type='text/javascript'>$(document).ready(function(){	// Asignar url al modal Admisión		var wurladm       = $("#wurladmision").val();	var wurladmision  = wurladm+$("#wemp_pmla").val();    $("#ifr_admision").attr("src", wurladmision);    // Asignar url al modal Cargos (Facturación)        var wurlfac       = $("#wurlfacturar").val();	var wurlcargos    = wurlfac+$("#wemp_pmla").val()+'&wtema=IPSERP&';    $("#ifr_facturacion").attr('src', wurlcargos);    // Asignar url al modal de Egresos    var wurlegre      = $("#wurlegreso").val();	var wurlegreso    = wurlegre+$("#wemp_pmla").val();    $("#ifr_egreso").attr("src", wurlegreso);        // Asignar url al modal de Impresion     var wurlimp      = $("#wurlimprimir").val();	var wurlimprimir = wurlimp+$("#wemp_pmla").val()+'&historia=hce&accion=CO';    $("#ifr_imprimir").attr("src", wurlimprimir);});    function cargaToolTip(){	var cont1 = 1;	while(document.getElementById('wide'+cont1))	{		 $('#wide'+cont1).tooltip({track: true, delay: 0, showURL: false, showBody: ' - ', opacity: 0.95, left: -50 });		 cont1++;	}}// Llamado ajax para asignar médico tratante pacientefunction asignarMedico(i,tipo_asignacion) {		$('#alta'+i).attr('disabled',false);		var parametros = "consultaAjax=10&basedatos="+document.forms.forma.wbasedato.value+"&basedatoshce="+document.forms.forma.wbasedatohce.value+"&medico=" + document.getElementById('wmedico'+i).value+"&paciente=" +document.getElementById('wpaciente'+i).value+"&ingreso="+document.getElementById('wingreso'+i).value+"&servicio=" +document.getElementById('wservicio'+i).value+"&wemp_pmla="+document.forms.forma.wemp_pmla.value+"&wserviciourl="+document.forms.forma.wserviciourl.value+"&seguridad=" +document.getElementById('wseguridad').value+"&tipo_asignacion="+tipo_asignacion;		try	{		var ajax = nuevoAjax();				ajax.open("POST", "agenda_ambulatorias.php",true);		ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");		ajax.send(parametros);				ajax.onreadystatechange=function() 		{ 			if (ajax.readyState==4 && ajax.status==200)			{ 				if(ajax.responseText!="ok")					alert(ajax.responseText);			} 		}		if ( !estaEnProceso(ajax) ) 		{			ajax.send(null);		}	}catch(e){	}}// Llamado ajax para dar de alta al pacientefunction altaPaciente(i) {	jConfirm("Realmente desea dar de alta el paciente ?","Confirmacion");	$("#modal-btn-si").off("click").on("click",function(){		$( "#jConfirm" ).modal("hide");		var parametros = "consultaAjax=11&basedatos="+document.forms.forma.wbasedato.value+"&basedatoshce="+document.forms.forma.wbasedatohce.value+"&cco="+document.forms.forma.cco.value+"&servicio=" +document.getElementById('wservicio'+i).value+"&paciente=" +document.getElementById('wpaciente'+i).value+"&ingreso=" +document.getElementById('wingreso'+i).value+"&wemp_pmla="+document.forms.forma.wemp_pmla.value+"&wserviciourl="+document.forms.forma.wserviciourl.value+"&seguridad="+document.getElementById('wseguridad').value; 				try		{					var ajax = nuevoAjax();						ajax.open("POST", "agenda_ambulatorias.php",false);			ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");			ajax.send(parametros);			if(ajax.responseText!="ok"){								jAlert(ajax.responseText,'Mensaje');				document.getElementById('alta'+i).checked = false;			}			else{				agendaUrgencias();			}							}catch(e){	}	});	$( "#modal-btn-no" ).off("click").on("click",function(){		document.getElementById('alta'+i).checked = false;		$( "#jConfirm" ).modal("hide");	});}// Llamado ajax para dar de alta por muerte al pacientefunction muertePaciente(i) {	if(confirm("Confirme la muerte del paciente")) 	{		var parametros = "consultaAjax=12&basedatos="+document.forms.forma.wbasedato.value+"&basedatoshce="+document.forms.forma.wbasedatohce.value+"&cco="+document.forms.forma.cco.value+"&paciente=" +document.getElementById('wpaciente'+i).value+"&wemp_pmla="+document.forms.forma.wemp_pmla.value+"&wserviciourl="+document.forms.forma.wserviciourl.value+"&ingreso=" +document.getElementById('wingreso'+i).value+"&seguridad=" +document.getElementById('wseguridad').value;				try		{			var ajax = nuevoAjax();						ajax.open("POST", "agenda_ambulatorias.php",false);			ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");			ajax.send(parametros);			if( ajax.responseText!="ok" )				alert(ajax.responseText);					}catch(e){	}	}	else	{		document.getElementById('muerte'+i).checked = false;		return false;	}	agendaUrgencias();}// Llamado ajax para activar de nuevo un paciente dado de altafunction activarPaciente(i) {	if(confirm("Realmente desea activar el paciente")) 	{		var parametros = "consultaAjax=15&basedatos="+document.forms.forma.wbasedato.value+"&basedatoshce="+document.forms.forma.wbasedatohce.value+"&cco="+document.forms.forma.cco.value+"&paciente=" +document.getElementById('wpaciente'+i).value+"&wemp_pmla="+document.forms.forma.wemp_pmla.value+"&wserviciourl="+document.forms.forma.wserviciourl.value+"&ingreso=" +document.getElementById('wingreso'+i).value+"&seguridad=" +document.getElementById('wseguridad').value; 				try		{			var ajax = nuevoAjax();			ajax.open("POST", "agenda_ambulatorias.php",false);			ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");			ajax.send(parametros);			if (ajax.readyState==4 && ajax.status==200)			{ 				if(ajax.responseText=="activo")					alert('El paciente ya se encuentra activo con otro ingreso');				if(ajax.responseText=="inactivoEnUnix")					alert('El paciente no se puede activar porque no est\u00e1 activo en Unix');			} 					}catch(e){	}	}	else	{		document.getElementById('muerte'+i).checked = false;		return false;	}	agendaUrgencias();}// Llamado ajax para activar de nuevo un paciente dado de altafunction reasignarPaciente(i) {	if(confirm("Realmente desea reasignar la historia del paciente")) 	{		var parametros = "consultaAjax=16&basedatos="+document.forms.forma.wbasedato.value+"&basedatoshce="+document.forms.forma.wbasedatohce.value+"&cco="+document.forms.forma.cco.value+"&paciente=" +document.getElementById('wpaciente'+i).value+"&ingreso=" +document.getElementById('wingreso'+i).value+"&wemp_pmla="+document.forms.forma.wemp_pmla.value+"&wserviciourl="+document.forms.forma.wserviciourl.value+"&seguridad=" +document.getElementById('wseguridad').value; 				try		{			var ajax = nuevoAjax();			ajax.open("POST", "agenda_ambulatorias.php",false);			ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");			ajax.send(parametros);			if (ajax.readyState==4 && ajax.status==200)			{ 				if(ajax.responseText=="no-reasignar")					alert('El paciente tiene más de 1 ingreso. No se puede reasignar este número de historia');			} 					}catch(e){	}	}	else	{		document.getElementById('reasignar'+i).checked = false;		return false;	}	agendaUrgencias();}// Llamado ajax que permite mostrar la lista de pacientes en urgenciasfunction agendaUrgencias(){			var parametros = ""; 		var wespecialidad = $("#wespecialidad").val();		parametros = "consultaAjax=13&basedatos="+document.forms.forma.wbasedato.value+"&basedatoshce="+document.forms.forma.wbasedatohce.value+"&basedatoscliame="+document.forms.forma.wbasedatocliame.value+"&cco="+document.forms.forma.cco.value+"&wemp_pmla="+document.forms.forma.wemp_pmla.value+"&wserviciourl="+document.forms.forma.wserviciourl.value+"&seguridad="+document.getElementById('wseguridad').value+"&servicio="+document.getElementById('wservicio').value+"&wesp="+wespecialidad+"&wcit="+document.getElementById('wcit').value;		try	{		try {			$.blockUI({ message: $('#msjEspere') });		} catch(e){ }		var ajax = nuevoAjax();				ajax.open("POST", "agenda_ambulatorias.php",true);		ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");		ajax.send(parametros);				ajax.onreadystatechange=function() 		{ 			var contenedor = document.getElementById('agendUrg');			if (ajax.readyState==4 && ajax.status==200)			{				contenedor.innerHTML=ajax.responseText;				cargaToolTip();			}			try {				$.unblockUI();			} catch(e){ }		}				if ( !estaEnProceso(ajax) ) 		{			ajax.send(null);		}	}catch(e){	}}// Llamado ajax para ingresar el paciente a la lista de pacientes en urgencia/*// Se usaba para el ingreso del paciente por campo de texto// Ver actualización de Abril 20 de 2011function ingresarPacienteUrg() {	var parametros = "consultaAjax=14&basedatos="+document.forms.forma.wbasedato.value+"&basedatoshce="+document.forms.forma.wbasedatohce.value+"&cco="+document.forms.forma.cco.value+"&whistoria=" +document.getElementById('whistoria').value+"&wemp_pmla="+document.forma.wemp_pmla.value+"&seguridad=" +document.getElementById('wseguridad').value; 		try	{		var ajax = nuevoAjax();				ajax.open("POST", "agenda_ambulatorias.php",false);		ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");		ajax.send(parametros);		if(ajax.responseText=='no-urg') 		{			alert('El paciente no se encuentra en urgencias o el número de la historia ingresada no existe.');		}		else if(ajax.responseText=='existente') 		{			alert('El paciente ya se ha ingresado');		}		else		{			agendaUrgencias();		}		document.getElementById('whistoria').value = '';		if ( !estaEnProceso(ajax) ) 		{			ajax.send(null);		}	}catch(e){	}}*/// Llama a la función de ingreso de paciente a urgencias cuando se teclea enter en el textboxdocument.onkeypress=function(e){	var esIE=(document.all);	var esNS=(document.layers);	tecla=(esIE) ? event.keyCode : e.which;	if(tecla==13)	{		ingresarPaciente();	}}// Valida la historia clínica digitada para el ingreso del pacientefunction ingresarPaciente(){	var historia = document.forms.forma.whistoria.value;	var valido = true;	var mensaje = "";		//validaciones	if(historia == '')	{		mensaje += "Debe especificar una historia clínica \n\r";		document.forms.forma.whistoria.value = '';		valido = false;		} 	else 	{				//Prueba el patron regular... empezar por 1-9, seguido de digitos		var reg = new RegExp("^[1-9]+[0-9]*");     	if(!reg.test(historia))		{			mensaje += 'Debe especificar un numero de historia compuesta por digitos.  Sin cero adelante. \n\r';			document.forms.forma.whistoria.value = '';			valido = false;    	}    		//Historia cero no se permite		if(historia == '0')		{			mensaje += 'Debe especificar una historia clínica diferente de cero \n\r';			document.forms.forma.whistoria.value = '';			valido = false;		}		}		if(!valido)	{		alert("Error: \n\r" + mensaje);		return false;	} 	else 	{		if(confirm("Desea ingresar el paciente a urgencias?"))		{			ingresarPacienteUrg();		}		else		{			return false;		}	}}//Validar la Agenda Multiple para limpiar los campos 'Medico y Conducta' y cargar segundo registro.function asignarAgendaMultiple(i){	    	jConfirm("Realmente desea generar Agenda Multiple?","Confirmacion");	$( "#modal-btn-si" ).off("click").on("click",function(){	       var parametros = "consultaAjax=17&basedatos="+document.forms.forma.wbasedato.value+"&basedatoshce="+document.forms.forma.wbasedatohce.value+"&cco="+document.forms.forma.cco.value+"&paciente=" +document.getElementById('wpaciente'+i).value+"&ingreso=" +document.getElementById('wingreso'+i).value+"&wemp_pmla="+document.forms.forma.wemp_pmla.value+"&wserviciourl="+document.forms.forma.wserviciourl.value+"&seguridad=" +document.getElementById('wseguridad').value; 						$.post("agenda_ambulatorias.php", parametros,	 		      function(data){	                    if  (data.error == true){	 		        	    jAlert(data.message,'Mensaje');	 		        	    document.getElementById('redirec'+i).checked = false;	                    }	 		        	else{	 		        		$( "#wmedico"+i ).val('0');							$( "#wmedico"+i ).attr('disabled',false);							$( "#wconducta"+i ).val(' -- sin asignar -- ');							agendaUrgencias();	 		        	}	 		        	$( "#jConfirm" ).modal("hide");	 		 }, 'json');	});	$( "#modal-btn-no" ).off("click").on("click",function(){		document.getElementById('redirec'+i).checked = false;		$( "#jConfirm" ).modal("hide");	});}// Función para abrir en modal mediante iframe la venta de nueva admisiónfunction abrirVentanaAdmision(){		$("#modalAdmision").modal({ backdrop: 'static',keyboard: false});	$("#ifr_admision").contents().find("body").css("width", "100%");	$("#ifr_admision").contents().find("#principalTitleMatrix").remove();	document.getElementById('ifr_admision').contentWindow.mostrarAdmision();		}//Ventana Cargos - facturacionfunction abrirVentanaCargos(i){	$("#modalFacturacion").modal({ backdrop: 'static',keyboard: false});		//Capturar valores para los inputs en la ventana modal		var whistoria = $("#wpaciente"+i).val();	var wingreso  = $("#wingreso"+i).val();	$("#ifr_facturacion").contents().find("#whistoria").val(whistoria);		$("#ifr_facturacion").contents().find("#wing").val(wingreso);	$("#ifr_facturacion").contents().find("body").css("width", "100%");	$("#ifr_facturacion").contents().find("#principalTitleMatrix").remove();		document.getElementById('ifr_facturacion').contentWindow.cargar_datos(wingreso);	}//Ventana Egresofunction abrirVentanaEgreso(i){	$("#modalEgreso").modal({ backdrop: 'static',keyboard: false});													$("#ifr_egreso").contents().find("body").css("width", "100%");		$("#ifr_egreso").contents().find("#principalTitleMatrix").remove();	//Capturar valores para los inputs en la ventana modal		var whistoria = $("#wpaciente"+i).val();	        $("#ifr_egreso").contents().find("#whisconsultada").val(whistoria);	}//Ventana impresionfunction abrirVentanaImpresion(i,identi,tipoid){	$("#modalImprimir").modal({ backdrop: 'static',keyboard: false});		$("#ifr_imprimir").contents().find("body").css("width", "100%");		$("#ifr_imprimir").contents().find("#tipoT01,#tipoT02,#tipoT03").remove();	//Capturar valores para los inputs en la ventana modal		var whistoria = $("#wpaciente"+i).val();	var wingreso  = $("#wingreso"+i).val();   	$("#ifr_imprimir").contents().find("#whis").val(whistoria);   	//$("#ifr_imprimir").contents().find("#wced").val(identi);	//$("#ifr_impresion").contents().find("#wing").val(wingreso);											}//Función jAlert creada tipo bootstrapfunction jAlert(html,titulo){      if($("#jAlert").length == 0)      {        var div_jAlert =  '<!-- Modal jAlert -->'                          +'<div class="modal fade bd-example-modal-lg" id="jAlert" tabindex="-1" role="dialog" aria-labelledby="alertModalLabel" aria-hidden="false">'                          +'  <div class="modal-dialog" role="document">'                          +'    <div class="modal-content">'                          +'      <div class="modal-header">'                          +'        <h4 class="modal-title" id="alertModalLabel">Modal title</h4>'                          +'      </div>'                          +'      <div class="modal-body" >'                          +'        ...'                          +'      </div>'                          +'      <div class="modal-footer">'                          +'        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>'                          +'      </div>'                          +'    </div>'                          +'  </div>'                          +'</div>';          $("body").append(div_jAlert);      }      $("#jAlert").find(".modal-header").removeClass("bg-danger");      $("#jAlert").find("#alertModalLabel").html(titulo);      $("#jAlert").find(".modal-body").html(html);      var bg = (titulo.toLowerCase() == 'alerta') ? 'bg-danger': 'bg-primary';      $("#jAlert").find(".modal-header").addClass(bg);      $("#jAlert").modal({ backdrop: 'static',                           keyboard: false}).css("z-index", 2030);      if((titulo.toLowerCase() == 'alerta')) { $("#jAlert").css("z-index", 2030); }}//Función jAlert creada tipo bootstrapfunction jConfirm(html,titulo){      var div_Confirm =  '<!-- Modal jConfirm -->'                          +'<div class="modal fade bd-example-modal-lg" id="jConfirm" tabindex="-1" role="dialog" aria-labelledby="alertModalLabel" aria-hidden="false">'                          +'  <div class="modal-dialog" role="document">'                          +'    <div class="modal-content">'                          +'      <div class="modal-header">'                          +'        <h4 class="modal-title" id="alertModalLabel">Modal title</h4>'                          +'      </div>'                          +'      <div class="modal-body" >'                          +'        ...'                          +'      </div>'                          +'      <div class="modal-footer">'                          +'        <button type="button" class="btn btn-default" id="modal-btn-si" data-dismiss="">Si</button>'                          +'        <button type="button" class="btn btn-primary" id="modal-btn-no" >No</button>'                          +'      </div>'                          +'    </div>'                          +'  </div>'                          +'</div>';      $("body").append(div_Confirm);      $("#jConfirm").find(".modal-header").removeClass("bg-danger");      $("#jConfirm").find("#alertModalLabel").html(titulo);      $("#jConfirm").find(".modal-body").html(html);      $("#jConfirm").modal({ backdrop: 'static',                           keyboard: false}).css("z-index", 2030);}window.onload = function() { agendaUrgencias(); }</script><style type="text/css">	.modal {		left: 1%;	}		.modal-header, h4, .close {		background-color: #004b8e; /*#5cb85c;*/		color:white !important;		text-align: center;		font-size: 24px;		  	}	.modal-header {		/*height: 40px*/	}	.modal-footer {		background-color: #f9f9f9;	}	.obligatorio {		color: red	}	.modal-body {		max-height: calc(100vh - 210px);		overflow-y: auto;		overflow-x: hidden;		background-color: InactiveBorder	}	.tdalta {		background-color: lightpink;	}    .tdhabalta {		background-color: #abd8b9;	}	#jAlert,#jConfirm {		    overflow: hidden;            text-align: center;            margin-top: 200px;            margin-left: 450px;            width: 40%;             height: 30%;    }		    @media screen and (min-width: 992px) {        .modal-lg {          width: 100%; /* New width for large modal */        }    }		table {		border-collapse: separate;		border-spacing: 2px;	}	.tooltip.top .tooltip-inner {        background-color:#7094db;    }    .button{	          color: #1b2631;	          font-weight: normal;	          font-size: 10pt;	          width: 118px; height: 25px;	          background: rgb(199,199,199);	          background: -moz-linear-gradient(top,  rgba(199,199,199,1) 0%, rgba(193,193,193,1) 50%, rgba(184,184,184,1) 51%, rgba(224,224,224,1) 100%);	          background: -webkit-linear-gradient(top,  rgba(199,199,199,1) 0%,rgba(193,193,193,1) 50%,rgba(184,184,184,1) 51%,rgba(224,224,224,1) 100%);	          background: linear-gradient(to bottom,  rgba(199,199,199,1) 0%,rgba(193,193,193,1) 50%,rgba(184,184,184,1) 51%,rgba(224,224,224,1) 100%);	          filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#c7c7c7', endColorstr='#e0e0e0',GradientType=0 );	          border: 1px solid #ccc;	          border-radius: 8px;	          box-shadow: 0 1px 1px rgba(0, 0, 0, 0.075) inset;    }</style></head><body style="width:100%"><!-- Modal pantalla Admisión --><div class="modal fade bd-example-modal-lg" id="modalAdmision" role="dialog">		<div class="modal-dialog modal-lg ">			<div class="modal-content" >				<div class="modal-header">				  <button type="button" class="close" data-dismiss="modal">&times;</button>				  <h4 id="tituloResultadoAnalisis">ADMISIÓN DE PACIENTES</h4>				</div>				<div class="modal-body" id="bodyResultadoAnalisis">   					 <iframe id="ifr_admision" src="" height="70%" width="100%" style="border:none;"></iframe> 						</div>    				<div class="modal-footer">					<button type="button" class="btn btn-danger btn-default pull-right" data-dismiss="modal" onclick='agendaUrgencias();'>Cerrar</button>				</div>			</div>		</div></div>  <!--fin modal  admisión -->  <!-- Modal ventana Facturacion -->	<div class="modal fade bd-example-modal-lg" id="modalFacturacion" role="dialog">		<div class="modal-dialog modal-lg ">			<div class="modal-content">				<div class="modal-header">				  <button type="button" class="close" data-dismiss="modal">&times;</button>				  <h4 id="tituloResultadoAnalisis">FACTURACIÓN CLÍNICA</h4>				</div>				<div class="modal-body" id="bodyResultadoAnalisis"> 					 <iframe id="ifr_facturacion" src="" height="100%" width="100%" style="border:none;"></iframe> 						</div>    				<div class="modal-footer">					<button type="button" class="btn btn-danger btn-default pull-right" data-dismiss="modal">Cerrar</button>				</div>			</div>		</div></div>  <!--fin modal ventana Egreso--><!-- Modal ventana Egreso -->	<div class="modal fade bd-example-modal-lg" id="modalEgreso" role="dialog">		<div class="modal-dialog modal-lg ">			<div class="modal-content">				<div class="modal-header">				  <button type="button" class="close" data-dismiss="modal">&times;</button>				  <h4 id="tituloResultadoAnalisis">PROCESO DE EGRESO DEL CLINICA</h4>				</div>				<div class="modal-body" id="bodyResultadoAnalisis"> 					 <iframe id="ifr_egreso" src="" height="100%" width="100%" style="border:none;"></iframe> 						</div>				<div class="modal-footer">					<button type="button" class="btn btn-danger btn-default pull-right" data-dismiss="modal" onclick='agendaUrgencias();'>Cerrar</button>				</div>    			</div>		</div></div>  <!--fin modal ventana Egreso--><!-- Modal ventana Imprimir -->	<div class="modal fade bd-example-modal-lg" id="modalImprimir" role="dialog">		<div class="modal-dialog modal-lg ">			<div class="modal-content">				<div class="modal-header">				  <button type="button" class="close" data-dismiss="modal">&times;</button>				  <h4 id="tituloResultadoAnalisis">IMPRIMIR HISTORIA CLÍNICA</h4>				</div>				<div class="modal-body" id="bodyResultadoAnalisis"> 					 <iframe id="ifr_imprimir" src=""  height="100%" width="100%" style="border:none;"></iframe> 						</div>    				<div class="modal-footer">					<button type="button" class="btn btn-danger btn-default pull-right" data-dismiss="modal">Cerrar</button>				</div> 			</div>		</div></div>  <!--fin modal ventana Egreso--><?phpinclude_once("conex.php");/* **************************** AGENDA URGENCIAS *************************************************** ****************************** DESCRIPCIÓN *************************************************** * Permite el registro de pacientes en urgencias.  * Lista los pacientes ingresados y permite asignar el médico tratante de cada uno * Muestra el estado en que se encuentran los pacientes tratados * Permite establecer estado de alta o muerte para el paciente en urgencias ************************************************************************************************* * Autor: John M. Cadavid. G. * Fecha creacion: 2011-02-16 ************************************************************************************************* * MODIFICACIONES  ************************************************************************************************* //=================================================================================================================\\ * 2020-08-11   Edwin Molina *				Se cambia el calculo de días de estancia desde la fecha y hora de ingreso al servicio a la fecha y hora actual, *				antes era de la fecha de ingreso al servicio hasta la fecha y hora actual //=================================================================================================================\\ * 2018-04-15   Arleyda Insignares C. *              Se adiciona columna 'Agenda Múltiple' a la tabla de pacientes Activos, la cual ejecuta *              una nueva función 'asignarAgendaMultiple' para insertar un nuevo registro en la tabla *              hce_000022 para pacientes que tienen mas de una consulta. *               *              Tener en cuenta parametros en root_000051 *              -ServicioAmbulatorioUnificado: se digitan los servicios que tendran activado el *               programa de manera unificada. *              -FormulariosFirmaHCe: Se digitan los formularios de evolución que se utilizan *               en el query que valida si el formulario se encuentra correctamente firmado por el *               médico, dicho parámetro debe contener los formularios separados por coma. *                *  ************************************************************************************************** * 2018-03-21   Arleyda Insignares C. *              Se adicionan cuatro modales para comunicar el programa con los procesos: admisión, *              egreso, cargos e impresión. *              -Se podrá imprimir la historia cuando tenga el egreso realizado. *              -Se podrán egresar unicamente los pacientes que se hayan dado de Alta. *              - La columna ‘Alta’ aparecerá resaltada con un color, en los siguientes casos: *                Rosado: Se requiere firma de la historia por parte del médico. *                Verde:  El paciente está listo para dar de Alta. ************************************************************************************************** * 2016-04-12   Verónica Arismendy                Se modifica la consulta porque no se estaban teniendno en cuenta las citas de la tabla citasfi_000017  ************************************************************************************************** * 2016-03-03 - Verónica Arismendy                Se valida si llega el parámetro wcit para mostrar en el listado sólo los pacientes que tengan cita el día actual			    Se debe tener en cuenta que actualmente está configurado para fisioterapia, si se desea adicionar otra especialidad 			    se debe actualizar el swicth de la función consultarPrefijoNumeroTabla y configurar la url para que llegue el parámetro $wcit ************************************************************************************************* * 2015-08-25 - Si en la url se declara la variable $wesp y esta tiene codigos de especialidades separadas por guion(-), en el seleciconador				se asignaran esas especialidades a los pacientes, en caso contrario seran medicos. ************************************************************************************************** * 2013-05-10 - En las funciones muertePacienteUrgencias y altaPacienteUrgencias se agregó la consulta para saber  * 				si el cco de ingreso del paciente es hospitalario (se busca en la tabla 000022 de historia clinica electronica (Mtrcci) ) *				y no tiene cco anterior registrado, (se busca en la tabla 000018 de movimiento hospitalario (Ubisan) ) * 				Si es así no se debe registrar el egreso en la tabla 000033 de movimiento hospitalario  * 				Esto porque hubo un paciente al que le registraron por error cco de ingreso 1180 en vez de poner 1800 *				lo cual hizo que al dar de alta al paciente se afectara los indicadores de egresos de cco hospitalarios - Mario Cadavid ************************************************************************************************* * 2013-04-25 - Cuando se da de alta o muerte, se cancela la solicitud de dieta con la funcion *				cancelar_pedido_alimentacion - Frederick Aguirre ************************************************************************************************* * 2013-04-23 - En la función activarPacienteUrgencias se agregó la asignación Mtrmed='' en el query de actualización * 				de la tabla 000022 de historia clinica electronica. Esto porque cuando un médico ya habia tomado un paciente *				y éste es dado de alta, cuando se reactiva el paciente ningun otro medico lo podía tomar pues quedaba inactivo *				el botón Ir a historia en el programa de sala de espera. ************************************************************************************************* * 2013-03-21 - Se comenta la función actualizarPacientesUnix porque el script "hce/procesos/agenda_urgecias_por_especialidad.php"  * 				será el úico encargado de hacer esta actualización de pacientes desde Unix, ya que en éste es donde se realizará todas las  * 				válidaciones y cambios que se deban hacer en esta funcion - Mario Cadavid ************************************************************************************************* * 2013-03-06 - En la función consultarPacienteUnix se adicionó los campos direccion y municipio a la clase paciente *				En las funciones actualizarResponsablePaciente e insertarResponsablePaciente se adicionó la grabación *				en los nuevos campos Ingdir e Ingmun de la tabla 000016 de movimiento hospitalario, grabación que se hace *				desde los campos direccion y municipio a la clase paciente. - Mario Cadavid * ************************************************************************************************* * 2013-02-26 - Se agrega la funcion BorrarAltasMuertesAntesDeAgregarNueva que elimina las altas y muertes de un paciente y actualiza el indicador *				Esto para garantizar que un paciente solo tenga una alta o una muerte en movhos33 *				Se agregan condiciones a dos querys que eliminaban todos los egresos del paciente de movhos33 - Frederick Aguirre ************************************************************************************************* * 2013-02-22 - En las funciones reasignarPacienteUrgencias y altaPacienteurgencias se agregó una consulta para definir *				si los registros de historia e ingreso que se van a borrar tiene registros de movimiento hospitalario, si los tiene, * 				no se borra. En la función altaPacieteUrgencias esto aplica cuando $tipo_alta == "borrado" - Mario Cadavid ************************************************************************************************* * 2013-02-18 - En las funciones altaPacienteUrgencias y muertePacienteUrgencias ya no se modifican los campos *				Mtrtra y seguridad en la tabla hce_000022, tampoco se modifica los campos Ubialp, Ubifap y Ubihap *				en la tabla movhos_000018. En la función activarPacienteUrgencias solo se dejó modificando los campos *				Ubimue='off', Ubiald='off', Ubifad='0000-00-00', Ubihad='00:00:00', Ubiuad=''; es decir solo lo que tenga *				que ver con el alta.  - Mario Cadavid *				En la función borraIngresosMayores se agregó una consulta para definir si los registros de historia e ingreso *				que se van a borrar tiene registros de movimiento hospitalario, si los tiene, no se borra. Esto porque se presentó *				la inactivacoón en unix de una historía cuyo paciente estaba ya hospitalizado, lo que hizo que el sistema tomara *				como mayor el ingreso actual y borrara sus registros, volviendolos a ingresar cuando reactivaron la historia en unix *				pero en el reingreso se perdieron los datos de movimiento hospitalario - Mario Cadavid ************************************************************************************************* * 2013-02-08 - Se adicionó la función obtenerRegistrosFila que permite almacenar todos los datos de una fila *				de la base de datos en una cadena tipo string. Esta función sirve para guardar en la tabla * 				log_agenda los datos de una fila de la base de datos antes de ésta ser actualizada o borrada - Mario Cadavid ************************************************************************************************* * 2012-07-18 - Se adicionó la grabación del centro de costo de ingreso (Mtrcci) en la tabla hce_000022 ************************************************************************************************* * 2012-06-14 - Se quitaron espacios en codigo html que pudieran afectar la respuesta ajax ya que las funciones javascript *				validan si la respuesta es igual a "ok" para definir si muestra un mensaje de advertencia o no y estaba  *				llegando ok pero con un salto de linea ************************************************************************************************* * 2012-04-11 - Se unieron los dos scripts (agenda_ambulatorias.php y auxAgendaAmbulatorias.php) en uno solo *				Se modifico la consulta principal en la función consultarPacienteUnix para que no se frenara *				el script si existe algun registro Nulo, sto por el cambio al nuevo servidor ************************************************************************************************* * 2012-03-16 - Se adicionó una condición más antes de borrar un ingreso, de modo que primero se consulte *				inpaci y si el ingreso a borrar es mayor que el ingreso actual en inpaci se borra (if($ingreso>$ing_act)) *				sino se da alta normal ************************************************************************************************* * 2012-01-24 - En las funciones "actualizarAltaPacientesUnix" y "actualizarPacientesUnix" se modificó *				el query de consulta de pacientes activos en Unix de modo que solo consulte inpac *				y no las demás tablas (insercco,inemp) ya que no se necesitan datos de estas  *				y al consultarlas se estabn trayendo algunas historias duplicadas ************************************************************************************************* * 2012-01-19 - En la función "altaPacienteUrgencias" se agregó la validación de la fecha de egreso *				en Unix. Si fecha de egreso en unix es igual a la fecha actual no se da de alta ************************************************************************************************* * 2011-11-29 - Se modificó la función ingresarPacientesUrgencias para que tenga en cuenta cuando  *				la historia y/o cédula en matrix no corresponde con las de Unix. Para esto también *				se creo la función borrarHistoriaDiferenteUnix  ************************************************************************************************* * 2011-11-28 - Se agregó la condición si mysql_affected_rows() antes de grabar en log_agenda *				para garantizar que si se ejecuto la acción que se graba en la tabla de log_agenda ************************************************************************************************* * 2011-11-27 - Se agregó grabación en la tabla de log_agenda para todas las acciones que se *				ejecuten en el sistema, no solo para las de borrado como estaba *				En la función borraIngresosMayores se cambió Ubiing >= ".$ingreso." por *				Ubiing*1 >= ".$ingreso." para que hiciera la comparación correctamente ************************************************************************************************* * 2011-11-25 - Cuando se llama la función borraIngresosMayores, se estaba llevando el ingreso de Matrix *				se cambió para que lleve el ingreso de unix ************************************************************************************************* * 2011-11-11 - Se agregó la columna de Afinidad del paciente tanto en la lista de pacientes activos  *				como en la lista de pacientes inactivos ************************************************************************************************* * 2011-10-31 - Se modificaron las funciones insertarIngresoPaciente y actualizarIngresoPaciente de modo que *				cuando la adición o edición en la tabla root_000037 saque error por clave duplicada,  *				borre los registros duplicados e inserte o actualice los datos del paciente que se traen desde Unix *				Se creo la función esCirugia para verificar si el centro de costo del paciente es cirugia *				de modo que En proceso de traslado quede en 'on', es decir, poner Ubiptr de la tabla movhos_000018 en 'on' ************************************************************************************************* * 2011-10-26 - Se adicionó la función borraIngresosMayores y se modificó la función ingresarPacientesUrgencias *				esto para preveer la situación en la que una historia o ingreso es reasignado en Unix *				de modo que en matrix se borren los ingresos mayores a los de Unix e igual se actualicen *				los datos en las tablas root_000036 y root_000037 en caso de un cambio de cédula para la historia ************************************************************************************************* * 2011-09-21 - Se verifica y hacen pruebas en el cambio para hacer el script multi centro de costos *				ya que se estaba perdiendo la variable cco (lleva código cco matrix) y la variable *				wservicio (lleva código cco unix) ************************************************************************************************* * 2011-08-25 - Cuando se escanea para ingreso de pacientes desde Unix se adicionó la función  *				actualizarDatosPacienteTablaUnica para que actualice los datos de la tabla root_000036 *				con los que se traen de Unix ************************************************************************************************* * 2011-08-17 - Se cambiaron las consultas que tenian Medurg y Ccourg igual a on, para no quemar *				el cco urgencias sino que se consulta segùn el cco que se recibe por parámetro *				En la consulta de médicos se incluyeron las condiciones para meduma diferente de '' y 'NO APLICA' ************************************************************************************************* * 2011-08-11 - Se agrego al LOG que guarde tambien el borrado de la tabla  movhos_000016 *				Se modificó las consultas que agregan pacientes nuevos a la agenda para que traiga de  *				Unix no solo los pacientes a partir de ayer sino todos los que esten en Unix  *				asignados a urgencias, ver campos comentados asi: 	//  AND pacfec >= '".$ayer."'"; ************************************************************************************************* * 2011-07-06 - Se creo una tabla para LOG (log_agenda) para guardar las acciones de borrado de la tabla movhos_000018 ************************************************************************************************* * 2011-06-08 - Se cambio la asignación por médico a asignación por especialidad ************************************************************************************************* * 2011-05-13 - Se cambio el query para consultar médico asignado en la función agendaUrgencias *				ya que estaba tomando pacientes con médico en blanco "", y mostraba médico  *				con código en blanco "" *				Se cambió la función actualizarAltaPacientesUnix ya que no se estaba recorriendo  *				el arreglo de forma correcta, se cambió la función while ($j < count ($altas_unix)) *				por foreach ($altas_unix as $j => $value) ************************************************************************************************* * 2011-04-28 - Cuando es alta automática, se cambio la función <altaPacienteUrgencias>  *				para que verifique si en Unix sigue activa la historia, si es asi no le da alta *				Se activaron los checbox de actas y muertes para conductas de alta *				Se inactiva checbox de muerte si conducta es alta y viceversa ************************************************************************************************* * 2011-04-25 - Modificación en el ingreso de pacientes a urgencias, se quito el campo  *				de texto donde se ingresaba la historia clínica, ya se toma de Unix los  *				pacientes en urgencias actualizándose la lista automáticamente. ************************************************************************************************* * 2011-03-04 - Modificación en el proceso de ingreso del paciente a urgencias para validar los siguientes casos: * 				Si un usuario ya está en movhos 18 pero aun no esta en hce 22, registrarlo en hce 22 * 				antes se asumia como ya ingresado y no se registraba en hce 22 *				Validar ingreso de paciente no solo por historia sino tambien por número de ingreso, por ejemplo: *				si un usuario está registrado con ingreso 1 y vuelven y lo entran y tiene ya en UNIX ingreso 2 *				se debe dar de alta automaticamente el ingreso 1 y adicionarlo a la agenda de urgencias con ingreso 2 *				Validación al activar un paciente dado de alta, si ya está activo con otro ingreso no lo deja activar *				En reasignar si el paciente tiene mas de un ingreso no deja reasiganar su número de historia ************************************************************************************************* * 2011-02-23 - Adición de try catch al ejecutar blockUI debido a que en algunas versiones viejas de IE * 				sacaba un error y no dejaba ejecutar la página. También se adicionó el evento onload al final del javascript ************************************************************************************************* * 2011-02-22 - Adición de columnas Activar y Reasignar historia para pacientes dados de alta */   /*************************************************************************************** * LOS SIGUIENTES CAMBIOS CORRESPONDEN CUANDO EL PROGRAMA ESTABA DIVIDIDO EN 2 SCRIPTS	* ****************************************************************************************//* **************************** AUXILIAR DE AGENDA URGENCIAS ************************************ ****************************** DESCRIPCIÓN *************************************************** * Contiene las funciones principales que usa el script agenda_ambulatorias.php  * Estas funciones se llaman desde AJAX ************************************************************************************************* * Autor: John M. Cadavid. G. * Fecha creacion: 2011-02-16 ************************************************************************************************* * MODIFICACIONES ************************************************************************************************* * 2012-01-24 - En las funciones "actualizarAltaPacientesUnix" y "actualizarPacientesUnix" se modificó *				el query de consulta de pacientes activos en Unix de modo que solo consulte inpac *				y no las demás tablas (insercco,inemp) ya que no se necesitan datos de estas  *				y al consultarlas se estabn trayendo algunas historias duplicadas ************************************************************************************************* * 2012-01-19 - En la función "altaPacienteUrgencias" se agregó la validación de la fecha de egreso *				en Unix. Si fecha de egreso en unix es igual a la fecha actual no se da de alta ************************************************************************************************* * 2011-11-29 - Se modificó la función ingresarPacientesUrgencias para que tenga en cuenta cuando  *				la historia y/o cédula en matrix no corresponde con las de Unix. Para esto también *				se creo la función borrarHistoriaDiferenteUnix  ************************************************************************************************* * 2011-11-28 - Se agregó la condición si mysql_affected_rows() antes de grabar en log_agenda *				para garantizar que si se ejecuto la acción que se graba en la tabla de log_agenda ************************************************************************************************* * 2011-11-27 - Se agregó grabación en la tabla de log_agenda para todas las acciones que se *				ejecuten en el sistema, no solo para las de borrado como estaba *				En la función borraIngresosMayores se cambió Ubiing >= ".$ingreso." por *				Ubiing*1 >= ".$ingreso." para que hiciera la comparación correctamente  ************************************************************************************************* * 2011-11-25 - Cuando se llama la función borraIngresosMayores, se estaba llevando el ingreso de Matrix *				se cambió para que lleve el ingreso de unix ************************************************************************************************* * 2011-11-11 - Se agregó la columna de Afinidad del paciente tanto en la lista de pacientes activos  *				como en la lista de pacientes inactivos ************************************************************************************************* * 2011-10-31 - Se modificaron las funciones insertarIngresoPaciente y actualizarIngresoPaciente de modo que *				cuando la adición o edición en la tabla root_000037 saque error por clave duplicada,  *				borre los registros duplicados e inserte o actualice los datos del paciente que se traen desde Unix *				Se creo la función esCirugia para verificar si el centro de costo del paciente es cirugia *				de modo que En proceso de traslado quede en 'on', es decir, poner Ubiptr de la tabla movhos_000018 en 'on' ************************************************************************************************* * 2011-10-26 - Se adicionó la función borraIngresosMayores y se modificó la función ingresarPacientesUrgencias *				esto para preveer la situación en la que una historia o ingreso es reasignado en Unix *				de modo que en matrix se borren los ingresos mayores a los de Unix e igual se actualicen *				los datos en las tablas root_000036 y root_000037 en caso de un cambio de cédula para la historia ************************************************************************************************* * 2011-09-21 - Se verifica y hacen pruebas en el cambio para hacer el script multi centro de costos *				ya que se estaba perdiendo la variable cco (lleva código cco matrix) y la variable *				wservicio (lleva código cco unix) ************************************************************************************************* * 2011-08-25 - Cuando se escanea para ingreso de pacientes desde Unix se adicionó la función  *				actualizarDatosPacienteTablaUnica para que actualice los datos de la tabla root_000036 *				con los que se traen de Unix ************************************************************************************************* * 2011-08-17 - Se hace el script multi centros de costos. Se cambiaron las consultas que tenian  *				Medurg y Ccourg igual a on, para no quemar el cco urgencias sino que se consulta   *				segùn el cco que se recibe por parámetro ************************************************************************************************* * 2011-08-11 - Se agrego al LOG que guarde tambien el borrado de la tabla  movhos_000016 *				Se modificó las consultas que agregan pacientes nuevos a la agenda para que traiga de  *				Unix no solo los pacientes a partir de ayer sino todos los que esten en Unix  *				asignados a urgencias, ver campos comentados asi: 	//  AND pacfec >= '".$ayer."'"; ************************************************************************************************* * 2011-07-06 - Se creo una tabla para LOG (log_agenda) para guardar las acciones de borrado de la tabla movhos_000018 ************************************************************************************************* * 2011-05-13 - Se cambio el query para consultar médico asignado en la función agendaUrgencias *				ya que estaba tomando pacientes con médico en blanco "", y mostraba médico  *				con código en blanco "" *				Se cambió la función actualizarAltaPacientesUnix ya que no se estaba recorriendo  *				el arreglo de forma correcta, se cambió la función while ($j < count ($altas_unix)) *				por foreach ($altas_unix as $j => $value) ************************************************************************************************* * 2011-04-28 - Cuando es alta automática, se cambio la función <altaPacienteUrgencias>  *				para que verifique si en Unix sigue activa la historia, si es asi no le da alta *				Se activaron los checbox de actas y muertes para conductas de alta *				Se inactiva checbox de muerte si conducta es alta y viceversa ************************************************************************************************* * 2011-04-25 - Modificación en el ingreso de pacientes a urgencias, se quito el campo  *				de texto donde se ingresaba la historia clínica, ya se toma de Unix los  *				pacientes en urgencias actualizándose la lista automáticamente. ************************************************************************************************* * 2011-03-04 - Modificación en el proceso de ingreso del paciente a urgencias para validar los siguientes casos: * 				Si un usuario ya está en movhos 18 pero aun no esta en hce 22, registrarlo en hce 22 * 				antes se asumia como ya ingresado y no se registraba en hce 22 *				Validar ingreso de paciente no solo por historia sino tambien por número de ingreso, por ejemplo: *				si un usuario está registrado con ingreso 1 y vuelven y lo entran y tiene ya en UNIX ingreso 2 *				se debe dar de alta automaticamente el ingreso 1 y adicionarlo a la agenda de urgencias con ingreso 2 *				Validación al activar un paciente dado de alta, si ya está activo con otro ingreso no lo deja activar *				En reasignar si el paciente tiene mas de un ingreso no deja reasiganar su número de historia ************************************************************************************************* * 2011-02-23 - Adición de try catch al ejecutar blockUI debido a que en algunas versiones viejas de IE * 				sacaba un error y no dejaba ejecutar la página. También se adicionó el evento onload al final del javascript ************************************************************************************************* * 2011-02-22 - Adición de columnas Activar y Reasignar historia para pacientes dados de alta * 			 */  // Retorna el código y nombre del centro de costos de urgencias function consultarCco($cco_unix) {	global $wbasedato;	global $conex;	global $wservicio;	$q = "SELECT			Ccocod, Cconom  		FROM 			".$wbasedato."_000011 		WHERE			Ccoseu = '".$cco_unix."'; ";	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	$filas = mysql_num_rows($res);	$cco = new centroCostosDTO();	if($filas > 0)	{		$fila = mysql_fetch_row($res);		$cco->codigo = $fila[0];  		$cco->nombre = $fila[1];	}	return $cco; }/************************************************************************************************************************** INICIO APLICACIÓN ****************************************************************************************************************************************/include_once("root/comun.php");include_once("movhos/movhos.inc.php");$wbasedato = "";$wactualiz = " 2018-05-30";// Validación de usuarioif (!isset($user)){	if (!isset($_SESSION['user'])) 	{		session_register("user");	}	$user="";}//Codigo de usuario que ingreso al sistemaif (strpos($user, "-") > 0)	$wuser = substr($user, (strpos($user, "-") + 1), strlen($user));else	$wuser="";$usuario = new Usuario();$usuario->codigo = $wuser;//Variable para determinar la empresaif(!isset($wemp_pmla)){	terminarEjecucion($MSJ_ERROR_FALTA_PARAMETRO."wemp_pmla");}if(!isset($wservicio)){	terminarEjecucion($MSJ_ERROR_FALTA_PARAMETRO."wservicio");}//Valida codigo de usuario en sesion si no esta registrado el sistema termina la ejecucionif (!isset($_SESSION['user'])){	terminarEjecucion("<div align='center'>Usuario no autenticado.  Por favor cierre esta ventana y vuelva a ingresar a Matrix.</div>");} else {	//Conexion base de datos Matrix	$conex = obtenerConexionBD("matrix");	$institucion     = consultarInstitucionPorCodigo($conex, $wemp_pmla);	$winstitucion    = $institucion->nombre;	$wprounificado   = consultarAliasPorAplicacion($conex, $wemp_pmla, "ServicioAmbulatorioUnificado");	$wformularios    = consultarAliasPorAplicacion($conex, $wemp_pmla, "FormulariosFirmaHCE");	$wbasedatohce    = consultarAliasPorAplicacion($conex, $wemp_pmla, "hce");	$wbasedatocliame = consultarAliasPorAplicacion($conex, $wemp_pmla, "cliame");	$wbasedato       = consultarAliasPorAplicacion($conex, $wemp_pmla, "movhos");	$urladmision     = consultarAliasPorAplicacion($conex, $wemp_pmla, "urladmision");	$urlegreso       = consultarAliasPorAplicacion($conex, $wemp_pmla, "urlegreso");	$urlfacturar     = consultarAliasPorAplicacion($conex, $wemp_pmla, "urlfacturar");	$urlimprimir     = consultarAliasPorAplicacion($conex, $wemp_pmla, "urlimprimir");	//Consulto el codigo y nombre del centro de costo de urgencias	$cco = consultarCco($wservicio);			//Formulario (forma)	echo "<form name='forma' action='' method='post'>";	echo "<input type='hidden' name='wemp_pmla' id='wemp_pmla' value='".$wemp_pmla."'>";	echo "<input type='hidden' name='wserviciourl' id='wserviciourl' value='".$wservicio."'>";	echo "<input type='hidden' name='wservicio' id='wservicio' value='".$wservicio."'>";	echo "<input type='hidden' name='wbasedato' value='".$wbasedato."'>";		echo "<input type='hidden' name='wbasedatohce' value='".$wbasedatohce."'>";		echo "<input type='hidden' name='wbasedatocliame' value='".$wbasedatocliame."'>";		echo "<input type='hidden' name='cco' value='".$cco->codigo."'>";		echo "<input type='hidden' name='wseguridad' id='wseguridad' value='".$wuser."'>";	// echo "<input type='hidden' name='conex' id='conex' value='".$conex."'>";	echo "<input type='hidden' name='wespecialidad' id='wespecialidad' value='".$wesp."'>";	echo "<input type='hidden' name='wurladmision'  id='wurladmision'  value='".$urladmision."'>";	echo "<input type='hidden' name='wurlegreso'    id='wurlegreso'    value='".$urlegreso."'>";	echo "<input type='hidden' name='wurlfacturar'  id='wurlfacturar'  value='".$urlfacturar."'>";	echo "<input type='hidden' name='wurlimprimir'  id='wurlimprimir'  value='".$urlimprimir."'>";	echo "<input type='hidden' name='waccion'>";	$wcit = isset($wcit) ? $wcit : "";	echo "<input type='hidden' name='wcit' id='wcit' value='".$wcit."'>"; //2016-03-02 Verónica Arismendy	//Mensaje de espera	echo "<div id='msjEspere' name='msjEspere' style='display:none;'>";	echo "<br /><img src='../../images/medical/ajax-loader5.gif'/><br /><br /> Por favor espere un momento ... <br /><br />";	echo "</div>";		// Definición del encabezado del aplicativo	encabezado("ASIGNACION DE MEDICO", $wactualiz, "clinica");		//Botones "Actualizar" y "Cerrar ventana"	echo "<br /><p align='center'><input type='button' class='button' value='Actualizar' onclick='agendaUrgencias();'> &nbsp; | &nbsp;";	if (isset($wservicio) && (strpos($wprounificado,$wservicio) !== false) )	   echo "<input type='button' class='button' value='Nueva Admisión' onclick='abrirVentanaAdmision();'> &nbsp; | &nbsp;";		echo "<input type='button' class='button' value='Cerrar ventana' onclick='cerrarVentana();'></p>";          	// Aca la función anterior pinta la lista de pacientes en Urgencias con sus opciones	echo "<div name='agendUrg' id='agendUrg'>";	echo "</div>";			// Establece que la página se refresca automáticamente cada 40 segundos	echo "<script> timer = setInterval('agendaUrgencias()', 300000); </script>";	echo "</form>";	//Botones "Actualizar" y "Cerrar ventana"	echo "<br /><p align='center'><input type='button' class='button' value='Actualizar' onclick='agendaUrgencias();'> &nbsp; | &nbsp;";	if (isset($wservicio) && ($wservicio==$wprounificado))	    echo "<input type='button' class='button' value='Nueva Admisión' onclick='abrirVentanaAdmision();'> &nbsp; | &nbsp;";	echo "<input type='button' class='button' value='Cerrar ventana' onclick='cerrarVentana();'></p>";  			echo "</div><br />"; //Cierre div id=page}}if(isset($consultaAjax)){header("Content-Type: text/html;charset=ISO-8859-1"); include_once("root/comun.php");include_once("root/magenta.php");include_once("movhos/movhos.inc.php");$conex         = obtenerConexionBD("matrix");$wprounificado = consultarAliasPorAplicacion($conex, $wemp_pmla, "ServicioAmbulatorioUnificado");$wformularios  = consultarAliasPorAplicacion($conex, $wemp_pmla, "FormulariosFirmaHCE");conexionOdbc($conex, $basedatos, $conexUnix, 'facturacion');class medicosUrgencias {	var $codigo;	var $nombre;} // Retorna un arreglo con los médicos actualmente asiganados a urgenciasfunction consultarMedicos($wbasedato,$servicio){	global $conex; 		$q1=  "	SELECT Meduma, Medno1, Medno2, Medap1, Medap2, Meddoc "		 ."  FROM ".$wbasedato."_000048 "		 ."  WHERE INSTR(Medseu,'".$servicio."') > 0 " 		 ." 	AND Medest = 'on' "		 ." 	AND Meduma != '' "		 ." 	AND Meduma != ' ' "		 ." 	AND Meduma != 'NO APLICA' "		 ." ORDER by Medno1, Medno2, Medap1, Medap2 ";	//or MedSeu='*'	$res1 = mysql_query($q1,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q1 . " - " . mysql_error());  	$num1 = mysql_num_rows($res1);  	$coleccion = array();  	  	if ($num1 > 0 )  	{  		for ($i=1;$i<=$num1;$i++)  		{  			$med = new medicosUrgencias();  			$row1 = mysql_fetch_array($res1);  			$med->codigo = $row1[0];  			$med->nombre = $row1[1]." ".$row1[2]." ".$row1[3]." ".$row1[4];  			$med->cedula = $row1[5];  			  			$coleccion[] = $med;  		}  	}  	return $coleccion;}/*********************************************************************************************VERIFICA SI LA HISTORIA DEL PACIENTE SE ENCUENTRA REGISTRADA EN URGENCIAS DE DB UNIX		*********************************************************************************************/function consultarPacienteUnix($pacienteConsulta,$servicio){	global $conexUnix;	$paciente = new pacienteDTO();		$q = " SELECT pacnom, pacap1, pacap2, pacnum, pacfec, pachor, pachab, paccer, pacres, pactid, pacced, pacnac, pacsex, pachos, serccocco, pactel, pacdir, pacmun		     FROM inpac, insercco		    WHERE pachis = '".$pacienteConsulta->historiaClinica."' 			  AND serccoser = pacser			  AND pacap2 is not null			  AND pachab is not null						UNION						SELECT pacnom, pacap1, ' ' AS pacap2, pacnum, pacfec, pachor, pachab, paccer, pacres, pactid, pacced, pacnac, pacsex, pachos, serccocco, pactel, pacdir, pacmun		     FROM inpac, insercco		    WHERE pachis = '".$pacienteConsulta->historiaClinica."' 			  AND serccoser = pacser			  AND pacap2 is null			  AND pachab is not null			  			UNION		   SELECT pacnom, pacap1, pacap2, pacnum, pacfec, pachor, ' ', paccer, pacres, pactid, pacced, pacnac, pacsex, pachos, serccocco, pactel, pacdir, pacmun		     FROM inpac, insercco		    WHERE pachis = '".$pacienteConsulta->historiaClinica."' 			  AND serccoser = pacser			  AND pacap2 is not null			  AND pachab is null						UNION						SELECT pacnom, pacap1, ' ' AS pacap2, pacnum, pacfec, pachor, ' ', paccer, pacres, pactid, pacced, pacnac, pacsex, pachos, serccocco, pactel, pacdir, pacmun		     FROM inpac, insercco		    WHERE pachis = '".$pacienteConsulta->historiaClinica."' 			  AND serccoser = pacser			  AND pacap2 is null			  AND pachab is null			  ";	$rs = odbc_do($conexUnix,$q) or die (odbc_errormsg());	//$campos = odbc_num_fields($rs);	if ($arr_paciente = odbc_fetch_array($rs))	{		$municipio = "";		$tipo_responsable = "";		//Busco el nombre del municipio		$muncod = trim($arr_paciente['pacmun']);		$qmun = "  SELECT munnom					 FROM inmun					WHERE muncod = '".trim($muncod)."'				  ";		$rsmun = odbc_do($conexUnix,$qmun) or die (odbc_errormsg());		$arr_municipio = odbc_fetch_array($rsmun);		$municipio = $arr_municipio['munnom'];		// $numreg = odbc_num_rows($rsmun);		// if($numemp>0)			// $municipio = trim(odbc_result($rsmun,1));		// else			// $municipio = "";		// Busco el tipo de responsable		$codResponsable = trim($arr_paciente['paccer']);		$qemp = "  SELECT emptip					 FROM inemp					WHERE empcod = '".$codResponsable."'					  AND emptip is not null				  ";		$rsemp = odbc_do($conexUnix,$qemp) or die (odbc_errormsg());		$arr_responsable = odbc_fetch_array($rsemp);		$tipo_responsable = $arr_responsable['emptip'];		// $numreg = odbc_num_rows($rsemp);		// if($numreg>0)			// $tipo_responsable = trim(odbc_result($rsemp,1));		// else			// $tipo_responsable = "";		$nombre = explode(" ",trim($arr_paciente['pacnom']));		$paciente->nombre1 = $nombre[0];		if(isset($nombre[1]) && !isset($nombre[2]))		{			$paciente->nombre2 = $nombre[1];		}		elseif(isset($nombre[1]) && isset($nombre[2]))		{			$paciente->nombre2 = $nombre[1]." ".$nombre[2];		}		elseif(!isset($nombre[1]) && isset($nombre[2]))		{			$paciente->nombre2 = $nombre[2];		}		else		{			$paciente->nombre2 = "";		}		$paciente->apellido1 = trim($arr_paciente['pacap1']);		$paciente->apellido2 = trim($arr_paciente['pacap2']);		$paciente->historiaClinica = trim($pacienteConsulta->historiaClinica);		$paciente->ingresoHistoriaClinica = trim($arr_paciente['pacnum']);		$paciente->fechaIngreso = str_replace("/","-",trim($arr_paciente['pacfec']));		$paciente->horaIngreso = str_replace(".",":",trim($arr_paciente['pachor'])).":00";		$paciente->habitacionActual = "";		$paciente->numeroIdentificacionResponsable = $codResponsable;		$paciente->nombreResponsable = trim($arr_paciente['pacres']);		$paciente->tipoDocumentoIdentidad = trim($arr_paciente['pactid']);		$paciente->documentoIdentidad = trim($arr_paciente['pacced']);		$paciente->fechaNacimiento = trim($arr_paciente['pacnac']);		$paciente->genero = trim($arr_paciente['pacsex']);		$paciente->deHospitalizacion = trim($arr_paciente['pachos']);		$paciente->servicioActual = trim($arr_paciente['serccocco']);		$paciente->tipoResponsable = $tipo_responsable;		$paciente->telefono = trim($arr_paciente['pactel']);		$paciente->direccion = trim($arr_paciente['pacdir']);		$paciente->municipio = $municipio;		if(!isset($paciente->tipoResponsable))		{			$paciente->tipoResponsable = "02";		}		else		{			if($paciente->tipoResponsable == '' || empty($paciente->tipoResponsable))			{				$paciente->tipoResponsable = "02";			}		}	}	return $paciente;}// 2013-02-08// Consulta los datos de una fila según el query $qlog y convierte esta fila en un String// separando cada campo por el caracter |function obtenerRegistrosFila($qlog){	global $conex;	$reslog = mysql_query($qlog, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qlog . " - " . mysql_error());	$rowlog = mysql_fetch_row($reslog);	$datosFila = implode("|", $rowlog);	return $datosFila;}/********************************************************************************************* FUNCIONES UTILIZADAS EN EL REGISTRO DEL PACIENTE QUE ENTRA A URGENCIAS					*********************************************************************************************///Existe un registro del paciente en la tabla 36 de rootfunction existeEnTablaUnicaPacientes($paciente){	global $conex; 		$esta = false;		$q = "SELECT 				* 		  	FROM			  		root_000036 			WHERE					Pacced = '".$paciente->documentoIdentidad."' 				AND Pactid = '".$paciente->tipoDocumentoIdentidad."'";			$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . "-en el query: " . $q . "-" . mysql_error());	$filas = mysql_num_rows($res);		if($filas > 0){		$esta = true;		}	return $esta;}//Ingresa los datos en la tabla 36 de rootfunction insertarPacienteTablaUnica($paciente,$seguridad){	global $conex; 	$fechaLog = date('Y-m-d');	$horaLog = date('H:i:s');	$q = "INSERT INTO 			root_000036 				(medico,fecha_data,hora_data,Pacced,Pacno1,Pacno2,Pacap1,Pacap2,Pacnac,Pacsex,Pactid,Seguridad)			VALUES 				('root','$paciente->fechaIngreso','$paciente->horaIngreso', '$paciente->documentoIdentidad', '$paciente->nombre1', '".$paciente->nombre2."', '".$paciente->apellido1."', '".$paciente->apellido2."', '".$paciente->fechaNacimiento."', '".$paciente->genero."', '$paciente->tipoDocumentoIdentidad', 'C-".$seguridad."' )";		$err=mysql_query($q,$conex);	$num_affect = mysql_affected_rows();	if($num_affect>0)	{		//Guardo LOG de grabación en tabla root_000036		$q = "	INSERT INTO log_agenda 								  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 						   VALUES								  ('".$fechaLog."', '".$horaLog."', '".$paciente->documentoIdentidad."', '".$paciente->tipoDocumentoIdentidad."', 'Grabacion tabla root_000036', '".$seguridad."', 'Auto')";		$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	}}//Actualiza documento del paciente en la tabla 36 de rootfunction actualizarDocumentoPacienteTablaUnica($pacienteAnterior, $pacienteNuevo){	global $conex; 		$fechaLog = date('Y-m-d');	$horaLog = date('H:i:s');	$q = "UPDATE 			root_000036 		SET 			Pacced = '".$pacienteNuevo->documentoIdentidad."',			Pactid = '".$pacienteNuevo->tipoDocumentoIdentidad."'		WHERE 			Pacced = '".$pacienteAnterior->documentoIdentidad."' 			AND Pactid = '".$pacienteAnterior->tipoDocumentoIdentidad."' ";	$err1=mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		$num_affect = mysql_affected_rows();	if($num_affect>0)	{		//Guardo LOG de actualización en tabla root_000036		$q = "	INSERT INTO log_agenda 								  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 						   VALUES								  ('".$fechaLog."', '".$horaLog."', '".$pacienteAnterior->documentoIdentidad."', '".$pacienteAnterior->tipoDocumentoIdentidad."', 'Actualizacion tabla root_000036', 'root', 'Nuevo documento ".$pacienteNuevo->tipoDocumentoIdentidad." ".$pacienteNuevo->documentoIdentidad."')";		$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	}}//Actualiza datos del paciente en la tabla 36 de rootfunction actualizarDatosPacienteTablaUnica($pacienteAnterior, $pacienteNuevo){	global $conex; 		$fechaLog = date('Y-m-d');	$horaLog = date('H:i:s');	$q = "UPDATE 			root_000036 		SET 			Pacno1 = '".$pacienteNuevo->nombre1."',			Pacno2 = '".$pacienteNuevo->nombre2."',			Pacap1 = '".$pacienteNuevo->apellido1."',			Pacap2 = '".$pacienteNuevo->apellido2."',			Pacnac = '".$pacienteNuevo->fechaNacimiento."',			Pacsex = '".$pacienteNuevo->genero."'		WHERE 			Pacced = '".$pacienteNuevo->documentoIdentidad."'			AND Pactid = '".$pacienteNuevo->tipoDocumentoIdentidad."'";	$err1=mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	$num_affect = mysql_affected_rows();	if($num_affect>0)	{		//Guardo LOG de actualización en tabla root_000036		$q = "	INSERT INTO log_agenda 								  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 						   VALUES								  ('".$fechaLog."', '".$horaLog."', '".$pacienteNuevo->documentoIdentidad."', '".$pacienteNuevo->tipoDocumentoIdentidad."', 'Actualizacion tabla root_000036', 'root', 'Nuevos datos ".$pacienteNuevo->nombre1." ".$pacienteNuevo->nombre2." ".$pacienteNuevo->apellido1." ".$pacienteNuevo->apellido2." | ".$pacienteNuevo->fechaNacimiento." | ".$pacienteNuevo->genero." ')";		$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	}}//Existe un registro del paciente en la tabla 37 de rootfunction existeEnTablaIngresos($paciente,$origen){	global $conex; 		$esta = false;		$q = "SELECT 				* 		  	FROM			  		root_000037 			WHERE					Orihis = '".$paciente->historiaClinica."'								AND Oriori = '".$origen."'";			$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . "-" . mysql_error());	$filas = mysql_num_rows($res);		if($filas > 0)	{		$esta = true;		}	return $esta;}// En tabla root_000037 borra la historia asociada en matrix a la cédula de unix// siempre y cuando esta historia sea diferente a la asociada en Unixfunction borrarHistoriaDiferenteUnix($paciente, $wemp_pmla, $seguridad){		global $conex; 		$fechaLog = date('Y-m-d');	$horaLog = date('H:i:s');	$q = "SELECT * 		  	FROM root_000037 		   WHERE Oriced = '".$paciente->documentoIdentidad."'						     AND Oritid = '".$paciente->tipoDocumentoIdentidad."'			 AND Orihis != '".$paciente->historiaClinica."'			 AND Oriori = '".$wemp_pmla."'";	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . "-" . mysql_error());	$filas = mysql_num_rows($res);		if($filas > 0)	{		$q = " DELETE FROM root_000037 				WHERE Oriced = '".$paciente->documentoIdentidad."'				  AND Oritid = '".$paciente->tipoDocumentoIdentidad."'				  AND Orihis != '".$paciente->historiaClinica."'				  AND Oriori = '".$wemp_pmla."'";		$err1=mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . "-" . mysql_error());		$num_affect = mysql_affected_rows();		if($num_affect>0)		{			//Guardo LOG de borrado en tabla root_000037 por clave duplicada			$q = "	INSERT INTO log_agenda 									  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 							   VALUES									  ('".$fechaLog."', '".$horaLog."', '".$paciente->historiaClinica."', '".$paciente->ingresoHistoriaClinica."', 'Borrado tabla root_000037', '".$seguridad."', 'Historia diferente unix ".$paciente->tipoDocumentoIdentidad." ".$paciente->documentoIdentidad."')";			$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		}	}}//Ingresa los datos en la tabla 37 de rootfunction insertarIngresoPaciente($paciente, $wemp_pmla, $seguridad){		global $conex; 		$fechaLog = date('Y-m-d');	$horaLog = date('H:i:s');	$q = "INSERT INTO root_000037 			( medico,fecha_data,hora_data,Oriced,Orihis,Oriing,Oriori,Oritid,Seguridad)		VALUES 			('root','".$paciente->fechaIngreso."','".$paciente->horaIngreso."','".$paciente->documentoIdentidad."', '".$paciente->historiaClinica."', '".$paciente->ingresoHistoriaClinica."', '".$wemp_pmla."', '".$paciente->tipoDocumentoIdentidad."', 'C-".$seguridad."' )";	$err=mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	$num_affect = mysql_affected_rows();	if($num_affect>0)	{		//Guardo LOG de grabación en tabla root_000037		$q = "	INSERT INTO log_agenda 								  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 						   VALUES								  ('".$fechaLog."', '".$horaLog."', '".$paciente->historiaClinica."', '".$paciente->ingresoHistoriaClinica."', 'Grabacion tabla root_000037', '".$seguridad."', 'Auto ".$paciente->tipoDocumentoIdentidad." ".$paciente->documentoIdentidad."')";		$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	}		// Si ocurrió error por clave duplicada	$error_sql = mysql_errno();	if(isset($error_sql) && $error_sql=="1062")	{		$q = " DELETE FROM root_000037 				WHERE Oriced = '".$paciente->documentoIdentidad."'				  AND Oritid = '".$paciente->tipoDocumentoIdentidad."'				  AND Oriori = '".$wemp_pmla."';";		$err1=mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . "-" . mysql_error());		$num_affect = mysql_affected_rows();		if($num_affect>0)		{			//Guardo LOG de borrado en tabla root_000037 por clave duplicada			$q = "	INSERT INTO log_agenda 									  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 							   VALUES									  ('".$fechaLog."', '".$horaLog."', '".$paciente->historiaClinica."', '".$paciente->ingresoHistoriaClinica."', 'Borrado tabla root_000037', '".$seguridad."', 'Clave duplicada ".$paciente->tipoDocumentoIdentidad." ".$paciente->documentoIdentidad."')";			$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		}		$q = "INSERT INTO root_000037 				( medico,fecha_data,hora_data,Oriced,Orihis,Oriing,Oriori,Oritid,Seguridad)			VALUES 				('root','".$paciente->fechaIngreso."','".$paciente->horaIngreso."','".$paciente->documentoIdentidad."', '".$paciente->historiaClinica."', '".$paciente->ingresoHistoriaClinica."', '".$wemp_pmla."', '".$paciente->tipoDocumentoIdentidad."', 'C-".$seguridad."' )";		$err=mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . "-" . mysql_error());		$num_affect = mysql_affected_rows();		if($num_affect>0)		{			//Guardo LOG de grabación en tabla root_000037 por clave duplicada			$q = "	INSERT INTO log_agenda 									  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 							   VALUES									  ('".$fechaLog."', '".$horaLog."', '".$paciente->historiaClinica."', '".$paciente->ingresoHistoriaClinica."', 'Grabacion tabla root_000037', '".$seguridad."', 'Clave duplicada ".$paciente->tipoDocumentoIdentidad." ".$paciente->documentoIdentidad."')";			$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		}	}}//Actualiza los datos en la tabla 37 de rootfunction actualizarIngresoPaciente($pacienteAnterior, $pacienteNuevo, $origen){	global $conex; 		$fechaLog = date('Y-m-d');	$horaLog = date('H:i:s');	$q = "UPDATE 			root_000037 		SET 			Oriing = '".$pacienteNuevo->ingresoHistoriaClinica."',			Oriced = '".$pacienteNuevo->documentoIdentidad."',			Oritid = '".$pacienteNuevo->tipoDocumentoIdentidad."' 		WHERE 			Orihis = '".$pacienteNuevo->historiaClinica."'			AND Oriori = '".$origen."';";	$err1=mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		$num_affect = mysql_affected_rows();	if($num_affect>0)	{		//Guardo LOG de actualización en tabla root_000037		$q = "	INSERT INTO log_agenda 								  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 						   VALUES								  ('".$fechaLog."', '".$horaLog."', '".$pacienteNuevo->historiaClinica."', '".$pacienteNuevo->ingresoHistoriaClinica."', 'Actualizacion tabla root_000037', 'root', 'Actualiza ingreso ".$pacienteNuevo->ingresoHistoriaClinica." | ".$pacienteNuevo->tipoDocumentoIdentidad." ".$pacienteNuevo->documentoIdentidad."')";		$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	}		// Si ocurrió error por clave duplicada	$error_sql = mysql_errno();	if(isset($error_sql) && $error_sql=="1062")	{		$q = "DELETE FROM root_000037 					WHERE Oriced = '".$pacienteNuevo->documentoIdentidad."'					  AND Oritid = '".$pacienteNuevo->tipoDocumentoIdentidad."'					  AND Oriori = '".$origen."';";		$err1=mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . "-" . mysql_error());		$num_affect = mysql_affected_rows();		if($num_affect>0)		{			//Guardo LOG de borrado en tabla root_000037 por clave duplicada			$q = "	INSERT INTO log_agenda 									  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 							   VALUES									  ('".$fechaLog."', '".$horaLog."', '".$pacienteNuevo->historiaClinica."', '".$pacienteNuevo->ingresoHistoriaClinica."', 'Borrado tabla root_000037', 'root', 'Clave duplicada ".$pacienteNuevo->tipoDocumentoIdentidad." ".$pacienteNuevo->documentoIdentidad."')";			$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		}		$q = "UPDATE 				root_000037 			SET 				Oriing = '".$pacienteNuevo->ingresoHistoriaClinica."',				Oriced = '".$pacienteNuevo->documentoIdentidad."',				Oritid = '".$pacienteNuevo->tipoDocumentoIdentidad."' 			WHERE 				Orihis = '".$pacienteNuevo->historiaClinica."'				AND Oriori = '".$origen."';";		$err1=mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . "-" . mysql_error());				$num_affect = mysql_affected_rows();		if($num_affect>0)		{			//Guardo LOG de actualizacion en tabla root_000037 por clave duplicada			$q = "	INSERT INTO log_agenda 									  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 							   VALUES									  ('".$fechaLog."', '".$horaLog."', '".$pacienteNuevo->historiaClinica."', '".$pacienteNuevo->ingresoHistoriaClinica."', 'Actualizacion tabla root_000037', 'root', 'Clave duplicada ".$pacienteNuevo->ingresoHistoriaClinica." | ".$pacienteNuevo->tipoDocumentoIdentidad." ".$pacienteNuevo->documentoIdentidad."')";			$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		}	}}//Actualiza el documento del paciente en la tabla 37 de rootfunction actualizarDocumentoPacienteTablaIngresos($pacienteAnterior, $pacienteNuevo,$wemp_pmla){	global $conex; 		$fechaLog = date('Y-m-d');	$horaLog = date('H:i:s');	$q = "UPDATE 			root_000037 		SET 			Oriced = '".$pacienteNuevo->documentoIdentidad."',			Oritid = '".$pacienteNuevo->tipoDocumentoIdentidad."'		WHERE 			Orihis = '".$pacienteAnterior->historiaClinica."' 			AND Oriori = '".$wemp_pmla."' ";	//		AND Oriing = '".$pacienteAnterior->ingresoHistoriaClinica."' 	$err1=mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	$num_affect = mysql_affected_rows();	if($num_affect>0)	{		//Guardo LOG de actualización en tabla root_000037		$q = "	INSERT INTO log_agenda 								  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 						   VALUES								  ('".$fechaLog."', '".$horaLog."', '".$pacienteAnterior->historiaClinica."', '".$pacienteAnterior->ingresoHistoriaClinica."', 'Actualizacion tabla root_000037', 'root', 'Actualiza documento paciente ".$pacienteNuevo->tipoDocumentoIdentidad." ".$pacienteNuevo->documentoIdentidad."')";		$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	}			// Si ocurrió error por clave duplicada	$error_sql = mysql_errno();	if(isset($error_sql) && $error_sql=="1062")	{		$q = "DELETE FROM root_000037 					WHERE Oriced = '".$pacienteNuevo->documentoIdentidad."'					  AND Oritid = '".$pacienteNuevo->tipoDocumentoIdentidad."'					  AND Oriori = '".$wemp_pmla."';";		$err1=mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . "-" . mysql_error());		$num_affect = mysql_affected_rows();		if($num_affect>0)		{			//Guardo LOG de borrado en tabla root_000037 por clave duplicada			$q = "	INSERT INTO log_agenda 									  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 							   VALUES									  ('".$fechaLog."', '".$horaLog."', '".$pacienteAnterior->historiaClinica."', '".$pacienteAnterior->ingresoHistoriaClinica."', 'Borrado tabla root_000037', 'root', 'Clave duplicada ".$pacienteNuevo->tipoDocumentoIdentidad." ".$pacienteNuevo->documentoIdentidad."')";			$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		}		$q = "UPDATE 				root_000037 			SET 				Oriced = '".$pacienteNuevo->documentoIdentidad."',				Oritid = '".$pacienteNuevo->tipoDocumentoIdentidad."'			WHERE 				Orihis = '".$pacienteAnterior->historiaClinica."' 				AND Oriori = '".$wemp_pmla."' ";		//		AND Oriing = '".$pacienteAnterior->ingresoHistoriaClinica."' 		$err1=mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());				$num_affect = mysql_affected_rows();		if($num_affect>0)		{			//Guardo LOG de grabacion en tabla root_000037 por clave duplicada			$q = "	INSERT INTO log_agenda 									  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 							   VALUES									  ('".$fechaLog."', '".$horaLog."', '".$pacienteAnterior->historiaClinica."', '".$pacienteAnterior->ingresoHistoriaClinica."', 'Grabacion tabla root_000037', 'root', 'Clave duplicada ".$pacienteNuevo->tipoDocumentoIdentidad." ".$pacienteNuevo->documentoIdentidad."')";			$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		}	}}//Existe un registro del paciente en la tabla 16 de movhosfunction existeEnTablaResponsables($pacienteMatrix, $wemp_pmla){	global $conex; 		$esta = false;		$q = "SELECT 				* 		  	FROM			  		movhos_000016 			WHERE					Inghis = '".$pacienteMatrix->historiaClinica."' 				AND Inging = '".$pacienteMatrix->ingresoHistoriaClinica."';";			$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . "-en el query: " . $q . "-" . mysql_error());	$filas = mysql_num_rows($res);		if($filas > 0)	{		$esta = true;		}	return $esta;}//Ingresa los datos en la tabla 22 de hcefunction registrarIngresoPaciente($ingreso,$seguridad){	global $conex; 		$fecha = date("Y-m-d");	$hora = date("H:i:s");	$q = "	SELECT Mtrhis 			FROM hce_000022 			WHERE Mtrhis = '".$ingreso->historiaClinica."' 			AND Mtring = '".$ingreso->ingresoHistoriaClinica."'";		$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	$num = mysql_num_rows($res);	if($num==0) 	{		$q = "INSERT INTO 				hce_000022 					(Medico,Fecha_data,Hora_data,Mtrhis,Mtring,Mtrcci,Mtrmed,Mtrest,Mtrtra,Mtretr,Mtrcur,Seguridad)				VALUES 					('HCE','".$fecha."','".$hora."','".$ingreso->historiaClinica."','".$ingreso->ingresoHistoriaClinica."','".$ingreso->servicioActual."','','on','off','','off','C-".$seguridad."')";				$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		$num_affect = mysql_affected_rows();		if($num_affect>0)		{			//Guardo LOG de garabación en tabla hce_000022			$q = "	INSERT INTO log_agenda 									  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 							   VALUES									  ('".$fecha."', '".$hora."', '".$ingreso->historiaClinica."', '".$ingreso->ingresoHistoriaClinica."', 'Grabacion tabla hce_000022', '".$seguridad."', 'Auto')";			$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		}		// Si ocurrió error por clave duplicada		$error_sql = mysql_errno();		if(isset($error_sql) && $error_sql=="1062")		{			$q = "DELETE FROM hce_000022 						WHERE Mtrhis = '".$ingreso->historiaClinica."'						  AND Mtring = '".$ingreso->ingresoHistoriaClinica."';";			$err1=mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . "-" . mysql_error());			$num_affect = mysql_affected_rows();			if($num_affect>0)			{				//Guardo LOG de borrado en tabla root_000037 por clave duplicada				$q = "	INSERT INTO log_agenda 										  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 								   VALUES										  ('".$fecha."', '".$hora."', '".$ingreso->historiaClinica."', '".$ingreso->ingresoHistoriaClinica."', 'Borrado tabla hce_000022', '".$seguridad."', 'Clave duplicada ".$ingreso->historiaClinica."-".$ingreso->ingresoHistoriaClinica."')";				$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());			}			$q = "INSERT INTO 					hce_000022 						(Medico,Fecha_data,Hora_data,Mtrhis,Mtring,Mtrcci,Mtrmed,Mtrest,Mtrtra,Mtretr,Mtrcur,Seguridad)					VALUES 						('HCE','".$fecha."','".$hora."','".$ingreso->historiaClinica."','".$ingreso->ingresoHistoriaClinica."','".$ingreso->servicioActual."','','on','off','','off','C-".$seguridad."')";						$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());			$num_affect = mysql_affected_rows();			if($num_affect>0)			{				//Guardo LOG de garabación en tabla hce_000022				$q = "	INSERT INTO log_agenda 										  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 								   VALUES										  ('".$fecha."', '".$hora."', '".$ingreso->historiaClinica."', '".$ingreso->ingresoHistoriaClinica."', 'Grabacion tabla hce_000022', '".$seguridad."', 'Auto')";				$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());			}		}	} 	else 	{		$q = "	UPDATE hce_000022 				SET Fecha_data='".$fecha."', Hora_data='".$hora."', Mtrmed='', Mtrest='on', Mtrtra='off', Mtretr='', Mtrcur='off', Mtrcci='".$ingreso->servicioActual."', Seguridad='C-".$seguridad."'				WHERE Mtrhis = '".$ingreso->historiaClinica."'				AND	Mtring = '".$ingreso->ingresoHistoriaClinica."'";				$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		$num_affect = mysql_affected_rows();		if($num_affect>0)		{			//Guardo LOG de actualización en tabla hce_000022			$q = "	INSERT INTO log_agenda 									  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 							   VALUES									  ('".$fecha."', '".$hora."', '".$ingreso->historiaClinica."', '".$ingreso->ingresoHistoriaClinica."', 'Actualizacion tabla hce_000022', '".$seguridad."', 'Auto')";			$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		}	}}//Ingresa los datos en la tabla 16 de movhosfunction insertarResponsablePaciente($paciente, $wemp_pmla, $seguridad){		global $conex; 		$fecha = date("Y-m-d");	$hora = date("H:i:s");	$q = "INSERT INTO movhos_000016 			(medico,Fecha_data,Hora_data,Inghis,Inging,Ingres,Ingnre,Ingtip,Ingtel,Ingdir,Ingmun,Seguridad)		VALUES 			('movhos','".$paciente->fechaIngreso."','".$paciente->horaIngreso."','".$paciente->historiaClinica."', '".$paciente->ingresoHistoriaClinica."', '".$paciente->numeroIdentificacionResponsable."', '".$paciente->nombreResponsable."', '".$paciente->tipoResponsable."', '".$paciente->telefono."', '".$paciente->direccion."', '".$paciente->municipio."', 'C-".$seguridad."' )";	$err=mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	$num_affect = mysql_affected_rows();	if($num_affect>0)	{		//Guardo LOG de garabación en tabla movhos_000016		$q = "	INSERT INTO log_agenda 								  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 						   VALUES								  ('".$fecha."', '".$hora."', '".$paciente->historiaClinica."', '".$paciente->ingresoHistoriaClinica."', 'Grabacion tabla movhos_000016', '".$seguridad."', 'Auto')";		$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	}}//Actualiza los datos en la tabla 16 de movhosfunction actualizarResponsablePaciente($pacienteAnterior, $pacienteNuevo){	global $conex; 		$fecha = date("Y-m-d");	$hora = date("H:i:s");	$q = "UPDATE 			movhos_000016 		SET 			Ingres = '".$pacienteNuevo->numeroIdentificacionResponsable."', 			Ingnre = '".$pacienteNuevo->nombreResponsable."',			Ingtip = '".$pacienteNuevo->tipoResponsable."',			Ingtel = '".$pacienteNuevo->telefono."',			Ingdir = '".$pacienteNuevo->direccion."',			Ingmun = '".$pacienteNuevo->municipio."'		WHERE 			Inghis = '".$pacienteAnterior->historiaClinica."' 			AND Inging = '".$pacienteAnterior->ingresoHistoriaClinica."' ";	$err1=mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	$num_affect = mysql_affected_rows();	if($num_affect>0)	{		//Guardo LOG de actualización en tabla movhos_000016		$q = "	INSERT INTO log_agenda 								  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 						   VALUES								  ('".$fecha."', '".$hora."', '".$pacienteAnterior->historiaClinica."', '".$pacienteAnterior->ingresoHistoriaClinica."', 'Actualizacion tabla movhos_000016', 'root', 'Auto ".$pacienteNuevo->numeroIdentificacionResponsable." ".$pacienteNuevo->nombreResponsable."')";		$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	}}//Ingresa los datos en la tabla 18 de movhosfunction grabarIngresoPaciente($ingreso,$seguridad){	global $conex; 		$fecha = date("Y-m-d");	$hora = date("H:i:s");	$q = "INSERT INTO 			movhos_000018 (Medico,Fecha_data,Hora_data,Ubihis,Ubiing,Ubisac,Ubisan,Ubihac,Ubihan,Ubialp,Ubiald,Ubifap,Ubihap,Ubifad,Ubihad,Ubiptr,Seguridad)		VALUES 			('movhos','".$ingreso->fechaIngreso."','".$ingreso->horaIngreso."','".$ingreso->historiaClinica."', '".$ingreso->ingresoHistoriaClinica."', '".$ingreso->servicioActual."', '".$ingreso->servicioAnterior."', '".$ingreso->habitacionActual."',  '".$ingreso->habitacionAnterior."','".$ingreso->altaEnProceso."', '".$ingreso->altaDefinitiva."', '".$ingreso->fechaAltaProceso."','".$ingreso->horaAltaProceso."', '".$ingreso->fechaAltaDefinitiva."', '".$ingreso->horaAltaDefinitiva."', '".$ingreso->enProcesoTraslado."', 'C-".$seguridad."' )";	$err=mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	$num_affect = mysql_affected_rows();	if($num_affect>0)	{		//Guardo LOG de grabación en tabla movhos_000018		$q = "	INSERT INTO log_agenda 								  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 						   VALUES								  ('".$fecha."', '".$hora."', '".$ingreso->historiaClinica."', '".$ingreso->ingresoHistoriaClinica."', 'Grabacion tabla movhos_000018', '".$seguridad."', 'Auto')";		$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	}	// Si ocurrió error por clave duplicada	$error_sql = mysql_errno();	if(isset($error_sql) && $error_sql=="1062")	{		$q = "DELETE FROM movhos_000018 					WHERE Ubihis = '".$ingreso->historiaClinica."'					  AND Ubiing = '".$ingreso->ingresoHistoriaClinica."';";		$err1=mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . "-" . mysql_error());		$num_affect = mysql_affected_rows();		if($num_affect>0)		{			//Guardo LOG de borrado en tabla root_000037 por clave duplicada			$q = "	INSERT INTO log_agenda 									  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 							   VALUES									  ('".$fecha."', '".$hora."', '".$ingreso->historiaClinica."', '".$ingreso->ingresoHistoriaClinica."', 'Borrado tabla movhos_000018', '".$seguridad."', 'Clave duplicada ".$ingreso->historiaClinica."-".$ingreso->ingresoHistoriaClinica."')";			$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		}		$q = "INSERT INTO 				movhos_000018 (Medico,Fecha_data,Hora_data,Ubihis,Ubiing,Ubisac,Ubisan,Ubihac,Ubihan,Ubialp,Ubiald,Ubifap,Ubihap,Ubifad,Ubihad,Ubiptr,Seguridad)			VALUES 				('movhos','".$ingreso->fechaIngreso."','".$ingreso->horaIngreso."','".$ingreso->historiaClinica."', '".$ingreso->ingresoHistoriaClinica."', '".$ingreso->servicioActual."', '".$ingreso->servicioAnterior."', '".$ingreso->habitacionActual."',  '".$ingreso->habitacionAnterior."','".$ingreso->altaEnProceso."', '".$ingreso->altaDefinitiva."', '".$ingreso->fechaAltaProceso."','".$ingreso->horaAltaProceso."', '".$ingreso->fechaAltaDefinitiva."', '".$ingreso->horaAltaDefinitiva."', '".$ingreso->enProcesoTraslado."', 'C-".$seguridad."' )";		$err=mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		$num_affect = mysql_affected_rows();		if($num_affect>0)		{			//Guardo LOG de grabación en tabla movhos_000018			$q = "	INSERT INTO log_agenda 									  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 							   VALUES									  ('".$fecha."', '".$hora."', '".$ingreso->historiaClinica."', '".$ingreso->ingresoHistoriaClinica."', 'Grabacion tabla movhos_000018', '".$seguridad."', 'Auto')";			$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		}	}}// Verifica si el paciente ya ha sido ingresaofunction pacienteIngresado($paciente){	global $conex; 		$es = false;	$q = "SELECT 				*		 	FROM 		 		movhos_000018			WHERE 				Ubihis = '".$paciente->historiaClinica."'  				AND Ubiing   = '".$paciente->ingresoHistoriaClinica."' 			";		$err = mysql_query($q,$conex);	$num = mysql_num_rows($err);		if($num>0)	{		$es = true;	} 		return $es;}// Verifica si el paciente ya ha sido ingresado a la tabla 22 de HCEfunction pacienteIngresadoHce($paciente){	global $conex; 		$es = false;	$q = "SELECT 				*		 	FROM 		 		hce_000022			WHERE 				Mtrhis = '".$paciente->historiaClinica."'  				AND Mtring   = '".$paciente->ingresoHistoriaClinica."' 			";		$err = mysql_query($q,$conex);	$num = mysql_num_rows($err);		if($num>0)	{		$es = true;	} 		return $es;}// Verifica si el centro de costos del paciente es cirugia// Para determinar si movhos_000018.Ubiptr = on (En proceso de traslado)function esCirugia($cco){	global $conex; 		$es = false;	$q = "SELECT 				Ccocod		 	FROM 		 		movhos_000011			WHERE 				Ccocod = '".$cco."'  				AND Ccocir   = 'on' 			";		$err = mysql_query($q,$conex);	$num = mysql_num_rows($err);		if($num>0)	{		$es = true;	} 		return $es;}/********************************************************************************************//********************************************************************************************* **************************	FUNCIONES DE LLAMADO AJAX ************************************* ********************************************************************************************/// Asigna el médico tratante a un paciente en urgenciasfunction asignarMedicoUrgencias($basedatos,$basedatoshce,$medico,$paciente,$ingreso,$servicio,$seguridad,$tipo_asignacion,$wserviciourl){	global $conex; 	global $wprounificado;		$q = "	SELECT Mtrhis 			FROM ".$basedatoshce."_000022 			WHERE Mtrhis = '".$paciente."' 			AND Mtring = '".$ingreso."'";		$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	$num = mysql_num_rows($res);	// Consulto la especialidad del médico	$qesp = "	SELECT Medesp  				FROM ".$basedatos."_000048 				WHERE Meduma = '".$medico."' ";	$resesp = mysql_query($qesp, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qesp . " - " . mysql_error());	$rowesp = mysql_fetch_array($resesp);	$especialidad = explode("-",$rowesp['Medesp']);		$fecha = date("Y-m-d");	$hora = date("H:i:s");		if($num==0) 	{		$q = "INSERT INTO 				".$basedatoshce."_000022 					(Medico,Mtrfam,Mtrham,Mtrhis,Mtring,Mtrmed,Mtrest,Mtrtra,Mtretr,Mtreme,Mtrcci,Mtrcur,Seguridad)				VALUES 					('".$basedatoshce."','".$fecha."','".$hora."','".$paciente."','".$ingreso."','".$medico."','on','on','".$especialidad[0]."','".$especialidad[0]."','".$servicio."','off','C-".$seguridad."')";						$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());				if($res)			return "ok";		else			return "No se pudo realizar la asignación. \n Error: ".$res;	}else {				//Si el update es por especialidad, solo se actualiza la especialidad que viene en la variable $medico.		if($tipo_asignacion == 'especialidad'){						$filtro = "Mtretr='".$medico."', 					   Mtreme='".$medico."',";					}else{						$filtro = "Mtrmed='".$medico."',					   					   Mtretr='".$especialidad[0]."', 					   Mtreme='".$especialidad[0]."',";		}        		if (strpos($wprounificado,$wserviciourl) !== false){            $q = "	UPDATE ".$basedatoshce."_000022 					   SET Mtrfam='".$fecha."', 						   Mtrham='".$hora."', 						   $filtro						   Mtrest='on', 						   Mtrtra='on',						   Mtrcur='off'					 WHERE Mtrhis = '".$paciente."'					   AND Mtring = '".$ingreso."'					   AND (Mtrmed = '' or  Mtrcon='') ";		}else{					$q = "	UPDATE ".$basedatoshce."_000022 					   SET Mtrfam='".$fecha."', 						   Mtrham='".$hora."', 						   $filtro						   Mtrest='on', 						   Mtrtra='on',						   Mtrcur='off'					 WHERE Mtrhis = '".$paciente."'					   AND Mtring = '".$ingreso."'";		}				$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());				if($res)			return "ok";		else			return "No se pudo realizar la asignación. \n Error: ".$res;	}}// Borra los ingresos de una historia mayores al ingreso actual de Unixfunction borraIngresosMayores($basedatos,$basedatoshce,$codcco,$paciente,$ingreso,$wemp_pmla,$seguridad,$bandera,$fechaIngresoUnix,$horaIngresoUnix){	global $conex; 	global $conexUnix; 		$fecha = date("Y-m-d");	$hora = date("H:i:s");	//Consulto los ingresos mayores al ingreso actual en unix	$qmay = "	SELECT Fecha_data, Hora_data, Ubiing, Ubisac 				FROM ".$basedatos."_000018 				WHERE Ubihis = '".$paciente."' 				AND   Ubiing*1 >= ".$ingreso." ";	$resmay = mysql_query($qmay, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qmay . " - " . mysql_error());	$nummay = mysql_num_rows($resmay);		$ingreso_unix = $ingreso;	// Si encontró ingresos comience el borrado	if($nummay>0)	{	  while($rowmay = mysql_fetch_array($resmay))	  {		$ingreso = $rowmay['Ubiing'];		$fechaIngreso = $rowmay['Fecha_data'];		$horaIngreso = $rowmay['Hora_data'];		$ccoActual = $rowmay['Ubisac'];				// 2013-02-18		// Cosulto si el paciente tiene registros de movimiento hospitalario		$qeyr = " SELECT Eyrhis					FROM ".$basedatos."_000017				   WHERE Eyrhis = '".$paciente."'					 AND Eyring = '".$ingreso."'					 AND Eyrest = 'on'";		$reseyr = mysql_query($qeyr, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qeyr . " - " . mysql_error());		$numeyr = mysql_num_rows($reseyr);		// Si el paciente no ha tenido movimiento hospitalario si se puede hacer el borrado		if($numeyr==0)		{			$numant=0;			if($ingreso==$ingreso_unix)			{				// Traigo la hora de unix menos 10 minutos para comprar que la de matrix no sea menor				$horaUnix = date( "Y-m-d H:i:s", strtotime( $fechaIngresoUnix." ".$horaIngresoUnix ) - 10*60 );				$fecha = explode(" ",$horaUnix);				$fechaIngresoUnix = $fecha[0];				$horaIngresoUnix = $fecha[1];								// Valida si Fecha y hora registrados en Matrix son anteriores que los registrados en Unix				// Si es menor quiere deir que el ingreso fue reasignado en Unix pero no se borró de Matrix				// Entonces se debe borrar				//Consulto si tiene fecha hora de ingreso anterior a la de unix				$qant = "	SELECT Fecha_data							FROM ".$basedatos."_000018 							WHERE Ubihis = '".$paciente."' 							AND   Ubiing = '".$ingreso."' 							AND   ( 									(  Fecha_data < '".$fechaIngresoUnix."')									OR									(  Fecha_data = '".$fechaIngresoUnix."'									   AND Hora_data < '".$horaIngresoUnix."'									)								   ) ";				$resant = mysql_query($qant, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qant . " - " . mysql_error());				$numant = mysql_num_rows($resant);			}						if($ingreso!=$ingreso_unix || $numant>0)			{				$fechaLog = date('Y-m-d');				$horaLog = date('H:i:s');								//Borro registro en tabla 16 de Movhos 				$q = "	DELETE 						  FROM ".$basedatos."_000016 						 WHERE Inghis = '".$paciente."'						   AND Inging = '".$ingreso."'";				$res2 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());				$num_affect = mysql_affected_rows();				if($num_affect>0)				{					//Guardo LOG de borrado en tabla Movhos 16					$q = "	INSERT INTO log_agenda 											  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 									   VALUES											  ('".$fechaLog."', '".$horaLog."', '".$paciente."', '".$ingreso."', 'Borrado tabla movhos_000016', '".$seguridad."', '".$bandera."')";					$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());				}				//Borro registro en tabla 18 de Movhos 				$q = "	DELETE 						  FROM ".$basedatos."_000018 						 WHERE Ubihis = '".$paciente."'						   AND Ubiing = '".$ingreso."'";				$res1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());				$num_affect = mysql_affected_rows();				if($num_affect>0)				{					//Guardo LOG de borrado en tabla Movhos 18 					$q = "	INSERT INTO log_agenda 											  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 									   VALUES											  ('".$fechaLog."', '".$horaLog."', '".$paciente."', '".$ingreso."', 'Borrado tabla movhos_000018', '".$seguridad."', '".$bandera."')";					$resl2 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());				}				// Cosulto si el paciente ya está registrado en la tabla 22 de Hce				$q = "	SELECT Mtrhis 						FROM ".$basedatoshce."_000022 						WHERE Mtrhis = '".$paciente."' 						AND Mtring = '".$ingreso."'";				$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());				$num = mysql_num_rows($res);				if($num>0) 				{					$q = "	DELETE							  FROM ".$basedatoshce."_000022 							 WHERE Mtrhis = '".$paciente."'							   AND	Mtring = '".$ingreso."'";					$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());										$num_affect = mysql_affected_rows();					if($num_affect>0)					{						//Guardo LOG de borrado en tabla hce 22 						$q = "	INSERT INTO log_agenda 												  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 										   VALUES												  ('".$fechaLog."', '".$horaLog."', '".$paciente."', '".$ingreso."', 'Borrado tabla hce_000022', '".$seguridad."', '".$bandera."')";						$resl2 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());					}				}				// 2013-02-26				// Con esta función se borra el registro de egreso por alta que exista en la tabla 000033 de movimiento hospitalario				BorrarAltasMuertesAntesDeAgregarNueva($conex, $basedatos, $paciente, $ingreso, $bandera);				// Como ya se borro el egreso se comentan las siguientes líneas				// Cosulto si el paciente ya está registrado en la tabla 33 de Movhos				// $q2 = "	SELECT Historia_clinica 						// FROM ".$basedatos."_000033 						// WHERE Historia_clinica = '".$paciente."' 						// AND Num_ingreso = '".$ingreso."'						// AND Servicio = '".$codcco."' ";				// $res2 = mysql_query($q2, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());				// $num2 = mysql_num_rows($res2);				// if($num2>0) 				// {					// $q = "	DELETE							// FROM ".$basedatos."_000033 							// WHERE Historia_clinica = '".$paciente."' 							// AND Num_ingreso = '".$ingreso."'							// AND Servicio = '".$codcco."' ";					// $res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());										// $num_affect = mysql_affected_rows();					// if($num_affect>0)					// {						// //Guardo LOG de borrado en tabla Movhos 33 						// $q = "	INSERT INTO log_agenda 												  // (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 										   // VALUES												  // ('".$fechaLog."', '".$horaLog."', '".$paciente."', '".$ingreso."', 'Borrado tabla movhos_000033', '".$seguridad."', '".$bandera."')";						// $resl2 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());					// }				// }			}		}	  }	}}// Establece el estado de alta para un paciente en urgenciasfunction altaPacienteUrgencias($basedatos,$basedatoshce,$cco,$servicio,$paciente,$ingreso,$wemp_pmla,$wserviciourl,$seguridad,$bandera){	global $conex; 	global $conexUnix; 	global $wbasedato;	global $wprounificado;    $wbasedato = $basedatos;		$fecha = date("Y-m-d");	$hora = date("H:i:s");	// Se consulta si el paciente sigue activo en Unix	$qact = "SELECT COUNT(*)			   FROM inpac			  WHERE pachis = '".$paciente."'				AND pacnum = ".$ingreso."";	$rs_act = odbc_do($conexUnix,$qact);	odbc_fetch_row($rs_act);	$campos = odbc_result($rs_act,1);			// Si no está activo en Unix según inpac	// mira en inpaci si está inactivo con el mismo ingreso	// Sino el ingreso fue cancelado y se borra ingreso en Matrix	if(!$campos || $campos==0)	{		// Se consulta si el paciente tiene el mismo ingreso en inpaci (Pacientes inactivos)		$qin = "SELECT COUNT(*)				   FROM inpaci				  WHERE pachis = '".$paciente."'					AND pacnum = ".$ingreso."";		$rs_in = odbc_do($conexUnix,$qin);		odbc_fetch_row($rs_in);		$fields = odbc_result($rs_in,1);	}	// Si se identificó ingreso diferente al que traemos en inpaci	// El alta debe ser con borrado de ingreso en Matrix	if(isset($fields) && $fields==0 && $bandera!="Ingreso")	{		// Consulto el ingreso actual en inpaci		$qcomp = " SELECT pacing				     FROM inpaci				    WHERE pachis = '".$paciente."'";		$rs_comp = odbc_do($conexUnix,$qcomp);		odbc_fetch_row($rs_comp);		$ing_act = odbc_result($rs_comp,1);				if($ingreso>$ing_act)			$tipo_alta = "borrado";		else			$tipo_alta = "normal";	}	else	{		// Si el alta es automática y se encontraron registros en inpac no se da de alta		// El que este en inpac y no en urgencias quiere decir que fue trasladado a otro centro de costos		// Notese que si el alta no es automatica deja dar de alta asi este activo en inpac		// El operador puede volver a activar el paciente si se equivocó al dar de alta		if(isset($bandera) && $bandera=="auto" && isset($campos) && $campos>0)			$tipo_alta = "noalta";		else			$tipo_alta = "normal";	}	// 2012-01-19	// Si fecha de egreso en unix es igual a la fecha actual y el paciente aún aparece en la tabla de 	// Estado de habitaciones (movhos_000020) con cama asignada, entonces la historia no se debe dar de alta	// Esto porque normalmente el paciente es egresado y el registro de egreso en Unix se hace al siguiente día	// Si se egresa el mismo día en matrix puede haber inconsistencias en cuanto a la ocupación de camas 	$qegr = "SELECT egregr 			   FROM inmegr			  WHERE egrhis = '".$paciente."'				AND egrnum = ".$ingreso."";	$rs_egr = odbc_do($conexUnix,$qegr);	odbc_fetch_row($rs_egr);	$fecha_egreso = odbc_result($rs_egr,1);		if($fecha_egreso == $fecha)	{		//Consulto si el paciente aún tiene cama asignada		$qhab = "	SELECT Habhis, Habing					FROM ".$basedatos."_000020					WHERE Habhis = '".$paciente."' 					AND Habing = '".$ingreso."'";		$reshab = mysql_query($qhab, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qhab . " - " . mysql_error());		$numhab = mysql_num_rows($reshab);		// Si tiene cama asiganada y fecha de egreso en unix es igual a la fecha actual		if($numhab>0)			$tipo_alta = "noalta";	}	// Consulto si el paciente está en la tabla de Historias No Automaticas	// Si está en esta tabla indica que no se puede dar de alta automáticamente	$qhna = "	SELECT Hnahis, Hnaing				FROM ".$basedatos."_000140				WHERE Hnahis = '".$paciente."'				  AND Hnaing = '".$ingreso."'				  AND Hnaest = 'on'";	$reshna = mysql_query($qhna, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qhna . " - " . mysql_error());	$numhna = mysql_num_rows($reshna);	// Si está en tabla de Historia no automática y el alta es automática	if($numhna>0 && isset($bandera) && $bandera=="auto")		$tipo_alta = "noalta";        // 2018-03-23 Se desactiva porque el usuario debe dar de Alta aunque    // tenga solo admisión.	if (strpos($wprounificado,$wserviciourl) !== false){		//Consulto si el paciente fue dado de alta por el médico en hce		$qAlta = "	SELECT Mtrhis, Mtring, Mtrcon					FROM ".$basedatoshce."_000022							WHERE Mtrhis = '".$paciente."' 							AND Mtring = '".$ingreso."'							AND Mtrest = 'on'";		$resAlta = mysql_query($qAlta, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qAlta . " - " . mysql_error());		$numAlta = mysql_num_rows($resAlta);				if($numAlta>1){           $qres = " SELECT Mtrhis, Mtring, Mtrcon				  FROM ".$basedatoshce."_000022							WHERE Mtrhis = '".$paciente."' 							AND Mtring = '".$ingreso."'							AND Mtrcon = ''							AND Mtrest = 'on' ";		   $result = mysql_query($qres, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qres . " - " . mysql_error());                      $numres = mysql_num_rows($result);           if($numres >= 1)		      $tipo_alta = "noalta";		}       }	// Inicia el proceso de alta después de validar si realmente se va a dar de alta	if($tipo_alta != "noalta")	{		if($tipo_alta == "normal")		{			//Consulto si el paciente tiene conducta asignada			$qcon = "	SELECT Mtrhis, Mtring, Mtrcon						FROM ".$basedatoshce."_000022						WHERE Mtrhis = '".$paciente."' 						AND Mtring = '".$ingreso."'						AND Mtrcon != '' 						AND Mtrcon != 'NO APLICA' 						AND Mtrest = 'on' ";			$rescon = mysql_query($qcon, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qcon . " - " . mysql_error());			$rowcon = mysql_fetch_array($rescon);			$numcon = mysql_num_rows($rescon);						// Si tiene conducta asiganada y es alta automática no se da de alta			if($numcon > 0 && isset($bandera) && $bandera=="auto") {				return "no-alta";			} else {				//Consulto si el paciente está en proceso de traslado				$qptr = "	SELECT Ubihis, Ubiing, Ubiptr, Eyrsor, Eyrsde, Cconom							FROM ".$basedatos."_000017, ".$basedatos."_000018, ".$basedatos."_000011							WHERE Ubihis = '".$paciente."' 							AND Ubiing = '".$ingreso."'							AND Ubiptr = 'on'							AND Ubihis = Eyrhis							AND Ubiing = Eyring							AND Eyrest = 'on'							AND Eyrsde = Ccocod ";				$resptr = mysql_query($qptr, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qptr . " - " . mysql_error());				$rowptr = mysql_fetch_array($resptr);				$numptr = mysql_num_rows($resptr);								// Si está en proceso de traslado no se puede dar de alta				if($numptr>0) {					return "El paciente no se puede dar de alta debido a que está en proceso de traslado para el servicio ".$rowptr['Cconom'];				} else {									//Consulto datos en tabla 18 de movhos					$qubi = "	SELECT Fecha_data, Hora_data, Ubisac								FROM ".$basedatos."_000018								WHERE Ubihis = '".$paciente."' 								AND Ubiing = '".$ingreso."'";					$resubi = mysql_query($qubi, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qubi . " - " . mysql_error());					$rowubi = mysql_fetch_array($resubi);					$numubi = mysql_num_rows($resubi);					//Actualizo tabla 18 de Movhos asignandole los parametros del alta					$q = "	UPDATE ".$basedatos."_000018 							SET Ubiald='on', Ubifad='".$fecha."', Ubihad='".$hora."', Ubiuad='".$seguridad."' 							WHERE Ubihis = '".$paciente."'							AND	Ubiing = '".$ingreso."'";					$res1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());						$num_affect = mysql_affected_rows();					if($num_affect>0)					{						//Guardo LOG de actualización alta en tabla movhos_000018						$q = "	INSERT INTO log_agenda 												  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 										   VALUES												  ('".$fecha."', '".$hora."', '".$paciente."', '".$ingreso."', 'Actualizacion tabla movhos_000018', '".$seguridad."', 'Alta ".$bandera."')";						$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());					}										//Consulto el código de la conducta de alta en la tabla 35 de HCE					$qalt = "	SELECT Concod  								FROM ".$basedatoshce."_000035 								WHERE Conalt = 'on' 								AND Conadm = 'on'";					$resalt = mysql_query($qalt, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qalt . " - " . mysql_error());					$rowalt = mysql_fetch_array($resalt);					$conducta = $rowalt['Concod'];										// Cosulto si el paciente ya está registrado en la tabla 22 de Hce					$q = "	SELECT Mtrhis 							FROM ".$basedatoshce."_000022 							WHERE Mtrhis = '".$paciente."' 							AND Mtring = '".$ingreso."'";					$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());					$num = mysql_num_rows($res);						if($num==0) {						$q = "INSERT INTO 								".$basedatoshce."_000022 									(Medico,Fecha_data,Hora_data,Mtrhis,Mtring,Mtrcci,Mtrmed,Mtrest,Mtrtra,Mtretr,Mtrcon,Mtrcur,Seguridad)								VALUES 									('".$basedatoshce."','".$fecha."','".$hora."','".$paciente."','".$ingreso."','".$cco."','','on','off','','".$conducta."','off','C-".$seguridad."')";						$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());												$num_affect = mysql_affected_rows();						if($num_affect>0)						{							//Guardo LOG de grabación alta en tabla hce_000022							$q = "	INSERT INTO log_agenda 													  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 											   VALUES													  ('".$fecha."', '".$hora."', '".$paciente."', '".$ingreso."', 'Grabacion tabla hce_000022', '".$seguridad."', 'Alta ".$bandera."')";							$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());						}					} else {						$q = "	UPDATE ".$basedatoshce."_000022 								SET Mtrest='on', Mtrcon='".$conducta."', Mtrcur='off'								WHERE Mtrhis = '".$paciente."'								AND	Mtring = '".$ingreso."'";												$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());												$num_affect = mysql_affected_rows();						if($num_affect>0)						{							//Guardo LOG de actualización alta en tabla hce_000022							$q = "	INSERT INTO log_agenda 													  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 											   VALUES													  ('".$fecha."', '".$hora."', '".$paciente."', '".$ingreso."', 'Actualizacion tabla hce_000022', '".$seguridad."', 'Alta ".$bandera."')";							$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());						}					}						// Cosulto si el paciente está registrado en la tabla 20 de Movhos					$q = "	SELECT *							FROM ".$basedatos."_000020							WHERE Habhis = '".$paciente."'							AND Habing = '".$ingreso."'";					$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());					$num = mysql_num_rows($res);					if($num>0) {						$q = "	UPDATE ".$basedatos."_000020								SET Habhis='', Habing='', Habali='off', Habdis='off', Habfal='".$fecha."', Habhal='".$hora."'								WHERE Habhis = '".$paciente."'								AND	Habing = '".$ingreso."'";						$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());						$num_affect = mysql_affected_rows();						if($num_affect>0)						{							//Guardo LOG de actualización alta en tabla hce_000022							$q = "	INSERT INTO log_agenda													  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera, Registros)											   VALUES													  ('".$fecha."', '".$hora."', '".$paciente."', '".$ingreso."', 'Actualizacion tabla movhos_000020', '".$seguridad."', 'Alta ".$bandera."', '')";							$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());						}					}					// 2013-02-26					// Con esta función se borra el registro de egreso por alta que exista en la tabla 000033 de movimiento hospitalario					BorrarAltasMuertesAntesDeAgregarNueva($conex, $basedatos, $paciente, $ingreso, "Egreso existente");					//2013-04-25					//Cancelar el servicio de dietas					cancelar_pedido_alimentacion($paciente, $ingreso, $rowubi['Ubisac'], "Cancelar", 'movhos');   					// Como ya se borro el egreso se comentan las siguientes líneas					// // Cosulto si el paciente ya está registrado en la tabla 33 de Movhos					// $q = "	SELECT Historia_clinica 							// FROM ".$basedatos."_000033 							// WHERE Historia_clinica = '".$paciente."' 							// AND Num_ingreso = '".$ingreso."'							// AND Servicio = '".$cco."'							// AND (Tipo_egre_serv = 'ALTA'							// OR Tipo_egre_serv = 'MUERTE'							// OR Tipo_egre_serv = 'MUERTE MAYOR A 48 HORAS' 							// OR Tipo_egre_serv = 'MUERTE MENOR A 48 HORAS') ";					// $resegr = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());					// $numegr = mysql_num_rows($resegr);						// 2013-05-09					// Cosulto si el cco de ingreso del paciente registrado en la tabla 000022 de historia clinica electronica (Mtrcci) es hospitalario					// y en la tabla 000018 de movimiento hospitalario no tiene cco anterior (Ubisan)					// Si es así no se debe registrar el egreso en la tabla 000033 de movimiento hospitalario					$q = "	SELECT Ubihis							FROM ".$basedatos."_000018, ".$basedatoshce."_000022, ".$basedatos."_000011							WHERE Ubihis = '".$paciente."'							AND Ubiing = '".$ingreso."'							AND Ubihis = Mtrhis 							AND Ubiing = Mtring  							AND Mtrcci = Ccocod							AND Ccohos = 'on'							AND Ccoing != 'on'							AND (TRIM(Ubisan) = '' OR TRIM(Ubisan) = 'NO APLICA')";					$resegr = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());					$numegr = mysql_num_rows($resegr);										$registraEgreso = true;					if($numegr>0)						$registraEgreso = false;										if($registraEgreso)					{						//Consulto la fecha y hora de ingreso del paciente						$sql = "SELECT Fecha_data, Hora_data								  FROM ".$basedatos."_000018								 WHERE Ubihis = '".$paciente."'								   AND Ubiing = '".$ingreso."'";														$resFH = mysql_query( $sql, $conex ) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());						if( $rowsFH = mysql_fetch_array( $resFH ) ){														$datetime1 		= new DateTime( $rowsFH['Fecha_data']." ".$rowsFH['Hora_data'] );							$datetime2		= new DateTime( $fecha." ".$hora );							$timeDiff 		= $datetime1->diff($datetime2);														//Calculo de dias de estancias contada en días a dos decimales							$tiempoEstancia = round( $timeDiff->days + $timeDiff->h/24 + $timeDiff->i/(24*60), 2 );													//Registro el egreso en la tabla 33 de Movhos							$q = "	INSERT INTO 									".$basedatos."_000033 										(Medico, Fecha_data, Hora_data, Historia_clinica, Num_ingreso, Servicio, Num_ing_serv, Fecha_egre_serv, Hora_egr_serv, Tipo_egre_serv, Dias_estan_serv,Seguridad)									VALUES 										('".$basedatos."','".$fecha."','".$hora."','".$paciente."','".$ingreso."','".$cco."','1','".$fecha."','".$hora."','ALTA','".$tiempoEstancia."','C-".$seguridad."')";							$res2 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());										$num_affect = mysql_affected_rows();							if($num_affect>0)							{								//Guardo LOG de grabación egreso en tabla movhos_000033								$q = "	INSERT INTO log_agenda 														  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 												   VALUES														  ('".$fecha."', '".$hora."', '".$paciente."', '".$ingreso."', 'Grabacion tabla movhos_000033', '".$seguridad."', 'Alta ".$bandera."')";								$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());							}						}					}					// else 					// {						// $q = "	UPDATE ".$basedatos."_000033 								// SET Fecha_data='".$fecha."', Hora_data='".$hora."', Fecha_egre_serv='".$fecha."', Hora_egr_serv='".$hora."', Seguridad='C-".$seguridad."' 								// WHERE Historia_clinica = '".$paciente."' 								// AND Num_ingreso = '".$ingreso."'								// AND Servicio = '".$cco."'								// AND Tipo_egre_serv = 'ALTA'";						// $res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());												// $num_affect = mysql_affected_rows();						// if($num_affect>0)						// {							// //Guardo LOG de actualización alta en tabla hce_000022							// $q = "	INSERT INTO log_agenda 													  // (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 											   // VALUES													  // ('".$fecha."', '".$hora."', '".$paciente."', '".$ingreso."', 'Actualizacion tabla movhos_000033', '".$seguridad."', 'Alta ".$bandera."')";							// $resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());						// }					// }						if($res1)						return "ok";					else						return "Ocurrió un error en el proceso. \n Error: ".$res1;				}			}		}		elseif($tipo_alta == "borrado")		{			//Consulto si el paciente está en proceso de traslado			$qptr = "	SELECT Ubihis, Ubiing, Ubiptr, Eyrsor, Eyrsde, Cconom						FROM ".$basedatos."_000017, ".$basedatos."_000018, ".$basedatos."_000011						WHERE Ubihis = '".$paciente."' 						AND Ubiing = '".$ingreso."'						AND Ubiptr = 'on'						AND Ubihis = Eyrhis						AND Ubiing = Eyring						AND Eyrest = 'on'						AND Eyrsde = Ccocod ";			$resptr = mysql_query($qptr, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qptr . " - " . mysql_error());			$rowptr = mysql_fetch_array($resptr);			$numptr = mysql_num_rows($resptr);						// Si está en proceso de traslado no se puede dar de alta			if($numptr>0) {				return "El paciente no se puede dar de alta debido a que está en proceso de traslado para el servicio ".$rowptr['Cconom'];			} else {				// 2013-02-22				// Cosulto si el paciente tiene registros de movimiento hospitalario				$qeyr = " SELECT Eyrhis							FROM ".$basedatos."_000017						   WHERE Eyrhis = '".$paciente."'							 AND Eyring = '".$ingreso."'							 AND Eyrest = 'on'";				$reseyr = mysql_query($qeyr, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qeyr . " - " . mysql_error());				$numeyr = mysql_num_rows($reseyr);				// Si el paciente ha tenido movimiento hospitalario no se puede hacer el borrado				if($numeyr>0) {					return "El paciente no se puede dar de alta debido a que tiene movimiento hospitalario registrado";				} else {									//Consulto datos en tabla 18 de movhos					$qubi = "	SELECT Fecha_data, Hora_data, Ubisac								FROM ".$basedatos."_000018								WHERE Ubihis = '".$paciente."' 								AND Ubiing = '".$ingreso."'";					$resubi = mysql_query($qubi, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qubi . " - " . mysql_error());					$rowubi = mysql_fetch_array($resubi);					$numubi = mysql_num_rows($resubi);					if($numubi>0)					{						//Actualizo tabla 37 de root						$q = "	UPDATE root_000037 								SET Fecha_data='".$rowubi['Fecha_data']."', Hora_data='".$rowubi['Hora_data']."', Oriing=Oriing-1								WHERE Orihis = '".$paciente."'								AND	Oriing = '".$ingreso."' 								AND	Oriori = '".$wemp_pmla."'";						$res1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());					}										$num_affect = mysql_affected_rows();					if($num_affect>0)					{						//Guardo LOG de actualización en tabla root_000037						$q = "	INSERT INTO log_agenda 												  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 										   VALUES												  ('".$fecha."', '".$hora."', '".$paciente."', '".$ingreso."', 'Actualizacion tabla root_000037', '".$seguridad."', 'Alta ".$bandera." Oriing-1')";						$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());					}										$fechaLog = date('Y-m-d');					$horaLog = date('H:i:s');					//Borro registro en tabla 16 de Movhos 					$q = "	DELETE 							  FROM ".$basedatos."_000016 							 WHERE Inghis = '".$paciente."'							   AND Inging = '".$ingreso."'";					$res2 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());					$num_affect = mysql_affected_rows();					if($num_affect>0)					{						//Guardo LOG de borrado en tabla Movhos 16						$q = "	INSERT INTO log_agenda 												  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 										   VALUES												  ('".$fechaLog."', '".$horaLog."', '".$paciente."', '".$ingreso."', 'Borrado tabla movhos_000016', '".$seguridad."', 'Alta ".$bandera."')";						$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());					}										//Borro registro en tabla 18 de Movhos 					$q = "	DELETE 							  FROM ".$basedatos."_000018 							 WHERE Ubihis = '".$paciente."'							   AND Ubiing = '".$ingreso."'";					$res1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());					$num_affect = mysql_affected_rows();					if($num_affect>0)					{						//Guardo LOG de borrado en tabla Movhos 18 						$q = "	INSERT INTO log_agenda 												  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 										   VALUES												  ('".$fechaLog."', '".$horaLog."', '".$paciente."', '".$ingreso."', 'Borrado tabla movhos_000018', '".$seguridad."', 'Alta ".$bandera."')";						$resl2 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());					}					// Cosulto si el paciente ya está registrado en la tabla 22 de Hce					$q = "	SELECT Mtrhis 							FROM ".$basedatoshce."_000022 							WHERE Mtrhis = '".$paciente."' 							AND Mtring = '".$ingreso."'";					$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());					$num = mysql_num_rows($res);					if($num>0) 					{						$q = "	DELETE								  FROM ".$basedatoshce."_000022 								 WHERE Mtrhis = '".$paciente."'								   AND	Mtring = '".$ingreso."'";						$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());						$num_affect = mysql_affected_rows();						if($num_affect>0)						{							//Guardo LOG de borrado en tabla hce 22							$q = "	INSERT INTO log_agenda 													  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 											   VALUES													  ('".$fechaLog."', '".$horaLog."', '".$paciente."', '".$ingreso."', 'Borrado tabla hce_000022', '".$seguridad."', 'Alta ".$bandera."')";							$resl2 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());						}					}					// 2013-02-26					// Con esta función se borra el registro de egreso por alta que exista en la tabla 000033 de movimiento hospitalario					BorrarAltasMuertesAntesDeAgregarNueva($conex, $basedatos, $paciente, $ingreso, "Alta ".$bandera);					//2013-04-25					//Cancelar el servicio de dietas					cancelar_pedido_alimentacion($paciente, $ingreso, $rowubi['Ubisac'], "Cancelar", 'movhos');   					// Como ya se borro el egreso se comentan las siguientes líneas					// // Cosulto si el paciente ya está registrado en la tabla 33 de Movhos					// $q = "	SELECT *							// FROM ".$basedatos."_000033							// WHERE Historia_clinica = '".$paciente."'							// AND Num_ingreso = '".$ingreso."'							// AND	Tipo_egre_serv = 'ALTA'";					// $res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());					// $num = mysql_num_rows($res);					// if($num>0)					// {						// $registrosFila = obtenerRegistrosFila($q);						// $q = "	DELETE								  // FROM ".$basedatos."_000033								 // WHERE Historia_clinica = '".$paciente."'								   // AND	Num_ingreso = '".$ingreso."'								   // AND	Tipo_egre_serv = 'ALTA'";						// $res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());						// $num_affect = mysql_affected_rows();						// if($num_affect>0)						// {							// //Guardo LOG de borrado en tabla hce 22							// $q = "	INSERT INTO log_agenda													  // (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera, Registros)											   // VALUES													  // ('".$fechaLog."', '".$horaLog."', '".$paciente."', '".$ingreso."', 'Borrado tabla movhos_000033', '".$seguridad."', 'Alta ".$bandera."', '".$registrosFila."')";							// $resl2 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());						// }					// }										if($res1)						return "ok";					else						return utf8_decode("Ocurrió un error en el proceso. \n Error: ").$res1;				}			}		}	}	else	{			return utf8_decode("El paciente no se puede dar de alta porque aún está activo en el sistema");	}}// Establece el estado de alta por muerte para un paciente en urgenciasfunction muertePacienteUrgencias($basedatos,$basedatoshce,$cco,$paciente,$ingreso,$seguridad){	global $conex; 	global $wbasedato;    $wbasedato = $basedatos;		$fecha = date("Y-m-d");	$hora = date("H:i:s");	//Consulto si el paciente está en proceso de traslado	$qptr = "	SELECT Ubihis, Ubiing, Ubiptr, Eyrsor, Eyrsde, Cconom				FROM ".$basedatos."_000017, ".$basedatos."_000018, ".$basedatos."_000011				WHERE Ubihis = '".$paciente."' 				AND Ubiing = '".$ingreso."'				AND Ubiptr = 'on'				AND Ubihis = Eyrhis				AND Ubiing = Eyring				AND Eyrest = 'on'				AND Eyrsde = Ccocod ";	$resptr = mysql_query($qptr, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qptr . " - " . mysql_error());	$rowptr = mysql_fetch_array($resptr);	$numptr = mysql_num_rows($resptr);		// Si está en proceso de traslado no se puede dar de alta	if($numptr>0)	{		return "El paciente no se puede dar de alta por muerte debido a que está en proceso de traslado para el servicio ".$rowptr['Cconom'];	}	else	{				//Actualizo tabla 18 de Movhos asignandole los parametros del alta		$q = "	UPDATE ".$basedatos."_000018 				SET Ubimue='on', Ubiald='on', Ubifad='".$fecha."', Ubihad='".$hora."', Ubiuad='".$seguridad."'				WHERE Ubihis = '".$paciente."'				AND	Ubiing = '".$ingreso."'";		$res1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		$num_affect = mysql_affected_rows();		if($num_affect>0)		{			//Guardo LOG de actualizacion en tabla movhos 18 - alta por muerte			$q = "	INSERT INTO log_agenda 									  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 							   VALUES									  ('".$fecha."', '".$hora."', '".$paciente."', '".$ingreso."', 'Actualizacion tabla movhos_000018', '".$seguridad."', 'Alta por muerte')";			$resl2 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		}				//Consulto el código de la conducta de alta en la tabla 35 de HCE		$qalt = "	SELECT Concod  					FROM ".$basedatoshce."_000035 					WHERE Conmue = 'on' 					AND Conadm = 'on'";		$resalt = mysql_query($qalt, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qalt . " - " . mysql_error());		$rowalt = mysql_fetch_array($resalt);		$conducta = $rowalt['Concod'];				// Cosulto si el paciente ya está registrado en la tabla 22 de Hce		$q = "	SELECT Mtrhis 				FROM ".$basedatoshce."_000022 				WHERE Mtrhis = '".$paciente."' 				AND Mtring = '".$ingreso."'";		$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		$num = mysql_num_rows($res);		if($num==0) 		{			$q = "INSERT INTO 					".$basedatoshce."_000022 						(Medico,Fecha_data,Hora_data,Mtrhis,Mtring,Mtrcci,Mtrmed,Mtrest,Mtrtra,Mtretr,Mtrcon,Mtrcur,Seguridad)					VALUES 						('".$basedatoshce."','".$fecha."','".$hora."','".$paciente."','".$ingreso."','".$cco."','','on','off','','".$conducta."','off','C-".$seguridad."')";			$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());						$num_affect = mysql_affected_rows();			if($num_affect>0)			{				//Guardo LOG de grabacion en tabla hce 22 - alta por muerte				$q = "	INSERT INTO log_agenda 										  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 								   VALUES										  ('".$fecha."', '".$hora."', '".$paciente."', '".$ingreso."', 'Grabacion tabla hce_000022', '".$seguridad."', 'Alta por muerte')";				$resl2 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());			}		} 		else 		{			$q = "	UPDATE ".$basedatoshce."_000022 					SET Mtrest='on', Mtrcon='".$conducta."', Mtrcur='off' 					WHERE Mtrhis = '".$paciente."'					AND	Mtring = '".$ingreso."'";			$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());			$num_affect = mysql_affected_rows();			if($num_affect>0)			{				//Guardo LOG de actualizacion en tabla hce 22 - alta por muerte				$q = "	INSERT INTO log_agenda 										  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 								   VALUES										  ('".$fecha."', '".$hora."', '".$paciente."', '".$ingreso."', 'Actualizacion tabla hce_000022', '".$seguridad."', 'Alta por muerte')";				$resl2 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());			}		}		// 2013-02-26		// Con esta función se borra el registro de egreso por alta que exista en la tabla 000033 de movimiento hospitalario		BorrarAltasMuertesAntesDeAgregarNueva($conex, $basedatos, $paciente, $ingreso, "Alta por muerte");				//2013-04-25		//Cancelar el servicio de dietas		cancelar_pedido_alimentacion($paciente, $ingreso, $codcco, "Muerte", 'movhos');   		// Como ya se borro el egreso se comentan las siguientes líneas		// Cosulto si el paciente ya está registrado en la tabla 33 de Movhos		// $q = "	SELECT Historia_clinica 				// FROM ".$basedatos."_000033 				// WHERE Historia_clinica = '".$paciente."' 				// AND Num_ingreso = '".$ingreso."'				// AND Servicio = '".$cco."'				// AND Tipo_egre_serv = 'MUERTE'";		// $resegr = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		// $numegr = mysql_num_rows($resegr);		// 2013-05-09		// Cosulto si el cco de ingreso del paciente registrado en la tabla 000022 de historia clinica electronica (Mtrcci) es hospitalario		// y en la tabla 000018 de movimiento hospitalario no tiene cco anterior (Ubisan)		// Si es así no se debe registrar el egreso en la tabla 000033 de movimiento hospitalario		$q = "	SELECT Ubihis				FROM ".$basedatos."_000018, ".$basedatoshce."_000022, ".$basedatos."_000011				WHERE Ubihis = '".$paciente."'				AND Ubiing = '".$ingreso."'				AND Ubihis = Mtrhis 				AND Ubiing = Mtring  				AND Mtrcci = Ccocod				AND Ccohos = 'on'				AND Ccoing != 'on'				AND (TRIM(Ubisan) = '' OR TRIM(Ubisan) = 'NO APLICA')";		$resegr = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		$numegr = mysql_num_rows($resegr);				$registraEgreso = true;		if($numegr>0)			$registraEgreso = false;				if($registraEgreso)		{			//Consulto la fecha y hora de ingreso del paciente			$sql = "SELECT Fecha_data, Hora_data					  FROM ".$basedatos."_000018					 WHERE Ubihis = '".$paciente."'					   AND Ubiing = '".$ingreso."'";								$resFH = mysql_query( $sql, $conex ) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());			if( $rowsFH = mysql_fetch_array( $resFH ) ){								$datetime1 		= new DateTime( $rowsFH['Fecha_data']." ".$rowsFH['Hora_data'] );				$datetime2		= new DateTime( $fecha." ".$hora );				$timeDiff 		= $datetime1->diff($datetime2);								$tiempoEstancia = round( $timeDiff->days + $timeDiff->h/24+ $timeDiff->i/(24*60), 2 );								//Registro el egreso en la tabla 33 de Movhos				$q = "	INSERT INTO 						".$basedatos."_000033 							(Medico, Fecha_data, Hora_data, Historia_clinica, Num_ingreso, Servicio, Num_ing_serv, Fecha_egre_serv, Hora_egr_serv, Tipo_egre_serv, Dias_estan_serv,Seguridad)						VALUES 							('".$basedatos."','".$fecha."','".$hora."','".$paciente."','".$ingreso."','".$cco."','1','".$fecha."','".$hora."','MUERTE','".$tiempoEstancia."','C-".$seguridad."')";				$res2 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());				$num_affect = mysql_affected_rows();				if($num_affect>0)				{					//Guardo LOG de grabación egreso en tabla movhos_000033					$q = "	INSERT INTO log_agenda 											  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 									   VALUES											  ('".$fecha."', '".$hora."', '".$paciente."', '".$ingreso."', 'Grabacion tabla movhos_000033', '".$seguridad."', 'Alta por muerte')";					$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());				}			}		}		// else 		// {			// $q = "	UPDATE ".$basedatos."_000033 					// SET Fecha_data='".$fecha."', Hora_data='".$hora."', Fecha_egre_serv='".$fecha."', Hora_egr_serv='".$hora."', Seguridad='C-".$seguridad."' 					// WHERE Historia_clinica = '".$paciente."' 					// AND Num_ingreso = '".$ingreso."'					// AND Servicio = '".$cco."'					// AND Tipo_egre_serv = 'MUERTE'";			// $res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());						// $num_affect = mysql_affected_rows();			// if($num_affect>0)			// {				// //Guardo LOG de actualización alta en tabla movhos_000033				// $q = "	INSERT INTO log_agenda 										  // (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 								   // VALUES										  // ('".$fecha."', '".$hora."', '".$paciente."', '".$ingreso."', 'Actualizacion tabla movhos_000033', '".$seguridad."', 'Alta por muerte')";				// $resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());			// }		// }		if($res1)			return "ok";		else			return "Ocurrió un error en el proceso. \n Error: ".$res1;	}}// Vuelve y activa un paciente dado de altafunction activarPacienteUrgencias($basedatos,$basedatoshce,$cco,$paciente,$ingreso,$seguridad){	global $conex; 	global $conexUnix;					$fecha = date("Y-m-d");	$hora = date("H:i:s");		// Cosulto si el paciente está en agenda urgencias	$qagn = "	SELECT Ubihis 				FROM ".$basedatos."_000018, ".$basedatoshce."_000022  				WHERE Ubihis = '".$paciente."' 				AND Ubimue != 'on' 				AND Ubiald != 'on' 				AND Ubisac = '".$cco."'				AND Ubihis = Mtrhis  				AND Ubiing = Mtring ";	$resagn = mysql_query($qagn, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qagn . " - " . mysql_error());	$numagn = mysql_num_rows($resagn);	if($numagn==0) 	{		// Se consulta si el paciente sigue activo en Unix		$qact = "SELECT COUNT(*)				   FROM inpac				  WHERE pachis = '".$paciente."'					AND pacnum = ".$ingreso."";		$rs_act = odbc_do($conexUnix,$qact);		odbc_fetch_row($rs_act);		$campos = odbc_result($rs_act,1);					// Si está activo en Unix según inpac		if(isset($campos) & $campos>0)		{			//Actualizo tabla 18 de Movhos de modo que quite los registros de alta			$q = "	UPDATE ".$basedatos."_000018 					SET Ubimue='off', Ubiald='off', Ubialp='off', Ubifad='0000-00-00', Ubihad='00:00:00', Ubiuad='' 					WHERE Ubihis = '".$paciente."'					AND	Ubiing = '".$ingreso."'";			$res1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());			$num_affect = mysql_affected_rows();			if($num_affect>0)			{				//Guardo LOG de actualizacion en tabla movhos 18 - Activacion paciente				$q = "	INSERT INTO log_agenda 										  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 								   VALUES										  ('".$fecha."', '".$hora."', '".$paciente."', '".$ingreso."', 'Actualizacion tabla movhos_000018', '".$seguridad."', 'Activacion paciente')";				$resl2 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());			}			// Cosulto si el paciente ya está registrado en la tabla 22 de Hce			$q = "	SELECT Mtrhis 					FROM ".$basedatoshce."_000022 					WHERE Mtrhis = '".$paciente."' 					AND Mtring = '".$ingreso."'";			$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());			$num = mysql_num_rows($res);			// Si está registrado active de nuevo los regisros del paciente			if($num>0) 			{				$q = "	UPDATE ".$basedatoshce."_000022 						SET Mtrest='on', Mtrcur='off', Mtrcon='',  Mtrmed=''						WHERE Mtrhis = '".$paciente."'						AND	Mtring = '".$ingreso."'";				$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());								$num_affect = mysql_affected_rows();				if($num_affect>0)				{					//Guardo LOG de actualizacion en tabla hce 22 - Activacion paciente					$q = "	INSERT INTO log_agenda 											  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 									   VALUES											  ('".$fecha."', '".$hora."', '".$paciente."', '".$ingreso."', 'Actualizacion tabla hce_000022', '".$seguridad."', 'Activacion paciente')";					$resl2 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());				}			}			// 2013-02-26			// Con esta función se borra el registro de egreso por alta que exista en la tabla 000033 de movimiento hospitalario			BorrarAltasMuertesAntesDeAgregarNueva($conex, $basedatos, $paciente, $ingreso, "Activacion paciente");			// Como ya se borro el egreso se comentan las siguientes líneas			//Borro el registro de egreso en la tabla 33 de Movhos			// $q = "	DELETE FROM ".$basedatos."_000033 					// WHERE Historia_clinica = '".$paciente."' AND Num_ingreso = '".$ingreso."'";			// $res2 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());			// $num_affect = mysql_affected_rows();			// if($num_affect>0)			// {				// //Guardo LOG de borrado en tabla movhos 33 - Activacion paciente				// $q = "	INSERT INTO log_agenda 										  // (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 								   // VALUES										  // ('".$fecha."', '".$hora."', '".$paciente."', '".$ingreso."', 'Borrado tabla movhos_000033', '".$seguridad."', 'Activacion paciente')";				// $resl2 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());			// }			if($res1)				return "ok";			else				return "Ocurrió un error en el proceso. \n Error: ".$res1;		}		else		{			return "inactivoEnUnix";		}	} 	else			{		return "activo";	}}// Crea un nuevo registro en hce_000022 indicando que el paciente posee mas de una cita médica en el mismo ingresofunction asignarAgendaMultiple($basedatos,$basedatoshce,$cco,$paciente,$ingreso,$wemp_pmla,$seguridad){    global $conex;         $arrResult = array("message" => "", "error" => false);    $fecha = date("Y-m-d");	$hora = date("H:i:s");    //Consultar que la historia e ingreso actual tenga conducta de Alta       $qAlta = "	SELECT Mtrhis 				FROM ".$basedatoshce."_000022 h22				Left JOIN ".$basedatoshce."_000035 h35				        ON  h22.Mtrcon = h35.Concod				Where Mtrhis = '".$paciente."' 				  And Mtring = '".$ingreso."' 				  And Conalt = 'on' ";		$resAlta = mysql_query($qAlta, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qAlta . " - " . mysql_error());	$numAlta = mysql_num_rows($resAlta);	if ( $numAlta == 0 ){    	 $arrResult["error"]   = true;         $arrResult["message"] = "El paciente no se encuentra dado de Alta";    }	//Consultar que la historia e ingreso actual no tenga consulta pendiente    $qPen = "	SELECT Mtrhis 				FROM ".$basedatoshce."_000022 h22				Left JOIN ".$basedatoshce."_000035 h35				        ON  h22.Mtrcon = h35.Concod				Where  Mtrhis = '".$paciente."' 				  And  Mtring = '".$ingreso."' 				  And (Mtrmed = ''  or Mtrmed = 'NO APLICA' or Mtrcon ='') ";		$resPen = mysql_query($qPen, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qPen . " - " . mysql_error());	$numPen = mysql_num_rows($resPen);	if ( $numPen > 0 ){    	 $arrResult["error"]   = true;         $arrResult["message"] = "El paciente ya se encuentra Redireccionado";    }    // En caso de que no exista error se crear registro en hce_000022    if ( $arrResult["error"] !== true ){         // Crear registro para reasignar el paciente a otro médico. Tabla hce_000022	     $q = "INSERT INTO ".$basedatoshce."_000022 						(Medico,Fecha_data,Hora_data,Mtrhis,Mtring,Mtrcci,Mtrmed,Mtrest,Mtrtra,Mtretr,Mtrcur,Seguridad)					VALUES 						('HCE','".$fecha."','".$hora."','".$paciente."','".$ingreso."','".$cco."','','on','off','','off','C-".$seguridad."')";					 $res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		 $num_affect = mysql_affected_rows();				 if( $num_affect>0 ){			//Guardo LOG de garabación en tabla hce_000022			$q = "	INSERT INTO log_agenda 									  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 							   VALUES									  ('".$fecha."', '".$hora."', '".$paciente."', '".$ingreso."', 'Grabacion tabla hce_000022', '".$seguridad."', 'Auto')";			$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		 }		 $arrResult["message"] = 'El paciente ha sido redireccionado';    }    echo json_encode($arrResult);    return;}// Borra los registros del paciente para que su ingreso pueda ser reasignadofunction reasignarPacienteUrgencias($basedatos,$basedatoshce,$cco,$paciente,$ingreso,$wemp_pmla,$seguridad){	global $conex; 		// Cosulto si el paciente está en agenda urgencias	$qtra = "	SELECT Ubihis 				FROM ".$basedatos."_000018, ".$basedatoshce."_000022  				WHERE Ubihis = '".$paciente."' 				AND Ubiing = '".$ingreso."'				AND Ubisac = '".$cco."'				AND Ubihis = Mtrhis  				AND Ubiing = Mtring 				AND Mtrfco <> '0000-00-00'				AND Mtrfco <> '' ";	$restra = mysql_query($qtra, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qtra . " - " . mysql_error());	$numtra = mysql_num_rows($restra);	if($numtra==0) 	{				// 2013-02-22		// Cosulto si el paciente tiene registros de movimiento hospitalario		$qeyr = " SELECT Eyrhis					FROM ".$basedatos."_000017				   WHERE Eyrhis = '".$paciente."'					 AND Eyring = '".$ingreso."'					 AND Eyrest = 'on'";		$reseyr = mysql_query($qeyr, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qeyr . " - " . mysql_error());		$numeyr = mysql_num_rows($reseyr);		// Si el paciente no ha tenido movimiento hospitalario si se puede reasignar la historia		if($numeyr==0)		{			$fechaLog = date('Y-m-d');			$horaLog = date('H:i:s');			// Borra registro en tabla 16 de Movhos			$q = "	DELETE FROM ".$basedatos."_000016 					WHERE Inghis = '".$paciente."'					AND	Inging = '".$ingreso."'";			$res1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());			$num_affect = mysql_affected_rows();			if($num_affect>0)			{				//Guardo LOG de borrado en tabla Movhos 16				$q = "	INSERT INTO log_agenda 										  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 								   VALUES										  ('".$fechaLog."', '".$horaLog."', '".$paciente."', '".$ingreso."', 'Borrado tabla movhos_000016', '".$seguridad."', 'Reasignacion paciente')";				$resl1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());			}			// Borra registro en tabla 18 de Movhos			$q = "	DELETE FROM ".$basedatos."_000018 					WHERE Ubihis = '".$paciente."'					AND	Ubiing = '".$ingreso."'";			$res2 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());			$num_affect = mysql_affected_rows();			if($num_affect>0)			{				//Guardo LOG de borrado en tabla Movhos 18 				$q = "	INSERT INTO log_agenda 										  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 								   VALUES										  ('".$fechaLog."', '".$horaLog."', '".$paciente."', '".$ingreso."', 'Borrado tabla movhos_000018', '".$seguridad."', 'Reasignacion paciente')";				$resl2 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());			}			// Borra registro de la tabla 37 de Root			$q = "	DELETE FROM	root_000037 					WHERE Orihis = '".$paciente."'					AND	Oriing = '".$ingreso."' 					AND	Oriori = '".$wemp_pmla."'";			$res2 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());			$num_affect = mysql_affected_rows();			if($num_affect>0)			{				//Guardo LOG de borrado en tabla Root 37 				$q = "	INSERT INTO log_agenda 										  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 								   VALUES										  ('".$fechaLog."', '".$horaLog."', '".$paciente."', '".$ingreso."', 'Borrado tabla root_000037', '".$seguridad."', 'Reasignacion paciente')";				$resl2 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());			}			// Borra registro de egreso en la tabla 33 de Movhos			$q = "	DELETE FROM	".$basedatos."_000033 					WHERE Historia_clinica = '".$paciente."'					AND	Num_ingreso = '".$ingreso."'";			$res2 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());			$num_affect = mysql_affected_rows();			if($num_affect>0)			{				//Guardo LOG de borrado en tabla Movhos 33 				$q = "	INSERT INTO log_agenda 										  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 								   VALUES										  ('".$fechaLog."', '".$horaLog."', '".$paciente."', '".$ingreso."', 'Borrado tabla movhos_000033', '".$seguridad."', 'Reasignacion paciente')";				$resl2 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());			}			// Borra registro en tabla 22 de Hce			$q = "	DELETE FROM ".$basedatoshce."_000022 					WHERE Mtrhis = '".$paciente."'					AND	Mtring = '".$ingreso."'";			$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());						$num_affect = mysql_affected_rows();			if($num_affect>0)			{				//Guardo LOG de borrado en tabla Hce 22 				$q = "	INSERT INTO log_agenda 										  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera) 								   VALUES										  ('".$fechaLog."', '".$horaLog."', '".$paciente."', '".$ingreso."', 'Borrado tabla hce_000022', '".$seguridad."', 'Reasignacion paciente')";				$resl2 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());			}						if($res1)				return "ok";			else				return "Ocurrió un error en el proceso. \n Error: ".$res1;		}	} 	else			{		return "no-reasignar";	}}/********************************************************************************* CONSULTA EN UNIX LOS PACIENTES QUE NO ESTAN EN URGENCIAS Y LOS DA DE ALTA		**********************************************************************************/function actualizarAltaPacientesUnix($basedatos,$basedatoshce,$cco,$servicio,$wemp_pmla,$seguridad,$listados){	global $conex;	global $conexUnix;			$ayer = date("Y-m-d",time()-86400);	// Se consultan los pacientes activos en Unix	$qact = "SELECT pachis, pacnum			   FROM inpac			  WHERE pacser = '".$servicio."' ";		//	   , insercco,outer inemp			// 2012-01-24		//	    AND serccoser = pacser			// 2012-01-24		//		AND paccer = empcod";			// 2013-01-24		//  	AND pacfec >= '".$ayer."'";		// 2011-10-27	$rs_act = odbc_do($conexUnix,$qact);	$k = 0;	$listados_unix = array();	// Se asigna la lista de pacientes de urgencias en Unix	while (odbc_fetch_row($rs_act))	{		$listados_unix[$k] = odbc_result($rs_act,1)."-".odbc_result($rs_act,2);		$k++;	}	// Se obtiene los registros que estan en lista de pacientes activos en el programa	// pero ya no están como pacientes de urgencias en Unix	$altas_unix = array_diff($listados,$listados_unix);	$conting=0;	// Se da de alta los pacientes que no estan en urgencias de Unix	foreach ($altas_unix as $j => $value)	{		if(isset($altas_unix[$j]) && $altas_unix[$j]!="")		{			$paciente_alta = explode("-",$altas_unix[$j]);			$historia_paciente = $paciente_alta[0];			$ingreso_paciente = $paciente_alta[1];;			//echo "<br>ALTA: ".$altas_unix[$j];			altaPacienteUrgencias($basedatos,$basedatoshce,$cco,$servicio,$historia_paciente,$ingreso_paciente,$wemp_pmla,"Movhos","auto");			$conting++;		}	}	}/********************************************************************************************* CONSULTA EN UNIX LOS PACIENTES EN URGENCIAS Y ACTUALIZA EL LISTADO DE PACIENTES ACTIVOS 	*********************************************************************************************/function actualizarPacientesUnix($basedatos,$basedatoshce,$cco,$servicio,$wemp_pmla,$seguridad,$listados){	global $conex; 	global $conexUnix;		if($conexUnix)	{				// Se llama a la funcion para dar de alta a los pacientes que no están en urgencias de Unix		actualizarAltaPacientesUnix($basedatos,$basedatoshce,$cco,$servicio,$wemp_pmla,$seguridad,$listados);				$ayer = date("Y-m-d",time()-86400);		// Se consultan los pacientes activos en urgencias de Unix		$qact = "SELECT pachis, pacnum, pacced, pactid				   FROM inpac				  WHERE pacser = '".$servicio."' ";			//	   , insercco,outer inemp			// 2012-01-24			//	    AND serccoser = pacser			// 2012-01-24			//	    AND paccer = empcod";			// 2012-01-24			//		AND pacfec >= '".$ayer."'";		// 2011-10-27		$rs_act = odbc_do($conexUnix,$qact);		$conting = 0;		// Ciclo para actualizar el listado de pacientes activos en urgencias		while (odbc_fetch_row($rs_act))		{			$historia_paciente = odbc_result($rs_act,1);			$ingreso_paciente = odbc_result($rs_act,2);			$paciente_unix = $historia_paciente."-".$ingreso_paciente;						// Si la historia clínica obtenida de Unix no está en listado de pacientes, ingrésala.			if (!in_array($paciente_unix,$listados))			{				//echo "<br>INGRESO: ".$paciente_unix;				ingresarPacientesUrgencias($basedatos,$basedatoshce,$cco,$historia_paciente,$servicio,$wemp_pmla,$seguridad);				$conting++;			}		}	}}/*********************************************************************************** LISTADO DE PACIENTES INGRESADOS  *******************************************************************************************/				function agendaPacientesUrgencias($basedatos,$basedatoshce,$basedatoscliame,$cco,$wemp_pmla,$wserviciourl,$seguridad,$servicio,$wesp, $wcit, $wservicio){// Validación de usuarioif (!isset($user)){	if (!isset($_SESSION['user'])) 	{		session_register("user");	}	$user="";}//Codigo de usuario que ingreso al sistemaif (strpos($user, "-") > 0)	$wuser = substr($user, (strpos($user, "-") + 1), strlen($user));else	$wuser = "";$usuario = new Usuario();$usuario->codigo = $wuser;//Variable para determinar la empresaif(!isset($wemp_pmla)){	terminarEjecucion($MSJ_ERROR_FALTA_PARAMETRO."wemp_pmla");}//Valida codigo de usuario en sesion si no esta registrado el sistema termina la ejecucionif (!isset($_SESSION['user']) || !isset($seguridad) || $seguridad==""){	terminarEjecucion("<div align='center'>Usuario no autenticado.  Por favor cierre esta ventana y vuelva a ingresar a Matrix.</div>");} else {	global $conex; 		global $wprounificado;	global $wformularios;	// Consulta de pacientes activos en la unidad	$q = "SELECT DISTINCT a.Fecha_data fing, a.Hora_data hing, Ubihis, Pactid, Pacced, 	             Pacno1, Pacno2, Pacap1, Pacap2, Ingres, Ingnre, Ubiing	      FROM ".$basedatos."_000018 a				Inner Join  ".$basedatos."_000016 b				        on  a.Ubihis = b.Inghis 				        and a.Ubiing = b.Inging				Inner Join  root_000037 c				        on  a.Ubihis = c.Orihis				Inner Join  root_000036 d				        on  c.Oriced = d.Pacced				        and c.Oritid = d.Pactid				  WHERE Ubisac = '".$cco."' 				AND Oriori = '".$wemp_pmla."'				AND a.Ubimue != 'on' 				AND a.Ubiald != 'on' 		  GROUP BY Ubihis		  ORDER BY fing DESC, hing DESC";	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	$num = mysql_num_rows($res);	$row = mysql_fetch_array($res);	$listados = array();	$i=0;	while ($i<$num)	{		// Arreglo para guardar las historias de los pacientes activos en urgencias		$listados[$i] = $row['Ubihis']."-".$row['Ubiing']; 		// Arreglo para guardar los ingresos de los pacientes activos en urgencias		//$listadosing[$i] = $row['Ubiing']; 		$i++;		$row = mysql_fetch_array($res);	}	// Trae desde Unix todos los pacientes activos que deben ser ingresados a Matrix	// 2013-03-21	// Se comenta porque el script "hce/procesos/agenda_urgecias_por_especialidad.php" será el úico encargado	// de hacer esta actualización de pacientes desde Unix, ya que en este es donde se realizará todas las válidaciones	// y cambios que se deban hacer en esta funcion	// actualizarPacientesUnix($basedatos,$basedatoshce,$cco,$servicio,$wemp_pmla,$seguridad,$listados);		/**********************************************************************************	 ******* INICIA SECCIÓN DEL LISTADO DE PACIENTES ACTIVOS HOY **********************	 *********************************************************************************/	// Consulta de pacientes activos en la unidad					//2016-03-02 Se agrega una validación que inicialmente se usa para fisitatria	//Si llega el parametro $wcit quiere decir que se debe buscar sólo los que tengan cita el día de hoy	//	if(isset($wcit) && $wcit != ""){				//Con el parametro se consulta el prefijo de tabla de citas y el número		$arrInfoTabla = consultarPrefijoNumeroTabla($wcit, $wemp_pmla, $conex);				if(isset($arrInfoTabla["nombreTabla"]) && count($arrInfoTabla["nombreTabla"]) >= 1){				    $fecha = date("Y-m-d");			$countTablas = count($arrInfoTabla["nombreTabla"]);			if($countTablas > 1){				$q = "";								for($i=0; $i<$countTablas; $i++){					$q .= "SELECT DISTINCT 						a.Fecha_data fing, a.Hora_data hing, Ubihis, Pactid, Pacced, Pacno1, Pacno2, Pacap1, Pacap2, Ingres, Ingnre, Ubiing, b.Fecha_data fingb						, b.Hora_data hingb, Ubisac 					FROM 						movhos_000018 a, movhos_000016, root_000036, root_000037, hce_000022 b , ".$arrInfoTabla["prefijo"] . "_" . $arrInfoTabla["nombreTabla"][$i]." c					WHERE 						Ubisac       = '".$cco."' 						AND Ubimue   != 'on' 						AND Ubiald   != 'on' 						AND Ubihis   = Inghis 						AND Ubiing   = Inging 						AND Ubihis   = Orihis 						AND Oriori   = '".$wemp_pmla."'						AND Oriced   = Pacced 						AND Oritid   = Pactid 						AND Ubihis   = Mtrhis 						AND Ubiing   = Mtring 						AND c.Cedula = Pacced						AND c.Fecha  = '".$fecha."'					GROUP BY Ubihis  														";										$can = $i+1;					if($arrInfoTabla["nombreTabla"][$can] != ""){						$q.= " UNION ";					}									}								$q.= " ORDER BY fing DESC, hing DESC";										}else{				$q = "SELECT DISTINCT 						a.Fecha_data fing, a.Hora_data hing, Ubihis, Pactid, Pacced, Pacno1, Pacno2, Pacap1, Pacap2, Ingres, Ingnre, Ubiing, b.Fecha_data fingb						, b.Hora_data hingb, Ubisac 					FROM 						movhos_000018 a, movhos_000016, root_000036, root_000037, hce_000022 b , ".$arrInfoTabla["prefijo"] . "_" . $arrInfoTabla["nombreTabla"][0]." c					WHERE 						Ubisac       = '".$cco."' 						AND Ubimue   != 'on' 						AND Ubiald   != 'on' 						AND Ubihis   = Inghis 						AND Ubiing   = Inging 						AND Ubihis   = Orihis 						AND Oriori   = '".$wemp_pmla."'						AND Oriced   = Pacced 						AND Oritid   = Pactid 						AND Ubihis   = Mtrhis 						AND Ubiing   = Mtring 						AND c.Cedula = Pacced						AND c.Fecha  = '".$fecha."'					GROUP BY Ubihis ORDER BY fing DESC, hing DESC				";			}			}else{			$q = "";		}			}else{		//Query por defecto es decir si no viene el parámetro $wcit para buscar asociado con la tabla de citas está es la consulta			$q = "SELECT DISTINCT			m18.Fecha_data fing, m18.Hora_data hing, Ubihis, Pactid, Pacced, Pacno1, Pacno2, Pacap1, Pacap2, Ingres, Ingnre, Ubiing, h22.Fecha_data fingb, h22.Hora_data hingb, Ubisac, Mtrmed, Mtrcur, Condes, Conadm, Conalt, Conmue			FROM ".$basedatos."_000018 m18				Inner Join ".$basedatos."_000016 m16				        on 	Ubihis = Inghis  						And Ubiing = Inging						And Ubisac = '".$cco."'						And Ubimue != 'on' 						And Ubiald != 'on'  				Inner Join root_000037 r37					    on  Ubihis = Orihis						And Oriori = '".$wemp_pmla."'						   				Inner Join root_000036 r36				        on  Oriced = Pacced						And Oritid = Pactid						    					   				Inner Join ".$basedatoshce."_000022 h22 				        on  Ubihis = Mtrhis  						And Ubiing = Mtring				Left Join ".$basedatoshce."_000035  h35				       on   Mtrcon = Concod			Order By fing DESC, hing DESC, hingb ";	}	if($q != ""){		$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		$num = mysql_num_rows($res);	}else{		$num = 0;	}			if ($num > 0)	{		$row = mysql_fetch_array($res);		$i=1;		$wtipo_asignacion = "medico"; //Controla el tipo de asignacion, por especialidad o por medico.				echo "<table border=0 cellspacing=2 cellpadding=0 align=center>"; 		//Titulo lista de pacientes		echo "<tr class='fila1'>";		echo "<td colspan=12 align='center'><strong> &nbsp; PACIENTES ACTIVOS &nbsp; </strong></td>";		echo "</tr>";		echo "<tr>";		echo "<td colspan=8>&nbsp;</td>";		echo "</tr>";		if($num>0) {			echo "<tr>";			echo "<td colspan='8' class='textoMedio'><strong>N&uacute;mero de pacientes: ".$num."</strong></td>";			echo "</tr>";		}		//Encabezado lista de pacientes		echo "<tr class='encabezadoTabla'>";		echo "<td align=center>&nbsp;Fecha Ing.&nbsp;<br>&nbsp;Unix&nbsp;</td>";		echo "<td align=center>&nbsp;Hora Ing.&nbsp;<br>&nbsp;Unix&nbsp;</td>";		echo "<td align=center>&nbsp;Historia&nbsp;</td>";		echo "<td align=center>&nbsp;Identificaci&oacute;n</td>";		echo "<td align=center>&nbsp;Paciente&nbsp;</td>";		if(isset($wesp) and $wesp != ''){			$wtipo_asignacion = "especialidad";			echo "<td align=center>&nbsp;Especialidad&nbsp;</td>";		}else{			echo "<td align=center>&nbsp;M&eacute;dico&nbsp;</td>";		}		echo "<td align=center>&nbsp;Conducta&nbsp;</td>";		echo "<td align=center>&nbsp;Afinidad&nbsp;</td>";        		if ( strpos($wprounificado,$wserviciourl) !== false ){		   echo "<td align=center>&nbsp;Agenda&nbsp;<br>&nbsp;M&uacute;ltiple&nbsp;</td>";			   echo "<td align=center>&nbsp;Cargos&nbsp;<br>&nbsp;Facturaci&oacute;n&nbsp;</td>";		}				echo "<td align=center>&nbsp;alta&nbsp;</td>";		echo "<td align=center>&nbsp;Muerte&nbsp;</td>";				echo "</tr>";			 		$medicos = consultarMedicos($basedatos,$servicio);		$cantidadMedicos = count($medicos);				//Si en la url viene la variable de especialidad se crea un arreglo con esos valores y seran las que se muestren en la pantalla.		if(isset($wesp) and $wesp != ''){						$wespecialidades = explode("-",$wesp);			$array_especialidades = implode("','",$wespecialidades);			$q_esp =   " SELECT Espcod, Espnom"					 . "   FROM ".$basedatos."_000044 "					 . "  WHERE Espcod in ('".$array_especialidades."') ";			$res_esp = mysql_query($q_esp, $conex) or die ("Error: ".mysql_errno()." - en el query: ".$q_esp." - ".mysql_error());						$array_especialidades = array();						while($row_esp = mysql_fetch_assoc($res_esp)){								if(!array_key_exists($row_esp['Espcod'], $array_especialidades)){										$array_especialidades[$row_esp['Espcod']] = $row_esp;				}							}					}							//Ciclo para recorrer todos los registros de la consulta		while ($i<=$num)		{			if (is_int ($i/2))			   $wcf="fila1"; 			else			   $wcf="fila2";			// Variable que me define si inactivo o no el select de médico y los checkbox de alta y muerte			$inacselect = '';			$inacselectalt = '';			$inacselectmue = '';			 			if($wtipo_asignacion == 'especialidad'){								// Consulto si el paciente tiene especialidad asociada								$qmtr =	 " SELECT Mtrhis, Mtring, Mtrcur, Meduma, Medno1, Medno2, Medap1, Medap2, Mtreme " 						."   FROM ".$basedatoshce."_000022, ".$basedatos."_000048 "						."  WHERE Mtrhis = '".$row['Ubihis']."' "						."    AND Mtring = '".$row['Ubiing']."' "												."    AND Mtreme = Medesp "						."    AND Medseu LIKE '%".$servicio."%' "						."    AND Medest = 'on' ";				$resmtr = mysql_query($qmtr, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qmtr . " - " . mysql_error());							}else{                 				// Consulto si el paciente tiene médico tratante asociado				$qmtr =	 " SELECT Mtrhis, Mtring, Mtrcur, Meduma, Medno1, Medno2, Medap1, Medap2, Mtreme, Mtrmed " 						."   FROM ".$basedatoshce."_000022, ".$basedatos."_000048 "						."  WHERE Mtrhis = '".$row['Ubihis']."' "						."    AND Mtring = '".$row['Ubiing']."' "						."    AND Mtrmed != '' "						."    AND Mtrmed != 'NO APLICA' "						."    AND Mtrmed = Meduma "						."    AND Medseu LIKE '%".$servicio."%' "						."    AND Medest = 'on' ";				$resmtr = mysql_query($qmtr, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qmtr . " - " . mysql_error());														}						$rowmtr = mysql_fetch_array($resmtr);			// Si Mtrcur en on el paciente está siendo atendido, inactivo fila			if($rowmtr['Mtrcur'] && $rowmtr['Mtrcur']=='on') 			{				$wcf = 'fondoAmarillo';				$inacselect = ' disabled';				$inacselectalt = ' disabled';				$inacselectmue = ' disabled';			}			// Consulto si el paciente tiene conducta asociada			if ( strpos($wprounificado,$wserviciourl) !== false ){				$qcon =	 " SELECT Condes, Conadm, Conalt, Conmue " 						." FROM ".$basedatoshce."_000022, ".$basedatoshce."_000035 "						." WHERE Mtrhis = '".$row['Ubihis']."' "						." AND Mtring = '".$row['Ubiing']."' "						." AND Mtrmed = '".$row['Mtrmed']."' "						." AND Mtrcon = Concod ";			}else{				 $qcon =	 " SELECT Condes, Conadm, Conalt, Conmue " 					." FROM ".$basedatoshce."_000022, ".$basedatoshce."_000035 "					." WHERE Mtrhis = '".$row['Ubihis']."' "					." AND Mtring = '".$row['Ubiing']."' "					." AND Mtrcon = Concod ";			}			$rescon = mysql_query($qcon, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qcon . " - " . mysql_error());			$rowcon = mysql_fetch_array($rescon);						// Si tiene condcuta que no sea de admisión, inactivo fila			if($rowcon['Condes'] && $rowcon['Condes']!='' && $rowcon['Conadm']!='on') 			{				$wcf = 'fondoAmarillo';				$inacselect = ' disabled';				$inacselectalt = ' disabled';				$inacselectmue = ' disabled';			}			else			{				if($rowcon['Conalt']=='on')				{					$inacselectmue = ' disabled';					$inacselect = ' disabled';				}				if($rowcon['Conmue']=='on')				{					$inacselectalt = ' disabled';					$inacselect = ' disabled';				}			}						$auxres = explode('-',$row['Ingres']);			//Se imprime los valores de cada fila			echo "<tr class=".$wcf.">";			echo "<td align=left>&nbsp;".$row['fing']."&nbsp;</td>";			echo "<td align=left>&nbsp;".$row['hing']."&nbsp;</td>";			echo "<td align=left>";			echo "<span id='wide".$i."' data-html='true' title='Responsable: <br />".$row['Ingnre']." <br />Cod. ".$row['Ingres']."'>";			echo "&nbsp;".$row['Ubihis']." - ".$row['Ubiing']."&nbsp;";			echo "</span></td>";			$longitud =strlen(trim($row['Mtrmed']));			echo "<td align=left>&nbsp;".$row['Pactid']." - ".$row['Pacced']."&nbsp;</td>";			echo "<td align=left>&nbsp;".$row['Pacno1']." ".$row['Pacno2']." ".$row['Pacap1']." ".$row['Pacap2']."&nbsp;</td>";					if(isset($wesp) and $wesp != ''){							$wtipo_asignacion = "especialidad";						// Columna de especialidad			echo "<td align=left>";			echo "<select name='wmedico".$i."' id='wmedico".$i."' onchange='asignarMedico(".$i.", \"".$wtipo_asignacion."\" )' ".$inacselect.">";			echo "<option value='0'> -- seleccione -- </option>";						foreach ($array_especialidades as $key_esp => $value_esp)			{												if($key_esp == $rowmtr['Mtreme'])					echo "<option value=".$key_esp." selected>".$value_esp['Espnom']."</option>";								else					echo "<option value=".$key_esp.">".$value_esp['Espnom']."</option>";								}			"</select>";						echo "<input type='hidden' name='wpaciente".$i."' id='wpaciente".$i."' value='".$row['Ubihis']."'>";			echo "<input type='hidden' name='wingreso".$i."' id='wingreso".$i."' value='".$row['Ubiing']."'>";			echo "<input type='hidden' name='wservicio".$i."' id='wservicio".$i."' value='".$row['Ubisac']."'>";			echo "</td>";					}else{			$tdalta   ='';			$tdhabalta='';			$numFirma =0;			$numCargos=0;			//Consultar si el ingreso se encuentra Firmado            $sqlFirma = " SELECT Firfir" 					." FROM ".$basedatoshce."_000036 "					." WHERE Firhis = '".$row['Ubihis']."' "					."   AND Firing = '".$row['Ubiing']."' "					."   AND Firusu = '".$row['Mtrmed']."' "					."   AND Firpro in (".($wformularios).")";					   			$resFirma = mysql_query($sqlFirma, $conex);			$numFirma = mysql_num_rows($resFirma);     		//Consultar si posee cargos diligencados			$sqlCargos = " SELECT Tcarhis" 					." FROM ".$basedatoscliame."_000106 " 					." WHERE Tcarhis = '".$row['Ubihis']."' "					."   AND Tcaring = '".$row['Ubiing']."' ";					   			$resCargos = mysql_query($sqlCargos, $conex);			$numCargos = mysql_num_rows($resCargos);					// Columna de médico						$sqlMed = "SELECT  ingmei FROM ".$basedatoscliame."_000101					   WHERE Inghis = '".$row['Ubihis']."' 					   AND Ingnin = '".$row['Ubiing']."' ";					   			$resMed = mysql_query($sqlMed, $conex);			$rowMed = mysql_fetch_assoc($resMed);						echo "<td align=left>";									echo "<select name='wmedico".$i."' id='wmedico".$i."' style='width:300px;' onchange='asignarMedico(".$i.", \"".$wtipo_asignacion."\")'".$inacselect.">";			echo "<option value='0'> -- Seleccione -- </option>";            //Columna para mostrar el Medico, este campo debe estar diligenciado en la tabla hce_000022, en caso de            //que no, deberá traerse de cliame_000101 y actualizarlo mediante la función 'asignarMedicoUrgencias'.			if ($row['Mtrmed'] && $row['Mtrmed'] != ''){				foreach ($medicos as $medico)				{					if(trim($medico->codigo) == trim($row['Mtrmed'])) 						echo "<option value=".$medico->codigo." selected>".trim($medico->nombre)."</option>";					else						echo "<option value=".$medico->codigo.">".trim($medico->nombre)."</option>";				}		    }else{		    	foreach ($medicos as $medico)				{					                    //30-05-2018- Se desactiva la consulta del medico desde la admisión a solicitud                    //de CityPlaza                    /*if( ( isset($rowMed["ingmei"]) &&  $rowMed["ingmei"] == $medico->cedula) ){												echo "<option value=".$medico->codigo." selected>".trim($medico->nombre)."</option>";												//Actualizo el campo Mtrmed,Mtreme,Mtretr en hce_000022									//asignarMedicoUrgencias($basedatos,$basedatoshce,$medico->codigo,$row['Ubihis'],$row['Ubiing'],$servicio,$seguridad,'medico',$wserviciourl);                    }					else*/					echo "<option value=".$medico->codigo.">".trim($medico->nombre)."</option>";				}		    }			"</select>";			echo "<input type='hidden' name='wpaciente".$i."' id='wpaciente".$i."' value='".$row['Ubihis']."'>";			echo "<input type='hidden' name='wingreso".$i."' id='wingreso".$i."' value='".$row['Ubiing']."'>";			echo "<input type='hidden' name='wservicio".$i."' id='wservicio".$i."' value='".$row['Ubisac']."'>";			echo "</td>";			}						// Columna de conducta			echo "<td align=left>";			if($row['Condes'] && $row['Condes'] != '') 				echo "<input type='text' name='wconducta".$i."' id='wconducta".$i."' style='text-align: center; font-weight: bold;' size='20' value='".$row['Condes']."' readonly>";			elseif($row['Mtrcur'] && $row['Mtrcur']=='on') 				echo "<input type='text' name='wconducta".$i."' id='wconducta".$i."' style='text-align: center; font-weight: bold;' size='20' value='En consulta' readonly>";			else				echo "<input type='text' name='wconducta".$i."' id='wconducta".$i."' style='text-align: center' size='26' value=' -- sin asignar -- ' readonly>";			echo "</td>";			// Columna de afinidad			// En este procedimiento pregunto si el paciente es cliente AFIN o no, y de que tipo			$wafin = clienteMagenta($row['Pacced'],$row['Pactid'],$wtpa,$wcolorpac);			if ($wafin)				echo "<td align=center><font color=".$wcolorpac."><b>".$wtpa."<b></font></td>";			else			    echo "<td> &nbsp; </td>";            //Validar que tenga médico y conducta diligenciado			$inaredirec = 'disabled';			if ($row['Mtrmed'] != '' && $row['Conalt']=='on')                $inaredirec = '';            //Verificar estado de Alta y médido diligenciado, sin firma ni cargo.		                        $tdalta    ='';            $inacalta  ='';            $tdcargo   ='';            $inacargos ='';            if (isset($wserviciourl) && ( strpos($wprounificado,$wserviciourl) !== false ) ){	            	            //Verificar que tenga Medico, conducta de Alta y Cargos pendientes para indicar en color rosado, 	            //que debe ser dado de Alta.	            if ( $row['Mtrmed'] != '' and ($row['Conalt']=='on') and ($numFirma==0 or $numCargos==0)){ 	            	 $tdalta   = "class = 'tdalta' ";	            	 $inacalta ='disabled';	            }	            if ( $row['Mtrmed'] != '' and ($row['Condes']=='')){	            	 $inacalta  ='disabled';                     $inacargos ='disabled';	            }	            //Verificar estado de Alta para activar y mostrar en verde (sifnifica que ya está listo para colocar Alta)	            if ( $row['Mtrmed'] != '' and ($row['Conalt']=='on') and ($numFirma>0) and ($numCargos>0) ){	            	 $tdalta   = "class = 'tdhabalta' ";	            	 $inacalta = '';	            	 $tdcargo  = "class = 'tdhabalta' ";	            }            }            if (isset($wserviciourl) && (strpos($wprounificado,$wserviciourl) !== false) ){                echo "<td align=center>&nbsp;<input type='radio' name='redirec".$i."' id='redirec".$i."' onclick='asignarAgendaMultiple(".$i.");' value='".$row['Ubihis']."'".$inaredirec." >&nbsp;</td>";			    echo "<td align=center>&nbsp;<input type='radio' onclick='abrirVentanaCargos(".$i.");' name='cargos".$i."' id='cargos".$i."' value='".$row['Ubihis']."'".$inacargos.">&nbsp;</td>";            }			echo "<td align=center ".$tdalta.">&nbsp;<input type='checkbox' onclick='altaPaciente(".$i.");' name='alta".$i."' id='alta".$i."' value='".$row['Ubihis']."'".$inacalta.">&nbsp;</td>";			echo "<td align=center>&nbsp;<input type='checkbox' onclick='muertePaciente(".$i.");' name='muerte".$i."' id='muerte".$i."' value='".$row['Ubihis']."'".$inacselectmue.">&nbsp;</td>";			echo "</tr>";						//Obtengo la siguiente fila			$row = mysql_fetch_array($res);			$i++;		}		echo "</table>";	} 	else 	{		echo "<br /><p align='center'>No se encontraron pacientes activos</p><p>&nbsp;</p>";	}	echo "<p>&nbsp;</p>";			/*******************************************************************************************	 ******* INICIA SECCIÓN DE PACIENTES INACTIVOS DADOS DE ALTA EN LOS ÚLTIMOS 2 DÍAS *********	 *******************************************************************************************/	$ayer = date("Y-m-d",time()-86400);	$hoy = date("Y-m-d");	// Consulta de pacientes inactivos dados de alta en los últimos 2 días	$q = "  SELECT DISTINCT			m18.Fecha_data fing, m18.Hora_data hing, Ubihis, Pactid, Pacced, Pacno1, Pacno2, Pacap1, 			  Pacap2, Ingres, Ingnre, Ubiing, Ubimue, Ubifad, Ubihad, Ubiuad, Egrhis, Mtrmed, Meduma,			  Medno1, Medno2, Medap1, Medap2, Condes			From 				".$basedatos."_000018 m18			Inner Join ".$basedatos."_000016 m16		        on  m18.Ubihis = m16.Inghis  				and m18.Ubiing = m16.Inging					Inner Join root_000037 r37			    on m18.Ubihis = r37.Orihis			Inner Join root_000036 r36				    on  r37.Oriced = r36.Pacced				and r37.Oritid = r36.Pactid			Inner Join ".$basedatoshce."_000022 h22 			    on  m18.Ubihis = h22.Mtrhis  				and m18.Ubiing = h22.Mtring			Left Join ".$basedatos."_000048 m48		        on h22.Mtrmed = m48.Meduma 		        and m48.Meduma != ''				and m48.Medest = 'on' 			    Left Join ".$basedatoshce."_000035  h35				on  h22.Mtrcon = Concod				and h35.Conest = 'on'			Left Join ".$basedatoscliame."_000108 c108			    on  c108.Egrhis = m18.Ubihis			    and c108.Egring = m18.Ubiing	 			Where   Ubisac = '".$cco."' 				and Ubifad >= '".$ayer."' 				and Ubifad != '0000-00-00' 				and Ubiald = 'on' 				and Oriori = '".$wemp_pmla."'			Order By Ubifad DESC, Ubihad desc";		$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	$num = mysql_num_rows($res);	echo "<table border=0 cellspacing=2 cellpadding=0 align=center>"; 	//Titulo lista de pacientes	echo "<tr class='fila1'>";	echo "<td colspan=12 align='center'><strong> &nbsp; PACIENTES DADOS DE ALTA EN LOS &Uacute;LTIMOS 2 D&Iacute;AS &nbsp; </strong></td>";	echo "</tr>";	echo "<tr>";	echo "<td colspan=11>&nbsp;</td>";	echo "</tr>";	if($num>0) {		echo "<tr>";		echo "<td colspan='11' class='textoMedio'><strong>N&uacute;mero de pacientes: ".$num."</strong></td>";		echo "</tr>";	}	if ($num > 0) {		$row = mysql_fetch_array($res);		$auxi = $i;		$i=1;				//Encabezado lista de pacientes		echo "<tr class='encabezadoTabla'>";		echo "<td align=center>&nbsp;Fecha Ing.&nbsp;<br>&nbsp;Unix&nbsp;</td>";		echo "<td align=center>&nbsp;Hora Ing.&nbsp;<br>&nbsp;Unix&nbsp;</td>";		echo "<td align=center>&nbsp;Historia&nbsp;</td>";		echo "<td align=center>&nbsp;Identificaci&oacute;n</td>";		echo "<td align=center>&nbsp;Paciente&nbsp;</td>";		echo "<td align=center>&nbsp;M&eacute;dico&nbsp;</td>";		echo "<td align=center>&nbsp;Conducta&nbsp;</td>";		echo "<td align=center>&nbsp;Afinidad&nbsp;</td>";		echo "<td align=center>&nbsp;Activar&nbsp;</td>";		echo "<td align=center>&nbsp;Reasignar&nbsp;<br>&nbsp;Historia&nbsp;</td>";		if (isset($wserviciourl) && (strpos($wprounificado,$wserviciourl) !== false) ){			echo "<td align=center>&nbsp;Egreso&nbsp;</td>";			echo "<td align=center>&nbsp;Imprimir&nbsp;<br>&nbsp;&nbsp;HCE&nbsp;</td>";        }		echo "</tr>";			 		//Ciclo para recorrer todos los registros de la consulta		while ($i<=$num)		{			if (is_int ($i/2))			   $wcf="fila1";  // color de fondo de la fila			else			   $wcf="fila2"; // color de fondo de la fila			// 2018-04-17 -Se desactivar consulta en hce_000022 para medico y conducta 			// estas tablas se pueden relacionar desde el inicio con movhos_000018			// Consulto si el paciente tiene médico tratante asociado			/*$qmtr =	 " SELECT Mtrhis, Mtring, Meduma, Medno1, Medno2, Medap1, Medap2 " 					." FROM ".$basedatoshce."_000022, ".$basedatos."_000048 "					." WHERE Mtrhis = '".$row['Ubihis']."' "					." AND Mtring = '".$row['Ubiing']."' "					." AND Mtrmed != '' "					." AND Mtrmed != 'NO APLICA' "					." AND Mtrmed = Meduma "					." AND Medseu LIKE '%".$servicio."%' "					." AND Medest = 'on' ";			$resmtr = mysql_query($qmtr, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qmtr . " - " . mysql_error());			$rowmtr = mysql_fetch_array($resmtr);			// Consulto si el paciente tiene conducta asociada			$qcon =	 " SELECT Condes " 					." FROM ".$basedatoshce."_000022, ".$basedatoshce."_000035 "					." WHERE Mtrhis = '".$row['Ubihis']."' "					." AND Mtring = '".$row['Ubiing']."' "					." AND Mtrcon = Concod ";			$rescon = mysql_query($qcon, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qcon . " - " . mysql_error());			$rowcon = mysql_fetch_array($rescon);*/						// Consulto el usuario que dió de alta al paciente			$quad =	 " SELECT Codigo, Descripcion " 					." FROM usuarios "					." WHERE Codigo = '".$row['Ubiuad']."'";			$resuad = mysql_query($quad, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $quad . " - " . mysql_error());			$rowuad = mysql_fetch_array($resuad);			$auxres = explode('-',$row['Ingres']);			//Se imprime los valores de cada fila			echo "<tr class=".$wcf.">";			echo "<td align=left>&nbsp;".$row['fing']."&nbsp;</td>";			echo "<td align=left>&nbsp;".$row['hing']."&nbsp;</td>";			echo "<td align=left>";			echo "<span id='wide".$auxi."' data-html='true' title='Responsable: <br>".$row['Ingnre']." <br>Cod. ".$row['Ingres']."<br><br>Fecha alta: ".$row['Ubifad']." <br>Hora alta: ".$row['Ubihad']."<br>Di&oacute; de alta: ".$rowuad['Descripcion']."'>";			echo "&nbsp;".$row['Ubihis']." - ".$row['Ubiing']."&nbsp;";			echo "</span></td>";			echo "<td align=left>&nbsp;".$row['Pactid']." - ".$row['Pacced']."&nbsp;</td>";			echo "<td align=left>&nbsp;".$row['Pacno1']." ".$row['Pacno2']." ".$row['Pacap1']." ".$row['Pacap2']."&nbsp;</td>";			echo "<input type='hidden' name='wpaciente".$auxi."' id='wpaciente".$auxi."' value='".$row['Ubihis']."'>";			echo "<input type='hidden' name='wingreso".$auxi."' id='wingreso".$auxi."' value='".$row['Ubiing']."'>";			// Columna de médico			echo "<td align=left>&nbsp;".$row['Medno1']." ".$row['Medno2']." ".$row['Medap1']." ".$row['Medap2']."&nbsp;</td>";			// Columna de conducta			echo "<td align=center>&nbsp;".$row['Condes']."&nbsp;</td>";			// Columna de afinidad			// En este procedimiento pregunto si el paciente es cliente AFIN o no, y de que tipo			$wafin = clienteMagenta($row['Pacced'],$row['Pactid'],$wtpa,$wcolorpac);			if ($wafin)			 echo "<td align=center><font color=".$wcolorpac."><b>".$wtpa."<b></font></td>";			else			  echo "<td> &nbsp; </td>";			// Columna de reactivación de pacientes			echo "<td align=center>&nbsp;<input type='checkbox' onclick='activarPaciente(".$auxi.");' name='activar".$auxi."' id='activar".$auxi."' value='".$row['Ubihis']."'>&nbsp;</td>";			// Columna de reasignación de pacientes			$desacReasignar = '';			if($row['Ubiing']>1)				$desacReasignar = 'disabled';			//Validar la activación de la opción imprimir historia			$desacImprimir = '';			$desacEgreso = '';			if ($row['Egrhis'] == null)			    $desacImprimir = 'disabled';			else                $desacEgreso = 'disabled checked';			echo "<td align=center>&nbsp;<input type='checkbox' onclick='reasignarPaciente(".$auxi.");' name='reasignar".$auxi."' id='reasignar".$auxi."' value='".$row['Ubihis']."' ".$desacReasignar.">&nbsp;</td>";			if ( isset($wserviciourl) && (strpos($wprounificado,$wserviciourl) !== false ) ){				echo "<td align=center>&nbsp;<input type='radio' onclick='abrirVentanaEgreso(".$auxi.");' name='egresar".$auxi."' id='egresar".$auxi."' value='".$row['Ubihis']."' ".$desacEgreso.">&nbsp;</td>";				echo "<td align=center>&nbsp;<input type='radio' onclick='abrirVentanaImpresion(".$auxi.", \"".$row['Pacced']."\", \"".$row['Pactid']."\"  );' name='imprimir".$auxi."' id='imprimir".$auxi."' value='".$row['Ubihis']."' ". $desacImprimir.">&nbsp;</td>";		    }			echo "</tr>";						//Obtengo la siguiente fila			$row = mysql_fetch_array($res);			$i++; 			$auxi++;		}	} else {		echo "<tr>";		echo "<td colspan=8><p align='center'>No se encontraron pacientes dados de alta en los &uacute;ltimos 2 d&iacute;as</p></td>";		echo "</tr>";	}	echo "</table>";	  }		}//ANTES DE INSERTAR UNA ALTA O UNA MUERTE PARA UN PACIENTE SE CONSULTA SI YA TUVO ALTA O MUERTE Y SE ELIMINANfunction BorrarAltasMuertesAntesDeAgregarNueva($conex, $wbasedato, $whis, $wing, $bandera){	$user_session = explode('-',$_SESSION['user']);	$seguridad = $user_session[1];	$q = "	SELECT *			FROM ".$wbasedato."_000033			WHERE Historia_clinica = '".$whis."'			AND Num_ingreso = '".$wing."'			AND Tipo_egre_serv REGEXP 'MUERTE MAYOR A 48 HORAS|MUERTE MENOR A 48 HORAS|ALTA' ";	$res = mysql_query($q,$conex) or die ("Error: ".mysql_errno()." - en el query: ".$q." - ".mysql_error());	$num = mysql_num_rows($res);	$arregloDatos = array();	if ($num > 0) {		while($row = mysql_fetch_assoc($res))		{			$result = array();			$result['fecha'] = $row['Fecha_data'];			$result['cco'] = $row['Servicio'];			$result['egreso'] = $row['Tipo_egre_serv'];			array_push( $arregloDatos, $result );		}	}	if( count( $arregloDatos )  > 0 ) {		foreach( $arregloDatos as $dato )		{			$wfecha = $dato['fecha'];			$wcco = $dato['cco'];			$wtipoEgresoABorrar = $dato['egreso'];			$q = " SELECT * "				."   FROM ".$wbasedato."_000038 "				."  WHERE Fecha_data = '".$wfecha."'"				."    AND Cieser = '".$wcco."'";			$res = mysql_query($q,$conex) or die ("Error: ".mysql_errno()." - en el query: ".$q." - ".mysql_error());			$num = mysql_num_rows($res);			$row = mysql_fetch_assoc($res);			$existe_en_la_67 = false;			$q67 = " SELECT * "				."   FROM ".$wbasedato."_000067 "				."  WHERE Fecha_data = '".$wfecha."'"				."    AND Habhis = '".$whis."'"				."    AND Habing = '".$wing."'";			$res67 = mysql_query($q67,$conex) or die ("Error: ".mysql_errno()." - en el query: ".$q." - ".mysql_error());			$num67 = mysql_num_rows($res67);			if( $num67 > 0 ){				$existe_en_la_67 = true;			}			$cant_egresos = $row['Cieegr'];			$cant_camas_ocupadas = $row['Cieocu'];			$cant_camas_disponibles = $row['Ciedis'];			$muerteMayor = $row['Ciemmay'];			$muerteMenor = $row['Ciemmen'];			$egresosAlta = $row['Cieeal'];			//Restamos uno al motivo de egreso que tenia el paciente			if(preg_match('/ALTA/i',$wtipoEgresoABorrar)) {				$egresosAlta--;				$cant_egresos--;				if( $existe_en_la_67 === false ) {					$cant_camas_ocupadas++;					$cant_camas_disponibles--;				}			} else if(preg_match('/MAYOR/i',$wtipoEgresoABorrar)) {				//Muerte mayor				$muerteMayor--;				$cant_egresos--;				if( $existe_en_la_67 === false ) {					$cant_camas_ocupadas++;					$cant_camas_disponibles--;				}			} else if(preg_match('/MENOR/i',$wtipoEgresoABorrar)) { 				// Muerte menor				$muerteMenor--;				$cant_egresos--;				if( $existe_en_la_67 === false ) {					$cant_camas_ocupadas++;					$cant_camas_disponibles--;				}			}			$query_para_log = "	SELECT *				FROM ".$wbasedato."_000033				WHERE Historia_clinica = '".$whis."'				AND Num_ingreso = '".$wing."'				AND Tipo_egre_serv = '".$wtipoEgresoABorrar."'";			$registrosFila = obtenerRegistrosFila($query_para_log);			$q ="	DELETE FROM ".$wbasedato."_000033					 WHERE Historia_clinica = '".$whis."'					   AND Num_ingreso = '".$wing."'					   AND Tipo_egre_serv = '".$wtipoEgresoABorrar."'";			$res = mysql_query($q,$conex);			$num_affect = mysql_affected_rows();						if($num_affect>0) {				$q = " UPDATE ".$wbasedato."_000038 "					."    SET Ciemmay = '".$muerteMayor."',"					."  	  Ciemmen = '".$muerteMenor."',"					."  	  Cieeal = '".$egresosAlta."',"					."  	  Cieegr = '".$cant_egresos."',"					."  	  Cieocu = '".$cant_camas_ocupadas."',"					."  	  Ciedis = '".$cant_camas_disponibles."'"					."  WHERE Fecha_data = '".$wfecha."'"					."    AND Cieser = '".$wcco."'"					."  LIMIT 1 ";				$res = mysql_query($q,$conex) or die ("Error: ".mysql_errno()." - en el query: ".$q." - ".mysql_error());				//Guardo LOG de borrado en tabla movhos 33 - Activacion paciente				$q = "	INSERT INTO log_agenda										  (Fecha, Hora, Historia, Ingreso, Accion, Seguridad, Bandera, Registros)								   VALUES										  ('".date('Y-m-d')."', '".date('H:i:s')."', '".$whis."', '".$wing."', 'Borrado tabla movhos_000033', '".$seguridad."', '".$bandera."', '".$registrosFila."')";				$resl2 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());			}		}	}}// Retorna el código del centro de costo en Matrixfunction obtenerCcoMatrix($basedatos,$codCco,$wemp_pmla,$seguridad){	global $conex;	$cco = "";	$conex = obtenerConexionBD("matrix");	// Consulto si hay un código asociado en la tabla 11 de movhos	$qcco = "	SELECT Ccocod				  FROM ".$basedatos."_000011				 WHERE Ccoseu  = '".$codCco."'				   AND Ccoing = 'on'				   AND Ccoest = 'on'";	$rescco = mysql_query($qcco, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qcco . " - " . mysql_error());	$numcco = mysql_num_rows($rescco);		if($numcco>0) {		$rowcco = mysql_fetch_array($rescco);		$cco = $rowcco['Ccocod'];	}	return $cco;}// Actualiza los datos de los pacientes en clínicafunction actualizarDatosPacientes($basedatos,$wemp_pmla,$seguridad,$listados){	global $conex;	for($i=0;$i<count($listados);$i++)	{		$paciente = new pacienteDTO();		// Obtengo historia clínica e ingreso de paciente		$datos_paciente = explode("-",$listados[$i]);		$whistoria = $datos_paciente[0];		$wingreso = $datos_paciente[1];		$paciente->historiaClinica  = $whistoria;		$pacienteUnix = consultarPacienteUnix($paciente);  //Paciente Unix		if(isset($pacienteUnix->nombre1) && isset($pacienteUnix->ingresoHistoriaClinica)) {			// Consulta si existe el paciente en las tablas root_000036, root_000037			// Con base en histora y último ingreso			$pacienteMatrix = consultarInfoPacientePorHistoria($conex, $paciente->historiaClinica,$wemp_pmla);			$pacienteEnTablaUnica = false;	// Indica si tipo identificacion e identificación existen en tabla root_000036			$pacienteEnTablaIngresos = false;	// Indica si historia y origen existen en tabla root_000037			// En tabla root_000037 borro historia asociada en matrix a la cédula de unix			// siempre y cuando esta historia sea diferente a la asociada en Unix			borrarHistoriaDiferenteUnix($pacienteUnix, $wemp_pmla, $seguridad);			if(isset($pacienteMatrix->documentoIdentidad)) {				// Se comenta porque no es necesario usar las funciones que usan esta variable				// 2011-11-29				//if($pacienteMatrix->documentoIdentidad != $pacienteUnix->documentoIdentidad || $pacienteMatrix->tipoDocumentoIdentidad != //$pacienteUnix->tipoDocumentoIdentidad)				//{					//$mismoDocumentoIdentidad = false;				//}			} else {				$pacienteMatrix->historiaClinica = $whistoria;				$pacienteMatrix->ingresoHistoriaClinica = $pacienteUnix->ingresoHistoriaClinica;				$pacienteMatrix->documentoIdentidad = $pacienteUnix->documentoIdentidad;				$pacienteMatrix->tipoDocumentoIdentidad = $pacienteUnix->tipoDocumentoIdentidad;			}			// Consulto por historia y origen si existe en tabla root_000037			$pacienteEnTablaIngresos = existeEnTablaIngresos($pacienteUnix, $wemp_pmla);			// Consulto por tipo identificacion e identificación si existe en tabla root_000036			$pacienteEnTablaUnica = existeEnTablaUnicaPacientes($pacienteUnix);			//Ingreso de datos en tabla 36 de root			if(!$pacienteEnTablaUnica) {				insertarPacienteTablaUnica($pacienteUnix,$seguridad);			} else {				actualizarDatosPacienteTablaUnica($pacienteMatrix,$pacienteUnix);			}			//Ingreso de datos en tabla 37 de root			if(!$pacienteEnTablaIngresos) {				insertarIngresoPaciente($pacienteUnix, $wemp_pmla, $seguridad);			} else {				actualizarIngresoPaciente($pacienteMatrix, $pacienteUnix, $wemp_pmla);			}		}	}}// Ingresa un paciente a la lista de pacientes en urgenciasfunction ingresarPacientesUrgencias($basedatos,$basedatoshce,$cco,$whistoria,$servicio,$wemp_pmla,$seguridad){	global $conex; 		$institucion = consultarInstitucionPorCodigo($conex, $wemp_pmla);	$winstitucion = $institucion->nombre;	// Grabación de ingreso de paciente	$conex = obtenerConexionBD("matrix");	$paciente = new pacienteDTO();	$paciente->historiaClinica = $whistoria;	$pacienteUnix = consultarPacienteUnix($paciente,$servicio);  //Paciente Unix					if(isset($pacienteUnix->nombre1) && isset($pacienteUnix->ingresoHistoriaClinica)) {		// Consulta si existe el paciente en las tablas root_000036, root_000037 y movhos_000018		// Con base en histora e ingreso		$pacienteMatrix = consultarInfoPacientePorHistoria($conex, $paciente->historiaClinica);				$ingresoAnterior = "";				if(!$pacienteMatrix || !isset($pacienteMatrix->historiaClinica)) {			$pacienteMatrix = $pacienteUnix;		} else {			if(isset($pacienteMatrix->ingresoHistoriaClinica)) {				$ingresoAnterior = $pacienteMatrix->ingresoHistoriaClinica;			} else {				$pacienteMatrix->ingresoHistoriaClinica = $ingresoAnterior; 			}						if($pacienteUnix) {				// Si el ingreso encontrado en Matrix (movhos_000018) es menor 				if($pacienteMatrix->ingresoHistoriaClinica=="") {					$pacienteMatrix->ingresoHistoriaClinica = $pacienteUnix->ingresoHistoriaClinica;									} elseif($pacienteMatrix->ingresoHistoriaClinica < $pacienteUnix->ingresoHistoriaClinica) {										if(isset($pacienteMatrix->historiaClinica) && !empty($pacienteMatrix->historiaClinica))					{						// Consulto si el ingreso no tiene alta definitiva						$qalt = "	SELECT Ubiald   									FROM ".$basedatos."_000018 									WHERE Ubihis  = '".$pacienteMatrix->historiaClinica."' 									AND	  Ubiing = '".$pacienteMatrix->ingresoHistoriaClinica."'									AND	  Ubiald != 'on'";						$resalt = mysql_query($qalt, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qalt . " - " . mysql_error());						$numalt = mysql_num_rows($resalt);						// Define si le doy de alta o no 1=no tiene alta 0=tiene alta						// Si no tiene alta definitiva le doy de alta						if($numalt>0)							@altaPacienteUrgencias($basedatos,$basedatoshce,$cco,$servicio,$pacienteMatrix->historiaClinica,$pacienteMatrix->ingresoHistoriaClinica,$wemp_pmla,"Movhos","Ingreso");												$pacienteMatrix->ingresoHistoriaClinica = $pacienteUnix->ingresoHistoriaClinica;						//$pacienteMatrix->nombre1 = "";					}				} elseif((($pacienteMatrix->ingresoHistoriaClinica)*1) >= (($pacienteUnix->ingresoHistoriaClinica)*1)) {										if(isset($pacienteMatrix->historiaClinica) && !empty($pacienteMatrix->historiaClinica)) {						borraIngresosMayores($basedatos,$basedatoshce,$cco,$pacienteMatrix->historiaClinica,$pacienteUnix->ingresoHistoriaClinica,$wemp_pmla,"Movhos","BorradoIngresoMayor",$pacienteUnix->fechaIngreso,$pacienteUnix->horaIngreso);						$pacienteMatrix->ingresoHistoriaClinica = $pacienteUnix->ingresoHistoriaClinica;						//$pacienteMatrix->nombre1 = "";					}				}			}							}				// Si ya se encuentra admitido va a consultar la información		// La guia es la tabla 18, si esta ahi, YA SE CONSIDERA INGRESADO		if(!isset($pacienteMatrix->historiaClinica) || empty($pacienteMatrix->historiaClinica)) {			$pacienteMatrix->historiaClinica = $pacienteUnix->historiaClinica;		}				$pacienteConResponsablePaciente = false;	// Indica si historia e ingreso existen en tabla movhos_000016		// Consulto por historia e ingreso si existe en tabla movhos_000016		$pacienteConResponsablePaciente = existeEnTablaResponsables($pacienteUnix, $wemp_pmla);					//Ingreso de datos en tabla 16 de movhos		if(!$pacienteConResponsablePaciente) {			insertarResponsablePaciente($pacienteUnix, $wemp_pmla, $seguridad);		} else {			actualizarResponsablePaciente($pacienteMatrix, $pacienteUnix);		}				// Busca por historia e ingreso en la tabla movhos_000018 si existen registros		$pacienteIngresado = pacienteIngresado($pacienteMatrix);		// Busca por historia e ingreso en la tabla hce_000022 si existen registros		$pacienteIngresadoHce = pacienteIngresadoHce($pacienteMatrix);		if(!isset($pacienteMatrix->ingresoHistoriaClinica) or !$pacienteIngresado or !$pacienteIngresadoHce)		{			if(!isset($pacienteMatrix->ingresoHistoriaClinica) or !$pacienteIngresado)			{				$pacienteEnTablaUnica = false;	// Indica si tipo identificacion e identificación existen en tabla root_000036				$pacienteEnTablaIngresos = false;	// Indica si historia y origen existen en tabla root_000037								// Se comenta porque no es necesario usar las funciones que usan esta variable - 2011-11-29				//$mismoDocumentoIdentidad = true;	// Indica si paciente unix y paciente matrix tienen el mismo documento				// En tabla root_000037 borro historia asociada en matrix a la cédula de unix				// siempre y cuando esta historia sea diferente a la asociada en Unix				borrarHistoriaDiferenteUnix($pacienteUnix, $wemp_pmla, $seguridad);				// Si exite documento de identidad en matrix verifico que sea el mismo de Unix				if(isset($pacienteMatrix->documentoIdentidad)) {					// Se comenta porque no es necesario usar las funciones que usan esta variable					/* 2011-11-29					if($pacienteMatrix->documentoIdentidad != $pacienteUnix->documentoIdentidad || $pacienteMatrix->tipoDocumentoIdentidad != $pacienteUnix->tipoDocumentoIdentidad)					{						$mismoDocumentoIdentidad = false;					}					*/				} 				else {					$pacienteMatrix->historiaClinica = $whistoria;					$pacienteMatrix->ingresoHistoriaClinica = $pacienteUnix->ingresoHistoriaClinica;					$pacienteMatrix->documentoIdentidad = $pacienteUnix->documentoIdentidad;					$pacienteMatrix->tipoDocumentoIdentidad = $pacienteUnix->tipoDocumentoIdentidad;  				}				// Consulto por historia y origen si existe en tabla root_000037				$pacienteEnTablaIngresos = existeEnTablaIngresos($pacienteUnix, $wemp_pmla);				// Consulto por tipo identificacion e identificación si existe en tabla root_000036				$pacienteEnTablaUnica = existeEnTablaUnicaPacientes($pacienteUnix);															// Actualiza documento de identidad en tabla root_000037				// Se comenta porque la actuailzación de documento en tabla root_000037 se realiza en las siguientes funciones				/* 2011-11-29				if(!$mismoDocumentoIdentidad)					actualizarDocumentoPacienteTablaIngresos($pacienteMatrix,$pacienteUnix,$wemp_pmla);				*/				// Actualiza documento de identidad en tabla root_000036				// Se comenta porque la actuailzación de documento en tabla root_000036 se realiza en las siguientes funciones				/* 2011-11-29				if(!$mismoDocumentoIdentidad)					actualizarDocumentoPacienteTablaUnica($pacienteMatrix,$pacienteUnix);				*/								//Ingreso de datos en tabla 36 de root				if(!$pacienteEnTablaUnica) {					insertarPacienteTablaUnica($pacienteUnix,$seguridad);				} else {					actualizarDatosPacienteTablaUnica($pacienteMatrix,$pacienteUnix);				}									//Ingreso de datos en tabla 37 de root				if(!$pacienteEnTablaIngresos) {					insertarIngresoPaciente($pacienteUnix, $wemp_pmla, $seguridad);				} else {					$pacienteMatrix->ingresoHistoriaClinica = $ingresoAnterior;					actualizarIngresoPaciente($pacienteMatrix, $pacienteUnix, $wemp_pmla);					$pacienteMatrix->ingresoHistoriaClinica = $pacienteUnix->ingresoHistoriaClinica;				}			}						//Proceso de movimiento hospitalario			$ingresoPaciente = new ingresoPacientesDTO();							$ingresoPaciente->historiaClinica = $pacienteUnix->historiaClinica;			$ingresoPaciente->ingresoHistoriaClinica = $pacienteUnix->ingresoHistoriaClinica;			$ingresoPaciente->servicioActual = $cco;			$ingresoPaciente->habitacionActual = "";			$ingresoPaciente->fechaIngreso = $pacienteUnix->fechaIngreso;			$ingresoPaciente->horaIngreso = $pacienteUnix->horaIngreso;						$ingresoPaciente->fechaAltaProceso = "0000-00-00";			$ingresoPaciente->horaAltaProceso = "00:00:00";			$ingresoPaciente->fechaAltaDefinitiva = "0000-00-00";			$ingresoPaciente->horaAltaDefinitiva = "00:00:00";							if(esCirugia($cco))				$ingresoPaciente->enProcesoTraslado = "on";			else				$ingresoPaciente->enProcesoTraslado = "off";			$ingresoPaciente->altaDefinitiva = "off";			$ingresoPaciente->altaEnProceso = "off";							$ingresoPaciente->usuario = "A-".$basedatos;							//Si hay un registro en urgencias			$pacienteIngresado = pacienteIngresado($pacienteMatrix);						//Grabar ingreso paciente			$ingresoPaciente->servicioAnterior = "";			$ingresoPaciente->habitacionAnterior = "";						if(!$pacienteIngresado or !$pacienteIngresadoHce) {				if(!$pacienteIngresado)					grabarIngresoPaciente($ingresoPaciente, $seguridad);								if(!$pacienteIngresadoHce)					registrarIngresoPaciente($ingresoPaciente, $seguridad);								return 'ok';			} else {				return 'existente';			}					} else {			return 'existente';		}	} else {		return 'no-urg';	}}	//2016-03-02 Verónica Arismendy se consulta el prefijo y el número de la tabla de citas dependiendo del tipo de atención se devuelve el nombre completo de la tabla de citas	function consultarPrefijoNumeroTabla($wcit, $wemp_pmla, $conex){		//Se consulta en la 51 el prefijo de la tabla envíandole la descripción		$q = "SELECT detval 		      FROM root_000050, root_000051 			  WHERE empcod = '".$wemp_pmla."' 			  AND empest = 'on' 			  AND empcod = detemp 			  AND detdes = '".$wcit."' 			  AND detapl = 'citas'		";			echo ' consulta prefijo '.$q;		$res = mysql_query($q,$conex) or die ("Error: ".mysql_errno()." - en el query: ".$q." - ".mysql_error());        $pref = mysql_fetch_assoc($res);		$prefijoTabla = isset($pref["detval"]) && $pref["detval"] != "" ? $pref["detval"] : "";				//Con el mismo parametro se hace un case para ver que tabla de citas maneja. OBS: cada que se agregue esta funcionalidad a un servcio se debe añadir al case		$numTablaCita = array();		switch($wcit){			case 'Fisioterapia' : 							$numTablaCita = array("000009", "000017");							break;		}				$arrTablaCitas = array(			"prefijo" 	   => $prefijoTabla != "" ? $prefijoTabla : "",			"nombreTabla"  => $numTablaCita		);						return $arrTablaCitas;	}	// Llamado a las funciones según el parámetro pasado por medio de ajax	switch($consultaAjax)	{			case 10:			echo asignarMedicoUrgencias($basedatos,$basedatoshce,$medico,$paciente,$ingreso,$servicio,$seguridad,$tipo_asignacion,$wserviciourl);		break;		case 11:			echo altaPacienteUrgencias($basedatos,$basedatoshce,$cco,$servicio,$paciente,$ingreso,$wemp_pmla,$wserviciourl,$seguridad,"Manual");		break;		case 12:			echo muertePacienteUrgencias($basedatos,$basedatoshce,$cco,$paciente,$ingreso,$seguridad);		break;		case 13:			echo agendaPacientesUrgencias($basedatos,$basedatoshce,$basedatoscliame,$cco,$wemp_pmla,$wserviciourl,$seguridad,$servicio,$wesp, $wcit, $wprounificado); //2016-03-02 Verónica Arismendy		break;		/* 		// Se usaba para el ingreso de paciente manualmente por el campo de texto		// Ver actualización de Abril 20 de 2011		case 14:			ingresarPacientesUrgencias($basedatos,$basedatoshce,$cco,$whistoria,$conexUnix,$wemp_pmla,$seguridad);		break;		*/		case 15:			echo activarPacienteUrgencias($basedatos,$basedatoshce,$cco,$paciente,$ingreso,$seguridad);		break;		case 16:			echo reasignarPacienteUrgencias($basedatos,$basedatoshce,$cco,$paciente,$ingreso,$wemp_pmla,$seguridad);		break;		case 17:			echo asignarAgendaMultiple($basedatos,$basedatoshce,$cco,$paciente,$ingreso,$wemp_pmla,$seguridad);		break;		default :			break;	}//Liberacion de conexion MatrixliberarConexionBD($conex);//Liberacion de conexion UnixliberarConexionOdbc($conexUnix);}if(!isset($consultaAjax)) { ?></body></html><?phpinclude_once("conex.php"); } ?>