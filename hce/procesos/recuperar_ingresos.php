<?php
include_once("conex.php"); header("Content-Type: text/html;charset=ISO-8859-1"); ?><!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"><html><head>  <title>Recuperar Ingresos</title></head><body><?php
include_once("conex.php");  include_once("root/comun.php");  
  $wbasedato_mov = consultarAliasPorAplicacion($conex, '01', "movhos");  $wbasedato_hce = consultarAliasPorAplicacion($conex, '01', "hce");  conexionOdbc($conex, $wbasedato_mov, &$conexUnix, 'facturacion');  function formato_hora($hora)  {	$hora_real = $hora;		if($hora=='0')		$hora_real =  '00';	if($hora=='1')		$hora_real =  '01';	if($hora=='2')		$hora_real =  '02';	if($hora=='3')		$hora_real =  '03';	if($hora=='4')		$hora_real =  '04';	if($hora=='5')		$hora_real =  '05';	if($hora=='6')		$hora_real =  '06';	if($hora=='7')		$hora_real =  '07';	if($hora=='8')		$hora_real =  '08';	if($hora=='9')		$hora_real =  '09';		return $hora_real;  }  	  $qfecha = "";  if(isset($fecha) && $fecha)	$qfecha = " AND a.Fecha_data >= '".$fecha."' ";    if(!isset($insert))	$insert = '1';  // Asignación de fecha y hora actual  $wfecha = date("Y-m-d");  $whora  = (string)date("H:i:s");  	// Consulto todos los ingresos que faltan en las tablas movhos_000018	 $q = "SELECT Firhis, Firing 			 FROM hce_000036 a				  LEFT JOIN movhos_000018 b 						 ON firhis = ubihis 						AND firing = ubiing		    WHERE b.id IS NULL 				  ".$qfecha."  			GROUP BY Firhis, Firing			ORDER BY Firhis, Firing ";	$res = mysql_query($q,$conex) or die ("Error: ".mysql_errno()." - en el query: ".$q." - ".mysql_error());	//echo $q."<br>";	$cont1=0;	$cont2=0;		// Recorro las historias e ingresos	while($row = mysql_fetch_array($res))	{		$paciente = $row['Firhis'];		$ingreso = $row['Firing'];				// Consulto en Unix los datos del ingreso		$qu = " SELECT egring, egrhoi, egregr, egrhoe, egrcer, egrsin, egrseg				  FROM inmegr				 WHERE egrhis = '".$paciente."'				   AND egrnum = '".$ingreso."'				";		$err_o = odbc_do($conexUnix,$qu);		echo "<br />REGISTRO: ".$paciente." - ".$ingreso."<br />";				if(odbc_fetch_row($err_o))		{			$cod_responsable = odbc_result($err_o,5);						// Consulto el codigo del centro de costos de ingreso			$servicio_ingreso = odbc_result($err_o,6);			$qcco = "  SELECT Ccocod						 FROM movhos_000011						WHERE Ccoseu = '".$servicio_ingreso."' ";			$rescco = mysql_query($qcco,$conex) or die ("Error: ".mysql_errno()." - en el query: ".$qcco." - ".mysql_error());			$numcco = mysql_num_rows($rescco);			$cod_cco_ing = "";			if($numcco>0)			{				$rowcco = mysql_fetch_array($rescco);				$cod_cco_ing = $rowcco['Ccocod'];			}			else			{				$qser = " SELECT serccocco 						    FROM insercco 						   WHERE serccoser = '".$servicio_egreso."'						";				$err_s = odbc_do($conexUnix,$qser);				if(odbc_fetch_row($err_s))					$cod_cco_ing = odbc_result($err_s,1);			}			// Consulto el codigo del centro de costos de egreso			$servicio_egreso = odbc_result($err_o,7);			$qcco = "  SELECT Ccocod						 FROM movhos_000011						WHERE Ccoseu = '".$servicio_egreso."' ";			$rescco = mysql_query($qcco,$conex) or die ("Error: ".mysql_errno()." - en el query: ".$qcco." - ".mysql_error());			$numcco = mysql_num_rows($rescco);			$cod_cco_egr = "";			if($numcco>0)			{				$rowcco = mysql_fetch_array($rescco);				$cod_cco_egr = $rowcco['Ccocod'];			}			else			{				$qser = " SELECT serccocco 						    FROM insercco 						   WHERE serccoser = '".$servicio_egreso."'						";				$err_s = odbc_do($conexUnix,$qser);				if(odbc_fetch_row($err_s))					$cod_cco_egr = odbc_result($err_s,1);			}						// Consulto en Unix los datos de la empresa			$qemp = " SELECT empnom, emptip 					  FROM inemp 					 WHERE empcod = '".$cod_responsable."'					";			$err_e = odbc_do($conexUnix,$qemp);			$nom_responsable = "";			$tip_responsable = "";			if(odbc_fetch_row($err_e))			{				$nom_responsable = odbc_result($err_e,1);				$tip_responsable = odbc_result($err_e,2);			}						// Consulto en Unix los datos del paciente			$qpac = " SELECT pacdir, pactel, pacmun   					  FROM inpaci 					 WHERE pachis = '".$paciente."'					";			$err_p = odbc_do($conexUnix,$qpac);			$dir_paciente = "";			$tel_paciente = "";			$muncod_paciente = "";			if(odbc_fetch_row($err_p))			{				$dir_paciente = odbc_result($err_p,1);				$tel_paciente = odbc_result($err_p,2);				$muncod_paciente = odbc_result($err_p,3);			}			// Consulto en Unix el nombre del municipio			$qmun = " SELECT munnom  					  FROM inmun 					 WHERE muncod = '".$muncod_paciente."'					";			$err_m = odbc_do($conexUnix,$qmun);			$mun_paciente = "";			if(odbc_fetch_row($err_m))			{				$mun_paciente = odbc_result($err_m,1);			}									$fec_ing_real = odbc_result($err_o,1);			$hor_ing_real_str = explode(".",odbc_result($err_o,2));			$hora_real = formato_hora($hor_ing_real_str[0]);			$minutos_real = formato_hora($hor_ing_real_str[1]);			$hor_ing_real = $hora_real.":".$minutos_real.":00";						$fec_egre_real = odbc_result($err_o,3);			$hor_egre_real_str = explode(".",odbc_result($err_o,4));			$hora_real = formato_hora($hor_egre_real_str[0]);			$minutos_real = formato_hora($hor_egre_real_str[1]);			$hor_egre_real = $hora_real.":".$minutos_real.":00";						//////////////////////////////////////////////////////////////////////////////////////			// Busco si hay registros en movhos 16 			$qing = "  SELECT Inghis						 FROM movhos_000016						WHERE Inghis = '".$paciente."'						  AND Inging = '".$ingreso."' ";			$resing = mysql_query($qing,$conex) or die ("Error: ".mysql_errno()." - en el query: ".$qing." - ".mysql_error());			$numing = mysql_num_rows($resing);			//echo $qing."<br />";			// Si no hay registro en movhos 16			if($numing==0)			{				// Ingreso los datos en la tabla movhos 16				$qins = " INSERT INTO movhos_000016 								 ( Medico , Fecha_data , Hora_data , Inghis , Inging , Ingres , Ingnre , Ingtip , Ingtel , Ingdir , Ingmun , Seguridad , id ) 						  VALUES ( 'movhos', '".$fec_ing_real."', '".$hor_ing_real."', '".$paciente."', '".$ingreso."', '".$cod_responsable."', '".$nom_responsable."', '".$tip_responsable."', '".$tel_paciente."', '".$dir_paciente."', '".$mun_paciente."', 'C-Movhos', '' ); ";				if($insert=='1')					$resins = mysql_query($qins,$conex) or die ("Error: ".mysql_errno()." - en el query: ".$qins." - ".mysql_error());				echo $qins."<br />";			} 			else			{				echo $paciente." - ".$ingreso." ya existe en tabla movhos_000016<br />";			}			//////////////////////////////////////////////////////////////////////////////////////							//////////////////////////////////////////////////////////////////////////////////////			// Busco si hay registros en movhos 18 			$qubi = "  SELECT Ubihis						 FROM movhos_000018						WHERE Ubihis = '".$paciente."'						  AND Ubiing = '".$ingreso."' ";			$resubi = mysql_query($qubi,$conex) or die ("Error: ".mysql_errno()." - en el query: ".$qubi." - ".mysql_error());			$numubi = mysql_num_rows($resubi);						// Si no hay registro en movhos 18			if($numubi==0)			{				// Ingreso los datos en la tabla movhos 18				$qins = " INSERT INTO movhos_000018 								 ( Medico, Fecha_data, Hora_data, Ubihis, Ubiing, Ubisac, Ubihac, Ubialp, Ubiald, Ubifad, Ubihad, Ubiptr, Ubimue, ubiuad, Seguridad , id ) 						  VALUES ( 'movhos', '".$fec_ing_real."', '".$hor_ing_real."', '".$paciente."', '".$ingreso."', '".$cod_cco_egr."', '', 'off', 'on', '".$fec_egre_real."', '".$hor_egre_real."', 'off', '', 'Movhos', 'C-Movhos', '' ); ";				if($insert=='1')					$resins = mysql_query($qins,$conex) or die ("Error: ".mysql_errno()." - en el query: ".$qins." - ".mysql_error());				echo $qins."<br />";			} 			else			{				echo $paciente." - ".$ingreso." ya existe en tabla movhos_000018<br />";			}			//////////////////////////////////////////////////////////////////////////////////////							//////////////////////////////////////////////////////////////////////////////////////			// Busco si hay registros en hce 22 			$qmtr = "  SELECT Mtrhis						 FROM hce_000022						WHERE Mtrhis = '".$paciente."'						  AND Mtring = '".$ingreso."' ";			$resmtr = mysql_query($qmtr,$conex) or die ("Error: ".mysql_errno()." - en el query: ".$qmtr." - ".mysql_error());			$nummtr = mysql_num_rows($resmtr);						// Si no hay registro en hce 22			if($nummtr==0)			{				// Ingreso los datos en la tabla hce 22				$qins = " INSERT INTO hce_000022 								 ( Medico, Fecha_data, Hora_data, Mtrhis, Mtring, Mtrest, Mtrtra, Mtrcon, Mtrcur, Mtrcci, Seguridad , id ) 						  VALUES ( 'HCE', '".$fec_ing_real."', '".$hor_ing_real."', '".$paciente."', '".$ingreso."', 'on', 'off', '05', 'off', '".$cod_cco_ing."', 'C-Hce', '' ); ";				if($insert=='1')					$resins = mysql_query($qins,$conex) or die ("Error: ".mysql_errno()." - en el query: ".$qins." - ".mysql_error());				echo $qins."<br />";			} 			else			{				echo $paciente." - ".$ingreso." ya existe en tabla hce_000022<br />";			}			//////////////////////////////////////////////////////////////////////////////////////			//////////////////////////////////////////////////////////////////////////////////////			// Busco si hay registros en movhos 33 			$qegr = "  SELECT Historia_clinica 						 FROM movhos_000033						WHERE Historia_clinica = '".$paciente."'						  AND Num_ingreso = '".$ingreso."'						  AND Tipo_egre_serv = 'ALTA' ";			$resegr = mysql_query($qegr,$conex) or die ("Error: ".mysql_errno()." - en el query: ".$qegr." - ".mysql_error());			$numegr = mysql_num_rows($resegr);						// Si no hay registro en movhos 18			if($numegr==0)			{				// Ingreso los datos en la tabla movhos 18				$qins = " INSERT INTO movhos_000033 								 ( Medico, Fecha_data, Hora_data, Historia_clinica, Num_ingreso, Servicio, Num_ing_serv, Fecha_egre_serv, Hora_egr_serv, Tipo_egre_serv, Dias_estan_serv, Seguridad , id ) 						  VALUES ( 'movhos', '".$fec_ing_real."', '".$hor_ing_real."', '".$paciente."', '".$ingreso."', '".$cod_cco_egr."', '1', '".$fec_egre_real."', '".$hor_egre_real."', 'ALTA', '1', 'C-Movhos', '' ); ";				if($insert=='1')					$resins = mysql_query($qins,$conex) or die ("Error: ".mysql_errno()." - en el query: ".$qins." - ".mysql_error());				echo $qins."<br />";			} 			else			{				echo $paciente." - ".$ingreso." ya existe en tabla movhos_000033<br />";			}			//////////////////////////////////////////////////////////////////////////////////////						$cont2++;							}					$cont1++;	}	echo "<br><br>Registros totales: $cont1 ";	echo "<br>Actualizados: $cont2 ";?></body></html>