<html><head><title>MATRIX - [AGENDA URGENCIAS]</title>	<link type='text/css' href='../../../include/root/ui.core.css' rel='stylesheet' />	<link type='text/css' href='../../../include/root/jquery.tooltip.css' rel='stylesheet' />	<script type='text/javascript' src='../../../include/root/jquery-1.3.2.js'></script>	<script type='text/javascript' src='../../../include/root/jquery.tooltip.js'></script>	<script type='text/javascript' src='../../../include/root/jquery.blockUI.min.js'></script><script type='text/javascript'>function cargaToolTip(){	var cont1 = 1;	while(document.getElementById('wide'+cont1))	{		 $('#wide'+cont1).tooltip({track: true, delay: 0, showURL: false, showBody: ' - ', opacity: 0.95, left: -50 });		 cont1++;	}}// Llamado ajax para asignar médico tratante pacientefunction asignarMedico(i) {	var parametros = "consultaAjax=10&basedatos="+document.forms.forma.wbasedato.value+"&basedatoshce="+document.forms.forma.wbasedatohce.value+"&medico=" + document.getElementById('wmedico'+i).value+"&paciente=" +document.getElementById('wpaciente'+i).value+"&ingreso=" +document.getElementById('wingreso'+i).value+"&seguridad=" +document.getElementById('wseguridad').value; 		try	{		var ajax = nuevoAjax();				ajax.open("POST", "auxAgenda.php",true);		ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");		ajax.send(parametros);				ajax.onreadystatechange=function() 		{ 			if (ajax.readyState==4 && ajax.status==200)			{ 				if(ajax.responseText!="ok")					alert(ajax.responseText);			} 		}		if ( !estaEnProceso(ajax) ) 		{			ajax.send(null);		}	}catch(e){	}}// Llamado ajax para dar de alta al pacientefunction altaPaciente(i) {	if(confirm("Realmente desea dar de alta el paciente")) 	{		var parametros = "consultaAjax=11&basedatos="+document.forms.forma.wbasedato.value+"&basedatoshce="+document.forms.forma.wbasedatohce.value+"&codcco="+document.forms.forma.codCco.value+"&paciente=" +document.getElementById('wpaciente'+i).value+"&ingreso=" +document.getElementById('wingreso'+i).value+"&seguridad=" +document.getElementById('wseguridad').value; 				try		{					var ajax = nuevoAjax();						ajax.open("POST", "auxAgenda.php",false);			ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");			ajax.send(parametros);			if(ajax.responseText!="ok")				alert(ajax.responseText);					}catch(e){	}	}	else	{		document.getElementById('alta'+i).checked = false;		return false;	}	agendaUrgencias();}// Llamado ajax para dar de alta por muerte al pacientefunction muertePaciente(i) {	if(confirm("Confirme la muerte del paciente")) 	{		var parametros = "consultaAjax=12&basedatos="+document.forms.forma.wbasedato.value+"&basedatoshce="+document.forms.forma.wbasedatohce.value+"&codcco="+document.forms.forma.codCco.value+"&paciente=" +document.getElementById('wpaciente'+i).value+"&ingreso=" +document.getElementById('wingreso'+i).value+"&seguridad=" +document.getElementById('wseguridad').value; 				try		{			var ajax = nuevoAjax();						ajax.open("POST", "auxAgenda.php",false);			ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");			ajax.send(parametros);			if(ajax.responseText!="ok")				alert(ajax.responseText);					}catch(e){	}	}	else	{		document.getElementById('muerte'+i).checked = false;		return false;	}	agendaUrgencias();}// Llamado ajax para activar de nuevo un paciente dado de altafunction activarPaciente(i) {	if(confirm("Realmente desea activar el paciente")) 	{		var parametros = "consultaAjax=15&basedatos="+document.forms.forma.wbasedato.value+"&basedatoshce="+document.forms.forma.wbasedatohce.value+"&codcco="+document.forms.forma.codCco.value+"&paciente=" +document.getElementById('wpaciente'+i).value+"&ingreso=" +document.getElementById('wingreso'+i).value+"&seguridad=" +document.getElementById('wseguridad').value; 				try		{			var ajax = nuevoAjax();			ajax.open("POST", "auxAgenda.php",false);			ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");			ajax.send(parametros);			if (ajax.readyState==4 && ajax.status==200)			{ 				if(ajax.responseText=="activo")					alert('El paciente ya se encuentra activo con otro ingreso');				if(ajax.responseText=="inactivoEnUnix")					alert('El paciente no se puede activar porque no está activo en Unix');			} 					}catch(e){	}	}	else	{		document.getElementById('muerte'+i).checked = false;		return false;	}	agendaUrgencias();}// Llamado ajax para activar de nuevo un paciente dado de altafunction reasignarPaciente(i) {	if(confirm("Realmente desea reasignar la historia del paciente")) 	{		var parametros = "consultaAjax=16&basedatos="+document.forms.forma.wbasedato.value+"&basedatoshce="+document.forms.forma.wbasedatohce.value+"&codcco="+document.forms.forma.codCco.value+"&paciente=" +document.getElementById('wpaciente'+i).value+"&ingreso=" +document.getElementById('wingreso'+i).value+"&seguridad=" +document.getElementById('wseguridad').value; 				try		{			var ajax = nuevoAjax();			ajax.open("POST", "auxAgenda.php",false);			ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");			ajax.send(parametros);			if (ajax.readyState==4 && ajax.status==200)			{ 				if(ajax.responseText=="no-reasignar")					alert('El paciente tiene más de 1 ingreso. No se puede reasignar este número de historia');			} 					}catch(e){	}	}	else	{		document.getElementById('reasignar'+i).checked = false;		return false;	}	agendaUrgencias();}// Llamado ajax que permite mostrar la lista de pacientes en urgenciasfunction agendaUrgencias(){			var parametros = ""; 	parametros = "consultaAjax=13&basedatos="+document.forms.forma.wbasedato.value+"&basedatoshce="+document.forms.forma.wbasedatohce.value+"&ccoUrgencias="+document.forms.forma.codCco.value+"&wemp_pmla="+document.forms.forma.wemp_pmla.value+"&seguridad=" +document.getElementById('wseguridad').value;		try	{		try {			$.blockUI({ message: $('#msjEspere') });		} catch(e){ }		var ajax = nuevoAjax();				ajax.open("POST", "auxAgenda.php",true);		ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");		ajax.send(parametros);				ajax.onreadystatechange=function() 		{ 			var contenedor = document.getElementById('agendUrg');			if (ajax.readyState==4 && ajax.status==200)			{				contenedor.innerHTML=ajax.responseText;				cargaToolTip();			}			try {				$.unblockUI();			} catch(e){ }		}				if ( !estaEnProceso(ajax) ) 		{			ajax.send(null);		}	}catch(e){	}}// Llamado ajax para ingresar el paciente a la lista de pacientes en urgencia/*// Se usaba para el ingreso del paciente por campo de texto// Ver actualización de Abril 20 de 2011function ingresarPacienteUrg() {	var parametros = "consultaAjax=14&basedatos="+document.forms.forma.wbasedato.value+"&basedatoshce="+document.forms.forma.wbasedatohce.value+"&ccoUrgencias="+document.forms.forma.codCco.value+"&whistoria=" +document.getElementById('whistoria').value+"&wemp_pmla="+document.forma.wemp_pmla.value+"&seguridad=" +document.getElementById('wseguridad').value; 		try	{		var ajax = nuevoAjax();				ajax.open("POST", "auxAgenda.php",false);		ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");		ajax.send(parametros);		if(ajax.responseText=='no-urg') 		{			alert('El paciente no se encuentra en urgencias o el número de la historia ingresada no existe.');		}		else if(ajax.responseText=='existente') 		{			alert('El paciente ya se ha ingresado');		}		else		{			agendaUrgencias();		}		document.getElementById('whistoria').value = '';		if ( !estaEnProceso(ajax) ) 		{			ajax.send(null);		}	}catch(e){	}}*/// Llama a la función de ingreso de paciente a urgencias cuando se teclea enter en el textboxdocument.onkeypress=function(e){	var esIE=(document.all);	var esNS=(document.layers);	tecla=(esIE) ? event.keyCode : e.which;	if(tecla==13)	{		ingresarPaciente();	}}// Valida la historia clínica digitada para el ingreso del pacientefunction ingresarPaciente(){	var historia = document.forms.forma.whistoria.value;	var valido = true;	var mensaje = "";		//validaciones	if(historia == '')	{		mensaje += "Debe especificar una historia clínica \n\r";		document.forms.forma.whistoria.value = '';		valido = false;		} 	else 	{				//Prueba el patron regular... empezar por 1-9, seguido de digitos		var reg = new RegExp("^[1-9]+[0-9]*");     	if(!reg.test(historia))		{			mensaje += 'Debe especificar un numero de historia compuesta por digitos.  Sin cero adelante. \n\r';			document.forms.forma.whistoria.value = '';			valido = false;    	}    		//Historia cero no se permite		if(historia == '0')		{			mensaje += 'Debe especificar una historia clínica diferente de cero \n\r';			document.forms.forma.whistoria.value = '';			valido = false;		}		}		if(!valido)	{		alert("Error: \n\r" + mensaje);		return false;	} 	else 	{		if(confirm("Desea ingresar el paciente a urgencias?"))		{			ingresarPacienteUrg();		}		else		{			return false;		}	}}window.onload = function() { agendaUrgencias(); }</script></head><body><?php
include_once("conex.php");/* **************************** AGENDA URGENCIAS *************************************************** ****************************** DESCRIPCIÓN *************************************************** * Permite el registro de pacientes en urgencias.  * Lista los pacientes ingresados y permite asignar el médico tratante de cada uno * Muestra el estado en que se encuentran los pacientes tratados * Permite establecer estado de alta o muerte para el paciente en urgencias ************************************************************************************************* * Autor: John M. Cadavid. G. * Fecha creacion: 2011-02-16 ************************************************************************************************* * MODIFICACIONES *************************************************************************************************  * 2011-05-13 - Se cambio el query para consultar médico asignado en la función agendaUrgencias *				ya que estaba tomando pacientes con médico en blanco "", y mostraba médico  *				con código en blanco "" *				Se cambió la función actualizarAltaPacientesUnix ya que no se estaba recorriendo  *				el arreglo de forma correcta, se cambió la función while ($j < count ($altas_unix)) *				por foreach ($altas_unix as $j => $value) ************************************************************************************************* * 2011-04-28 - Cuando es alta automática, se cambio la función <altaPacienteUrgencias>  *				para que verifique si en Unix sigue activa la historia, si es asi no le da alta *				Se activaron los checbox de actas y muertes para conductas de alta *				Se inactiva checbox de muerte si conducta es alta y viceversa ************************************************************************************************* * 2011-04-25 - Modificación en el ingreso de pacientes a urgencias, se quito el campo  *				de texto donde se ingresaba la historia clínica, ya se toma de Unix los  *				pacientes en urgencias actualizándose la lista automáticamente. ************************************************************************************************* * 2011-03-04 - Modificación en el proceso de ingreso del paciente a urgencias para validar los siguientes casos: * 				Si un usuario ya está en movhos 18 pero aun no esta en hce 22, registrarlo en hce 22 * 				antes se asumia como ya ingresado y no se registraba en hce 22 *				Validar ingreso de paciente no solo por historia sino tambien por número de ingreso, por ejemplo: *				si un usuario está registrado con ingreso 1 y vuelven y lo entran y tiene ya en UNIX ingreso 2 *				se debe dar de alta automaticamente el ingreso 1 y adicionarlo a la agenda de urgencias con ingreso 2 *				Validación al activar un paciente dado de alta, si ya está activo con otro ingreso no lo deja activar *				En reasignar si el paciente tiene mas de un ingreso no deja reasiganar su número de historia ************************************************************************************************* * 2011-02-23 - Adición de try catch al ejecutar blockUI debido a que en algunas versiones viejas de IE * 				sacaba un error y no dejaba ejecutar la página. También se adicionó el evento onload al final del javascript ************************************************************************************************* * 2011-02-22 - Adición de columnas Activar y Reasignar historia para pacientes dados de alta */ // Retorna el código y nombre del centro de costos de urgencias function consultarCcoUrgencias() {	global $wbasedato;	global $conex;	$q = "SELECT			Ccocod, Cconom  		FROM 			".$wbasedato."_000011 		WHERE			Ccourg = 'on'; ";	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	$filas = mysql_num_rows($res);	$cco = new centroCostosDTO();	if($filas > 0)	{		$fila = mysql_fetch_row($res);		$cco->codigo = $fila[0];  		$cco->nombre = $fila[1];	}	return $cco; }/************************************************************************************************************************** INICIO APLICACIÓN ****************************************************************************************************************************************/include_once("root/comun.php");$wactualiz = " May. 13 de 2011";// Validación de usuarioif (!isset($user)){	if (!isset($_SESSION['user'])) 	{		session_register("user");	}	$user="";}//Codigo de usuario que ingreso al sistemaif (strpos($user, "-") > 0)	$wuser = substr($user, (strpos($user, "-") + 1), strlen($user));else	$wuser="";$usuario = new Usuario();$usuario->codigo = $wuser;//Variable para determinar la empresaif(!isset($wemp_pmla)){	terminarEjecucion($MSJ_ERROR_FALTA_PARAMETRO."wemp_pmla");}//Valida codigo de usuario en sesion si no esta registrado el sistema termina la ejecucionif (!isset($_SESSION['user'])){	terminarEjecucion("<div align='center'>Usuario no autenticado.  Por favor cierre esta ventana y vuelva a ingresar a Matrix.</div>");} else {	//Conexion base de datos Matrix	$conex = obtenerConexionBD("matrix");	$institucion = consultarInstitucionPorCodigo($conex, $wemp_pmla);	$winstitucion = $institucion->nombre;		$wbasedatohce = consultarAliasPorAplicacion($conex, $wemp_pmla, "hce");	$wbasedato = consultarAliasPorAplicacion($conex, $wemp_pmla, "movhos");	//Consulto el codigo y nombre del centro de costo de urgencias	$ccoUrgencias = consultarCcoUrgencias();		//Formulario (forma)	echo "<form name='forma' action='' method='post'>";	echo "<input type='hidden' name='wemp_pmla' value='".$wemp_pmla."'>";	echo "<input type='hidden' name='wbasedato' value='".$wbasedato."'>";		echo "<input type='hidden' name='wbasedatohce' value='".$wbasedatohce."'>";		echo "<input type='hidden' name='codCco' value='".$ccoUrgencias->codigo."'>";		echo "<input type='hidden' name='wseguridad' id='wseguridad' value='".$wuser."'>";	echo "<input type='hidden' name='conex' id='conex' value='".$conex."'>";	echo "<input type='hidden' name='waccion'>";	//Mensaje de espera	echo "<div id='msjEspere' name='msjEspere' style='display:none;'>";	echo "<br /><img src='../../images/medical/ajax-loader5.gif'/><br /><br /> Por favor espere un momento ... <br /><br />";	echo "</div>";		// Definición del encabezado del aplicativo	encabezado("ASIGNACIÓN MÉDICO URGENCIAS", $wactualiz, "clinica");		//Botones "Actualizar" y "Cerrar ventana"	echo "<br /><p align='center'><input type='button' value='Actualizar' onclick='javascript:agendaUrgencias();'> &nbsp; | &nbsp; <input type='button' value='Cerrar ventana' onclick='javascript:cerrarVentana();'></p>";          	// Aca la función anterior pinta la lista de pacientes en Urgencias con sus opciones	echo "<div name='agendUrg' id='agendUrg'>";	echo "</div>";			// Establece que la página se refresca automáticamente cada 40 segundos	echo "<script> timer = setInterval('agendaUrgencias()', 300000); </script>";	echo "</form>";	//Botones "Actualizar" y "Cerrar ventana"	echo "<br /><p align='center'><input type='button' value='Actualizar' onclick='javascript:agendaUrgencias();'> &nbsp; | &nbsp; <input type='button' value='Cerrar ventana' onclick='javascript:cerrarVentana();'></p>";          		echo "</div><br />"; //Cierre div id=page}?></body></html>