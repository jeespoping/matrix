<?php
include_once("conex.php");include_once("root/comun.php");$conex = obtenerConexionBD("matrix");class serviciosMatrix{	var $codigo;	var $nombre;}class tiposEstudiosMatrix{	var $codigo;	var $nombre;}class anatomiasMatrix{	var $codigo;	var $nombre;}class clasesExamenesMatrix	{	var $codigo;	var $nombre;}class tiposPosMatrix	{	var $codigo;	var $nombre;}header("Content-Type: text/html;charset=ISO-8859-1");// Si no es consulta por AJAXif(!isset($consultaAjax)){?>	<html>	<head>	<title>MATRIX - [HOMOLOGACION DE PROCEDIMIENTOS Y EXAMENES]</title>		<link type='text/css' href='../../../include/root/ui.core.css' rel='stylesheet' />		<link type="text/css" href="../../../include/root/jquery.autocomplete.css" rel="stylesheet" /> <!-- Autocomplete -->		<link type="text/css" href="../../../include/root/smartpaginator.css" rel="stylesheet" /> <!-- Autocomplete -->		<script src="../../../include/root/jquery_1_7_2/js/jquery-1.7.2.min.js" type="text/javascript"></script>		<script src="../../../include/root/modernizr.custom.js" type="text/javascript"></script>		<script type='text/javascript' src='../../../include/root/jquery.blockUI.min.js'></script>		<script type='text/javascript' src='../../../include/root/jquery.jeditable.js'></script>		<script type='text/javascript' src='../../../include/root/jquery.autocomplete.js'></script>	<!-- Autocomplete -->		<script type='text/javascript' src='../../../include/root/jquery.autocomplete.js'></script>	<!-- Autocomplete -->		<script type='text/javascript' src='../../../include/root/smartpaginator.js'></script>	<!-- Autocomplete -->				<style>			.campoBuscar { color:#333; }									.linkadd			{				 background-color: #C0C0C0;				 font-family: verdana;				 font-size: 12px;				 color: #E8EEF7;				 border: 1px  #626262;				 border-left: 1px  #90815C;				 border-right: 1px  #9F8F69;				 border-bottom: 1px solid #ACACAC;			}						.efectoeditar {			border: none;			background: transparent;			color:#333333;			}			.efectoeditar:hover {			border: thin #999999 outset;			filter:alpha(opacity=50);-moz-opacity:.5;opacity:.5;			background: #FFFFFF;			color: #000000;			}			.efectoeditar:focus  {			border: thin #000000 solid;			background: #FFFFFF;			color: #000000;			}			.efectoeditar:focus:hover {			border: thin #000000 solid;			filter:alpha(opacity=100);-moz-opacity:1;opacity:1;			background: #FFFFFF;			color: #000000;			}		</style>			<script type='text/javascript'>			// JavaScript Document	$(document).ready(function() {				inicializarEditTable();				inicializarAutocompletar();				$('#divAdd').click(function() {			$('#tablaAdd').slideToggle('slow');		});								var total_registros = $("#total_registros").val();		var registros_pagina = $("#registros_pagina").val();		var wemp_pmla = $("#wemp_pmla").val();		var wbasedato = $("#wbasedato").val();		var wbasedatohce = $("#wbasedatohce").val();		var wseguridad = $("#wseguridad").val();		var nro_pagina = $("#nro_pagina").val();								$('#paginador').smartpaginator({										totalrecords: total_registros, 				recordsperpage: registros_pagina, 				length: 7, 				next: 'Sig', 				prev: 'Atrás', 				first: 'Inicio', 				last: 'Ulti',				go: 'Ir',				theme: 'black',				controlsalways: true, 				onchange: 								function (newPage) {												$.blockUI({ message:	'<img src="../../images/medical/ajax-loader.gif" >',								css: 	{											width: 	'auto',											height: 'auto'										}						 });																		$.ajax({							url: "homologacion_examenes.php",							type: "POST",							data:{															consultaAjax: 		'consultar_registros',													wemp_pmla:      	wemp_pmla,								wbasedato:      	wbasedato,								wbasedatohce:		wbasedatohce,								wseguridad:			wseguridad,								registros_inicial:	(newPage*registros_pagina) - registros_pagina,								registros_final:	registros_pagina															},										async: false,							dataType: "json",							success:function(data_json) {														if (data_json.error == 1)								{									alert(data_json.mensaje);									return;								}								else{																												$('#examenesNuevos').html(data_json.html);									$.unblockUI();								}							}						}					).done(function(){															inicializarAutocompletar();												});								}            });						var total_registros_homologados = $("#total_registros_homologados").val();						$('#paginadorhomologados').smartpaginator({										totalrecords: total_registros_homologados, 				recordsperpage: registros_pagina, 				length: 7, 				next: 'Sig', 				prev: 'Atrás', 				first: 'Inicio', 				last: 'Ulti',				go: 'Ir',				theme: 'black',				controlsalways: true, 				onchange: 								function (newPage) {												$.blockUI({ message:	'<img src="../../images/medical/ajax-loader.gif" >',								css: 	{											width: 	'auto',											height: 'auto'										}						 });																		$.ajax({							url: "homologacion_examenes.php",							type: "POST",							data:{															consultaAjax: 		'consultar_registros_homologados',													wemp_pmla:      	wemp_pmla,								wbasedato:      	wbasedato,								wbasedatohce:		wbasedatohce,								wseguridad:			wseguridad,								registros_inicial:	(newPage*registros_pagina) - registros_pagina,								registros_final:	registros_pagina															},										async: false,							dataType: "json",							success:function(data_json) {														if (data_json.error == 1)								{									alert(data_json.mensaje);									return;								}								else{																												$('#examenesMaestro').html(data_json.html);									$.unblockUI();								}							}						}					).done(function(){															inicializarAutocompletar();												});								}            });	 });	 function textobuscar(este, dato, campo){	 	 	 if(dato != campo){		este.value = dato;	 }else{	 	 este.value="";	 }	 	 }		 	// Determina si una variable ha sido declarada	// Cumple la misma función que isset en PHP	function isset(variable_name) 	{		try {			 if (typeof(eval(variable_name)) != 'undefined')			 if (eval(variable_name) != null)			 return true;		 } catch(e) { }		return false;	}	function validateEnter(e) 	{		var key=e.keyCode || e.which;		if (key==13){ return true; } else { return false; }	}		function inicializarEditTable() 	{		 // servira para editar los de tipo input text.		 //$('.text').editable('homologacion_examenes.php?consultaAjax=editable&basedatoshce='+document.forms.forma.wbasedatohce.value);		 		 // servira para editar el textarea.		 // $('.textarea').editable('homologacion_examenes.php?consultaAjax=editable&basedatoshce='+document.forms.forma.wbasedatohce.value, { 			 // type     : 'textarea',			 // submit   : 'Ok'		 // });		// $('#divAdd').click(function() {			// $('#tablaAdd').slideToggle('slow');		// });		 				$('#addOk').hide();		$('#addWarning').hide();	}		function inicializarAutocompletar() 	{		var numfilas = document.getElementById('wnumfilas').value;		var codexamen = '';				for(var cont=0;cont<=numfilas;cont++)		{			//console.log(cont);			//codexamen = document.getElementById('wcodigo'+cont).value;						if( cont == 0 )				cont = "";						//Autocomplete para CUPS			if(isset(document.getElementById('codcups'+cont)))			{				$("#codcups"+cont).autocomplete("homologacion_examenes.php?consultaAjax=liscup&wemp_pmla="+document.getElementById('wemp_pmla').value+"&seguridad=" +document.getElementById('wseguridad').value+"&basedatos="+document.getElementById('wbasedato').value+"&basedatoshce="+document.getElementById('wbasedatohce').value+"&codigo="+document.getElementById('wcodigo'+cont).value, {					max: 100,					scroll: true,					scrollHeight: 500,					matchContains: true,					width:500,					minChars: 2,					autoFill:false,					formatResult: function(data, value) {						return value;					}				}).result(function(event, item) {										//console.log('wcodigo: '+cont);					codexamen = item[2];					asignarCups(codexamen,item[1]);									});			}	 						if( cont == "" )				cont = 0;		}		 		$("#fndCodcupsH").autocomplete("homologacion_examenes.php?consultaAjax=liscup&wemp_pmla="+document.getElementById('wemp_pmla').value+"&seguridad=" +document.getElementById('wseguridad').value+"&basedatos="+document.getElementById('wbasedato').value+"&basedatoshce="+document.getElementById('wbasedatohce').value, {					max: 100,					scroll: true,					scrollHeight: 500,					matchContains: true,					width:500,					minChars: 2,					autoFill:false,					formatResult: function(data, value) {						return value;					}				}).result(function(event, item) {										//console.log('wcodigo: '+cont);					codexamen = item[2];					asignarCups(codexamen,item[1]);									}); 				$("#fndCodcups").autocomplete("homologacion_examenes.php?consultaAjax=liscup&wemp_pmla="+document.getElementById('wemp_pmla').value+"&seguridad=" +document.getElementById('wseguridad').value+"&basedatos="+document.getElementById('wbasedato').value+"&basedatoshce="+document.getElementById('wbasedatohce').value, {					max: 100,					scroll: true,					scrollHeight: 500,					matchContains: true,					width:500,					minChars: 2,					autoFill:false,					formatResult: function(data, value) {						return value;					}				}).result(function(event, item) {										//console.log('wcodigo: '+cont);					codexamen = item[2];					asignarCups(codexamen,item[1]);									}); 		 	}	 	 // Llamado ajax para asignar el servicio al examen	function validoCups(cups)	{		var parametros = "consultaAjax=valcup&wemp_pmla="+document.forms.forma.wemp_pmla.value+"&seguridad=" +document.getElementById('wseguridad').value+"&basedatos="+document.forms.forma.wbasedato.value+"&basedatoshce="+document.forms.forma.wbasedatohce.value+"&wcups="+cups;		try		{			var ajax = nuevoAjax();			ajax.open("POST", "homologacion_examenes.php",false);			ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");			ajax.send(parametros);			eval( "var data = "+ajax.responseText );						// if(ajax.responseText!="ok")			if( data.error == 1 )				return false;			else				return data;		}catch(e){	}		//listaExamenes();	}	 // Llamado ajax para asignar el servicio al examen	function asignarCups(codigoExamen,cups)	{		var parametros = "consultaAjax=asicup&wemp_pmla="+document.forms.forma.wemp_pmla.value+"&seguridad=" +document.getElementById('wseguridad').value+"&basedatos="+document.forms.forma.wbasedato.value+"&basedatoshce="+document.forms.forma.wbasedatohce.value+"&wexamen="+codigoExamen+"&wcups="+cups;		try		{			var ajax = nuevoAjax();			ajax.open("POST", "homologacion_examenes.php",false);			ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");			ajax.send(parametros);			if(ajax.responseText!="ok")				alert('El código cups ingresado no se pudo asignar, verifique el valor');		}catch(e){	}		//listaExamenes();	}	 	 // Llamado ajax para asignar el servicio al examen	function asignarServicio(codigoExamen,campo)	{		// asigno el servicio seleccionado		var sersel = campo.value;				var parametros = "consultaAjax=asiserexa&wemp_pmla="+document.forms.forma.wemp_pmla.value+"&seguridad=" +document.getElementById('wseguridad').value+"&basedatos="+document.forms.forma.wbasedato.value+"&basedatoshce="+document.forms.forma.wbasedatohce.value+"&wexamen="+codigoExamen+"&wservicio="+sersel;		try		{			var ajax = nuevoAjax();			ajax.open("POST", "homologacion_examenes.php",false);			ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");			ajax.send(parametros);			//if(ajax.responseText!="ok")				//alert(ajax.responseText);		}catch(e){	}		//listaExamenes();	}	function asignarTipoEstudio(codigoExamen,campo)	{		// asigno el tipo de estudio seleccionado		var tipestsel = campo.value;				var parametros = "consultaAjax=asitipestexa&wemp_pmla="+document.forms.forma.wemp_pmla.value+"&seguridad=" +document.getElementById('wseguridad').value+"&basedatos="+document.forms.forma.wbasedato.value+"&basedatoshce="+document.forms.forma.wbasedatohce.value+"&wexamen="+codigoExamen+"&wtipoestudio="+tipestsel;		try		{			var ajax = nuevoAjax();			ajax.open("POST", "homologacion_examenes.php",false);			ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");			ajax.send(parametros);			//if(ajax.responseText!="ok")				//alert(ajax.responseText);		}catch(e){	}		//listaExamenes();	}	function asignarAnatomia(codigoExamen,campo)	{		// asigno la anatomia seleccionada		var anasel = campo.value;				var parametros = "consultaAjax=asianaexa&wemp_pmla="+document.forms.forma.wemp_pmla.value+"&seguridad=" +document.getElementById('wseguridad').value+"&basedatos="+document.forms.forma.wbasedato.value+"&basedatoshce="+document.forms.forma.wbasedatohce.value+"&wexamen="+codigoExamen+"&wanatomia="+anasel;		try		{			var ajax = nuevoAjax();			ajax.open("POST", "homologacion_examenes.php",false);			ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");			ajax.send(parametros);			//if(ajax.responseText!="ok")				//alert(ajax.responseText);		}catch(e){	}		//listaExamenes();	}		function asignarClaseEexamen(codigoExamen,campo)	{		// asigno la clase de examen seleccionado		var claexasel = campo.value;				var parametros = "consultaAjax=asiclaexa&wemp_pmla="+document.forms.forma.wemp_pmla.value+"&seguridad=" +document.getElementById('wseguridad').value+"&basedatos="+document.forms.forma.wbasedato.value+"&basedatoshce="+document.forms.forma.wbasedatohce.value+"&wexamen="+codigoExamen+"&wclaseexamen="+claexasel;		try		{			var ajax = nuevoAjax();			ajax.open("POST", "homologacion_examenes.php",false);			ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");			ajax.send(parametros);			//if(ajax.responseText!="ok")				//alert(ajax.responseText);		}catch(e){	}		//listaExamenes();	}		function asignarNopos(codigoExamen,campo)	{		// asigno el valor para Es No POS		if(campo.checked)			var noposcheck = 'off';		else			var noposcheck = 'on';				var parametros = "consultaAjax=asinoposexa&wemp_pmla="+document.forms.forma.wemp_pmla.value+"&seguridad=" +document.getElementById('wseguridad').value+"&basedatos="+document.forms.forma.wbasedato.value+"&basedatoshce="+document.forms.forma.wbasedatohce.value+"&wexamen="+codigoExamen+"&wnopos="+noposcheck;		try		{			var ajax = nuevoAjax();			ajax.open("POST", "homologacion_examenes.php",false);			ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");			ajax.send(parametros);			//if(ajax.responseText!="ok")				//alert(ajax.responseText);		}catch(e){	}				//listaExamenes();	}			function alertaCambioCodigo(idDiv)	{		if(confirm('Si cambia el nuevo código este se eliminará. Está seguro?'))		{			$("#tmp"+idDiv).hide();			$("#"+idDiv).show();			$("#"+idDiv).trigger('click');					}		else		{			return false;		}	}			function eliminarExamenNuevo(codigoExamen,campo,idTr)	{		// asigno el tipo de estudio seleccionado		if(campo.checked)		{		  if(confirm("Está seguro que desea eliminar el examen?"))		  {			var parametros = "consultaAjax=eliexanue&wemp_pmla="+document.forms.forma.wemp_pmla.value+"&seguridad=" +document.getElementById('wseguridad').value+"&basedatos="+document.forms.forma.wbasedato.value+"&basedatoshce="+document.forms.forma.wbasedatohce.value+"&wexamen="+codigoExamen;			try			{				var ajax = nuevoAjax();				ajax.open("POST", "homologacion_examenes.php",false);				ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");				ajax.send(parametros);				//if(ajax.responseText!="ok")					//alert(ajax.responseText);							$('#'+idTr).hide('slow');			}catch(e){	}					//listaExamenes();		  }		  else		  {			campo.checked = false;		  }		}			}		function homologarExamenNuevo(codigoExamen,idTr,indice)	{				// asigno el tipo de estudio seleccionado		// if(confirm("Está seguro que ha finalizado la homologación?"))		// {			var codigoCups = document.getElementById('codcups'+indice).value;						if( $.trim( codigoCups ) != "" ){								var cupValido 	= false;				var datosCups 	= validoCups(codigoCups);								if( datosCups ){										if( datosCups.data.estado == 'on' ){						cupValido = true;					}				}							if( !cupValido )				{					alert( "El codigo cups no es valido" );					// var nonmbreCups = prompt('Digite la descripción de este CUPS nuevo','');										// if( $.trim(nonmbreCups) != '' ){						// agregarCups(nonmbreCups = $('textarea#Descripcion-'+codigoExamen).val(),codigoCups,codigoExamen);					// }					// else{						// alert( "El nombre del CUPS no puede ser vacío" );					// }				}				else{										var descripcion = $('textarea#Descripcion-'+codigoExamen).val();										homologarExamen(codigoExamen, codigoCups, descripcion );										var fndCodigo 		= $('#fndCodigo').val();					var fndDescripcion	= $('#fndDescripcion').val();					var fndServicio		= $('#fndServicio').val();					var fndTipoestudio 	= $('#fndTipoestudio').val();					var fndAnatomia		= $('#fndAnatomia').val();					var fndCodcups		= $('#fndCodcups').val();					var fndClase		= $('#fndClase').val();					var fndNoPos		= $('#fndNoPos').val();															if( fndCodigo != "" || fndDescripcion != "" || fndServicio != "" || fndTipoestudio != "" || fndAnatomia != "" || fndCodcups!= "" || fndClase != "" || fndNoPos != "" )					{										$( "#buscar_homologados" ).click();										}else{															actualizar();										}				}								document.getElementById('codcups'+indice).value = '';			}			else{				alert( "El codigo cups no puede ser vacío" );			}		// }	}		function homologarExamen( codigoExamen, codigoCups, descripcion ){			var parametros = "consultaAjax=homexanue&wemp_pmla="+document.forms.forma.wemp_pmla.value+"&seguridad=" +document.getElementById('wseguridad').value+"&basedatos="+document.forms.forma.wbasedato.value+"&basedatoshce="+document.forms.forma.wbasedatohce.value+"&wexamen="+codigoExamen+"&codigoCups="+codigoCups+"&descripcion="+descripcion;		try		{			var ajax = nuevoAjax();			ajax.open("POST", "homologacion_examenes.php",false);			ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");			ajax.send(parametros);			//if(ajax.responseText!="ok")				//alert(ajax.responseText);						//$('#'+idTr).hide('slow');						document.getElementById('fndCodigoH').value = 'codigo';					listarExamenesNuevos();						listarExamenes();		}catch(e){	}	}	function correccionExamen(codigoExamen,idTr)	{				 $.blockUI({ message:	'<img src="../../images/medical/ajax-loader.gif" >',						css: 	{									width: 	'auto',									height: 'auto'								}				 });				var parametros = "consultaAjax=corexa&wemp_pmla="+document.forms.forma.wemp_pmla.value+"&seguridad=" +document.getElementById('wseguridad').value+"&basedatos="+document.forms.forma.wbasedato.value+"&basedatoshce="+document.forms.forma.wbasedatohce.value+"&wexamen="+codigoExamen;		try		{			var ajax = nuevoAjax();			ajax.open("POST", "homologacion_examenes.php",false);			ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");			ajax.send(parametros);			//if(ajax.responseText!="ok")				//alert(ajax.responseText);						//$('#'+idTr).hide('slow');			document.getElementById('fndCodigoH').value = codigoExamen;						listarExamenesNuevos();						listarExamenes();						$('html, body').animate({scrollTop: '0px'},1500);			  			$.unblockUI();								}catch(e){	}	}	function listarExamenesNuevos()	{			var codigoExamen = document.getElementById('fndCodigoH').value;		var nonmbreExamen = document.getElementById('fndDescripcionH').value;		var servicio = document.getElementById('fndServicioH').options[ document.getElementById('fndServicioH').selectedIndex ].value;		var tipoEstudio = document.getElementById('fndTipoestudioH').options[ document.getElementById('fndTipoestudioH').selectedIndex ].value;		var anatomia = document.getElementById('fndAnatomiaH').options[ document.getElementById('fndAnatomiaH').selectedIndex ].value;		var codigoCups = document.getElementById('fndCodcupsH').value;		var clase = document.getElementById('fndClaseH').options[ document.getElementById('fndClaseH').selectedIndex ].value;		var noPos = document.getElementById('fndNoPosH').value;				var total_registros = $("#total_registros").val();		var registros_pagina = $("#registros_pagina").val();				if(codigoExamen=='' || codigoExamen==' ' || codigoExamen=='codigo')		{			codigoExamen = '%';		}		if(nonmbreExamen=='' || nonmbreExamen==' ' || nonmbreExamen=='descripcion')		{			nonmbreExamen = '%';		}		if(codigoCups=='' || codigoCups==' ' || codigoCups=='codigo cups')		{			codigoCups = '%';		}				var total_registros = $("#total_registros").val();		registros_pagina = $("#registros_pagina").val();		var wemp_pmla = $("#wemp_pmla").val();		var wbasedato = $("#wbasedato").val();		var wbasedatohce = $("#wbasedatohce").val();		var wseguridad = $("#wseguridad").val();		var nro_pagina = $("#nro_pagina").val();				$.ajax({				url: "homologacion_examenes.php",				type: "POST",				data:{										consultaAjax: 		'consultar_registros',										wemp_pmla:      	wemp_pmla,					wbasedato:      	wbasedato,					wbasedatohce:		wbasedatohce,					wseguridad:			wseguridad,					registros_inicial:	(1*registros_pagina) - registros_pagina,					registros_final:	registros_pagina,								descripcion: 		nonmbreExamen,					servicio: 			servicio,					tipoEstudio: 		tipoEstudio,					anatomia: 			anatomia,					codigoCups: 		codigoCups,					clase: 				clase,					noPos: 				noPos,					codigo: 			codigoExamen				},							async: false,				dataType: "json",				success:function(data_json) {								if (data_json.error == 1)					{						alert(data_json.mensaje);						return;					}					else{																						$('#examenesNuevos').html(data_json.html);						$.unblockUI();					}										total_reg = data_json.total_registros;									}			}		).done(function(){																inicializarAutocompletar();										//-					$('#paginador').smartpaginator({												totalrecords: total_reg, 					recordsperpage: registros_pagina, 					length: 7, 					next: 'Sig', 					prev: 'Atrás', 					first: 'Inicio', 					last: 'Ulti',					go: 'Ir',					theme: 'black',					controlsalways: true, 					onchange: 										function (newPage) {														$.blockUI({ message:	'<img src="../../images/medical/ajax-loader.gif" >',									css: 	{												width: 	'auto',												height: 'auto'											}							 });														$.ajax({								url: "homologacion_examenes.php",								type: "POST",								data:{																	consultaAjax: 		'consultar_registros',														wemp_pmla:      	wemp_pmla,									wbasedato:      	wbasedato,									wbasedatohce:		wbasedatohce,									wseguridad:			wseguridad,									registros_inicial:	(newPage*registros_pagina) - registros_pagina,									registros_final:	registros_pagina,									descripcion: 		nonmbreExamen,									servicio: 			servicio,									tipoEstudio: 		tipoEstudio,									anatomia: 			anatomia,									codigoCups: 		codigoCups,									clase: 				clase,									noPos: 				noPos								},											async: false,								dataType: "json",								success:function(data_json) {																if (data_json.error == 1)									{										alert(data_json.mensaje);										return;									}									else{																														$('#examenesNuevos').html(data_json.html);										$.unblockUI();									}								}							}						).done(function(){																	inicializarAutocompletar();														});										}				});				//-						});						return false;	}		function actualizar(){		  $.blockUI({ message:	'<img src="../../images/medical/ajax-loader.gif" >',						css: 	{									width: 	'auto',									height: 'auto'								}				 });				 	  location.reload();	 			}			function listarExamenes()	{				var codigoExamen = document.getElementById('fndCodigo').value;		var nonmbreExamen = document.getElementById('fndDescripcion').value;		var servicio = document.getElementById('fndServicio').options[ document.getElementById('fndServicio').selectedIndex ].value;		var tipoEstudio = document.getElementById('fndTipoestudio').options[ document.getElementById('fndTipoestudio').selectedIndex ].value;		var anatomia = document.getElementById('fndAnatomia').options[ document.getElementById('fndAnatomia').selectedIndex ].value;		var codigoCups = document.getElementById('fndCodcups').value;		var clase = document.getElementById('fndClase').options[ document.getElementById('fndClase').selectedIndex ].value;		var noPos = document.getElementById('fndNoPos').value;				var total_registros = $("#total_registros").val();		var registros_pagina = $("#registros_pagina").val();				if(codigoExamen=='' || codigoExamen==' ' || codigoExamen=='codigo')		{			codigoExamen = '%';		}		if(nonmbreExamen=='' || nonmbreExamen==' ' || nonmbreExamen=='descripcion')		{			nonmbreExamen = '%';		}		if(codigoCups=='' || codigoCups==' ' || codigoCups=='codigo cups')		{			codigoCups = '%';		}				var total_registros = $("#total_registros").val();		registros_pagina = $("#registros_pagina").val();		var wemp_pmla = $("#wemp_pmla").val();		var wbasedato = $("#wbasedato").val();		var wbasedatohce = $("#wbasedatohce").val();		var wseguridad = $("#wseguridad").val();		var nro_pagina = $("#nro_pagina").val();				$.ajax({				url: "homologacion_examenes.php",				type: "POST",				data:{										consultaAjax: 		'consultar_registros_homologados',										wemp_pmla:      	wemp_pmla,					wbasedato:      	wbasedato,					wbasedatohce:		wbasedatohce,					wseguridad:			wseguridad,					registros_inicial:	(1*registros_pagina) - registros_pagina,					registros_final:	registros_pagina,								descripcion: 		nonmbreExamen,					servicio: 			servicio,					tipoEstudio: 		tipoEstudio,					anatomia: 			anatomia,					codigoCups: 		codigoCups,					clase: 				clase,					noPos: 				noPos,					codigo:				codigoExamen				},							async: false,				dataType: "json",				success:function(data_json) {								if (data_json.error == 1)					{						alert(data_json.mensaje);						return;					}					else{																						$('#examenesMaestro').html(data_json.html);						$.unblockUI();					}										total_reg_homolo = data_json.total_registros;									}			}		).done(function(){																		//-					$('#paginadorhomologados').smartpaginator({												totalrecords: total_reg_homolo, 					recordsperpage: registros_pagina, 					length: 7, 					next: 'Sig', 					prev: 'Atrás', 					first: 'Inicio', 					last: 'Ulti',					go: 'Ir',					theme: 'black',					controlsalways: true, 					onchange: 										function (newPage) {														$.blockUI({ message:	'<img src="../../images/medical/ajax-loader.gif" >',									css: 	{												width: 	'auto',												height: 'auto'											}							 });														$.ajax({								url: "homologacion_examenes.php",								type: "POST",								data:{																	consultaAjax: 		'consultar_registros_homologados',														wemp_pmla:      	wemp_pmla,									wbasedato:      	wbasedato,									wbasedatohce:		wbasedatohce,									wseguridad:			wseguridad,									registros_inicial:	(newPage*registros_pagina) - registros_pagina,									registros_final:	registros_pagina,									descripcion: 		nonmbreExamen,									servicio: 			servicio,									tipoEstudio: 		tipoEstudio,									anatomia: 			anatomia,									codigoCups: 		codigoCups,									clase: 				clase,									noPos: 				noPos,									codigo:				codigoExamen								},											async: false,								dataType: "json",								success:function(data_json) {																if (data_json.error == 1)									{										alert(data_json.mensaje);										return;									}									else{																														$('#examenesMaestro').html(data_json.html);										$.unblockUI();									}								}							}						)}				});				//-						});						return false;					}	function agregarExamen()	{		var codigoExamen = document.getElementById('wcodigo').value;		var nonmbreExamen = document.getElementById('Descripcion').value;		var servicio = document.getElementById('Servicio').options[ document.getElementById('Servicio').selectedIndex ].value;		var tipoEstudio = document.getElementById('Tipoestudio').options[ document.getElementById('Tipoestudio').selectedIndex ].value;		var anatomia = document.getElementById('Anatomia').options[ document.getElementById('Anatomia').selectedIndex ].value;		var codigoCups = document.getElementById('codcups').value;		var clase = document.getElementById('Clase').options[ document.getElementById('Clase').selectedIndex ].value;		var chkNoPos = document.getElementById('NoPos').checked;						if(chkNoPos)			noPos = 'off';		else			noPos = 'on';				if(codigoExamen=='' || codigoExamen==' ')		{			alert('Debe ingresar el código del procedimiento o examen');			return false;		}		if(nonmbreExamen=='' || nonmbreExamen==' ')		{			alert('Debe ingresar el nombre del procedimiento o examen');			return false;		}		if(servicio=='' || servicio=='0')		{			alert('Debe seleccionar el servicio del procedimiento o examen');			return false;		}		if(tipoEstudio=='' || tipoEstudio=='0')		{			alert('Debe seleccionar el tipo de estudio del procedimiento o examen');			return false;		}				if( $.trim( codigoCups ) == '' ){			alert('Debe seleccionar un codigo cups');			return false;		}				parametros = "consultaAjax=addexa&wemp_pmla="+document.getElementById('wemp_pmla').value+"&seguridad=" +document.getElementById('wseguridad').value+"&basedatos="+document.getElementById('wbasedato').value+"&basedatoshce="+document.getElementById('wbasedatohce').value+"&codigo="+codigoExamen+"&descripcion="+nonmbreExamen+"&servicio="+servicio+"&tipoEstudio="+tipoEstudio+"&anatomia="+anatomia+"&codigoCups="+codigoCups+"&clase="+clase+"&noPos="+noPos;		//alert(parametros);		try		{			//$.blockUI({ message: $('#msjEspere') });			var ajax = nuevoAjax();			ajax.open("POST", "homologacion_examenes.php",true);			ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");			ajax.send(parametros);						ajax.onreadystatechange=function()			{ 				if (ajax.readyState==4 && ajax.status==200)				{					if(ajax.responseText=='Ok')					{						$('#addexamen').each (function(){							this.reset();						});												$('#addWarning').hide('fast');						$('#addOk').show('slow');												listarExamenes();					}					else					{						$('#addWarning').html( ajax.responseText );						$('#addOk').hide('fast');						$('#addWarning').show('slow');					}				}				//$.unblockUI();			}			if ( !estaEnProceso(ajax) ) {				ajax.send(null);			}		}catch(e){	}	}	function agregarCups(nonmbreCups,codigoCups,codigo)	{		parametros = "consultaAjax=addcup&wemp_pmla="+document.getElementById('wemp_pmla').value+"&seguridad=" +document.getElementById('wseguridad').value+"&basedatos="+document.getElementById('wbasedato').value+"&basedatoshce="+document.getElementById('wbasedatohce').value+"&codigoCups="+codigoCups+"&descripcion="+nonmbreCups+"&examen="+codigo;		//alert(parametros);		try		{			//$.blockUI({ message: $('#msjEspere') });			var ajax = nuevoAjax();			ajax.open("POST", "homologacion_examenes.php",true);			ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");			ajax.send(parametros);						ajax.onreadystatechange=function()			{ 				if (ajax.readyState==4 && ajax.status==200)				{					if(ajax.responseText!='Ok')					{						alert(ajax.responseText);						return false;					}					else					{						homologarExamen(codigo, codigoCups, nonmbreCups );					}				}				//$.unblockUI();			}			if ( !estaEnProceso(ajax) ) {				ajax.send(null);			}		}catch(e){	}	}			</script>	</head>	<body><?php
include_once("conex.php");	/*	 ********************** HOMOLOGACIÓN DE PROCEDIMIENTOS Y EXAMENES ********************************	 ****************************** DESCRIPCIÓN ******************************************************	 * Muestra los examenes nuevo que se han agregado por el programa de ordenes y permit su homologación	 * en el maestro de procedimientos y exámenes de modo que se puedan completar los datos de estos	 * nuevos exámenes	 *************************************************************************************************	 * Autor: John M. Cadavid. G.	 * Fecha creacion: 2013-07-10	 *************************************************************************************************	 * MODIFICACIONES	 *************************************************************************************************	 * 2018-05-02 (Edwin) Se valida que el código cups este activo para poderlo homologar	 * 2018-02-26 (Edwin) Al elminar un examen se pone el campo nuevo off para que no vuelvan a salir los procedimientos cups eliminados en la sección procedimientos no homologados	 * 2017-09-26 (Edwin) Se valida que el codigo cups este activo	 * 2016-03-03 (Edwin) Permite la busqueda de procedimientos y examenes por código en homologados y muestra los procedimientos que no tengan servicio y/o unidad que realiza	 * 2016-02-18 (Edwin) Al elminar un examen se pone el campo nuevo off para que no salgan los procedimientos cups eliminados	 * 2016-02-01 (Edwin) En la función listarExamenesNuevos se cambia la función utf8_decode por utf8_encode al mostrar medicamentos.	 * 2015-07-31 (Jonatan) Se corrige el caracter ñ para que registre correctamente.	 * 2015-03-31 (Jonatan) Al seleccionar eliminar en un procedimiento inactiva el registro, no lo elimina.	 * 2015-01-30 (Jonatan) Se ordenan los examenes nuevos por fecha de registro, primero los mas nuevos o lo ultimo que se haya registrado.	 * 2014-07-03 (Jonatan) Se corrigen algunos filtros de la interfaz, ademas se corrige para que el servicio y el tipo de orden si se muestren al modificar.	 * 2014-06-19 (Jonatan) Se modifica la funcionalidad de cambio de descripcion, al modificar hace scroll automatico, si modifican un registro					y estan haciendo busquedas, deja la consulta que tenia.		 * 2014-04-01 - Se valida la sessión de usuario	 *			  - Se impide agregar cups nuevos	 *			  - Se agrega columna de quién crea el procedimiento nuevo en la lista de procedimientos NO homologados	 *			  - Se agrega columna para saber qué usuario homologa en la lista de procedimientos homologados	 * 2014-03-18 - Al eliminar examen se evita que se borren los registros, solo se desactivan	 * 2013-09-05 - En la función homologarExamenNuevo de javascript se agregó la validación si el código CUPS 	 * no existe, entonces se llama por ajax a la función php guardarCups que permite guardar los campos de 	 * un nuevo CUPS - Mario Cadavid	 *************************************************************************************************	 */	/********************************************************************************************	****************************** INICIO APLICACIÓN ********************************************	********************************************************************************************/	$wbasedato = "";	$wactualiz = " Mayo 2 de 2018 ";	// Validación de usuario	if (!isset($_SESSION['user']))	{		exit( "LA SESSION HA CADUCADO. POR FAVOR CIERRE LAS VENTANAS Y VUELVA A INTENTARLO" );	}	// $user="";		//Codigo de usuario que ingreso al sistema	if (strpos($user, "-") > 0)		$wuser = substr($user, (strpos($user, "-") + 1), strlen($user));	else		$wuser="";	$usuario = new Usuario();	$usuario->codigo = $wuser;	//Variable para determinar la empresa	if(!isset($wemp_pmla))	{		terminarEjecucion($MSJ_ERROR_FALTA_PARAMETRO."wemp_pmla");	}	//Valida codigo de usuario en sesion si no esta registrado el sistema termina la ejecucion    if (!isset($_SESSION['user']))    {        terminarEjecucion("<div align='center'>Usuario no autenticado.  Por favor cierre esta ventana y vuelva a ingresar a Matrix.</div>");    }    else    {        //Conexion base de datos Matrix        $institucion = consultarInstitucionPorCodigo($conex, $wemp_pmla);        $winstitucion = $institucion->nombre;        $wbasedatohce = consultarAliasPorAplicacion($conex, $wemp_pmla, "hce");        $wbasedato = consultarAliasPorAplicacion($conex, $wemp_pmla, "movhos");        $registros_pagina = consultarAliasPorAplicacion($conex, $wemp_pmla, "RegistrosPaginadorHomologacion");				echo "<table align='center' width='100%'><tr><td>";        // Definición del encabezado del aplicativo        encabezado("HOMOLOGACIÓN DE PROCEDIMIENTOS Y EXAMENES", $wactualiz, "clinica");        //Formulario (addexamen)        echo "<form name='addexamen' id='addexamen' action='' method='post'>";		echo "<div align='center'> &nbsp; <input type='button' value='Actualizar' onclick='actualizar();'>  &nbsp;</div>";				echo "<div class='linkadd' style='display:inline; width:150px; height:21px;' id='divAdd'> &nbsp; <b>Agregar examen</b> &nbsp;</div>";		echo "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";		echo "<div id='addOk' style='display:inline; font-weight:bold; color:#336699;'><img src='../../images/medical/root/grabar.png' border='0' /> &nbsp; Examen guardado</div>";		echo "<div id='addWarning' style='display:inline; font-weight:bold; color:#A52A2A;'>El examen no se pudo guardar, por favor verifique la informaci&oacute;n y vuelva a intentarlo</div>";				echo "</form>";        //Formulario (forma)        echo "<form name='forma' action='' method='post'>";        echo "<input type='hidden' id='wemp_pmla' name='wemp_pmla' value='".$wemp_pmla."'>";        echo "<input type='hidden' id='wbasedato' name='wbasedato' value='".$wbasedato."'>";        echo "<input type='hidden' id='wbasedatohce' name='wbasedatohce' value='".$wbasedatohce."'>";		echo "<input type='hidden' id='wseguridad' name='wseguridad' value='".$wuser."'>";        // echo "<input type='hidden' id='conex' name='conex' value='".$conex."'>";        echo "<input type='hidden' id='registros_pagina' name='registros_pagina' value='".$registros_pagina."'>";				if(!$pagina){						$pagina = 1;		}		        echo "<input type='hidden' id='nro_pagina' name='nro_pagina' value='".$pagina."'>";		echo "<div id='paginador' style='margin: auto;'></div>";				echo "<div id='tablaAdd' style='display:none; position:relative; padding-top:10px;padding-bottom:10px;'>";		echo "<table id='nuevoExamen' style='border: 1px solid #999999;' align='center' width='100%'>";		nuevoExamen($wemp_pmla,$usuario->codigo,$wbasedato,$wbasedatohce);        echo "</table>";		echo "</div>";		echo "<div id='examenesNuevos'>";		listaExamenesNuevos($wemp_pmla,$usuario->codigo,$wbasedato,$wbasedatohce);		echo "</div>";		echo "<br /><br />";				echo "<div id='paginadorhomologados' style='margin: auto;'></div>";				echo "<div id='examenesMaestro'>";		listaExamenes($wemp_pmla,$usuario->codigo,$wbasedato,$wbasedatohce);		echo "</div>";        echo "</form>";        //Botones "Actualizar" y "Cerrar ventana"        echo "<br /><p align='center'><input type='button' value='Cerrar ventana' onclick='cerrarVentana();'></p>";        echo "</div><br />"; //Cierre div id=page				echo "</td></tr><table>";    }} // Fin si no es consulta por AJAX/********************************************************************************************* **************************	FUNCIONES DE LLAMADO AJAX ************************************* ********************************************************************************************/// Prepara el comodin espacio por '%' de sqlfunction prepararCriterio($criterio){	return str_replace(" ","%",$criterio);}   function consultarCups($wemp_pmla,$seguridad,$basedatos,$basedatoshce,$dato,$codigo){	global $conex;	// Consulta de pacientes activos en urgencias	$q = " SELECT Codigo, Nombre			 FROM root_000012			WHERE ( Nombre LIKE '%".$dato."%'			   OR Codigo LIKE '%".$dato."%' )			  AND Estado = 'on'			GROUP BY Codigo			ORDER BY Nombre			LIMIT 0, 50	";	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	$num = mysql_num_rows($res);	while ($row = mysql_fetch_array($res))	{		echo htmlentities(@$row['Codigo']."-".@trim(utf8_decode($row['Nombre'])))."|".@$row['Codigo']."|".@$codigo."\n";	}} // Retorna un arreglo con los servicios actuales en Matrixfunction consultarServicios($wbasedato){	global $conex;	$q1=  "	SELECT Ccocod, Cconom "		 ."   FROM ".$wbasedato."_000011 "		 ."  WHERE Ccoest = 'on' "		 ."    AND ( Ccohos = 'on' "		 ."     OR Ccourg = 'on' "		 ."     OR Ccocir = 'on' "		 ."     OR Ccoing = 'on' "		 ."     OR Ccoayu = 'on' ) "		 ."  GROUP BY Ccocod "		 ."  ORDER BY Cconom ASC ";	$res1 = mysql_query($q1,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q1 . " - " . mysql_error());  	$num1 = mysql_num_rows($res1);  	$coleccion = array();  	if ($num1 > 0 )  	{  		for ($i=1;$i<=$num1;$i++)  		{  			$ser = new serviciosMatrix();  			$row1 = mysql_fetch_array($res1);  			$ser->codigo = $row1[0];  			$ser->nombre = $row1[1];  			$coleccion[] = $ser;  		}  	}  	return $coleccion;}// Retorna un arreglo con los tipos de estudio actuales en Matrixfunction consultarTiposEstudios($wbasedatohce){	global $conex;	$q1=  "	SELECT Codigo, Descripcion "		 ."   FROM ".$wbasedatohce."_000015 "		 ."  WHERE Estado = 'on' "		 ."  GROUP BY Codigo "		 ."  ORDER BY Descripcion ASC ";	$res1 = mysql_query($q1,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q1 . " - " . mysql_error());  	$num1 = mysql_num_rows($res1);  	$coleccion = array();  	if ($num1 > 0 )  	{  		for ($i=1;$i<=$num1;$i++)  		{  			$tip = new tiposEstudiosMatrix();  			$row1 = mysql_fetch_array($res1);  			$tip->codigo = $row1[0];  			$tip->nombre = $row1[1];  			$coleccion[] = $tip;  		}  	}  	return $coleccion;}// Retorna un arreglo con las anatomias actuales en Matrixfunction consultarAnatomias($wbasedatohce){	global $conex;	$q1=  "	SELECT Codigo, Descripcion "		 ."   FROM ".$wbasedatohce."_000016 "		 ."  WHERE Estado = 'on' "		 ."  GROUP BY Codigo "		 ."  ORDER BY Descripcion ASC ";	$res1 = mysql_query($q1,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q1 . " - " . mysql_error());  	$num1 = mysql_num_rows($res1);  	$coleccion = array();  	if ($num1 > 0 )  	{  		for ($i=1;$i<=$num1;$i++)  		{  			$ana = new anatomiasMatrix();  			$row1 = mysql_fetch_array($res1);  			$ana->codigo = $row1[0];  			$ana->nombre = utf8_encode($row1[1]);  			$coleccion[] = $ana;  		}  	}  	return $coleccion;}// Retorna un arreglo con las anatomias actuales en Matrixfunction consultarAnatomias2($wbasedatohce){	global $conex;	$q1=  "	SELECT Codigo, Descripcion "		 ."   FROM ".$wbasedatohce."_000016 "		 ."  WHERE Estado = 'on' "		 ."  GROUP BY Codigo "		 ."  ORDER BY Descripcion ASC ";	$res1 = mysql_query($q1,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q1 . " - " . mysql_error());  	$num1 = mysql_num_rows($res1);  	$coleccion = array();  	if ($num1 > 0 )  	{  		for ($i=1;$i<=$num1;$i++)  		{  			$ana = new anatomiasMatrix();  			$row1 = mysql_fetch_array($res1);			$codigo = $row1[0];  			$coleccion[$codigo] = $row1[1];  		}  	}  	return $coleccion;}// Retorna un arreglo con las clases para los exámenesfunction consultarClasesExamenes(){	global $conex;  	$coleccion = array();	$cla = new clasesExamenesMatrix();	$cla->codigo = 'E';	$cla->nombre = 'Examen';	$coleccion[] = $cla;	$cla = new clasesExamenesMatrix();	$cla->codigo = 'C';	$cla->nombre = 'Consulta';	$coleccion[] = $cla;	$cla = new clasesExamenesMatrix();	$cla->codigo = 'P';	$cla->nombre = 'Procedimiento';	$coleccion[] = $cla;  	return $coleccion;}// Retorna un arreglo con las clases para los exámenesfunction consultarTipos(){	global $conex;  	$coleccion = array();	$tip = new tiposPosMatrix();	$tip->codigo = 'off';	$tip->nombre = 'POS';	$coleccion[] = $tip;	$tip = new tiposPosMatrix();	$tip->codigo = 'on';	$tip->nombre = 'No POS';	$coleccion[] = $tip;  	return $coleccion;}// Realiza el update sobre el maestro de exámenes para asignar el código cupsfunction verificarCups($wemp_pmla,$seguridad,$wbasedato,$wbasedatohce,$cups){	global $conex;		$data = array(				'error' => 0,				'msg' 	=> '',			);		$valCups = explode('-',$cups);	$cups = $valCups[0];		// Consulto los datos del examen actualemnte guardados en hce 000017	$q1=  "	SELECT Codigo, Estado "		 ."   FROM root_000012 "		 ."  WHERE Codigo = '".$cups."' ";		 // ."    AND Estado = 'on' ";	$res1 = mysql_query($q1,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q1 . " - " . mysql_error());  	$num1 = mysql_num_rows($res1);		if($num1>0){				$rows = mysql_fetch_array( $res1 );				$data = array(					'error' => 0,					'msg' 	=> 'ok',					'data' 	=> array(									'codigo' => $rows[ 'Codigo' ],									'estado' => $rows[ 'Estado' ],								),				);				// return 'ok';	}	else{				$data = array(					'error' => 1,					'msg' 	=> 'No asignado',				);				// return 'no-asignado';	}		return json_encode( $data );}// Realiza el update sobre el maestro de exámenes para asignar el código cupsfunction asignarCups($wemp_pmla,$seguridad,$wbasedato,$wbasedatohce,$examen,$cups){	global $conex;	// Consulto los datos del examen actualemnte guardados en hce 000017	$q1=  "	SELECT Codigo "		 ."   FROM root_000012 "		 ."  WHERE Codigo = '".$cups."' ";	$res1 = mysql_query($q1,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q1 . " - " . mysql_error());  	$num1 = mysql_num_rows($res1);		if($num1>0)	{		$q=   "	UPDATE ".$wbasedatohce."_000017 "			 ."    SET Codcups = '".$cups."' "			 ."  WHERE Codigo = '".$examen."' ";		$res = mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		return 'ok';	}	else	{		return 'no-asignado';	}}// Realiza el update sobre el maestro de exámenes para asignar el serviciofunction asignarServicioExamen($wemp_pmla,$seguridad,$wbasedato,$wbasedatohce,$examen,$servicio){	global $conex;	$q=  "	UPDATE ".$wbasedatohce."_000017 "		 ."    SET Servicio = '".$servicio."' "		 ."  WHERE Codigo = '".$examen."' ";	$res = mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());  	//return 'ok';}// Realiza el update sobre el maestro de exámenes para asignar el tipo de estudiofunction asignarTipoEstudioExamen($wemp_pmla,$seguridad,$wbasedato,$wbasedatohce,$examen,$tipoestudio){	global $conex;	$q=  "	UPDATE ".$wbasedatohce."_000017 "		 ."    SET Tipoestudio = '".$tipoestudio."' "		 ."  WHERE Codigo = '".$examen."' ";	$res = mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());  	//return 'ok';}// Realiza el update sobre el maestro de exámenes para asignar la anatomia 	function asignarAnatomiaExamen($wemp_pmla,$seguridad,$wbasedato,$wbasedatohce,$examen,$anatomia){	global $conex;	$q=  "	UPDATE ".$wbasedatohce."_000017 "		 ."    SET Anatomia = '".$anatomia."' "		 ."  WHERE Codigo = '".$examen."' ";	$res = mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());  	//return 'ok';}// Realiza el update sobre el maestro de exámenes para asignar la clase de examen 	function asignarClaseExamen($wemp_pmla,$seguridad,$wbasedato,$wbasedatohce,$examen,$claseexamen){	global $conex;	$q=  "	UPDATE ".$wbasedatohce."_000017 "		 ."    SET Clase = '".$claseexamen."' "		 ."  WHERE Codigo = '".$examen."' ";	$res = mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());  	//return 'ok';}// Realiza el update sobre el maestro de exámenes para asignar el campo No POS	function asignarNoposExamen($wemp_pmla,$seguridad,$wbasedato,$wbasedatohce,$examen,$nopos){	global $conex;	$q=  "	UPDATE ".$wbasedatohce."_000017 "		 ."    SET NoPos = '".$nopos."' "		 ."  WHERE Codigo = '".$examen."' ";	$res = mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());  	//return 'ok';}// Elimina el examen a homologarfunction eliminarExamen($wemp_pmla,$seguridad,$wbasedato,$wbasedatohce,$examen){	global $conex;		 	$q=  "	UPDATE ".$wbasedatohce."_000017 "		 ."    SET estado = 'off', "		 ."         nuevo = 'off' "		 ."  WHERE Codigo = '".$examen."' ";	$res = mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());}// Hace el proceso de homologacion del examenfunction homologarExamen($wemp_pmla,$seguridad,$wbasedato,$wbasedatohce,$examen,$cups, $descripcion){	global $conex;	$homologado = false;		$descripcion = utf8_decode($descripcion);	// Defino datos a guardar	$medico = $wbasedatohce; 	$fecha_data = date('Y-m-d');	$hora_data = date('H:i:s');	$protocolo = '';	$estado = 'on';	$nuevo = 'off';	$valCups = explode('-',$cups);	$codigoCups = $valCups[0];		// Consulto los datos del examen actualemnte guardados en hce 000017	$q1=  "	SELECT * "		 ."   FROM ".$wbasedatohce."_000017 "		 ."  WHERE Codigo = '".$examen."' ";	$res1 = mysql_query($q1,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q1 . " - " . mysql_error());  	$num1 = mysql_num_rows($res1);	$row1 = mysql_fetch_array($res1);	// Verifico si ya existe el examen en la tabla de lenguaje americas	$q3=  "	SELECT Codigo "		 ."   FROM ".$wbasedatohce."_000047 "		 ."  WHERE Codigo = '".$examen."' ";	$res3 = mysql_query($q3,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q3 . " - " . mysql_error());  	$num3 = mysql_num_rows($res3);		// Si no existe el examen en la tabla de lenguaje americas, lo registro	if($num3==0)	{		$q = "	INSERT INTO 					".$wbasedatohce."_000047					(Medico,Fecha_data,Hora_data,Codigo,Descripcion,Servicio,Tipoestudio,Anatomia,Codcups,Protocolo,Estado,Clase,NoPos,Nuevo,Seguridad)					VALUES					('$medico','$fecha_data','$hora_data','".$row1['Codigo']."','".$descripcion."','".$row1['Servicio']."','".$row1['Tipoestudio']."','".$row1['Anatomia']."','".$codigoCups."','$protocolo','$estado','".$row1['Clase']."','".$row1['NoPos']."','$nuevo','C-$seguridad')";		$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	}	// Si existe el examen en la tabla de lenguaje americas, lo actualizo	else	{		$q = "	UPDATE 					".$wbasedatohce."_000047				SET					Codigo='".$row1['Codigo']."',Descripcion='".$descripcion."',Servicio='".$row1['Servicio']."',Tipoestudio='".$row1['Tipoestudio']."',Anatomia='".$row1['Anatomia']."',Codcups='".$codigoCups."',Estado='$estado',Clase='".$row1['Clase']."',NoPos='".$row1['NoPos']."',Nuevo='$nuevo',Seguridad='C-$seguridad'				WHERE					Codigo = '".$examen."'";		$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	}	// Si no hubo error en la homologación	if(mysql_affected_rows() > 0)		$homologado = true;		// Si la homologación fue exitosa	if($homologado)	{		// Verifico si en el maestro de examenes ya existía un código cups igual para otro examen		$q2=  "	SELECT Codigo "			 ."   FROM ".$wbasedatohce."_000017 "			 ."  WHERE Codcups = '".$codigoCups."' "			 ."	   AND Codigo != '".$examen."' ";		$res2 = mysql_query($q2,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());		$num2 = mysql_num_rows($res2);				// Si ya existia un código cups igual, borro el examen actual		// Queda guardado en la tabla de lenguaje américas		if($num2 > 0)		{			$q=  "	DELETE FROM ".$wbasedatohce."_000017 "				 ."  WHERE Codigo = '".$examen."' ";			$res = mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		}		// Cambio el estado al examen para que ya no esté pendiente de homologación		$q=  "	UPDATE ".$wbasedatohce."_000017 "			 ."    SET Nuevo = 'off' "			 ."  WHERE Codigo = '".$examen."' ";		$res = mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		$q=  "	UPDATE ".$wbasedatohce."_000047 "			 ."    SET Nuevo = 'off' "			 ."  WHERE Codigo = '".$examen."' ";		$res = mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		echo 'Ok';	}	else	{		echo 'El examen no se pudo guardar, por favor verifique la información y vuelva a intenatrlo';		}}// Modifica los registros del examen para que quede como pendiente de homologaciónfunction corregirExamen($wemp_pmla,$seguridad,$wbasedato,$wbasedatohce,$examen){	global $conex;	$correccion = false;	// $q=   "	UPDATE ".$wbasedatohce."_000047 "		 // ."    SET Nuevo = 'on' "		 // ."  WHERE Codigo = '".$examen."' ";	// $res = mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		// Defino datos a guardar	$medico = $wbasedatohce; 	$fecha_data = date('Y-m-d');	$hora_data = date('H:i:s');	$protocolo = '';	$estado = 'on';	$nuevo = 'on';	// Consulto los datos del examen actualemnte guardados en hce 000047	$q1=  "	SELECT * "		 ."   FROM ".$wbasedatohce."_000047 "		 ."  WHERE Codigo = '".$examen."' ";	$res1 = mysql_query($q1,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q1 . " - " . mysql_error());  	$num1 = mysql_num_rows($res1);	$row1 = mysql_fetch_array($res1);	// Verifico si ya existe el examen en el maestro de examenes	$q3=  "	SELECT Codigo "		 ."   FROM ".$wbasedatohce."_000017 "		 ."  WHERE Codigo = '".$examen."' ";	$res3 = mysql_query($q3,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q3 . " - " . mysql_error());  	$num3 = mysql_num_rows($res3);	//$row3 = mysql_fetch_array($res3);		if($num3==0)	{				//Se borra de la tabla 47 ya que va a ser modificado, ademas para que no salga doble cuando se haga union con la tabla 17.		$q=  "	DELETE FROM ".$wbasedatohce."_000047 "			 ."  WHERE Codigo = '".$row1['Codigo']."' ";		$res = mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());				$q = "	INSERT INTO 					".$wbasedatohce."_000017					(Medico,Fecha_data,Hora_data,Codigo,Descripcion,Servicio,Tipoestudio,Anatomia,Codcups,Protocolo,Estado,Clase,NoPos,Nuevo,Seguridad)					VALUES					('$medico','$fecha_data','$hora_data','".$row1['Codigo']."','".$row1['Descripcion']."','".$row1['Servicio']."','".$row1['Tipoestudio']."','".$row1['Anatomia']."','".$row1['Codcups']."','$protocolo','$estado','".$row1['Clase']."','".$row1['NoPos']."','$nuevo','C-$seguridad')";		$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());					}	else	{				//Se borra de la tabla 47 ya que va a ser modificado, ademas para que no salga doble cuanod se haga union con la tabla 17.		$q=  "	DELETE FROM ".$wbasedatohce."_000047 "			 ."  WHERE Codigo = '".$examen."' ";		$res = mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());				$q=  "	UPDATE ".$wbasedatohce."_000017 "			 ."    SET Nuevo = 'on', Estado = 'on' "			 ."  WHERE Codigo = '".$examen."' ";		$res = mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	}	if(mysql_affected_rows() > 0)		$correccion = true;		if($correccion)		echo 'Ok';	else		echo 'El examen no se pudo enviar para corregir';		  	//return 'ok';}// Actualiza el campo descripcion// function actualizarCampoTexto($wbasedatohce,$id,$value)// {	// global $conex;	// $data  = explode("-",$id);	// $campo = $data[0]; // nombre del campo	// $id    = $data[1]; // id del registro	// $value = $value; // valor por el cual reemplazar	// $alerta = '';		// if($data[0]!='Codigo')	// {		// $q=  "	UPDATE ".$wbasedatohce."_000017 "			 // ."    SET ".$campo." = '".$value."' "			 // ."  WHERE Codigo = '".$id."' ";		// $res = mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	// }	// else	// {		// if($id!=$value)		// {			// $q1=  "	SELECT id "				 // ."   FROM ".$wbasedatohce."_000017 "				 // ."  WHERE Codigo = '".$value."' ";			// $res1 = mysql_query($q1,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q1 . " - " . mysql_error());			// $num1 = mysql_num_rows($res1);			// if($num1>0)			// {				// $q=  "	UPDATE ".$wbasedatohce."_000028 "					 // ."    SET Detcod = '".$value."' "					 // ."  WHERE Detcod = '".$id."' ";				// $res = mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());				// $num_affect = mysql_affected_rows();				// if($num_affect>0)				// {								// $q=  "	DELETE FROM ".$wbasedatohce."_000017 "						 // ."  WHERE Codigo = '".$id."' ";					// $res = mysql_query($q,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());				// }				// else				// {					// $value = $id;					// $alerta = 'El examen aún no tiene ordenes asociadas';				// }			// }			// else			// {				// $alerta = 'El código a homologar no existe';			// }		// }	// }	// //echo $value.'|'.$alerta;		// echo $value;// }// Guarda los datos de un nuevo examenfunction guardarExamen($wemp_pmla,$seguridad,$basedatos,$basedatoshce,$codigo,$descripcion,$servicio,$tipoestudio,$anatomia,$codcups,$clase,$noPos){	global $conex;	$homologado = false;		$conExamenes = consultarAliasPorAplicacion($conex, $wemp_pmla, 'ConsecutivoExamenes');	// $conExamenes++;	$codigo = $conExamenes;	// Defino datos a guardar	$medico = $basedatoshce; 	$fecha_data = date('Y-m-d');	$hora_data = date('H:i:s');	$protocolo = '';	$estado = 'on';	$nuevo = 'off';	$i = 0;		$descripcion = strtoupper( $descripcion );			list( $codcups ) = explode( "-", $codcups );		// Válido que el código cups sea válido	$q = "SELECT *			FROM root_000012		   WHERE codigo = '$codcups'		  ";	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	if( mysql_num_rows( $res ) > 0 ){		// // Se consulta si el consecutivo de examenes que nos da root_000051 no existe		// $q = "SELECT				// Codigo 			// FROM				// ".$basedatoshce."_000017			// WHERE				// Codigo = '".$codigo."'			// AND Estado = 'on';";		// $resMax = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		// $numMax = mysql_num_rows($resMax);				// // Si el consecutivo de examenes existe siga consultando hasta que encuentre uno que no exista		// if($numMax>0) 		// {			do			{				$i++;				$codigo++;				$q = "SELECT						Codigo 					FROM						".$basedatoshce."_000017					WHERE						Codigo = '".$codigo."'					UNION					SELECT						Codigo 					FROM						".$basedatoshce."_000047					WHERE						Codigo = '".$codigo."'					;";							$resMax = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());				$numMax = mysql_num_rows($resMax);			} while( $numMax > 0);		// }					// Se graba en la tabla de lenguaje américas		$q = "	INSERT INTO 					".$basedatoshce."_000047					(Medico,Fecha_data,Hora_data,Codigo,Descripcion,Servicio,Tipoestudio,Anatomia,Codcups,Protocolo,Estado,Clase,NoPos,Nuevo,Seguridad)					VALUES					('$medico','$fecha_data','$hora_data','$codigo','$descripcion','$servicio','$tipoestudio','$anatomia','$codcups','$protocolo','$estado','$clase','$noPos','$nuevo','C-$seguridad')";		$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		if(mysql_affected_rows() > 0)			$homologado = true;				// Verifico si en el maestro de examenes ya existía un código cups igual		$q2=  "	SELECT * "			 ."   FROM ".$basedatoshce."_000017 "			 ."  WHERE Codcups = '".$codcups."' ";		$res2 = mysql_query($q2,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());		$num2 = mysql_num_rows($res2);		//$row2 = mysql_fetch_array($res2);				if($num2==0)		{			$q = "	INSERT INTO 						".$basedatoshce."_000017						(Medico,Fecha_data,Hora_data,Codigo,Descripcion,Servicio,Tipoestudio,Anatomia,Codcups,Protocolo,Estado,Clase,NoPos,Nuevo,Seguridad)						VALUES						('$medico','$fecha_data','$hora_data','$codigo','$descripcion','$servicio','$tipoestudio','$anatomia','$codcups','$protocolo','$estado','$clase','$noPos','$nuevo','C-$seguridad')";			$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		}				if($homologado)		{			//Aumento el consecutivo de los examenes			$sql = "UPDATE root_000051					   SET detval = detval+$i					 WHERE detemp = '".$wemp_pmla."'					   AND detapl = 'ConsecutivoExamenes'					";						$rs = mysql_query( $sql, $conex ) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());					echo 'Ok';		}		else			echo 'El examen no se pudo guardar, por favor verifique la información y vuelva a intenatrlo';	}	else{		echo "El código cups no es válido";	}}// Guarda los datos de un nuevo CUPSfunction guardarCups($wemp_pmla,$seguridad,$basedatos,$basedatoshce,$codigo,$descripcion,$examen){	global $conex;		$codigo = trim( $codigo );	$descripcion = trim( $descripcion );		if( !empty($codigo) ){			// Defino datos a guardar		$medico = 'root'; 		$fecha_data = date('Y-m-d');		$hora_data = date('H:i:s');				// Válido que el código cups sea válido		$q = "SELECT *			    FROM root_000012			   WHERE codigo = '$codigo'			  ";		$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());		if( mysql_num_rows( $res ) > 0){						// Asigno el nuevo código CUPS al examen			$q2 = "	UPDATE ".$basedatoshce."_000017 "				 ."    SET Codcups = '".$codigo."' "				 ."  WHERE Codigo = '".$examen."' ";			$res2 = mysql_query($q2,$conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());							echo 'Ok';		}		else{			echo "El código CUPS seleccionado no es válido";		}	}	else{		echo "El Código cups y la descripción no pueden ser vacíos.";	}}/*********************************************************************************** FORMULARIO DE ADICIÓN DE EXAMENEN *******************************************************************************************/function nuevoExamen($wemp_pmla,$seguridad,$basedatos,$basedatoshce){	//Variable para determinar la empresa	if(!isset($wemp_pmla))	{		terminarEjecucion($MSJ_ERROR_FALTA_PARAMETRO."wemp_pmla");	}	global $conex;	// Consulto el consecutivo actual en root_000051	$conExamenes = consultarAliasPorAplicacion($conex, $wemp_pmla, 'ConsecutivoExamenes');	$conExamenes++;		// Se consulta si el consecutivo de examenes que nos da root_000051 no existe	$q = "SELECT			Codigo 		FROM			".$basedatoshce."_000017		WHERE			Codigo = '".$conExamenes."'		AND Estado = 'on';";	$resMax = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	$numMax = mysql_num_rows($resMax);		// Si el consecutivo e examenes existe siga consultando hasta que encuentre uno que no exista	if($numMax>0) 	{		do		{			$conExamenes++;			$q = "SELECT					Codigo 				FROM					".$basedatoshce."_000017				WHERE					Codigo = '".$conExamenes."'				AND Estado = 'on';";					$resMax = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());			$numMax = mysql_num_rows($resMax);		} while( $numMax > 0);	}		//Encabezado lista de examenes	echo "<tr class='fondoAmarillo'>";	echo "<td nowrap>C&oacute;digo</td>";	echo "<td nowrap>Descripci&oacute;n</td>";	echo "<td nowrap>Servicio</td>";	echo "<td nowrap>Unidad que realiza</td>";	echo "<td nowrap>Anatom&iacute;a</td>";	echo "<td nowrap>C&oacute;digo CUPS</td>";	echo "<td nowrap>Clase</td>";	echo "<td nowrap>POS</td>";	echo "<td nowrap> &nbsp; Grabar &nbsp; </td>";	echo "</tr>";	echo "<tr class='fondoAmarillo'>";		echo "<td align='left'><div><input type='text' name='wcodigo' id='wcodigo' value='".$conExamenes."' /></div></td>";		echo "<td align='left'><div><input type='text' name='Descripcion' id='Descripcion' value='' /></div></td>";	$servicios = consultarServicios($basedatos);	// Columna de servicio / centro de costo	echo "<td align='left'>";	echo "<select name='Servicio' id='Servicio' style='width:194px'>";	echo "<option value='0'> -- seleccione -- </option>";	foreach ($servicios as $servicio)	{		echo "<option value=".$servicio->codigo.">".$servicio->nombre."</option>";	}	"</select>";	echo "</td>";	$tiposestudios = consultarTiposEstudios($basedatoshce);	// Columna de tipos de estudio	echo "<td align='left'>";	echo "<select name='Tipoestudio' id='Tipoestudio' style='width:194px'>";	echo "<option value='0'> -- seleccione -- </option>";	foreach ($tiposestudios as $tipoestudio)	{		echo "<option value=".$tipoestudio->codigo.">".$tipoestudio->nombre."</option>";	}	"</select>";	echo "</td>";		$anatomias = consultarAnatomias($basedatoshce);	// Columna de anatomias	echo "<td align='left'>";	echo "<select name='Anatomia' id='Anatomia' style='width:194px'>";	echo "<option value='0'> -- seleccione -- </option>";	foreach ($anatomias as $anatomia)	{		echo "<option value=".$anatomia->codigo.">".$anatomia->nombre."</option>";	}	"</select>";	echo "</td>";		echo "<td align='left'><div><input type='text' name='codcups' id='codcups' value='' /></div></td>";	$clasesexamenes = consultarClasesExamenes();	// Columna de clases de examenes	echo "<td align='left'>";	echo "<select name='Clase' id='Clase' style='width:194px'>";	echo "<option value='0'> -- seleccione -- </option>";	foreach ($clasesexamenes as $claseexamen)	{		echo "<option value=".$claseexamen->codigo.">".$claseexamen->nombre."</option>";	}	"</select>";	echo "</td>";		// Columna Es No POS	echo "<td align='center'>&nbsp;<input type='checkbox' name='NoPos' id='NoPos' value='1'>&nbsp;</td>";	// Columna para subimit formulario	echo "<td align='center'>&nbsp;<input type='button' onclick='agregarExamen();' name='guardar' id='guardar' value='Ok'>&nbsp;</td>";	echo "</tr>";	}/********************************************************************************* LISTADO DE PROCEDIMIENTOS Y EXAMENES *****************************************************************************************/function listaExamenesNuevos($wemp_pmla,$seguridad,$basedatos,$basedatoshce,$codigo='%',$descripcion='%',$servicio='%',$tipoEstudio='%',$anatomia='%',$codigoCups='%',$clase='%',$noPos='%'){		global $conex;		//Variable para determinar la empresa	if(!isset($wemp_pmla))	{		terminarEjecucion($MSJ_ERROR_FALTA_PARAMETRO."wemp_pmla");	}	// Defino si hay filtros para la consulta de los examenes	$filtroConsulta = "";	if($codigo!='%')		$filtroConsulta .= " AND a.Codigo LIKE '%".$codigo."%' ";	if($descripcion!='%')		$filtroConsulta .= " AND a.Descripcion LIKE '%".$descripcion."%' ";	if($servicio!='%')		$filtroConsulta .= " AND a.Servicio = '".$servicio."' ";	if($tipoEstudio!='%')		$filtroConsulta .= " AND a.Tipoestudio = '".$tipoEstudio."' ";	if($anatomia!='%')		$filtroConsulta .= " AND a.Anatomia = '".$anatomia."' ";	if($codigoCups!='%'){		$datos_cups = explode("-",$codigoCups);		$codigoCup = $datos_cups[0];		$filtroConsulta .= " AND a.Codcups LIKE '%".$codigoCup."%' ";			}			if($clase!='%')		$filtroConsulta .= " AND a.Clase = '".$clase."' ";	if($noPos!='%')		$filtroConsulta .= " AND a.NoPos = '".$noPos."' ";		/***************************************************************	 ******* INICIA SECCIÓN DEL LISTADO DE EXÁMES NUEVOS ***********	 ***************************************************************/	$registros_pagina = consultarAliasPorAplicacion($conex, $wemp_pmla, "RegistrosPaginadorHomologacion");		// Consulta el número de examenes pendientes de homologacion	$qcount = "SELECT a.Fecha_data AS Fecha, a.Hora_data AS Hora, a.Codigo AS Codigo, a.Descripcion AS Descripcion, Anatomia, Codcups, Protocolo, Clase, NoPos, a.Seguridad as Seguridad, a.Servicio, a.TipoEstudio			FROM				".$basedatoshce."_000017 a			WHERE				a.Nuevo = 'on'				AND a.Estado = 'on'				".$filtroConsulta."				GROUP BY a.Codigo ";	$rescount = mysql_query($qcount, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qcount . " - " . mysql_error());	$numcount = mysql_num_rows($rescount);	 	// Consulta la lista de examenes nuevos	$q = "SELECT a.Fecha_data AS Fecha, a.Hora_data AS Hora, a.Codigo AS Codigo, a.Descripcion AS Descripcion, Anatomia, Codcups, Protocolo, Clase, NoPos, a.Seguridad as Seguridad, a.Servicio, a.TipoEstudio			FROM				".$basedatoshce."_000017 a			WHERE				a.Nuevo = 'on'				AND a.Estado = 'on'				".$filtroConsulta."			GROUP BY a.Codigo			ORDER BY a.Fecha_data DESC			LIMIT 0, $registros_pagina ";				$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	$num = mysql_num_rows($res);		echo "<input type='hidden' id='total_registros' value='$numcount' >";	echo "<input type='hidden' id='registros_por_pagina' value='$registros_pagina' >";			//echo "<div class='titulo' align='center'><span style='float:left; position:relative; font-size:9px; font-weight:normal;'>Solo se muestran 50 registros por p&aacute;gina</span> ".$numcount." Procedimientos y Ex&aacute;menes pendientes de Homologaci&oacute;n</div>";		echo "<table border='0' cellspacing='2' cellpadding='0' align='center' width='100%'>";	//Encabezado lista de examenes	echo "<tr class='encabezadoTabla'>";	echo "<td align='center'>&nbsp;Fecha Registro&nbsp;</td>";	echo "<td align='center'>&nbsp;Hora Registro&nbsp;</td>";	echo "<td align='center'>&nbsp;Usuario que crea&nbsp;</td>";	echo "<td align='center'>&nbsp;C&oacute;digo&nbsp;</td>";	echo "<td align='center'>&nbsp;Descripci&oacute;n&nbsp;</td>";	echo "<td align='center'>&nbsp;Servicio&nbsp;</td>";	echo "<td align='center'>&nbsp;Unidad que realiza&nbsp;</td>";	echo "<td align='center'>&nbsp;Anatom&iacute;a&nbsp;</td>";	echo "<td align='center'>&nbsp;C&oacute;digo CUPS&nbsp;</td>";	echo "<td align='center'>&nbsp;Clase&nbsp;</td>";	echo "<td align='center'>&nbsp;POS&nbsp;</td>";	echo "<td align='center'>&nbsp;Eliminar&nbsp;</td>";	echo "<td align='center'>&nbsp;Homologar&nbsp;</td>";	echo "</tr>";	//Fila con campos para búsqueda	echo "<tr class='fondoAmarillo'>";	echo "<td align='center' colspan='3'><b>&nbsp;Buscar por&nbsp;</b></td>";		if($codigo=='%') {		$codigo='codigo';	$campo = 'codigo';		}else{	$campo = 'codigo';	}	echo "<td align='center'><input type='text' name='fndCodigoH' id='fndCodigoH' class='campoBuscar' style='width:81px' onkeyup='if(validateEnter(event) == true) { listarExamenesNuevos(); }' onClick='textobuscar(this, \"$codigo\",\"$campo\");' value='".$codigo."' /></td>";			if($descripcion=='%') {		$descripcion='descripcion';	$campo = 'descripcion';		}else{	$campo = 'descripcion';	}	echo "<td align='center'><input type='text' name='fndDescripcionH' id='fndDescripcionH' class='campoBuscar' onkeyup='if(validateEnter(event) == true) { listarExamenesNuevos(); }' onClick='textobuscar(this, \"$descripcion\",\"$campo\");' value='".$descripcion."' style='width:260px;' /></td>";		$servicios = consultarServicios($basedatos);	echo "<td align='center'>";	echo "<select name='fndServicioH' id='fndServicioH' onChange='listarExamenesNuevos()' style='width:170px' class='campoBuscar'>";	echo "<option value='%'>-servicio-</option>";	foreach ($servicios as $arrServicio)	{		if($servicio!=$arrServicio->codigo)			echo "<option value=".$arrServicio->codigo.">".$arrServicio->nombre."</option>";		else			echo "<option value=".$arrServicio->codigo." selected='selected'>".$arrServicio->nombre."</option>";	}	"</select>";	echo "</td>";		$tiposestudios = consultarTiposEstudios($basedatoshce);	echo "<td align='center'>";	echo "<select name='fndTipoestudioH' id='fndTipoestudioH' onChange='listarExamenesNuevos()' style='width:170px' class='campoBuscar'>";	echo "<option value='%'>-tipo estudio-</option>";	foreach ($tiposestudios as $arrTipoestudio)	{		if($tipoEstudio!=$arrTipoestudio->codigo)			echo "<option value=".$arrTipoestudio->codigo.">".$arrTipoestudio->nombre."</option>";		else			echo "<option value=".$arrTipoestudio->codigo." selected='selected'>".$arrTipoestudio->nombre."</option>";	}	"</select>";	echo "</td>";		$anatomias = consultarAnatomias($basedatoshce);	echo "<td align='center'>";	echo "<select name='fndAnatomiaH' id='fndAnatomiaH' onChange='listarExamenesNuevos()' style='width:170px' class='campoBuscar'>";	echo "<option value='%'>-anatomia-</option>";	foreach ($anatomias as $arrAnatomia)	{		if($anatomia!=$arrAnatomia->codigo)			echo "<option value=".$arrAnatomia->codigo.">".$arrAnatomia->nombre."</option>";		else			echo "<option value=".$arrAnatomia->codigo." selected='selected'>".$arrAnatomia->nombre."</option>";	}	"</select>";	echo "</td>";		if($codigoCups=='%') {		$codigoCups='codigo cups';	$campo = 'codigo cups';		}else{	$campo = 'codigo cups';	}		echo "<td align='center'><input type='text' name='fndCodcupsH' id='fndCodcupsH' class='campoBuscar' style='width:100px' onkeyup='if(validateEnter(event) == true) { listarExamenesNuevos(); }' onClick='textobuscar(this, \"$codigoCups\",\"$campo\");' value='".$codigoCups."' /></td>";	$clasesexamenes = consultarClasesExamenes();	echo "<td align='center'>";	echo "<select name='fndClaseH' id='fndClaseH' onChange='listarExamenesNuevos()' style='width:120px' class='campoBuscar'>";	echo "<option value='%'>-clase-</option>";	foreach ($clasesexamenes as $arrClase)	{		if($clase!=$arrClase->codigo)			echo "<option value=".$arrClase->codigo.">".$arrClase->nombre."</option>";		else			echo "<option value=".$arrClase->codigo." selected='selected'>".$arrClase->nombre."</option>";	}	"</select>";	echo "</td>";	$tipos = consultarTipos();	echo "<td align='center'>";	echo "<select name='fndNoPosH' id='fndNoPosH' onChange='listarExamenesNuevos()' style='width:80px' class='campoBuscar'>";	echo "<option value='%'>-tipo-</option>";	foreach ($tipos as $arrTipo)	{		if($noPos!=$arrTipo->codigo)			echo "<option value=".$arrTipo->codigo.">".$arrTipo->nombre."</option>";		else			echo "<option value=".$arrTipo->codigo." selected='selected'>".$arrTipo->nombre."</option>";	}	"</select>";	echo "</td>";	echo "<td align='left' colspan='2'>";	echo "<input type='button' name='buscar' id='buscar' onClick='listarExamenesNuevos();' value='buscar'>";	echo "</td>";	// echo "<td align='center'>&nbsp;Eliminar&nbsp;</td>";	// echo "<td align='center'>&nbsp;Homologar&nbsp;</td>";	echo "</tr>";	//echo "</form>";	echo "<input type='hidden' id='wnumfilas' name='wnumfilas' value='".$num."'>";		if ($num > 0)	{				$row = mysql_fetch_array($res);		$i=1;		//Ciclo para recorrer todos los registros de la consulta		while ($i<=$num)		{			if (is_int ($i/2))			   $wcf="fila1";  // color de fondo de la fila			else			   $wcf="fila2"; // color de fondo de la fila			//Se imprime los valores de cada fila			echo "<tr class='".$wcf."' id='tr".$i."'>";			echo "<td align='left'>&nbsp;".$row['Fecha']."&nbsp;</td>";			echo "<td align='left'>&nbsp;".$row['Hora']."&nbsp;</td>";						list( $bbb, $row['Seguridad'] ) = explode( "-", $row['Seguridad'] );						echo "<td align='center'>&nbsp;".$row['Seguridad']."&nbsp;</td>";						// Se comenta porque el código no se debe poder modificar, el que podrá cambiar es el código CUPS			// echo "<td align='left'>";			// echo "<div onClick='alertaCambioCodigo(\"Codigo-".$row['Codigo']."\");' id='tmpCodigo-".$row['Codigo']."'>".$row['Codigo']."</div>";			// echo "<div class='text' id='Codigo-".$row['Codigo']."' style='display:none;'>".$row['Codigo']."</div>";			// echo "</td>";						echo "<td align='center'>";			echo "<input type='hidden' id='wcodigo".$i."' name='wcodigo".$i."' value='".$row['Codigo']."'>";			echo "<div>".$row['Codigo']."</div>";			echo "</td>";						//echo "<td align='left'><div class='efectoeditar' id='Descripcion-".$row['Codigo']."' style='width:260px;'>".$row['Descripcion']."</div></td>";			echo "<td align='left'><textarea rows='3' cols='30' style='text-transform:uppercase;' onkeyup='this.value=this.value.toUpperCase();' id='Descripcion-".$row['Codigo']."' autocomplete='off' class='efectoeditar'>".$row['Descripcion']."</textarea></td>";			$servicios = consultarServicios($basedatos);			// Columna de servicio / centro de costo			echo "<td align='left'>";			echo "<select name='wservicio".$i."' id='wservicio".$i."' style='width:170px' onchange='asignarServicio(\"".$row['Codigo']."\",this)'>";			echo "<option value='0'> -- seleccione -- </option>";			foreach ($servicios as $servicio)			{				if($row && $servicio->codigo==$row['Servicio'])					echo "<option value=".$servicio->codigo." selected>".$servicio->nombre."</option>";				else					echo "<option value=".$servicio->codigo.">".$servicio->nombre."</option>";			}			"</select>";			//echo "<input type='hidden' name='wservicio".$i."' id='wservicio".$i."' value='".$row['CodigoServicio']."'>";			echo "</td>";			$tiposestudios = consultarTiposEstudios($basedatoshce);			// Columna de tipos de estudio			echo "<td align='left'>";			echo "<select name='wtipoestudio".$i."' id='wtipoestudio".$i."' style='width:170px' onchange='asignarTipoEstudio(\"".$row['Codigo']."\",this)'>";			echo "<option value='0'> -- seleccione -- </option>";			foreach ($tiposestudios as $tipoestudio)			{				if($row && $tipoestudio->codigo==$row['TipoEstudio'])					echo "<option value=".$tipoestudio->codigo." selected>".$tipoestudio->nombre."</option>";				else					echo "<option value=".$tipoestudio->codigo.">".$tipoestudio->nombre."</option>";			}			"</select>";			//echo "<input type='hidden' name='wtipoestudio".$i."' id='wtipoestudio".$i."' value='".$row['CodigoTipoEstudio']."'>";			echo "</td>";						$anatomias = consultarAnatomias($basedatoshce);			// Columna de anatomias			echo "<td align='left'>";			echo "<select name='wanatomia".$i."' id='wanatomia".$i."' style='width:170px' onchange='asignarAnatomia(\"".$row['Codigo']."\",this)'>";			echo "<option value='0'> -- seleccione -- </option>";			foreach ($anatomias as $anatomia)			{				if($row && $anatomia->codigo==$row['Anatomia'])					echo "<option value=".$anatomia->codigo." selected>".$anatomia->nombre."</option>";				else					echo "<option value=".$anatomia->codigo.">".$anatomia->nombre."</option>";			}			"</select>";			//echo "<input type='hidden' name='wanatomia".$i."' id='wanatomia".$i."' value='".$row['Anatomia']."'>";			echo "</td>";						//echo "<td align='left'><div class='text' id='Codcups-".$row['Codigo']."'>".$row['Codcups']."</div></td>";			echo "<td align='left'><input type='text' name='codcups".$i."' id='codcups".$i."' onClick='this.value=\"\";' style='width:100px' value='".$row['Codcups']."'></td>";			$clasesexamenes = consultarClasesExamenes();			// Columna de clases de examenes			echo "<td align='left'>";			echo "<select name='wclaseexamen".$i."' id='wclaseexamen".$i."' style='width:120px' onchange='asignarClaseEexamen(\"".$row['Codigo']."\",this)'>";			echo "<option value='0'> -- seleccione -- </option>";			foreach ($clasesexamenes as $claseexamen)			{				if($row && $claseexamen->codigo==$row['Clase'])					echo "<option value=".$claseexamen->codigo." selected>".$claseexamen->nombre."</option>";				else					echo "<option value=".$claseexamen->codigo.">".$claseexamen->nombre."</option>";			}			"</select>";			//echo "<input type='hidden' name='wclaseexamen".$i."' id='wclaseexamen".$i."' value='".$row['Clase']."'>";			echo "</td>";						// Columna Es No POS			$chkNopos = '';			if($row['NoPos']!='on')				$chkNopos = " checked='checked'";			echo "<td align='center'>&nbsp;<input type='checkbox' onclick='asignarNopos(\"".$row['Codigo']."\",this);' name='wnopos".$i."' id='wnopos".$i."' value='".$row['Codigo']."'".$chkNopos.">&nbsp;</td>";						// Columna para eliminar examen nuevo			echo "<td align='center'>&nbsp;<input type='checkbox' onclick='eliminarExamenNuevo(\"".$row['Codigo']."\",this,\"tr".$i."\");' name='elimina".$i."' id='elimina".$i."' value='".$row['Codigo']."'>&nbsp;</td>";			// Columna para homologar examen nuevo			echo "<td align='center'>&nbsp;<input type='button' onClick='homologarExamenNuevo(\"".$row['Codigo']."\",\"tr".$i."\",\"".$i."\");' name='homologa".$i."' id='homologa".$i."' value='Ok'>&nbsp;</td>";						echo "</tr>";			//Obtengo la siguiente fila			$row = mysql_fetch_array($res);			$i++;		}	}	else	{		echo "<tr><td colspan='12'><br /><p align='center'>No se encontraron ex&aacute;menes nuevos para homologar</p><p>&nbsp;</p></td></tr>";	}    echo "</table>";	}function listaExamenesNuevosPaginacion($wemp_pmla, $basedatos, $basedatoshce, $wseguridad, $registros_inicial, $registros_final, $codigo='%',$descripcion='%',$servicio='%',$tipoEstudio='%',$anatomia='%',$codigoCups='%',$clase='%',$noPos='%'){		global $conex;		$datamensaje = array('mensaje'=>'', 'error'=>0, 'html'=>'', 'total_registros'=>'');	// Defino si hay filtros para la consulta de los examenes	$filtroConsulta = "";	if($codigo!='%' and $codigo!='')		$filtroConsulta .= " AND a.Codigo LIKE '%".$codigo."%' ";	if($descripcion!='%' and $descripcion!='')		$filtroConsulta .= " AND a.Descripcion LIKE '%".$descripcion."%' ";	if($servicio!='%' and $servicio!='')		$filtroConsulta .= " AND a.Servicio = '".$servicio."' ";	if($tipoEstudio!='%' and $tipoEstudio!='')		$filtroConsulta .= " AND a.Tipoestudio = '".$tipoEstudio."' ";	if($anatomia!='%' and $anatomia!='')		$filtroConsulta .= " AND a.Anatomia = '".$anatomia."' ";	if($codigoCups!='%'){		$datos_cups = explode("-",$codigoCups);		$codigoCup = $datos_cups[0];		$filtroConsulta .= " AND a.Codcups LIKE '%".$codigoCup."%' ";			}	if($clase!='%' and $clase!='')		$filtroConsulta .= " AND a.Clase = '".$clase."' ";	if($noPos!='%' and $noPos!='')		$filtroConsulta .= " AND a.NoPos = '".$noPos."' ";		/***************************************************************	 ******* INICIA SECCIÓN DEL LISTADO DE EXÁMES NUEVOS ***********	 ***************************************************************/	$registros_pagina = consultarAliasPorAplicacion($conex, $wemp_pmla, "RegistrosPaginadorHomologacion");		// Consulta el número de examenes pendientes de homologacion	$qcount = "SELECT a.Fecha_data AS Fecha, a.Hora_data AS Hora, a.Codigo AS Codigo, a.Descripcion AS Descripcion, Anatomia, Codcups, Protocolo, Clase, NoPos, a.Seguridad as Seguridad, a.Servicio, a.TipoEstudio			FROM				".$basedatoshce."_000017 a			WHERE				a.Nuevo = 'on'				AND a.Estado = 'on'				".$filtroConsulta."				GROUP BY a.Codigo ";	$rescount = mysql_query($qcount, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qcount . " - " . mysql_error());	$numcount = mysql_num_rows($rescount);	 	// Consulta la lista de examenes nuevos	$q = "SELECT a.Fecha_data AS Fecha, a.Hora_data AS Hora, a.Codigo AS Codigo, a.Descripcion AS Descripcion, Anatomia, Codcups, Protocolo, Clase, NoPos, a.Seguridad as Seguridad, a.Servicio, a.TipoEstudio			FROM				".$basedatoshce."_000017 a			WHERE				a.Nuevo = 'on'				AND a.Estado = 'on'				".$filtroConsulta."			GROUP BY a.Codigo			ORDER BY a.Fecha_data DESC			LIMIT $registros_inicial, $registros_final ";				$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	$num = mysql_num_rows($res);		$datamensaje['html'].="<input type='hidden' id='total_registros' value='$numcount' >";	$datamensaje['total_registros'] = $numcount;			//$datamensaje['html'].="<div class='titulo' align='center'><span style='float:left; position:relative; font-size:9px; font-weight:normal;'>Solo se muestran 50 registros por p&aacute;gina</span> ".$numcount." Procedimientos y Ex&aacute;menes pendientes de Homologaci&oacute;n</div>";		$datamensaje['html'].="<table border='0' cellspacing='2' cellpadding='0' align='center' width='100%'>";	//Encabezado lista de examenes	$datamensaje['html'].="<tr class='encabezadoTabla'>";	$datamensaje['html'].="<td align='center'>&nbsp;Fecha Registro&nbsp;</td>";	$datamensaje['html'].="<td align='center'>&nbsp;Hora Registro&nbsp;</td>";	$datamensaje['html'].="<td align='center'>&nbsp;Usuario que crea&nbsp;</td>";	$datamensaje['html'].="<td align='center'>&nbsp;C&oacute;digo&nbsp;</td>";	$datamensaje['html'].="<td align='center'>&nbsp;Descripci&oacute;n&nbsp;</td>";	$datamensaje['html'].="<td align='center'>&nbsp;Servicio&nbsp;</td>";	$datamensaje['html'].="<td align='center'>&nbsp;Unidad que realiza&nbsp;</td>";	$datamensaje['html'].="<td align='center'>&nbsp;Anatom&iacute;a&nbsp;</td>";	$datamensaje['html'].="<td align='center'>&nbsp;C&oacute;digo CUPS&nbsp;</td>";	$datamensaje['html'].="<td align='center'>&nbsp;Clase&nbsp;</td>";	$datamensaje['html'].="<td align='center'>&nbsp;POS&nbsp;</td>";	$datamensaje['html'].="<td align='center'>&nbsp;Eliminar&nbsp;</td>";	$datamensaje['html'].="<td align='center'>&nbsp;Homologar&nbsp;</td>";	$datamensaje['html'].="</tr>";	//Fila con campos para búsqueda	$datamensaje['html'].="<tr class='fondoAmarillo'>";	$datamensaje['html'].="<td align='center' colspan='3'><b>&nbsp;Buscar por&nbsp;</b></td>";		if($codigo=='%') {		$codigo='codigo';	$campo = 'codigo';		}else{	$campo = 'codigo';	}	$datamensaje['html'].="<td align='center'><input type='text' name='fndCodigoH' id='fndCodigoH' class='campoBuscar' style='width:81px' onkeyup='if(validateEnter(event) == true) { listarExamenesNuevos(); }' onClick='textobuscar(this, \"$codigo\",\"$campo\");' value='".$codigo."' /></td>";			if($descripcion=='%') {		$descripcion='descripcion';	$campo = 'descripcion';		}else{	$campo = 'descripcion';	}	$datamensaje['html'].="<td align='center'><input type='text' name='fndDescripcionH' id='fndDescripcionH' class='campoBuscar' onkeyup='if(validateEnter(event) == true) { listarExamenesNuevos(); }' onClick='textobuscar(this, \"$descripcion\",\"$campo\");' value='".$descripcion."' style='width:260px;' /></td>";		$servicios = consultarServicios($basedatos);	$datamensaje['html'].="<td align='center'>";	$datamensaje['html'].="<select name='fndServicioH' id='fndServicioH' onChange='listarExamenesNuevos()' style='width:170px' class='campoBuscar'>";	$datamensaje['html'].="<option value='%'>-servicio-</option>";	foreach ($servicios as $arrServicio)	{		if($servicio!=$arrServicio->codigo)			$datamensaje['html'].="<option value=".$arrServicio->codigo.">".utf8_encode( $arrServicio->nombre )."</option>";		else			$datamensaje['html'].="<option value=".$arrServicio->codigo." selected='selected'>".utf8_encode( $arrServicio->nombre )."</option>";	}	"</select>";	$datamensaje['html'].="</td>";		$tiposestudios = consultarTiposEstudios($basedatoshce);	$datamensaje['html'].="<td align='center'>";	$datamensaje['html'].="<select name='fndTipoestudioH' id='fndTipoestudioH' onChange='listarExamenesNuevos()' style='width:170px' class='campoBuscar'>";	$datamensaje['html'].="<option value='%'>-tipo estudio-</option>";	foreach ($tiposestudios as $arrTipoestudio)	{		if($tipoEstudio!=$arrTipoestudio->codigo)			$datamensaje['html'].="<option value=".$arrTipoestudio->codigo.">".utf8_encode( $arrTipoestudio->nombre )."</option>";		else			$datamensaje['html'].="<option value=".$arrTipoestudio->codigo." selected='selected'>".utf8_encode( $arrTipoestudio->nombre )."</option>";	}	"</select>";	$datamensaje['html'].="</td>";		$anatomias = consultarAnatomias($basedatoshce);	$datamensaje['html'].="<td align='center'>";	$datamensaje['html'].="<select name='fndAnatomiaH' id='fndAnatomiaH' onChange='listarExamenesNuevos()' style='width:170px' class='campoBuscar'>";	$datamensaje['html'].="<option value='%'>-anatomia-</option>";	foreach ($anatomias as $arrAnatomia)	{		if($anatomia!=$arrAnatomia->codigo)			$datamensaje['html'].="<option value=".$arrAnatomia->codigo.">".utf8_encode( $arrAnatomia->nombre )."</option>";		else			$datamensaje['html'].="<option value=".$arrAnatomia->codigo." selected='selected'>".utf8_encode( $arrAnatomia->nombre )."</option>";	}	"</select>";	$datamensaje['html'].="</td>";		if($codigoCups=='%') {		$codigoCups='codigo cups';	$campo = 'codigo cups';		}else{	$campo = 'codigo cups';	}		$datamensaje['html'].="<td align='center'><input type='text' name='fndCodcupsH' id='fndCodcupsH' class='campoBuscar' style='width:100px' onkeyup='if(validateEnter(event) == true) { listarExamenesNuevos(); }' onClick='textobuscar(this, \"$codigoCups\",\"$campo\");' value='".$codigoCups."' /></td>";	$clasesexamenes = consultarClasesExamenes();	$datamensaje['html'].="<td align='center'>";	$datamensaje['html'].="<select name='fndClaseH' id='fndClaseH' onChange='listarExamenesNuevos()' style='width:120px' class='campoBuscar'>";	$datamensaje['html'].="<option value='%'>-clase-</option>";	foreach ($clasesexamenes as $arrClase)	{		if($clase!=$arrClase->codigo)			$datamensaje['html'].="<option value=".$arrClase->codigo.">".utf8_encode( $arrClase->nombre )."</option>";		else			$datamensaje['html'].="<option value=".$arrClase->codigo." selected='selected'>".utf8_encode( $arrClase->nombre )."</option>";	}	"</select>";	$datamensaje['html'].="</td>";	$tipos = consultarTipos();	$datamensaje['html'].="<td align='center'>";	$datamensaje['html'].="<select name='fndNoPosH' id='fndNoPosH' onChange='listarExamenesNuevos()' style='width:80px' class='campoBuscar'>";	$datamensaje['html'].="<option value='%'>-tipo-</option>";	foreach ($tipos as $arrTipo)	{		if($noPos!=$arrTipo->codigo)			$datamensaje['html'].="<option value=".$arrTipo->codigo.">".utf8_encode( $arrTipo->nombre )."</option>";		else			$datamensaje['html'].="<option value=".$arrTipo->codigo." selected='selected'>".utf8_encode( $arrTipo->nombre )."</option>";	}	"</select>";	$datamensaje['html'].="</td>";	$datamensaje['html'].="<td align='left' colspan='2'>";	$datamensaje['html'].="<input type='button' name='buscar' id='buscar' onClick='listarExamenesNuevos();' value='buscar'>";	$datamensaje['html'].="</td>";	// $datamensaje['html'].="<td align='center'>&nbsp;Eliminar&nbsp;</td>";	// $datamensaje['html'].="<td align='center'>&nbsp;Homologar&nbsp;</td>";	$datamensaje['html'].="</tr>";	//$datamensaje['html'].="</form>";	$datamensaje['html'].="<input type='hidden' id='wnumfilas' name='wnumfilas' value='".$num."'>";		if ($num > 0)	{				$row = mysql_fetch_array($res);		$i=1;		//Ciclo para recorrer todos los registros de la consulta		while ($i<=$num)		{			if (is_int ($i/2))			   $wcf="fila1";  // color de fondo de la fila			else			   $wcf="fila2"; // color de fondo de la fila			//Se imprime los valores de cada fila			$datamensaje['html'].="<tr class='".$wcf."' id='tr".$i."'>";			$datamensaje['html'].="<td align='left'>&nbsp;".$row['Fecha']."&nbsp;</td>";			$datamensaje['html'].="<td align='left'>&nbsp;".$row['Hora']."&nbsp;</td>";						list( $bbb, $row['Seguridad'] ) = explode( "-", $row['Seguridad'] );						$datamensaje['html'].="<td align='center'>&nbsp;".$row['Seguridad']."&nbsp;</td>";			$datamensaje['html'].="<td align='center'>";			$datamensaje['html'].="<input type='hidden' id='wcodigo".$i."' name='wcodigo".$i."' value='".$row['Codigo']."'>";			$datamensaje['html'].="<div>".$row['Codigo']."</div>";			$datamensaje['html'].="</td>";						//$datamensaje['html'].="<td align='left'><div class='efectoeditar' id='Descripcion-".$row['Codigo']."' style='width:260px;'>".$row['Descripcion']."</div></td>";			$datamensaje['html'].="<td align='left'><textarea rows='3' cols='30' style='text-transform:uppercase;' onkeyup='this.value=this.value.toUpperCase();' id='Descripcion-".$row['Codigo']."' autocomplete='off' class='efectoeditar'>".utf8_encode($row['Descripcion'])."</textarea></td>";			$servicios = consultarServicios($basedatos);			// Columna de servicio / centro de costo			$datamensaje['html'].="<td align='left'>";			$datamensaje['html'].="<select name='wservicio".$i."' id='wservicio".$i."' style='width:170px' onchange='asignarServicio(\"".$row['Codigo']."\",this)'>";			$datamensaje['html'].="<option value='0'> -- seleccione -- </option>";			foreach ($servicios as $servicio)			{				if($row && $servicio->codigo==$row['Servicio'])					$datamensaje['html'].="<option value=".$servicio->codigo." selected>".utf8_encode( $servicio->nombre )."</option>";				else					$datamensaje['html'].="<option value=".$servicio->codigo.">".utf8_encode( $servicio->nombre )."</option>";			}			"</select>";						$datamensaje['html'].="</td>";			$tiposestudios = consultarTiposEstudios($basedatoshce);			// Columna de tipos de estudio			$datamensaje['html'].="<td align='left'>";			$datamensaje['html'].="<select name='wtipoestudio".$i."' id='wtipoestudio".$i."' style='width:170px' onchange='asignarTipoEstudio(\"".$row['Codigo']."\",this)'>";			$datamensaje['html'].="<option value='0'> -- seleccione -- </option>";			foreach ($tiposestudios as $tipoestudio)			{				if($row && $tipoestudio->codigo==$row['TipoEstudio'])					$datamensaje['html'].="<option value=".$tipoestudio->codigo." selected>".utf8_encode( $tipoestudio->nombre )."</option>";				else					$datamensaje['html'].="<option value=".$tipoestudio->codigo.">".utf8_encode( $tipoestudio->nombre )."</option>";			}			"</select>";						$datamensaje['html'].="</td>";						$anatomias = consultarAnatomias($basedatoshce);			// Columna de anatomias			$datamensaje['html'].="<td align='left'>";			$datamensaje['html'].="<select name='wanatomia".$i."' id='wanatomia".$i."' style='width:170px' onchange='asignarAnatomia(\"".$row['Codigo']."\",this)'>";			$datamensaje['html'].="<option value='0'> -- seleccione -- </option>";			foreach ($anatomias as $anatomia)			{				if($row && $anatomia->codigo==$row['Anatomia'])					$datamensaje['html'].="<option value=".$anatomia->codigo." selected>".utf8_encode( $anatomia->nombre )."</option>";				else					$datamensaje['html'].="<option value=".$anatomia->codigo.">".utf8_encode( $anatomia->nombre )."</option>";			}			"</select>";						$datamensaje['html'].="</td>";									$datamensaje['html'].="<td align='left'><input type='text' name='codcups".$i."' id='codcups".$i."' onClick='this.value=\"\";' style='width:100px' value='".$row['Codcups']."'></td>";			$clasesexamenes = consultarClasesExamenes();			// Columna de clases de examenes			$datamensaje['html'].="<td align='left'>";			$datamensaje['html'].="<select name='wclaseexamen".$i."' id='wclaseexamen".$i."' style='width:120px' onchange='asignarClaseEexamen(\"".$row['Codigo']."\",this)'>";			$datamensaje['html'].="<option value='0'> -- seleccione -- </option>";			foreach ($clasesexamenes as $claseexamen)			{				if($row && $claseexamen->codigo==$row['Clase'])					$datamensaje['html'].="<option value=".$claseexamen->codigo." selected>".utf8_encode( $claseexamen->nombre )."</option>";				else					$datamensaje['html'].="<option value=".$claseexamen->codigo.">".utf8_encode( $claseexamen->nombre )."</option>";			}			"</select>";			//$datamensaje['html'].="<input type='hidden' name='wclaseexamen".$i."' id='wclaseexamen".$i."' value='".$row['Clase']."'>";			$datamensaje['html'].="</td>";						// Columna Es No POS			$chkNopos = '';			if($row['NoPos']!='on')				$chkNopos = " checked='checked'";			$datamensaje['html'].="<td align='center'>&nbsp;<input type='checkbox' onclick='asignarNopos(\"".$row['Codigo']."\",this);' name='wnopos".$i."' id='wnopos".$i."' value='".$row['Codigo']."'".$chkNopos.">&nbsp;</td>";						// Columna para eliminar examen nuevo			$datamensaje['html'].="<td align='center'>&nbsp;<input type='checkbox' onclick='eliminarExamenNuevo(\"".$row['Codigo']."\",this,\"tr".$i."\");' name='elimina".$i."' id='elimina".$i."' value='".$row['Codigo']."'>&nbsp;</td>";			// Columna para homologar examen nuevo			$datamensaje['html'].="<td align='center'>&nbsp;<input type='button' onClick='homologarExamenNuevo(\"".$row['Codigo']."\",\"tr".$i."\",\"".$i."\");' name='homologa".$i."' id='homologa".$i."' value='Ok'>&nbsp;</td>";						$datamensaje['html'].="</tr>";			//Obtengo la siguiente fila			$row = mysql_fetch_array($res);			$i++;		}	}	else	{		$datamensaje['html'].="<tr><td colspan='12'><br /><p align='center'>No se encontraron ex&aacute;menes nuevos para homologar</p><p>&nbsp;</p></td></tr>";	}    $datamensaje['html'].="</table>";		//$datamensaje['html'] = base64_encode(serialize($datamensaje['html']));		echo json_encode($datamensaje);	return;	}function listaExamenes($wemp_pmla,$seguridad,$basedatos,$basedatoshce,$codigo='%',$descripcion='%',$servicio='%',$tipoEstudio='%',$anatomia='%',$codigoCups='%',$clase='%',$noPos='%'){		global $conex;		$regAnatomias = consultarAnatomias2($basedatoshce);		//Variable para determinar la empresa	if(!isset($wemp_pmla))	{		terminarEjecucion($MSJ_ERROR_FALTA_PARAMETRO."wemp_pmla");	}	// Defino si hay filtros para la consulta de los examenes	$filtroConsulta = "";	if($codigo!='%')		$filtroConsulta .= " AND a.Codigo LIKE '%".$codigo."%' ";	if($descripcion!='%')		$filtroConsulta .= " AND a.Descripcion LIKE '%".$descripcion."%' ";	if($servicio!='%')		$filtroConsulta .= " AND a.Servicio = '".$servicio."' ";	if($tipoEstudio!='%')		$filtroConsulta .= " AND a.Tipoestudio = '".$tipoEstudio."' ";	if($anatomia!='%')		$filtroConsulta .= " AND a.Anatomia = '".$anatomia."' ";	if($codigoCups!='%'){		$datos_cups = explode("-",$codigoCups);		$codigoCup = $datos_cups[0];		$filtroConsulta .= " AND a.Codcups LIKE '%".$codigoCup."%' ";			}	if($clase!='%')		$filtroConsulta .= " AND a.Clase = '".$clase."' ";	if($noPos!='%')		$filtroConsulta .= " AND a.NoPos = '".$noPos."' ";		/***************************************************************	 *********** INICIA SECCIÓN DEL LISTADO DE EXÁMES **************	 ***************************************************************/		// Consulta el número de examenes homologados	$qcount = " SELECT a.Codigo				FROM					".$basedatoshce."_000047 a, ".$basedatos."_000011 b, ".$basedatoshce."_000015 c				WHERE					a.Nuevo != 'on'					AND a.Estado = 'on'					AND a.Servicio = b.Ccocod					AND b.Ccoest = 'on'					AND a.Tipoestudio = c.Codigo					AND c.Estado = 'on'				GROUP BY a.Codigo ";	$rescount = mysql_query($qcount, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qcount . " - " . mysql_error());	$numcount = mysql_num_rows($rescount);	// Consulta de pacientes activos en urgencias	$q = "SELECT a.Fecha_data AS Fecha, a.Hora_data AS Hora, a.Codigo AS Codigo, a.Descripcion AS Descripcion, b.Ccocod AS CodigoServicio, b.Cconom AS Servicio, c.Codigo AS CodigoTipoEstudio, c.Descripcion AS TipoEstudio, Anatomia, Codcups, Protocolo, Clase, NoPos, a.Seguridad as Seguridad			FROM				".$basedatoshce."_000047 a, ".$basedatos."_000011 b, ".$basedatoshce."_000015 c			WHERE				a.Nuevo != 'on'				AND a.Estado = 'on'				AND a.Servicio = b.Ccocod				AND b.Ccoest = 'on'				AND a.Tipoestudio = c.Codigo				AND c.Estado = 'on'				".$filtroConsulta."			GROUP BY a.Codigo			ORDER BY a.Fecha_data DESC, a.Hora_data DESC			LIMIT 0, 50			";	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	$num = mysql_num_rows($res);	//echo "<div class='titulo' align='center'><span style='float:left; position:relative; font-size:9px; font-weight:normal;'>Solo se muestran 50 registros por p&aacute;gina</span> ".$numcount." Procedimientos y Ex&aacute;menes Homologados</div>";	echo "<input type='hidden' id='total_registros_homologados' value='$numcount' >";	echo "<table border='0' cellspacing='2' cellpadding='0' align='center' width='100%'>";	//Encabezado lista de examenes	echo "<tr class='encabezadoTabla'>";	echo "<td align='center'>&nbsp;Fecha Registro&nbsp;</td>";	echo "<td align='center'>&nbsp;Hora Registro&nbsp;</td>";	echo "<td align='center'>&nbsp;Usuario que homologa&nbsp;</td>";	echo "<td align='center'>Código</td>";	echo "<td align='center'>&nbsp;Descripci&oacute;n&nbsp;</td>";	echo "<td align='center'>&nbsp;Servicio&nbsp;</td>";	echo "<td align='center'>&nbsp;Unidad que realiza&nbsp;</td>";	echo "<td align='center'>&nbsp;Anatom&iacute;a&nbsp;</td>";	echo "<td align='center'>&nbsp;C&oacute;digo CUPS&nbsp;</td>";	echo "<td align='center'>&nbsp;Clase&nbsp;</td>";	echo "<td align='center'>POS</td>";	echo "<td align='center'>Acci&oacute;n</td>";	// echo "<td align='center'>&nbsp;Eliminar&nbsp;</td>";	// echo "<td align='center'>&nbsp;Homologar&nbsp;</td>";	echo "</tr>";	//echo "<form name='busqueda' id=busqueda' action=''  onSubmit='listarExamenes();'>";	//Fila con campos para búsqueda	echo "<tr class='fondoAmarillo'>";	echo "<td align='center' colspan='3'><b>&nbsp;Buscar por&nbsp;</b></td>";		if($codigo=='%') {		$codigo='codigo';	$campo = 'codigo';		}else{	$campo = 'codigo';	}		echo "<td align='center'><input type='text' name='fndCodigo' id='fndCodigo' class='campoBuscar' style='width:81px' onkeyup='if(validateEnter(event) == true) { listarExamenes(); }' onClick='textobuscar(this, \"$codigo\",\"$campo\");' value='".$codigo."' /></td>";			if($descripcion=='%') {		$descripcion='descripcion';	$campo = 'descripcion';		}else{	$campo = 'descripcion';	}			echo "<td align='center'><input type='text' name='fndDescripcion' id='fndDescripcion' class='campoBuscar' onkeyup='if(validateEnter(event) == true) { listarExamenes(); }' onClick='textobuscar(this, \"$descripcion\",\"$campo\");' value='".$descripcion."' style='width:260px;' /></td>";		$servicios = consultarServicios($basedatos);	echo "<td align='center'>";	echo "<select name='fndServicio' id='fndServicio' onChange='listarExamenes()' style='width:170px' class='campoBuscar'>";	echo "<option value='%'>-servicio-</option>";	foreach ($servicios as $arrServicio)	{		if($servicio!=$arrServicio->codigo)			echo "<option value=".$arrServicio->codigo.">".$arrServicio->nombre."</option>";		else			echo "<option value=".$arrServicio->codigo." selected='selected'>".$arrServicio->nombre."</option>";	}	"</select>";	echo "</td>";		$tiposestudios = consultarTiposEstudios($basedatoshce);	echo "<td align='center'>";	echo "<select name='fndTipoestudio' id='fndTipoestudio' onChange='listarExamenes()' style='width:170px' class='campoBuscar'>";	echo "<option value='%'>-tipo estudio-</option>";	foreach ($tiposestudios as $arrTipoestudio)	{		if($tipoEstudio!=$arrTipoestudio->codigo)			echo "<option value=".$arrTipoestudio->codigo.">".$arrTipoestudio->nombre."</option>";		else			echo "<option value=".$arrTipoestudio->codigo." selected='selected'>".$arrTipoestudio->nombre."</option>";	}	"</select>";	echo "</td>";		$anatomias = consultarAnatomias($basedatoshce);	echo "<td align='center'>";	echo "<select name='fndAnatomia' id='fndAnatomia' onChange='listarExamenes()' style='width:170px' class='campoBuscar'>";	echo "<option value='%'>-anatomia-</option>";	foreach ($anatomias as $arrAnatomia)	{		if($anatomia!=$arrAnatomia->codigo)			echo "<option value=".$arrAnatomia->codigo.">".$arrAnatomia->nombre."</option>";		else			echo "<option value=".$arrAnatomia->codigo." selected='selected'>".$arrAnatomia->nombre."</option>";	}	"</select>";	echo "</td>";		if($codigoCups=='%') {		$codigoCups='codigo cups';	$campo = 'codigo cups';		}else{	$campo = 'codigo cups';	}		echo "<td align='center'><input type='text' name='fndCodcups' id='fndCodcups' class='campoBuscar' style='width:100px' onkeyup='if(validateEnter(event) == true) { listarExamenes(); }' onClick='textobuscar(this, \"$codigoCups\",\"$campo\");' value='".$codigoCups."' /></td>";	$clasesexamenes = consultarClasesExamenes();	echo "<td align='center'>";	echo "<select name='fndClase' id='fndClase' onChange='listarExamenes()' style='width:120px' class='campoBuscar'>";	echo "<option value='%'>-clase-</option>";	foreach ($clasesexamenes as $arrClase)	{		if($clase!=$arrClase->codigo)			echo "<option value=".$arrClase->codigo.">".$arrClase->nombre."</option>";		else			echo "<option value=".$arrClase->codigo." selected='selected'>".$arrClase->nombre."</option>";	}	"</select>";	echo "</td>";	$tipos = consultarTipos();	echo "<td align='center'>";	echo "<select name='fndNoPos' id='fndNoPos' onChange='listarExamenes()' style='width:80px' class='campoBuscar'>";	echo "<option value='%'>-tipo-</option>";	foreach ($tipos as $arrTipo)	{		if($noPos!=$arrTipo->codigo)			echo "<option value=".$arrTipo->codigo.">".$arrTipo->nombre."</option>";		else			echo "<option value=".$arrTipo->codigo." selected='selected'>".$arrTipo->nombre."</option>";	}	"</select>";	echo "</td>";	echo "<td align='center'>";	echo "<input type='button' name='buscar_homologados' id='buscar' onClick='listarExamenes();' value='buscar'>";	echo "</td>";	// echo "<td align='center'>&nbsp;Eliminar&nbsp;</td>";	// echo "<td align='center'>&nbsp;Homologar&nbsp;</td>";	echo "</tr>";	//echo "</form>";			if ($num > 0)	{				$row = mysql_fetch_array($res);		$i=1;		//Ciclo para recorrer todos los registros de la consulta		while ($i<=$num)		{			$clase = "";					if (is_int ($i/2))			   $wcf="fila1";  // color de fondo de la fila			else			   $wcf="fila2"; // color de fondo de la fila			//Se imprime los valores de cada fila			echo "<tr class='".$wcf."'>";			echo "<td align='left'>&nbsp;".$row['Fecha']."&nbsp;</td>";			echo "<td align='left'>&nbsp;".$row['Hora']."&nbsp;</td>";						list( $bbb, $row['Seguridad'] ) = explode( "-", $row['Seguridad'] );			echo "<td align='center'>&nbsp;".$row['Seguridad']."&nbsp;</td>";						// Se comenta porque el código no se debe poder modificar, el que podrá cambiar es el código CUPS			// echo "<td align='left'>";			// echo "<div onClick='alertaCambioCodigo(\"Codigo-".$row['Codigo']."\");' id='tmpCodigo-".$row['Codigo']."'>".$row['Codigo']."</div>";			// echo "<div class='text' id='Codigo-".$row['Codigo']."' style='display:none;'>".$row['Codigo']."</div>";			// echo "</td>";						echo "<td align='center'>";			echo "<div>".$row['Codigo']."</div>";			echo "</td>";						echo "<td align='left'><div style='width:201px;'>".$row['Descripcion']."</div></td>";			// Columna de servicio / centro de costo			echo "<td align='left'>";			echo "<div>".$row['CodigoServicio']." - ".$row['Servicio']."</div>";			echo "</td>";			// Columna de tipos de estudio			echo "<td align='left'>";			echo "<div>".$row['CodigoTipoEstudio']." - ".$row['TipoEstudio']."</div>";			echo "</td>";			$anatomia = $row['Anatomia'];			// Columna de anatomias			echo "<td align='left'>";						if( !empty($anatomia) )				echo "<div>".$anatomia." - ".$regAnatomias[$anatomia]."</div>";			else				echo "<div></div>";							echo "</td>";						echo "<td align='left'><div>".$row['Codcups']."</div></td>";			if($row['Clase']=='E')				$clase = 'Examen';			elseif($row['Clase']=='P')				$clase = 'Procedimiento';			elseif($row['Clase']=='C')				$clase = 'Consulta';			// Columna de clases de examenes			echo "<td align='left'>";			echo "<div>".$clase."</div>";			echo "</td>";						// Columna Es No POS						if($row['NoPos']=='on'){			$chkNopos = "NO POS";			}else{			$chkNopos = "POS";			}							echo "<td align='center'>&nbsp;".$chkNopos."&nbsp;</td>";			echo "<td align='center'><input type='button' onClick='correccionExamen(\"".$row['Codigo']."\",\"tr".$i."\");' name='corrige".$i."' id='corrige".$i."' value='Modificar'></td>";						// // Columna para eliminar examen nuevo			// echo "<td align='center'>&nbsp;<input type='checkbox' onclick='eliminarExamenNuevo(\"".$row['Codigo']."\",this,\"tr".$i."\");' name='elimina".$i."' id='elimina".$i."' value='".$row['Codigo']."'>&nbsp;</td>";			// // Columna para homologar examen nuevo			// echo "<td align='center'>&nbsp;<input type='button' onClick='homologarExamenNuevo(\"".$row['Codigo']."\",\"tr".$i."\");' name='homologa".$i."' id='homologa".$i."' value='Ok'>&nbsp;</td>";						echo "</tr>";			//Obtengo la siguiente fila			$row = mysql_fetch_array($res);			$i++;		}	}	else	{		echo "<tr><td colspan='10'><br /><p align='center'>No se encontraron ex&aacute;menes homologados</p><p>&nbsp;</p></td></tr>";	}    echo "</table>";	}								function listaExameneshomologados($wemp_pmla,$seguridad,$basedatos,$basedatoshce,$codigo='%',$descripcion='%',$servicio='%',$tipoEstudio='%',$anatomia='%',$codigoCups='%',$clase='%',$noPos='%',$registros_inicial, $registros_final){		global $conex;		$datamensaje = array('mensaje'=>'', 'error'=>0, 'html'=>'', 'total_registros'=>'');	$regAnatomias = consultarAnatomias2($basedatoshce);			// Defino si hay filtros para la consulta de los examenes	$filtroConsulta = "";	if($codigo!='%' and $codigo!='')		$filtroConsulta .= " AND a.Codigo LIKE '%".$codigo."%' ";	if($descripcion!='%' and $descripcion!='')		$filtroConsulta .= " AND a.Descripcion LIKE '%".$descripcion."%' ";	if($servicio!='%' and $servicio!='')		$filtroConsulta .= " AND a.Servicio = '".$servicio."' ";	if($tipoEstudio!='%' and $tipoEstudio!='')		$filtroConsulta .= " AND a.Tipoestudio = '".$tipoEstudio."' ";	if($anatomia!='%' and $anatomia!='')		$filtroConsulta .= " AND a.Anatomia = '".$anatomia."' ";	if($codigoCups!='%'){		$datos_cups = explode("-",$codigoCups);		$codigoCup = $datos_cups[0];		$filtroConsulta .= " AND a.Codcups LIKE '%".$codigoCup."%' ";			}	if($clase!='%' and $clase!='')		$filtroConsulta .= " AND a.Clase = '".$clase."' ";	if($noPos!='%' and $noPos!='')		$filtroConsulta .= " AND a.NoPos = '".$noPos."' ";		/***************************************************************	 *********** INICIA SECCIÓN DEL LISTADO DE EXÁMES **************	 ***************************************************************/		// Consulta el número de examenes homologados	$qcount = "SELECT a.Codigo					  FROM						".$basedatoshce."_000047 a 						LEFT JOIN ".$basedatos."_000011 b 							   ON a.Servicio = b.Ccocod							  AND b.Ccoest = 'on'						LEFT JOIN ".$basedatoshce."_000015 c							   ON a.Tipoestudio = c.Codigo							  AND c.Estado = 'on'					  WHERE a.Nuevo != 'on'					    AND a.Estado = 'on'					    $filtroConsulta					GROUP BY a.Codigo ";	$rescount = mysql_query($qcount, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qcount . " - " . mysql_error());	$numcount = mysql_num_rows($rescount);					$q = "SELECT a.Fecha_data AS Fecha, a.Hora_data AS Hora, a.Codigo AS Codigo, a.Descripcion AS Descripcion, b.Ccocod AS CodigoServicio, b.Cconom AS Servicio, c.Codigo AS CodigoTipoEstudio, c.Descripcion AS TipoEstudio, Anatomia, Codcups, Protocolo, Clase, NoPos, a.Seguridad as Seguridad			FROM				".$basedatoshce."_000047 a 				LEFT JOIN ".$basedatos."_000011 b 					   ON a.Servicio = b.Ccocod					  AND b.Ccoest = 'on'				LEFT JOIN ".$basedatoshce."_000015 c					   ON a.Tipoestudio = c.Codigo					  AND c.Estado = 'on'			WHERE a.Nuevo != 'on'			  AND a.Estado = 'on'				".$filtroConsulta."			GROUP BY a.Codigo			ORDER BY a.Fecha_data DESC, a.Hora_data DESC			LIMIT $registros_inicial, $registros_final";	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	$num = mysql_num_rows($res);		$datamensaje['total_registros'] = $numcount;	//$datamensaje['html'] .= "<div class='titulo' align='center'><span style='float:left; position:relative; font-size:9px; font-weight:normal;'>Solo se muestran 50 registros por p&aacute;gina</span> ".$numcount." Procedimientos y Ex&aacute;menes Homologados</div>";	$datamensaje['html'] .= "<input type='hidden' id='total_registros_homologados' value='$numcount' >";	$datamensaje['html'] .= "<table border='0' cellspacing='2' cellpadding='0' align='center' width='100%'>";	//Encabezado lista de examenes	$datamensaje['html'] .= "<tr class='encabezadoTabla'>";	$datamensaje['html'] .= "<td align='center'>&nbsp;Fecha Registro&nbsp;</td>";	$datamensaje['html'] .= "<td align='center'>&nbsp;Hora Registro&nbsp;</td>";	$datamensaje['html'] .= "<td align='center'>&nbsp;Usuario que homologa&nbsp;</td>";	$datamensaje['html'] .= "<td align='center'>C&oacutedigo</td>";	$datamensaje['html'] .= "<td align='center'>&nbsp;Descripci&oacute;n&nbsp;</td>";	$datamensaje['html'] .= "<td align='center'>&nbsp;Servicio&nbsp;</td>";	$datamensaje['html'] .= "<td align='center'>&nbsp;Unidad que realiza&nbsp;</td>";	$datamensaje['html'] .= "<td align='center'>&nbsp;Anatom&iacute;a&nbsp;</td>";	$datamensaje['html'] .= "<td align='center'>&nbsp;C&oacute;digo CUPS&nbsp;</td>";	$datamensaje['html'] .= "<td align='center'>&nbsp;Clase&nbsp;</td>";	$datamensaje['html'] .= "<td align='center'>POS</td>";	$datamensaje['html'] .= "<td align='center'>Acci&oacute;n</td>";	// $datamensaje['html'] .= "<td align='center'>&nbsp;Eliminar&nbsp;</td>";	// $datamensaje['html'] .= "<td align='center'>&nbsp;Homologar&nbsp;</td>";	$datamensaje['html'] .= "</tr>";	//$datamensaje['html'] .= "<form name='busqueda' id=busqueda' action=''  onSubmit='listarExamenes();'>";	//Fila con campos para búsqueda	$datamensaje['html'] .= "<tr class='fondoAmarillo'>";	$datamensaje['html'] .= "<td align='center' colspan='3'><b>&nbsp;Buscar por&nbsp;</b></td>";		if($codigo=='%') {		$codigo='codigo';	$campo = 'codigo';		}else{	$campo = 'codigo';	}		$datamensaje['html'] .= "<td align='center'><input type='text' name='fndCodigo' id='fndCodigo' class='campoBuscar' style='width:81px' onkeyup='if(validateEnter(event) == true) { listarExamenes(); }' onClick='textobuscar(this, \"$codigo\",\"$campo\");' value='".$codigo."' /></td>";			if($descripcion=='%') {		$descripcion='descripcion';	$campo = 'descripcion';		}else{	$campo = 'descripcion';	}			$datamensaje['html'] .= "<td align='center'><input type='text' name='fndDescripcion' id='fndDescripcion' class='campoBuscar' onkeyup='if(validateEnter(event) == true) { listarExamenes(); }' onClick='textobuscar(this, \"$descripcion\",\"$campo\");' value='".$descripcion."' style='width:260px;' /></td>";		$servicios = consultarServicios($basedatos);	$datamensaje['html'] .= "<td align='center'>";	$datamensaje['html'] .= "<select name='fndServicio' id='fndServicio' onChange='listarExamenes()' style='width:170px' class='campoBuscar'>";	$datamensaje['html'] .= "<option value='%'>-servicio-</option>";	foreach ($servicios as $arrServicio)	{		if($servicio!=$arrServicio->codigo)			$datamensaje['html'] .= "<option value=".$arrServicio->codigo.">".utf8_encode( $arrServicio->nombre )."</option>";		else			$datamensaje['html'] .= "<option value=".$arrServicio->codigo." selected='selected'>".utf8_encode( $arrServicio->nombre )."</option>";	}	"</select>";	$datamensaje['html'] .= "</td>";		$tiposestudios = consultarTiposEstudios($basedatoshce);	$datamensaje['html'] .= "<td align='center'>";	$datamensaje['html'] .= "<select name='fndTipoestudio' id='fndTipoestudio' onChange='listarExamenes()' style='width:170px' class='campoBuscar'>";	$datamensaje['html'] .= "<option value='%'>-tipo estudio-</option>";	foreach ($tiposestudios as $arrTipoestudio)	{		if($tipoEstudio!=$arrTipoestudio->codigo)			$datamensaje['html'] .= "<option value=".$arrTipoestudio->codigo.">".utf8_encode( $arrTipoestudio->nombre )."</option>";		else			$datamensaje['html'] .= "<option value=".$arrTipoestudio->codigo." selected='selected'>".utf8_encode( $arrTipoestudio->nombre )."</option>";	}	"</select>";	$datamensaje['html'] .= "</td>";		$anatomias = consultarAnatomias($basedatoshce);	$datamensaje['html'] .= "<td align='center'>";	$datamensaje['html'] .= "<select name='fndAnatomia' id='fndAnatomia' onChange='listarExamenes()' style='width:170px' class='campoBuscar'>";	$datamensaje['html'] .= "<option value='%'>-anatomia-</option>";	foreach ($anatomias as $arrAnatomia)	{		if($anatomia!=$arrAnatomia->codigo)			$datamensaje['html'] .= "<option value=".$arrAnatomia->codigo.">".utf8_encode( $arrAnatomia->nombre )."</option>";		else			$datamensaje['html'] .= "<option value=".$arrAnatomia->codigo." selected='selected'>".utf8_encode( $arrAnatomia->nombre )."</option>";	}	"</select>";	$datamensaje['html'] .= "</td>";		if($codigoCups=='%') {		$codigoCups='codigo cups';	$campo = 'codigo cups';		}else{	$campo = 'codigo cups';	}		$datamensaje['html'] .= "<td align='center'><input type='text' name='fndCodcups' id='fndCodcups' class='campoBuscar' style='width:100px' onkeyup='if(validateEnter(event) == true) { listarExamenes(); }' onClick='textobuscar(this, \"$codigoCups\",\"$campo\");' value='".$codigoCups."' /></td>";	$clasesexamenes = consultarClasesExamenes();	$datamensaje['html'] .= "<td align='center'>";	$datamensaje['html'] .= "<select name='fndClase' id='fndClase' onChange='listarExamenes()' style='width:120px' class='campoBuscar'>";	$datamensaje['html'] .= "<option value='%'>-clase-</option>";	foreach ($clasesexamenes as $arrClase)	{		if($clase!=$arrClase->codigo)			$datamensaje['html'] .= "<option value=".$arrClase->codigo.">".utf8_encode( $arrClase->nombre )."</option>";		else			$datamensaje['html'] .= "<option value=".$arrClase->codigo." selected='selected'>".utf8_encode( $arrClase->nombre )."</option>";	}	"</select>";	$datamensaje['html'] .= "</td>";	$tipos = consultarTipos();	$datamensaje['html'] .= "<td align='center'>";	$datamensaje['html'] .= "<select name='fndNoPos' id='fndNoPos' onChange='listarExamenes()' style='width:80px' class='campoBuscar'>";	$datamensaje['html'] .= "<option value='%'>-tipo-</option>";	foreach ($tipos as $arrTipo)	{		if($noPos!=$arrTipo->codigo)			$datamensaje['html'] .= "<option value=".$arrTipo->codigo.">".utf8_encode( $arrTipo->nombre )."</option>";		else			$datamensaje['html'] .= "<option value=".$arrTipo->codigo." selected='selected'>".utf8_encode( $arrTipo->nombre )."</option>";	}	"</select>";	$datamensaje['html'] .= "</td>";	$datamensaje['html'] .= "<td align='center'>";	$datamensaje['html'] .= "<input type='button' name='buscar_homologados' id='buscar' onClick='listarExamenes();' value='buscar'>";	$datamensaje['html'] .= "</td>";	// $datamensaje['html'] .= "<td align='center'>&nbsp;Eliminar&nbsp;</td>";	// $datamensaje['html'] .= "<td align='center'>&nbsp;Homologar&nbsp;</td>";	$datamensaje['html'] .= "</tr>";	//$datamensaje['html'] .= "</form>";			if ($num > 0)	{				$row = mysql_fetch_array($res);		$i=1;		//Ciclo para recorrer todos los registros de la consulta		while ($i<=$num)		{			$clase = "";					if (is_int ($i/2))			   $wcf="fila1";  // color de fondo de la fila			else			   $wcf="fila2"; // color de fondo de la fila			//Se imprime los valores de cada fila			$datamensaje['html'] .= "<tr class='".$wcf."'>";			$datamensaje['html'] .= "<td align='left'>&nbsp;".$row['Fecha']."&nbsp;</td>";			$datamensaje['html'] .= "<td align='left'>&nbsp;".$row['Hora']."&nbsp;</td>";						list( $bbb, $row['Seguridad'] ) = explode( "-", $row['Seguridad'] );			$datamensaje['html'] .= "<td align='center'>&nbsp;".$row['Seguridad']."&nbsp;</td>";						// Se comenta porque el código no se debe poder modificar, el que podrá cambiar es el código CUPS			// $datamensaje['html'] .= "<td align='left'>";			// $datamensaje['html'] .= "<div onClick='alertaCambioCodigo(\"Codigo-".$row['Codigo']."\");' id='tmpCodigo-".$row['Codigo']."'>".$row['Codigo']."</div>";			// $datamensaje['html'] .= "<div class='text' id='Codigo-".$row['Codigo']."' style='display:none;'>".$row['Codigo']."</div>";			// $datamensaje['html'] .= "</td>";						$datamensaje['html'] .= "<td align='center'>";			$datamensaje['html'] .= "<div>".$row['Codigo']."</div>";			$datamensaje['html'] .= "</td>";						$datamensaje['html'] .= "<td align='left'><div style='width:201px;'>".utf8_encode($row['Descripcion'])."</div></td>";			// Columna de servicio / centro de costo			$datamensaje['html'] .= "<td align='left'>";			$datamensaje['html'] .= "<div>".$row['CodigoServicio']." - ".$row['Servicio']."</div>";			$datamensaje['html'] .= "</td>";			// Columna de tipos de estudio			$datamensaje['html'] .= "<td align='left'>";			$datamensaje['html'] .= "<div>".$row['CodigoTipoEstudio']." - ".$row['TipoEstudio']."</div>";			$datamensaje['html'] .= "</td>";			$anatomia = $row['Anatomia'];			// Columna de anatomias			$datamensaje['html'] .= "<td align='left'>";						if( !empty($anatomia) )				$datamensaje['html'] .= "<div>".utf8_encode($anatomia)." - ".utf8_encode($regAnatomias[$anatomia])."</div>";			else				$datamensaje['html'] .= "<div></div>";							$datamensaje['html'] .= "</td>";						$datamensaje['html'] .= "<td align='left'><div>".$row['Codcups']."</div></td>";			if($row['Clase']=='E')				$clase = 'Examen';			elseif($row['Clase']=='P')				$clase = 'Procedimiento';			elseif($row['Clase']=='C')				$clase = 'Consulta';			// Columna de clases de examenes			$datamensaje['html'] .= "<td align='left'>";			$datamensaje['html'] .= "<div>".$clase."</div>";			$datamensaje['html'] .= "</td>";						// Columna Es No POS						if($row['NoPos']=='on'){			$chkNopos = "NO POS";			}else{			$chkNopos = "POS";			}							$datamensaje['html'] .= "<td align='center'>&nbsp;".$chkNopos."&nbsp;</td>";			$datamensaje['html'] .= "<td align='center'><input type='button' onClick='correccionExamen(\"".$row['Codigo']."\",\"tr".$i."\");' name='corrige".$i."' id='corrige".$i."' value='Modificar'></td>";						// // Columna para eliminar examen nuevo			// $datamensaje['html'] .= "<td align='center'>&nbsp;<input type='checkbox' onclick='eliminarExamenNuevo(\"".$row['Codigo']."\",this,\"tr".$i."\");' name='elimina".$i."' id='elimina".$i."' value='".$row['Codigo']."'>&nbsp;</td>";			// // Columna para homologar examen nuevo			// $datamensaje['html'] .= "<td align='center'>&nbsp;<input type='button' onClick='homologarExamenNuevo(\"".$row['Codigo']."\",\"tr".$i."\");' name='homologa".$i."' id='homologa".$i."' value='Ok'>&nbsp;</td>";						$datamensaje['html'] .= "</tr>";			//Obtengo la siguiente fila			$row = mysql_fetch_array($res);			$i++;		}	}	else	{		$datamensaje['html'] .= "<tr><td colspan='10'><br /><p align='center'>No se encontraron ex&aacute;menes homologados</p><p>&nbsp;</p></td></tr>";	}    $datamensaje['html'] .= "</table>";		return json_encode($datamensaje);	}////////////////////////////////////////////////////////////////////////////////// LLAMADOS AJAXif(isset($consultaAjax)){	// Llamado a las funciones según el parámetro pasado por medio de ajax	switch($consultaAjax)	{		/*		case 'lisexanue':			echo listaExamenesNuevos($wemp_pmla,$seguridad,$basedatos,$basedatoshce);		break;		*/		case 'asiserexa':			echo asignarServicioExamen($wemp_pmla,$seguridad,$basedatos,$basedatoshce,$wexamen,$wservicio);		break;		case 'asitipestexa':			echo asignarTipoEstudioExamen($wemp_pmla,$seguridad,$basedatos,$basedatoshce,$wexamen,$wtipoestudio);		break;		case 'asianaexa':			echo asignarAnatomiaExamen($wemp_pmla,$seguridad,$basedatos,$basedatoshce,$wexamen,$wanatomia);		break;		case 'asiclaexa':			echo asignarClaseExamen($wemp_pmla,$seguridad,$basedatos,$basedatoshce,$wexamen,$wclaseexamen);		break;		case 'asinoposexa':			echo asignarNoposExamen($wemp_pmla,$seguridad,$basedatos,$basedatoshce,$wexamen,$wnopos);		break;		case 'eliexanue':			echo eliminarExamen($wemp_pmla,$seguridad,$basedatos,$basedatoshce,$wexamen);		break;		case 'homexanue':			echo homologarExamen($wemp_pmla,$seguridad,$basedatos,$basedatoshce,$wexamen,$codigoCups, $descripcion);		break;		case 'corexa':			echo corregirExamen($wemp_pmla,$seguridad,$basedatos,$basedatoshce,$wexamen);		break;		// case 'editable':			// echo actualizarCampoTexto($basedatoshce,$_POST['id'],$_POST['value']);		// break;		case 'addexa':			echo guardarExamen($wemp_pmla,$seguridad,$basedatos,$basedatoshce,$codigo,$descripcion,$servicio,$tipoEstudio,$anatomia,$codigoCups,$clase,$noPos);		break;		case 'addcup':			echo guardarCups($wemp_pmla,$seguridad,$basedatos,$basedatoshce,$codigoCups,$descripcion,$examen);		break;		case 'lisexanue':			echo listaExamenesNuevos($wemp_pmla,$seguridad,$basedatos,$basedatoshce,$codigo,$descripcion,$servicio,$tipoEstudio,$anatomia,$codigoCups,$clase,$noPos);		break;		case 'lisexa':			echo listaExamenes($wemp_pmla,$seguridad,$basedatos,$basedatoshce,$codigo,utf8_decode( $descripcion ),$servicio,$tipoEstudio,$anatomia,$codigoCups,$clase,$noPos);		break;		case 'liscup':			if(!isset($codigo)) $codigo = '%';			echo consultarCups($wemp_pmla,$seguridad,$basedatos,$basedatoshce,prepararCriterio($q),$codigo);		break;		case 'asicup':			echo asignarCups($wemp_pmla,$seguridad,$basedatos,$basedatoshce,$wexamen,$wcups);		break;		case 'valcup':			echo verificarCups($wemp_pmla,$seguridad,$basedatos,$basedatoshce,$wcups);		break;				case 'consultar_registros':					echo listaExamenesNuevosPaginacion($wemp_pmla, $wbasedato, $wbasedatohce, $wseguridad, $registros_inicial, $registros_final,$codigo,$descripcion,$servicio,$tipoEstudio,$anatomia,$codigoCups,$clase,$noPos);		break;						case 'consultar_registros_homologados':				echo listaExameneshomologados($wemp_pmla,$wseguridad,$wbasedato,$wbasedatohce,$codigo,utf8_decode( $descripcion ),$servicio,$tipoEstudio,$anatomia,$codigoCups,$clase,$noPos,$registros_inicial, $registros_final);					break;				default :			break;	}}if(!isset($consultaAjax)) { 	echo '</body></html>'; }