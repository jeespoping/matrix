<?php
include_once("conex.php");
//ORDENES PARA HCE a
//BSD
//Creado JUNIO 1 DE 2010
//Mauricio Sanchez Castaño

/************************************************************************************************************************
 * A tener en cuenta
 * 
 * Abrir el programa de ordenes desde la HCE sin que se vea la ventana de consultar de ordnes
 *  - Para abrir ordenes sin que se vea la pantalla de consultar ordenes, en la tabla 000009 de HCE, el link que se crea
 *    para el programa de ordenes debe tener &hce=on
 *  - Un medico no debe estar registrado con el centro de costos 1050 o 1051, ya que da el efecto de que no se guarda los articulos.
 *    Esto debido a que los articulos son guardados con cco * y su encabezado como 1051, por tanto no se vería los articulos al
 *    abrir el kardex
 *  - Para mostrar los componentes de un articulo generico, sus componentes deben estar en la tabla 000098 de movhos
 *  - Los consecutivos de la orden se encuentran en movhos_000011
 *  - El examen de la orden médica, para mensajes HL7 se guarda en tabla indicada segun HCE_000017
 *	- Solo los examenes cuyo tipo tengan justificacion, indicado en la tabla 000015, campo reqjus, obliga a ingresar una 
 *	  justificacion para el examen.
 ************************************************************************************************************************/

/************************************************************************************************************************
 * Modificaciones
 * Agosto 13 de 2020	Edwin 		- Se permite ordenar cups buscando por codigo CUP
 * Agosto 05 de 2020	Edwin 		- Si un paciente está con traslado temporal en hemodinamia, en el mensaje HL7 enviado a laboratorio se manda la habitación dónde se encuentra
 *									- Se cambia el nombre del archivo que se crea en el ftp para los mensajes hl7 con la interoperabilidad de laboratorio, agregando a la fecha, 
 *									  la hora el minuto y segundo de creación del archivo
 * Junio 30 de 2020		Edwin 		- Se guarda la fecha y hora de toma de muestra y se registra en la auditoría y se impide que dos usuarios diferentes tomen la muestra a la misma fecha y hora
 * Junio 17 de 2020		Edwin 		- Se crea función enviarALaboratorioHL7Faltantes para que cree los mensajes hl7 faltantes por enviar de los estudios
 *									  que tengan interoperabilidad
 * Junio 05 de 2020		Edwin 		- En el mensaje hl7 a laboratorio se manda el médico quién realizo la orden
 * Mayo 21 de 2020		Edwin 		- Se permite toma de muestra por cco según interoperabilidad (movhos 11 campo Ccotio)
 * Mayo 13 de 2020		Edwin 		- Los estudios no ofertados al tomar la muestra desde gestión no se envían a laboratorio
 * Mayo 12 de 2020		Edwin 		- Se hacen cambios para toma de muestra desde gestion de enfermería
 * Mayo 4 de 2020		Edwin 		- Se hacen cambios varios para la interoperabilidad con laboratorio por centro de costos y POCT
 * Febrero 14 de 2020	Edwin 		- Si un tipo de orden tiene interoperabilidad y el estudio es ofertado, no se permite mover los estados del estudio
 * Febrero 13 de 2020	Edwin 		- Cuando una orden de estudios tiene interoperabilidad, no se muestran resultados a ningún usuario.
 * Febrero 03 de 2020	Edwin 		- Se envía el tipo de documento en el mensaje HL7 enviado a Laboratorio
 * Enero 23 de 2020		Edwin 		- Se crea función tieneKardex, para identificar si en un día especifico las ordenes eran kardex u ordenes según el encabezado
 *									  del kardex (movhos_000053)
 * Diciembre 17 de 2019	Edwin 		- Se borran espacios al final del número de documento en el mensaje HL7 que se envía a laboratorio
 * Diciembre 10 de 2019	Edwin 		- Para antecedentes personales se corrige guardado de caracteres especiales
 * Noviembre 20 de 2019	Edwin 		- Si en el parámetro permitirCambiarEstadoInteroperabilidadPorTipoOrden se encuentra el tipo de la orden no se muestra
 *									  información en la pestaña de ordenes realizadas
 * Noviembre 19 de 2019	Edwin 		- Si en el parámetro permitirCambiarEstadoInteroperabilidadPorTipoOrden se encuentra el tipo de la orden no se muestra
 *									  mensaje "NO OFERTADO" para estudios no ofertados
 * Noviembre 18 de 2019	Edwin 		- Si en el parámetro permitirCambiarEstadoInteroperabilidadPorTipoOrden se encuentra el tipo de la orden, la 
 *									  interoperabilidad con los sistemas de laboratorio o HIRUKO no se ven reflejados en el programa de ordenes
 * Noviembre 13 de 2019	Edwin 		- Si no hay interoperabilidad no habilita el campo enviar mensaje hl7(Detval = on) para que luego no se envíe
 *									  el mensaje HL7 a laboratorio al iniciar nuevamente el proceso
 * Noviembre 07 de 2019	Edwin 		- Al enviar un mensaje HL7 a Hiruko, se deshabilita en campo Detval (Detval = off) en la tabla temporal de
 *									  procedimientos y examenes (movhos_000159) para que no se envíe nuevamente.
 * Octubre 30 de 2019	Edwin 		- Se hacen modificaciones varias para interoperabilidad con ordenes (LABORATORIO, HIRUKO)
 * Julio 29 de 2019	Edwin 			- Se puede marcar no enviar para medicamentos ordenados en ayudas dx
 * Mayo 27 de 2019	Edwin 			- Se corrige división por cero en la línea 34105 al momento de modificar el escript 
 *									  (se multiplica denominador y numerador por 1000 para corregirlo)
 *									- A la función consultarFamiliaMedicamentos, el valor retornado se le queta el utf8_encode
 * Abril 24 de 2019	Edwin 			- Se corrige filtro en la consulta del where en la función pintarModalIC
 * Febrero 7 de 2019	Edwin 		- Se comenta el funcionamiento de la función seguimiento
 * Febrero 4 de 2019	Edwin 		- Se muestra la información más reciente de medicamentos de consumo habitual, para ello en 
 *									  la función consultarMedConsuHabitual se agrega ORDER BY por fecha y hora en forma descendente
 *									  en el query principal
 * Enero 29 de 2019	Edwin 			- En la función generarListaProtocolos se agrega filtro de estado en la consulta principal
 * Noviembre 15 de 2018	Jessica 	- En la función consultarAlergiasPorPrincipioActivo() se agrega el filtro Daaest='on' para 
 *									  que valide solo las alergias de medicamentos activas.
 * Noviembre 15 de 2018	Edwin 		- Se agrega validación de alergias de medicamentos al prescribir los medicamentos, es decir, 
 *									  si el paciente tiene una alergia activa para el principio activo no debe permitir ordenarlo.
 * Julio 9 de 2018 Edwin 			- Se crea opción ajax para buscar los articulos anteriores
 * Julio 3 de 2018 Edwin			- Se crea ajax para consultar la auditoría
 * Julio 1 de 2018 Edwin			- Se evita que aparezcan los tres cifras decimales al consultar el medicamento
 * Mayo 15 de 2018 Jessica			- Para las dosis adaptadas con purga se agrega la unidad del medicamento prescrito por el medico
 * Mayo 8 de 2018 Jessica			- Para las dosis adaptadas con purga, se muestra en el campo DOSIS la dosis sin purga 
 *									  (ordenada por el medico), al hacer alguna modificacion sobre el articulo y guardar se 
 *									  valida si es un articulo de central de mezclas y DA para evitar que se modifique el valor 
 *									  de la dosis Kadcfr por la dosis sin purga.
 * Mayo 7 de 2018 Jessica			- Los articulos E00 se marcan como no enviar para cualquier paciente en un cco diferente a urgencias
 * Mayo 4 de 2018 Jessica			- Se mueve la funcion consultarSiProductoDA() al script cargos.inc.php en cenpro para que pueda 
 *									  ser consulta desde el programa Contingencia Kardex de enfermería, por tal motivo se agrega el 
 *									  include a ese script; tambien se agrega la funcion consultarDosisSinPurgaDA() en ese script ya 
 *									  que se valida si las dosis adaptadas fueron creadas con purga, si es el caso se muestra la dosis 
 * 									  ordenada por el medico en vez de la dosis real del producto (dosis con purga) para evitar 
 * 									  confusiones, en el tooltip se detalla la dosis con purga y sin purga. En la regleta también 
 * 									  se muestra la dosis ordenada por el medico (sin purga).
 * Febrero 13 de 2018 Edwin			- Se cambia campo ubiste por el valor del cco correspondiente
 * 									- Lo médicos y enfermeras en hemodinamia ven todo lo ordenado en piso
 * Febrero 5 de 2018 Edwin			- Se modifica para que los protocolos realizados en una ayuda dx(Hemodinamia) no aparezcan en pisos
 * Febrero 02 de 2018 Jessica		- Se corrige update en la función grabarExamenKardex() ya que en algunos casos quedaba con una 
 *									  coma extra que generaba error 
 * Diciembre 18 de 2017 Jessica		- Se agrega un echo al ajax 61 ya que no se estaba mostrando el diagnóstico en la respuesta ajax
 * Noviembre 28 de 2017 Jessica		- Se modifican las funciones ya que las especialidades por médico se deben consultar en movhos_000065
 *										- consultaInformacionMedico() - Solo se agrega el estado de la consulta a movhos_000048
 *										- generarListaProtocolos() - Se tienen en cuenta todas las especialiades (movhos_000065) del médico para traer la lista de protocolos que aplican para el médico.
 *										- consultarMedicos() - Se agrega movhos_000065 a la consulta de especialidades por médico (pinta la lista de médicos cuando no se ha seleccionado una especialidad - toma la especialidad principal, es decir, Medesp de movhos_000048)
 *										- consultarEspecialidadesUsuarios() - Se agrega movhos_000065 a la consulta de especialidades por médico
 *										- consultarMedicosTratantesHCE() - Se agrega movhos_000065 a la consulta de medicos tratantes
 *										- consultarMedicosTratantesTemporalKardex() - Se agrega movhos_000065 a la consulta de medicos tratantes
 *										- consultarMedicosTratantesDefinitivoKardex() - Se agrega movhos_000065 a la consulta de medicos tratantes
 *										- consultarMedicosPorEspecialidad() - Se agrega movhos_000065 a la consulta de medicos por especialidad
 *										- consultarProtocolo() - Se tienen en cuenta todas las especialiades (movhos_000065) del médico 
 *										  para traer el protocolo, se corrigen las condiciones ya que estaban repetidas y se recibe el 
 *										  código del usuario como parámetro ya que estaba quedando vacio.
 * Noviembre 27 de 2017 Jessica		- Se modifica la función marcarRegistrosLeidos() para que marque como leidos los medicamentos, 
 *									  procedimientos, dietas e informacion general solo si hizo clic en la pestaña. Además se le 
 *									  agrega al ajax 58 la asignacion de las variables $historia e $ingreso ya que como quedaban 
 *									  vacias no se estaba ejecutando la funcion marcarRegistrosLeidos().
 *									- Se habilita el llamado a marcarRegistrosLeidos() en la función salirsigrabar().
 *									- Se agrega el campo Detlog en hce_000028 y movhos_000159 para identificar si la ordenen es nueva o modificada.
 *									- Si en la pestaña Ordenes hay procedimientos pendientes de lectura (Detpen=on) se muestran de otro color. 
 * Septiembre 26 de 2017 Jessica	- Si el centro de costos tiene purga para las dosis adaptadas y el articulo es una DA muestra, se 
 *									  agrega un tooltip con el detalle de la dosis con purga y sin purga.
 *									- Se agrega validacion al insertar el detalle de las NPT para evitar que el detalle quede duplicado.
 * Agosto 14 de 2017 Jessica		- Para los ctc de responsables contributivos, al cerrar la modal de las prescripciones en mipres
 *								  	  se consume el web service del ministerio, se relaciona el consecutivo en movhos_000134 o movhos_000135
 *								  	  y se guarda la prescripcion en las tablas del grupo mipres.
 * Junio 6 de 2017: Edwin MG		- Los examenes y procedimientos quedan con la hora de la auditoría
 * Junio 6 de 2017: Jonatan			- Se agrega el campo Detpri al registro de respaldo de la tabla movhos_000159.
 * Abril 27 de 2017 				- Se muestra el formato de control a los médicos una vez grabe la orden.
 * Abril 5 de 2017 					- Se busca el dx desde la funcion consultarUltimoDiagnosticoHCE que se encuentra en comun.php
 * Marzo 7 de 2017 					- Se agrega la justificación a los procedimientos realizados.
 * Febrero 06 de 2017 				- Se valida que las tablas de extension del kardex (movhos_000208, movhos_000209) antes de insertar los registros no existan en dicha tabla.
 * Enero 24 de 2017					- Todo articulo ordenado desde urgencias siempre queda como ENVIAR, esto se hace para que se pueda dispensar desde urgencias.
 *									- Los articulos que pertenecen a LEV o IC ordenados desde urgencias y están como ENVIAR cambian a NO ENVIAR una vez se traslade a piso.
 *									  El cambio de ENVIAR a NO ENVIAR va de acuerdo a las configuraciones de la tabla movhos_000098. El proceso es realizado 
 * 									  desde cargos PDA(movhos/procesos/cargoscpx.ph), perfil farmacoterapeutico (movhos/procesos/perfilFarmacoterapeutico.php) 
 *									  u ordenes (hce/procesos/ordenes.php) una vez se abra el programa.
 * Diciembre 6 de 2016				- Se agrega parametro en root_000051 (validarBrowserPorCTC) que indica si debe enviar email a soporte para actualizar
 *									  el navegador del usuario.
 * Diciembre 5 de 2016				- Se agregan funciones para consultar si es adulto o pediatrico para validar el peso y la talla
 * 									- Se agregan funciones para abrir y guardar los CTC de responsables contributivos y sus respectivas notas medicas, se 
 *									  activa con el parametro de root_000051 CTCcontributivo en ON y la url de la plataforma del ministerio en urlCTCministerio
 * Noviembre 17 de 2016				- Se agrega validacion de centros de costos al importar protocolos para evitar cargar varias veces el mismo protocolo
 * Noviembre 9 de 2016				- Se modifica el receptor del correo para actualizacion del navegador por cambio en el valor del parametro emailpmla
 * Octubre 04 de 2016				- Cuando se ordena un medicamento No POS y no se hace el CTC se envía un correo a soporte para actualizar el navegador
 * Septiembre 20 de 2016			- Se agrega orden a mostrar en la modal por tipo de orden agrupada
 * Septiembre 19 de 2016			- Se envía email cuando se requiere actualizar el browser Mozilla del cliente a soporte(informatica.clnica@lasamericas.com.co)
 * 									- Se actualiza parametro versionMozilla en root_000051 cuando un usuario tiene una version Superior del browser Mozilla según el parametro
 * Septiembre 13 de 2016			- Se hace registro en aud_cierre_kardex cuando un CTC no se realiza por que la versión del navegador(mozzila) está desactualizado
 * Agosto 26 de 2016				- Se agrega estado para cada uno de los procedimientos de las ordenes agrupadas y se crea indicador de procedimiento imprimiblen
 *										en movhos_000186. 
 * Agosto 3 de 2016 Jessica			- Se modifica la modal de prescripción de NPT para que solo se permita ordenar NPT seguras teniendo en cuenta ciertas condiciones.
 * Junio 17 de 2016. Edwin			- Se corrige para que en la funcion cargarArticulosADefinitivo las horas por frecuencia tengan por defecto una hora inicial
 * Junio 02 de 2016. Edwin			- Se evita que los medicamentos de tipo liquido, indicados en movhos_000066 no les salga la pestaña de NPT.
 * Mayo 11 de 2016 					- Se añade la funcionalidad de procedimientos agrupados, modal que permite seleccionar varios procedimientos a la vez, 
 *										las acciones que toma la orden general deben aplicarse para cada uno de los procedimientos que internamente continuan 
 *										funcionando como siempre.
 *										Por cada procedimiento se pueden adicionar medicamentos y son obligatorios de acuerdo a la configuración de cada procedimiento.
 *										Cuando se cambia el estado a realizado, pendiente de resultado o cancelado se suspenden los medicamentos asociados.
 *										Si uno de los medicamentos tiene como minimo una aplicación el procedimiento no podrá ser cancelado.
 * Mayo 05 de 2016					- Al momento de insertar un medicamento en la tabla temporal del kardex (2016-05-06) se registar el valor del campo Kadlog
 * Mayo 04 de 2016					- Para pedir los ctc por cambio de responsable se valida que no sea una empresa definida en empresasConfirmanCTC de root_000051
 * Abril 19 de 2016					- Las nutriciones se puede confirmar por parte de la enfermera o el médico y siempre pasan desconfirmadas para el día siguiente
 * Marzo 18 de 2016					- Al consultar una orden la primera vez del día se crea el encabezado del kardex
 * Marzo 03 de 2016					- Se cambia query en la función consultarAyudasDiagnosticasPorCodigo para que los procedimientos por protocolos se traigan correctamente
 * Febrero 18 de 2016 				- Si es un articulo de lactario el articulo se registra como no pendiente
 * Febrero 12 de 2016 				- Cualquier centro de costos que maneje ordenes tendra el cco en el encabezado del kardex como * a excepción de lactario
 *									- Se corrige actualización de la enfermera al momento de cambiar un dextrometer
 * Enero 21 de 2015 				- Se consultan los medicamentos y procedimientos sin CTC por cambio de responsable.
 * Septiembre 1 de 20145 Jonatan	- Se valida para los medicos y las dietas que no se dupliquen los registros en la tabla temporal para el primer registro de datos.
 * Agosto 3 de 2015 Jonatan			- Se comenta la la X roja el 3 de agosto de 2015 para que no puedan eliminar articulos, solamente suspender.
 * Julio 31 de 2015 Jonatan			- Se corrige la busque da procedimientos con la ñ, para que la muestre correctamente.
 * Julio 22 de 2015 Jonatan			- Cuando un articulo tipo nutricion parenteral generica es solicitado por primera vez, quedara confirmado y leido, para que se muestre en el perfil.
 * Julio 15 de 2015 Edwin			- Se organizan filtros de estado de familias activas en las cosultas correspondientes al buscar de medicamentos( ajax 31,34 y 35 )
 * Julio 13 de 2015 Edwin			- Se permite buqueda de familias con caracteres especiales (áéíóúñ).
 * Junio 30 de 2015 Edwin			- Se realizan los siguientes cambios
 *									  1. Ordenar medicamentos LEVS(liquidos endovensoso) y de IC(Infusión continua) con una modal nueva
 *									  2. Permite ordenar medicamentos con la misma fecha y hora de inicio.
 * Julio 2 de 2015 Jonatan			- Se agrega la funcion para buscarlo estados activos en el seleccionador de estados de ayudas diagnosticas.
 * Junio 26 de 2015 Jonatan			- Se valida que antes de actualizar un medicamento, el registro no se encuentra en la tabla definitiva del kardex, en caso de encontrar el medicamento
 *									  en la tabla definitiva del kardex se borra el medicamento de la tabla definitiva. Esto para evitar un duplicado de articulo.
 * Junio 25 de 2015 Jonatan			- Se controla para que el esquema de dextromenter no se traslade del dia anterior al actual si esta inactivo el dia anterior.
									- Se registra log para los medicamentos en el campo kadlog, este campo tendra 4 estados incialmente (N=Nuevo, M=Modificado, S=Suspendido, A=Activo),
									  los cuales se mostrarán en el programa de gestion de enfermeria.
 * Junio 05 de 2015 Jonatan			- En el historial de medicamentos no se tendra en cuenta la cantidad de aplicacion cuando un articulo esta suspendido.
 * Junio 02 de 2015 Edwin			- Se valida que cuando a un medicamento se le cambia la frecuencia, devuelva la fecha y hora de inicio nueva con que queda el medicamento.
 *									  Esto se hace para tenerlo en cuenta en el javascript. El cambio se encuentra en la función grabarArticuloDetalle. 
 * Mayo 21 de 2015 Jonatan			- Se agrega funcion de seguimiento que genera un archivo txt, en ese archivo se guaradaran inicialmente los querys de suspendido y 
									  creacion o modificacion de articulos.
 * Abril 07 de 2015 Edwin			- Los articulos que no han sido aplicados y tienen dosis única y no han sido aplicados o no tienen saldo pasan al día siguiente
 * Marzo 31 de 2015 Edwin			- Se añade log cuando los medicamentos no pasan de una tabla a otra al abrir o guardar kardex (movhos 54 a movhos 60 y viceversa)
 * Marzo 11 de 2015 Jonatan			- Se permite eliminar articulos de la pestaña de alta por cualquier especialidad.
									- No permite que el calendario de fecha de inicio del articulo se devuelva a la ronda actual. (Edwin).
									- La DA no se deja marcar si la fecha y hora de inicio es la ronda actual, debe ser la posterior. (Edwin)
 * Marzo 09 de 2015		Edwin MG.	- Se corrige la función vista_desplegarListaArticulosHistorial, no se mostraba bien cuando la familia era igual a la del día siguiente
 * Febrero 26 de 2015 Edwin MG.		- Se hace control al momento de guardar teniendo en cuenta el campo kadido, esto con el fin de poder guardar dos medicamentos
 *									  a la misma fecha y hora cuando el medicamento está suspendido.
 * Febrero 21 de 2015 Jonatan.		- Se muestran los examenes generados desde kardex en la pestaña de ordenes, los cuals pueden ser cambiados de estado.
									- Se genera regleta para articulos creados desde urgencias.
 * Febrero 9 de 2015 Jonatan.		- Se hace control sobre las areas de texto de la pestaña de medidas generales para que segun el rol se puedan ver
									  o  no, ademas se utilizara el campo Rrpnpe para el control de los nombres de las pestañas por rol.
 * Febrero 5 de 2015 Jonatan.		- Se valida por rol si se muestra el medico tratante.
									- Se valida por rol si se muestra la mensajeria.
									- Se valida el lenguaje americas para que no permita repetir exmenes con el mismo nombre.
									- Se valida si el medico desea realizar el CTC de articulos o examenes para un paciente del IDC, se controla con un parametro en la tabla root_000051 (empresasConfirmanCTC).
									- Se guarda la auditoria si el medico decide no realizar CTC para el paciente.
									- Los articulos de lactario se muestran en las nutriciones.
									- En el historico se muestran los medicamentos.
									- Se corrige error al agregar medicamento.
									- Se corrige el Kadido.
									- El parpadeo de los med de central de mezclas se muestran con parpadeo violeta si no estan confirmados.
 * Enero 26 de 2015		Edwin MG.	- Se actualiza los articulos NE de forma similar como las DA en la función actualizarFamiliaProductos
 * Diciembre 30 de 2014 Jonatan. 	- En el buscador de articulos se podra buscar tambien por codigo del articulo, segun la necesidad.
 * Diciembre 04 de 2014 Jonatan.	- Se corrige el registro de medicos tratantes para un paciente, estaban siendo registrados en la tabla hce_000022, 
									  ahora se insertaran en la tabla 47 y 63(temporal). 
 * Diciembre 04 de 2014 Edwin MG.	- Mientras este activo el indicador de ordenes, los medicamentos siempre quedan aprobados para dispensar
 *									- Se agrega la ubiación de paciente cuando este está en urgencias
 *									- Se corrige query ya que al selecccionar una familia permitía elegir una familia desactivada (ajax 31)
 * Noviembre 18 de 2014 Jonatan	  	Se agrega a la consulta de ordenes del paciente las que estan en estado diferente de pendiente solo si el paciente
									se encuentra en urgencias, se mostraran los pendientes arriba y los realizadas abajo en la misma lista.
 *************************************************************************************************************************
 * Octubre 27 de 2014	Edwin MG. 	Si un medicamento no se encuentra en el maestro de familias y tiene una familia asociada
 *									en el campo Kadctr en movhos_000054, se muestra la familia correspondiente a ese campo
 ************************************************************************************************************************/

 

/**********************************
 * INCLUDES
 **********************************/
include_once("root/comun.php");
include_once("root/magenta.php");
include_once("cenpro/cargos.inc.php");
include_once("./../../interoperabilidad/procesos/funcionesGeneralesEnvioHL7.php");

/**********************************
 * VARIABLES GLOBALES
 **********************************/
//Conexion base de datos
$conex = obtenerConexionBD("matrix");
	
$strPendientesCTC="";
 
 $grupoControl = "CTR";

$centroCostosServicioFarmaceutico = "1050";

if( $wemp_pmla == '02')
	$centroCostosServicioFarmaceutico = "1505";

$centroCostosCentralMezclas = "1051";

$codigoServicioFarmaceutico = "SF";
$codigoCentralMezclas = "CM";

$descripcionServicioFarmaceutico = "Servicio farmacéutico";
$descripcionCentralMezclas = "Central de mezclas";
$descripcionOtroServicio = "Otro servicio";

$articuloInsulina = "I";

//Tipos de protocolo
$protocoloNormal = "N";
$nombreProtocoloNormal = "Normal";
$protocoloNutricion = "U";
$nombreProtocoloNutricion = "Nutricion";
$protocoloAnalgesia = "A";
$nombreProtocoloAnalgesia = "Analgesia";
$protocoloQuimioterapia = "Q";
$nombreProtocoloQuimioterapia = "Quimioterapia";

// Regleta con dosis por ronda para cada familia
$regletaFamilia = array();

//Nombre del esquema de hce
$esquemaBDHce = consultarAliasPorAplicacion($conex,$wemp_pmla,"hce");
$codigoAplicacion = "ordenes";
$codigoAyudaHospitalaria="H";


//Consulta de la información del usuario
@$usuario = consultarUsuarioOrdenes($wuser);

/**********************************
 * PARAMETROS DE LA BASE DE DATOS *
 **********************************/
$horaCorteDispensacion 	= consultarAliasPorAplicacion($conex,$wemp_pmla,"horaCorteDispensacion");
$inicioDiaDispensacion 	= consultarAliasPorAplicacion($conex,$wemp_pmla,"inicioDiaDispensacion");
$topePorcentualCtc 		= consultarAliasPorAplicacion($conex,$wemp_pmla,"topePorcentualCTC");

$diasDispensacion = 1;
if( $wemp_pmla == '02' )
	$diasDispensacion = 7;

/***********************************
 * CLASES
 ***********************************/

class tiposAyudasDxHCEDTO{
	var $codigo = "";
	var $descripcion = "";
	var $arc_HL7 = "";
	var $programa = "";
	var $formato = "";
}

class UsuarioOrden{
	var $codigo;
	var $contrasena;
	var $descripcion;
	var $empresa;

	//Centro costos
	var $centroCostos;
	var $nombreCentroCostos;
	var $centroCostosHospitalario;
	var $centroCostosGrabacion;
	var $pestanasKardex;
	var $gruposMedicamentos;
	var $gruposMedicamentosQuery;
	var $esUsuarioCM;
	var $esUsuarioSF;
	var $esUsuarioCTC;
	var $esUsuarioLactario;

	//Campos HCE
	var $codigoRolHCE = "";
	var $nombreRolHCE = "";
	var $pestanasHCE = "";
	var $nombreEmpresaAgrupada = "";
	var $empresasAgrupadas = "";
	var $codigoEmpresaAgrupada = "";
	var $firmaElectronicamente = "";
	
	var $esCcoUrgencias = false;
	var $esCcoCirugia = false;
	var $esCcoIngreso = false;
	
	// var $permisosPestanas = "";
	var $permisosPestanas = array();
	
	//Registro en Tabla Medicos
	var $registradoMedico;
	
	var $tieneFirmaVencida = true;
}

class detalleKardexDTO {
	var $historia = "";
	var $ingreso = "";
	var $fecha = "";
	var $codigoArticulo = "";
	var $nombreArticulo = "";
	var $unidadDosis = "";				//Unidad de fraccion a aplicar
	var $cantidadDosis = "";			//Partes de la unidad de manejo
	var $periodicidad = "";
	var $condicionSuministro = "";
	var $formaFarmaceutica = "";
	var $diasTratamiento = "";
	var $estadoRegistro = "";
	var $estadoAdministracion = "";
	var $fechaInicioAdministracion = "";
	var $horaInicioAdministracion = "";
	var $fechaFinAdministracion = "";
	var $fechaKardex = "";
	var $horaKardex = "";
	var $via = "";
	var $origen = "";
	var $dosisMaxima = "";
	var $estaConfirmado = "";
	var $observaciones = "";
	var $suspendido = "";
	var $cantidadGrabar = "";
	var $cantidadUnidadManejo = "";
	var $unidadManejo = "";
	var $grupo = "";
	var $cantidadADispensar = "";
	var $cantidadDispensada = "";
	var $permiteModificar = "";
	var $permiteReemplazar = "";
	var $centroCostos = "";
	var $maximoUnidadManejo = "";
	var $unidadMaximoManejo = "";
	var $vencimiento = "";
	var $diasVencimiento = "";
	var $esDispensable = "";
	var $esDuplicable = "";
	var $tienePrioridad = "";
	var $estaAprobado = "";

	var $campoAuxiliar = "";
	var $tipoProtocolo = "";
	var $diasTotalesTto = "";
	var $dosisTotalesTto = "";
	var $saldoDispensacion = "";
	var $viasPosibles = "";
	var $nombreProtocolo = "";

	var $fechaCreacion = "";		//Corresponde a fecha data de movhos_000053 o movhos_000060
	var $horaCreacion = "";			//Corresponde a fecha data de movhos_000053 o movhos_000060
	var $esPos = "";

	var $cantidadAutorizadaCtc = "";
	var $cantidadUtilizadaCtc = "";
	var $unidadesCantidadesCtc = "";
	
	var $estadoArticulo = "";
	
	var $codigoCreador = "";		//Codigo de usuario quien crea el articulo
	
	var $codigoFamilia = "";
	var $nombreFamilia = "";
	
	var $nombreGenerico = "";	//Agosto 27 de 2012
	
	var $esLev = "";	//Agosto 15 de 2014	Indica si un articulo fue agregado como LEV 
	
	var $esLactario = "";	//Agosto 15 de 2014	Indica si un articulo fue agregado como LEV 
	
	var $idOriginal = "";	//Agosto 15 de 2014	Indica si un articulo fue agregado como LEV 
	
	var $presentacionPermiteDA = ""; 	//Marzo 02 de 2015
	
	var $descripcionPrincipioActivo = ""; 	//Junio 16 de 2015
	var $codigoPrincipioActivo = ""; 		//Junio 16 de 2015
	
	
	var $esAntibiotico = ""; 		//Julio 6 de 2016
	
	var $tratamiento = "";
	var $profilaxis = "";
	
	var $esPediatrico = "";
	var $conInsumo1 = "";
	var $conInsumo2 = "";
	var $porProtocolo = "";
	
	
	/******************************************************************************
	 * Consulta la familia atc del articulo
	 *****************************************************************************/
	function consultarFamiliaATC( $conex, $wbasedato ){
	
		$val = [];
		
		$sql = "SELECT Atccod, Atcdes
				  FROM ".$wbasedato."_000026, ".$wbasedato."_000280
				 WHERE artcod = '".$this->consultarCodigoArticulo()."'
				   AND FIND_IN_SET( atccod, artfat ) > 0	
				   AND atcest = 'on'
				 ";
		
		$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
		$num = mysql_num_rows($res);

		if( count($num) > 0 ){
			
			$val = [];
			
			while( $rows = mysql_fetch_array( $res ) ){
				$val[] = [
						'codigo' 		=> $rows['Atccod'],
						'descripcion' 	=> $rows['Atcdes'],
					];
			}
		}
		
		return $val;
	}

	/************************************************************************************
	 * Metodo que obtiene el codigo del articulo
	 * Creado: Diciembre 5 de 2011
	 ************************************************************************************/
	function consultarCodigoArticulo(){
		$datos = explode( "-", $this->codigoArticulo );
		
		return $datos[ 0 ];
	}
	
	/************************************************************************************
	 * Metodo que obtiene el nombre comercial del articulo
	 * Creado: Diciembre 5 de 2011
	 ************************************************************************************/
	function consultarNombreArticulo(){
		$datos = explode( "-", $this->codigoArticulo );
		
		return $datos[ 2 ];
	}
	
	function consultarDatosExtensionDetalleKardexPorArticulo( $conex, $wbasedato, $tabla, $his, $ing, $fecha, $art, $ido ){
		
		global $centroCostosServicioFarmaceutico;
	
		$val = false;
		
		$sql = "SELECT *
				  FROM ".$wbasedato."_".$tabla.", ".$wbasedato."_000059
				 WHERE Ekxhis = '".$his."'
				   AND Ekxing = '".$ing."'
				   AND Ekxfec = '".$fecha."'
				   AND Ekxart = '".$art."'
				   AND Ekxido = '".$ido."'
				   AND Ekxest = 'on'
				   AND Ekxart = Defart
				   AND Defcco = '".$centroCostosServicioFarmaceutico."'
				 ";
		
		$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
		$num = mysql_num_rows($res);
		
		if( $rows = mysql_fetch_array( $res ) ){
			$val = $rows;
		}
		
		return $val;
	}
	
	function setDatosExtension(){
		
		global $conex;
		global $wbasedato;
		global $wemp_pmla;
		
		//Consulto los datos de la extensión del kardex
		$datos = $this->consultarDatosExtensionDetalleKardexPorArticulo( $conex, $wbasedato, "000208", $this->historia, $this->ingreso, $this->fechaKardex, $this->consultarCodigoArticulo(), $this->idOriginal );
		if( $datos === false ){
			$datos = $this->consultarDatosExtensionDetalleKardexPorArticulo( $conex, $wbasedato, "000209", $this->historia, $this->ingreso, $this->fechaKardex, $this->consultarCodigoArticulo(), $this->idOriginal );
		}
		
		//Seteo los datos de la tabla de extension del kardex
		if( count($datos)> 0 ){
			$this->profilaxis 			= $datos['Ekxpro'] == 'on' ? true: false;
			$this->tratamiento 			= $datos['Ekxtra'] == 'on' ? true: false;
			$this->esPediatrico 		= $datos['Ekxped'] == 'on' ? true: false;
			$this->conInsumo1 			= $datos['Defcpa'];	//concentracion insumo 1
			$this->conInsumo2 			= $datos['Defcsa'];	//concentracion insumo 1
			$this->conInsumoCalculado1 	= $datos['Ekxin1'];	//concentracion insumo 1
			$this->conInsumoCalculado2 	= $datos['Ekxin2'];	//concentracion insumo 2
			$this->esAntibioticoCompuesto=$datos['Defcmp'] == 'on' ? true: false;	//concentracion insumo 2
			$this->porProtocolo			= $datos['Ekxayu'] != '' ? true: false;	//concentracion insumo 2
			
			$this->autorizadoPorDirector= $datos['Ekxaut'] == 'on' ? true: false;	//Articulo con tarifa
			$this->jusParaAutorizar		= $datos['Ekxjus'];	//Justificación parar odenar el medicamento sin tarifa
			$this->fechaAutorizado		= $datos['Ekxfau'];	//Fecha de aprobación del articulo por director Médico
			$this->horaAutorizado		= $datos['Ekxhau'];	//Hora de aprobacion del articulo por director médico
			$this->directorMedico		= $datos['Ekxmau'];	//Director médico que autoriza el medicamento
			$this->justificacionDM		= $datos['Ekxjau'];	//Justificación del director médico
		}
	}
	
	function consultarUltimaAplicacion(){
		
		global $conex;
		global $wbasedato;
		
		$val = array(
			'fecha' 	=> '0000-00-00',
			'hora'  	=> '00:00:00',
			'unix'  	=> 0,
			'unixUTC'  	=> 0,
		);
		
		$sql = "SELECT Aplfec, Aplron
				  FROM ".$wbasedato."_000015
				 WHERE aplhis = '".$this->historia."'
				   AND apling = '".$this->ingreso."'
				   AND aplart = '".$this->consultarCodigoArticulo()."'
				   AND aplido = '".$this->idOriginal."'
				   AND aplest = 'on'
			  ORDER BY 1 DESC, 2 DESC
				";

		$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
		$num = mysql_num_rows( $res );

		if( $rows = mysql_fetch_array( $res ) ){
			
			$hora = substr( $rows['Aplron'], 0, 2 ).":00:00";
			
			$val['fecha']	= $rows['Aplfec'];
			$val['hora']	= $hora;
			$val['unix']	= strtotime( $rows['Aplfec']." ".$hora );
			$val['unixUTC']	= strtotime( $rows['Aplfec']." ".$hora." UTC" );
		}

		return $val;
	}
}

class medicoDTO {
	var $tipoDocumento = "";
	var $numeroDocumento = "";
	var $nombre1 = "";
	var $nombre2 = "";
	var $apellido1 = "";
	var $apellido2 = "";
	var $telefono = "";
	var $registroMedico = "";
	var $interconsultante = "";
	var $tratante = "";
	var $codigoEspecialidad = "";
	var $usuarioMatrix = "";
	var $id = "";
}

class dietaKardexDTO {
	var $id = "";
	var $codigoDieta = "";
	var $descripcionDieta = "";
	var $historia = "";
	var $ingreso = "";
	var $fechaKardex = "";
	var $estado = "";
}

class cambioKardexDTO{
	var $historia = "";
	var $ingreso = "";
	var $fecha = "";
	var $hora = "";
	var $descripcion = "";
	var $mensaje = "";
	var $usuario = "";
}

class kardexDTO {
	var $historia = "";
	var $ingreso = "";
	var $fechaCreacion = "";
	var $fechaGrabacion = "";
	var $horaCreacion = "";
	var $observaciones = "";
	var $estado = "";
	var $rutaOrdenMedica = "";
	var $diagnostico = "";
	var $talla = "";
	var $peso = "";
	var $antecedentesAlergicos = "";
	var $cuidadosEnfermeria = "";
	var $terapiaRespiratoria = "";
	var $sondasCateteres = "";
	var $curaciones = "";
	var $interconsulta = "";
	var $consentimientos = "";
	var $medidasGenerales = "";
	var $preparacionAlta = "";
	var $confirmado = "";
	var $usuario = "";

	var $firmaDigital = "";
	var $obsDietas = "";
	var $mezclas = "";
	var $procedimientos = "";
	var $dextrometer = "";
	var $cirugiasPendientes = "";
	var $terapiaFisica = "";
	var $rehabilitacionCardiaca = "";
	var $antecedentesPersonales = "";
	var $aislamientos = "";

	var $esAnterior = "";
	var $editable = "";
	var $grabado = "";
	var $aprobado = "";
	var $esPrimerKardex = "";

	var $usuarioQueModifica = "";
	var $nombreUsuarioQueModifica = "";
	var $centroCostos = "";
	var $noAcumulaSaldoDispensacion = "";
	var $descontarDispensaciones = "";
	var $horaDescuentoDispensaciones = "";
}

class pacienteKardexDTO {
	var $historiaClinica = "";
	var $ingresoHistoriaClinica = "";
	var $documentoIdentidad = "";
	var $tipoDocumentoIdentidad = "";
	var $nombre1 = "";
	var $nombre2 = "";
	var $apellido1 = "";
	var $apellido2 = "";

	//Adicionales en UNIX
	var $fechaIngreso = "";
	var $horaIngreso = "";
	var $servicioActual = "";
	var $servicioAnterior = "";
	var $servicioAnteriorUrgencias = "";
	var $servicioAnteriorCirugia = "";
	var $habitacionActual = "";
	var $habitacionAnterior = "";
	var $numeroIdentificacionResponsable = "";
	var $nombreResponsable = "";
	var $genero = "";
	var $fechaNacimiento = "";
	var $deHospitalizacion = "";
	var $ultimoMvtoHospitalario = "";
	var $fechaHoraIngresoServicio = "";
	var $nombreServicioActual = "";

	var $altaProceso = "";
	var $altaDefinitiva = "";
	
	var $sexo = "";
	
	var $esDeAyudaDx = false;
	
	var $servicioRealActual = "";
	var $nombreRealServicioActual = "";
}

class DietaDTO{
	var $codigo = "";
	var $descripcion = "";
	var $estado = "";
}

class RegistroGenericoDTO{
	var $codigo = "";
	var $descripcion = "";
	var $observacion = "";
	var $fecha = "";
	
	var $valDefecto = "";	//Junio 13 de 2012. Valor por defecto
	var $accion_med_proc_agrup = "";	//Abril 2015. Accion a tomar para medicamentos de procedimientos agrupados
	var $est_cancelada = "";	//Abril 2015. Estados cancelados para medicamentos de procedimientos agrupados
	var $est_realizado = "";	//Abril 2015. Estados realizados para medicamentos de procedimientos agrupados
}

//Clase que maneja las condiciones de suministro
class CondicionesDTO{
	var $codigo = "";
	var $descripcion = "";
	var $observacion = "";
	var $fecha = "";
	
	var $valDefecto = "";	//Junio 13 de 2012. Valor por defecto
	var $permiteDma = "";	//Febrero 17 de 2015
	var $permiteDtt = "";	//Febrero 17 de 2015
	var $esANEC = "";	//Febrero 17 de 2015
	var $permiteDva = "";	//Abril 20 de 2016. Permite dosis variable
}

class RegistroEstadoDet{
	var $estado = "";
}

class CentroCostosOrdenesDTO{
	var $codigo = "";
	var $nombre = "";
	var $consecutivoOrden = "";
}

class PeriodicidadDTO{
	var $codigo = "";
	var $descripcion = "";
	var $equivalencia = "";
	var $dosisMax;
	var $condicion;
	var $tipo;
	var $esTipoInsulina;
	var $esTipoCorriente;
}

class AuditoriaDTO{
	var $fechaRegistro = "";
	var $horaRegistro = "";
	var $historia = "";
	var $ingreso = "";
	var $fechaKardex = "";
	var $descripcion = "";
	var $mensaje = "";
	var $seguridad = "";

	//Anexo para reporte de cambios por tiempo
	var $servicio = "";
	var $confirmadoKardex = "";
	
	var $idOriginal = 0;
}

class MedicamentoHorarioDTO{
	var $servicio = "";
	var $habitacion = "";
	var $historia = "";
	var $fechaKardex = "";
	var $fechaInicioAdministracion = "";
	var $horaInicioAdministracion = "";
	var $horasFrecuencia = "";
	var $ingreso = "";
	var $paciente = "";
	var $codigoArticulo = "";
	var $seguridad = "";
	var $dosis = "";
	var $unidadDosis = "";
	var $horaConsulta = "";
	var $frecuencia = "";
	var $via = "";

	var $diasTratamiento = "";
	var $dosisMaximas = "";
	var $observaciones = "";
	var $cantidadADispensar = "";
	var $cantidadDispensada = "";
	var $condicion = "";
	var $estadoKardex = "";
}

class ReportesKardexDTO{
	var $historia = "";
	var $ingreso = "";
	var $paciente = "";
	var $servicio = "";
	var $habitacion = "";
	var $detalle = "";
	var $fecha = "";
}

class ExamenKardexDTO{
	var $codigoExamen = "";
	var $descripcionExamen = "";
	var $historia = "";
	var $ingreso = "";
	var $fecha = "";
	var $fechaDeSolicitado = "";
	var $estado = "";
	var $observaciones = "";
	var $justificacion = "";

	var $campoAuxiliar = "";
}

class ExamenHCEDTO{
	var $fecha = "";
	var $hora = "";
	var $historia = "";
	var $ingreso = "";
	var $tipoDeOrden = "";
	var $numeroDeOrden = "";
	var $observacionesOrden = "";
	var $estadoOrden = "";
	var $estadoRegistroOrden = "";
	var $firmaOrden = "";
	var $fechaARealizar = "";
	var $horaARealizar = "";

	var $nombreCentroCostos = "";
	var $nombreExamen = "";

	var $codigoExamen = "";
	var $estadoExamen = "";
	var $resultadoExamen = "";
	var $estadoRegistroExamen = "";
	var $justificacion = "";
	var $protocoloPreparacion = "";
	var $nroItem = "";
	var $tipoEstudio = "";
	var $tipoAyudasDxs = "";
	
	var $tieneAnteriores = false;
	var $totalPendientes = 0;
	var $totalAnteriores = 0;
	
	var $creadorOrden = "";
	var $creadorItem = "";
	var $requiereJustificacion = "";
	
	// Agosto 21 de 2019. 
	// Este estado indica que fue modificado externamente
	// Al momento de crear este campo es el estado de laboratorio, el cuál se modifica
	// de acuerdo a los mensajes HL7 que envía el laboratorio con respecto a cada examen 
	// que procesan.
	// Por este motivo, el usuario no puede modificar este estado
	var $estadoExterno = "";
	
	//Indica si se le permite anexar una nueva orden
	var $anexarOrden = false;
	
	//Contiene la descripción del estado externo (Estado de homologación HL7)
	var $descripcionEstadoExterno = "";
	
	//Mostrar estado externo
	var $mostrarEsadoExterno = false;
	
	//Indica si permite al usuario tomar muestra
	var $solicitaUsuarioTomaMuestra = false;
	
	/************************************************************************************
	 * Si el estudio tiene estado externo (Deteex de hce 28) verifica si puede al enfermera
	 * puede tomar muestra
	 ************************************************************************************/
	public function permiteTomarMuestra( $conex, $wbasedato, $permitePorCco ){
			
		$sql = "SELECT Estptm
				  FROM ".$wbasedato."_000257
				 WHERE Esthl7 = '".$this->estadoExterno."'
				   AND Estest = 'on'
				";
				
		$res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
		
		if( $row = mysql_fetch_array($res) ){
			$this->solicitaUsuarioTomaMuestra = strtolower( $permitePorCco && $row['Estptm'] == 'on' ) || !empty( $this->usuarioTomaMuestra ) ? $this->solicitaUsuarioTomaMuestra : false;
		}
	}
	
	/************************************************************************************
	 * Este método indica si un examen se puede modificar la fecha del examen una vez comience
	 * la interoperabilidad con laboratorio según el estado en que se encuentre 
	 * en laboratorio (estado externo)
	 ************************************************************************************/
	public function permiteModificarFecha( $conex, $wbasedato ){
		
		$val = true;
			
		$sql = "SELECT Estpmf
				  FROM ".$wbasedato."_000257 a
				 WHERE Esthl7 = '".$this->estadoExterno."'
				   AND Estest = 'on'
				";
				
		$res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
		
		if( $row = mysql_fetch_array($res) ){
			$val = strtolower( $row['Estpmf'] ) == 'on';
		}
		
		return $val;
	}
	
	/************************************************************************************
	 * Este método indica si un examen se puede cancelar una vez comience
	 * la interoperabilidad con laboratorio según el estado en que se encuentre 
	 * en laboratorio (estado externo)
	 ************************************************************************************/
	public function permiteCancelarExamen( $conex, $wbasedato ){
		
		$val = false;
		
		//Tiene interoperabilidad si tipo de orden se encuentra en la tabla de sedes (movhos_000264 para Sistema HIRUKO de IMEXH)
		//o en la tabla de tipos ofertados (movhos_000267 para laboratorio)
		// $sql = "SELECT Valtor
				  // FROM ".$wbasedato."_000267 a
				 // WHERE Valtor = '".$this->tipoDeOrden."'
				   // AND Valest = 'on'
				 // UNION
				// SELECT Sedtor as Valtor
				  // FROM ".$wbasedato."_000264 a
				 // WHERE Sedtor = '".$this->tipoDeOrden."'
				   // AND Sedest = 'on'
				// ";
				
		// $res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
		// $num = mysql_num_rows( $res );
		
		// if( $num > 0 ){
			
		$permiteModificarEstado = $this->permiteModificarEstado( $conex, $wbasedato );
		
		if( !$permiteModificarEstado ){
			
			$sql = "SELECT Estpme
					  FROM ".$wbasedato."_000257 a
					 WHERE Esthl7 = '".$this->estadoExterno."'
					   AND Estest = 'on'
					";
					
			$res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
			
			$val = true;
			if( $row = mysql_fetch_array($res) ){
				$val = strtolower( $row['Estpme'] ) == 'on';
			}
		}
		
		return $val;
	}
	
	/************************************************************************************
	 * Este método indica si a un examen se le puede modificar el estado una vez comience
	 * la interoperabilidad con laboratorio
	 ************************************************************************************/
	public function permiteModificarEstado( $conex, $wbasedato ){
		
		global $wemp_pmla;
		
		if( empty($wemp_pmla) )
			$wemp_pmla = '01';
		
		$val = true;
		
		if( !empty($this->estadoExterno) )
		{ 
			//Tiene interoperabilidad si tipo de orden se encuentra en la tabla de sedes (movhos_000264 para Sistema HIRUKO de IMEXH)
			//o en la tabla de tipos ofertados (movhos_000267 para laboratorio)
			$sql = "SELECT Valtor
					  FROM ".$wbasedato."_000267 a
					 WHERE Valtor = '".$this->tipoDeOrden."'
					   AND Valest = 'on'
					";
					
			$res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
			$num = mysql_num_rows( $res );
			
			if( $num > 0 ){
				$val = false;
			}
		}
		
		return $val;
	}
	
	/************************************************************************************
	 * Este método indica si a un examen se le puede modificar el estado una vez comience
	 * la interoperabilidad con laboratorio
	 ************************************************************************************/
	public function consultarDescripcionEstadoExterno( $conex, $wbasedato ){
		
		$val = "";
		
		//Busco el estado del examen
		//Solo cambia si es estado cancelado
		$sql = "SELECT b.*
				  FROM ".$wbasedato."_000257 b
				 WHERE Esthl7 = '".$this->estadoExterno."'
				   AND Estest = 'on'
				";
				
		$res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
		$num = mysql_num_rows( $res );

		if( $num > 0 ){
			if( $rows = mysql_fetch_array($res) ){
				$val = $rows['Estdpa'];
			}
		}
		
		return $val;
	}
}

class pestanaKardexDTO{
	var $codigoPestana = "";
	var $nombrePestana = "";
	var $estado = "";
	var $posicion = "";
	var $rutaScript = "";
	var $tablaGrabacion = "";
}

class IntervaloDextrometerDTO{
	var $minimo = "";
	var $maximo = "";
	var $dosis = "";
	var $unidadDosis = "";
	var $observaciones = "";
	var $via = "";
}

class ArticuloDTO{
	var $codigo = "";
	var $nombre = "";
	var $centroCostos = "";
	var $estado = "";
	var $frecuencia = "";
	var $codEsquema = "";
	var $tipo = "";
	var $via = "";
}

class PestanaDTO{
	var $nroPestana = "";
	var $nombrePestana = "";
	var $colAcciones = "";
}

class AccionPestanaDTO{
	var $nroPestana = "";
	var $codigoAccion = "";
	var $crear = "";
	var $leer = "";
	var $borrar = "";
	var $actualizar = "";
}

/***********************************
 * FUNCIONES
 ***********************************/

function hayArticuloAutorizado( $conex, $wmovhos, $codigo, $his, $ing ){
	
	$val = false;
	
	//Consultando el nombre del estudio
	$sql = "SELECT Ekxaut, Ekxjus, Ekxfau, Ekxhau, Ekxmau, Ekxjau
			  FROM ".$wmovhos."_000208 a
			 WHERE a.Ekxaut  = 'on'
			   AND a.Ekxhis  = '".$his."'
			   AND a.Ekxing  = '".$ing."'
			   AND a.Ekxart  = '".$codigo."'
			 UNION
			SELECT Ekxaut, Ekxjus, Ekxfau, Ekxhau, Ekxmau, Ekxjau
			  FROM ".$wmovhos."_000208 a
			 WHERE a.Ekxaut  = 'on'
			   AND a.Ekxhis  = '".$his."'
			   AND a.Ekxing  = '".$ing."'
			   AND a.Ekxart  = '".$codigo."'
			 ";

	$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error()); 
	
	if( $rows = mysql_fetch_array ($res) ){
		$val = true;
	}
	
	return $val;
}

function articuloTieneTarifa( $conex, $wcliame, $wmovhos, $codigo, $tarifa ){
	
	$val = false;
	
	//Consultando el nombre del estudio
	$sql = "SELECT Artcod
			  FROM ".$wmovhos."_000026 a, ".$wcliame."_000026 b
			 WHERE a.artcod = b.mtaart
			   AND a.artest = 'on'
			   AND b.mtaest = 'on'
			   AND b.mtatar = '".$tarifa."'
			   AND a.artcod = '".$codigo."'
			 ";

	$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error()); 
	
	if( $rows = mysql_fetch_array ($res) ){
		$val = true;
	}
	
	return $val;
}

/**
 * Consulta los dias de dispensación por centro de costos donde se encuentra ubicado el paciente
 * 
 */
function consultarDiasDispensacion( $conex, $wmovhos, $his, $ing ){
	
	$val = 1;
	
	//Consultando el nombre del estudio
	$sql = "SELECT Ccoddi
			  FROM ".$wmovhos."_000011 a, ".$wmovhos."_000018 b
			 WHERE a.ccocod = b.ubisac
			   AND a.ccoest = 'on'
			   AND b.ubihis = '".$his."'
			   AND b.ubiing = '".$ing."'
			 ";

	$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error()); 
	
	if( $rows = mysql_fetch_array ($res) ){
		$val = $rows['Ccoddi'];
	}
	
	return $val;
} 
 
function consultarEstudioPorOrdenClinica( $conex, $whce, $wtor, $wnro, $wite ){
				
	$val = '';
	
	//Consultando el nombre del estudio
	$sql = "SELECT b.Descripcion
			  FROM ".$whce."_000028 a, ".$whce."_000047 b
			 WHERE a.Dettor = '".$wtor."' 
			   AND a.Detnro = '".$wnro."'
			   AND a.Detite = '".$wite."'
			   AND b.Codigo = Detcod
			 ";

	$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error()); 
	
	if( $rows = mysql_fetch_array ($res) ){
		$val = $rows['Descripcion'];
	}
	
	return $val;
}
 
function enviarALaboratorioHL7Faltantes( $conex, $wemp_pmla, $wmovhos, $whce, $usuario ){
	
	$val = '';
	
	//Consulto los tipo de orden para Hiruko
	$sql = "SELECT Sedtor
			  FROM ".$wmovhos."_000264 a
			 WHERE Sedest = 'on'
			 ";
	
	$resH 	= mysql_query( $sql, $conex ) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
	
	$tipoOrdenHiruko = [];
	
	while( $rowsH = mysql_fetch_array( $resH ) ){
		$tipoOrdenHiruko[] = $rowsH['Sedtor'];
	}
	
	//Consulto si existe cups ofertados por tipo de orden
	$sql = "SELECT a.habcod, a.habhis, a.habing, c.Dettor
			  FROM ".$wmovhos."_000020 a, ".$whce."_000027 b, ".$whce."_000028 c, ".$whce."_000047 d
			 WHERE a.habhis  = b.ordhis
			   AND a.habing  = b.ording
			   AND c.dettor  = b.ordtor
			   AND c.detnro  = b.ordnro
			   AND c.detest  = 'on'
			   AND b.ordest  = 'on'
			   AND c.detenv  = 'on'
			   AND d.codigo  = c.detcod
			   AND d.codcups!= ''
			   AND ( c.fecha_data < '".date("Y-m-d")."' 
			    OR ( c.fecha_data = '".date("Y-m-d")."' AND c.hora_data <= '".date("H:i:s", time()-10*60 )."') )
		  GROUP BY 1,2,3,4
			 ";
	
	$res 	= mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
	
	while( $rows = mysql_fetch_array( $res ) ){
		
		if( in_array( $rows['Dettor'], $tipoOrdenHiruko ) ){
			//Esta función se encarga de enviar las ordenes al sistema Hiruko, validando por tipo de orden en la tabla de sedes de Hiruko
			enviarOrdenesAAgendar( $conex, $whce, $wmovhos, $rows['habhis'], $rows['habing'] );
		}
		else{
			//Esta función envía las ordenes a laboratorio
			crearMensajesHL7OLM( $conex, $wemp_pmla, $wmovhos, $rows['habhis'], $rows['habing'], $usuario );
		}
	}
	
	return $val;
}


function enviarOrdenesAAgendar( $conex, $whce, $wbasedato, $historia, $ingreso ){
				
	$ids = [];
	
	// AND a.Ordfec = '".date("Y-m-d")."'
	//En este caso se debe procesar las ordenes cuyo tipo de orden se encuentran en las sedes de Hiruko (movhos 264)
	$sql = "SELECT a.*
			  FROM ".$whce."_000027 a, ".$whce."_000028 b, ".$wbasedato."_000264 c
			 WHERE a.Ordhis = '".$historia."'
			   AND a.Ording = '".$ingreso."'
			   AND a.Ordest = 'on'
			   AND a.Ordtor = b.Dettor
			   AND a.Ordnro = b.Detnro
			   AND b.Detenv = 'on'
			   AND c.Sedtor = a.Ordtor
		 GROUP BY Ordtor, Ordnro
			   ";
	
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	
	for( $i = 0; $rows = mysql_fetch_array($res); $i++ ){
	
		// Crea un nuevo recurso cURL
		$ch = curl_init();
		
		$data = array( 
				'consultaAjax'	=> '',
				'accion'		=> 'agendarOrden', 
				'historia'		=> $historia,
				'ingreso'		=> $ingreso, 
				'tipoOrden'		=> $rows['Ordtor'], 
				'nroOrden'		=> $rows['Ordnro'], 
			);
		
		
		// curl_setopt($ch, CURLOPT_POSTFIELDS, $data);

		// set URL and other appropriate options
		$options = array(
					CURLOPT_URL 			=> 'localhost/matrix/interoperabilidad/procesos/IoImagenologia.php',
					CURLOPT_HEADER 			=> false,
					CURLOPT_POSTFIELDS 		=> $data,
					CURLOPT_CUSTOMREQUEST 	=> 'POST',
				);

		$opts = curl_setopt_array($ch, $options);
		
		if( $opts === false )
			echo "Opciones mal configuradas...";

		// grab URL and pass it to the browser
		$exec = curl_exec($ch);
		
		if( $exec === false ){
			echo "No hizo nada....";
		}
		else{
			$ids[] = $rows['id'];
		}

		// close cURL resource, and free up system resources
		curl_close($ch);
	}
	
	// if( count( $ids ) > 0 ){
		
		// $sql = "UPDATE ".$whce."_000027 a, ".$whce."_000028 b
				   // SET Detenv = 'off',
					   // Deteex = 'E'
				 // WHERE a.id in(".implode( ",", $ids ).")
				   // AND b.Dettor = a.Ordtor
				   // AND b.Detnro = a.Ordnro
			// ";
	
		// $resEnv	= mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
		
		
		// $sql = "UPDATE ".$whce."_000027 a, ".$wbasedato."_000159 b
				   // SET Detenv = 'off',
					   // Deteex = 'E'
				 // WHERE a.id in(".implode( ",", $ids ).")
				   // AND b.Dettor = a.Ordtor
				   // AND b.Detnro = a.Ordnro
			// ";
	
		// $resEnv	= mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	// }
	
}
 
 
function consultarCupPorEstudio( $conex, $whce, $tor, $nro, $item ){
	
	$val = '';
	
	//Consulto si existe cups ofertados por tipo de orden
	$sql = "SELECT b.Codcups
			  FROM ".$whce."_000028 a, ".$whce."_000047 b
			 WHERE Dettor = '".$tor."'
			   AND Detnro = '".$nro."'
			   AND Detite = '".$item."'
			   AND Detcod = Codigo
			 UNION
			SELECT b.Codcups
			  FROM ".$whce."_000028 a, ".$whce."_000017 b
			 WHERE Dettor = '".$tor."'
			   AND Detnro = '".$nro."'
			   AND Detite = '".$item."'
			   AND Detcod = Codigo
			   AND estado = 'on'
			   AND nuevo != 'on'
			 ";
	
	$res 	= mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
	
	if( $rows = mysql_fetch_array( $res ) ){
		$val = $rows['Codcups'];
	}
	
	return $val;
}
 
function esCupOfertado( $conex, $wbasedato, $tor, $cup ){
	
	$val = false;
	
	//Consulto si existe cups ofertados por tipo de orden
	$sql = "SELECT Valtoc, Valcoc, Valeoc, Valerl
			  FROM ".$wbasedato."_000267
			 WHERE valtor = '".$tor."'
			   AND valest = 'on'
		  GROUP BY 1,2,3";
	
	$resToOfertado 	= mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
	$numToOfertado	= mysql_num_rows($resToOfertado);
	
	if( $numToOfertado > 0 ){
		
		if( $rowsToOfertado = mysql_fetch_array( $resToOfertado ) )
		{
			$tablaOfertas 		= $rowsToOfertado['Valtoc'];
			$campoOferta		= $rowsToOfertado['Valcoc'];
			$campoEstado		= $rowsToOfertado['Valeoc'];
			$campoRealizaUnidad	= trim( $rowsToOfertado['Valerl'] );
			
			$sql = "SELECT *
					  FROM ".$tablaOfertas."
					 WHERE ".$campoOferta." = '".$cup."'
					   AND ".$campoEstado." = 'on'";
			
			$resConOferta = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
			$numConOferta = mysql_num_rows($resConOferta);
			
			if( $numConOferta > 0 ){
				$val = true;
			}
		}
	}
	
	return $val;
}
 
function tomarMuestrasDesdeGestion( $conex, $whce, $wmovhos, $tor, $nro, $item, $usuario ){
	
	$val = [	
			'fecha'=> '',
			'hora' => '',
			'user' => '',
			'error'=> true,	//Indica si hay un error(Por defecto 'hay error' = true )
		];
	
	$fecha 	= date( "Y-m-d" );
	$hora 	= date("H:i:s");
	
	$cup = consultarCupPorEstudio( $conex, $whce, $tor, $nro, $item );
	
	$hayInteroperabilidad 	= hayInteroperabilidadPorTipoDeOrden( $conex, $wmovhos, $tor );
	$cupOfertado 			= esCupOfertado( $conex, $wmovhos, $tor, $cup );
	
	$detval = $hayInteroperabilidad && $cupOfertado ? 'on' : 'off' ;
	
	//Consulto encabezado de kardex del dia
	$sql = "UPDATE ".$wmovhos."_000159 b
			   SET Detutm = '".$usuario."',
			       Detenv = '".$detval."',
				   Detlog = 'M',
				   Detftm = '".$fecha."', 
				   Dethtm = '".$hora."'
			 WHERE Dettor = '".$tor."'
			   AND Detnro = '".$nro."'
			   AND Detite = '".$item."'
			   AND Detutm = ''
			   ";

	$res = mysql_query($sql, $conex) or die ("Error: ".mysql_errno()." - en el query: $sql - " . mysql_error());
	
	//Consulto encabezado de kardex del dia
	$sql = "UPDATE ".$whce."_000028 b
			   SET Detutm = '".$usuario."',
			       Detenv = '".$detval."',
				   Detlog = 'M',
				   Detftm = '".$fecha."', 
				   Dethtm = '".$hora."'
			 WHERE Dettor = '".$tor."'
			   AND Detnro = '".$nro."'
			   AND Detite = '".$item."'
			   AND Detutm = ''
			   ";

	$res = mysql_query($sql, $conex) or die ("Error: ".mysql_errno()." - en el query: $sql - " . mysql_error());
	
	if( mysql_affected_rows() > 0 ){
		
		$val = [
				'fecha' => $fecha,
				'hora' 	=> $hora,
				'user' 	=> $usuario,
				'error' => false,
			];
		
		/************************************************************************************
		 * Mayo 20 de 2020
		 * Se agrega auditoria para toma de muestras desde gestión
		 ************************************************************************************/
		
		//Consulto la historia del paciente
		$sql = "SELECT Ordhis, Ording, Detcod, Descripcion
				  FROM ".$whce."_000027 a, ".$whce."_000028 b, ".$whce."_000047 c
				 WHERE Ordtor = '".$tor."'
				   AND Ordnro = '".$nro."' 
				   AND Dettor = ordtor
				   AND Detnro = ordnro
				   AND Detite = '".$item."'
				   AND Detcod = c.codigo
				   ";

		$res = mysql_query($sql, $conex) or die ("Error: ".mysql_errno()." - en el query: $sql - " . mysql_error());
		
		$rows = mysql_fetch_array( $res );
		
		
		//Registro de auditoria
		$auditoria = new AuditoriaDTO();

		$auditoria->historia 	= $rows['Ordhis'];
		$auditoria->ingreso 	= $rows['Ording'];
		$auditoria->descripcion = $tor."-".$nro."-".$item.",".$rows['Detcod'].",".$rows['Descripcion'].",".$usuario;
		$auditoria->fechaKardex = $fecha;
		$auditoria->mensaje 	= obtenerMensaje( "TOMA_MUESTRAS_GESTION" );
		$auditoria->seguridad 	= $usuario;
		$auditoria->idOriginal 	= '';

		registrarAuditoriaKardex( $conex, $wmovhos, $auditoria );
		/************************************************************************************/
	}
	else{
		
		//Consulto la historia del paciente
		$sql = "SELECT Detutm, Detftm, Dethtm
				  FROM ".$whce."_000028
				 WHERE Dettor = '".$tor."'
				   AND Detnro = '".$nro."' 
				   AND Detite = '".$item."'
				   ";

		$res = mysql_query($sql, $conex) or die ("Error: ".mysql_errno()." - en el query: $sql - " . mysql_error());
		
		if( $rows = mysql_fetch_array( $res ) ){
			$val = [
				'fecha' => $rows['Detftm'],
				'hora' 	=> $rows['Dethtm'],
				'user' 	=> $rows['Detutm'],
				'error' => false,
			];
		}
	}
	
	return $val;
}
 
function consultarImpresoraGA( $conex, $wbasedato, $cco ){
	
	$val = '';
	
	//Consulto encabezado de kardex del dia
	$sql = "SELECT Ccoism
			  FROM ".$wbasedato."_000011 b
			 WHERE ccocod = '".$cco."'";

	$res = mysql_query($sql, $conex) or die ("Error: ".mysql_errno()." - en el query: $sql - " . mysql_error());
	
	if( $rows = mysql_fetch_array( $res ) ){
		$val = $rows[ 'Ccoism' ];
	}
	
	return $val;
}
 
function tieneCcoInteroperabilidadLaboratorio( $conex, $wbasedato, $cco ){
	
	$val = [];
	
	//Consulto encabezado de kardex del dia
	$sql = "SELECT Ccotio
			  FROM ".$wbasedato."_000011 b
			 WHERE ccocod = '".$cco."'";

	$res = mysql_query($sql, $conex) or die ("Error: ".mysql_errno()." - en el query: $sql - " . mysql_error());
	$num = mysql_num_rows( $res );
	
	if( $num > 0 ){
		$rows = mysql_fetch_array( $res );
		
		$val = explode( "-", $rows[ 'Ccotio' ] );
	}
	
	return $val;
}
 
function tieneKardex($conex, $wbasedato, $whis, $wing, $wfecha ){
	
	$val = false;
	
	//Consulto encabezado de kardex del dia
	$sql = "SELECT Karhis
			  FROM ".$wbasedato."_000053
			 WHERE Karest = 'on'
			   AND Fecha_data = '".$wfecha."' 
			   AND Karhis = '".$whis."'
			   AND Karing = '".$wing."'
			   AND Karord != 'on'";

	$res = mysql_query($sql, $conex) or die ("Error: ".mysql_errno()." - en el query: $sql - " . mysql_error());
	$num = mysql_num_rows( $res );
	
	if( $num > 0 ){
		$val = true;
	}
	
	return $val;
}
 
/************************************************************************
 * Indica si el cco puede realizar procedimientos o no
 ************************************************************************/
function ccoRealizaEstudios( $conex, $wbasedato, $cco ){
	
	$val = false;
	
	//Tiene interoperabilidad si tipo de orden se encuentra en la tabla de sedes (movhos_000264 para Sistema HIRUKO de IMEXH)
	//o en la tabla de tipos ofertados (movhos_000267 para laboratorio)
	$sql = "SELECT Ccoerl
			  FROM ".$wbasedato."_000011
			 WHERE ccocod = '".$cco."'
			   AND ccoest = 'on'
			   AND Ccoerl = 'on'
			";
			
	$res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$num = mysql_num_rows( $res );
	
	if( $num > 0 ){
		$val = true;
	}
	
	return $val;
}
 
function hayInteroperabilidadPorTipoDeOrden( $conex, $wbasedato, $tor ){
		
	$val = false;
	
	//Tiene interoperabilidad si tipo de orden se encuentra en la tabla de sedes (movhos_000264 para Sistema HIRUKO de IMEXH)
	//o en la tabla de tipos ofertados (movhos_000267 para laboratorio)
	$sql = "SELECT Valtor
			  FROM ".$wbasedato."_000267 a
			 WHERE Valtor = '".$tor."'
			   AND Valest = 'on'
			";
			
	$res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$num = mysql_num_rows( $res );
	
	if( $num > 0 ){
		$val = true;
	}
	
	return $val;
}
 
function consultarComentarioPorInteroperabilidad( $conex, $wbasedato, $tipoOrden, $nroOrden, $item ){
	
	$val = [];
	
	$sql = "SELECT Fecha_data, Hora_data, Logtxt
			  FROM ".$wbasedato."_000273
			 WHERE Logtor = '".$tipoOrden."'
			   AND Lognro = '".$nroOrden."'
			   AND Logite = '".$item."'
			   AND Logest = 'on'
			   AND Logcla = 'Comentario Asignado'
		  ORDER BY Fecha_data DESC, hora_data DESC
			  ";
	
	$res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	
	while( $rows = mysql_fetch_array($res) ){
		$val[] = [
				'fecha' 		=> $rows['Fecha_data'],
				'hora' 			=> $rows['Hora_data'],
				'comentario' 	=> $rows['Logtxt'],
			];
	}
	
	return $val;
	
}
 
 
 
function consultarDatosAdicionales( $conex, $wbasedato, $tipoOrden, $nroOrden, $item ){
	
	$val = [];
	
	$sql = "SELECT *
			  FROM ".$wbasedato."_000258
			 WHERE Saotor = '".$tipoOrden."'
			   AND Saonro = '".$nroOrden."'
			   AND Saoite = '".$item."'
			   AND Saoest = 'on'
			  ";
	
	$res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	
	while( $rows = mysql_fetch_array($res) ){
		$val[] = [
				'origen' 			=> [ 
										 'codigo' 		=> $rows['Saocor'],  
										 'descripcion' 	=> $rows['Saodor'],  
									   ],
				'sitioAnatomico' 	=> [ 
										 'codigo' 		=> $rows['Saocsa'],  
										 'descripcion' 	=> $rows['Saodsa'],  
									   ],
			];
	}
	
	return $val;
}
 
function actualizarEstudioLeido( $conex, $whce, $wbasedato, $wusuario, $tipoOrden, $nroOrden, $item ){
	
	// @$usuario = consultarUsuarioOrdenes($wusuario);
	
	$resp = false;
	
	//Se consulta si es médico el usuario
	$sql = "SELECT Meduma, Espcod, Espnom 
			 FROM ".$wbasedato."_000044,".$wbasedato."_000065,".$wbasedato."_000048
			WHERE Esmcod=Espcod
			  AND Medtdo=Esmtdo
			  AND Meddoc=Esmndo
			  AND Meduma = '".$wusuario."'   
		 ORDER BY Espnom;";
	
	$res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$num = mysql_num_rows( $res );	
	
	//Si el usuario es medico actualizo el pendiente sin leer
	if(true || $num > 0 ){
		
		$sql = "UPDATE ".$whce."_000028 a
				   SET Detplc = 'off',
					   Detflc = '".date("Y-m-d")."',
					   Dethlc = '".date("H:i:s")."',
					   Detulc = '".$wusuario."'
				 WHERE Dettor = '".$tipoOrden."'
				   AND Detnro = '".$nroOrden."'
				   AND Detite = '".$item."'
				   ";
				   
		$res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
		
		if( mysql_affected_rows() > 0 ){
			$resp = true;
		}
	}
	
	return $resp;
}

function actualizarOrdenLeida( $conex, $whce, $wbasedato, $historia, $ingreso, $wusuario, $tipoOrden, $nroOrden ){
	
	// @$usuario = consultarUsuarioOrdenes($wusuario);
	
	$resp = false;
	
	//Se consulta si es médico el usuario
	$sql = "SELECT Meduma, Espcod, Espnom 
			 FROM ".$wbasedato."_000044,".$wbasedato."_000065,".$wbasedato."_000048
			WHERE Esmcod=Espcod
			  AND Medtdo=Esmtdo
			  AND Meddoc=Esmndo
			  AND Meduma = '".$wusuario."'   
		 ORDER BY Espnom;";
	
	$res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$num = mysql_num_rows( $res );	
	
	//Si el usuario es medico actualizo el pendiente sin leer
	if($num > 0 ){
		
		$sql = "UPDATE ".$whce."_000027 a
				   SET Ordple = 'off',
					   Ordfle = '".date("Y-m-d")."',
					   Ordhle = '".date("H:i:s")."',
					   Ordule = '".$wusuario."'
				 WHERE Ordtor = '".$tipoOrden."'
				   AND Ordnro = '".$nroOrden."'
				   AND Ordhis = '".$historia."'
				   AND Ording = '".$ingreso."'
				   ";
				   
		$res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
		
		if( mysql_affected_rows() > 0 ){
			$resp = true;
		}
	}
	
	return $resp;
}

// function actualizarOrdenLeida( $conex, $whce, $wbasedato, $historia, $ingreso, $wusuario, $tipoOrden, $nroOrden ){
	
	// // @$usuario = consultarUsuarioOrdenes($wusuario);
	
	// $resp = false;
	
	// $sql = "SELECT Meduma, Espcod, Espnom 
			 // FROM ".$wbasedato."_000044,".$wbasedato."_000065,".$wbasedato."_000048
			// WHERE Esmcod=Espcod
			  // AND Medtdo=Esmtdo
			  // AND Meddoc=Esmndo
			  // AND Meduma = '".$wusuario."'   
		 // ORDER BY Espnom;";
	
	// $res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	
	// $espUsuario = [];
	// while( $rows = mysql_fetch_array($res) ){
		// $espUsuario[] = trim( $rows['Espcod'] );
	// }
	
	// //Consulto la tabla de validacion de los principios activos
	// //Se hace sobre el tipo 01 que es la de medicamentos
	// $sql = "SELECT *
			  // FROM ".$whce."_000027 a
			 // WHERE Ordtor = '".$tipoOrden."'
			   // AND Ordnro = '".$nroOrden."'
			   // AND Ordhis = '".$historia."'
			   // AND Ording = '".$ingreso."'
			   // AND Ordple = 'on'
			// ";
			
	// $res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	
	// if( $rows = mysql_fetch_array($res) ){
		
		// $val = $rows['Ordusu'] == $wusuario;
		// if( !$val ){
			
			// $sql = "SELECT Meduma, Espcod, Espnom 
					 // FROM ".$wbasedato."_000044,".$wbasedato."_000065,".$wbasedato."_000048
					// WHERE Esmcod=Espcod
					  // AND Medtdo=Esmtdo
					  // AND Meddoc=Esmndo
					  // AND Meduma = '".$rows['Ordusu']."'   
					  // AND Espcod IN('".implode( "','", $espUsuario)."')
				 // ORDER BY Espnom;";
			
			// $res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
			// $num = mysql_num_rows( $res );
			// if( $num > 0 ){
				// $val = true;
			// }
		// }
	
		// if($val){
			
			// $sql = "UPDATE ".$whce."_000027 a
					   // SET Ordple = 'off',
						   // Ordfle = '".date("Y-m-d")."',
						   // Ordhle = '".date("H:i:s")."',
						   // Ordule = '".$wusuario."'
					 // WHERE Ordtor = '".$tipoOrden."'
					   // AND Ordnro = '".$nroOrden."'
					   // AND Ordhis = '".$historia."'
					   // AND Ording = '".$ingreso."'
					   // ";
					   
			// $res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
			
			// if( mysql_affected_rows() > 0 ){
				// $resp = true;
			// }
		// }
	// }
	
	// return $resp;
// }
 
function consultarAlergiasPorPrincipioActivo( $conex, $wbasedato, $historia, $ingreso ){
	
	$val = array();
	$tabla = "";
	$campo = "";
	
	//Consulto la tabla de validacion de los principios activos
	//Se hace sobre el tipo 01 que es la de medicamentos
	$sql = "SELECT Mcltva
			  FROM ".$wbasedato."_000218 a
			 WHERE Mclcla = '01'
			   AND Mclest = 'on'
			";
			
	$res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	
	if( $rows = mysql_fetch_array( $res ) ){
		
		list( $tabla, $campo ) = explode( ",", $rows[ 'Mcltva' ] );
		
		//Consulto la tabla de validacion de los principios activos
		//Se hace sobre el tipo 01 que es la de medicamentos
		$sql = "SELECT Paccod, Maades, Pacdes, Daalim, Daafli 
				  FROM ".$wbasedato."_000220, ".$wbasedato."_000217, ".$tabla." a
				 WHERE Daahis = '".$historia."'
				   AND Daaing = '".$ingreso."'
				   AND Daacod = Maacod
				   AND Maatip = 'AG'
				   AND Maaest = 'on'
				   AND Maacod = ".$campo."
				   AND Maacla = '01'
				   AND Daaest = 'on';
				";
				
		$resPA = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
		
		while( $rows = mysql_fetch_array( $resPA ) ){
			//Principios activos de los cuales el paciente es alergico
			$val[] = array(
				'codigo'					=> $rows[ 'Paccod' ],
				'descripcionAlergia'		=> $rows[ 'Maades' ],
				'descripcionPrincipioActivo'=> $rows[ 'Pacdes' ],
				'limiteTiempo'				=> $rows[ 'Daalim' ] == 'on' ? true: false,
				'fechaLimite'				=> $rows[ 'Daafli' ],
				'fechaLimiteUnix'			=> strtotime( $rows[ 'Daafli' ]." 00:00:00" )+24*3600,	//Sumo un día para que se tenga en cuenta el día en curso
			);
		}
	}
	
	return $val;
}
 
function consultarAuditoria( $historia, $ingreso, $mostrarRol = false, $wfecha = '', $mostrarAuditoria = true ){
	
	// global $wbasedato;
	// echo $wbasedato;
	
	if( empty($wfecha) ){
		$wfecha = date( "Y-m-d" );
	}
	
	$data = array(
		'html' 	=> '',
		'error' => 0,
		'msg' 	=> '',
	);
	
	$indicePestana = "7";	
	$data['html'] .= "<input type=hidden id='pestana' value='$indicePestana'>";
	
	if( $mostrarAuditoria ){
		
		$data['html'] .= "<input type='hidden' name='wauditoria' value='1'>";

		$data['html'] .= "<table align='center' border=0>";

		$data['html'] .= "<tr align='center' class='encabezadoTabla'>";
		$data['html'] .= "<td>Usuario</td>";
		$data['html'] .= "<td>Fecha y hora</td>";
		$data['html'] .= "<td>Mensaje</td>";
		$data['html'] .= "<td>Referencia</td>";
		$data['html'] .= "</tr>";

		$historialCambios = consultarHistorialCambiosKardex( $historia, $ingreso, $wfecha );

		$cont1 = 0;
		foreach($historialCambios as $historia){
			if($cont1 % 2 == 0){
				$data['html'] .= "<tr class='fila1'>";
			} else {
				$data['html'] .= "<tr class='fila2'>";
			}

			$data['html'] .= "<td>".utf8_encode( $historia->usuario );
			if( $mostrarRol && $historia->codigoRolHce  != '' ){
				$data['html'] .= "<br>".utf8_encode( $historia->codigoRolHce." - ".$historia->descripcionRolHCE );
			}
			$data['html'] .= "</td>";
			$data['html'] .= "<td>".utf8_encode( $historia->fecha." - ".$historia->hora )."</td>";
			$data['html'] .= "<td>".utf8_encode( $historia->mensaje )."</td>";
			$data['html'] .= "<td>".utf8_encode( $historia->descripcion )."</td>";
				
			$data['html'] .= "</tr>";
				
			$cont1++;
		}
			
		$data['html'] .= "</table>";
	}
	// echo $data['html'];
	return $data;
}
 
function  pintarDetalleDosisPurgaDA($dosisSinPurga,$dosisConPurga,$unidadSinPurga,$unidadDosis,$esEditable)
{
	$tooltipDosisPurga = "";
	$detalleDosis = "";
	
	if($dosisSinPurga>0)
	{
		if($dosisSinPurga!=$dosisConPurga)
		{
			if($esEditable)
			{
				$tooltipDosisPurga= "<div style=\"font-family:verdana;font-size:10pt\">Dosis ordenada: ".$dosisSinPurga." ".$unidadSinPurga."<br>Dosis con purga: ".$dosisConPurga." ".$unidadDosis."</div>";
			
				$detalleDosis =  "<img src='../../images/medical/root/info.png' title='".$tooltipDosisPurga."' alt='' border='0' align='right' width='17px'>";
			}
			else
			{
				$detalleDosis = "<br>Dosis ordenada: ".$dosisSinPurga." ".$unidadSinPurga."<br>Dosis con purga: ".$dosisConPurga." ".$unidadDosis;
			}
		}
	}
	
	return $detalleDosis;
}


function consultarDiagnosticos( $conex, $dx, $porCodigo = true ){

	$val = '';

	if( $porCodigo ){
	
		//Diagnostico
		$sql = "SELECT
					Codigo, Descripcion
				FROM
					root_000011 a
				WHERE
					Codigo = '$dx'
				ORDER BY
					Descripcion
				";
	}
	else{
	
		//Diagnostico
		$sql = "SELECT
					Codigo, Descripcion
				FROM
					root_000011 a
				WHERE
					Codigo LIKE '%$dx%'
					OR Descripcion LIKE '%$dx%'
				ORDER BY
					Descripcion
				";
	}
			
	$res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$num = mysql_num_rows( $res );
			
	if( $num > 0 ){
		
		for( $i = 0; $rows = mysql_fetch_array( $res ); $i++ ){
		
			if( !$soloNoPos || ( $soloNoPos && strtolower( $rows[ 'NoPos' ] ) == 'on' ) ){
			
				$rows[ 'Descripcion' ] = trim( $rows[ 'Descripcion' ] );
			
				//Creo el resultado como un json
				//Primero creo un array con los valores necesarios
				$datArticulos[ 'value' ] = Array( "cod"=> $rows[ 'Codigo' ], "des"=> $rows[ 'Descripcion' ] );	//Este es el dato a procesar en javascript
				$datArticulos[ 'label' ] = "{$rows[ 'Codigo' ]}-{$rows[ 'Descripcion' ]}";	//Este es el que ve el usuario
				$dat = Array();
				$dat[] = $datArticulos;
				
				$val .= json_encode( $dat )."\n";
			}
		}
	}
	
	return $val;
}

function consultarArticuloControlAImprimir( $conex, $wbasedato, $cenmez, $wemp_pmla, $his, $ing, $fechaKardex ){
	
	$val = array();
	
				// -- AND ctrimp = 'off'
	$sql = "(SELECT Artcod, Artgen, Artcom, a.id, Ctrido
			   FROM {$wbasedato}_000222 h, {$wbasedato}_000133 a, {$wbasedato}_000026 b, {$wbasedato}_000043 c, {$wbasedato}_000018 d, {$wbasedato}_000011 e, root_000036 f, root_000037 g
			  WHERE Ecthis = '".$his."'
				AND Ecting = '".$ing."'
				AND Ctrfge = '".$fechaKardex."'
				AND Ecthis = Ctrhis
				AND Ecting = Ctring
				AND ctrest = 'on'
				AND artcod = ctrart
				AND percod = ctrper
				AND ubihis = ctrhis
				AND ubiing = ctring
				AND ccocod = ubisac
				AND orihis = ubihis
				AND oriing = ubiing
				AND oritid = pactid
				AND oriced = pacced
				AND oriori = '".$wemp_pmla."')
			UNION
			(SELECT Artcod, Artgen, Artcom, a.id, Ctrido
			   FROM {$wbasedato}_000222 h, {$wbasedato}_000133 a, {$cenmez}_000002 b, {$cenmez}_000001 i, {$wbasedato}_000043 c, {$wbasedato}_000018 d, {$wbasedato}_000011 e, root_000036 f, root_000037 g
			  WHERE Ecthis = '".$his."'
				AND Ecting = '".$ing."'
				AND Ctrfge = '".$fechaKardex."'
			    AND Ecthis = Ctrhis
				AND Ecting = Ctring
				AND ctrest = 'on'
				AND artcod = ctrart
				AND percod = ctrper
				AND ubihis = ctrhis
				AND ubiing = ctring
				AND ccocod = ubisac
				AND orihis = ubihis
				AND oriing = ubiing
				AND oritid = pactid
				AND oriced = pacced
				AND tipcod = arttip
				AND tipcdo != 'on'
				AND oriori = '".$wemp_pmla."' )
			";
				
	$res = mysql_query( $sql, $conex ) or die (mysql_errno()." - Error en la consulta: $sql- ".mysql_error());
	//$val['sql'] = $sql;
	while( $rows = mysql_fetch_array( $res ) ){
		$val[] = array(
			'codigo' 			=> $rows['Artcod'],
			'nombreComercial' 	=> trim( $rows['Artgen'] ),
			'nombreGenerico' 	=> trim( $rows['Artcom'] ),
			'id' 	 			=> $rows['id'],
			'identificador'		=> $rows['Ctrido'],
		);
	}
	
	return $val;
}
 
/************************************************************************************************************************
 * Busca los articulos ordenados que sean por LEV o IC que se encuentren para enviar y los cambia a NO Enviar
 * Esto se debe hacer solo para pacientes que no sean de urgencias.
 *
 * NOTA: Está función es llamada desde cargoscpx.php y perfilfarmacoterapeutico, ambos en movhos/procesos/
 ************************************************************************************************************************/
function cambiarEstadoDeDispensacionParaLEVIC( $conex, $wbasedato, $his, $ing ){
	
	global $centroCostosServicioFarmaceutico;
	
	$val= false;

	$sql = "UPDATE ".$wbasedato."_000054 a, ".$wbasedato."_000098 b, ".$wbasedato."_000171 c
			   SET a.kadess = 'on',
				   a.kadcan = '0',
				   a.kaddis = '0',
				   a.kadsal = '0',
				   a.kadcdi = '0'
			 WHERE a.kadhis = '".$his."'
			   AND a.kading = '".$ing."'
			   AND a.kadfec = '".date( "Y-m-d" )."'
			   AND c.levhis = a.kadhis
			   AND c.leving = a.kading
			   AND c.levins = a.kadart
			   AND c.levidi = a.kadido
			   AND a.kadart = b.carcod
			   AND a.kadlev = 'on'
			   AND a.kadess = 'off'
			   AND b.carcco = '".$centroCostosServicioFarmaceutico."'
			   AND b.cardis = 'off'
			   AND b.carest = 'on'
			   AND b.cartip = 'IC'
			   AND c.levinf = 'on'
			   ";
	
	$res = mysql_query($sql,$conex) or die (mysql_errno()." - Error en la consulta: $sql- ".mysql_error());
	
	if( $rows = mysql_affected_rows() > 0 ){
		$val = true;
	}
	
	$sql = "UPDATE ".$wbasedato."_000054 a, ".$wbasedato."_000098 b, ".$wbasedato."_000171 c
			   SET a.kadess = 'on',
				   a.kadcan = '0',
				   a.kaddis = '0',
				   a.kadsal = '0',
				   a.kadcdi = '0'
			 WHERE a.kadhis = '".$his."'
			   AND a.kading = '".$ing."'
			   AND a.kadfec = '".date( "Y-m-d" )."'
			   AND c.levhis = a.kadhis
			   AND c.leving = a.kading
			   AND c.levins = a.kadart
			   AND c.levidi = a.kadido
			   AND a.kadart = b.carcod
			   AND a.kadlev = 'on'
			   AND a.kadess = 'off'
			   AND b.carcco = '".$centroCostosServicioFarmaceutico."'
			   AND b.cardis = 'off'
			   AND b.carest = 'on'
			   AND b.cartip = 'LQ'
			   AND c.levinf = 'off'
			   ";

	$res = mysql_query($sql,$conex) or die (mysql_errno()." - Error en la consulta: $sql- ".mysql_error());
	
	if( $rows = mysql_affected_rows() > 0 ){
		$val = true;
	}
	
	return $val;
}
 
function consultarRegMedico($wbasedato, $usuMed)
{
	global $conex;
	$val="";

	$queryRegMedico = "SELECT Medtdo,Meddoc,Medreg,Medesp  
					 FROM ".$wbasedato."_000048 
					WHERE Meduma='".$usuMed."';";
	
	$res = mysql_query($queryRegMedico,$conex) or die (mysql_errno()." - ".mysql_error());
	
	if( $rows = mysql_fetch_array($res) ){
		$val = $rows[ 2 ];
	}
	
	return $val;
}

function consultarFirma($whce, $usuMed)
{
	global $conex;
	$val="";
	
	$queryFirma = "SELECT Usucla 
					 FROM ".$whce."_000020 
					WHERE Usucod='".$usuMed."' 
					  AND Usuest='on';";
	
	$res = mysql_query($queryFirma,$conex) or die (mysql_errno()." - ".mysql_error());
	
	if( $rows = mysql_fetch_array($res) ){
		$val = $rows[ 0 ];
	}
	
	return $val;
}

function consultarUbicacion($whce, $his, $ing, $queryUbicacion)
{
	global $conex;
	$val="";
	//reemplazar historia HIS e ingreso ING
	$queryUbicacion = str_replace("HIS",$his,$queryUbicacion);
	$queryUbicacion = str_replace("ING",$ing,$queryUbicacion);
	
	$res = mysql_query($queryUbicacion,$conex) or die (mysql_errno()." - ".mysql_error());
	
	if( $rows = mysql_fetch_array($res) ){
		$val = $rows[ 0 ];
	}
	
	return $val;
}

function guardarNotaMedicaCtcContributivo($his,$ing,$fechaCTC,$horaCTC,$ctcmed,$notaMedica)
{
	global $conex;
	global $wbasedato;
	global $wbasedatohce;
	
	global $wemp_pmla;
	
	$fecha_data = date( "Y-m-d" );
	$hora_data = date( "H:i:s" );
	$cco = "";
	
	$tablaHceNotas = consultarAliasPorAplicacion( $conex, $wemp_pmla, 'NotaMedicaCtcContributivo' );
	
	$qFormularioHCE = " SELECT Hora_data,Movdat 
							FROM ".$wbasedatohce."_".$tablaHceNotas." 
						   WHERE Fecha_data='".$fecha_data."' 
						     AND Hora_data='".$hora_data."' 
						     AND movpro='000243' 
							 AND movcon='6' 
							 AND movhis='".$his."' 
							 AND moving='".$ing."' 
							 AND movtip='Memo' 
							 AND movusu='".$ctcmed."';";
	
	$resFormularioHCE = mysql_query($qFormularioHCE,$conex) or die (mysql_errno()." - ".mysql_error());
		
	while(mysql_num_rows($resFormularioHCE) > 0)
	{
		if( $rowFormularioHCE = mysql_fetch_array($resFormularioHCE) )
		{
			if($rowFormularioHCE['Movdat'] != $notaMedica )
			{
				$hora_data = date( "H:i:s", strtotime("+1 second") ) ;
			}
		}
		
		$qFormularioHCE = " SELECT Hora_data,Movdat 
								FROM ".$wbasedatohce."_".$tablaHceNotas." 
							   WHERE Fecha_data='".$fecha_data."' 
								 AND Hora_data='".$hora_data."' 
								 AND movpro='000243' 
								 AND movcon='6' 
								 AND movhis='".$his."' 
								 AND moving='".$ing."' 
								 AND movtip='Memo' 
								 AND movusu='".$ctcmed."';";
		
		$resFormularioHCE = mysql_query($qFormularioHCE,$conex) or die (mysql_errno()." - ".mysql_error());
	}		
		
	$qDatosFormulario = " SELECT Detcon,Dettip,Detfor 
							FROM ".$wbasedatohce."_000002 
						   WHERE detpro='000243' 
						     AND Dettip !='Titulo';";
	
	$resDatosFormulario = mysql_query($qDatosFormulario,$conex) or die (mysql_errno()." - ".mysql_error());
	$numDatosFormulario = mysql_num_rows($resDatosFormulario);
	
	while( $rowDatosFormulario = mysql_fetch_array($resDatosFormulario) ){
		$datosFormulario[] = $rowDatosFormulario[ 0 ];
		
		$consecutivo = $rowDatosFormulario['Detcon'];
		$tipoDato 	 = $rowDatosFormulario['Dettip'];
		if($consecutivo== 2 )
		{
			$valorAGrabar = $fechaCTC;
		}
		
		switch ($consecutivo) {

			case 2:
				$valorAGrabar = $fechaCTC;
				break;

			case 3:
				$valorAGrabar = $horaCTC;
				break;
				
			case 4:
			
				$ubicacion = consultarUbicacion($wbasedatohce, $his, $ing, $rowDatosFormulario['Detfor']);
				$valorAGrabar = $ubicacion;
				$cco = explode("-",$ubicacion);
				break;
				
			case 6:
				$valorAGrabar = $notaMedica;
				break;

			default:
				$valorAGrabar = "";
				break;
		}
				
		if($valorAGrabar!="")
		{
			$queryInsertHce= "INSERT INTO ".$wbasedatohce."_".$tablaHceNotas." (	Medico	,		Fecha_data	,	  Hora_data	   , movpro ,		movcon		  ,		 movhis   ,		 moving   ,		 movtip	   ,		movdat	   ,	movusu    ,	Seguridad	) 
													VALUES ('".$wbasedatohce."' , '".$fecha_data."' , '".$hora_data."' ,'".$tablaHceNotas."',  '".$consecutivo."' ,'".$his."', '".$ing."', '".$tipoDato."','".$valorAGrabar."','".$ctcmed ."','C-".$wbasedatohce."');";

			$res = mysql_query( $queryInsertHce, $conex ) or die( mysql_errno()." - Error en el query $queryInsertHce - ".mysql_error() );	
		}
	}	
	
	//Firma
	$firma = consultarFirma($wbasedatohce,$ctcmed);
	$queryInsertHce= "INSERT INTO ".$wbasedatohce."_".$tablaHceNotas." (	Medico	,		Fecha_data	,	  Hora_data	   , movpro ,  movcon ,	 	movhis    ,	 moving	   , movtip ,	movdat		,	 movusu	   ,Seguridad	) 
											VALUES ('".$wbasedatohce."' , '".$fecha_data."' , '".$hora_data."' ,'".$tablaHceNotas."',  '1000' ,'".$his."', '".$ing."', 'Firma',  '".$firma."'	,'".$ctcmed ."','C-".$wbasedatohce."');";

	$res = mysql_query( $queryInsertHce, $conex ) or die( mysql_errno()." - Error en el query $queryInsertHce - ".mysql_error() );
	
	//Registrar firma
	$regMedico = consultarRegMedico($wbasedato,$ctcmed);
	$queryInsertHce= "INSERT INTO ".$wbasedatohce."_000036 (	Medico	,		Fecha_data	,	  Hora_data	   , Firpro, Firhis, Firing, Firusu, Firfir, Firrol,Fircco,Seguridad	) 
											VALUES ('".$wbasedatohce."' , '".$fecha_data."' , '".$hora_data."' ,'".$tablaHceNotas."',  '".$his."' , '".$ing."', '".$ctcmed ."',  'on'	,'".$regMedico ."','".$cco[0] ."','C-".$wbasedatohce."');";

	$res = mysql_query( $queryInsertHce, $conex ) or die( mysql_errno()." - Error en el query $queryInsertHce - ".mysql_error() );
	
}
 // ------
 
 
function guardarCTCProcedimientosContributivo($historia,$ingreso,$tipoOrden,$nroOrden,$item,$codMedico,$accion,$consecutivoMipres)
{
	global $conex;
	global $wbasedato;
	
	$idCTC = "";
    
	$qInsert = "INSERT INTO ".$wbasedato."_000135 (Medico,Fecha_data,Hora_data,Ctchis,Ctcing,Ctctor,Ctcnro,Ctcite,Ctcmed,Ctcest,Ctcacc,Ctcacr,Ctcacu,Ctcacf,Ctcach,Ctcmip,Seguridad) VALUES('".$wbasedato."','".date("Y-m-d")."','".date("H:i:s")."','".$historia."','".$ingreso."','".$tipoOrden."','".$nroOrden."','".$item."','".$codMedico."','on','".$accion."','off','".$codMedico."','".date("Y-m-d")."','".date("H:i:s")."','".$consecutivoMipres."','C-".$wbasedato."');";
	$resultadoInsertEncab = mysql_query($qInsert,$conex) or die("Error: " . mysql_errno() . " - en el query: ".$queryInsertEncab." - ".mysql_error());
						
	if(mysql_affected_rows()==1)
	{
		// echo $qInsert;
		$idCTC = mysql_insert_id();
	}
	
	return $idCTC;
}
function guardarCTCMedicamentosContributivo($historia,$ingreso,$codArticulo,$codMedico,$ido,$accion,$consecutivoMipres)
{
	global $conex;
	global $wbasedato;
	
	$cadenaIdos = "";
	
	$idOriginales = explode(",",$ido);
	
	for($i=0;$i<count($idOriginales);$i++)
	{
		$sqlIdoExiste = "SELECT *
						  FROM ".$wbasedato."_000134 
						 WHERE Ctchis='".$historia."' 
						   AND Ctcing='".$ingreso."' 
						   AND Ctcart='".$codArticulo."'
						   AND Ctcest='on'
						   AND FIND_IN_SET( ".$idOriginales[$i].",Ctcido ) > 0; ";		

		$resIdoExiste = mysql_query($sqlIdoExiste, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sqlIdoExiste . " - " . mysql_error());		   
		$numIdoExiste = mysql_num_rows( $resIdoExiste );
		
		$idoExisteEnCadena = strpos($cadenaIdos,$idOriginales[$i]);

		if( $numIdoExiste == 0 && $idoExisteEnCadena === false)
		{
			$cadenaIdos .= $idOriginales[$i].",";
		}
	}
	
    $qInsert = "INSERT INTO ".$wbasedato."_000134 (Medico,Fecha_data,Hora_data,Ctchis,Ctcing,Ctcart,Ctcfkx,Ctcido,Ctcmed,Ctcest,Ctcacc,Ctcacu,Ctcacf,Ctcach,Ctcmip,Seguridad) VALUES('".$wbasedato."','".date("Y-m-d")."','".date("H:i:s")."','".$historia."','".$ingreso."','".$codArticulo."','0000-00-00','".substr($cadenaIdos, 0, -1)."','".$codMedico."','on','".$accion."','".$codMedico."','".date("Y-m-d")."','".date("H:i:s")."','".$consecutivoMipres."','C-".$wbasedato."');";
	$resultadoInsertEncab = mysql_query($qInsert,$conex) or die("Error: " . mysql_errno() . " - en el query: ".$queryInsertEncab." - ".mysql_error());
						
	if(mysql_affected_rows()==1)
	{
		// echo $qInsert;
	}
}

function consultarTipoAtencionCTCcontributivo($historia, $ingreso )
{
	global $conex;
	global $wbasedato;
	
	$tipoAtencion = "";

	$sql = "SELECT Ccohos, Ccourg
			  FROM ".$wbasedato."_000018, ".$wbasedato."_000011
			 WHERE ubihis = '".$historia."'
			   AND ubiing = '".$ingreso."'
			   AND ccocod = ubisac;";
				 
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query ".$sql." - ".mysql_error() );
	
	if( $rows = mysql_fetch_array($res) ){
		
		if( $rows['Ccohos'] == 'on' ){
			$tipoAtencion = "HOSPITALARIO-INTERNACION";
		}
		elseif( $rows['Ccourg'] == 'on' ){
			$tipoAtencion = "URGENCIAS";
		}
		else{
			$tipoAtencion = "AMBULATORIO";
		}
	}
	
	return $tipoAtencion;
}

function guardarCTCcontributivo($wemp_pmla,$historia,$ingreso,$codMedico,$cadenaCTCcontributivo,$consecutivoMipres)
{
	global $conex;
	global $wbasedato;
	global $wbasedatohce;
	
	$elementosCTCcontributivo = explode("***",$cadenaCTCcontributivo);
		
	for( $i=0; $i < count($elementosCTCcontributivo)-1;$i++)
	{
		$elementoPendienteCTC = explode("|",$elementosCTCcontributivo[$i]);
		
		if($elementoPendienteCTC[0]=="medicamento")
		{
			// guardar registro del ctc y nota medica
			guardarCTCMedicamentosContributivo($historia,$ingreso,$elementoPendienteCTC[1],$codMedico,$elementoPendienteCTC[5],"E",$consecutivoMipres);
			$notaMedica = "JUSTIFICACIÓN TECNOLOGÍA NO POS: ".$elementoPendienteCTC[2].". Posología: ".$elementoPendienteCTC[6]." ".$elementoPendienteCTC[8]."."; 
			guardarNotaMedicaCtcContributivo($historia,$ingreso,date("Y-m-d"),date("H:i:s"),$codMedico,$notaMedica);
		}
		else if($elementoPendienteCTC[0]=="procedimiento")
		{
			// guardar registro del ctc y nota medica
			$idCTC = guardarCTCProcedimientosContributivo($historia,$ingreso,$elementoPendienteCTC[4],$elementoPendienteCTC[5],$elementoPendienteCTC[6],$codMedico,"E",$consecutivoMipres);
			$notaMedica = "NOTA MÉDICA CTC PROCEDIMIENTOS [".$idCTC."]: ".$elementoPendienteCTC[2]; 
			guardarNotaMedicaCtcContributivo($historia,$ingreso,date("Y-m-d"),date("H:i:s"),$codMedico,$notaMedica);
		}
		else if($elementoPendienteCTC[0]=="medicamentoCR")
		{
			// guardar registro del ctc y nota medica
			guardarCTCMedicamentosContributivo($historia,$ingreso,$elementoPendienteCTC[1],$codMedico,$elementoPendienteCTC[5],"EM",$consecutivoMipres);
			$notaMedica = "JUSTIFICACIÓN TECNOLOGÍA NO POS: ".$elementoPendienteCTC[2].". Posología: ".$elementoPendienteCTC[6]." ".$elementoPendienteCTC[8]."."; 
			guardarNotaMedicaCtcContributivo($historia,$ingreso,date("Y-m-d"),date("H:i:s"),$codMedico,$notaMedica);
		}
		else if($elementoPendienteCTC[0]=="procedimientoCR")
		{
			// guardar registro del ctc y nota medica
			$idCTC = guardarCTCProcedimientosContributivo($historia,$ingreso,$elementoPendienteCTC[4],$elementoPendienteCTC[5],$elementoPendienteCTC[6],$codMedico,"EM",$consecutivoMipres);
			$notaMedica = "NOTA MÉDICA CTC PROCEDIMIENTOS [".$idCTC."]: ".$elementoPendienteCTC[2]; 
			guardarNotaMedicaCtcContributivo($historia,$ingreso,date("Y-m-d"),date("H:i:s"),$codMedico,$notaMedica);
		}
	}
	
}
function abrirCTCcontributivo($wemp_pmla,$historia,$ingreso,$codMedico,$cadenaCTCcontributivo)
{
	global $conex;
	global $wbasedato;
	global $wbasedatohce;
	global $wfecha;
	
	$listaPendientesCTCcontributivo = "";
	$listaMedPendientesCTCcontributivo = "";
	$listaProcPendientesCTCcontributivo = "";
	$contMedPendientesCTCcontributivo = 0;
	$contProcPendientesCTCcontributivo = 0;
	
	
	$elementosCTCcontributivo = explode("***",$cadenaCTCcontributivo);
		
	$tipoAtencion = consultarTipoAtencionCTCcontributivo($historia, $ingreso );
					
	for( $i=0; $i < count($elementosCTCcontributivo)-1;$i++)
	{
		$elementoPendienteCTC = explode("|",$elementosCTCcontributivo[$i]);
		
		if($elementoPendienteCTC[0]=="medicamento")
		{
			$listaMedPendientesCTCcontributivo .= "- ".str_replace("_", " ", $elementoPendienteCTC[2])." <b>Dosis: </b>".$elementoPendienteCTC[6]." ".$elementoPendienteCTC[8]." ".$elementoPendienteCTC[7]."<br>";
			$contMedPendientesCTCcontributivo++;
			
		}
		else if($elementoPendienteCTC[0]=="procedimiento")
		{
			$listaProcPendientesCTCcontributivo .= "- ".str_replace("_", " ", $elementoPendienteCTC[2])."<br>";
			$contProcPendientesCTCcontributivo++;
			
		}
		else if($elementoPendienteCTC[0]=="medicamentoCR")
		{
			$listaMedPendientesCTCcontributivo .= "- ".str_replace("_", " ", $elementoPendienteCTC[2])." <b>Dosis: </b>".$elementoPendienteCTC[6]." ".$elementoPendienteCTC[8]." ".$elementoPendienteCTC[7]." - <b>POR CAMBIO DE RESPONSABLE</b><br>";
			$contMedPendientesCTCcontributivo++;
		}
		else if($elementoPendienteCTC[0]=="procedimientoCR")
		{
			$listaProcPendientesCTCcontributivo .= "- ".str_replace("_", " ", $elementoPendienteCTC[2])." - <b>POR CAMBIO DE RESPONSABLE</b><br>";
			$contProcPendientesCTCcontributivo++;
		}
	}
	
	$paciente = consultarInfoPacienteOrdenHCEPorHistoriaIngreso( $conex, $wbasedato, $historia, $ingreso);
	$diagnostico = consultarDxs( $conex, $wemp_pmla, $wbasedatohce, $historia, $ingreso );
	
	if(strlen($diagnostico)>100)
	{
		$diagnostico = substr(strtoupper($diagnostico),0,100)."...";
	}
	

	
	$estilosFieldset = "style='padding:5px;margin:5px;border: 2px solid #2A5DB0;height:60px;overflow:auto;'";
	$estilosLegend = "style='border: 2px solid #2A5DB0;border-top: 0px;font-family: Verdana;background-color: #2A5DB0;font-size:8pt;font-weight:bold;color:#FFFFFF;'";
	
	$estiloDato = "font-weight: bold;";
	$estiloDescripcion = "";
	
	$listaPendientesCTCcontributivo = " <div>
											<table id='tablaCTCcontributivo' width='100%'>
												<tr class='encabezadoTabla'>
													<td align='center' colspan='2'>MIPRES para pacientes contributivos</td>
												</tr>
												<tr class='fila1'>
													<td colspan='2' style='font-size:11px' align='center'>
														<span style='".$estiloDato."'>Documento: </span><span class='fondoAmarillo' style='".$estiloDescripcion."'>".strtoupper($paciente->tipoDocumentoIdentidad." ".$paciente->documentoIdentidad)."</span>
														<span style='".$estiloDato."'>Nombre: </span><span class='fondoAmarillo' style='".$estiloDescripcion."'>".strtoupper($paciente->nombre1." ".$paciente->nombre2." ".$paciente->apellido1." ".$paciente->apellido2)."</span>
														<span style='".$estiloDato."'>Diagn&oacute;stico: </span><span class='fondoAmarillo' style='".$estiloDescripcion."'>".$diagnostico."</span>
														<span style='".$estiloDato."'>&Aacute;mbito: </span><span class='fondoAmarillo' style='".$estiloDescripcion."'>".$tipoAtencion."</span>
													</td>
												</tr>
												<tr class='fila1'>
													<td colspan='2' id='fondoAmarilloCTCcontributivo' class='fondoAmarillo' style='font-size:11px;text-decoration: blink' >Debe llenar el MIPRES para los siguientes articulos: </td>
												</tr>
												<tr class='fila1'>
													<td  width='50%' style=''>
														<fieldset ".$estilosFieldset.">
															<legend ".$estilosLegend."><span style='border-radius: 12px;background-color:#FF6600';color:#000000;>&nbsp;".$contMedPendientesCTCcontributivo."&nbsp;</span> Medicamentos: </legend>
															<span style='font-size:11px;'>".$listaMedPendientesCTCcontributivo."</span>
														</fieldset>
													</td>
													<td width='50%'>
														<fieldset ".$estilosFieldset.">
															<legend ".$estilosLegend."><span style='border-radius: 12px;background-color:#FF6600';color:#000000;>&nbsp;".$contProcPendientesCTCcontributivo."&nbsp;</span> Procedimientos: </legend>
															<span style='font-size:11px'>".$listaProcPendientesCTCcontributivo."</span>
														</fieldset>
													</td>
												</tr>
											</table>
										</div>";
		
	$urlCTCministerio = consultarAliasPorAplicacion( $conex, $wemp_pmla, "urlCTCministerio" );
	
	
	echo "	<div id='divCTCcontributivo' style='width:100%;height:100%;' >
				".$listaPendientesCTCcontributivo."
				<span id='botonCerrarCTCcontributivo'>
					<iframe id='iframeCTCcontributivo'  scrolling='yes' src='".$urlCTCministerio."' style='width:1260px;height:100px;right:0px;left:0px;top:0px;padding:0px;background-color:white;overflow-y: auto;'></iframe>
					<br>
					<!--<input type='button' value='Cerrar ventana' onclick='cerrarDivIframeCTCcontributivo();'>-->
					<input type='button' value='Cerrar ventana' onclick='cerrarDivIframeCTCcontributivo(\"".$cadenaCTCcontributivo."\");'>
					<!--<input type='button' value='Cerrar ventana' onclick='cerrarDivIframeCTCcontributivo(\"".$wemp_pmla."\",\"".$historia."\",\"".$ingreso."\",\"".$codMedico."\",\"".$cadenaCTCcontributivo."\");'>-->
				</span>
			</div>";
}

function consultarSiContributivo($codigoResponsable)
{
	global $conex;
	global $wemp_pmla;
	
	$wbasedatoCliame = consultarAliasPorAplicacion( $conex, $wemp_pmla, "cliame" );
	$CTCcontributivo = consultarAliasPorAplicacion( $conex, $wemp_pmla, "CTCcontributivo" );
		
	$query = "SELECT Empeco
				FROM ".$wbasedatoCliame."_000024 
			   WHERE Empcod='".$codigoResponsable."' 
				 AND Empest='on';";
	
	$res = mysql_query ($query, $conex ) or die ( "Error: " . mysql_errno() . " - en el query: " . $query . " - " . mysql_error() );
	$num = mysql_num_rows( $res );
	
	$esContributivo = false;
	if($num>0)
	{
		$rows = mysql_fetch_array($res);
		
		if($rows['Empeco']=="on" && $CTCcontributivo=="on")
		{
			$esContributivo = true;
		}
	}

	return $esContributivo;			 
}

function consultarSiAdulto($fechaNacimiento)
{
	global $conex;
	global $wbasedatohce;
	
	$esAdulto = true;
	
	$query = " SELECT Raerfi
				 FROM ".$wbasedatohce."_000041
				WHERE Raecod='P'
				  AND Raeest='on';";
	
	$res = mysql_query($query, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $query . " - " . mysql_error());
	
	$row = mysql_fetch_array($res);
	$limiteEdadPedietrico = $row['Raerfi'];
	
	//Edad
	$ann=(integer)substr($fechaNacimiento,0,4)*360 +(integer)substr($fechaNacimiento,5,2)*30 + (integer)substr($fechaNacimiento,8,2);
	$aa=(integer)date("Y")*360 +(integer)date("m")*30 + (integer)date("d");
	$wedad=($aa - $ann);
	
	if ($wedad <= $limiteEdadPedietrico)
	{
		$esAdulto = false;
	} 
	else 
	{
		$esAdulto = true;
	}
	
	return $esAdulto;
}

// /************************************************************************************************************
 // * 
 // * $wasunto				Asunto del correo
 // * $mensaje				Mensaje del correo
 // * $altbody
 // * $wremitente			Email de quién envía el correo. Debe ser de la forma [email]--[clave]
 // * $wdestinatarios		Array de correos de quienes reciben el correo
 // ************************************************************************************************************/
// function enviarEmail($wasunto,$mensaje,$altbody, $wremitente, $wpassword, $wdestinatarios ){
	
	// include_once("root/PHPMailer/class.phpmailer.php");
	// global $conex, $wemp_pmla;

	// $data = array('error'=>0,'mensError'=>"");
	
	// $fecha         = date("Y-m-d");
    // $hora          = date("H:i:s");

	// $wnombre_destino	= "";
	// $wnombrepdf         = "";
	// // $wpassword   = $wremitente[1];
	// // $wremitente = $wremitente[0];

	// $mail = new PHPMailer();
	// $mail->IsSMTP();
	// $mail->SMTPAuth = true;
	// $mail->SMTPSecure = "ssl";
	// $mail->Host = "smtp.gmail.com";
	// $mail->Port = 465;
	// $mail->Username = $wremitente;
	// $mail->Password = $wpassword;
	// $mail->From = $wremitente;
	// $mail->FromName = "Clinica las Americas";
	// $mail->Subject = $wasunto; 	//O un asunto fijo => Historia Clinica del paciente xxx
	// //$msghtml = "Cordial saludo,<br> \n\n El cron que actualiza los cargos de laboratorio presento una falla. El parametro pasarCargosLaboratorio se ha puesto en off, para que no genere más errores.Es necesario revisar este proceso y monitorearlo";
	// $msghtml = $mensaje;
	// $mail->AltBody = $altbody;
	// $mail->MsgHTML( $msghtml );
	// //$mail->AddAttachment("");

	// for($i=0; $i<count($wdestinatarios); $i++)
	// {
		// //echo "<br>".$wcorreo_reportar[$i];
		// $wemail_destino 	= $wdestinatarios[$i];
		// $mail->AddAddress($wemail_destino, $wnombre_destino);
	// }
	// $mail->IsHTML(true);
	// if(!$mail->Send()) {
		// $data[ 'Error' ] =  "0";
		// $data[ 'mensError' ] =  "No se envió el correo";
	// }
	// else {
		// $accion 	    = "envio email";
		// $tabla		    = "";
		// $descripcion    = "Se envio un correo Electronico a: {$wemail_destino}";
		
		// $data[ 'Error' ] =  "1";
		// $data[ 'mensError' ] =  "Correo enviado";
	// }
	
	// return $data;
// }

/******************************************************************************************
 * Actualiza la version del navegdor en la tabla root_000051
 ******************************************************************************************/
function actulizarVesionNavegador( $conex, $wemp_pmla, $version ){
	
	$data = array('error'=>0,'mensError'=>"");
	
	//Actualizando la version del navegador mozilla en BD
	$sql = "UPDATE root_000051
			   SET Detval = '".$version."' 
			 WHERE Detapl = 'versionMozilla'
			   AND Detemp = '".$wemp_pmla."'
			   AND Detval*1 < ".$version."*1
			 ";
			 
	$res = mysql_query( $sql, $conex ) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
	
	if( mysql_affected_rows() > 0 ){
		$data['error'] = "1";
		$data['mensError'] = "Version actualizada a $version";
	}
	else{
		$data['error'] = "1";
		$data['mensError'] = "No se pudo actualizar el parametro versionMozilla a $version en root_000051";
	}
	
	return $data;
}
 
/************************************************************************************************
 * Verifica que todos los CTC de los medicamentos tengan un registro
 ************************************************************************************************/
function verificarCTCs( $conex, $wbasedato, $his, $ing, $datos, $usuario, $navegador, $wemp_pmla ){
	
	$val = true;
	
	//Parametro que indica si debe enviar correo por que no se realizó un CTC para un articulo
	$realizarVerificacion = consultarAliasPorAplicacion( $conex, $wemp_pmla, "validarBrowserPorCTC" );
	$realizarVerificacion = trim( strtolower( $realizarVerificacion ) ) == 'on' ? true: false;
	
	if( $realizarVerificacion ){
	
		$data = array('error'=>0,'mensError'=>"");
		
		$arDatos = explode( ",", $datos );
		
		foreach( $arDatos as $key => $value ){
			list( $art, $ido, $nombre ) = explode( "-", $value );
			$val = artTieneCTC( $conex, $wbasedato, $his, $ing, $art, $ido );
			
			if( !$val ){
				break;
			}
		}
		
		$data['error'] = $val ? "1" : "0";
		
		if( !$val ){
			$data['mensError']  =   "**********************************************************************************";
			$data['mensError'] .= "\n***************          			ALERTA               			***************";
			$data['mensError'] .= "\n**********************************************************************************";
			$data['mensError'] .= "\nHAY ARTICULOS SIN CTC.";
			$data['mensError'] .= "\n - Por favor actualice la version del navegador.";
			$data['mensError'] .= "\n - Cierre ordenes y vuelva a entrar para realizar el CTC de los\narticulos No POS.";
			$data['mensError'] .= "\n**********************************************************************************";
			
			$data['mensError'] = utf8_encode( $data['mensError'] );
			
			/************************************************************************************************************************
			 * Octubre 04 de 2016
			 ************************************************************************************************************************/
			$wasunto 			= "Actualizar navegador ".$_SERVER[ 'REMOTE_ADDR' ];
			$mensaje 			= "Por favor actualizar el navegador mozilla de la terminal con la siguiente IP: ".$_SERVER[ 'REMOTE_ADDR' ];
			$altbody 			= "";
			$email        		= consultarAliasPorAplicacion( $conex, $wemp_pmla, "emailpmla");
			$email        		= explode("--", $email );
			$wremitente			= array( 'email'	=> $email[0],
										 'password' => $email[1],
										 'from' 	=> $email[0],
										 'fromName' => 'Clinica las americas',
								 );
			// $wdestinatario[]	= $email[0];
			$wdestinatario[]	= consultarAliasPorAplicacion( $conex, $wemp_pmla, "emailSoporte");
			$rp = sendToEmail($wasunto,$mensaje,$altbody,$wremitente,$wdestinatario);
			/************************************************************************************************************************/
			
			registrarAuditoriaCierreKardex( $his, $ing, $usuario, "No se hizo CTC por navegador*".$_SERVER[ 'REMOTE_ADDR' ]."*".json_encode( $navegador ) );
		}
	}
	else{
		$data = array('error'=>1,'mensError'=>"");
	}
	
	// var_dump($data);
	return $data;
}
 
/********************************************************************************************************************************
 * Esta función toma un arreglo de detalle de articulos y elimina del arreglo original los articulo que son lev y los pasa
 * a otro arreglo con los artiulos lev
 ********************************************************************************************************************************/
function consultarArticulosPestana( &$colDetalleLTR, &$colDetArt, $arTipos ){
	
	global $wbasedato;
	global $wcenmez;
	global $conex;
	
	$val = Array();
	// var_dump( $arTipos );
	foreach( $colDetArt as $key => $value ){
		if( in_array( esArticuloGenericoCpx( $conex, $wbasedato, $wcenmez, $value->consultarCodigoArticulo() ),$arTipos) ){
			$colDetalleLTR[] = $value;
		}
		else{
			$val[] = $value;
		}
	}
	
	$colDetArt = $val;
}
 
// NUTRICIONES PARENTERALES - NPT
function pintarFormulasModalNutricionesParenteralesNPT($volumenTotal,$observaciones,$accion,$contadorTabIndex)
{
	global $wbasedato;
	global $conex;
	
	$campoSoloLectura="";
	
	if($volumenTotal!="0.00" && $accion != "modificar")
	{
		$campoSoloLectura="readOnly='readOnly'";
	}

	$qFormulasNPT  = " SELECT Fortip,Forsti,Forcod,Fordes,Forfor,Formj1,Fortt1,Fortt2
						 FROM ".$wbasedato."_000213
						WHERE Forest='on'
					 ORDER BY Fortip,Forcod;";
	
	$resFormulasNPT = mysql_query($qFormulasNPT, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qNutriciones . " - " . mysql_error());
	
	$arrayFormulas=array();
	while($rowsFormulasNPT = mysql_fetch_array($resFormulasNPT))
	{
		$arrayFormulas[$rowsFormulasNPT['Fortip']][$rowsFormulasNPT['Forcod']]['subtipo'] = $rowsFormulasNPT['Forsti'];
		$arrayFormulas[$rowsFormulasNPT['Fortip']][$rowsFormulasNPT['Forcod']]['descripcion'] = $rowsFormulasNPT['Fordes'];
		$arrayFormulas[$rowsFormulasNPT['Fortip']][$rowsFormulasNPT['Forcod']]['formula'] = strtoupper (str_replace(",",".",$rowsFormulasNPT['Forfor']));
		$arrayFormulas[$rowsFormulasNPT['Fortip']][$rowsFormulasNPT['Forcod']]['mensaje1'] = str_replace(",",".",$rowsFormulasNPT['Formj1']);
		$arrayFormulas[$rowsFormulasNPT['Fortip']][$rowsFormulasNPT['Forcod']]['tooltip1'] = $rowsFormulasNPT['Fortt1'];
		$arrayFormulas[$rowsFormulasNPT['Fortip']][$rowsFormulasNPT['Forcod']]['tooltip2'] = $rowsFormulasNPT['Fortt2'];
	}
	
	
	// SUBTOTAL
	foreach($arrayFormulas as $tipoFormula => $codFormula)
	{
		if ($fila_lista=='Fila2')
			$fila_lista = "Fila1";
		else
			$fila_lista = "Fila2";
		
		if($tipoFormula=="SUBTOTAL")
		{
			echo "<tr>
					<td colspan=4 class='encabezadoTabla' align='right'>Subtotal (ml)</td>";
					foreach($codFormula as $keyFormula => $valueFormula)
					{
						if($valueFormula['subtipo']=="VOLUMEN")
						{
							echo "<td class='".$fila_lista."' align='center'><span id='NPT_STV'>0.00</span><input type='hidden' id='NPT_Formula_STV' value='".$valueFormula['formula']."'></td>";
						}
						elseif($valueFormula['subtipo']=="CORRECCION_PURGA")
						{
							echo "<td class='".$fila_lista."' align='center'><span id='NPT_STCP'>0.00</span><input type='hidden' id='NPT_Formula_STCP' value='".$valueFormula['formula']."'></td>";
						}
					}
			echo "</tr>";
			break;
		}
	}
		
	// AGUA_ESTERIL
	foreach($arrayFormulas as $tipoFormula => $codFormula)
	{
		if ($fila_lista=='Fila2')
			$fila_lista = "Fila1";
		else
			$fila_lista = "Fila2";
		
		if($tipoFormula=="AGUA_ESTERIL")
		{
			echo "<tr>
					<td colspan=4 class='encabezadoTabla' align='right'>Agua esteril (ml)</td>";
					foreach($codFormula as $keyFormula => $valueFormula)
					{
						if($valueFormula['subtipo']=="VOLUMEN")
						{
							echo "<td class='".$fila_lista."' align='center'><span id='NPT_AEV'>0.00</span><input type='hidden' id='NPT_Formula_AEV' value='".$valueFormula['formula']."'></td>";
						}
						elseif($valueFormula['subtipo']=="CORRECCION_PURGA")
						{
							echo "<td class='".$fila_lista."' align='center'><span id='NPT_AECP'>0.00</span><input type='hidden' id='NPT_Formula_AECP' value='".$valueFormula['formula']."'></td>";
						}
					}
			echo "</tr>";	
			break;
		}
	}
	
	// VOLUMEN TOTAL
	foreach($arrayFormulas as $tipoFormula => $codFormula)
	{
		if($tipoFormula=="VOLUMEN_TOTAL")
		{
			echo "<tr>
					<td colspan=2 style='background-color:#98B8F0' align='left'>VOLUMEN TOTAL</td>
					<td style='background-color:#98B8F0' align='center'>ml</td>
					<td style='background-color:#98B8F0' align='left'><input type='text' size='6'id='NPT_VT' value='".number_format($volumenTotal,2, '.', '')."' style='margin-left:25px' ".$campoSoloLectura." onkeypress='return validarEntradaDecimalSoloUnPuntoNPT(this,event);' onChange='recalcularVolumenyPurgaModalNPT();' tabIndex='".$contadorTabIndex."'></td>";
										
					foreach($codFormula as $keyFormula => $valueFormula)
					{
						if($valueFormula['subtipo']=="VOLUMEN")
						{
							echo "<td style='background-color:#98B8F0' align='center'><span id='NPT_VTV'>0.00</span><input type='hidden' id='NPT_Formula_VTV' value='".$valueFormula['formula']."'></td>";
						}
						elseif($valueFormula['subtipo']=="CORRECCION_PURGA")
						{
							echo "<td style='background-color:#98B8F0' align='center'><span id='NPT_VTCP'>0.00</span><input type='hidden' id='NPT_Formula_VTCP' value='".$valueFormula['formula']."'></td>";
						}
					}
			echo "</tr>";
			break;				
		}
	}
	
	if($contadorTabIndex!="")
	{
		$contadorTabIndex++;
	}
	
	// VELOCIDAD DE INFUSIÓN
	foreach($arrayFormulas as $tipoFormula => $codFormula)
	{
		if($tipoFormula=="VELOCIDAD_INFUSION")
		{
			foreach($codFormula as $keyFormula => $valueFormula)
			{
				echo "<tr>
						<td colspan=2 style='background-color:#98B8F0' align='left'>".$valueFormula['descripcion']."</td>
						<td style='background-color:#98B8F0' align='center'>ml/h</td>
						<td style='background-color:#98B8F0' align='left'><span id='NPT_VI' style='margin-left:30px'>0.00</span><input type='hidden' id='NPT_Formula_VI' value='".$valueFormula['formula']."'></td>
						<td colspan=2 style='background-color:#98B8F0' align='center'>OBSERVACIONES:</td>
					</tr>";
				break 2;
			}
		}
	}
	
	// REQUERIMIENTO LÍQUIDOS
	foreach($arrayFormulas as $tipoFormula => $codFormula)
	{
		if($tipoFormula=="REQUERIMIENTOS_LIQUIDOS")
		{
			$observacionesTextarea="";
			if($observaciones!="")
			{
				$observacionesTextarea = "readOnly='readonly'";
			}
			foreach($codFormula as $keyFormula => $valueFormula)
			{
				$imgInfo1 = "";	
				if($valueFormula['tooltip1']!="")
				{
					$tooltipNPT1= " - <div id=\"dvTooltipNPT1_".$keyFormula."\" style=\"font-family:verdana;font-size:10pt\">".$valueFormula['tooltip1']."</div>";
					
					$imgInfo1 = "<img src='../../images/medical/root/info.png' border='0' align='right' id='tooltipNPT1RQ_".$keyFormula."' title='".$tooltipNPT1."' />";

					$cadenaTooltipFormulas .= "tooltipNPT1RQ_".$keyFormula."|";
				}

				echo "<tr>
					<td colspan=2 style='background-color:#98B8F0' align='left'>".$valueFormula['descripcion']."</td>
					<td style='background-color:#98B8F0' align='center'>m1/kg</td>
					<td style='background-color:#98B8F0' align='left'><span id='NPT_RL' style='margin-left:30px'>0.00</span>".$imgInfo1."<input type='hidden' id='NPT_Formula_RL' value='".$valueFormula['formula']."'></td>
					<td colspan=2 rowspan=5 style='background-color:#98B8F0' align='center'><textarea id='NPT_Observaciones'cols='26' rows='8' ".$campoSoloLectura." tabIndex='".$contadorTabIndex."'>".utf8_decode($observaciones)."</textarea></td>
				</tr>";
				break 2;
			}
		}
	}
	if($contadorTabIndex!="")
	{
		$contadorTabIndex++;
	}
	
	// CLORO TOTAL
	foreach($arrayFormulas as $tipoFormula => $codFormula)
	{
		if($tipoFormula=="CLORO_TOTAL")
		{
			foreach($codFormula as $keyFormula => $valueFormula)
			{
				$imgInfo1 = "";	
				if($valueFormula['tooltip1']!="")
				{
					$tooltipNPT1= " - <div id=\"dvTooltipNPTCT_".$keyFormula."\" style=\"font-family:verdana;font-size:10pt\">".$valueFormula['tooltip1']."</div>";
					
					$imgInfo1 = "<img src='../../images/medical/root/info.png' border='0' align='right' id='tooltipNPTCT_".$keyFormula."' title='".$tooltipNPT1."' />";

					$cadenaTooltipFormulas .= "tooltipNPTCT_".$keyFormula."|";
				}

				echo "<tr>
						<td colspan=2 style='background-color:#B8D0FA' align='left'>".$valueFormula['descripcion']."</td>
						<td style='background-color:#B8D0FA' align='center'>mEq/Kg/D&iacute;a</td>
						<td style='background-color:#B8D0FA' align='left'><span id='NPT_CT' style='margin-left:30px'>0.00</span>".$imgInfo1."<input type='hidden' id='NPT_Formula_CT' value='".$valueFormula['formula']."'></td>
					</tr>";
					break 2;
			}
		}
	}
	
	// POTASIO TOTAL
	foreach($arrayFormulas as $tipoFormula => $codFormula)
	{
		if($tipoFormula=="POTASIO_TOTAL")
		{
			foreach($codFormula as $keyFormula => $valueFormula)
			{
				$imgInfo1 = "";	
				if($valueFormula['tooltip1']!="")
				{
					$tooltipNPT1= " - <div id=\"dvTooltipNPTPT_".$keyFormula."\" style=\"font-family:verdana;font-size:10pt\">".$valueFormula['tooltip1']."</div>";
					
					$imgInfo1 = "<img src='../../images/medical/root/info.png' border='0' align='right' id='tooltipNPTPT_".$keyFormula."' title='".$tooltipNPT1."' />";

					$cadenaTooltipFormulas .= "tooltipNPTPT_".$keyFormula."|";
				}

				echo "<tr>
						<td colspan=2 style='background-color:#B8D0FA' align='left'>".$valueFormula['descripcion']."</td>
						<td style='background-color:#B8D0FA' align='center'>mEq/Kg/D&iacute;a</td>
						<td style='background-color:#B8D0FA' align='left'><span id='NPT_PT' style='margin-left:30px'>0.00</span>".$imgInfo1."<input type='hidden' id='NPT_Formula_PT' value='".$valueFormula['formula']."'></td>
					</tr>";
					break 2;
			}
		}
	}
	
	// SODIO TOTAL
	foreach($arrayFormulas as $tipoFormula => $codFormula)
	{
		if($tipoFormula=="SODIO_TOTAL")
		{
			foreach($codFormula as $keyFormula => $valueFormula)
			{
				$imgInfo1 = "";	
				if($valueFormula['tooltip1']!="")
				{
					$tooltipNPT1= " - <div id=\"dvTooltipNPTST_".$keyFormula."\" style=\"font-family:verdana;font-size:10pt\">".$valueFormula['tooltip1']."</div>";
					
					$imgInfo1 = "<img src='../../images/medical/root/info.png' border='0' align='right' id='tooltipNPTST_".$keyFormula."' title='".$tooltipNPT1."' />";

					$cadenaTooltipFormulas .= "tooltipNPTST_".$keyFormula."|";
				}

				echo "<tr>
						<td colspan=2 style='background-color:#B8D0FA' align='left'>".$valueFormula['descripcion']."</td>
						<td style='background-color:#B8D0FA' align='center'>mEq/Kg/D&iacute;a</td>
						<td style='background-color:#B8D0FA' align='left'><span id='NPT_ST' style='margin-left:30px'>0.00</span>".$imgInfo1."<input type='hidden' id='NPT_Formula_ST' value='".$valueFormula['formula']."'></td>
					</tr>";
					break 2;
			}
		}
	}
	
	// APORTE GRASAS VITALIPID INFANT+ APORTE DE GRASAS ORDENADAS
	foreach($arrayFormulas as $tipoFormula => $codFormula)
	{
		if($tipoFormula=="APORTE_GRASAS")
		{
			foreach($codFormula as $keyFormula => $valueFormula)
			{
				$imgInfo1 = "";	
				if($valueFormula['tooltip1']!="")
				{
					$tooltipNPT1= " - <div id=\"dvTooltipNPTAG_".$keyFormula."\" style=\"font-family:verdana;font-size:10pt\">".$valueFormula['tooltip1']."</div>";
					
					$imgInfo1 = "<img src='../../images/medical/root/info.png' border='0' align='right' id='tooltipNPTAG_".$keyFormula."' title='".$tooltipNPT1."' />";

					$cadenaTooltipFormulas .= "tooltipNPTAG_".$keyFormula."|";
				}

				echo "<tr>
						<td colspan=2 style='background-color:#B8D0FA' align='left'>".$valueFormula['descripcion']."</td>
						<td style='background-color:#B8D0FA' align='center'>g/Kg/D&Iacute;a</td>
						<td style='background-color:#B8D0FA' align='left'><span id='NPT_AG' style='margin-left:30px'>0.00</span>".$imgInfo1."<input type='hidden' id='NPT_Formula_AG' value='".$valueFormula['formula']."'></td>
					</tr>";
					break 2;
			}
		}
	}
	
	if ($fila_lista=='Fila2')
			$fila_lista = "Fila1";
		else
			$fila_lista = "Fila2";
	

	// PARÁMETROS NUTRICIONALES Y FARMACÉUTICOS		
	echo "<tr>
			<td colspan=6 class='encabezadoTabla' align='center'>PAR&Aacute;METROS NUTRICIONALES Y FARMAC&Eacute;UTICOS</td>
		</tr>";
		
	
		
	foreach($arrayFormulas as $tipoFormula => $codFormula)
	{	
		if ($fila_lista=='Fila2')
			$fila_lista = "Fila1";
		else
			$fila_lista = "Fila2";
		
			if($tipoFormula=="PARAMETROS_NUTRICIONALES_Y_FARMACEUTICOS")
			{
				foreach($codFormula as $keyFormula => $valueFormula)
				{
					// $valueFormula['descripcion']
					if ($fila_lista=='Fila2')
						$fila_lista = "Fila1";
					else
						$fila_lista = "Fila2";
					$imgInfo1 = "";	
					if($valueFormula['tooltip1']!="")
					{
						$tooltipNPT1= " - <div id=\"dvTooltipNPT1_".$keyFormula."\" style=\"font-family:verdana;font-size:10pt\">".$valueFormula['tooltip1']."</div>";
						
						$imgInfo1 = "<img src='../../images/medical/root/info.png' border='0' align='right' id='tooltipNPT1_".$keyFormula."' title='".$tooltipNPT1."' />";

						$cadenaTooltipFormulas .= "tooltipNPT1_".$keyFormula."|";
					}
					else
					{
						$imgInfo1 = "<img src='../../images/medical/root/info.png' border='0' align='right' style='visibility:hidden;'/>";

					}
					
					$imgInfo2 = "";	
					if($valueFormula['tooltip2']!="")
					{
						$tooltipNPT2= " - <div id=\"dvTooltipNPT2_".$keyFormula."\" style=\"font-family:verdana;font-size:10pt\">".$valueFormula['tooltip2']."</div>";
						
						$imgInfo2 = "<img src='../../images/medical/root/info.png' border='0' align='right' id='tooltipNPT2_".$keyFormula."' title='".$tooltipNPT2."' />";	
						
						$cadenaTooltipFormulas .= "tooltipNPT2_".$keyFormula."|";
					}
					else
					{
						$imgInfo2 = "<img src='../../images/medical/root/info.png' border='0' align='right' style='visibility:hidden;'/>";

					}
					
					$mensajeValidacion1 = "";	
					if($valueFormula['mensaje1']!="")
					{
						$mensajeValidacion1 = "<input type='hidden' id='NPT_FMF1_".$keyFormula."' value='".strtoupper ($valueFormula['mensaje1'])."'>";
					}
					
					echo "<tr class='".$fila_lista."'>
							<td colspan=2 align='left' id='NPT_ParametroNutricional".$keyFormula."'>".$valueFormula['descripcion']."</td>
							<td colspan=2 align='center'><span id='NPT_RF".$keyFormula."' >0.00</span>".$imgInfo1."<input type='hidden' id='NPT_F".$keyFormula."' value='".$valueFormula['formula']."'></td>
							<td colspan=2 align='center'><b><span id='NPT_MF1_".$keyFormula."'></span></b>".$imgInfo2."".$mensajeValidacion1."</td>
						</tr>";
			}
		}
	}
		
	echo"<input type='hidden' id='tooltipFormulas' value='".$cadenaTooltipFormulas."'>";

	
	// VÍA DE ADMINISTRACIÓN
	foreach($arrayFormulas as $tipoFormula => $codFormula)
	{
		if($tipoFormula=="VIA_ADMINISTRACION")
		{
			echo "<tr>
					<td colspan=2 class='fondoAmarillo' align='left'>V&Iacute;A DE ADMINISTRACI&Oacute;N</td>";
					foreach($codFormula as $keyFormula => $valueFormula)
					{
						if($valueFormula['subtipo']=="CENTRAL_PERIFERICA_PEDIATRICOS")
						{
							echo "<td class='fondoAmarillo' align='center'><span id='NPT_MVAF1_".$keyFormula."'></span><input type='hidden' id='NPT_FMVAF1_".$keyFormula."' value='".strtoupper ($valueFormula['mensaje1'])."'></td>";
						}
						elseif($valueFormula['subtipo']=="CENTRAL_PERIFERICA_ADULTOS")
						{
							echo "<td class='fondoAmarillo' align='center'><span id='NPT_MVAF2_".$keyFormula."'></span><input type='hidden' id='NPT_FMVAF2_".$keyFormula."' value='".strtoupper ($valueFormula['mensaje1'])."'></td>";
						}
						elseif($valueFormula['subtipo']=="RIESGO")
						{
							echo "<td colspan=2 style='background-color:#CDCDCD' align='center'><span id='NPT_MVAF3_".$keyFormula."'></span><input type='hidden' id='NPT_FMVAF3_".$keyFormula."' value='".strtoupper ($valueFormula['mensaje1'])."' indicadorSeguridad='on'></td>";
						}
					}
			echo "</tr>";
			break;				
		}
	}
	
	return $contadorTabIndex;
}

function abrirModalNutricionesParenteralesNPT($wemp_pmla,$wcenmez,$historia,$ingreso,$articulo,$ido,$realizada,$codigoReal,$peso,$tiempoInfusion,$purga,$volumenTotal,$observaciones,$reemplazada)
{
	global $wbasedato;
	global $conex;
	
	//Nutrición realizada
	$mostrarRotulo = "";
	$codigoRealNPT = "";
	if($codigoReal != "" && $realizada == "on" && $reemplazada == "on")
	{
		// $mostrarRotulo = "<a href='../../cenpro/procesos/rotuloNPT.php?wemp_pmla=".$wemp_pmla."&historia=".$historia."&codigo=".$codigoReal."&horas=".$tiempoInfusion."&insti=".$wemp_pmla."' target='_blank'>Ver r&oacute;tulo de la NPT producida</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
		$codigoRealNPT = " - ".strtoupper($codigoReal);
	}
	
	
	$inputSoloLecturaNPT = "readOnly='readonly'";
	// Modal nutriciones
	echo "<div id='modalNutriciones' >";
	
	echo "	<br>
			<table width='100%'>
				<tr>
					<td align='right'>".$mostrarRotulo."</td>
				</tr>
				<tr>
					<td align='center'><input type='button' value='Cerrar' onclick='cerrarModalNPT();'></td>
				</tr>
			</table>
			";
	
	echo "<table id='tablaNutricionesNPT' width='90%' align='center' height='90%'>";
	echo "<tr>";
	echo "<td colspan=6 align=center class='encabezadoTabla'>";
	echo "<b>ORDEN NUTRICI&Oacute;N PARENTERAL".$codigoRealNPT."</b>";
	echo "</td>";
	echo "</tr>";
	
	echo "	<tr>
				<td colspan=6 class='fila1'>
					<fieldset style='padding:5px;margin:5px;border: 2px solid #2a5db0;' >
						<table align='center' width='70%'>
							<tr>
								<td>Peso(kg)</td>
								<td><input type='text' id='NPT_PESO' size='2' ".$inputSoloLecturaNPT ." value='".$peso."' onkeypress='return validarEntradaDecimalSoloUnPuntoNPT(this,event);' onChange='recalcularVolumenyPurgaModalNPT();'></td>
								<td>Tiempo de infusion(h)</td>
								<td><input type='text' id='NPT_TIEMPOINFUSION' size='2' ".$inputSoloLecturaNPT ." value='".$tiempoInfusion."' onkeypress='return validarEntradaDecimalSoloUnPuntoNPT(this,event);' onChange='recalcularVolumenyPurgaModalNPT();'></td>
								<td>Purga(ml)</td>
								<td><input type='text' id='NPT_PURGA' size='2' ".$inputSoloLecturaNPT ." value='".$purga."' onkeypress='return validarEntradaDecimalSoloUnPuntoNPT(this,event);' onChange='recalcularVolumenyPurgaModalNPT();'></td>
							</tr>
						</table>
					</fieldset>
				</td>
			</tr>";
	
	
	
	echo"<tr>
			<td class='encabezadoTabla' align='center' width='35%'>COMPOSICI&Oacute;N</td>
			<td class='encabezadoTabla' align='center'>CONCENTRACI&Oacute;N</td>
			<td class='encabezadoTabla' align='center'>REQUERIMIENTO</td>
			<td class='encabezadoTabla' align='center'>PRESCRIPCI&Oacute;N</td>
			<td class='encabezadoTabla' align='center'>VOL&Uacute;MEN (ML)</td>
			<td class='encabezadoTabla' align='center'>CORRECCI&Oacute;N PURGA (ML)</td>
		</tr>";
		
		$qPrescripciones = " SELECT Dnucod,Dnupre 
								 FROM ".$wbasedato."_000215 
								WHERE Dnuhis='".$historia."' 
								AND Dnuing='".$ingreso."' 
								AND Dnuart='".$articulo."' 
								AND Dnuido='".$ido."';";
		
		$resPrescripciones = mysql_query($qPrescripciones, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qPrescripciones . " - " . mysql_error());
		
		$arrayPrescripciones = array();
		while($rowsPrescripciones = mysql_fetch_array($resPrescripciones))
		{				
			$arrayPrescripciones[$rowsPrescripciones['Dnucod']] = $rowsPrescripciones['Dnupre'];
		}
		
		$qNutriciones  = " SELECT Inscod,Insdes,Inscon,Insreq,Insfov,Insfop,Insord,Condes,Requni
							 FROM ".$wbasedato."_000210,".$wcenmez."_000002,".$wbasedato."_000211,".$wbasedato."_000212
							WHERE Inscod=Artcod
							  AND Insest='on'
							  AND Artest='on'
							  AND Insreq=Reqcod
							  AND Inscon=Concod
						 ORDER BY Insoam;";
		
		$resNutriciones = mysql_query($qNutriciones, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qNutriciones . " - " . mysql_error());
		
		$infoNutriciones="";
		while($rowsNutriciones = mysql_fetch_array($resNutriciones))
		{	
			foreach($arrayPrescripciones as $codInsumo => $prescripcion)
			{
				if($codInsumo == $rowsNutriciones['Inscod'])
				{
					if ($fila_lista=='Fila2')
						$fila_lista = "Fila1";
					else
						$fila_lista = "Fila2";
					
					echo"<tr class='".$fila_lista."'>
							<td>".$rowsNutriciones['Insdes']."</td>
							<td align='center'>".$rowsNutriciones['Condes']."</td>
							<td align='center'>".$rowsNutriciones['Requni']."</td>
							<td align='center'><input type='text' size='2' ".$inputSoloLecturaNPT ." id='NPT_PRESCRIPCION".$rowsNutriciones['Insord']."' value='".$prescripcion."' onkeypress='return validarEntradaDecimalSoloUnPuntoNPT(this,event);' onChange='recalcularVolumenyPurgaModalNPT(this,\"".$rowsNutriciones['Inscod']."\");' ><input type='hidden' id='NPT_Insumo".$rowsNutriciones['Insord']."' value='".$rowsNutriciones['Inscod']."'></td>
							<td align='center'><span id='NPT_V".$rowsNutriciones['Insord']."'>0.00</span><input type='hidden' id='formulaVolumen".$rowsNutriciones['Insord']."' value='".strtoupper ($rowsNutriciones['Insfov'])."'></td>
							<td align='center'><span id='NPT_CP".$rowsNutriciones['Insord']."'>0.00</span><input type='hidden' id='formulaPurga".$rowsNutriciones['Insord']."' value='".strtoupper ($rowsNutriciones['Insfop'])."'></td>
							";
					echo"</tr>";
				}
			}
		}
		
		$contadorTabIndex = pintarFormulasModalNutricionesParenteralesNPT($volumenTotal,$observaciones,"","");
		
		
		
	echo "<tr>";
	echo "<td colspan=6>";
	echo "<div id='dvMsgConfiguracion' class='fondoamarillo' style='text-align:center;display:none;'></div>";
	echo "</td>";
	echo "</tr>";

	echo "	<br>
			<table width='100%'>
				<tr>
					<td align='center'><input type='button' value='Cerrar' onclick='cerrarModalNPT();'></td>
				</tr>
			</table>
			<br>";	
	
	echo "</table>";
	echo "</div>";
		
}
 
function consultarSiEsNutricionNPT($wbasedato,$historia,$ingreso,$codArticulo,$idOriginal)
{	
	global $conex;
	
	$qNutricion = "   SELECT Enuart,Enuido,Enurea,Enucnu,Enupes,Enutin,Enupur,Enuvol,Enuobs
						FROM ".$wbasedato."_000214
					   WHERE Enuhis='".$historia."' 
						 AND Enuing='".$ingreso."' 
						 AND Enuart='".$codArticulo."' 
						 AND Enuido='".$idOriginal."' 
						 AND Enuord='on';";
						 
	$resNutricion = mysql_query($qNutricion, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qNutriciones . " - " . mysql_error());	
	$numNutricion = mysql_num_rows($resNutricion);
	
	$arrayNutricion=array();
	$funcionOnclickAbrirNPT = "";
	if($numNutricion > 0)
	{
		$rowsNutricion = mysql_fetch_array($resNutricion);
		$funcionOnclickAbrirNPT = "onClick='abrirModalNPT(\"".$historia."\",\"".$ingreso."\",\"".$rowsNutricion['Enuart']."\",\"".$rowsNutricion['Enuido']."\",\"".$rowsNutricion['Enurea']."\",\"".$rowsNutricion['Enucnu']."\",\"".$rowsNutricion['Enupes']."\",\"".$rowsNutricion['Enutin']."\",\"".$rowsNutricion['Enupur']."\",\"".$rowsNutricion['Enuvol']."\",\"".$rowsNutricion['Enuobs']."\",\"off\");'";
	}
	else
	{
		$qNutricion = "   SELECT Enuart,Enuido,Enurea,Enucnu,Enupes,Enutin,Enupur,Enuvol,Enuobs
							FROM ".$wbasedato."_000214
						   WHERE Enuhis='".$historia."' 
							 AND Enuing='".$ingreso."' 
							 AND Enucnu='".$codArticulo."' 
							 AND Enuord='on';";
							 
		$resNutricion = mysql_query($qNutricion, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qNutriciones . " - " . mysql_error());	
		$numNutricion = mysql_num_rows($resNutricion);
		
		if($numNutricion > 0)
		{
			$rowsNutricion = mysql_fetch_array($resNutricion);
			$funcionOnclickAbrirNPT = "onClick='abrirModalNPT(\"".$historia."\",\"".$ingreso."\",\"".$rowsNutricion['Enuart']."\",\"".$rowsNutricion['Enuido']."\",\"".$rowsNutricion['Enurea']."\",\"".$rowsNutricion['Enucnu']."\",\"".$rowsNutricion['Enupes']."\",\"".$rowsNutricion['Enutin']."\",\"".$rowsNutricion['Enupur']."\",\"".$rowsNutricion['Enuvol']."\",\"".$rowsNutricion['Enuobs']."\",\"on\");'";
		}
	}
	
	return $funcionOnclickAbrirNPT;
}

function cargarUltimaNPTordenada($wemp_pmla,$wbasedato,$historia,$ingreso,$articulo,$ido)
{
	global $conex;
	
	$data = array('error'=>0,'mensError'=>"",'arrayPrescripciones'=>array());
		
	$qUltimaNutricion = " SELECT Dnucod,Dnupre,Insord
							FROM ".$wbasedato."_000215,".$wbasedato."_000210
						   WHERE Dnuhis='".$historia."' 
							 AND Dnuing='".$ingreso."' 
							 AND Dnuart='".$articulo."' 
							 AND Dnuido='".$ido."' 
							 AND Dnuest='on'
							 AND Dnucod=Inscod;";
	
	$resUltimaNutricion = mysql_query($qUltimaNutricion, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qUltimaNutricion . " - " . mysql_error());	
	$numUltimaNutricion = mysql_num_rows($resUltimaNutricion);
	
	$arrayPrescripciones=array();
	if($numUltimaNutricion > 0)
	{
		while($rowsUltimaNutricion = mysql_fetch_array($resUltimaNutricion))
		{
			$arrayPrescripciones[$rowsUltimaNutricion['Dnucod']]['Prescripcion'] = $rowsUltimaNutricion['Dnupre'];
			$arrayPrescripciones[$rowsUltimaNutricion['Dnucod']]['Orden'] = $rowsUltimaNutricion['Insord'];
		}
		
		$data['error'] = 0;
		$data['mensError'] = "";
		$data['arrayPrescripciones'] = $arrayPrescripciones;
	}
	else
	{
		$data['error'] = 1;
		$data['mensError'] = "Error al cargar los insumos de la NPT";
	}
	
	echo json_encode($data);
}

function grabarInsumosNutricionesParenteralesNPT($wemp_pmla,$wbasedato,$historia,$ingreso,$wuser,$arrayInsumosNPT,$idProtocolo,$ido,$codArticulo,$peso,$tiempoInfusion,$purga,$volumenTotal,$observaciones)
{
	$data = array('error'=>0,'mensError'=>"");
	
	$fecha = date("Y-m-d");
	$hora = date("H:i:s");
	
	global $conex;
	
	//Consultar que no exista la NPT
	$qNutricion = "   SELECT *
						FROM ".$wbasedato."_000214
					   WHERE Enuhis='".$historia."' 
						 AND Enuing='".$ingreso."' 
						 AND Enuart='".$codArticulo."' 
						 AND Enuido='".$ido."' 
						 AND Enuord='on';";
	
	$resNutricion = mysql_query($qNutricion, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qNutriciones . " - " . mysql_error());	
	$numNutricion = mysql_num_rows($resNutricion);
	
	if($numNutricion == 0)
	{
		//Insertar encabezado
		$queryInsertEncab="INSERT INTO ".$wbasedato."_000214 (Medico,Fecha_data,Hora_data,Enuhis,Enuing,Enuart,Enuido,Enupes,Enutin,Enupur,Enuvol,Enuobs,Enurea,Enuord,Enuest,Seguridad) VALUES ('".$wbasedato."','".$fecha."','".$hora."','".$historia."','".$ingreso."','".$codArticulo."','".$ido."','".$peso."','".$tiempoInfusion."','".$purga."','".$volumenTotal."','".utf8_decode($observaciones)."','off','on','on','C-".$wuser."');";
		
		$resultadoInsertEncab = mysql_query($queryInsertEncab,$conex) or die("Error: " . mysql_errno() . " - en el query: ".$queryInsertEncab." - ".mysql_error());
						
		if(mysql_affected_rows()==1)
		{
			foreach($arrayInsumosNPT as $keyNPT => $valueNPT)
			{
				
				$qDetalleNutricion = "SELECT *
										FROM ".$wbasedato."_000215
									   WHERE Dnuhis='".$historia."' 
										 AND Dnuing='".$ingreso."' 
										 AND Dnuart='".$codArticulo."' 
										 AND Dnuido='".$ido."' 
										 AND Dnucod='".$valueNPT['codInsumo']."' 
										 AND Dnuest='on';";
				
				$resDetalleNutricion = mysql_query($qDetalleNutricion, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qDetalleNutricion . " - " . mysql_error());	
				$numDetalleNutricion = mysql_num_rows($resDetalleNutricion);
				
				if($numDetalleNutricion == 0)
				{
					//Insertar encabezado
					$queryInsertDet="INSERT INTO ".$wbasedato."_000215 (Medico,Fecha_data,Hora_data,Dnuhis,Dnuing,Dnuart,Dnuido,Dnucod,Dnupre,Dnuest,Seguridad) VALUES ('".$wbasedato."','".$fecha."','".$hora."','".$historia."','".$ingreso."','".$codArticulo."','".$ido."','".$valueNPT['codInsumo']."','".$valueNPT['prescripcion']."','on','C-".$wuser."');";
					
					$resultadoInsertDet = mysql_query($queryInsertDet,$conex) or die("Error: " . mysql_errno() . " - en el query: ".$queryInsertDet." - ".mysql_error());
					
					if(mysql_affected_rows()==1)
					{
						$data['error'] = 0;
					}
					else
					{
						$data['error'] = 1;
						$data['mensError'] = "Error al insertar el detalle de la NPT: ".$codArticulo."ido: ".$ido." insumo: ".$valueNPT['codInsumo'];
					}
				}
				
			}
		}
		else
		{
			$data['error'] = 1;
			$data['mensError'] = "Error al insertar el encabezado de la NPT: ".$codArticulo."ido: ".$ido;
		}
	}
	
	echo json_encode($data);
}

function pintarModalNutricionesParenteralesNPT($wemp_pmla,$wcenmez,$idx,$tipoprotocolo,$historia,$ingreso,$accion,$arrayInsumos,$peso,$tiempoInfusion,$purga,$volumenTotal,$observaciones)
{
	global $wbasedato;
	global $conex;
	
	$pesoNPT = "";
	$tiempoInfusionNPT = "";
	$purgaNPT = "";
	$volumenTotalNPT = "0.00";
	$observacionesNPT = "";
	
	$contadorTabIndex = 0;
	
	if($accion == "modificar")
	{
		$pesoNPT = $peso;
		$tiempoInfusionNPT = $tiempoInfusion;
		$purgaNPT = $purga;
		$volumenTotalNPT = $volumenTotal;
		$observacionesNPT = $observaciones;
		
		for($j=0;$j<count($arrayInsumos);$j++)
		{
			$insumoNPT[$arrayInsumos[$j]['codInsumo']] = $arrayInsumos[$j]['prescripcion'];
		}
		
			
		$botonCerrar = "<input type='button' id='botonNPTCargar' value='Cerrar' onclick='cerrarModalNPT();'>";
	}
	else
	{
		$botonCerrar = "<input type='button' id='botonNPTSalirSinGrabar' value='Salir sin grabar' onclick='salirSinGrabarModalNPT(\"".$idx."\",\"".$tipoprotocolo."\");'>";
	}
		
	// Modal nutriciones
	echo "<div id='modalNutriciones' >";
	
	if($accion != "modificar")
	{
		$qUltimaNutricion = " SELECT Enuhis,Enuing,Enuart,Enuido,Enupes,Enutin,Enupur,Enuvol,Enuobs 
								FROM ".$wbasedato."_000214 
							   WHERE Enuhis='".$historia."' 
								 AND Enuing='".$ingreso."' 
								 AND Enuest='on' 
							ORDER BY Fecha_data DESC,Hora_data DESC 
							   LIMIT 1;";
		$resUltimaNutricion = mysql_query($qUltimaNutricion, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qUltimaNutricion . " - " . mysql_error());	
		$numUltimaNutricion = mysql_num_rows($resUltimaNutricion);
		
		if($numUltimaNutricion > 0)
		{
			$rowsUltimaNutricion = mysql_fetch_array($resUltimaNutricion);
			echo "	<br>
					<table id='tablaBotonesNPT' width='100%'>
						<tr>
							<td align='center'>
								<input type='button' id='botonNPTCargar' value='Cargar &uacute;ltima nutrici&oacute;n' onclick='cargarNutricionAnterior(\"".$historia."\",\"".$ingreso."\",\"".$rowsUltimaNutricion['Enuart']."\",\"".$rowsUltimaNutricion['Enuido']."\",\"".$rowsUltimaNutricion['Enupes']."\",\"".$rowsUltimaNutricion['Enutin']."\",\"".$rowsUltimaNutricion['Enupur']."\",\"".$rowsUltimaNutricion['Enuvol']."\",\"".$rowsUltimaNutricion['Enuobs']."\");'>
								".$botonCerrar."
							</td>
						</tr>
					</table>
					<br>";
		}
		else
		{
			echo "	<br>
					<table id='tablaBotonesNPT' width='100%'>
						<tr>
							<td align='center'>".$botonCerrar."</td>
						</tr>
					</table>
					<br>";
		}
	}
	else
	{
		echo "	<br>
				<table id='tablaBotonesNPT' width='100%'>
					<tr>
						<td align='center'><input type='button' id='botonNPTCerrar' value='Cerrar' onclick='cerrarModalNPT();'></td>
					</tr>
				</table>
				<br>";
	}
	
	
	echo "<table id='tablaNutricionesNPT' width='90%' align='center' height='90%'>";
	echo "<tr>";
	echo "<td colspan=6 align=center class='encabezadoTabla'>";
	echo "<b>ORDEN NUTRICI&Oacute;N PARENTERAL</b>";
	echo "</td>";
	echo "</tr>";
	
	echo "	<tr>
				<td colspan=6 class='fila1'>
					<fieldset style='padding:5px;margin:5px;border: 2px solid #2a5db0;' >
						<table align='center' width='70%'>
							<tr>
								<td>Peso(kg)</td>
								<td><input type='text' id='NPT_PESO' size='2' value='".$pesoNPT."' onkeypress='return validarEntradaDecimalSoloUnPuntoNPT(this,event);' onChange='recalcularVolumenyPurgaModalNPT();' tabIndex='".$contadorTabIndex."' autofocus></td>";
								$contadorTabIndex++;
	echo "						<td>Tiempo de infusion(h)</td>
								<td><input type='text' id='NPT_TIEMPOINFUSION' value='".$tiempoInfusionNPT."' size='2' onkeypress='return validarEntradaDecimalSoloUnPuntoNPT(this,event);' onChange='recalcularVolumenyPurgaModalNPT();' tabIndex='".$contadorTabIndex."'></td>";
								$contadorTabIndex++;
	echo "						<td>Purga(ml)</td>
								<td><input type='text' id='NPT_PURGA' size='2' value='".$purgaNPT."' onkeypress='return validarEntradaDecimalSoloUnPuntoNPT(this,event);' onChange='recalcularVolumenyPurgaModalNPT();' tabIndex='".$contadorTabIndex."'></td>";
								$contadorTabIndex++;
	echo "					</tr>
						</table>
					</fieldset>
				</td>
			</tr>";
	
	
	
	echo"<tr>
			<td class='encabezadoTabla' align='center' width='35%'>COMPOSICI&Oacute;N</td>
			<td class='encabezadoTabla' align='center'>CONCENTRACI&Oacute;N</td>
			<td class='encabezadoTabla' align='center'>REQUERIMIENTO</td>
			<td class='encabezadoTabla' align='center'>PRESCRIPCI&Oacute;N</td>
			<td class='encabezadoTabla' align='center'>VOL&Uacute;MEN (ML)</td>
			<td class='encabezadoTabla' align='center'>CORRECCI&Oacute;N PURGA (ML)</td>
		</tr>";
	
		$qNutriciones  = " SELECT Inscod,Insdes,Inscon,Insreq,Insfov,Insfop,Insord,Condes,Requni
							 FROM ".$wbasedato."_000210,".$wcenmez."_000002,".$wbasedato."_000211,".$wbasedato."_000212
							WHERE Inscod=Artcod
							  AND Insest='on'
							  AND Artest='on'
							  AND Insreq=Reqcod
							  AND Inscon=Concod
						 ORDER BY Insoam;";
		
		$resNutriciones = mysql_query($qNutriciones, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qNutriciones . " - " . mysql_error());
		
		$infoNutriciones="";
		$cont = 0;
		while($rowsNutriciones = mysql_fetch_array($resNutriciones))
		{				
			$arrayInsumosNutriciones[$cont]['Inscod']=$rowsNutriciones['Inscod'];
			$arrayInsumosNutriciones[$cont]['Insdes']=$rowsNutriciones['Insdes'];
			$arrayInsumosNutriciones[$cont]['Inscon']=$rowsNutriciones['Inscon'];
			$arrayInsumosNutriciones[$cont]['Insreq']=$rowsNutriciones['Insreq'];
			$arrayInsumosNutriciones[$cont]['Insfov']=$rowsNutriciones['Insfov'];
			$arrayInsumosNutriciones[$cont]['Insfop']=$rowsNutriciones['Insfop'];
			$arrayInsumosNutriciones[$cont]['Insord']=$rowsNutriciones['Insord'];
			$arrayInsumosNutriciones[$cont]['Condes']=$rowsNutriciones['Condes'];
			$arrayInsumosNutriciones[$cont]['Requni']=$rowsNutriciones['Requni'];
			
			$cont++;
		}
	
		for($i=0;$i<count($arrayInsumosNutriciones);$i++)
		{
			if ($fila_lista=='Fila2')
				$fila_lista = "Fila1";
			else
				$fila_lista = "Fila2";
			
			$prescripcionInsumoNPT = "0.00";
			if($insumoNPT[$arrayInsumosNutriciones[$i]['Inscod']])
			{
				$prescripcionInsumoNPT = $insumoNPT[$arrayInsumosNutriciones[$i]['Inscod']];
			}
			
				echo"<tr class='".$fila_lista."'>
						<td>".$arrayInsumosNutriciones[$i]['Insdes']."</td>
						<td align='center'>".$arrayInsumosNutriciones[$i]['Condes']."</td>
						<td align='center'>".$arrayInsumosNutriciones[$i]['Requni']."</td>
						<td align='center'><input type='text' size='2'id='NPT_PRESCRIPCION".$arrayInsumosNutriciones[$i]['Insord']."' value='".$prescripcionInsumoNPT."'  onkeypress='return validarEntradaDecimalSoloUnPuntoNPT(this,event);' onChange='recalcularVolumenyPurgaModalNPT(this,\"".$arrayInsumosNutriciones[$i]['Inscod']."\");' tabIndex='".$contadorTabIndex."' ><input type='hidden' id='NPT_Insumo".$arrayInsumosNutriciones[$i]['Insord']."' value='".$arrayInsumosNutriciones[$i]['Inscod']."'></td>
						<td align='center'><span id='NPT_V".$arrayInsumosNutriciones[$i]['Insord']."'>0.00</span><input type='hidden' id='formulaVolumen".$arrayInsumosNutriciones[$i]['Insord']."' value='".strtoupper ($arrayInsumosNutriciones[$i]['Insfov'])."'></td>
						<td align='center'><span id='NPT_CP".$arrayInsumosNutriciones[$i]['Insord']."'>0.00</span><input type='hidden' id='formulaPurga".$arrayInsumosNutriciones[$i]['Insord']."' value='".strtoupper ($arrayInsumosNutriciones[$i]['Insfop'])."'></td>
						";
				echo"</tr>";
			
			$contadorTabIndex++;			
		}
		
		$contadorTabIndex = pintarFormulasModalNutricionesParenteralesNPT($volumenTotalNPT,$observacionesNPT,$accion,$contadorTabIndex);
	
	
	echo "<tr>";
	echo "<td colspan=6>";
	echo "<div id='dvMsgConfiguracion' class='fondoamarillo' style='text-align:center;display:none;'></div>";
	echo "</td>";
	echo "</tr>";
	echo "<tr>";
	echo "<td colspan=2 align=right style='width:50%'>";
	echo "<input type='button' id='btnGrabarNPT' value='Grabar' onclick='validarEleccionInsumosNPT(\"".$idx."\",\"".$tipoprotocolo."\");' tabIndex='".$contadorTabIndex."'>"; 
	echo "</td>";
	echo "<td colspan=2 align=left>";
	echo $botonCerrar; 
	echo "</td>";
	echo "</tr>";
	echo "</table>";
	echo "</div>";
	echo "</div>";
}

 
// PROCEDIMIENTOS AGRUPADOS

function consultarSiImprimeProcAgrupado($tipoProcAgrupado,$contadorProcAgrupado,$codProcedimiento,$impOrdenAgrupada,$grabado)
{
	global $wbasedato;
	global $conex;
	
	$queryEstados = " SELECT * 
						FROM ".$wbasedato."_000186 
					   WHERE Toacag='".$tipoProcAgrupado."' 
						 AND Toacpr='".$codProcedimiento."' 
						 AND Toaest='on' 
						 AND Toaimp='on';";
	
	$resEstados = mysql_query($queryEstados, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $queryEstados . " - " . mysql_error());
	$numEstados = mysql_num_rows($resEstados);
	
	$checkboxImpresion = "<input type='checkbox' id='checkboxImpProcAgrupado".$tipoProcAgrupado.$contadorProcAgrupado.$codProcedimiento."' style='display:none;' tipProcAgrup='".$tipoProcAgrupado."' contadorProcAgrupado='".$contadorProcAgrupado."' codProcedimiento='".$codProcedimiento."' >";
	if($numEstados > 0){
		
		$rowEstados = mysql_fetch_array($resEstados);
		
		$checkImpresion = "";
		if($impOrdenAgrupada == "on")
		{
			$checkImpresion = "checked='checked'";
		}
		
		
		$funcionOnclick = "onClick='modificarArrayProcedimientosAgrupadosImprimirIndividual(\"".$tipoProcAgrupado."\",\"".$contadorProcAgrupado."\",\"".$codProcedimiento."\",event);'";
				
		$checkboxImpresion = "<input type='checkbox' id='checkboxImpProcAgrupado".$tipoProcAgrupado.$contadorProcAgrupado.$codProcedimiento."' ".$checkImpresion."  ".$funcionOnclick." tipProcAgrup='".$tipoProcAgrupado."' contadorProcAgrupado='".$contadorProcAgrupado."' codProcedimiento='".$codProcedimiento."'>";
			
		
	}
	
	return $checkboxImpresion;
}

function pintarConvencionProcAgrupados()
{
	global $wbasedato;
	global $conex;
	
	$queryEstados = " SELECT Eexcod,Eexdes,Eexpnd,Eexrea,Eexcan,Eexgen,Eexapa  
						FROM ".$wbasedato."_000045 
					   WHERE Eexord='on' 
						 AND Eexest='on'
					ORDER BY Eexgen;";
	
	$resEstados = mysql_query($queryEstados, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $queryEstados . " - " . mysql_error());
	$numEstados = mysql_num_rows($resEstados);
	
	$EstadosAgrupados = array();
	
	if($numEstados > 0){
		
		while ($rowEstados = mysql_fetch_array($resEstados)) 
		{
			if($rowEstados['Eexpnd']=='on')
			{
				$EstadosAgrupados['PENDIENTE'][] = $rowEstados['Eexcod'];
			}
			elseif($rowEstados['Eexrea']=='on')
			{
				$EstadosAgrupados['REALIZADO'][] = $rowEstados['Eexcod'];
			}
			elseif($rowEstados['Eexcan']=='on')
			{
				$EstadosAgrupados['CANCELADO'][] = $rowEstados['Eexcod'];
			}
			
		}
	}
	
	$convencionesProcAgrup = "";
	$convencionesProcAgrup .= "	<td align='left'>";
	foreach($EstadosAgrupados as $key => $est)
	{
		if($key=="REALIZADO")
		{
			$convencionesProcAgrup .=  "<img src='/matrix/images/medical/movhos/checkmrk.ico'  width='15px'><span style='font-size:7pt;vertical-align:top;'>&nbsp;Realizado&nbsp;&nbsp;</span>";
		}
		elseif($key=="PENDIENTE")
		{
			$convencionesProcAgrup .=  "<img src='/matrix/images/medical/root/borrarAmarillo.png'  width='15px'><span style='font-size:7pt;vertical-align:top;'>&nbsp;Pendiente&nbsp;&nbsp;</span>";
		}
		elseif($key=="CANCELADO")
		{
			$convencionesProcAgrup .=  "<img src='/matrix/images/medical/root/borrar.png'  width='15px'><span style='font-size:7pt;vertical-align:top;'>&nbsp;Cancelado&nbsp;&nbsp;</span>";
		}
	}
	$convencionesProcAgrup .= "</td>";	
	
	return $convencionesProcAgrup;
}

function consultarSaldoMedicamentoPorProcAgrupado($historia,$ingreso,$medicamento)
{
	global $wbasedato;
	global $conex;
	
	$querySaldMed = " SELECT SUM(Spauen),SUM(Spausa)
						FROM ".$wbasedato."_000004
					   WHERE Spahis='".$historia."' 
						 AND Spaing='".$ingreso."' 
						 AND Spaart='".$medicamento."';";
	
	$resSaldMed = mysql_query($querySaldMed, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $querySaldMed . " - " . mysql_error());
	$numSaldMed = mysql_num_rows($resSaldMed);
	
	$saldo = 0;
	if($numSaldMed == 0)
	{
		$saldo = 0;
	}
	else
	{
		$rowSaldMed = mysql_fetch_array($resSaldMed);
		$saldo = $rowSaldMed[0] - $rowSaldMed[1];
		
	}
	
	return $saldo;
}

function consultarAplicacionMedicamentoPorProcAgrupado($historia,$ingreso,$medicamento,$ido)
{
	global $wbasedato;
	global $conex;
	
	$queryApliMed = " SELECT COUNT(*)
						FROM ".$wbasedato."_000015
					   WHERE Aplhis='".$historia."' 
						 AND Apling='".$ingreso."' 
						 AND Aplart='".$medicamento."'
						 AND Aplido='".$ido."'
						 AND Aplest='on';";
	
	$resApliMed = mysql_query($queryApliMed, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $queryApliMed . " - " . mysql_error());
	$numApliMed = mysql_num_rows($resApliMed);
	
	$aplicado = "off";
	if($numApliMed > 0)
	{
		$rowApliMed = mysql_fetch_array($resApliMed);
		if($rowApliMed[0]>0)
		{
			$aplicado = "on";
		}
	}
	
	return $aplicado;
}
 
 function consultarMedicamentosRelacionadosProcAgrup($whis,$wing,$art,$ido)
 {
	 
	global $wbasedato;
	global $conex;
	
	$relacionado = false;
	$queryMedicamentos = "SELECT *
							FROM ".$wbasedato."_000195 
						   WHERE Relhis='".$whis."' 
							 AND Reling='".$wing."' 
							 AND Relmed='".$art."' 
							 AND Relido='".$ido."';";

	$resMedicamentos = mysql_query($queryMedicamentos, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $queryMedicamentos . " - " . mysql_error());
	$numMedicamentos = mysql_num_rows($resMedicamentos);
	
	$medicamentosProcedimiento = array();
	if($numMedicamentos>0)
	{
		$relacionado = true;
	}
	return $relacionado;
 }
 function consultarPresentacion($proc,$med,$via)
 {
	global $wbasedato;
	global $conex;
	
	$q = "SELECT Rpmpre 
			FROM ".$wbasedato."_000190 
		   WHERE Rpmpro='".$proc."' 
		     AND Rpmmed='".$med."' 
			 AND Rpmvia='".$via."' 
			 AND Rpmest='on';";		 
			 
	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res); 
	
	$presentacion="";
	if($num > 0){
		
		$row = mysql_fetch_array($res);
		$presentacion= $row['Rpmpre'];
	}

	return $presentacion; 
 }
 
 
 function consultarMedicamentosProcedimientosAgrupados($procedimiento)
 {
	global $wbasedato;
	global $conex;
			 
	// $q = "SELECT Rpmpro,Rpmmed,Artgen,Artcom,Rpmpre,Pcodes,Deffru,Unides,Rpmvia,Viades,Relcon,Relfam,Famnom
			// FROM ".$wbasedato."_000190,".$wbasedato."_000026,".$wbasedato."_000027,".$wbasedato."_000040,".$wbasedato."_000059 ,".$wbasedato."_000175,".$wbasedato."_000115,".$wbasedato."_000114
		   // WHERE Rpmpro='".$procedimiento."' 
			 // AND Rpmest='on' 
			 // AND Artcod=Rpmmed 
			 // AND Artest='on' 
			 // AND Artpco=Rpmpre
			 // AND Pcocod=Rpmpre
			 // AND Pcoest='on'
			 // AND Defart=Rpmmed
			 // AND Defest='on'
			 // AND Unicod=Artuni 
			 // AND Uniest='on'
			 // AND Viacod=Rpmvia
			 // AND FIND_IN_SET(Rpmvia,Defvia)>0
			 // AND Relart=Rpmmed
			 // AND Relest='on'
			 // AND Relfam=Famcod
			 // AND Famest='on';";		 
			 		 
					 
	$q = "SELECT Rpmpro,Rpmmed,Artgen,Artcom,Rpmpre,Pcodes,Deffru,Unides,Rpmvia,Viades,Relcon,Relfam,Famnom
			FROM ".$wbasedato."_000190,".$wbasedato."_000026,".$wbasedato."_000027,".$wbasedato."_000040,".$wbasedato."_000059 ,".$wbasedato."_000175,".$wbasedato."_000115,".$wbasedato."_000114
		   WHERE Rpmpro='".$procedimiento."' 
			 AND Rpmest='on' 
			 AND Artcod=Rpmmed 
			 AND Artest='on' 
			 AND Artpco=Rpmpre
			 AND Pcocod=Rpmpre
			 AND Pcoest='on'
			 AND Defart=Rpmmed
			 AND Defest='on'
			 AND Unicod=Deffru 
			 AND Uniest='on'
			 AND Viacod=Rpmvia
			 AND FIND_IN_SET(Rpmvia,Defvia)>0
			 AND Relart=Rpmmed
			 AND Relest='on'
			 AND Relfam=Famcod
			 AND Famest='on';";		 
			 
	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res); 
	
	$medicamentosProcAgrup = array();
	$contador = 0;

	if($num > 0){
		// echo "<pre>".print_r($q,true)."</pre>";
		while ($row = mysql_fetch_array($res)) 
		{
			$medicamentosProcAgrup[$contador]['Rpmpro'] = $row['Rpmpro'];
			$medicamentosProcAgrup[$contador]['Rpmmed'] = $row['Rpmmed'];
			$medicamentosProcAgrup[$contador]['Artgen'] = $row['Artgen'];
			$medicamentosProcAgrup[$contador]['Artcom'] = $row['Artcom'];
			$medicamentosProcAgrup[$contador]['Rpmpre'] = $row['Rpmpre'];
			$medicamentosProcAgrup[$contador]['Pcodes'] = $row['Pcodes'];
			$medicamentosProcAgrup[$contador]['Deffru'] = $row['Deffru'];
			$medicamentosProcAgrup[$contador]['Unides'] = $row['Unides'];
			$medicamentosProcAgrup[$contador]['Rpmvia'] = $row['Rpmvia'];
			$medicamentosProcAgrup[$contador]['Viades'] = $row['Viades'];
			// $medicamentosProcAgrup[$contador]['Relcon'] = $row['Relcon'];
			$medicamentosProcAgrup[$contador]['Relcon'] = "";
			$medicamentosProcAgrup[$contador]['Relfam'] = $row['Relfam'];
			$medicamentosProcAgrup[$contador]['Famnom'] = $row['Famnom'];
			
			
			$qPrincActiv = "  SELECT Parpac,Pacdes
								FROM ".$wbasedato."_000181, ".$wbasedato."_000176 
							   WHERE Parfam = '".$row['Relfam']."'
								 AND Parest='on'
								 AND Parpac=Paccod
								 AND Pacest='on';";		 
					 
			$resPrincActiv = mysql_query($qPrincActiv, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qPrincActiv . " - " . mysql_error());
			$numPrincActiv = mysql_num_rows($resPrincActiv); 
			
			while ($rowPrincActiv = mysql_fetch_array($resPrincActiv)) 
			{
				$medicamentosProcAgrup[$contador]['Parpac'] .= $rowPrincActiv['Parpac'].",";
				$medicamentosProcAgrup[$contador]['Pacdes'] .= $rowPrincActiv['Pacdes'].",";
			}
			
			//quitar ultima coma
			$medicamentosProcAgrup[$contador]['Parpac']=substr($medicamentosProcAgrup[$contador]['Parpac'], 0, -1);
			$medicamentosProcAgrup[$contador]['Pacdes']=substr($medicamentosProcAgrup[$contador]['Pacdes'], 0, -1);
			
			$contador++;
		}
	}

	return $medicamentosProcAgrup;
 }
 
function consultarEstadoGeneralProcAgrup(){
	global $wbasedato;
	global $conex;

	$coleccion = array();
	
	$q = "SELECT Eexcod,Eexdes,Eexcpe,Eexapa,Eexcan,Eexrea
		    FROM ".$wbasedato."_000045
		   WHERE Eexord = 'on'
		     AND Eexest = 'on'
			 AND (Eexgen != '' AND Eexgen != 'NO APLICA');";
			 
	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$cont1 = 0;
	while($cont1 < $num)
	{
		$info = mysql_fetch_array($res);

		$reg = new RegistroGenericoDTO();

		$reg->codigo = $info['Eexcod'];
		$reg->descripcion = $info['Eexdes'];
		$reg->codigo_permiso = $info['Eexcpe'];
		$reg->accion_med_proc_agrup = $info['Eexapa'];
		$reg->est_cancelada = $info['Eexcan'];
		$reg->est_realizado = $info['Eexrea'];

		$cont1++;

		$coleccion[] = $reg;
	}

	return $coleccion;
}
 
function consultarEstadosAgrupadosGenerales($estadoProce)
{
	global $conex;
	global $wbasedato;
	
	$queryEstados = " SELECT Eexcod,Eexpnd,Eexrea,Eexcan 
						FROM ".$wbasedato."_000045 
					   WHERE Eexord='on' 
						 AND Eexest='on'
					ORDER BY Eexgen;";
	
	$resEstados = mysql_query($queryEstados, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $queryEstados . " - " . mysql_error());
	$numEstados = mysql_num_rows($resEstados);
	
	$EstadosAgrupadosGenerales = array();
	
	if($numEstados > 0){
		
		while ($rowEstados = mysql_fetch_array($resEstados)) 
		{
			if($rowEstados[1]=='on')
			{
				$EstadosAgrupadosGenerales['PENDIENTE'][] = $rowEstados[0];
			}
			elseif($rowEstados[2]=='on')
			{
				$EstadosAgrupadosGenerales['REALIZADO'][] = $rowEstados[0];
			}
			elseif($rowEstados[3]=='on')
			{
				$EstadosAgrupadosGenerales['CANCELADO'][] = $rowEstados[0];
			}
		}
	}
	
	
	$cadenaProcedimientos = "";							
	$cadenaProcedimientos .= "	<td align='center' width='5%'> ";							
	foreach($EstadosAgrupadosGenerales as $key => $est)
	{
		foreach($est as $key2 => $value)
		{
			if($value==$estadoProce)
			{
				if($key=="REALIZADO")
				{
					$cadenaProcedimientos .=  "<img src='/matrix/images/medical/movhos/checkmrk.ico'  width='15px' alt='REALIZADO'>";
				}
				elseif($key=="PENDIENTE")
				{
					$cadenaProcedimientos .=  "<img src='/matrix/images/medical/root/borrarAmarillo.png'  width='15px' alt='PENDIENTE'>";
				}
				elseif($key=="CANCELADO")
				{
					$cadenaProcedimientos .=  "<img src='/matrix/images/medical/root/borrar.png'  width='15px' alt='CANCELADO'>";
				}
			}
		}
		
	}							
	$cadenaProcedimientos .= "	</td>";	
	
	return $cadenaProcedimientos;
}
 
function modificarTrProcedimientosAgrupados($whis,$wing,$agrupados,$tipoOrdenAgrup,$contadorActualAgrup)
{
	global $conex;
	global $wbasedato;
	global $wbasedatohce;
	
	$cadenaProcedimientos = "";
	$cadenaJustificacion = "";
	
	$cadenaProcedimientos .= "<table width='100%'>";
	$cadenaProcedimientos .= "<tr>";
	$cadenaProcedimientos .= "<td>Imp</td>";
	$cadenaProcedimientos .= "<td align='right' colspan='2'>Cant.</td>";
	$cadenaProcedimientos .= "<td align='right'>Estado</td>";
	$cadenaProcedimientos .= "</tr>";
	foreach ($agrupados as $valor)
	{
		$proc = consultarNombreProcedimiento($valor['codigo']);
					
		$cadenaProcedimientos .= "<tr>";
		$cadenaProcedimientos .= "	<td width='5%'>".consultarSiImprimeProcAgrupado($tipoOrdenAgrup,$contadorActualAgrup,$valor['codigo'],$valor['imprimir'],"off")."</td>
									<td width='90%'> ".trim($proc)."</td>
									<td align='center' width='5%'> ". $valor['cantidad'] ."</td>";
		// -------------------	
		
		$cadenaProcedimientos .= consultarEstadosAgrupadosGenerales($valor['estadoProced']);
	
		// -------------------		
		$cadenaProcedimientos .= "</tr>";
		
		
		if($valor['justificacion']!="")
			$cadenaJustificacion .= trim($proc) . ": " . $valor['justificacion'] . "\n =================================== \n";
	}
	$cadenaProcedimientos .= "</table>";
	
	echo $cadenaProcedimientos."*||*".$cadenaJustificacion;
}

 function pintarTrProcedimientosAgrupados($whis,$wing,$accionesPestana,$indicePestana,$editable,$ccoPaciente,$colArticulo)
{
	global $conex;
	global $wbasedato;
	global $wbasedatohce;
	global $usuario;
	
	global $arrayParaCrearJsAgrupados;
	
	$ccoUrgencias = consultarCcoUrgencias();
	
	$consultarEstadosAyudasDx = consultarEstadoGeneralProcAgrup();
				 
	$query = "SELECT Ordfec,Ordtor,Ordnro,Ordimp
				FROM ".$wbasedato."_000188
			   WHERE Ordhis='".$whis."' 
				 AND Ording='".$wing."' 
				 AND Ordest='on' ";
	
	$res = mysql_query($query, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $query . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$OrdenesAgrupadas = array();

	$contador = 0;

	if($num > 0){
		
		while ($row = mysql_fetch_array($res)) 
		{
			$OrdenesAgrupadas[$contador]['Fecha'] = $row[0];
			$OrdenesAgrupadas[$contador]['TipOrd'] = $row[1];
			$OrdenesAgrupadas[$contador]['NumOrd'] = $row[2];
			$OrdenesAgrupadas[$contador]['Impresion'] = $row[3];
			$contador++;
		}
	}
	
	
	$contadorProcAgr = 0;
	if(count($OrdenesAgrupadas)>0)
	{
		foreach ($OrdenesAgrupadas as $valor)
		{
			$queryDetalles = "SELECT a.Dettor,a.Detnro,a.Detcod,a.Detite,a.Detcnt,b.Detjus,b.Detesi,b.Detfmo,b.Dethmo,c.Eexmeh,b.Detimp,b.Detpen
								FROM ".$wbasedato."_000189 a, ".$wbasedatohce."_000028 b , ".$wbasedato."_000045 c
							   WHERE a.Dettoa='".$valor['TipOrd']."' 
								 AND a.Detnra='".$valor['NumOrd']."'
								 AND a.Dettor=b.Dettor
								 AND a.Detnro=b.Detnro
								 AND a.Detite=b.Detite
								 AND b.Detesi = c.Eexcod;";
			
			$resDetalles = mysql_query($queryDetalles, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $queryDetalles . " - " . mysql_error());
			$numDetalles = mysql_num_rows($resDetalles);

			$Detalles = array();
			$Estados = array();

			$contadorDetalles = 0;

			if($numDetalles > 0){
				$cadenaJustificacion="";
				$cadenaProcedimientos="";
				$estadoAgrupado="";
				
				$pendiente_lectura = "";
				
				
				$cantidadPendientes=0;
				$cantidadRealizados=0;
				$cantidadCancelados=0;
				$cantidadPendientesResultado=0;
				$cantidadAutorizados=0;
				
				$cadenaProcedimientos .= "<table width='100%'>";
				$cadenaProcedimientos .= "	<tr>";
				$cadenaProcedimientos .= "		<td>Imp.</td>";
				$cadenaProcedimientos .= "		<td align='right' colspan='2'>Cant.</td>";
				$cadenaProcedimientos .= "		<td align='right'>Estado</td>";
				$cadenaProcedimientos .= "	</tr>";
				
				$cantEstadosRealizados=0;
				$cantEstadosRealizadosUrgen=0;
				while ($rowDetalles = mysql_fetch_array($resDetalles)) 
				{
					$Detalles[$contadorDetalles]['TipOrd'] = $rowDetalles[0];
					$Detalles[$contadorDetalles]['NumOrd'] = $rowDetalles[1];
					$Detalles[$contadorDetalles]['CodPro'] = $rowDetalles[2];
					$Detalles[$contadorDetalles]['Item'] = $rowDetalles[3];
					$Detalles[$contadorDetalles]['cantidad'] = $rowDetalles[4];
					$Detalles[$contadorDetalles]['justificacion'] = $rowDetalles[5];
					$Detalles[$contadorDetalles]['estado'] = $rowDetalles[6];
					
					$Detalles[$contadorDetalles]['fecMod'] = $rowDetalles[7];
					$Detalles[$contadorDetalles]['horMod'] = $rowDetalles[8];
					$Detalles[$contadorDetalles]['Eexmeh'] = $rowDetalles[9];
					$Detalles[$contadorDetalles]['impresion'] = $rowDetalles[10];
					
					$Estados[$contadorDetalles] = $rowDetalles[6];
					
					$fecHorModificacion = strtotime( $rowDetalles[7]." ".$rowDetalles[8] );
					$diaAnterior = strtotime("-1 day"); // 24 horas antes de la fecha actual --DATE_SUB( NOW() , INTERVAL 24 HOUR )
					
					if( permiteLecturaOrdenesPendientes( $conex, "01", $usuario->codigoRolHCE ) && $pendiente_lectura=="")
					{
						if($rowDetalles[11]=="on"){				
							$pendiente_lectura = "style='background-color:#3CB648'";
						}
					}
					
					
					if($rowDetalles[9]=="on")
					{
						$cantEstadosRealizados++;
					}
					
					if($ccoPaciente == $ccoUrgencias)
					{
						if($fecHorModificacion > $diaAnterior)
						{
							$cantEstadosRealizadosUrgen++;
						}
					}
					
					$queryMedicamentos = "SELECT Relmed,Relido 
											FROM ".$wbasedato."_000195 
										   WHERE Relhis='".$whis."' 
										     AND Reling='".$wing."' 
											 AND Reltor='".$Detalles[$contadorDetalles]['TipOrd']."' 
											 AND Relnro='".$Detalles[$contadorDetalles]['NumOrd']."' 
											 AND Relpro='".$Detalles[$contadorDetalles]['CodPro']."' 
											 AND Relite='".$Detalles[$contadorDetalles]['Item']."';";
			
					$resMedicamentos = mysql_query($queryMedicamentos, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $queryMedicamentos . " - " . mysql_error());
					$numMedicamentos = mysql_num_rows($resMedicamentos);
					
					$medicamentosProcedimiento = array();
					if($numMedicamentos>0)
					{
						while ($rowMedicamentos = mysql_fetch_array($resMedicamentos)) 
						{
							
							foreach($colArticulo as $arti)
							{
								$codArticulo = explode("-",$arti->codigoArticulo);
								
								if($rowMedicamentos['Relmed'] == $codArticulo[0] && $rowMedicamentos['Relido'] == $arti->idOriginal)
								{
									$present= consultarPresentacion($Detalles[$contadorDetalles]['CodPro'],$rowMedicamentos['Relmed'],$arti->via);
								
									$idArrMed = $Detalles[$contadorDetalles]['CodPro']."_".$rowMedicamentos['Relmed']."_".$present."_".$arti->via;
									
									$medicamentosProcedimiento[$idArrMed]['codMed']=$rowMedicamentos['Relmed'];
									$medicamentosProcedimiento[$idArrMed]['dosis']=$arti->cantidadDosis;
									$medicamentosProcedimiento[$idArrMed]['frecuencia']=$arti->periodicidad;
									$medicamentosProcedimiento[$idArrMed]['via']=$arti->via;
									$medicamentosProcedimiento[$idArrMed]['tipoProtocolo']=$arti->tipoProtocolo;
									$medicamentosProcedimiento[$idArrMed]['posicionActual']=$arti->consecutivoArticuloOrden;
									
									$medicamentosProcedimiento[$idArrMed]['suspendido']=$arti->suspendido;
									
									$apli =  consultarAplicacionMedicamentoPorProcAgrupado($whis,$wing,$rowMedicamentos['Relmed'],$rowMedicamentos['Relido']);
									
									if($apli == "on")
									{
										$medAplic[$valor['TipOrd']."|".$valor['NumOrd']] = $apli;
									}
									
									$sald =  consultarSaldoMedicamentoPorProcAgrupado($whis,$wing,$rowMedicamentos['Relmed']);
									
									if($sald != 0)
									{
										$medSald[$valor['TipOrd']."|".$valor['NumOrd']] = $sald;
									}
									
									if($sald == 0)
									{
										$medSinSald[$valor['TipOrd']."|".$valor['NumOrd']] = $sald;
									}
								}
							}
						}
					}
					
					$proc = consultarNombreProcedimiento($Detalles[$contadorDetalles]['CodPro']);
					
					$cadenaProcedimientos .= "<tr>";
					$cadenaProcedimientos .= "	<td width='5%'>".consultarSiImprimeProcAgrupado($valor['TipOrd'],$contadorProcAgr,$Detalles[$contadorDetalles]['CodPro'],$valor['Impresion'],"on")."</td>
												<td width='85%'>".trim($proc)."</td>
												<td align='center' width='5%'> ". $Detalles[$contadorDetalles]['cantidad'] ."</td>";
					$cadenaProcedimientos .= consultarEstadosAgrupadosGenerales($Detalles[$contadorDetalles]['estado']);
												
					$cadenaProcedimientos .= "</tr>";
					
					if($Detalles[$contadorDetalles]['justificacion']!="")
						$cadenaJustificacion .= trim($proc) . ": " . $Detalles[$contadorDetalles]['justificacion'] . "\n =================================== \n";
						
					$arrayParaCrearJsAgrupados[ $rowDetalles[0]."-".$rowDetalles[1]."-".$rowDetalles[3] ] = array( $valor['TipOrd'].$contadorProcAgr, $valor['TipOrd'], $Detalles[$contadorDetalles]['cantidad'],utf8_encode($Detalles[$contadorDetalles]['justificacion']),$Detalles[$contadorDetalles]['estado'],$medicamentosProcedimiento,$Detalles[$contadorDetalles]['impresion'] );
					$contadorDetalles++;
				}
				$cadenaProcedimientos .= "</table>";
			}
// var_dump($arrayParaCrearJsAgrupados);
			$queryEstados = " SELECT Eexcod,Eexdes,Eexpnd,Eexrea,Eexcan,Eexgen,Eexapa  
								FROM ".$wbasedato."_000045 
							   WHERE Eexord='on' 
								 AND Eexest='on'
							ORDER BY Eexgen;";
			
			$resEstados = mysql_query($queryEstados, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $queryEstados . " - " . mysql_error());
			$numEstados = mysql_num_rows($resEstados);
			
			$EstadosProced = array();
			$EstadosProcedimientos = array();
			$EstadosAgrupados = array();
			
			if($numEstados > 0){
				
				$contEstados=0;
				while ($rowEstados = mysql_fetch_array($resEstados)) 
				{
					if($rowEstados[2]=='on')
					{
						$EstadosAgrupados['PENDIENTE'][] = $rowEstados[0];
					}
					elseif($rowEstados[3]=='on')
					{
						$EstadosAgrupados['REALIZADO'][] = $rowEstados[0];
					}
					elseif($rowEstados[4]=='on')
					{
						$EstadosAgrupados['CANCELADO'][] = $rowEstados[0];
					}
					
					$EstadosProcedimientos[$contEstados]['Eexgen'] = $rowEstados[5];
					$EstadosProcedimientos[$contEstados]['Eexcod'] = $rowEstados[0];
					$EstadosProcedimientos[$contEstados]['Eexdes'] = $rowEstados[1];
					$EstadosProcedimientos[$contEstados]['Eexapa'] = $rowEstados[6];
					
					$contEstados++;
				}
			}
			
			foreach($EstadosAgrupados as $key => $est)
			{
				$EstadosAgrupados[$key]['cantidad'] = 0;
				foreach($est as $key2 => $value)
				{
					foreach($Estados as $key3 => $value2)
					{
						if($value2 == $value)
						{
							$EstadosAgrupados[$key]['cantidad'] ++;
						}
					}
				}
			}
			
			foreach($EstadosProcedimientos as $key => $valueEstado)
			{
				if($valueEstado['Eexgen'] != "")
				{
					foreach($EstadosAgrupados as $key => $value)
					{
						if($valueEstado['Eexdes']==$key && $value['cantidad'] > 0)
						{
							$estadoAgrupado = $valueEstado['Eexcod'];
							break 2;
						}
					}
				}
			}
			$tipoOrdenDesc = consultarNombreTipoOrden($wbasedatohce,$valor['TipOrd']);
			
			//Eliminar del array los procedimientos que ya fueron realizados
			if($cantEstadosRealizados==count($Estados) && $cantEstadosRealizadosUrgen==0)
			{
				foreach ($Detalles as $detall)
				{
					unset($arrayParaCrearJsAgrupados[ $detall['TipOrd']."-".$detall['NumOrd']."-".$detall['Item'] ]);
				}
			}
			
			if(($cantEstadosRealizados==count($Estados) && $cantEstadosRealizadosUrgen>0) || $cantEstadosRealizados!=count($Estados))
			{
				
				
				echo "	<tr id='trExAgru".$valor['TipOrd'].$contadorProcAgr."' bgcolor='#CCF0D2'>
						<td align='center'>";
				echo "		<a href='#null'  style='font-size:10pt'>
							<b>&nbsp;&nbsp;&nbsp;<u>Orden Nro.<br> ".$valor['NumOrd']."</u></b>
						</td>";
						
						if( $editable )
						{
							$checkImpresion = "";
							if($valor['Impresion'] == "on")
							{
								$checkImpresion = "checked='checked'";
							}
							echo "<td align='center'>
									<div id='imgImprimirAgr".$valor['TipOrd'].$contadorProcAgr."' style='display:inline'>
									<img width='18' height='18' src='../../images/medical/hce/icono_imprimir.png' border='0'/>
									<br>
									<input type='checkbox' id='imprimir_examen_Agru".$valor['TipOrd'].$contadorProcAgr."' name='imprimir_examen_Agru$contadorProcAgr' ".$checkImpresion." onClick='cambiarImprimirProcedimientosAgrupados(\"".$valor['TipOrd']."\",\"$contadorProcAgr\");' />
									</div>
								  </td>"  ;
						}
						
				echo	"<td>";
						if( $editable ){
							
							//Solo se puede modificar la fecha general si no se ha realizado ningun procedimiento
							if($EstadosAgrupados['REALIZADO']['cantidad']==0 && $EstadosAgrupados['CANCELADO']['cantidad']==0)
							{
								crearCampo("1","wfsolAgru".$valor['TipOrd'].$contadorProcAgr,@$accionesPestana[$indicePestana.".8"],array("SIZE"=>"10","onChange"=>"marcarCambio('$indicePestana','$contadorProcAgr');cambiarFechaProcedimientosAgrupados('".$valor['TipOrd']."','$contadorProcAgr');","cod_examen"=>$valor['TipOrd'],"readonly"=>"readonly","class"=>"campo2 calendariofecha"),$valor['Fecha']);
							}
							else							
							{
								crearCampo("1","wfsolAgru".$valor['TipOrd'].$contadorProcAgr,@$accionesPestana[$indicePestana.".8"],array("SIZE"=>"10","disabled"=>"disabled","onChange"=>"marcarCambio('$indicePestana','$contadorProcAgr');cambiarFechaProcedimientosAgrupados('".$valor['TipOrd']."','$contadorProcAgr');","cod_examen"=>$valor['TipOrd'],"readonly"=>"readonly","class"=>"campo2 calendariofecha"),$valor['Fecha']);
							}
						}
						else
						{
							echo $valor['Fecha'];
						}
						  
						$grabad="on";
						 
						$funcionOnclickAbrirModal = "onClick='abrirModalProcedimientosAgrupados(\"".$valor['TipOrd']."\",\"".$contadorProcAgr."\",\"".$editable."\",\"".$grabad."\");'";
						
						
						echo"</td>;
						 
								<td  align='center' ". $funcionOnclickAbrirModal.">".$tipoOrdenDesc."</td>
							  
								<td ". $funcionOnclickAbrirModal." ".$pendiente_lectura."><div id='divCantidadesProcedimiento".$valor['TipOrd'].$contadorProcAgr."'>".$cadenaProcedimientos."</div></td>
						  
							<td>";
						  
						  $cantidadRenglones = count($Detalles)+2;
						  
						  crearCampo("2","wtxtjustexamenAgru".$valor['TipOrd'].$contadorProcAgr,@$accionesPestana[$indicePestana.".6"],array("cols"=>"35","rows"=> $cantidadRenglones,"readonly"=>"readonly"),$cadenaJustificacion);
						  echo"</td>
						  
						  <input type='hidden' id='tipoOrdenAgru".$valor['TipOrd'].$contadorProcAgr."' value='".$valor['TipOrd']."'>
						  <input type='hidden' id='NroOrdenAgru".$valor['TipOrd'].$contadorProcAgr."' value='".$valor['NumOrd']."'>
						  
						  <td>";
						  						  
							$tieneUnMedAplicado = false;
							if(count($medAplic)>0)
							{
								foreach($medAplic as $keyMedApl => $valMedApl)
								{
									if($keyMedApl == $valor['TipOrd']."|".$valor['NumOrd'])
									{
										$tieneUnMedAplicado = true;
										break;
									}
								}
							}
						  					  
							$tieneUnMedConSaldo = false;
							if(count($medSald)>0)
							{
								// var_dump($medSald);
								foreach($medSald as $keyMedSald => $valMedSald)
								{
									if($keyMedSald == $valor['TipOrd']."|".$valor['NumOrd'])
									{
										$tieneUnMedConSaldo = true;
										break;
									}
								}
							}
						  				  
							$tieneUnMedSinSaldo = false;
							if(count($medSinSald)>0)
							{
								// var_dump($medSinSald);
								foreach($medSinSald as $keyMedSinSald => $valMedSinSald)
								{
									if($keyMedSinSald == $valor['TipOrd']."|".$valor['NumOrd'])
									{
										$tieneUnMedSinSaldo = true;
										break;
									}
								}
							}
						  
							$opcionesSeleccion="";
							foreach ($consultarEstadosAyudasDx as $estadoExamen){
								$permisoEstado = @$accionesPestana[$indicePestana.".".$estadoExamen->codigo_permiso];
							
								$estado_opcion = "disabled";
								
								//Si el rol tiene permisos y puede leer entonces el estado de la opcion estara activo.								
								if(count($permisoEstado) > 0 and $permisoEstado->leer == true){									
									$estado_opcion = "";
								}
								
								//No puede cancelar si uno de los medicamentos asociados tiene una aplicacion
								if($estadoExamen->est_cancelada == "on" && $tieneUnMedAplicado)
								{
									$estado_opcion = "disabled";
								}
								
								//No puede realizar si uno de los medicamentos asociados tiene saldo, es decir, si no se ha aplicado o no se ha devuelto
								if($estadoExamen->est_realizado == "on" && $tieneUnMedConSaldo)
								{
									$estado_opcion = "disabled";
								}
								
								//No puede realizar si no se ha dispensado por lo menos uno de los medicamentos
								if($estadoExamen->est_realizado == "on" && $tieneUnMedSinSaldo)
								{
									$estado_opcion = "disabled";
								}
								
								// La orden no se puede cancelar si un procedimiento fue realizado
								if($EstadosAgrupados['REALIZADO']['cantidad']>0 && $estadoExamen->codigo=="C")
								{
									$estado_opcion = "disabled";
								}
								
								if($estadoExamen->codigo!=$estadoAgrupado)
								{
									$opcionesSeleccion .= "<option value='$estadoExamen->codigo' accMed='$estadoExamen->accion_med_proc_agrup' estRealizado='$estadoExamen->est_realizado' $estado_opcion>$estadoExamen->descripcion</option>";
								}
								else
								{										
									$opcionesSeleccion .= "<option value='$estadoExamen->codigo' accMed='$estadoExamen->accion_med_proc_agrup' estRealizado='$estadoExamen->est_realizado' selected $estado_opcion>$estadoExamen->descripcion</option>";
								}
							}
							
							//Solo se puede modificar el estado general si no se ha realizado ningun procedimiento
							if($EstadosAgrupados['REALIZADO']['cantidad']==0 && $EstadosAgrupados['CANCELADO']['cantidad']==0)
							{
								crearCampo("6","westadoexamenProcAgrup".$valor['TipOrd'].$contadorProcAgr,@$accionesPestana[$indicePestana.".9"],array("class"=>"campo2","onChange"=>"cambioEstadosProcAgrupados('".$valor['TipOrd']."','".$contadorProcAgr."');marcarCambio('$indicePestana','$contExamenes');"),"$opcionesSeleccion");	
							}
							else							
							{
								crearCampo("6","westadoexamenProcAgrup".$valor['TipOrd'].$contadorProcAgr,@$accionesPestana[$indicePestana.".9"],array("class"=>"campo2","disabled"=>"disabled","onChange"=>"cambioEstadosProcAgrupados('".$valor['TipOrd']."','".$contadorProcAgr."');marcarCambio('$indicePestana','$contExamenes');"),"$opcionesSeleccion");	
							}
							
					echo "</td>
						  
						  <td> </td>
						</tr>";		
					
					// $contadorProcAgr++;
			}
			// else
			// {
				// unset($arrayParaCrearJsAgrupados[ $valor['TipOrd']."-".$valor['NumOrd']."-".$valor['Item'] ]);
			// }
			$contadorProcAgr++;
		}
	}
	
	?><script>contprocedimientosAgrupados = <?php echo $contadorProcAgr; ?>;</script><?php
	
}

function GrabarProcedimientosAgrupados($wemp_pmla, $wbasedato,$historia,$ingreso,$tipoOrden,$NroOrden,$fechaOrdAgr,$wuser,$detalles,$justificaciones,$imprimir)
{
	global $conex;
	global $wbasedatohce;
	
	$referencia = "";
	$mensajeAud = "";
		
	$fecha = date("Y-m-d");
	$hora = date("H:i:s");
	
	if($NroOrden=="")
	{
		$NroOrden=consultarAliasPorAplicacion( $conex, $wemp_pmla, "consecutivoProcedimientosAgrupados" );
	}
		
	$qOrdenExiste = "  SELECT * 
						 FROM ".$wbasedato."_000188
						WHERE Ordhis = '".$historia."'
						  AND Ording = '".$ingreso."'
						  AND Ordtor = '".$tipoOrden."'
						  AND Ordnro = '".$NroOrden."';";
	
	$resOrdenExiste = mysql_query($qOrdenExiste, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qOrdenExiste . " - " . mysql_error());
	$numOrdenExiste = mysql_num_rows($resOrdenExiste);
	
	$EstadosProced = array();
	$EstadosProcedimientos = array();
	if($numOrdenExiste > 0){
		
		foreach($detalles as $keyAgrupados => $tipAgrupado)
		{
			foreach($tipAgrupado as $key => $examen)
			{
				$queryUpdateEncabezado = "  UPDATE ".$wbasedato."_000188 
											SET	Ordfec = '".$fechaOrdAgr."',
												Ordimp = '".$imprimir."'
										  WHERE Ordhis = '".$historia."'
										    AND Ording = '".$ingreso."'
										    AND Ordtor = '".$tipoOrden."'
										    AND Ordnro = '".$NroOrden."';";
			
				$resultadoUpdateEncabezado = mysql_query($queryUpdateEncabezado,$conex) or die("Error: " . mysql_errno() . " - en el query: ".$queryUpdateEncabezado." - ".mysql_error());
							
				if(mysql_affected_rows()==1)
				{
					$Mensaje = "Se actualizo correctamente el encabezado de la orden agrupada";
				}
				else
				{
					$Mensaje = "Error al actualizar el encabezado de la orden agrupada";
				}
				
				$queryUpdateDetalle = "  UPDATE ".$wbasedato."_000189 
												SET	Detcnt = '".$examen['cantidad']."'
											  WHERE Dettoa = '".$examen['tipoOrdenAgrupada']."'
												AND Detnra = '".$NroOrden."'
												AND Dettor = '".$examen['tipoOrden']."'
												AND Detnro = '".$examen['numOrden']."'
												AND Detcod = '".$examen['CodProcedimiento']."'
												AND Detite = '".$examen['numItem']."';";
				
				$resultadoUpdateDetalle = mysql_query($queryUpdateDetalle,$conex) or die("Error: " . mysql_errno() . " - en el query: ".$queryUpdateDetalle." - ".mysql_error());
				
				if(mysql_affected_rows()==1)
				{
					$Mensaje = "Se actualizo correctamente el detalle de la orden agrupada";
					
					$mensajeAud= "Procedimiento agrupado modificado";
					$referencia.= "Procedimiento agrupado: ".$examen['tipoOrdenAgrupada'].",".$NroOrden.",".$examen['tipoOrden'].",".$examen['numOrden'].",".$examen['CodProcedimiento'].",".$examen['numItem'].",".$examen['cantidad']."<br>";
				}
				else
				{
					$Mensaje = "Error al actualizar el detalle de la orden agrupada";
				}
				
				if(isset($examen['medicamentos']))
				{
					foreach($examen['medicamentos'] as $keyMed => $valueMed)
					{
						$qRelMedExiste = "  SELECT * 
											 FROM ".$wbasedato."_000195
											WHERE Relhis = '".$historia."'
											  AND Reling = '".$ingreso."'
											  AND Reltor = '".$examen['tipoOrden']."'
											  AND Relnro = '".$examen['numOrden']."'
											  AND Relpro = '".$examen['CodProcedimiento']."'
											  AND Relite = '".$examen['numItem']."'
											  AND Relmed = '".$valueMed['codMed']."'
											  AND Relido = '".$valueMed['ido']."';";
						
						$resRelMedExiste = mysql_query($qRelMedExiste, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qRelMedExiste . " - " . mysql_error());
						$numRelMedExiste = mysql_num_rows($resRelMedExiste);
						
						if($numRelMedExiste == 0)
						{
							$queryInsertDetalleMed="INSERT INTO ".$wbasedato."_000195 (Medico,Fecha_data,Hora_data,Relhis,Reling,Reltor,Relnro,Relpro,Relite,Relmed,Relido,Seguridad)  VALUES ('".$wbasedato."','".$fecha."','".$hora."','".$historia."','".$ingreso."','".$examen['tipoOrden']."','".$examen['numOrden']."','".$examen['CodProcedimiento']."','".$examen['numItem']."','".$valueMed['codMed']."','".$valueMed['ido']."','C-".$wbasedato."');";
						
							$resultadoInsertDetalleMed = mysql_query($queryInsertDetalleMed,$conex) or die("Error: " . mysql_errno() . " - en el query: ".$queryInsertDetalleMed." - ".mysql_error());
											
							if(mysql_affected_rows()==1)
							{
								$mensajeAud= "Procedimiento agrupado modificado";
								$referencia.= "Procedimiento agrupado: ".$examen['tipoOrdenAgrupada'].",".$NroOrden.",".$examen['tipoOrden'].",".$examen['numOrden'].",".$examen['CodProcedimiento'].",".$examen['numItem'].",".$examen['cantidad']."<br>";
								
								$Mensaje = "Se inserto correctamente la relacion del medicamento con el procedimiento de la orden agrupada";
								$referencia.= "Nuevo medicamento asociado: ".$examen['tipoOrden'].",".$examen['numOrden'].",".$examen['CodProcedimiento'].",".$examen['numItem'].",".$valueMed['codMed'].",".$valueMed['ido']."<br>";
							}
							else
							{
								$Mensaje = "Error al insertar la relacion del medicamento con el procedimiento de la orden agrupada";
							}
						}
						
						
						
					}
				}
			}
		}
	}
	else
	{
		//Insertar encabezado
		$queryInsert="INSERT INTO ".$wbasedato."_000188 (Medico,Fecha_data,Hora_data,Ordfec,Ordhis,Ording,Ordtor,Ordnro,Ordest,Ordusu,Ordimp,Seguridad) VALUES ('".$wbasedato."','".$fecha."','".$hora."','".$fechaOrdAgr."','".$historia."','".$ingreso."','".$tipoOrden."','".$NroOrden."','on','".$wuser."','".$imprimir."','C-".$wbasedato."');";
		
		$resultadoInsert = mysql_query($queryInsert,$conex) or die("Error: " . mysql_errno() . " - en el query: ".$queryInsert." - ".mysql_error());
						
		if(mysql_affected_rows()==1)
		{
			// $Mensaje = "Se inserto correctamente el encabezado de la orden agrupada";
			
			foreach($detalles as $keyAgrupados => $tipAgrupado)
			{
				foreach($tipAgrupado as $key => $examen)
				{
					
					
					$qDetOrdenExiste = "  SELECT * 
											 FROM ".$wbasedato."_000189
											WHERE Dettoa = '".$examen['tipoOrdenAgrupada']."'
											  AND Detnra = '".$NroOrden."'
											  AND Dettor = '".$examen['tipoOrden']."'
											  AND Detnro = '".$examen['numOrden']."'
											  AND Detcod = '".$examen['CodProcedimiento']."'
											  AND Detite = '".$examen['numItem']."';";
					
					$resDetOrdenExiste = mysql_query($qDetOrdenExiste, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qDetOrdenExiste . " - " . mysql_error());
					$numDetOrdenExiste = mysql_num_rows($resDetOrdenExiste);
					
					if($numDetOrdenExiste == 0){
						$queryInsertDetalle="INSERT INTO ".$wbasedato."_000189 (Medico,Fecha_data,Hora_data,Dettoa,Detnra,Dettor,Detnro,Detcod,Detite,Detcnt,Seguridad)  VALUES ('".$wbasedato."','".$fecha."','".$hora."','".$examen['tipoOrdenAgrupada']."','".$NroOrden."','".$examen['tipoOrden']."','".$examen['numOrden']."','".$examen['CodProcedimiento']."','".$examen['numItem']."','".$examen['cantidad']."','C-".$wbasedato."');";
				
						$resultadoInsertDetalle = mysql_query($queryInsertDetalle,$conex) or die("Error: " . mysql_errno() . " - en el query: ".$queryInsertDetalle." - ".mysql_error());
										
						if(mysql_affected_rows()==1)
						{
							$Mensaje = "Se inserto correctamente el detalle de la orden agrupada \n";
							$mensajeAud= "Procedimiento agrupado creado";
							$referencia.= "Procedimiento agrupado: ".$examen['tipoOrdenAgrupada'].",".$NroOrden.",".$examen['tipoOrden'].",".$examen['numOrden'].",".$examen['CodProcedimiento'].",".$examen['numItem'].",".$examen['cantidad']."<br>";
						}
						else
						{
							$Mensaje = "Error al insertar el detalle de la orden agrupada";
						}
					}
					
					
					
					
					if(isset($examen['medicamentos']))
					{
						foreach($examen['medicamentos'] as $keyMed => $valueMed)
						{
							$queryInsertDetalleMed="INSERT INTO ".$wbasedato."_000195 (Medico,Fecha_data,Hora_data,Relhis,Reling,Reltor,Relnro,Relpro,Relite,Relmed,Relido,Seguridad)  VALUES ('".$wbasedato."','".$fecha."','".$hora."','".$historia."','".$ingreso."','".$examen['tipoOrden']."','".$examen['numOrden']."','".$examen['CodProcedimiento']."','".$examen['numItem']."','".$valueMed['codMed']."','".$valueMed['ido']."','C-".$wbasedato."');";
							
							$resultadoInsertDetalleMed = mysql_query($queryInsertDetalleMed,$conex) or die("Error: " . mysql_errno() . " - en el query: ".$queryInsertDetalleMed." - ".mysql_error());
											
							if(mysql_affected_rows()==1)
							{
								$Mensaje = "Se inserto correctamente la relacion del medicamento con el procedimiento de la orden agrupada";
								$referencia.= "Medicamento asociado: ".$examen['tipoOrden'].",".$examen['numOrden'].",".$examen['CodProcedimiento'].",".$examen['numItem'].",".$valueMed['codMed'].",".$valueMed['ido']."<br>";
							}
							else
							{
								$Mensaje = "Error al insertar la relacion del medicamento con el procedimiento de la orden agrupada";
							}
						}
					}
					
				}
			}
			
			$queryUpdateConsecutivo="UPDATE root_000051 
										SET	Detval = Detval + 1
									  WHERE Detemp = '".$wemp_pmla."' 
										AND Detapl = 'consecutivoProcedimientosAgrupados';";
			
			$resultadoUpdateConsecutivo = mysql_query($queryUpdateConsecutivo,$conex) or die("Error: " . mysql_errno() . " - en el query: ".$queryUpdateConsecutivo." - ".mysql_error());
									
			if(mysql_affected_rows()==1)
			{
				$Mensaje = "Modificado correctamente el consecutivo de la orden agrupada";
			}
			else
			{
				$Mensaje = "Error al modificar el consecutivo de la orden agrupada";
			}
		}
		else
		{
			$Mensaje = "Error al insertar el encabezado de la orden agrupada";
		}
		
	}
	
	//Registro de auditoria
	$auditoria = new AuditoriaDTO();

	$auditoria->historia = $historia;
	$auditoria->ingreso = $ingreso;
	$auditoria->descripcion = $referencia;
	// $auditoria->descripcion = "$audAnterior \n\n$audNuevo";
	$auditoria->fechaKardex = $fecha." - ".$hora;
	// $auditoria->mensaje = $mensajeAuditoria;
	$auditoria->mensaje = $mensajeAud;
	$auditoria->seguridad = $wuser;
	$auditoria->idOriginal = $idOriginal;

	registrarAuditoriaKardex($conex,$wbasedato,$auditoria);
	
}

function pintarFilaProcedimientosAgrupados($tipoOrden,$wuser,$contadorProcAgr,$wcedula,$tipoDocumento,$wemp_pmla,$agrupados,$renglon)
{
	global $conex;
	global $wbasedatohce;
	
	$editable = "1";
	
	$indicePestana = "4";
	$accionesPestana = consultarAccionesPestana($indicePestana);
	
	$tipoOrdenDesc = consultarNombreTipoOrden($wbasedatohce,$tipoOrden);
	
	$cadenaProcedimientos="";
	
	$cadenaJustificacion="";
	
	
	$cadenaProcedimientos .= "<table width='100%'>";
	$cadenaProcedimientos .= "<tr>";
	$cadenaProcedimientos .= "<td>Imp.</td>";
	$cadenaProcedimientos .= "<td align='right' colspan='2'>Cant.</td>";
	$cadenaProcedimientos .= "</tr>";
	
	foreach($agrupados as $keyAgrupados => $tipAgrupado)
	{
		$proc = consultarNombreProcedimiento($agrupados[$keyAgrupados]['codigo']);
		
		$cadenaCodProcedimientos .= $agrupados[$keyAgrupados]['codigo'] . "|";
		
		$cadenaProcedimientos .= "<tr>";
		$cadenaProcedimientos .= "<td width='5%'>".consultarSiImprimeProcAgrupado($tipoOrden,$contadorProcAgr,$agrupados[$keyAgrupados]['codigo'],$agrupados[$keyAgrupados]['imprimir'],"off")."</td>";
		$cadenaProcedimientos .= "<td width='95%'> ".trim($proc)."</td><td align='center' width='5%'> ". $agrupados[$keyAgrupados]['cantidad'] ."</td>";
		$cadenaProcedimientos .= "</tr>";
		
		
		if($agrupados[$keyAgrupados]['justificacion']!="")
			$cadenaJustificacion .= trim($proc) . ": " . $agrupados[$keyAgrupados]['justificacion'] . "\n =================================== \n";
			
	}
	
	$cadenaProcedimientos .= "</table>";
	
	
	$numeroDeOrden=consultarAliasPorAplicacion( $conex, $wemp_pmla, "consecutivoProcedimientosAgrupados" ); 
	
	echo "	<tr id='trExAgru".$tipoOrden.$contadorProcAgr."'>
			<td align='center'>";
				crearCampo("4","",@$accionesPestana["4.3"],array("onClick"=>"quitarExamenAgrupado('$tipoOrden','$contadorProcAgr','$renglon','','on');"),"<img src='../../images/medical/root/borrar.png' border='0' width='17' height='17' />");
	echo "	<a href='#null'  style='font-size:10pt'>
			<b>&nbsp;&nbsp;&nbsp;Orden Nro. ".$numeroDeOrden."</b>
			</td>
			
			<td align='center'>";
			
			 crearCampo("4","",@$accionesPestana[$indicePestana.".5"],array("onClick"=>"quitarExamenAgrupado('$tipoOrden','$contadorProcAgr','$renglon','','on');"),"<img src='../../images/medical/root/borrar.png' border='0' width='17' height='17'>");
			 
			echo"
			  <img width='17' height='17' src='../../images/medical/hce/icono_imprimir.png' border='0'/><input type='checkbox' value='' id='imprimir_examen_Agru".$tipoOrden.$contadorProcAgr."' name='imprimir_examen_Agru$contadorProcAgr'  checked='checked' onClick='cambiarImprimirProcedimientosAgrupados(\"$tipoOrden\",\"$contadorProcAgr\")' />
			</td>
			  
			  <td>";
			  crearCampo("1","wfsolAgru".$tipoOrden.$contadorProcAgr,@$accionesPestana[$indicePestana.".8"],array("SIZE"=>"10","onChange"=>"marcarCambio('$indicePestana','$contadorProcAgr');cambiarFechaProcedimientosAgrupados('$tipoOrden','$contadorProcAgr');","cod_examen"=>$tipoOrden,"readonly"=>"readonly","class"=>"campo2 calendariofecha"),date("Y-m-d"));
			 
			 $grabad = "off";
			  echo"</td>;
			  
			  <td onClick='abrirModalProcedimientosAgrupados(\"".$tipoOrden."\",\"".$contadorProcAgr."\",\"".$editable."\",\"".$grabad."\");'>".$tipoOrdenDesc."</td>
			  
			  <td onClick='abrirModalProcedimientosAgrupados(\"".$tipoOrden."\",\"".$contadorProcAgr."\",\"".$editable."\",\"".$grabad."\");'>".$cadenaProcedimientos."</td>
			  
			  <td>";
			  // var_dump($agrupados[$tipoOrden.$contadorProcAgr]);
			  // var_dump(count($agrupados[$tipoOrden.$contadorProcAgr]));
			    $cantidadRenglones = count($agrupados[$tipoOrden.$contadorProcAgr])+2;
			  crearCampo("2","wtxtjustexamenAgru".$tipoOrden.$contadorProcAgr,@$accionesPestana[$indicePestana.".6"],array("cols"=>"35","rows"=> $cantidadRenglones,"readonly"=>"readonly"),utf8_decode( $cadenaJustificacion ) );
			  echo"</td>
			  
			  <input type='hidden' id='tipoOrdenAgru".$tipoOrden.$contadorProcAgr."' value='".$tipoOrden."'>
			  			   
			  <td>Pendiente</td>
			  
			  <td> </td>
			</tr>";
}

function pintarModalProcedimientosAgrupados($wemp_pmla, $wbasedatohce,$agrupados,$tipoServicio,$Grabado,$contprocedAgrupados,$editable)
{
	global $conex;
	global $wbasedato;
	
	global $usuario;
	global $wuser;
	global $paciente;
	
	$paciente = consultarInfoPacienteOrdenHCEPorHistoriaIngreso($conex, $wbasedato, $historia, $ingreso);
	$usuario = consultarUsuarioOrdenes( $wuser );
		
	$cadenaProcMed = "";
	$procedimientos = consultarProcedimientosAgrupados($tipoServicio);
	
	$tipoOrden = consultarNombreTipoOrden($wbasedatohce,$tipoServicio);
	
	$accionesPestanaMedicamentos = consultarAccionesPestana( "3" );
	$accionesPestanaProcedimientos = consultarAccionesPestana( "4" );
	
	$accionesPestana = array_merge($accionesPestanaMedicamentos,$accionesPestanaProcedimientos);
	
	//-------------------------------------------------
	//				Acciones por pestaña
	//-------------------------------------------------
	
		//Agregar procedimientos
		$permisoAgregarProc = '';
		if( !$accionesPestana[ "4.1" ]->leer ){
			$permisoAgregarProc = 'disabled="disabled"';
		}
		
		//Cancelar procedimientos
		$permisoCancelarProc = '';
		if( !$accionesPestana[ "4.14" ]->leer ){
			$permisoCancelarProc = 'disabled="disabled"';
		}
		
		//Justificacion procedimientos
		$permisoJustificacion = '';
		if( !$accionesPestana[ "4.6" ]->leer ){
			$permisoJustificacion = 'disabled="disabled"';
		}
		
		//Agregar medicamentos
		$permisoAgregarMed = '';
		if( !$accionesPestana[ "3.1" ]->leer ){
			$permisoAgregarMed = 'disabled="disabled"';
		}
		
		//Suspender medicamentos
		$permisoSuspenderMed = '';
		if( !$accionesPestana[ "3.N3" ]->leer ){
			$permisoSuspenderMed = 'disabled="disabled"';
		}
		
		//Dosis medicamentos
		$permisoDosis = '';
		if( !$accionesPestana[ "3.N5" ]->leer ){
			$permisoDosis = 'disabled="disabled"';
		}
		
		//Frecuencia medicamentos
		$permisoFrecuencia = '';
		if( !$accionesPestana[ "3.N7" ]->leer ){
			$permisoFrecuencia = 'disabled="disabled"';
		}
		
	//-------------------------------------------------
	
	
// var_dump($procedimientos);	
// var_dump($agrupados);	
	$queryEstados = " SELECT Eexcod,Eexdes,Eexpnd,Eexrea,Eexcan,Eexgen  
						FROM ".$wbasedato."_000045 
					   WHERE Eexord='on' 
						 AND Eexest='on'
					ORDER BY Eexgen;";
	
	$resEstados = mysql_query($queryEstados, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $queryEstados . " - " . mysql_error());
	$numEstados = mysql_num_rows($resEstados);
	
	$EstadosProcedimientos = array();
	$EstadosAgrupados = array();
	$EstadosProced = array();
	if($numEstados > 0){
		
		$contEstados=0;
		while ($rowEstados = mysql_fetch_array($resEstados)) 
		{
			if($rowEstados[2]=='on')
			{
				$EstadosAgrupados['PENDIENTE'][] = $rowEstados[0];
			}
			elseif($rowEstados[3]=='on')
			{
				$EstadosAgrupados['REALIZADO'][] = $rowEstados[0];
			}
			elseif($rowEstados[4]=='on')
			{
				$EstadosAgrupados['CANCELADO'][] = $rowEstados[0];
			}
			
			$EstadosProced[$contEstados] = $rowEstados[0];
			
			$EstadosProcedimientos[$contEstados]['Eexgen'] = $rowEstados[5];
			$EstadosProcedimientos[$contEstados]['Eexcod'] = $rowEstados[0];
			$EstadosProcedimientos[$contEstados]['Eexdes'] = $rowEstados[1];
			
			$contEstados++;
		}
	}
		
	echo "<div id='procedimientosAgrupados'>
			</br>
			<span  style='font-weight:bold;text-align:left;'>Ayuda o procedimiento</span>
			</br>
			</br>
			<table width='90%' id='tablaProcedimientosAgrupados' align='center' cellspacing='1' cellpadding='2' >
				<tr class='encabezadoTabla' align='center' >
					<td colspan='".(($Grabado=="on") ? '8' : '6')."'>".$tipoOrden."</td>
				</tr>";
				
				if(count($procedimientos)>0)
				{
					echo "<tr class='encabezadoTabla' align='center' >
							<td colspan='2'>Procedimiento</td>
							<td>Cant.</td>
							".(($Grabado=="on") ? '<td>Estado</td>' : '')."
							<td colspan='2'>Procedimiento</td>
							<td>Cant.</td>
							".(($Grabado=="on") ? '<td>Estado</td>' : '')."
						</tr>";
					// var_dump($procedimientos);
					$contEditable=0;
					for($i=0;$i<count($procedimientos);$i+=2)
					{
						$medicamentosProcAgrup1 = consultarMedicamentosProcedimientosAgrupados($procedimientos[$i]['codigo']);
						$medicamentosProcAgrup2 = consultarMedicamentosProcedimientosAgrupados($procedimientos[$i+1]['codigo']);
						
						if(count($agrupados)>0)
						{
							$ProcedimientoSeleccionado=false;
							$ProcedimientoSeleccionado2=false;
							$cantidad1=1;
							$cantidad2=1;
							$justificacion1="";
							$justificacion2="";
							$descEstado1="";
							$descEstado2="";
							$estadoAgru1="";
							$estadoAgru2="";
							$estadoPendiente1 = 'estPendiente=""';
							$estadoPendiente2 = 'estPendiente=""';
							
							foreach($agrupados as $key => $examen)
							{
								// if($examen['consecutivo']==-1 && $procedimientos[$i]['estadoProced']=="R")
								
								// if($examen['consecutivo']!="-1" && $Grabado=="on")
								// if($examen['consecutivo']!="-1" && $Grabado=="on")
								// {
									if($examen['codigo']==$procedimientos[$i]['codigo'])
									{
										$ProcedimientoSeleccionado=true;
										$cantidad1=$examen['cantidad'];
										$justificacion1=$examen['justificacion'];
										$estado1=$examen['estadoProced'];
										$estadoAnt1=$examen['estadoAnterior'];
										
										foreach($EstadosAgrupados as $key => $est)
										{
											foreach($est as $key2 => $value)
											{
												if($estado1 == $value)
												{
													$estadoAgru1=$key;
													
													if($key == "PENDIENTE")
													{
														$estadoPendiente1 = 'estPendiente="on"';
													}
													
													break;
												}
											}
										}
																			
										$posicionEstado1 = array_search($examen['estadoProced'], $EstadosProced);
										
										$descEstado1=$EstadosProcedimientos[$posicionEstado1]['Eexdes'];
									}
							// var_dump($examen);
									if($examen['codigo']==$procedimientos[$i+1]['codigo'])
									{
										$ProcedimientoSeleccionado2=true;
										$cantidad2=$examen['cantidad'];
										$justificacion2=$examen['justificacion'];
										$estado2=$examen['estadoProced'];
										$estadoAnt2=$examen['estadoAnterior'];
										
										foreach($EstadosAgrupados as $key => $est)
										{
											foreach($est as $key2 => $value)
											{
												if($estado2 == $value)
												{
													$estadoAgru2=$key;
													
													if($key == "PENDIENTE")
													{
														$estadoPendiente2 = 'estPendiente="on"';
													}
													
													break;
												}
											}
										}
										
										$posicionEstado2 = array_search($examen['estadoProced'], $EstadosProced);
										
										$descEstado2=$EstadosProcedimientos[$posicionEstado2]['Eexdes'];
									}
								// }
									
								
									
								
							}
						}
						//---------------------------------------------------
						
						//-----> i
						
						// $deshabilitado = "";
						// $funcionOnclick = "";
						// $soloLectura = "";
						// $clase = "";
						// $checkProc = "";
						// $justificacionProc1 = "";
						// $cantPrAg = 0;
						// $estadoPrAg = "";
						// $fondoProcSeleccionado = "";
						// $claseMed = "";
						
						
						
						if($Grabado=="on" && $ProcedimientoSeleccionado == false)
						{
							$deshabilitado = 'disabled="disabled"';
						}
						else
						{
							$deshabilitado = '';
						}
						
						if($estadoAgru1=="REALIZADO" || ($estadoAgru1=="CANCELADO" && $estadoAnt1 == ""))
						{
							$funcionOnclick = 'onclick="javascript: return false;"';
							$soloLectura = 'readOnly="readOnly"';
						}
						else
						{
							$funcionOnclick = '';
							$soloLectura = '';
						}
																		
						if($procedimientos[$i]['justificacion'] == "on")
						{
							$clase = "class='ProcedimientoConJustificacion'";
						}
						else
						{
							$clase = '';
						}
						
						if($ProcedimientoSeleccionado == true && $estado1 !="C")
						{
							$checkProc = 'checked="checked"';
							$permisoProcedimiento = $permisoCancelarProc;
						}
						else
						{
							$checkProc = '';
							$permisoProcedimiento = $permisoAgregarProc;
						}
						
						if($ProcedimientoSeleccionado == true)
						{
							$justificacionProc1 = $justificacion1;
							$cantPrAg =  $cantidad1;
							$estadoPrAg =  $estado1;
						}
						else
						{
							$justificacionProc1 = '';
							$cantPrAg = 1;
							$estadoPrAg = "P";
							$estadoPendiente1 = 'estPendiente="on"';
						}
						
						
						if($descEstado1!="")
						{
							$fondoProcSeleccionado =  "bgcolor='#FFF97E'";
						}
						else
						{
							$fondoProcSeleccionado = "";
						}
						
						//---
						if(count($medicamentosProcAgrup1) > 0)
						{
							$claseMed =  "class='ProcedimientoConMedicamentos'";
						}
						else
						{
							$claseMed = "";
						}
						
						
						//-----> i + 1
						
						// $deshabilitado2 = "";
						// $funcionOnclick2 = "";
						// $soloLectura2 = "";
						// $clase2 = "";
						// $checkProc = "";
						// $justificacionProc2 = "";
						// $cantPrAg2 = 0;
						// $estadoPrAg2 = "";
						// $fondoProcSeleccionado2 = "";
						// $claseMed = "";
						
						if($Grabado=="on" && $ProcedimientoSeleccionado2 == false)
						{
							$deshabilitado2 = 'disabled="disabled"';
						}
						else
						{
							$deshabilitado2 = '';
						}
						
						if($estadoAgru2=="REALIZADO" || ($estadoAgru2=="CANCELADO" && $estadoAnt2 == ""))
						{
							$funcionOnclick2 = 'onclick="javascript: return false;"';
							$soloLectura2 = 'readOnly="readOnly"';
						}
						else
						{
							$funcionOnclick2 = '';
							$soloLectura2 = '';
						}
																
						if($procedimientos[$i+1]['justificacion'] == "on")
						{
							$clase2 = "class='ProcedimientoConJustificacion'";
						}
						else
						{
							$clase2 = '';
						}
						
						if($ProcedimientoSeleccionado2 == true && $estado2 !="C")
						{
							$checkProc2 = 'checked="checked"';
							$permisoProcedimiento = $permisoCancelarProc;
						}
						else
						{
							$checkProc2 = '';
							$permisoProcedimiento = $permisoAgregarProc;
						}
						// echo "justificacion2 ---> ".$justificacion2;
						if($ProcedimientoSeleccionado2 == true)
						{
							$justificacionProc2 = $justificacion2;
							$cantPrAg2 =  $cantidad2;
							$estadoPrAg2 =  $estado2;
							
							
						}
						else
						{
							$justificacionProc2 = '';
							$cantPrAg2 = 1;
							$estadoPrAg2 = "P";
							$estadoPendiente2 = 'estPendiente="on"';
						}
						
						if($descEstado2!="")
						{
							$fondoProcSeleccionado2 =  "bgcolor='#FFF97E'";
						}
						else
						{
							$fondoProcSeleccionado2 = "";
						}
						
						
						//---------------------------------------------------
						
						if ($fila_lista=='Fila2')
							$fila_lista = "Fila1";
						else
							$fila_lista = "Fila2";
						
						
						
						if($Grabado=="on" && $descEstado1!="" && ($estadoAgru1!="REALIZADO" || ($estadoAgru1!="CANCELADO" && $estadoAnt1 != "")))
						{
							$contEditable++;
						}

						if($Grabado=="on" && $descEstado2!="" && ($estadoAgru2!="REALIZADO" || ($estadoAgru2!="CANCELADO" && $estadoAnt2 != "")))
						{
							$contEditable++;
						}
						

						echo"<tr class='".$fila_lista."'>
								<td align='center' width='3%'  valign='top' ><input type='checkbox' value='".$procedimientos[$i]['codigo']."' name='ckProcedimiento' id='ckProcedimiento'  ".$permisoProcedimiento."  ".$deshabilitado."  ".$funcionOnclick." ".$clase."  ".$checkProc."  onchange='validarMedicamentos(\"".$procedimientos[$i]['codigo']."\",\"".$procedimientos[$i]['descripcion']."\");'  ></td>
								<td width='43%' valign='top'>".$procedimientos[$i]['descripcion']." 
								</br>";
								
								if($procedimientos[$i]['justificacion'] == "on")
								{
									echo "<textarea name='txaJustificacionProced".$procedimientos[$i]['codigo']."' id='txaJustificacionProced".$procedimientos[$i]['codigo']."' cols='55' rows='2' placeholder='Justificacion' class='fondoAmarillo' ".$soloLectura." onblur='validarCheckMarcado(\"".$procedimientos[$i]['codigo']."\",\"".$procedimientos[$i]['descripcion']."\");' ".$deshabilitado."  ".$permisoJustificacion." >".utf8_decode( $justificacionProc1 )."</textarea>";
								}
								
								//Procedimientos con medicamentos asociados
								if(count($medicamentosProcAgrup1)>0)
								{
									echo "<fieldset style='padding:5px;margin:5px;border: 2px solid #8FAACE;' >";
										echo "<legend style='border: 2px solid #8FAACE;border-top: 0px;font-family: Verdana;background-color: #8FAACE;font-size:8pt;font-weight:bold;'> Medicamentos </legend>";
									
									
									echo "<table id='medProcAgrup_".$procedimientos[$i]['codigo']."' width='100%'>";
										echo "<tr class='".$fila_lista."'>";
											echo "<td colspan='2' width='55%'></td>";
											echo "<td style='font-weight:bold;font-size:7pt;' width='30%'>Dosis</td>";
											echo "<td style='font-weight:bold;font-size:7pt;' width='25%'>Frecuencia</td>";
										echo "</tr>";
										
											for($d=0;$d<count($medicamentosProcAgrup1);$d++)
											{
												if(count($agrupados)>0)
												{
													$MedicamentoSeleccionado1=false;
													$codMed1="";
													$dosis1="";
													$frecue1="";
													$suspendido1="";
													$suspActual1="";
													
													$checkMed1="";
													$estMedic1="";
													$fondoMedSuspend1="";
													$disabledMedSuspend1="";
													
													$tipoProtocolo1="";
													$posicionActual1="";
													
													$permisoMedicamento="";
													
													// var_dump($agrupados);
													foreach($agrupados as $key => $examen)
													{
														if($examen['codigo']==$procedimientos[$i]['codigo'])
														{
															// if(isset($examen['medicamentos']))
															if(count($examen['medicamentos']) > 0)
															{
																foreach($examen['medicamentos'] as $keyMed => $medicam)
																{
																	if($medicamentosProcAgrup1[$d]['Rpmmed'] == $medicam['codMed'])
																	{
																		$MedicamentoSeleccionado1=true;
																		
																		$codMed1= $medicam['codMed'];
																		$dosis1= $medicam['dosis'];
																		$frecue1= $medicam['frecuencia'];
																		$suspendido1= $medicam['suspendido'];
																		$suspActual1= $medicam['suspActual'];
																		
																		$tipoProtocolo1= $medicam['tipoProtocolo'];
																		$posicionActual1= $medicam['posicionActual'];
																		
																		break;
																	}
																	
																}
															}
														}
													}
												}
												
												if($MedicamentoSeleccionado1 == true)
												{
													// if($suspendido1!="on" || $suspActual1!="on")
													if($suspendido1!="on")
													{
														// $checkMed1 = 'checked="checked"';
														
														$estMedic1 = "";
														$fondoMedSuspend1 =  "";
														$disabledMedSuspend1 = '';
														
														
														if($suspActual1!="on")
														{
															$checkMed1 = 'checked="checked"';
															$permisoMedicamento = $permisoSuspenderMed;
														}
														else
														{
															$checkMed1 = '';
															$permisoMedicamento = $permisoAgregarMed;
														}
														
													}
													else
													{
														$checkMed1 = '';
														$estMedic1 = "(SUSPENDIDO)";
														$fondoMedSuspend1 =  "bgcolor='#F8B2B2'";
														
														if($suspendido1=="on")
														{
															$disabledMedSuspend1 = 'disabled="disabled"';
														}
													}
													
													
													
													$dosis1 =  $dosis1;
													$frecuencia1 =  $frecue1;
													
													$attrProtPos1 = "attrProtPos='".$tipoProtocolo1.$posicionActual1."'";
												}
												else
												{
													$checkMed1 = '';
													$permisoMedicamento = $permisoAgregarMed;
													$dosis1 =  $medicamentosProcAgrup1[$d]['Relcon'];
													$frecuencia1 =  "";
													
													$attrProtPos1 =  "";
												}
												
												// if($Grabado=="on" && $ProcedimientoSeleccionado == false)
												if($checkProc!="")
												{
													$MedDeshabilitado = '';
												}
												else
												{
													$MedDeshabilitado = 'disabled="disabled"';
												}
												
												
												$cadenaProcMed .= "".$procedimientos[$i]['codigo']."_".$medicamentosProcAgrup1[$d]['Rpmmed']."_".$medicamentosProcAgrup1[$d]['Rpmpre']."_".$medicamentosProcAgrup1[$d]['Rpmvia']."|";
												
												//Tooltip
												$InfoMed1 = " - <div id=\"dvMedAgrupado_".$procedimientos[$i]['codigo']."\" style=\"font-family:verdana;font-size:10pt\"><b>[".$medicamentosProcAgrup1[$d]['Rpmmed']."] ".$medicamentosProcAgrup1[$d]['Artgen']."</b>";
												$InfoMed1 .= "<br><b>Nombre Comercial:</b> " . $medicamentosProcAgrup1[$d]['Artcom'];
												$InfoMed1 .= "<br><b>Presentacion:</b> " . $medicamentosProcAgrup1[$d]['Pcodes'];
												$InfoMed1 .= "<br><b>Unidad de medida:</b> " . $medicamentosProcAgrup1[$d]['Unides'];
												$InfoMed1 .= "<br><b>Via:</b> " . $medicamentosProcAgrup1[$d]['Viades'];
												$InfoMed1 .= "</div>";
												
												$idProc_Med1 = $procedimientos[$i]['codigo']."_".$medicamentosProcAgrup1[$d]['Rpmmed']."_".$medicamentosProcAgrup1[$d]['Rpmpre']."_".$medicamentosProcAgrup1[$d]['Rpmvia'];
												
												//Medicamentos
												echo "<tr class='".$fila_lista."'>";
													echo "<td ".$fondoMedSuspend1."><input type='checkbox' value='".$medicamentosProcAgrup1[$d]['Rpmmed']."' name='ckProcMed_".$idProc_Med1."' id='ckProcMed_".$idProc_Med1."' ".$checkMed1." ".$permisoMedicamento." ".$deshabilitado." ".$MedDeshabilitado." ".$disabledMedSuspend1." ".$attrProtPos1." onChange='validarMedicamentosProcAgrupados(\"".$idProc_Med1."\",\"".$medicamentosProcAgrup1[$d]['Rpmmed']."\",\"".$medicamentosProcAgrup1[$d]['Parpac']."\",\"".$medicamentosProcAgrup1[$d]['Relfam']."\",\"".$medicamentosProcAgrup1[$d]['Artgen']."\",\"".$medicamentosProcAgrup1[$d]['Famnom']."\",\"".$medicamentosProcAgrup1[$d]['Pacdes']."\");validarPrincipioActivoAgrup(\"".$procedimientos[$i]['codigo']."\",\"".$idProc_Med1."\",\"".$procedimientos[$i]['descripcion']."\");' ></td>";
													echo "<td style='font-size:7pt' id='MedAgrupado_".$idProc_Med1."' title='".$InfoMed1."'>".$medicamentosProcAgrup1[$d]['Artgen']." <b>".$estMedic1."</b></td>";
													echo "<td><input type='text' id='DosisAgrupada_".$idProc_Med1."' name='DosisAgrupada_".$idProc_Med1."' style='font-weight:bold;text-align:right;font-size:7pt;' size='3' value='".$dosis1."' ".$permisoDosis." ".$deshabilitado." ".$MedDeshabilitado." ".$disabledMedSuspend1." onkeypress='return validarEntradaEntera(event);'><br><span style='font-size:7pt'>".$medicamentosProcAgrup1[$d]['Unides']." <br> ".$medicamentosProcAgrup1[$d]['Pcodes']."</span></td>";
													echo "<input type='hidden' value='".$medicamentosProcAgrup1[$d]['Artgen']."' name='descrMedProAgrupGener_".$idProc_Med1."' id='descrMedProAgrupGener_".$idProc_Med1."'>";
													
													echo "<td>
															<select style='font-size:7pt' id='freMedAgrup_".$idProc_Med1."' ".$permisoFrecuencia." ".$deshabilitado." ".$MedDeshabilitado." ".$disabledMedSuspend1." >";
														echo "<option value='' selected>Seleccione...</option>";
														
														$colPeriodicidades = consultarPeriodicidades();
														foreach ($colPeriodicidades as $periodicidad){
															
															if($frecuencia1==$periodicidad->codigo)
															{
																echo "<option value='".$periodicidad->codigo."' selected>$periodicidad->descripcion</option>";
															}
															else
															{
																echo "<option value='".$periodicidad->codigo."'>$periodicidad->descripcion</option>";
															}
														}
														
													echo"	</select>
														  </td>";
													echo "<input type='hidden' value='".$medicamentosProcAgrup1[$d]['Famnom']."' name='DescFamiliaProcAgrup_".$idProc_Med1."' id='DescFamiliaProcAgrup_".$idProc_Med1."'>";	  																	  
													echo "<input type='hidden' value='".$medicamentosProcAgrup1[$d]['Parpac']."' name='princActivProcAgrup_".$idProc_Med1."' id='princActivProcAgrup_".$idProc_Med1."'>";	  
													echo "<input type='hidden' value='".$medicamentosProcAgrup1[$d]['Relcon']."' name='dosisProcAgrup_".$idProc_Med1."' id='dosisProcAgrup_".$idProc_Med1."'>";	  
													echo "<input type='hidden' value='".$medicamentosProcAgrup1[$d]['Rpmvia']."' name='viaProcAgrup_".$idProc_Med1."' id='viaProcAgrup_".$idProc_Med1."'>";	  
												echo "</tr>";
											}
											
										echo "</table>";
									
									echo "</fieldset>";
									
									
								}
								
						echo "	<input type='hidden' value='".$procedimientos[$i]['medObligatorio']."' name='medObligatorio".$procedimientos[$i]['codigo']."' id='medObligatorio".$procedimientos[$i]['codigo']."'>
								<input type='hidden' value='".$procedimientos[$i]['descripcion']."' name='descProc".$procedimientos[$i]['codigo']."' id='descProc".$procedimientos[$i]['codigo']."'>
								<input type='hidden' value='".$procedimientos[$i]['imprimir']."' name='imprimirProcAgrup".$procedimientos[$i]['codigo']."' id='imprimirProcAgrup".$procedimientos[$i]['codigo']."'>
								</td>";
						echo"	<td width='4%' ".$fondoProcSeleccionado."  valign='top'><input type='text' style='font-weight:bold;text-align:right;' size='1' value='".$cantPrAg."' name='cantProcAgru".$procedimientos[$i]['codigo']."' id='cantProcAgru".$procedimientos[$i]['codigo']."' ".$deshabilitado." ".$soloLectura." onkeypress='return validarEntradaEntera(event);'>
								<input type='hidden' value='".$estadoPrAg."' name='estProcAgru".$procedimientos[$i]['codigo']."' id='estProcAgru".$procedimientos[$i]['codigo']."' ".$estadoPendiente1.">
								</td>
								";		
								if($Grabado=="on")
								{
									echo "<td valign='top'>".(($descEstado1!="") ? '<b>'.$descEstado1.'</b>' : '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;')."</td>";
								}
								
								if($procedimientos[$i+1]['codigo']!="")
								{
									echo "	<td align='center' width='3%' valign='top'><input type='checkbox' value='".$procedimientos[$i+1]['codigo']."' name='ckProcedimiento' id='ckProcedimiento' ".$permisoProcedimiento." ".$deshabilitado2." ".$funcionOnclick2." ".$clase2."   onchange='validarMedicamentos(\"".$procedimientos[$i+1]['codigo']."\",\"".$procedimientos[$i+1]['descripcion']."\");' ".$checkProc2."></td>
											<td width='43%' valign='top'>".$procedimientos[$i+1]['descripcion']." 
											</br>";
											
											if($procedimientos[$i+1]['justificacion'] == "on")
											{
												echo"<textarea name='txaJustificacionProced".$procedimientos[$i+1]['codigo']."' id='txaJustificacionProced".$procedimientos[$i+1]['codigo']."' cols='55' rows='2' placeholder='Justificacion' class='fondoAmarillo' ".$soloLectura2." onblur='validarCheckMarcado(\"".$procedimientos[$i+1]['codigo']."\",\"".$procedimientos[$i+1]['descripcion']."\");' ".$deshabilitado2." ".$permisoJustificacion.">".$justificacionProc2."</textarea>";
											}
											
											//Procedimientos con medicamentos asociados
											if(count($medicamentosProcAgrup2)>0)
											{
												echo "<fieldset style='padding:5px;margin:5px;border: 2px solid #8FAACE;' >";
													echo "<legend style='border: 2px solid #8FAACE;border-top: 0px;font-family: Verdana;background-color: #8FAACE;font-size:8pt;font-weight:bold;'> Medicamentos </legend>";
																										
												echo "<table id='medProcAgrup_".$procedimientos[$i+1]['codigo']."' width='100%' >";
													echo "<tr class='".$fila_lista."'>";
														echo "<td colspan='2' width='55%'></td>";
														echo "<td style='font-weight:bold;font-size:7pt;' width='30%'>Dosis</td>";
														echo "<td style='font-weight:bold;font-size:7pt;' width='25%'>Frecuencia</td>";
													echo "</tr>";
													
														for($d=0;$d<count($medicamentosProcAgrup2);$d++)
														{
															if(count($agrupados)>0)
															{
																$MedicamentoSeleccionado2=false;
																$codMed2="";
																$dosis2="";
																$frecue2="";
																$suspendido2="";
																$suspActual2="";
																$checkMed2="";
																$estMedic2="";
																$fondoMedSuspend2="";
																$disabledMedSuspend2="";
																$tipoProtocolo2="";
																$posicionActual2="";
																$permisoMedicamento="";
																
																foreach($agrupados as $key => $examen)
																{
																	if($examen['codigo']==$procedimientos[$i+1]['codigo'])
																	{
																		// if(isset($examen['medicamentos']))
																		if(count($examen['medicamentos']) > 0)
																		{
																			foreach($examen['medicamentos'] as $keyMed => $medicam)
																			{
																				if($medicamentosProcAgrup2[$d]['Rpmmed'] == $medicam['codMed'])
																				{
																					$MedicamentoSeleccionado2=true;
																					
																					$codMed2= $medicam['codMed'];
																					$dosis2= $medicam['dosis'];
																					$frecue2= $medicam['frecuencia'];
																					$suspendido2= $medicam['suspendido'];
																					$suspActual2= $medicam['suspActual'];
																					
																					$tipoProtocolo2= $medicam['tipoProtocolo'];
																					$posicionActual2= $medicam['posicionActual'];
																					
																					break;
																				}
																				
																			}
																		}
																	}
																}
															}
															
															// if($MedicamentoSeleccionado2 == true && $suspendido2!="on")
															if($MedicamentoSeleccionado2 == true)
															{
																
																if($suspendido2!="on")
																{
																	$estMedic2 = "";
																	$fondoMedSuspend2 =  "";
																	$disabledMedSuspend2 = '';
																	
																	if($suspActual2!="on")
																	{
																		$checkMed2 = 'checked="checked"';
																		$permisoMedicamento = $permisoSuspenderMed;
																	}
																	else
																	{
																		$checkMed2 = '';
																		$permisoMedicamento = $permisoAgregarMed;
																	}
																	
																}
																else
																{
																	$checkMed2 = '';
																	$permisoMedicamento = $permisoAgregarMed;
																	$estMedic2 = "(SUSPENDIDO)";
																	$fondoMedSuspend2 =  "bgcolor='#F8B2B2'";
																	
																	// if($estado=="grabado" && $suspendido2=="on")
																	if($suspendido2=="on")
																	{
																		$disabledMedSuspend2 = 'disabled="disabled"';
																	}
																	
																}
																
																$dosis2 =  $dosis2;
																$frecuencia2 =  $frecue2;
																
																$attrProtPos2 = "attrProtPos='".$tipoProtocolo2.$posicionActual2."'";
															}
															else
															{
																$checkMed2 = '';
																$permisoMedicamento = $permisoAgregarMed;
																$dosis2 =  $medicamentosProcAgrup2[$d]['Relcon'];
																$frecuencia2 =  "";
																
																$attrProtPos2 =  "";
															}
															
															
														if($checkProc2!="")
														{
															$MedDeshabilitado2 = '';
														}
														else
														{
															$MedDeshabilitado2 = 'disabled="disabled"';
														}
															
															$cadenaProcMed .= "".$procedimientos[$i+1]['codigo']."_".$medicamentosProcAgrup2[$d]['Rpmmed']."_".$medicamentosProcAgrup2[$d]['Rpmpre']."_".$medicamentosProcAgrup2[$d]['Rpmvia']."|";
															
															//Tooltip
															$InfoMed = " - <div id=\"dvMedAgrupado_".$procedimientos[$i+1]['codigo']."\" style=\"font-family:verdana;font-size:10pt\"><b>[".$medicamentosProcAgrup2[$d]['Rpmmed']."] ".$medicamentosProcAgrup2[$d]['Artgen']."</b>";
															$InfoMed .= "<br><b>Nombre Comercial:</b> " . $medicamentosProcAgrup2[$d]['Artcom'];
															$InfoMed .= "<br><b>Presentacion:</b> " . $medicamentosProcAgrup2[$d]['Pcodes'];
															$InfoMed .= "<br><b>Unidad de medida:</b> " . $medicamentosProcAgrup2[$d]['Unides'];
															$InfoMed .= "<br><b>Via:</b> " . $medicamentosProcAgrup2[$d]['Viades'];
															$InfoMed .= "</div>";
															
															$idProc_Med2 = $procedimientos[$i+1]['codigo']."_".$medicamentosProcAgrup2[$d]['Rpmmed']."_".$medicamentosProcAgrup2[$d]['Rpmpre']."_".$medicamentosProcAgrup2[$d]['Rpmvia'];
															
															//Medicamentos
															echo "<tr class='".$fila_lista."'>";
																echo "<td ".$fondoMedSuspend2."><input type='checkbox' value='".$medicamentosProcAgrup2[$d]['Rpmmed']."' name='ckProcMed_".$idProc_Med2."' id='ckProcMed_".$idProc_Med2."' ".$checkMed2." ".$permisoMedicamento." ".$deshabilitado2." ".$MedDeshabilitado2." ".$disabledMedSuspend2." onChange='validarMedicamentosProcAgrupados(\"".$idProc_Med2."\",\"".$medicamentosProcAgrup2[$d]['Rpmmed']."\",\"".$medicamentosProcAgrup2[$d]['Parpac']."\",\"".$medicamentosProcAgrup2[$d]['Relfam']."\",\"".$medicamentosProcAgrup2[$d]['Artgen']."\",\"".$medicamentosProcAgrup2[$d]['Famnom']."\",\"".$medicamentosProcAgrup2[$d]['Pacdes']."\");validarPrincipioActivoAgrup(\"".$procedimientos[$i+1]['codigo']."\",\"".$idProc_Med2."\",\"".$procedimientos[$i+1]['descripcion']."\");'></td>";
																echo "<td style='font-size:7pt' id='MedAgrupado_".$idProc_Med2."' title='".$InfoMed."'>".$medicamentosProcAgrup2[$d]['Artgen']." <b>".$estMedic2."</b></td>";
																echo "<td><input type='text' id='DosisAgrupada_".$idProc_Med2."' name='DosisAgrupada_".$idProc_Med2."' style='font-weight:bold;text-align:right;font-size:7pt;' size='3' value='".$dosis2."' ".$permisoDosis." ".$deshabilitado2." ".$MedDeshabilitado2." ".$disabledMedSuspend2." onkeypress='return validarEntradaEntera(event);'><br><span style='font-size:7pt'>".$medicamentosProcAgrup2[$d]['Unides']." <br> ".$medicamentosProcAgrup2[$d]['Pcodes']."</span></td>";
																
																// echo "<td><input type='text' id='DosisAgrupada_".$idProc_Med2."' name='DosisAgrupada_".$idProc_Med2."' style='font-weight:bold;text-align:right;font-size:7pt;' size='3' value='".$dosis2."' ".$deshabilitado2." ".$MedDeshabilitado2." ".$disabledMedSuspend2." onkeypress='return validarEntradaEntera(event);'><br><span style='font-size:7pt'>".$medicamentosProcAgrup2[$d]['Unides']." <br> ".$medicamentosProcAgrup2[$d]['Pcodes']."</span></td>";
																
																echo "<input type='hidden' value='".$medicamentosProcAgrup2[$d]['Relcon']."' name='dosisProcAgrup_".$idProc_Med2."' id='dosisProcAgrup_".$idProc_Med2."'>";
																echo "<input type='hidden' value='".$medicamentosProcAgrup2[$d]['Artgen']."' name='descrMedProAgrupGener_".$idProc_Med2."' id='descrMedProAgrupGener_".$idProc_Med2."'>";
																echo "<td>
																		<select style='font-size:7pt' id='freMedAgrup_".$idProc_Med2."' ".$permisoFrecuencia."  ".$deshabilitado2." ".$MedDeshabilitado2." ".$disabledMedSuspend2." >";
																	echo "<option value='' selected>Seleccione...</option>";
																	
																	$colPeriodicidades = consultarPeriodicidades();
																	foreach ($colPeriodicidades as $periodicidad){
																		
																		if($frecuencia2==$periodicidad->codigo)
																		{
																			echo "<option value='".$periodicidad->codigo."' selected>$periodicidad->descripcion</option>";
																		}
																		else
																		{
																			echo "<option value='".$periodicidad->codigo."'>$periodicidad->descripcion</option>";
																		}
																	}
																	
																echo"	</select>
																	  </td>";
																
																echo "<input type='hidden' value='".$medicamentosProcAgrup2[$d]['Famnom']."' name='DescFamiliaProcAgrup_".$idProc_Med2."' id='DescFamiliaProcAgrup_".$idProc_Med2."'>";	  																
																echo "<input type='hidden' value='".$medicamentosProcAgrup2[$d]['Parpac']."' name='princActivProcAgrup_".$idProc_Med2."' id='princActivProcAgrup_".$idProc_Med2."'>";	  																
																echo "<input type='hidden' value='".$medicamentosProcAgrup2[$d]['Relcon']."' name='dosisProcAgrup_".$idProc_Med2."' id='dosisProcAgrup_".$idProc_Med2."'>";	  
																echo "<input type='hidden' value='".$medicamentosProcAgrup2[$d]['Rpmvia']."' name='viaProcAgrup_".$idProc_Med2."' id='viaProcAgrup_".$idProc_Med2."'>";	  
															echo "</tr>";
														}
														
														echo "</table>";
											
											echo "</fieldset>";
											
												
												
											}
											
											
									echo	"	<input type='hidden' value='".$procedimientos[$i+1]['medObligatorio']."' name='medObligatorio".$procedimientos[$i+1]['codigo']."' id='medObligatorio".$procedimientos[$i+1]['codigo']."'>
												<input type='hidden' value='".$procedimientos[$i+1]['descripcion']."' name='descProc".$procedimientos[$i+1]['codigo']."' id='descProc".$procedimientos[$i+1]['codigo']."'>
												<input type='hidden' value='".$procedimientos[$i+1]['imprimir']."' name='imprimirProcAgrup".$procedimientos[$i+1]['codigo']."' id='imprimirProcAgrup".$procedimientos[$i+1]['codigo']."'>
											</td>
											<td width='4%' ".$fondoProcSeleccionado2." valign='top'><input type='text'  style='font-weight:bold;text-align:right;' size='1' value='".$cantPrAg2."'  name='cantProcAgru".$procedimientos[$i+1]['codigo']."' id='cantProcAgru".$procedimientos[$i+1]['codigo']."' ".$deshabilitado2."  ".$soloLectura2." onkeypress='return validarEntradaEntera(event);'>
											<input type='hidden' value='".$estadoPrAg2."' name='estProcAgru".$procedimientos[$i+1]['codigo']."' id='estProcAgru".$procedimientos[$i+1]['codigo']."' ".$estadoPendiente2.">
											</td>";
										if($Grabado=="on")
										{
											echo "	<td valign='top'> ".(($descEstado2!="") ? '<b>'.$descEstado2.'</b>' : '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;')." </td>";
										}
										
								}
								else
								{
									echo"<td align='center'></td>
										 <td align='center'></td>
										 <td align='center'></td>";
									
									if($Grabado=="on")
									{
										echo "<td align='center'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>";
									}
								}
								
						echo"</tr>";
					}
				}
				else
				{
					echo"	<tr class='fila2' >
								<td colspan=6 align=center><b>No se encontraron resultados.</b></td>
							</tr>";
				}
				
				
				if($Grabado=="on")
				{
					if($editable!=1)
					{
						echo"<tr>
							<td align='center' colspan='6'><INPUT type='button' value='Cerrar' onClick='cancerlarModalProcedimientosAgrupados();'></td>
						</tr>";
					}
					else
					{
						if($contEditable>0)
						{
							echo"<tr>
								<td align='center' colspan='3'><input type='button' value='Grabar' onClick='validarSeleccionProcedimientoAgrupado(\"".$tipoServicio."\",\"".$contprocedAgrupados."\");'></td>
								<td align='center' colspan='3'><INPUT type='button' value='Cerrar' onClick='cancerlarModalProcedimientosAgrupados();'></td>
							</tr>";
						}
						else
						{
							echo"<tr>
									<td align='center' colspan='6'><INPUT type='button' value='Cerrar' onClick='cancerlarModalProcedimientosAgrupados();'></td>
								</tr>";
						}
					}

				}
				else
				{
						echo"<tr>
								<td align='center' colspan='3'><input type='button' value='Grabar' onClick='validarSeleccionProcedimientoAgrupado(\"".$tipoServicio."\",\"".$contprocedAgrupados."\");'></td>
								<td align='center' colspan='3'><INPUT type='button' value='Cerrar' onClick='cancerlarModalProcedimientosAgrupados();'></td>
							</tr>";
				}
			
			//Crear un array o cadena con los procedimientos con medicamentos asociados
			echo "<input type='hidden' value='".$cadenaProcMed."' name='cadenaProcemientosConMed' id='cadenaProcemientosConMed'>";	  
														
	echo "	</table>
			</br>
		   </div>";
}

function consultarNombreTipoOrden($wbasedatohce,$tipoServicio)
{
	global $conex;
	
	$sql = "SELECT Descripcion 
			  FROM {$wbasedatohce}_000015 
			 WHERE Codigo='".$tipoServicio."'
			   AND Tipagr='on';";

	$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
	
	$row = mysql_fetch_array( $res );
	
	return $row[0];
}

function consultarNombreProcedimiento($procedimiento)
{
	global $conex;
	global $wbasedatohce;
	
	$sql = "SELECT Descripcion 
			  FROM {$wbasedatohce}_000047 
			 WHERE Codigo='".$procedimiento."';";

	$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
	
	$row = mysql_fetch_array( $res );
	
	$row[0] =  str_replace("\"","",$row[0]);
	$row[0] =  str_replace("\'","",$row[0]);
	return $row[0];
}

function consultarTiposOrdenesAgrupadas()
{
	global $conex;
	global $wbasedatohce;

	$q = "SELECT Codigo 
			FROM {$wbasedatohce}_000015 
		   WHERE Tipagr = 'on';";
		   
	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$TiposOrdenesAgrupadas = array();

	$contador = 0;

	if($num > 0){
		
		while ($row = mysql_fetch_array($res)) 
		{
			$TiposOrdenesAgrupadas[$contador] = $row[0];
			$contador++;
		}
		
	} else {
		$TiposOrdenesAgrupadas = $TiposOrdenesAgrupadas."<b>No se encontraron coincidencias</b>";
	}
	
	return $TiposOrdenesAgrupadas;
}

function consultarProcedimientosAgrupados($tipoServicio)
{
	global $conex;
	global $wbasedato;
	global $wbasedatohce;

	$q = "SELECT b.Codigo,b.Descripcion, tiprju AS Justificacion,Toacmo,Toaimp
			FROM {$wbasedato}_000186 a, {$wbasedatohce}_000047 b, {$wbasedatohce}_000015 c
		   WHERE Toacpr=b.Codigo 
			 AND Toacag='".$tipoServicio."' 
			 AND Toaest='on'
			 AND Tipoestudio=c.Codigo
			 AND b.Estado = 'on'
		ORDER BY Toaord,Justificacion,Descripcion;";
		   
	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$TiposOrdenesAgrupadas = array();

	$contador = 0;

	if($num > 0){
		
		while ($row = mysql_fetch_array($res)) 
		{
			$row[1] =  str_replace("\"","",$row[1]);
			$row[1] =  str_replace("\'","",$row[1]);
			$TiposOrdenesAgrupadas[$contador]['descripcion'] = $row[1];
			$TiposOrdenesAgrupadas[$contador]['codigo'] = $row[0];
			$TiposOrdenesAgrupadas[$contador]['justificacion'] = $row[2];
			$TiposOrdenesAgrupadas[$contador]['medObligatorio'] = $row[3];
			$TiposOrdenesAgrupadas[$contador]['imprimir'] = $row[4];
			$contador++;
		}
		
	} 
	
	return $TiposOrdenesAgrupadas;
}
 
 // ----------------
 
function consultarNitResponsable($wemp_pmla,$responsable)
{
	global $conex;
	
	$wbasedatoCliame = consultarAliasPorAplicacion( $conex, $wemp_pmla, "cliame" );
		
	$sql = "  SELECT Empnit 
				FROM ".$wbasedatoCliame."_000024
			   WHERE Empcod='".$responsable."' 
			     AND Empest='on';";
	
	$res = mysql_query ($sql, $conex ) or die ( "Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error() );
	$num = mysql_num_rows( $res );
	
	$nit = "";
	if($num>0)
	{
		$rows = mysql_fetch_array($res);
		$nit = $rows['Empnit'];
	}

	return $nit;
	
}

function replicarEncabezadoKardexAnterior($historia,$ingreso,$fecha){
	global $wbasedato;
	global $conex;

	global $usuario;		//Información de usuario

	$creado = false;

	//Consulta el kardex del dia seleccionado, si es diferente al dia actual sera de consulta Karmeg,
	$q = "INSERT INTO {$wbasedato}_000053 (Medico,Fecha_data,Hora_data,Karhis,Karing,Karobs,Karest,Kardia,Karrut,Kartal,Karpes,Karale,Karcui,Karter,Karcon,Karson,Karcur,Karint,Kardec,Karpal,Kardie,Karmez,Kardem,Karcip,Kartef,Karrec,Kargra,Karanp,Karais,Karare,Karcco,Karusu,Karfir,Karmeg,Karprc,Karsuc,Karaut,Karhco,Karrca,Karusp,Karpda,Karfpv,Karhpv,Karegr,Karupe,Karpen,Karule,Karfle,Karhle,Karord,Seguridad)
									SELECT 
										   Medico,'$fecha'  ,Hora_data,Karhis,Karing,Karobs,Karest,Kardia,Karrut,Kartal,Karpes,Karale,Karcui,Karter,Karcon,Karson,Karcur,Karint,Kardec,Karpal,Kardie,Karmez,Kardem,Karcip,Kartef,Karrec,Kargra,Karanp,Karais,Karare,Karcco,Karusu,Karfir,Karmeg,Karprc,Karsuc,Karaut,Karhco,Karrca,Karusp,Karpda,Karfpv,Karhpv,Karegr,Karupe,Karpen,Karule,Karfle,Karhle,Karord,Seguridad
									FROM 
										".$wbasedato."_000053
									WHERE
										Karest = 'on'
										AND Fecha_data = DATE_ADD('".$fecha."', INTERVAL -1 DAY) 
										AND Karhis = '".$historia."'
										AND Karing = '".$ingreso."'
		";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

	if(mysql_affected_rows() > 0){
		$creado = true;
	}
	return $creado;
}

/****************************************************************************************************************************************
 * Consulta el total de aplicaciones que ha tenido un medicamento
 ****************************************************************************************************************************************/
function consultarTotalAplicacionesEfectivasIncOrdenesINC( $conex, $wbasedato, $his, $ing, $articulo, $fechorInicial, $fechorFinal, $ido = false, $fechorTraslado = 0 ){

	$val = 0;

	if( !$ido ){
		$sql = "SELECT
					Aplcan,Apldos,Aplufr,UNIX_TIMESTAMP( CONCAT( Aplfec,' ', SUBSTRING( Aplron, 1, 2 ) ) ) as Aplfec
				FROM
					{$wbasedato}_000015
				WHERE
					aplhis = '$his'
					AND apling = '$ing'
					AND aplart = '$articulo'
					AND aplfec >= '".date( "Y-m-d", $fechorInicial )."'
					AND aplido != ''
					AND aplest = 'on'
				";
	}
	else{
		$sql = "SELECT
					Aplcan,Apldos,Aplufr,UNIX_TIMESTAMP( CONCAT( Aplfec,' ', SUBSTRING( Aplron, 1, 2 ) ) ) as Aplfec
				FROM
					{$wbasedato}_000015
				WHERE
					aplhis = '$his'
					AND apling = '$ing'
					AND aplart = '$articulo'
					AND aplido = '$ido'
					AND aplest = 'on'
				";
	}

	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$num = mysql_num_rows( $res );

	if( $num > 0 ){

		for( $i = 0; $rows = mysql_fetch_array( $res ); $i++ ){

			if( $rows['Aplfec'] >= 0 && $rows['Aplfec'] > $fechorTraslado && $rows['Aplfec'] <= $fechorFinal ){
				$val += 1;	//Suma de articulos en unidades enteras
			}
		}
	}

	return $val;
}

/**
 * Consulta la última fecha y hora del medicamento en formato Unix en que fue aplicado el medicamento
 */ 
function ultimaAplicacion( $conex, $wbasedato, $his, $ing, $art, $ido ){
	
	$val = 0;
	
	$q="SELECT
			Aplfec, SUBSTRING( Aplron, 1, 2 ) as Aplron
		FROM
			{$wbasedato}_000015
		WHERE
			Aplhis = '$his'
			AND Apling = '$ing'
			AND Aplart = '$art'
			AND Aplido = '$ido'
			AND Aplest = 'on'
		ORDER BY
			Aplfec DESC, Aplron DESC
		";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if($num > 0 ){
		if( $rows = mysql_fetch_array($res) ){
			$val = strtotime( $rows[ 'Aplfec' ]." ".$rows[ 'Aplron' ].":00:00" );
		}
	}
	
	return $val;
}

/**************************************************************************************************************
 * Calcula cuantas veces un articulo ha sido aplicado a partir de una fecha y hora
 *
 * Parametros opcionales:
 * $fecha:	Si este parametro no se manda calculo todas las aplicaciones que tiene el articulo
 * $hora:	Este parametro debe ir acompañado de $fecha. La hora de aplicación a partir de la 
 *			cual se quiere calcular lad dosis calculada. La fecha debe ir en formato de 24 horas y dos cifras.
 * Nota: Si solo se manda la fecha sin hora, el caculo será a partir de la fecha a medica noche
 **************************************************************************************************************/
function cantidadAplicadoPorArticulo( $conex, $wbasedato, $historia, $ingreso, $articulo, $ido, &$cantidadAplicada, $fecha = '', $hora = '' ){

	$val = 0;
	$cantidadAplicada = 0;
	
	$filtroFecha = "";
	if( !empty( $fecha ) ){
		
		if( empty($hora) )
			$hora = '00';
		else
			$hora = substr( $hora, 0, 2 );
			
		$filtroFecha = " 
			AND ((Aplfec = '$fecha'
            AND SUBSTRING( Aplron, 1, 2 ) >= '$hora')
             OR Aplfec > '$fecha')";
	}
	
	$q="SELECT
			COUNT(*), SUM( Apldos )
		FROM
			{$wbasedato}_000015
		WHERE
			Aplhis = '$historia'
			AND Apling = '$ingreso'
			AND Aplart = '$articulo'
			AND Aplido = '$ido'
			AND Aplest = 'on'
			$filtroFecha
		HAVING
			count(*) > 0
		";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if($num > 0 ){
		if( $rows = mysql_fetch_array($res) ){
			$val = $rows[0];
			$cantidadAplicada = $rows[1];
		}
	}
	
	return $val;
}

function consultarPeriodicidadesPorCodigo( $conex, $wbasedato, $cod ){

	$q = "SELECT
			Percod, Percan, Peruni, Perequ, Perdma, Percon, Pertip
		FROM 
			".$wbasedato."_000043
		WHERE Percod = '".$cod."'
	;";

	$coleccion = array();

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$cont1 = 0;
	while($cont1 < $num)
	{
		$info = mysql_fetch_array($res);

		$reg = new PeriodicidadDTO();

		$reg->codigo = $info['Percod'];
		
		$reg->equivalencia = $info['Perequ'];
		$reg->dosisMax = trim( $info['Perdma'] );
		$reg->condicion = trim( $info['Percon'] );
		
		//Actualmente se manejan dos tipos
		//C - Corriento
		//I - Insulina, frecuencia que se pone en el dextrometer
		$reg->tipo = trim( $info['Pertip'] );
		$reg->esTipoInsulina = $reg->tipo == 'I' ? true: false;
		$reg->esTipoCorriente = $reg->tipo == 'C' ? true: false;
		
		if( $reg->esTipoInsulina ){
			$reg->descripcion = strtoupper($info['Peruni']);
		}
		else{
			$reg->descripcion = $info['Percan']." - ".strtoupper($info['Peruni'])."(S)";
		}

		$cont1++;

		$coleccion = $reg;
	}

	return $coleccion;
}

/********************************************************************************************************
 * Consulta la informacion de una familia
 ********************************************************************************************************/
function consultarInfoFamiliaPorCodigo( $conex, $wbasedato, $familia ){

	$val = false;	//Dosis

	$sql = "SELECT Famcod, Famnom, Famest, Famctr
			  FROM {$wbasedato}_000114 b
			 WHERE famcod = '".$familia."' 
		  ";
			  
	$res = mysql_query ($sql, $conex ) or die ( "Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error() );
	
	if( $rows = mysql_fetch_array($res) ){
		$val = $rows;
	}
	
	return $val;

}

/********************************************************************************************************
 * Consulta la informacion de la familia para un articulo según el código
 ********************************************************************************************************/
function consultarInfoFamiliaPorArticulo( $conex, $wbasedato, $familia ){

	$val = false;	//Dosis

	$sql = "SELECT Relfam, Relart, Reluni, Relcon, Relest, Relpre
			  FROM {$wbasedato}_000115 b
			 WHERE relart = '".$familia."' 
		  ";
			  
	$res = mysql_query ($sql, $conex ) or die ( "Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error() );
	
	if( $rows = mysql_fetch_array($res) ){
		$val = Array();
		$val[ 'articulo' ] = $rows;
		$val[ 'familia' ] = consultarInfoFamiliaPorCodigo( $conex, $wbasedato, $rows[ 'Relfam' ] );
	}
	
	return $val;

}

function pedirCTCExamenesGrabados( $conex, $wbasedato, $tip, $numOrd, $item,$codMedico ){
	
	global $wbasedatohce;
	$val = false;
	
		$sql = "  SELECT Detusu 
					FROM ".$wbasedatohce."_000028,".$wbasedatohce."_000019,".$wbasedatohce."_000020  
				   WHERE Dettor='".$tip."' 
					 AND Detnro='".$numOrd."' 
					 AND Detite='".$item."' 
					 AND Detest='on' 
					 AND Detusu = Usucod
					 AND Rolcod = Usurol 
					 AND Rolmed = 'on'
					
				   UNION

				  SELECT Detusu 
					FROM ".$wbasedato."_000159,".$wbasedatohce."_000019,".$wbasedatohce."_000020  
				   WHERE Dettor='".$tip."' 
					 AND Detnro='".$numOrd."' 
					 AND Detite='".$item."' 
					 AND Detest='on' 
					 AND Detusu = Usucod
					 AND Rolcod = Usurol 
					 AND Rolmed = 'on';";
	
	$res = mysql_query ($sql, $conex ) or die ( "Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error() );
	$num = mysql_num_rows( $res );
	
	if($num>0)
	{
		if( $rows = mysql_fetch_array($res) ){
			
			if($codMedico == $rows[0])
			{
				$val = true;
			}
		}
	}
	
	return $val;
}

function procTieneCTC( $conex, $wbasedato, $his, $ing, $tip, $numOrd, $item){
	
	$val = false;
	
	$sql = "SELECT *  
			  FROM ".$wbasedato."_000135
			 WHERE Ctchis = '".$his."'
			   AND Ctcing = '".$ing."'
			   AND Ctctor='".$tip."' 
			   AND Ctcnro='".$numOrd."' 
			   AND Ctcite='".$item."' 
			   AND ctcest='on'; ";
		 
	$res = mysql_query ($sql, $conex ) or die ( "Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error() );
	
	if( $rows = mysql_fetch_array($res) ){
		$val = true;
	}
	
	return $val;
}

 function consultarExamenNoPos( $conex, $procedimiento, $tipoProcedimiento ){
	
	global $wbasedatohce;
	$val = false;
	
	$sql = "  SELECT * 
				FROM ".$wbasedatohce."_000047 
			   WHERE Codigo='".$procedimiento."' 
			     AND Tipoestudio='".$tipoProcedimiento."' 
				 AND NoPos='on' 
				 AND Estado='on';";
	
	$res = mysql_query ($sql, $conex ) or die ( "Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error() );
	$num = mysql_num_rows( $res );
	
	if($num>0)
	{
		$val = true;
	}

	return $val;
}

 // function pedirCTCArticulosGrabados( $conex, $wbasedato, $his, $ing, $art,$codMedico ){
 function pedirCTCArticulosGrabados( $conex, $wbasedato, $his, $ing, $art,$codMedico,$ido ){
	
	global $wbasedatohce;
	$val = false;
	
	$sql = "  SELECT Kadusu 
				FROM ".$wbasedato."_000054,".$wbasedatohce."_000019,".$wbasedatohce."_000020 
			   WHERE kadhis='".$his."' 
				 AND Kading='".$ing."' 
				 AND Kadart='".$art."'
			     AND Kadido='".$ido."' 
			     AND Kadest='on' 
			     AND Kadsus='off' 
				 AND Kadusu = Usucod
				 AND Rolcod = Usurol
				 AND Rolmed = 'on'
			   UNION
			   
			   SELECT Kadusu 
				FROM ".$wbasedato."_000060,".$wbasedatohce."_000019,".$wbasedatohce."_000020 
			   WHERE kadhis='".$his."' 
				 AND Kading='".$ing."' 
				 AND Kadart='".$art."'
			     AND Kadido='".$ido."' 
			     AND Kadest='on' 
			     AND Kadsus='off' 
				 AND Kadusu = Usucod
				 AND Rolcod = Usurol
				 AND Rolmed = 'on';";
	
	$res = mysql_query ($sql, $conex ) or die ( "Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error() );
	$num = mysql_num_rows( $res );
	
	if($num>0)
	{
		if( $rows = mysql_fetch_array($res) ){
			
			if($codMedico == $rows[0])
			{
				$val = true;
			}
		}
	}
	
	return $val;
}
 
 
function artTieneCTC( $conex, $wbasedato, $his, $ing, $art, $ido ){
	
	$val = false;
	
	$sql = "SELECT *
			  FROM ".$wbasedato."_000134
			 WHERE ctchis = '".$his."'
			   AND ctcing = '".$ing."'
			   AND ctcart = '".$art."'
			   AND FIND_IN_SET( '".$ido."', ctcido ) > 0
			 ";
		 
	$res = mysql_query ($sql, $conex ) or die ( "Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error() );
	
	if( $rows = mysql_fetch_array($res) ){
		$val = true;
	}
	
	return $val;
}
 
 /************************************************************************
 * Indica si el articulo es genérico o LEV
 ************************************************************************/
function esArticuloGenericoLevICOrdenes( $conex, $wbasedato, $art, $ido, $his, $ing ){

	$val = false;	//Dosis

	$sql = "SELECT *
			  FROM {$wbasedato}_000171 b
			 WHERE Levhis = '".$his."' 
			   AND Leving = '".$ing."'
			   AND Levlev = '".$art."'
			   AND Levido = '".$ido."'
			   AND Levest = 'on'
		  ";
			  
	$res = mysql_query ($sql, $conex ) or die ( "Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error() );
	
	if( $rows = mysql_fetch_array($res) ){
		$val = true;
	}
	
	return $val;
}
 

function mostrarMensajeAlertaDmax( $conex, $wbasedato, $his, $ing, $art, $ido, &$nombreAlterno ){

	$val = true;
	
	//Busco el insumo ya sea para IC o LQ
	$sql = "SELECT *
			  FROM ".$wbasedato."_000171
			 WHERE levhis = '".$his."'
			   AND leving = '".$ing."'
			   AND levins = '".$art."'
			   AND levidi = '".$ido."'
			";
			   
	$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
	
	if( $rows = mysql_fetch_array($res) ){
		
		//Si es una infusión continua siempre debo mostrar el medicamento
		if( $rows['Levinf'] == 'on' ){
		
			//Si tiene componentes asociados en la tabla de componentes por tipo, mostrará los tipos
			$qComp = "SELECT Carnal, Artgen, Carpna
						FROM {$wbasedato}_000098, {$wbasedato}_000026
					   WHERE Cartip = 'IC'
					     AND Carcod = '$art'
					     AND Carcod = Artcod
					   ;";
			
			$resComp = mysql_query($qComp, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qComp . " - " . mysql_error());
			
			if( $rowsComp = mysql_fetch_array($resComp) ){
				if( !empty($rowsComp['Carnal']) && $rowsComp['Carpna'] ){
					$nombreAlterno = $art."-".$rowsComp['Carnal'];
				}
				else{
					$nombreAlterno = $art."-".$rowsComp['Artgen'];
				}
			}
		
			if( $rows['Levele'] != 'on' ){
				$val = false;
			}
		}
		else{
			//Si es un LQ debo mostrar el electrolito, en caso de no tenerlo debo mostrar
			//la solución
			
			//Si tiene componentes asociados en la tabla de componentes por tipo, mostrará los tipos
			$qComp = "SELECT Carnal
						FROM {$wbasedato}_000098, {$wbasedato}_000026
					   WHERE Cartip = 'LQ'
					     AND Carcod = '$art'
					     AND Carcod = '$art'
					     AND Carcod = Artcod
					   ;";
			
			$resComp = mysql_query($qComp, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qComp . " - " . mysql_error());
			
			if( $rowsComp = mysql_fetch_array($resComp) ){
				if( !empty($rowsComp['Carnal']) ){
					if( !empty($rowsComp['Carnal']) && $rowsComp['Carpna'] ){
						$nombreAlterno = $art."-".$rowsComp['Carnal'];
					}
					else{
						$nombreAlterno = $art."-".$rowsComp['Artgen'];
					}
				}
			}
			
			//Si es LQ miro si tiene más de un articulo
			$sql = "SELECT *
					  FROM ".$wbasedato."_000171
					 WHERE levhis = '".$his."'
					   AND leving = '".$ing."'
					   AND levido = '".$rows['Levido']."'
					";
					   
			$res2 = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
			$num = mysql_num_rows( $res2 );
			
			if( $num > 1 ){
				if( $rows['Levele'] != 'on' ){
					$val = false;
				}
			}
		}
	}
	
	return $val;
}
 
/*******************************************************************************************
 * Carga los articulos de IC y LEV a la temporal
 *******************************************************************************************/
function cargarLEVICAHistorial( $conex, $wmovhos, $his, $ing, $fecKdx ){

	$val = false;
	
	$fecha = date( "Y-m-d" );
	$hora = date( "H:i:s" );
	
	$sql = "INSERT INTO ".$wmovhos."_000184
				  (Medico  , Fecha_data  , Hora_data  , Levhis, Leving, Levlev, Levido, Levins, Levidi, Levele, Levvel, Levvdi, Levvto, Levest, Levfdi, Levvfd, Levinf, Levdca, Levcdc,    Levfkx    , Seguridad )
			SELECT a.Medico, '".$fecha."', '".$hora."', Levhis, Leving, Levlev, Levido, Levins, Levidi, Levele, Levvel, Levvdi, Levvto, Levest, Levfdi, Levvfd, Levinf, Levdca, Levcdc, '".$fecKdx."',a.Seguridad 
			  FROM ".$wmovhos."_000171 a, ".$wmovhos."_000026 b, ".$wmovhos."_000054 c, ".$wmovhos."_000059 d, ".$wmovhos."_000011 f
			 WHERE levhis = '".$his."'
			   AND leving = '".$ing."'
			   AND levhis = kadhis
			   AND leving = kading
			   AND kadfec = '".$fecKdx."'
			   AND levins = kadart
			   AND levidi = kadido
			   AND artcod = levins
			   AND kadlev = 'on'
			   AND defart = artcod
			   AND defcco = ccocod
			   AND ccotra = 'on'
			   AND ccoima != 'on'
			   AND ccofac = 'on'
			   AND kadido NOT IN(
						SELECT levidi 
						  FROM ".$wmovhos."_000184 g
						 WHERE g.levhis = kadhis
						   AND g.leving = kading
						   AND g.levfkx = kadfec
						   AND g.levins = kadart
						   AND g.levidi = kadido
			   )";
			   
	$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
	$num = mysql_affected_rows();
	
	return $val;
}
 
function permisosModificarLEVsIC( $conex, $wbasedato, $tipo, $rol, $cco ){

	$val = false;
	
	$sql = "SELECT *
			  FROM ".$wbasedato."_000183 a
			 WHERE pertip = '$tipo'
			   AND perrol = '$rol'
			   AND percco = '$cco'
			   AND perest = 'on'
			 ";
			   
	$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
	$num = mysql_num_rows( $res );
	
	if( $num > 0 ){
		//Si encuentra es que pertenece a los LEV nuevos
		$val = true;
	}
	
	return $val;
}
 
/**
 * Consulta si un articulo pertenece a los LEVs nuevos o antiguos
 */
function esLevAnterior( $conex, $wbasedato, $his, $ing, $art, $ido ){

	$val = true;
	
	$sql = "SELECT *
			  FROM ".$wbasedato."_000171 a
			 WHERE levhis = '$his'
			   AND leving = '$ing'
			   AND levins = '$art'
			   AND levidi = '$ido'
			 UNION
			SELECT *
			  FROM ".$wbasedato."_000171 a
			 WHERE levhis = '$his'
			   AND leving = '$ing'
			   AND levlev = '$art'
			   AND levido = '$ido'
			 ";
			   
	$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
	$num = mysql_num_rows( $res );
	
	if( $num > 0 ){
		//Si encuentra es que pertenece a los LEV nuevos
		$val = false;
	}
	
	return $val;
}
 
//Buscar las vias de administracion de un articulo.
function buscarViasArticulo($conex, $wbasedatos, $cod_art){
	
	
	$colVias = array();
	
	$q3 = "SELECT Viacod, Viades
			 FROM ".$wbasedatos."_000040
		 ORDER BY Viades ASC;";
	$res3 = mysql_query($q3, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q3 . " - " . mysql_error());
	$num3 = mysql_num_rows($res3);

	$cont1 = 0;
	while($info = mysql_fetch_assoc($res3))
	{
		if(!array_key_exists($info['Viacod'],$colVias)){
			
			$colVias[$info['Viacod']] = $info;
		}

	}
	
	$cod_art = explode("-",$cod_art);
	
	$q = "SELECT Defvia
			 FROM {$wbasedatos}_000059
			WHERE Defest = 'on'
			  AND Defart = '$cod_art[0]'";
	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);
	
	$viasArticulo = array();

	if($num > 0){
		
		$fila = mysql_fetch_array($res);
		
		$fila['Defvia'] = trim( $fila['Defvia'] );
		
		if( strtoupper( $fila['Defvia'] ) == "NO APLICA"  ){
			$fila['Defvia'] = '';
		}
		
		$viasArticulo = explode( ",", $fila['Defvia'] );
	}
	
	$viasFinalArticulo = array();
	
	foreach($viasArticulo as $key => $value){
		
		if(count($colVias[$value]) > 1){
			$viasFinalArticulo[$value] = $colVias[$value];
		}
	}
	
	
	return $viasFinalArticulo;
 }
 
//---------------------
function consultarInfoPacienteOrdenHCEPorHistoriaIngreso( $conex, $wbasedato, $historia, $ingreso){

	
	global $wemp_pmla;
	$paciente = new pacienteKardexDTO();

	$q = "SELECT pacno1, pacno2, pacap1, pacap2, pactid, pacced, Ubisac, Ubihac, Ubisan, Ubihan, Ubialp, Ubiald, Ubiptr, Ubihis, Ubiing,
				".$wbasedato."_000018.fecha_data fecha_data, ".$wbasedato."_000018.hora_data hora_data, Pacnac,
				Ingres,Ingnre, '' fechaServicio, '' horaServicio, Cconom, Orihis, Oriing, Ccourg, Ccocir, Pacsex
			FROM root_000036, root_000037, ".$wbasedato."_000016, ".$wbasedato."_000018 LEFT JOIN ".$wbasedato."_000011 ON Ubisac = Ccocod
		   WHERE Inghis = Ubihis  
			 AND Inging = Ubiing			
             AND orihis=inghis
	         AND Oriori = '$wemp_pmla' 
			 AND Ubihis = '$historia'
			 AND Ubiing = '$ingreso'
			 AND Pacced = Oriced
			 AND Pactid = Oritid ";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if ($num > 0)
	{
		$info = mysql_fetch_array($res);

		$paciente->historiaClinica = $info['Ubihis'];
		$paciente->ingresoHistoriaClinica = $info['Ubiing'];
		$paciente->nombre1 = $info['pacno1'];
		$paciente->nombre2 = $info['pacno2'];
		$paciente->apellido1 = $info['pacap1'];
		$paciente->apellido2 = $info['pacap2'];
		$paciente->documentoIdentidad = $info['pacced'];
		$paciente->tipoDocumentoIdentidad = $info['pactid'];
		$paciente->fechaNacimiento = $info['Pacnac'];
		$paciente->servicioActual = $info['Ubisac'];
		$paciente->servicioAnterior = $info['Ubisan'];
		$paciente->habitacionActual = $info['Ubihac'];
		$paciente->habitacionAnterior = $info['Ubihan'];
		$paciente->numeroIdentificacionResponsable = $info['Ingres'];
		$paciente->nombreResponsable = $info['Ingnre'];
		
		//Consulto la fecha y hora de traslado al piso
		$qMv = "SELECT
					".$wbasedato."_000017.Fecha_data,".$wbasedato."_000017.hora_data
				FROM 
					".$wbasedato."_000017, ".$wbasedato."_000011 
				WHERE 
					Eyrhis = '$paciente->historiaClinica' 
					AND Eyring = '$paciente->ingresoHistoriaClinica' 
					AND Eyrtip = 'Recibo'
					AND Ccocod = Eyrsor	
					AND Eyrest='on'
				ORDER BY 1 DESC, 2 DESC";

		$resMv = mysql_query($qMv,$conex) or die ("Error: " . mysql_errno() . " - en el querys: $qMv - " . mysql_error());
		$contMv = mysql_num_rows($resMv);
		
		if( $rowsMv = mysql_fetch_array( $resMv ) ){
			$info['fechaServicio'] = $rowsMv['Fecha_data'];
			$info['horaServicio'] = $rowsMv['hora_data'];
		}

		$paciente->fechaHoraIngresoServicio = $info['fechaServicio']." ".$info['horaServicio'];

		$paciente->fechaIngreso = $info['fecha_data'];
		$paciente->horaIngreso = $info['hora_data'];

		$paciente->altaDefinitiva = $info['Ubiald'];
		$paciente->altaProceso = $info['Ubialp'];
		
		$paciente->sexo = $info['Pacsex'];

		$estado = false;
		if($info['Ubiptr'] == 'on'){
			$paciente->ultimoMvtoHospitalario = "En proceso de traslado";
			$estado = true;
		}

		if ($info['Ubialp'] == 'on'){
			$paciente->ultimoMvtoHospitalario = "Alta en proceso";
			$estado = true;
		}

		if ($info['Ubiald'] == 'on') {
			$paciente->ultimoMvtoHospitalario = "Alta definitiva";
			$estado = true;
		}

		if(!$estado){
			$paciente->ultimoMvtoHospitalario = "En habitaci&oacute;n";
		}
		$paciente->nombreServicioActual = $info['Cconom'];
		
		//El paciente se encuentra en cirugia o en urgencias
		$paciente->enCirugia = isset($info['Ccocir']) && $info['Ccocir'] == "on" ? true : false;
		$paciente->enUrgencias = isset($info['Ccourg']) && $info['Ccourg'] == "on" ? true : false;

		//Edad
		$ann=(integer)substr($paciente->fechaNacimiento,0,4)*360 +(integer)substr($paciente->fechaNacimiento,5,2)*30 + (integer)substr($paciente->fechaNacimiento,8,2);
		$aa=(integer)date("Y")*360 +(integer)date("m")*30 + (integer)date("d");
		$ann1=($aa - $ann)/360;
		$meses=(($aa - $ann) % 360)/30;
		if ($ann1<1){
			$dias1=(($aa - $ann) % 360) % 30;
			$wedad=(string)(integer)$meses." mes(es) ".(string)$dias1." dia(s)";
			$anos = 0;
		} else {
			$dias1=(($aa - $ann) % 360) % 30;
			$wedad=(string)(integer)$ann1." a&ntilde;o(s) ".(string)(integer)$meses." mes(es) ".(string)$dias1." dia(s)";
			$anos = (integer)$ann1;
		}
		$paciente->edadPaciente = $wedad; 
		$paciente->anosPaciente = $anos; 
	}
	return $paciente;
}

 
 
 
function existeFraccion( $conex, $wbasedato, $art, $ori ){

	$val = false;
	
	global $centroCostosCentralMezclas;
	global $centroCostosServicioFarmaceutico;
	
	$cco = $centroCostosCentralMezclas;
	if( strtoupper( $ori ) == "SF" ){
		$cco = $centroCostosServicioFarmaceutico;
	}
	
	$sql = "SELECT *
			  FROM ".$wbasedato."_000059
			 WHERE defart = '".$art."'
			   AND defcco = '".$cco."'
			   AND defest = 'on'
			 ";
	
	$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
	$num = mysql_num_rows( $res );
	
	if( $num > 0 ){
		$val = true;
	}
	
	return $val;
} 

/************************************************************************************************************
 * Actualiza un insumo para un medicamento LEV
 ************************************************************************************************************/
function eliminarInsLiquidosEndovenoso( $conex, $wbasedato, $his, $ing, $codlev, $idolev, $codIns, $idoIns, $esEle, $volEle, $volDil, $fecSol, $volTot, $codFdi, $valFdi, $inf, $wuser, $insDca, $insCdc ){
	
	$val = true;
	
	$fecha = date( "Y-m-d" );
	$hora = date( "H:i:s" );
	
	$sql = "SELECT *
			  FROM ".$wbasedato."_000171 a
			 WHERE levhis = '$his'
			   AND leving = '$ing'
			   AND levins = '$codIns'
			   AND levidi = '$idoIns'
			 ";
			   
	$resOri = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
	$numOri = mysql_num_rows( $resOri );
	
	if( $numOri > 0 ){
	
		$rowsOri = mysql_fetch_array( $resOri );
	
		$sql = "UPDATE ".$wbasedato."_000171 a
				   SET Levest = 'off'
				 WHERE levhis = '$his'
				   AND leving = '$ing'
				   AND levins = '$codIns'
				   AND levidi = '$idoIns'
				 ";
				   
		$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
		
		if( mysql_affected_rows() == 0 ){
			registrarAuditoriaCierreKardex( $his, $ing, $wuser, "*Insumo LEV no ELIMINADO*No ELIMINADO*".$sql );
			$val = false;
		}
		else{
			$mensajeAuditoria = "";
			$descripcion = "";
			
			if( $rowsOri['Levinf'] == 'on' ){
				if( $rowsOri['Levele'] == 'on' ){
					$mensajeAuditoria = obtenerMensaje('MSJ_IC_MEDICAMENTO_ELIMINADO');
				}
				else{
					$mensajeAuditoria = obtenerMensaje('MSJ_IC_SOLUCION_ELIMINADO');
				}
			}
			else{
				if( $rowsOri['Levele'] == 'on' ){
					$mensajeAuditoria = obtenerMensaje('MSJ_LEV_ELECTROLITO_ELIMINADO');
				}
				else{
					$mensajeAuditoria = obtenerMensaje('MSJ_LEV_SOLUCION_ELIMINADO');
				}
			}
			
			$descripcion = "A:".$rowsOri['Levins'].",".$rowsOri['Levidi'].",".$rowsOri['Levfdi'].",".$rowsOri['Levvfd'].",".$rowsOri['Levcdc'].",".$rowsOri['Levdca'].",".$rowsOri['Levvel'].",".$rowsOri['Levvdi'].",".$rowsOri['Levvto'];

			//Registro de auditoria
			$auditoria = new AuditoriaDTO();

			$auditoria->historia = $his;
			$auditoria->ingreso = $ing;
			$auditoria->descripcion = $descripcion;
			$auditoria->fechaKardex = date( "Y-m-d" );
			$auditoria->mensaje = $mensajeAuditoria;
			$auditoria->seguridad = $wuser;
			$auditoria->idOriginal = $idoIns;

			registrarAuditoriaKardex($conex,$wbasedato,$auditoria);
		}
	}
	
	return $val;
}

/************************************************************************************************************
 * Actualiza un insumo para un medicamento LEV
 ************************************************************************************************************/
function actualizarInsLiquidosEndovenoso( $conex, $wbasedato, $his, $ing, $codlev, $idolev, $codIns, $idoIns, $esEle, $volEle, $volDil, $fecSol, $volTot, $codFdi, $valFdi, $inf, $wuser, $insDca, $insCdc ){
	
	$val = true;
	
	$fecha = date( "Y-m-d" );
	$hora = date( "H:i:s" );
	
	$sql = "SELECT *
			  FROM ".$wbasedato."_000171 a
			 WHERE levhis = '$his'
			   AND leving = '$ing'
			   AND levins = '$codIns'
			   AND levidi = '$idoIns'
			 ";
			   
	$resOri = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
	$numOri = mysql_num_rows( $resOri );
	
	if( $numOri > 0 ){
	
		$rowsOri = mysql_fetch_array( $resOri );

		$actualizar = true;
		//Si no hay datos validos no se actualiza
		if( $codFdi != $rowsOri['Levfdi'] || $valFdi != $rowsOri['Levvfd'] ){
			if( empty( $codFdi ) && empty($valFdi) ){
				$actualizar = false;
			}
		}
		else{
			if( empty( $insCdc ) && empty( $insDca ) ){
				$actualizar = false;
			}
		}
		
		if( !$actualizar ){
			if( $volEle != $rowsOri['Levele'] ){
				$actualizar = true;
			}
			
			if( $volDil != $rowsOri['Levvdi'] ){
				$actualizar = true;
			}
			
			if( $volTot != $rowsOri['Levvto'] ){
				$actualizar = true;
			}
		}
		
		if( $actualizar ){
	
			$sql = "UPDATE ".$wbasedato."_000171 a
					   SET Levfdi = '".$codFdi."',
						   Levvfd = '".$valFdi."',
						   Levcdc = '".$insCdc."',
						   Levdca = '".$insDca."',
						   Levvel = '".$volEle."',
						   Levvdi = '".$volDil."',
						   Levvto = '".$volTot."'
					 WHERE levhis = '$his'
					   AND leving = '$ing'
					   AND levins = '$codIns'
					   AND levidi = '$idoIns'
					 ";
					   
			$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
			
			if( mysql_affected_rows() == 0 ){
				registrarAuditoriaCierreKardex( $his, $ing, $wuser, "*Insumo LEV no MODIFICADO*No Modificado*".$sql );
				$val = false;
			}
			else{
				$mensajeAuditoria = "";
				$descripcion = "";
				
				if( $rowsOri['Levinf'] == 'on' ){
					if( $rowsOri['Levele'] == 'on' ){
						$mensajeAuditoria = obtenerMensaje('MSJ_IC_MEDICAMENTO');
					}
					else{
						$mensajeAuditoria = obtenerMensaje('MSJ_IC_SOLUCION');
					}
				}
				else{
					if( $rowsOri['Levele'] == 'on' ){
						$mensajeAuditoria = obtenerMensaje('MSJ_LEV_ELECTROLITO');
					}
					else{
						$mensajeAuditoria = obtenerMensaje('MSJ_LEV_SOLUCION');
					}
				}
				
				$descripcion = "A:".$rowsOri['Levins'].",".$rowsOri['Levidi'].",".$rowsOri['Levfdi'].",".$rowsOri['Levvfd'].",".$rowsOri['Levcdc'].",".$rowsOri['Levdca'].",".$rowsOri['Levvel'].",".$rowsOri['Levvdi'].",".$rowsOri['Levvto'];
				$descripcion .= " N:$codIns,$idoIns,$codFdi,$valFdi,$insCdc,$insDca,$volEle,$volDil,$volTot";

				//Registro de auditoria
				$auditoria = new AuditoriaDTO();

				$auditoria->historia = $his;
				$auditoria->ingreso = $ing;
				$auditoria->descripcion = $descripcion;
				$auditoria->fechaKardex = date( "Y-m-d" );
				$auditoria->mensaje = $mensajeAuditoria;
				$auditoria->seguridad = $wuser;
				$auditoria->idOriginal = $idoIns;

				registrarAuditoriaKardex($conex,$wbasedato,$auditoria);
			}
		}
	}
	
	return $val;
}

/*******************************************************************************************
 * Muestra la nueva forma de los articulos LEV
 *******************************************************************************************/
function vista_desplegarListaArticulosLEVHistorial( $conex, $wmovhos, $whce, $wemp_pmla, $colDetalle, $his, $ing, $fechaKardex, $accionesPestana,$indicePestana, $usuario, $tipoProtocolo, $editable ){

	$val = false;
	
	$clase_pendientes = "";
	
	$editable = false;
	
	//Busco todos los articulos de levs sobre la temporal por que en está instancia todos los articulos están en la temporal
	$sql = "SELECT * 
			  FROM ".$wmovhos."_000184 a, ".$wmovhos."_000026 b, ".$wmovhos."_000054 c, ".$wmovhos."_000059 d, ".$wmovhos."_000011 f
			 WHERE levhis = '".$his."'
			   AND leving = '".$ing."'
			   AND levhis = kadhis
			   AND leving = kading
			   AND kadfec < '".$fechaKardex."'
			   AND levins = kadart
			   AND levidi = kadido
			   AND artcod = levins
			   AND kadlev = 'on'
			   AND defart = artcod
			   AND defcco = ccocod
			   AND ccotra = 'on'
			   AND ccoima != 'on'
			   AND ccofac = 'on'
			   AND levfkx = kadfec
		  ORDER BY kadfec DESC,levlev, levido, levinf, levele DESC";
	
	$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
	$num = mysql_num_rows( $res );
	
	
	$nombreLev = "";
	$nombreLev1 = "";
	$nombreLev2 = "";
	$suspendido = "";
	$dosisCalculada = "";
	$codigoDosisCalculada = "";
	if( $num > 0 ){
	
		//Muestra el detalle de medicamentos del kardex consultado
		// echo '<span class="subtituloPagina2" align="center" style="cursor:pointer;" onclick="ver_articulos_anteriores(\''.$tipoProtocolo.'\');">';
		// echo "Detalle de articulos anteriores (Ver)";
		// echo "</span><br><br>";
		// echo "<div id='lista_articulos_anterioresLQ' style='display:none'>";
	
		//Se busca la frecuencia de dilución
		$sql = "SELECT *
				  FROM ".$wmovhos."_000173 a
				 WHERE freest = 'on'
				";
					 
		$resVdi = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
		$numVdi = mysql_num_rows( $resVdi );
	
	
	
		$classLev = 'fila1';
		$classInf = 'classIC';
	
		$rows = mysql_fetch_array( $res );
		$rowsUlt['Kadfec'] = '';
		$j = 0;
		$sol = 0;
		do{
		
			if( $rows && ( $rowsUlt['Kadfec'] != $rows[ 'Kadfec' ] ) ){
				if( $j > 0 ){
					echo "</table>";
					echo "</div>";
				}
			
				echo "<a onclick=\"intercalarMedicamentoAnterior('".$rows[ 'Kadfec' ]."','".$tipoProtocolo."');\" href=\"#null\">".$rows[ 'Kadfec' ]."</a><br>";
				echo "<div id='medAnt".$tipoProtocolo.$rows['Kadfec']."' style='display:none'>";
				
				echo "<table align='center' style='width:1500'>";
				
				echo "<tr class='encabezadotabla'>";
				// echo "<td style='width:70'>Acciones</td>";
				echo "<td align='center' style='width:700'>LEV O INFUSION</td>";
				echo "<td align='center' style='width:80'>Vel. de Inf.</td>";
				echo "<td align='center' style='width:80'>Fecha y hora<br>Inicio</td>";
				echo "<td align='center' style='width:60;display:none'>Dias tto.</td>";
				echo "<td align='center' style='width:60'>Dosis máx</td>";
				echo "<td align='center' style='width:100'>Observaciones</td>";
				for( $i =2; $i<=24; $i+=2){
					echo "<td align='center' style='width:50;'>".($i < 10 ? "0".$i : $i )."</td>";
				}
				echo "</tr>";
			}
		
			//Busco el nombre alterno del medicamento
			$sql = "SELECT * 
					  FROM ".$wmovhos."_000098 a
					 WHERE Carcod = '".$rows[ 'Kadart' ]."'
					   AND Cartip = '".( $rows[ 'Levinf' ] == 'on' ? 'IC': 'LQ' )."'
					 ";
			
			$resNA = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
			if( $rowsNA = mysql_fetch_array( $resNA ) ){
				if( !empty($rowsNA[ 'Carnal' ]) && $rowsNA[ 'Carpna' ] == 'on' )
					$rows[ 'Artgen' ] = $rowsNA[ 'Carnal' ];
			}
		
		
		
			$levIdoAnt = $rows[ 'Levido' ];
			$suspendido = $rows[ 'Kadsus' ];
			$rowsUlt = $rows;
			$esLev = true;
			if( $rows[ 'Levinf' ] == 'on' ){
				$esLev = false;
			}
			
			if( permiteLecturaOrdenesPendientes( $conex, $wemp_pmla, $usuario->codigoRolHCE ) ){
				if( $rows[ 'Kadpen' ] == 'on' ){
					$clase_pendientes = 'background-color:#3CB648;';
				}
			}
			
			//Las frecuencias para un mismo LEV es igual en todos sus insumos
			$frec = consultarFrecuencia( $conex, $wmovhos, $rows[ 'Kadper' ] );	
			
			//Se muestra el volumen total de las soluciones
		
			//Para los levs se debe mostrar el nombre de los articulos de soluciones
			if( $esLev ){
				$sol += $rows[ 'Levvto' ];
				$dosisCalculada = $rows[ 'Levvfd' ];
				
				if( $rows['Levele'] != 'on' ){
					$uni = $rows[ 'Deffru' ];
					$nombreLev1 .= $rows[ 'Artgen' ]." <b>".$rows[ 'Levvto' ]." ".$rows[ 'Deffru' ]."</b><br>";
				}
				else{
					$nombreLev2 .= $rows['Artgen']." <b>".$rows[ 'Levvel' ]." ".$rows[ 'Deffru' ]."</b> en C/<b>".$rows[ 'Levvdi' ]."</b><br>";;
				}
			}
			else{
				$sol += $rows[ 'Levvel' ];
				
				if( $rows['Levele'] == 'on' ){
					if( trim($rows[ 'Levdca' ]) != "" && trim($rows[ 'Levcdc' ]) != "" ){
						$dosisCalculada = $rows[ 'Levdca' ];
						$codigoDosisCalculada = $rows[ 'Levcdc' ];
					}
					else if( trim($rows[ 'Levfdi' ]) != "" && trim($rows[ 'Levvfd' ]) != "" ){
						$dosisCalculada = $rows[ 'Levvfd' ];
						$codigoDosisCalculada = $rows[ 'Levfdi' ];
					}
					$uni = $rowsUlt[ 'Deffru' ];
					$nombreLev = $rows[ 'Artgen' ]." <b>".$rows[ 'Levvel' ]." ".$rows[ 'Deffru' ]."</b><br>".$nombreLev;
				}
				else{
					if( trim($rows[ 'Levfdi' ]) != "" && trim($rows[ 'Levvfd' ]) != "" ){
						$dosisCalculada = $rows[ 'Levvfd' ];
						$codigoDosisCalculada = $rows[ 'Levfdi' ];
					}
					$nombreLev .= " hasta <b>".$rows[ 'Levvto' ]." ".$rows[ 'Deffru' ]."</b> de ".$rows[ 'Artgen' ]. "<br>infusi&oacute;n continua " ;
				}
			}
			
			$rows = mysql_fetch_array( $res );
			
			if( ( !$rows || $levIdoAnt != $rows[ 'Levido' ] || $rows['Kadfec'] != $rowsUlt['Kadfec'] ) ){
			
				// $j++;
				
				if( $esLev ){
			
					//Muestra la forma para levs
					if( $suspendido != 'on' ){
						echo "<tr class='$classLev' id='trIdoLev".$levIdoAnt."'>";
					}
					else{
						echo "<tr class='suspendido' id='trIdoLev".$levIdoAnt."'>";
					}
					
					// echo "<td align='center' style='$clase_pendientes'>";
					
					
					// $rolNoSuspenden = consultarAliasPorAplicacion( $conex, $wemp_pmla, "rolNoSuspenden" ); 
					// $rolNoSuspenden = explode( ",", $rolNoSuspenden );
					
					// $usuCreador = consultarUsuarioOrdenes( $rows[ 'Kadusu' ] );
					
					// // if( !in_array( $usuario->codigoRolHCE, $rolNoSuspenden ) || ( in_array( $usuario->codigoRolHCE, $rolNoSuspenden ) && $articulo->codigoCreador == $usuario->codigo ) ){
					// // if( !in_array( $usuario->codigoRolHCE, $rolNoSuspenden ) || ( in_array( $usuario->codigoRolHCE, $rolNoSuspenden ) && in_array( $usuCreador->codigoRolHCE, $rolNoSuspenden ) ) ){
						// // // crearCampo("4","",@$accionesPestana[$indicePestana.".$tipoProtocolo"."3"],array("onClick"=>"suspenderArticulo($contArticulos,'$articulo->tipoProtocolo');"),"<img src='../../images/medical/root/suspender.png' border='0' width='17' height='17' />");
						// // crearCampo("4","",@$accionesPestana[$indicePestana.".$tipoProtocolo"."3"],array("onClick"=>"suspenderArtsLev( $levIdoAnt, true );"),"<img src='../../images/medical/root/suspender.png' border='0'  />");
					// // }
					
					// echo "</td>";
				
					$rowsUlt[ 'Fredes' ] = "";
					$opcionesSeleccion = "<option value=''>Seleccione</option>";
					while($rowsVdi = mysql_fetch_array($resVdi) ){
						if( $rowsVdi[ 'Frecod' ] == $rowsUlt[ 'Levfdi' ]){
							$rowsUlt[ 'Fredes' ] = $rowsVdi[ 'Fredes' ];
							$opcionesSeleccion .= "<option value='".$rowsVdi[ 'Frecod' ]."' selected>".$rowsVdi[ 'Fredes' ]."</option>";
						} else {
							$opcionesSeleccion .= "<option value='".$rowsVdi[ 'Frecod' ]."'>".$rowsVdi[ 'Fredes' ]."</option>";
						}
					}
					mysql_data_seek($resVdi,0);

					// echo "<td onClick='mostrarLEV( ".$levIdoAnt.", \"on\" )'>".trim( $nombreLev1 )."+".trim( $nombreLev2 )."para <b>$frec Horas</b> a <b>$dosisCalculada ".$rowsUlt[ 'Fredes' ]."</b></td>";
					echo "<td>".utf8_encode( trim( $nombreLev1 )."+".trim( $nombreLev2 ) )."para <b>$frec Horas</b> a <b>$dosisCalculada ".$rowsUlt[ 'Fredes' ]."</b></td>";
					
					echo "<td align='center'>"; 
					
					echo "<b>".$dosisCalculada."".$rowsUlt[ 'Fredes' ]."</b>";
					// if( $editable ){
						// crearCampo("1","inFrecDilHis".$levIdoAnt,@$accionesPestana[$indicePestana.".L1"],array("size"=>"3","class"=>"campo2 msg_tooltip","onKeyPress"=>"return validarEntradaDecimal( event );","onChange"=>"cambiarVelocidadInfusionLevInf( $levIdoAnt )"), $dosisCalculada );
						// crearCampo("6", "slVelDilHis".$levIdoAnt,@$accionesPestana[$indicePestana.".L1"],array("class"=>"seleccion","style"=>"height: 25px;","onChange"=>"cambiarVelocidadInfusionLevInf( $levIdoAnt )"),"$opcionesSeleccion");
					// } else {
						// crearCampo("1","inFrecDilHis".$levIdoAnt,@$accionesPestana[$indicePestana.".L1"],array("title"=>$title,"size"=>"3","class"=>"campo2 msg_tooltip","onBlur"=>"return validarEntradaDecimalMinDca( this, $levIdoAnt );","onKeyPress"=>"return validarEntradaDecimal( this, $levIdoAnt, event );","onChange"=>"cambiarVelocidadInfusionLevInf( $levIdoAnt )"), $dosisCalculada );
						// echo "<select id='slVelDil".$levIdoAnt."'>";
						// echo "<option value='".$rowsUlt[ 'Levfdi' ]."'>".$rowsUlt[ 'Fredes' ]."</option>";
						// echo "</select>";
					// }
				
					echo "</td>";
					
					//Fecha y hora de inicio
					echo "<td>";
					echo "<b>".$rowsUlt['Kadfin']." a las:".$rowsUlt['Kadhin']."</b>";
					// echo "<INPUT TYPE='text' NAME='txFecIni".$levIdoAnt."' id='txFecIni".$levIdoAnt."' SIZE=25 readonly class='campo2' value='".$rowsUlt['Kadfin']." a las:".$rowsUlt['Kadhin']."' onChange='marcarCambioFecLEVIC(\"$tipoProtocolo\",\"$levIdoAnt\", this );'>";
					// crearCampo("3","btnFecIniHis".$levIdoAnt,@$accionesPestana[$indicePestana.".$tipoProtocolo"."9"],array("onClick"=>"calendarioLevIC($levIdoAnt);"),"*");
					// echo "<input type='hidden' name='wfinicioori$articulo->tipoProtocolo$contArticulos' id='wfinicioori$articulo->tipoProtocolo$contArticulos' value='$articulo->fechaInicioAdministracion a las:$articulo->horaInicioAdministracion' />";
					echo "</td>";
					
					//Días de tratamiento
					echo "<td align='center' style='display:none'>";
					echo $rowsUlt[ 'Kaddia' ];
					echo "</td>";
					
					//Dosis Máxima
					echo "<td align='center'>";
					echo $rowsUlt[ 'Kaddma' ];
					echo "</td>";
					
					//Observaciones
					echo "<td align='center'>";
					echo "<div style='overflow:auto;width:270px;height:70px;background:#fff;border:1px #999 solid;font-size:9pt;text-align:left;'>".utf8_encode( $rowsUlt[ 'Kadobs' ] )."</div>";
					echo "</td>";
					// echo "<td>";
					// echo "<textarea id='txLEVObservaciones' style='width: 130px; height: 72px;'></textarea>";	//Observaciones de LEV
					// if( $editable ){
						// crearCampo("2","txLEVObservacionesHis$levIdoAnt",@$accionesPestana[$indicePestana.".$tipoProtocolo"."14"],array("cols"=>"30","rows"=>"2","onChange"=>"marcarCambioLEV( this, '$levIdoAnt');"),"");
					// } else {
						// crearCampo("2","txLEVObservacionesHis$levIdoAnt",@$accionesPestana[$indicePestana.".$tipoProtocolo"."14"],array("cols"=>"30","rows"=>"2","readonly"=>""),"");
					// }
					// echo "</td>";
					
					$difHoras = ( strtotime( date( "Y-m-d 00:00:00" ) ) - strtotime( $rowsUlt['Kadfin']." ".$rowsUlt['Kadhin'] ) )/3600;
					
					for( $i =2; $i<=24; $i+=2){
						echo "<td align='center'>".( ( $difHoras+$i>=0 && ($difHoras+$i)%$frec == 0 )? $sol." ".$uni : "" )."</td>";
					}
					
					echo "</tr>";
				}
				else{
					//Muestra la forma para infusiones
					if( $suspendido != 'on' ){
						echo "<tr class='$classInf' id='trIdoLev".$levIdoAnt."'>";
					}
					else{
						echo "<tr class='suspendido' id='trIdoLev".$levIdoAnt."'>";
					}
					
					// echo "<td align='center' style='$clase_pendientes'>";
					
					
					// $rolNoSuspenden = consultarAliasPorAplicacion( $conex, $wemp_pmla, "rolNoSuspenden" ); 
					// $rolNoSuspenden = explode( ",", $rolNoSuspenden );
					
					// $usuCreador = consultarUsuarioOrdenes( $rows[ 'Kadusu' ] );
					
					$rowsUlt[ 'Fredes' ] = "";
					$opcionesSeleccion = "<option value=''>Seleccione</option>";
					while($rowsVdi = mysql_fetch_array($resVdi) ){
						if( $rowsVdi[ 'Frecod' ] == $codigoDosisCalculada ){
							$rowsUlt[ 'Fredes' ] = $rowsVdi[ 'Fredes' ];
							$opcionesSeleccion .= "<option value='".$rowsVdi[ 'Frecod' ]."' selected>".$rowsVdi[ 'Fredes' ]."</option>";
						}
						else {
							$opcionesSeleccion .= "<option value='".$rowsVdi[ 'Frecod' ]."'>".$rowsVdi[ 'Fredes' ]."</option>";
						}
					}
					mysql_data_seek($resVdi,0);
					
					$tieneVelocidadInfusion = true;
					$opcionesDosisCalculada = $opcionesSeleccion;
					if( $rowsUlt[ 'Fredes' ] == "" ){
						
						$tieneVelocidadInfusion = false;
						//Consulto las unidades de dosis calculada
						$sql = "SELECT *
								  FROM ".$wmovhos."_000177
								 WHERE dcaest = 'on'
								";
								 
						$resDca = mysql_query( $sql, $conex ) or die( mysql_error()." - Error en el query $sql - ".mysql_errno() );
						while( $rowsDca = mysql_fetch_array( $resDca ) ){
						
							/********************************************************************************************************************************************
							 * Deja en el option los atributos de minimo y máximo cómo vMin y vMax por que ya hay propiedades de min y max en html 5
							 ********************************************************************************************************************************************/
							
							if( $rowsDca[ 'Dcacod' ] == $codigoDosisCalculada ){
								$rowsUlt[ 'Fredes' ] = $rowsDca[ 'Dcades' ];
								$title = "Ingrese un valor entre ".$rowsDca[ 'Dcamin' ]." y ".$rowsDca[ 'Dcamax' ];
								$opcionesDosisCalculada .= "<option selected value='".$rowsDca[ 'Dcacod' ]."' vMin='".$rowsDca[ 'Dcamin' ]."' vMax='".$rowsDca[ 'Dcamax' ]."'>".$rowsDca[ 'Dcades' ]."</option>";
							}
							else{
								$opcionesDosisCalculada .= "<option value='".$rowsDca[ 'Dcacod' ]."' vMin='".$rowsDca[ 'Dcamin' ]."' vMax='".$rowsDca[ 'Dcamax' ]."'>".$rowsDca[ 'Dcades' ]."</option>";
							}
						}
					}

					echo "</td>";
					
					// echo "<td onClick='mostrarIC( ".$levIdoAnt.", \"on\" )'>".trim( $nombreLev )." a <b>".$rowsUlt[ 'Fredes' ]."</b> para <b>".$frec." Horas</b></td>";
					echo "<td>".trim( $nombreLev )." a <b>".$rowsUlt[ 'Fredes' ]."</b> para <b>".$frec." Horas</b></td>";
						
					echo "<td align='center'>"; 
					
					if( $editable ){
						
						if( $tieneVelocidadInfusion ){
							crearCampo("1","inFrecDilHis".$levIdoAnt,@$accionesPestana[$indicePestana.".L1"],array("size"=>"3","class"=>"campo2 msg_tooltip","onKeyPress"=>"return validarEntradaDecimal( event );","onChange"=>"cambiarVelocidadInfusionLevInf( $levIdoAnt )"), $dosisCalculada );
							crearCampo("6","slVelDilHis".$levIdoAnt,@$accionesPestana[$indicePestana.".L1"],array("class"=>"seleccion","style"=>"width: 80px;","onChange"=>"cambiarVelocidadInfusionLevInf( $levIdoAnt )"),"$opcionesDosisCalculada");
						}
						else{
							crearCampo("1","txDosisCalculadaHis".$levIdoAnt,@$accionesPestana[$indicePestana.".L1"],array("title"=>$title,"size"=>"3","class"=>"campo2 msg_tooltip","onBlur"=>"return validarEntradaDecimalMinDca( this, $levIdoAnt );","onKeyPress"=>"return validarEntradaDecimalMaxDca( this, $levIdoAnt, event );","onChange"=>"cambiarDosisCalculada( this, $levIdoAnt )"), $dosisCalculada );
							crearCampo("6","slDosisCalculadaHis".$levIdoAnt,@$accionesPestana[$indicePestana.".L1"],array("class"=>"seleccion","style"=>"width:80px;","onChange"=>"cambiarDosisCalculada( this, $levIdoAnt )"),"$opcionesDosisCalculada");
						}
					} else {
						echo "<b>".$dosisCalculada." ".$rowsUlt[ 'Fredes' ]."</b>";
						// echo "<select id='slVelDil".$levIdoAnt."'>";
						// echo "<option value='".$rowsUlt[ 'Frecod' ]."'>".$rowsUlt[ 'Fredes' ]."</option>";
						// echo "</select>";
					}
				
					echo "</td>";
					
					//Fecha y hora de inicio
					echo "<td>";
					echo "<b>".$rowsUlt['Kadfin']." a las:".$rowsUlt['Kadhin']."</b>";
					// echo "<INPUT TYPE='text' NAME='txFecIni".$levIdoAnt."' id='txFecIni".$levIdoAnt."' SIZE=25 readonly class='campo2' value='".$rowsUlt['Kadfin']." a las:".$rowsUlt['Kadhin']."' onChange='marcarCambioFecLEVIC(\"$tipoProtocolo\",\"$levIdoAnt\",this);'>";
					// crearCampo("3","btnFecIniHis".$levIdoAnt,@$accionesPestana[$indicePestana.".$tipoProtocolo"."9"],array("onClick"=>"calendarioLevIC($levIdoAnt);"),"*");
					// echo "<input type='hidden' name='wfinicioori$articulo->tipoProtocolo$contArticulos' id='wfinicioori$articulo->tipoProtocolo$contArticulos' value='$articulo->fechaInicioAdministracion a las:$articulo->horaInicioAdministracion' />";
					echo "</td>";
					
					//Días de tratamiento
					echo "<td align='center' style='display:none'>";
					echo $rowsUlt[ 'Kaddia' ];
					echo "</td>";
					
					//Dosis máxima
					echo "<td align='center'>";
					echo $rowsUlt[ 'Kaddma' ];
					echo "</td>";
					
					//Observaciones
					echo "<td>";
					echo "<div style='overflow:auto;width:270px;height:70px;background:#fff;border:1px #999 solid;font-size:9pt;text-align:left;'>".$rowsUlt[ 'Kadobs' ]."</div>";
					echo "</td>";
					// echo "<td>";
					// echo "<textarea id='txICObservaciones' style='width: 268px; height: 72px;'></textarea>";	//Observaciones de IC
					// if( $editable ){
						// crearCampo("2","txICObservacionesHis$levIdoAnt",@$accionesPestana[$indicePestana.".$tipoProtocolo"."14"],array("cols"=>"30","rows"=>"2","onChange"=>"marcarCambioIC( this, '$levIdoAnt');"),"");
					// } else {
						// crearCampo("2","txICObservacionesHis$levIdoAnt",@$accionesPestana[$indicePestana.".$tipoProtocolo"."14"],array("cols"=>"30","rows"=>"2","readonly"=>""),"");
					// }
					// echo "</td>";
					
					//Busco la diferencia en horas entre la hora de inicio y la media noche del día actual
					$difHoras = ( strtotime( date( "Y-m-d 00:00:00" ) ) - strtotime( $rowsUlt['Kadfin']." ".$rowsUlt['Kadhin'] ) )/3600;
					
					for( $i =2; $i<=24; $i+=2){
						echo "<td align='center'>".( ( $difHoras+$i>=0 && ($difHoras+$i)%$frec == 0 )? $sol." ".$uni : "" )."</td>";
					}
					
					echo "</tr>";
				}
				
				$nombreLev = "";
				$nombreLev1 = "";
				$nombreLev2 = "";
				$sol = 0;
				$suspendido = "";
				$dosisCalculada = "";
				$codigoDosisCalculada = "";
				$clase_pendientes = "";
			}
			
			if( !$rows ){
				echo "</table>";
				echo "</div>";
			}
			$j++;
		}
		while( $rows );
		
		// echo"</div>";
	}
	
	return $val;
}



/*******************************************************************************************
 * Muestra la nueva forma de los articulos LEV
 *******************************************************************************************/
function vista_desplegarListaArticulosLEV( $conex, $wmovhos, $whce, $wemp_pmla, $colDetalle, $his, $ing, $fechaKardex, $accionesPestana,$indicePestana, $usuario, $tipoProtocolo, $editable ){

	$val = false;
	
	$clase_pendientes = "";
	
	if( $editable){
	//Busco todos los articulos de levs sobre la temporal por que en está instancia todos los articulos están en la temporal
	$sql = "SELECT * 
			  FROM ".$wmovhos."_000171 a, ".$wmovhos."_000026 b, ".$wmovhos."_000060 c, ".$wmovhos."_000059 d, ".$wmovhos."_000011 f
			 WHERE levhis = '".$his."'
			   AND leving = '".$ing."'
			   AND levhis = kadhis
			   AND leving = kading
			   AND kadfec = '".$fechaKardex."'
			   AND levins = kadart
			   AND levidi = kadido
			   AND artcod = levins
			   AND kadlev = 'on'
			   AND defart = artcod
			   AND defcco = ccocod
			   AND ccotra = 'on'
			   AND ccoima != 'on'
			   AND ccofac = 'on'
			   AND levest = 'on'
		  ORDER BY levlev, levido, levinf, levele DESC";
	}else{
	//Busco todos los articulos de levs sobre la temporal por que en está instancia todos los articulos están en la temporal
	$sql ="SELECT * 
			  FROM ".$wmovhos."_000171 a, ".$wmovhos."_000026 b, ".$wmovhos."_000054 c, ".$wmovhos."_000059 d, ".$wmovhos."_000011 f
			 WHERE levhis = '".$his."'
			   AND leving = '".$ing."'
			   AND levhis = kadhis
			   AND leving = kading
			   AND kadfec = '".$fechaKardex."'
			   AND levins = kadart
			   AND levidi = kadido
			   AND artcod = levins
			   AND kadlev = 'on'
			   AND defart = artcod
			   AND defcco = ccocod
			   AND ccotra = 'on'
			   AND ccoima != 'on'
			   AND ccofac = 'on'
			   AND levest = 'on'
		  ORDER BY levlev, levido, levinf, levele DESC";
	}
	
	$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
	$num = mysql_num_rows( $res );
	
	
	$nombreLev = "";
	$nombreLev1 = "";
	$nombreLev2 = "";
	$suspendido = "";
	$dosisCalculada = "";
	$codigoDosisCalculada = "";
	if( $num > 0 ){
	
		//Se busca la frecuencia de dilución
		$sql = "SELECT *
				  FROM ".$wmovhos."_000173 a
				 WHERE freest = 'on'
				";
					 
		$resVdi = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
		$numVdi = mysql_num_rows( $resVdi );
	
	
	
		$classLev = 'fila1';
		$classInf = 'classIC';
	
		echo "<table align='center' style='width:1500'>";
		
		echo "<tr>";
		echo "<td colspan=19>";
		
		echo "<table style='width:150'>";
		echo "<tr style='height:40'>";
		// echo "<td colspan='15'></td>";
		echo "<td align='center' class='$classLev' style='width:70;'>LEV</td>";
		echo "<td align='center' class='$classInf' style='width:70;'>IC</td>";
		echo "</tr>";
		echo "</table>";
		
		echo "</td>";
		echo "</tr>";
		
		
		echo "<tr class='encabezadotabla'>";
		echo "<td style='width:70'>Acciones</td>";
		echo "<td align='center' style='width:700'>LEV O INFUSION</td>";
		echo "<td align='center' style='width:80'>Vel. de Inf.</td>";
		echo "<td align='center' style='width:80'>Fecha y hora<br>Inicio</td>";
		echo "<td align='center' style='width:60;'>Dias tto.</td>";
		echo "<td align='center' style='width:60'>Dosis máx.</td>";
		echo "<td align='center' style='width:100' colspan=2>Observaciones</td>";
		for( $i =2; $i<=24; $i+=2){
			echo "<td align='center' style='width:50;'>".($i < 10 ? "0".$i : $i )."</td>";
		}
		echo "</tr>";
	
		$rows = mysql_fetch_array( $res );
		$j = 0;
		$sol = 0;
		do{
		
			$rows[ 'Levvto' ] = (integer) $rows[ 'Levvto' ];
			$rows[ 'Levvel' ] = (integer) $rows[ 'Levvel' ];
		
			//Busco el nombre alterno del medicamento
			$sql = "SELECT * 
					  FROM ".$wmovhos."_000098 a
					 WHERE Carcod = '".$rows[ 'Kadart' ]."'
					   AND Cartip = '".( $rows[ 'Levinf' ] == 'on' ? 'IC': 'LQ' )."'
					 ";
			
			$resNA = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
			if( $rowsNA = mysql_fetch_array( $resNA ) ){
				if( !empty( $rowsNA[ 'Carnal' ] ) && $rowsNA[ 'Carpna' ] == 'on' )
					$rows[ 'Artgen' ] = $rowsNA[ 'Carnal' ];
			}
		
		
		
			$levIdoAnt = $rows[ 'Levido' ];
			$suspendido = $rows[ 'Kadsus' ];
			$rowsUlt = $rows;
			$esLev = true;
			if( $rows[ 'Levinf' ] == 'on' ){
				$esLev = false;
			}
			
			if( permiteLecturaOrdenesPendientes( $conex, $wemp_pmla, $usuario->codigoRolHCE ) ){
				if( $rows[ 'Kadpen' ] == 'on' ){
					$clase_pendientes = 'background-color:#3CB648;';
				}
			}
			
			//Las frecuencias para un mismo LEV es igual en todos sus insumos
			$frec = consultarFrecuencia( $conex, $wmovhos, $rows[ 'Kadper' ] );	
			
			//Se muestra el volumen total de las soluciones
		
			//Para los levs se debe mostrar el nombre de los articulos de soluciones
			if( $esLev ){
				$sol += $rows[ 'Levvto' ];
				$dosisCalculada = $rows[ 'Levvfd' ];
				
				if( $rows['Levele'] != 'on' ){
					$uni = $rows[ 'Deffru' ];
					$nombreLev1 .= $rows[ 'Artgen' ]." <b>".$rows[ 'Levvto' ]." ".$rows[ 'Deffru' ]."</b><br>";
				}
				else{
					$nombreLev2 .= $rows['Artgen']." <b>".$rows[ 'Levvel' ]." ".$rows[ 'Deffru' ]."</b> en C/<b>".$rows[ 'Levvdi' ]."</b><br>";;
				}
			}
			else{
				
				if( strlen($obsIC) < strlen($rowsUlt[ 'Kadobs' ]) )
					$obsIC = $rowsUlt[ 'Kadobs' ];
			
				$sol += $rows[ 'Levvel' ];
				
				if( $rows['Levele'] == 'on' ){
					if( trim($rows[ 'Levdca' ]) != "" && trim($rows[ 'Levcdc' ]) != "" ){
						$dosisCalculada = $rows[ 'Levdca' ];
						$codigoDosisCalculada = $rows[ 'Levcdc' ];
					}
					else if( trim($rows[ 'Levfdi' ]) != "" && trim($rows[ 'Levvfd' ]) != "" ){
						$dosisCalculada = $rows[ 'Levvfd' ];
						$codigoDosisCalculada = $rows[ 'Levfdi' ];
					}
					$uni = $rowsUlt[ 'Deffru' ];
					$nombreLev = $rows[ 'Artgen' ]." <b>".$rows[ 'Levvel' ]." ".$rows[ 'Deffru' ]."</b><br>".$nombreLev;
				}
				else{
					if( trim($rows[ 'Levfdi' ]) != "" && trim($rows[ 'Levvfd' ]) != "" ){
						$dosisCalculada = $rows[ 'Levvfd' ];
						$codigoDosisCalculada = $rows[ 'Levfdi' ];
					}
					$nombreLev .= " hasta <b>".$rows[ 'Levvto' ]." ".$rows[ 'Deffru' ]."</b> de ".$rows[ 'Artgen' ]. "<br>infusi&oacute;n continua " ;
				}
			}
			
			$rows = mysql_fetch_array( $res );
			
			if( ( !$rows || $levIdoAnt != $rows[ 'Levido' ]  ) ){
			
				$j++;
				
				if( $esLev ){
			
					//Muestra la forma para levs
					if( $suspendido != 'on' ){
						echo "<tr class='$classLev' id='trIdoLev".$levIdoAnt."'>";
					}
					else{
						echo "<tr class='suspendido' id='trIdoLev".$levIdoAnt."'>";
					}
					
					echo "<td align='center' style='$clase_pendientes'>";
					
					
					$rolNoSuspenden = consultarAliasPorAplicacion( $conex, $wemp_pmla, "rolNoSuspenden" ); 
					$rolNoSuspenden = explode( ",", $rolNoSuspenden );
					
					$usuCreador = consultarUsuarioOrdenes( $rows[ 'Kadusu' ] );
					
					// if( !in_array( $usuario->codigoRolHCE, $rolNoSuspenden ) || ( in_array( $usuario->codigoRolHCE, $rolNoSuspenden ) && $articulo->codigoCreador == $usuario->codigo ) ){
					if( !in_array( $usuario->codigoRolHCE, $rolNoSuspenden ) || ( in_array( $usuario->codigoRolHCE, $rolNoSuspenden ) && in_array( $usuCreador->codigoRolHCE, $rolNoSuspenden ) ) ){
						// crearCampo("4","",@$accionesPestana[$indicePestana.".$tipoProtocolo"."3"],array("onClick"=>"suspenderArticulo($contArticulos,'$articulo->tipoProtocolo');"),"<img src='../../images/medical/root/suspender.png' border='0' width='17' height='17' />");
						crearCampo("4","",@$accionesPestana[$indicePestana.".$tipoProtocolo"."3"],array("onClick"=>"suspenderArtsLev( $levIdoAnt, true );"),"<img src='../../images/medical/root/suspender.png' border='0'  />");
					}
					
					echo "</td>";
				
					$rowsUlt[ 'Fredes' ] = "";
					$opcionesSeleccion = "<option value=''>Seleccione</option>";
					while($rowsVdi = mysql_fetch_array($resVdi) ){
						if( $rowsVdi[ 'Frecod' ] == $rowsUlt[ 'Levfdi' ]){
							$rowsUlt[ 'Fredes' ] = $rowsVdi[ 'Fredes' ];
							$opcionesSeleccion .= "<option value='".$rowsVdi[ 'Frecod' ]."' selected>".$rowsVdi[ 'Fredes' ]."</option>";
						} else {
							$opcionesSeleccion .= "<option value='".$rowsVdi[ 'Frecod' ]."'>".$rowsVdi[ 'Fredes' ]."</option>";
						}
					}
					mysql_data_seek($resVdi,0);

					if( $editable ){
						echo "<td onClick='mostrarLEV( ".$levIdoAnt." )'>".trim( $nombreLev1 )."+".trim( $nombreLev2 )." a <b>$dosisCalculada ".$rowsUlt[ 'Fredes' ]."</b></td>";
					}
					else{
						echo "<td>".trim( $nombreLev1 )."+".trim( $nombreLev2 )." a <b>$dosisCalculada ".$rowsUlt[ 'Fredes' ]."</b></td>";
						// echo "<td onClick='mostrarLEV( ".$levIdoAnt." )'>".trim( $nombreLev1 )."+".trim( $nombreLev2 )."para <b>$frec Horas</b> a <b>$dosisCalculada ".$rowsUlt[ 'Fredes' ]."</b></td>";
					}
					
					echo "<td align='center'>"; 
					
					if( $editable ){
						crearCampo("1","inFrecDil".$levIdoAnt,@$accionesPestana[$indicePestana.".L1"],array("size"=>"3","class"=>"campo2 msg_tooltip","onKeyPress"=>"return validarEntradaDecimal( event );","onChange"=>"cambiarVelocidadInfusionLevInf( $levIdoAnt )"), $dosisCalculada );
						crearCampo("6", "slVelDil".$levIdoAnt,@$accionesPestana[$indicePestana.".L1"],array("class"=>"seleccion","style"=>"height: 25px;","onChange"=>"cambiarVelocidadInfusionLevInf( $levIdoAnt )"),"$opcionesSeleccion");
					} else {
						crearCampo("1","inFrecDil".$levIdoAnt,@$accionesPestana[$indicePestana.".L1"],array("title"=>$title,"size"=>"3","class"=>"campo2 msg_tooltip","readOnly"=>""), $dosisCalculada );
						echo "<select id='slVelDil".$levIdoAnt."'>";
						echo "<option value='".$rowsUlt[ 'Levfdi' ]."'>".$rowsUlt[ 'Fredes' ]."</option>";
						echo "</select>";
					}
				
					echo "</td>";
					
					//Fecha y hora de inicio
					echo "<td>";
					if( $editable ){
						echo "<INPUT TYPE='text' NAME='txFecIni".$levIdoAnt."' id='txFecIni".$levIdoAnt."' SIZE=25 readonly class='campo2' value='".$rowsUlt['Kadfin']." a las:".$rowsUlt['Kadhin']."' onChange='marcarCambioFecLEVIC(\"$tipoProtocolo\",\"$levIdoAnt\", this );'>";
						crearCampo("3","btnFecIni".$levIdoAnt,@$accionesPestana[$indicePestana.".$tipoProtocolo"."9"],array("onClick"=>"calendarioLevIC($levIdoAnt);"),"*");
						// echo "<input type='hidden' name='wfinicioori$articulo->tipoProtocolo$contArticulos' id='wfinicioori$articulo->tipoProtocolo$contArticulos' value='$articulo->fechaInicioAdministracion a las:$articulo->horaInicioAdministracion' />";
					}
					else{
						crearCampo("1","btnFecIni".$levIdoAnt,@$accionesPestana[$indicePestana.".$tipoProtocolo"."9"],array("readOnly"=>"","class"=>"campo2 msg_tooltip"),$rowsUlt['Kadfin']." a las:".$rowsUlt['Kadhin']);
					}
					echo "</td>";
					
					//Días de tratamiento
					echo "<td align='center' id='tdDttoLEV".$levIdoAnt."'>";
					echo $rowsUlt[ 'Kaddia' ];
					echo "</td>";
					
					//Dosis Máxima
					echo "<td align='center' id='tdDmaxLEV".$levIdoAnt."'>";
					echo $rowsUlt[ 'Kaddma' ];
					echo "</td>";
					
					//Observaciones
					echo "<td align='center'>";
					echo "<div style='overflow:auto;width:270px;height:70px;background:#fff;border:1px #999 solid;font-size:9pt;text-align:left;'>".$rowsUlt[ 'Kadobs' ]."</div>";
					echo "</td>";
					echo "<td>";
					// echo "<textarea id='txLEVObservaciones' style='width: 130px; height: 72px;'></textarea>";	//Observaciones de LEV
					if( $editable ){
						crearCampo("2","txLEVObservaciones$levIdoAnt",@$accionesPestana[$indicePestana.".$tipoProtocolo"."14"],array("cols"=>"30","rows"=>"2","onChange"=>"marcarCambioLEV( this, '$levIdoAnt');"),"");
					} else {
						crearCampo("2","txLEVObservaciones$levIdoAnt",@$accionesPestana[$indicePestana.".$tipoProtocolo"."14"],array("cols"=>"30","rows"=>"2","readonly"=>""),"");
					}
					echo "</td>";
					
					$difHoras = ( strtotime( date( "Y-m-d 00:00:00" ) ) - strtotime( $rowsUlt['Kadfin']." ".$rowsUlt['Kadhin'] ) )/3600;
					
					for( $i =2; $i<=24; $i+=2){
						echo "<td align='center'>".( ( $difHoras+$i>=0 && ($difHoras+$i)%$frec == 0 )? $sol." ".$uni : "" )."</td>";
					}
					
					echo "</tr>";
				}
				else{
				
					//Muestra la forma para infusiones
					if( $suspendido != 'on' ){
						echo "<tr class='$classInf' id='trIdoLev".$levIdoAnt."'>";
					}
					else{
						echo "<tr class='suspendido' id='trIdoLev".$levIdoAnt."'>";
					}
					
					echo "<td align='center' style='$clase_pendientes'>";
					
					
					$rolNoSuspenden = consultarAliasPorAplicacion( $conex, $wemp_pmla, "rolNoSuspenden" ); 
					$rolNoSuspenden = explode( ",", $rolNoSuspenden );
					
					$usuCreador = consultarUsuarioOrdenes( $rows[ 'Kadusu' ] );
					
					// if( !in_array( $usuario->codigoRolHCE, $rolNoSuspenden ) || ( in_array( $usuario->codigoRolHCE, $rolNoSuspenden ) && $articulo->codigoCreador == $usuario->codigo ) ){
					if( !in_array( $usuario->codigoRolHCE, $rolNoSuspenden ) || ( in_array( $usuario->codigoRolHCE, $rolNoSuspenden ) && in_array( $usuCreador->codigoRolHCE, $rolNoSuspenden ) ) ){
						// crearCampo("4","",@$accionesPestana[$indicePestana.".$tipoProtocolo"."3"],array("onClick"=>"suspenderArticulo($contArticulos,'$articulo->tipoProtocolo');"),"<img src='../../images/medical/root/suspender.png' border='0' width='17' height='17' />");
						crearCampo("4","",@$accionesPestana[$indicePestana.".$tipoProtocolo"."3"],array("onClick"=>"suspenderArtsLev( $levIdoAnt, false );"),"<img src='../../images/medical/root/suspender.png' border='0' />");
					}
					
					$rowsUlt[ 'Fredes' ] = "";
					$opcionesSeleccion = "<option value=''>Seleccione</option>";
					while($rowsVdi = mysql_fetch_array($resVdi) ){
						if( $rowsVdi[ 'Frecod' ] == $codigoDosisCalculada ){
							$rowsUlt[ 'Fredes' ] = $rowsVdi[ 'Fredes' ];
							$opcionesSeleccion .= "<option value='".$rowsVdi[ 'Frecod' ]."' selected>".$rowsVdi[ 'Fredes' ]."</option>";
						}
						else {
							$opcionesSeleccion .= "<option value='".$rowsVdi[ 'Frecod' ]."'>".$rowsVdi[ 'Fredes' ]."</option>";
						}
					}
					mysql_data_seek($resVdi,0);
					
					$tieneVelocidadInfusion = true;
					$opcionesDosisCalculada = $opcionesSeleccion;
					if( $rowsUlt[ 'Fredes' ] == "" ){
						
						$tieneVelocidadInfusion = false;
						//Consulto las unidades de dosis calculada
						$sql = "SELECT *
								  FROM ".$wmovhos."_000177
								 WHERE dcaest = 'on'
								";
								 
						$resDca = mysql_query( $sql, $conex ) or die( mysql_error()." - Error en el query $sql - ".mysql_errno() );
						while( $rowsDca = mysql_fetch_array( $resDca ) ){
						
							/********************************************************************************************************************************************
							 * Deja en el option los atributos de minimo y máximo cómo vMin y vMax por que ya hay propiedades de min y max en html 5
							 ********************************************************************************************************************************************/
							
							if( $rowsDca[ 'Dcacod' ] == $codigoDosisCalculada ){
								$rowsUlt[ 'Fredes' ] = $dosisCalculada." ".$rowsDca[ 'Dcades' ];
								$title = "Ingrese un valor entre ".$rowsDca[ 'Dcamin' ]." y ".$rowsDca[ 'Dcamax' ];
								$opcionesDosisCalculada .= "<option selected value='".$rowsDca[ 'Dcacod' ]."' vMin='".$rowsDca[ 'Dcamin' ]."' vMax='".$rowsDca[ 'Dcamax' ]."'>".$rowsDca[ 'Dcades' ]."</option>";
							}
							else{
								$opcionesDosisCalculada .= "<option value='".$rowsDca[ 'Dcacod' ]."' vMin='".$rowsDca[ 'Dcamin' ]."' vMax='".$rowsDca[ 'Dcamax' ]."'>".$rowsDca[ 'Dcades' ]."</option>";
							}
						}
					}

					echo "</td>";
					
					if( $editable ){
						echo "<td onClick='mostrarIC( ".$levIdoAnt." )'>".trim( $nombreLev )." a <b>".$rowsUlt[ 'Fredes' ]."</b>";// para <b>".$frec." Horas</b></td>";
					}
					else{
						echo "<td>".trim( $nombreLev )." a <b>".$rowsUlt[ 'Fredes' ]."</b>";// para <b>".$frec." Horas</b></td>";
					}
						
					echo "<td align='center'>"; 
					
					if( $editable ){
						
						if( $tieneVelocidadInfusion ){
							crearCampo("1","inFrecDil".$levIdoAnt,@$accionesPestana[$indicePestana.".L1"],array("size"=>"3","class"=>"campo2 msg_tooltip","onKeyPress"=>"return validarEntradaDecimal( event );","onChange"=>"cambiarVelocidadInfusionLevInf( $levIdoAnt )"), $dosisCalculada );
							crearCampo("6","slVelDil".$levIdoAnt,@$accionesPestana[$indicePestana.".L1"],array("class"=>"seleccion","style"=>"width: 80px;","onChange"=>"cambiarVelocidadInfusionLevInf( $levIdoAnt )"),"$opcionesDosisCalculada");
						}
						else{
							crearCampo("1","txDosisCalculada".$levIdoAnt,@$accionesPestana[$indicePestana.".L1"],array("title"=>$title,"size"=>"3","class"=>"campo2 msg_tooltip","onBlur"=>"return validarEntradaDecimalMinDca( this, $levIdoAnt );","onKeyPress"=>"return validarEntradaDecimalMaxDca( this, $levIdoAnt, event );","onChange"=>"cambiarDosisCalculada( this, $levIdoAnt )"), $dosisCalculada );
							crearCampo("6","slDosisCalculada".$levIdoAnt,@$accionesPestana[$indicePestana.".L1"],array("class"=>"seleccion","style"=>"width:80px;","onChange"=>"cambiarDosisCalculada( this, $levIdoAnt )"),"$opcionesDosisCalculada");
						}
					} else {
					
						if( $tieneVelocidadInfusion ){
							crearCampo("1","txDosisCalculada".$levIdoAnt,@$accionesPestana[$indicePestana.".L1"],array("readOnly"=>"","size"=>"3","class"=>"campo2 msg_tooltip"), $dosisCalculada );
						}
						else{
							crearCampo("1","txDosisCalculada".$levIdoAnt,@$accionesPestana[$indicePestana.".L1"],array("readOnly"=>"","size"=>"3","class"=>"campo2 msg_tooltip"), $dosisCalculada );
						}
					
						// echo $dosisCalculada." ".$rowsUlt[ 'Fredes' ];
						echo "<select id='slVelDil".$levIdoAnt."'>";
						echo "<option value='".$rowsUlt[ 'Frecod' ]."'>".$rowsUlt[ 'Fredes' ]."</option>";
						echo "</select>";
					}
				
					echo "</td>";
					
					//Fecha y hora de inicio
					echo "<td>";
					if( $editable ){
						echo "<INPUT TYPE='text' NAME='txFecIni".$levIdoAnt."' id='txFecIni".$levIdoAnt."' SIZE=25 readonly class='campo2' value='".$rowsUlt['Kadfin']." a las:".$rowsUlt['Kadhin']."' onChange='marcarCambioFecLEVIC(\"$tipoProtocolo\",\"$levIdoAnt\",this);'>";
						crearCampo("3","btnFecIni".$levIdoAnt,@$accionesPestana[$indicePestana.".$tipoProtocolo"."9"],array("onClick"=>"calendarioLevIC($levIdoAnt);"),"*");
						// echo "<input type='hidden' name='wfinicioori$articulo->tipoProtocolo$contArticulos' id='wfinicioori$articulo->tipoProtocolo$contArticulos' value='$articulo->fechaInicioAdministracion a las:$articulo->horaInicioAdministracion' />";
					}
					else{
						//echo $rowsUlt['Kadfin']." a las:".$rowsUlt['Kadhin'];
						crearCampo("1","btnFecIni".$levIdoAnt,@$accionesPestana[$indicePestana.".$tipoProtocolo"."9"],array("readOnly"=>"","class"=>"campo2 msg_tooltip"),$rowsUlt['Kadfin']." a las:".$rowsUlt['Kadhin']);
					}
					echo "</td>";
					
					//Días de tratamiento
					echo "<td align='center' id='tdDttoIC".$levIdoAnt."'>";
					echo $rowsUlt[ 'Kaddia' ];
					echo "</td>";
					
					//Dosis máxima
					echo "<td align='center' id='tdDmaxIC".$levIdoAnt."'>";
					echo $rowsUlt[ 'Kaddma' ];
					echo "</td>";
					
					//Observaciones
					echo "<td>";
					// echo "<div style='overflow:auto;width:270px;height:70px;background:#fff;border:1px #999 solid;font-size:9pt;text-align:left;'>".$rowsUlt[ 'Kadobs' ]."</div>";
					echo "<div style='overflow:auto;width:270px;height:70px;background:#fff;border:1px #999 solid;font-size:9pt;text-align:left;'>".$obsIC."</div>";
					echo "</td>";
					echo "<td>";
					
					$arrayObsIC[ $rowsUlt['Levido'] ] = $obsIC;
					
					$obsIC = "";
					
					// echo "<textarea id='txICObservaciones' style='width: 268px; height: 72px;'></textarea>";	//Observaciones de IC
					if( $editable ){
						crearCampo("2","txICObservaciones$levIdoAnt",@$accionesPestana[$indicePestana.".$tipoProtocolo"."14"],array("cols"=>"30","rows"=>"2","onChange"=>"marcarCambioIC( this, '$levIdoAnt');"),"");
					} else {
						crearCampo("2","txICObservaciones$levIdoAnt",@$accionesPestana[$indicePestana.".$tipoProtocolo"."14"],array("cols"=>"30","rows"=>"2","readonly"=>""),"");
					}
					echo "</td>";
					
					
					$difHoras = ( strtotime( date( "Y-m-d 00:00:00" ) ) - strtotime( $rowsUlt['Kadfin']." ".$rowsUlt['Kadhin'] ) )/3600;
					
					for( $i =2; $i<=24; $i+=2){
						echo "<td align='center'>".( ( $difHoras+$i>=0 && ($difHoras+$i)%$frec == 0 )? $sol." ".$uni : "" )."</td>";
					}
					
					echo "</tr>";
				}
				
				$nombreLev = "";
				$nombreLev1 = "";
				$nombreLev2 = "";
				$sol = 0;
				$suspendido = "";
				$dosisCalculada = "";
				$codigoDosisCalculada = "";
				$clase_pendientes = "";
			}
		}
		while( $rows );
		
		echo "</table>";
				
		/****************************************************************************************************
		 * Creo el objeto JSON para javascript, se requiere esto para la grabación y modificación
		 * En el ready hay que volver a recorrer este objeto para colocar los valores faltantes
		 * Faltarían el protocolo y código correpondiente de cada uno de los LEV
		 **************************************************************************************************/
		mysql_data_seek( $res, 0 );
		
		while( $rows = mysql_fetch_array( $res ) ){
		
			$obJSON[ "L". $rows[ 'Levidi' ] ][ 'codLev' ] = '';
			$obJSON[ "L". $rows[ 'Levidi' ] ][ 'idoLev' ] = $rows[ 'Levido' ];
			$obJSON[ "L". $rows[ 'Levidi' ] ][ 'insCod' ] = $rows[ 'Levins' ];
			$obJSON[ "L". $rows[ 'Levidi' ] ][ 'insIdi' ] = $rows[ 'Levidi' ];
			$obJSON[ "L". $rows[ 'Levidi' ] ][ 'insEle' ] = $rows[ 'Levele' ];
			$obJSON[ "L". $rows[ 'Levidi' ] ][ 'insVel' ] = $rows[ 'Levvel' ];
			$obJSON[ "L". $rows[ 'Levidi' ] ][ 'insVdi' ] = $rows[ 'Levvdi' ];
			$obJSON[ "L". $rows[ 'Levidi' ] ][ 'insVto' ] = $rows[ 'Levvto' ];
			$obJSON[ "L". $rows[ 'Levidi' ] ][ 'insFdi' ] = $rows[ 'Levfdi' ];
			$obJSON[ "L". $rows[ 'Levidi' ] ][ 'insVfd' ] = $rows[ 'Levvfd' ];
			$obJSON[ "L". $rows[ 'Levidi' ] ][ 'insInf' ] = $rows[ 'Levinf' ];
			$obJSON[ "L". $rows[ 'Levidi' ] ][ 'insFre' ] = $rows[ 'Kadper' ];	//Todos los levs e infusiones tienen la misma frecuencia
			$obJSON[ "L". $rows[ 'Levidi' ] ][ 'insFin' ] = $rows[ 'Kadfin' ];	//Todos los levs e infusiones tienen la misma fecha de inicio
			$obJSON[ "L". $rows[ 'Levidi' ] ][ 'insHin' ] = $rows[ 'Kadhin' ];	//Todos los levs e infusiones tienen la misma hora de inicio
			$obJSON[ "L". $rows[ 'Levidi' ] ][ 'insDca' ] = $rows[ 'Levdca' ];	//Todos los levs e infusiones tienen la misma hora de inicio
			$obJSON[ "L". $rows[ 'Levidi' ] ][ 'insCdc' ] = $rows[ 'Levcdc' ];	//Todos los levs e infusiones tienen la misma hora de inicio
			$obJSON[ "L". $rows[ 'Levidi' ] ][ 'insObs' ] = ( $rows[ 'Levinf' ] ) != 'on' ? utf8_encode( $rows[ 'Kadobs' ] ) : utf8_encode( $arrayObsIC[ $rows['Levido'] ] );	//Todos los levs e infusiones tienen la misma hora de inicio
			$obJSON[ "L". $rows[ 'Levidi' ] ][ 'insEst' ] = 'gra';				//Por defecto grabado( gra )
		}
		/****************************************************************************************************/
		
		echo "<script>"; 
		echo "artLevsCopia = ".json_encode( $obJSON ).";";
		echo "</script>";
	}
	
	return $val;
}

/************************************************************************************************************
 * Registra un insumo para un medicamento LEV
 ************************************************************************************************************/
function registrarLiquidosEndovenosos( $conex, $wbasedato, $his, $ing, $codlev, $idolev, $codIns, $idoIns, $esEle, $volEle, $volDil, $fecSol, $volTot, $codFdi, $valFdi, $inf, $insDca, $insCdc, $sinSol ){
	
	global $usuario;
	
	$val = true;
	
	$fecha = date( "Y-m-d" );
	$hora = date( "H:i:s" );
	
	$sql = "INSERT INTO ".$wbasedato."_000171(      Medico     , Fecha_data  , Hora_data  ,  Levhis   ,  Leving   ,   Levlev     ,    Levido    ,    Levins    ,     Levidi   ,     Levele  ,   Levvel     ,    Levvdi    ,    Levvto     , Levest,    Levfdi      , Levvfd       , Levinf    ,    Levdca    ,   Levcdc     ,    Seguridad      )
									   VALUES( '".$wbasedato."', '".$fecha."', '".$hora."', '".$his."', '".$ing."', '".$codlev."', '".$idolev."', '".$codIns."', '".$idoIns."', '".$esEle."', '".$volEle."', '".$volDil."', '". $volTot."',  'on' , '".$codFdi."'  , '".$valFdi."', '".$inf."', '".$insDca."', '".$insCdc."','C-".$wbasedato."' )";
			   
	$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
	
	if( mysql_affected_rows() == 0 ){
		registrarAuditoriaCierreKardex( $his, $ing, $usuario->codigo, "*Insumo LEV no INSERTADO*No insertado*".$sql );
		$val = false;
	}
	
	//Si está sin solución y es IC lo agrego al articulo LEv correspondiente de la auditoria
	if( $inf == 'on' && $sinSol == 'on' ){
		
		$sql = "UPDATE ".$wbasedato."_000055
				   SET kaudes = CONCAT( kaudes,',Sin dilución' )
				 WHERE kauhis = '".$his."'
				   AND kauing = '".$ing."'
				   AND kaumen = 'Articulo creado'
				   AND kauido = '".$idolev."'
				   AND kaufec = '".$fecha."'
				   AND kaudes LIKE '%".$codlev."%'
				";
			   
		$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
	}
	
	return $val;
}

/************************************************************************************************************
 * Pinta un formulario oculto para hacer los lev, este se usa para ordenar un medicamento INF o modificar
 * un medicamento INF
 ************************************************************************************************************/
function pintarModalIC( $conex, $wbasedato, $wcenmez, $whce, $tipoGenerico, $ccoPaciente ){

	//Si tiene componentes asociados en la tabla de componentes por tipo, mostrará los tipos
	$qComp = "SELECT Cartip,Carcod,Carcco,Cardis, Artcom, Carnal as Artgen, Deffra, Deffru, Carele, Artgen as ngen, Carpna
				FROM {$wbasedato}_000098, {$wbasedato}_000026, {$wbasedato}_000059 
			   WHERE Cartip = '{$tipoGenerico}' 
				 AND Carcod = artcod
				 AND Artest = 'on'
				 AND Carest = 'on'
				 AND Artcod = Defart
				 AND Defcco = Carcco
				 AND Defest = 'on'
			   UNION
			  SELECT Cartip,Carcod,Carcco,Cardis, Artcom, Carnal as Artgen, Deffra, Deffru, Carele, Artgen as ngen, Carpna
				FROM {$wbasedato}_000098, {$wcenmez}_000002, {$wcenmez}_000001, {$wbasedato}_000059 
			   WHERE Cartip = '{$tipoGenerico}' 
				 AND Carcod = artcod
				 AND Artest = 'on'
				 AND Carest = 'on'
				 AND arttip = tipcod
				 AND tipcdo != 'on'
				 AND Artcod = Defart
				 AND Defcco = Carcco
				 AND Defest = 'on'
			ORDER BY artgen
			";
				 
	$resComp = mysql_query($qComp, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qComp . " - " . mysql_error());
	$numrows = mysql_num_rows( $resComp );

	//Se dejan todos los campos en una fila 1 - 10 sería
	//i indica las filas leidas
	//j indica el indice de los electrolitos
	//k indica el indice de las soluciones
	$componentes = array();
	for( $i = 0, $j = 0, $k = 0; $infoComp = mysql_fetch_array($resComp); $i++ )
	{
		$infoComp['Cardis'] = $pacEnUrgencias ? 'on': 'iff';
		
		if( empty( $infoComp[ 'Artgen' ] ) || $infoComp[ 'Carpna' ] != 'on' )
			$infoComp[ 'Artgen' ] = trim( $infoComp[ 'ngen' ] );
	
		$indice = '';
		if( $infoComp[ 'Carele' ] == 'on' ){
			$indice = 'ele';
			$pos = $j;
			$j++;
			
		}
		else{
			$indice = 'sol';
			$pos = $k;
			$k++;
		}
		
		$componentes[ $indice ][ $pos ] = $infoComp;
	}
	
	$num = max( $k, $j );
	for( $i = 0, $j = 3000; $i < $num; $i++ )
	{
		if( $i == 0 ){
			echo "<div style='display:none;' id='listaComponentesIC'>";
			echo "<br>";
			echo "<table border='0'  align='center'>";
			echo "<tr class='encabezadotabla' align=center><td colspan=11>INFUSION CONTINUA</td></tr>";
			
			echo "<tr class='encabezadoTabla' align=center>";
			echo "<td colspan=2 style='background-color:#3CB648;'>Medicamento</td>";
			echo "<td style='background-color:#3CB648;' colspan=2>Dosis</td>";
			echo "<td style='width:40px;background-color:#3CB648;display:none;'></td>";
			echo "<td style='background-color:#3CB648;display:none;'>Vol/Dil</td>";
			echo "<td style='background-color:#3CB648;display:none;'>Frecuencia</td>";
			echo "<td style='background-color:#3CB648;' colspan=2>Dosis calculada</td>";
			echo "<td colspan=2 class='articuloControl'>Soluciones*</td>";
			echo "<td class='articuloControl' style='display:none'>Frecunecia*</td>";
			echo "<td class='articuloControl' colspan=2>Vol/total*</td>";
			echo "</tr>";
		}
		
		
		$class = "class='fila".( $i%2 ? 1 : 2 )."'";
		
		echo "<tr ".$class.">";

		if( !empty( $componentes[ 'ele' ][$i] ) ){
			
			//checkbox
			echo "<td id='tdCbEle".$j."' ele".$componentes[ 'ele' ][$i]['Carcod']."='".$j."' >";	//Dejo el codigo cómo atributo para poder buscar el indice en el javascript cuando se requiera
			echo "<INPUT type='checkbox' name='check_insumo".$j."' id='check_insumo".$j."' value=''  onChange=\"adicionarComponenteArticuloIC('".$componentes[ 'ele' ][$i]['Carcod']."','".$componentes[ 'ele' ][$i]['Artgen']."','".$j."','".$componentes[ 'ele' ][$i]['Cardis']."','".$componentes[ 'ele' ][$i]['Deffra']."',this,true)\">";
			echo "</td>";
			
			//Nombre del electrolito
			echo "<td tdEleGen".$j.">";
			echo $componentes[ 'ele' ][$i][ 'Artgen' ];
			echo "</td>";
			
			//Vol del electrolito
			echo "<td>";
			echo "<INPUT type='text' name='cantidad_insumo".$j."' id='cantidad_insumo".$j."' value='' style='width:50px' onChange=\"adicionarComponenteArticuloIC('".$componentes[ 'ele' ][$i]['Carcod']."','".$componentes[ 'ele' ][$i]['Artgen']."','".$j."','".$componentes[ 'ele' ][$i]['Cardis']."','".$componentes[ 'ele' ][$i]['Deffra']."',this,true)\" onkeypress='return validarEntradaDecimal(event);'>";
			echo "</td>";
			
			echo "<td tdEleUVol".$j.">";
			echo $componentes[ 'ele' ][$i]['Deffru'];
			echo "</td>";
			
			//Texto fijo
			echo "<td style='display:none'>en C/</td>";
			
			//Vol deliluyente
			echo "<td style='display:none'>";
			echo "<INPUT type='text' name='volxdil".$j."' id='volxdil".$j."' value='' style='width:50px' onChange=\"adicionarComponenteArticuloIC('".$componentes[ 'ele' ][$i]['Carcod']."','".$componentes[ 'ele' ][$i]['Artgen']."','".$j."','".$componentes[ 'ele' ][$i]['Cardis']."','".$componentes[ 'ele' ][$i]['Deffra']."',this,true)\" onkeypress='return validarEntradaDecimal(event);'>";
			echo "</td>";
			
			//Frecuencia
			echo "<td style='display:none;'>";
			echo "<select name='frecsol".$j."' id='frecsol".$j."' onChange=\"adicionarComponenteArticuloIC('".$componentes[ 'ele' ][$i]['Carcod']."','".$componentes[ 'ele' ][$i]['Artgen']."','".$j."','".$componentes[ 'ele' ][$i]['Cardis']."','".$componentes[ 'ele' ][$i]['Deffra']."',this,true)\">";
			echo "<option value='' selected>Seleccione...</option>";
			$colPeriodicidades = consultarPeriodicidades();
			foreach ($colPeriodicidades as $periodicidad){
				echo "<option value='".$periodicidad->codigo."'>$periodicidad->descripcion</option>";
			}
			echo "</select>";
			
			//Dosis calculada
			echo "<td><input class='msg_tooltip' title='Ingrese un valor' type='text' id='inICDca".$j."' style='width:50;' onkeypress='return validarEntradaDecimal(event);' onChange='verificarVelocidadInfusion();'></td>";
			
			//Consulto las unidades de dosis calculada
			$sql = "SELECT *
					  FROM {$wbasedato}_000177
					 WHERE dcaest = 'on'";
					 
			$resDca = mysql_query( $sql, $conex ) or die( mysql_error()." - Error en el query $sql - ".mysql_errno() );
			
			echo "<td>";
			
			echo "<select id='slICUdca".$j."' onChange='cambiarDosisCalculadaModalIC( this, $j )'>";
			echo "<option></option>";
			while( $rowsDca = mysql_fetch_array( $resDca ) ){
				echo "<option value='".$rowsDca[ 'Dcacod' ]."' vMin='".$rowsDca[ 'Dcamin' ]."' vMax='".$rowsDca[ 'Dcamax' ]."'>".$rowsDca['Dcades']."</option>";
			}
			echo "</select>";
			echo "</td>";
			
			$j++;
		}
		else{
			
			//checkbox
			echo "<td></td>";
			echo "<td></td>";
			echo "<td colspan=2></td>";
			echo "<td style='display:none;'></td>";
			echo "<td style='display:none;'></td>";
			echo "<td style='display:none;'></td>";
			echo "<td></td>";
			echo "<td></td>";
		}
		
		if( !empty( $componentes[ 'sol' ][$i] ) ){
				
			//checkbox
			echo "<td id='tdCbSol".$j."' sol".$componentes[ 'sol' ][$i]['Carcod']."='".$j."'>";
			echo "<INPUT type='checkbox' name='check_insumo' id='check_insumo".$j."' value='' onChange=\"adicionarComponenteArticuloIC('".$componentes[ 'sol' ][$i]['Carcod']."','".$componentes[ 'sol' ][$i]['Artgen']."','".$j."','".$componentes[ 'sol' ][$i]['Cardis']."','".$componentes[ 'sol' ][$i]['Deffra']."',this,false)\">";
			echo "</td>";
			
			//Nombre de la solución
			echo "<td tdSolGen".$j.">";
			echo $componentes[ 'sol' ][$i][ 'Artgen' ];
			echo "</td>";
			
			//Frecuencia
			echo "<td style='display:none'>";
			echo "<select name='frecsol".$j."' id='frecsol".$j."' onChange=\"adicionarComponenteArticuloIC('".$componentes[ 'sol' ][$i]['Carcod']."','".$componentes[ 'sol' ][$i]['Artgen']."','".$j."','".$componentes[ 'sol' ][$i]['Cardis']."','".$componentes[ 'sol' ][$i]['Deffra']."',this,false)\">";
			echo "<option value='' selected>Seleccione...</option>";
			$colPeriodicidades = consultarPeriodicidades();
			foreach ($colPeriodicidades as $periodicidad){
				echo "<option value='".$periodicidad->codigo."'>$periodicidad->descripcion</option>";
				
				$jsobjPerValor .= ",$periodicidad->codigo : $periodicidad->equivalencia ";
			}
			echo "</select>";
			
			//Creo el obejto javascript para el manejo de dosis maxima por defecto
			if( !empty($jsobjPerValor) ){
				echo "<script>var valFrecuencia = { ".substr( $jsobjPerValor, 1 )." }</script>";
			}
			
			// echo "<INPUT type='text' name='check_insumo$i' id='check_insumo$i' value='' style='width:50px'>";
			echo "</td>";
			
			
			//Volumen Total
			echo "<td>";
			echo "<INPUT type='text' name='cantidad_insumo".$j."' id='cantidad_insumo".$j."' value='' style='width:100px' onChange=\"adicionarComponenteArticuloIC('".$componentes[ 'sol' ][$i]['Carcod']."','".$componentes[ 'sol' ][$i]['Artgen']."','".$j."','".$componentes[ 'sol' ][$i]['Cardis']."','".$componentes[ 'sol' ][$i]['Deffra']."',this,false)\" onkeypress='return validarEntradaDecimal(event);'>";
			echo "</td>";
			
			echo "<td tdSolUVol".$j.">";
			echo $componentes[ 'sol' ][$i][ 'Deffru' ];
			echo "</td>";
			
			$j++;
		}
		else{
			//checkbox
			echo "<td></td>";
			echo "<td></td>";
			echo "<td></td>";
			echo "<td></td>";
			// echo "<td></td>";
			// echo "<td colspan=2></td>";
		}
		
		echo "</tr>";
		
		if( $i == $num-1 ){
		
			/****************************************************************
			 * Se muestra la frecuencia de dilución
			 ****************************************************************/
			//Se busca la frecuencia de dilución
			$sql = "SELECT *
					  FROM {$wbasedato}_000173 a
					 WHERE freest = 'on'
					";
						 
			$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
			$numFdi = mysql_num_rows( $res );
			
			echo "<tr>";
			echo "<td colspan='10' align='center'>";
			
			echo "<table style='width:100%'>"; 
			echo "<tr style='background-color:#3CB648;'>";
			echo "<td colspan='1' align='right'><b>* Velocidad de infusi&oacute;n</b></td>";
			echo "<td>";
			echo "<INPUT type='text' id='txFrecDilLev' style='width:100;' onchange='borrarDatosDosisCalculada( this );'>";
			echo "<select id='slFrecDilLev' onchange='borrarDatosDosisCalculada( this );'>";
			if( $numFdi > 1 ){
				echo "<option value=''>Seleccione...</option>";
				while( $rowsFre = mysql_fetch_array( $res ) ){
					echo "<option value='".$rowsFre[ 'Frecod' ]."'>".$rowsFre[ 'Fredes' ]."</option>";
				}
			}
			else{
				$rowsFre = mysql_fetch_array( $res );
				echo "<option selected value='".$rowsFre[ 'Frecod' ]."'>".$rowsFre[ 'Fredes' ]."</option>";
			}
			echo "</select>";
			echo "</td>";
			echo "<td class='articuloControl' style='width:200'>"; 
			echo "<INPUT type='checkbox' name='ckSinSolucion' id='ckSinSolucion' onClick='deshabilitarSolucionesIC( this );'>";
			echo " <b>Por protocolo</b>";
			echo "</td>";
			echo "<td>";
			echo "<b>D. tto:</b> <input type='text' name='inDttoIC' id='inDttoIC' style='width:70px' onKeyUp='inhabilitarDosisMaximaModalIC(this);' onkeypress='return validarEntradaEntera(event);'>";
			echo "</td>";
			echo "<td>";
			echo "<b>D. máx:</b> <input type='text' name='inDmaxIC' id='inDmaxIC' style='width:70px' onKeyUp='inhabilitarDiasTratamientoModalIC(this);' onkeypress='return validarEntradaEntera(event);'>";
			echo "</td>";
			echo "</tr>";
			echo "</table>";
			
			echo "</td>";
			echo "</tr>";
			/****************************************************************/
			
			//Observaciones
			echo "<tr class='encabezadoTabla'>";
			echo "<td align='center' colspan=10>OBSERVACIONES</td>";
			echo "</tr>";
			echo "<tr class='fila1'>";
			echo "<td colspan='10'>";
			echo "<textarea id='txObservacionesIC' style='width:100%;height:90'></textarea>";
			echo "</td>";
			echo "</tr>";
			echo "<tr class='fila1' trMod>";	//Para mostrar en modo de consulta
			echo "<td colspan='10'>";
			echo "<div id='dvObservacionesIC' style='overflow:auto;width:100%;height:70px;background:#fff;border:1px #999 solid;font-size:9pt;text-align:left;'></div>";
			echo "</td>";
			echo "</tr>";
			
			// echo "<tr><td>&nbsp;</td></tr>";
		
			echo "<tr align=center id='trModificar' class='encabezadoTabla'>";	//Esta es para cuando se va a actualizar un articulo
			echo "<td colspan='10'>"; 
			echo "Inicia el <b id='bICFin'></b> a las <b id='bICHin'></b><b id='bICFre' style='display:none;'></b>";
			echo "</td>";
			echo "</tr>";
			
			echo "<tr align=center id='trNuevo' trNew>";		//Esta se muestra solo cuando se crea un LEV nuevo
			echo "<td colspan='10'>"; 
			echo "<br><INPUT type='button' value='Grabar' onClick='cerrarModalArticulos( \"IC\" );' style='width:100;'>";
			echo "<INPUT type='button' value='Cancelar' onClick=cancerlarModalArticulosLEVIC(); style='width:100;'>";
			echo "</td>";
			echo "</tr>";
			
			echo "<tr trMod>";
			echo "<td align='center' colspan=10>";
			echo "<INPUT type='button' id='btGrabarModIC' style='width:100' value='Grabar' onClick='modificarCambiosIC();'>";
			echo "<INPUT type='button' style='width:100' value='Cerrar' onClick=$.unblockUI();>";
			echo "<INPUT type='hidden' id='idoMostrado'>";
			echo "</td>";
			echo "</tr>";
			
			
			
			echo "</table>";
			echo "</div>";
		}
	}
}

/************************************************************************************************************
 * Pinta un formulario oculto para hacer los lev, este se usa para ordenar un medicamento LEV o modificar
 * un medicamento LEV
 ************************************************************************************************************/
function pintarModalLEVS( $conex, $wbasedato, $wcenmez, $whce, $tipoGenerico, $pacEnUrgencias ){

	//Si tiene componentes asociados en la tabla de componentes por tipo, mostrará los tipos
	$qComp = "SELECT Cartip,Carcod,Carcco,Cardis, Artcom, Carnal as Artgen, Deffra, Deffru, Carele, Artgen as ngen, Carpna
				FROM {$wbasedato}_000098, {$wbasedato}_000026, {$wbasedato}_000059 
			   WHERE Cartip = '{$tipoGenerico}' 
				 AND Carcod = artcod
				 AND Artest = 'on'
				 AND Carest = 'on'
				 AND Artcod = Defart
				 AND Defcco = Carcco
				 AND Defest = 'on'
			   UNION
			  SELECT Cartip,Carcod,Carcco,Cardis, Artcom, Artgen, Deffra, Deffru, Carele, Artgen as ngen, Carpna
				FROM {$wbasedato}_000098, {$wcenmez}_000002, {$wcenmez}_000001, {$wbasedato}_000059 
			   WHERE Cartip = '{$tipoGenerico}' 
				 AND Carcod = artcod
				 AND Artest = 'on'
				 AND Carest = 'on'
				 AND arttip = tipcod
				 AND tipcod != 'on'
				 AND Artcod = Defart
				 AND Defcco = Carcco
				 AND Defest = 'on'
			ORDER BY artgen
			";
				 
	$resComp = mysql_query($qComp, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qComp . " - " . mysql_error());
	$numrows = mysql_num_rows( $resComp );

	//Se dejan todos los campos en una fila 1 - 10 sería
	//i indica las filas leidas
	//j indica el indice de los electrolitos
	//k indica el indice de las soluciones
	$componentes = array();
	for( $i = 0, $j = 0, $k = 0; $infoComp = mysql_fetch_array($resComp); $i++ )
	{
		//Si el paciente es de urgencias nunca es de stock
		$infoComp['Cardis'] = $pacEnUrgencias ? 'on': 'iff';
		
		if( empty( $infoComp[ 'Artgen' ] )  || $infoComp[ 'Carpna' ] != 'on' )
			$infoComp[ 'Artgen' ] = trim( $infoComp[ 'ngen' ] );
	
		$indice = '';
		if( $infoComp[ 'Carele' ] == 'on' ){
			$indice = 'ele';
			$pos = $j;
			$j++;
			
		}
		else{
			$indice = 'sol';
			$pos = $k;
			$k++;
		}
		
		$componentes[ $indice ][ $pos ] = $infoComp;
	}
	
	$num = max( $k, $j );
	for( $i = 0, $j = 1000; $i < $num; $i++ )
	{
		if( $i == 0 ){
			echo "<div style='display:none;' id='listaComponentesLEV'>";
			echo "<br>";
			echo "<table border='0' align='center'>";
			echo "<tr class='encabezadotabla' align=center><td colspan=11>LIQUIDO ENDOVENOSO</td></tr>";
			
			echo "<tr class='encabezadoTabla' align=center>";
			echo "<td colspan=2 style='background-color:#3CB648;'>Electrolitos</td>";
			echo "<td style='background-color:#3CB648;' colspan=2>Vol</td>";
			echo "<td style='width:40px;background-color:#3CB648;'></td>";
			echo "<td style='background-color:#3CB648;' class='msg_tooltip' title='Volumen de diluci&oacute;n'>Vol/Dil</td>";
			echo "<td style='background-color:#3CB648;display:none;'>Frecuencia</td>";
			echo "<td colspan=2 class='articuloControl'>Soluciones*</td>";
			echo "<td class='articuloControl' style='display:none'>Frecunecia*</td>";
			echo "<td class='articuloControl' colspan=2>Vol/total*</td>";
			echo "</tr>";
		}
		
		
		$class = "class='fila".( $i%2 ? 1 : 2 )."'";
		
		echo "<tr ".$class.">";

		if( !empty( $componentes[ 'ele' ][$i] ) ){
			
			//checkbox
			echo "<td id='tdCbEle".$j."' ele".$componentes[ 'ele' ][$i]['Carcod']."='".$j."' >";	//Dejo el codigo cómo atributo para poder buscar el indice en el javascript cuando se requiera
			echo "<INPUT type='checkbox' name='check_insumo".$j."' id='check_insumo".$j."' value=''  onChange=\"adicionarComponenteArticuloLEV('".$componentes[ 'ele' ][$i]['Carcod']."','".$componentes[ 'ele' ][$i]['Artgen']."','".$j."','".$componentes[ 'ele' ][$i]['Cardis']."','".$componentes[ 'ele' ][$i]['Deffra']."',this)\">";
			echo "</td>";
			
			//Nombre del electrolito
			echo "<td tdEleGen".$j.">";
			echo $componentes[ 'ele' ][$i][ 'Artgen' ];
			echo "</td>";
			
			//Vol del electrolito
			echo "<td>";
			echo "<INPUT type='text' name='cantidad_insumo".$j."' id='cantidad_insumo".$j."' value='' style='width:50px' onChange=\"adicionarComponenteArticuloLEV('".$componentes[ 'ele' ][$i]['Carcod']."','".$componentes[ 'ele' ][$i]['Artgen']."','".$j."','".$componentes[ 'ele' ][$i]['Cardis']."','".$componentes[ 'ele' ][$i]['Deffra']."',this)\" onkeypress='return validarEntradaDecimal(event);'>";
			echo "</td>";
			
			echo "<td tdEleUVol".$j.">";
			echo $componentes[ 'ele' ][$i]['Deffru'];
			echo "</td>";
			
			//Texto fijo
			echo "<td>en C/</td>";
			
			//Vol deliluyente
			echo "<td>";
			echo "<INPUT type='text' name='volxdil".$j."' id='volxdil".$j."' value='' style='width:50px' onChange=\"adicionarComponenteArticuloLEV('".$componentes[ 'ele' ][$i]['Carcod']."','".$componentes[ 'ele' ][$i]['Artgen']."','".$j."','".$componentes[ 'ele' ][$i]['Cardis']."','".$componentes[ 'ele' ][$i]['Deffra']."',this)\" onkeypress='return validarEntradaDecimal(event);'>";
			echo "</td>";
			
			//Frecuencia
			echo "<td style='display:none;'>";
			echo "<select name='frecsol".$j."' id='frecsol".$j."' onChange=\"adicionarComponenteArticuloLEV('".$componentes[ 'ele' ][$i]['Carcod']."','".$componentes[ 'ele' ][$i]['Artgen']."','".$j."','".$componentes[ 'ele' ][$i]['Cardis']."','".$componentes[ 'ele' ][$i]['Deffra']."',this)\">";
			echo "<option value='' selected>Seleccione...</option>";
			$colPeriodicidades = consultarPeriodicidades();
			foreach ($colPeriodicidades as $periodicidad){
				echo "<option value='".$periodicidad->codigo."'>$periodicidad->descripcion</option>";
			}
			echo "</select>";
			
			$j++;
		}
		else{
			
			//checkbox
			echo "<td></td>";
			echo "<td></td>";
			echo "<td colspan=2></td>";
			echo "<td></td>";
			echo "<td></td>";
			echo "<td style='display:none;'></td>";
		}
		
		if( !empty( $componentes[ 'sol' ][ $i ] ) ){
				
			//checkbox
			echo "<td id='tdCbSol".$j."' sol".$componentes[ 'sol' ][$i]['Carcod']."='".$j."'>";
			echo "<INPUT type='checkbox' name='check_insumo' id='check_insumo".$j."' value='' onChange=\"adicionarComponenteArticuloLEV('".$componentes[ 'sol' ][$i]['Carcod']."','".$componentes[ 'sol' ][$i]['Artgen']."','".$j."','".$componentes[ 'sol' ][$i]['Cardis']."','".$componentes[ 'sol' ][$i]['Deffra']."',this)\">";
			echo "</td>";
			
			//Nombre de la solución
			echo "<td tdSolGen".$j.">";
			echo $componentes[ 'sol' ][$i][ 'Artgen' ];
			echo "</td>";
			
			//Frecuencia
			echo "<td style='display:none'>";
			echo "<select name='frecsol".$j."' id='frecsol".$j."' onChange=\"adicionarComponenteArticuloLEV('".$componentes[ 'sol' ][$i]['Carcod']."','".$componentes[ 'sol' ][$i]['Artgen']."','".$j."','".$componentes[ 'sol' ][$i]['Cardis']."','".$componentes[ 'sol' ][$i]['Deffra']."',this)\">";
			echo "<option value='' selected>Seleccione...</option>";
			$colPeriodicidades = consultarPeriodicidades();
			foreach ($colPeriodicidades as $periodicidad){
				echo "<option value='".$periodicidad->codigo."'>$periodicidad->descripcion</option>";
				
				$jsobjPerValor .= ",$periodicidad->codigo : $periodicidad->equivalencia ";
			}
			echo "</select>";
			
			//Creo el obejto javascript para el manejo de dosis maxima por defecto
			if( !empty($jsobjPerValor) ){
				echo "<script>var valFrecuencia = { ".substr( $jsobjPerValor, 1 )." }</script>";
			}
			
			// echo "<INPUT type='text' name='check_insumo$i' id='check_insumo$i' value='' style='width:50px'>";
			echo "</td>";
			
			
			//Volumen Total
			echo "<td>";
			echo "<INPUT type='text' name='cantidad_insumo".$j."' id='cantidad_insumo".$j."' value='' style='width:100px' onChange=\"adicionarComponenteArticuloLEV('".$componentes[ 'sol' ][$i]['Carcod']."','".$componentes[ 'sol' ][$i]['Artgen']."','".$j."','".$componentes[ 'sol' ][$i]['Cardis']."','".$componentes[ 'sol' ][$i]['Deffra']."',this)\" onkeypress='return validarEntradaDecimal(event);'>";
			echo "</td>";
			
			echo "<td tdSolUVol".$j.">";
			echo $componentes[ 'sol' ][$i][ 'Deffru' ];
			echo "</td>";
			
			$j++;
		}
		else{
			
			//checkbox
			echo "<td></td>";
			echo "<td></td>";
			echo "<td></td>";
			echo "<td></td>";
			echo "<td></td>";
			echo "<td colspan=2></td>";
		}
		
		echo "</tr>";
		
		if( $i == $num-1 ){
		
			/****************************************************************
			 * Se muestra la frecuencia de dilución
			 ****************************************************************/
			//Se busca la frecuencia de dilución
			$sql = "SELECT *
					  FROM {$wbasedato}_000173 a
					 WHERE freest = 'on'
					";
						 
			$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
			$numFdi = mysql_num_rows( $res );
			
			echo "<tr>";
			echo "<td colspan=10>";
			
			echo "<table align=center style='width:100%;'>";
			echo "<tr style='background-color:#3CB648;'>";
			
			echo "<td colspan='5' align='right'><b>* Velocidad de infusi&oacute;n</b></td>";
			echo "<td colspan='5'>";
			echo "<INPUT type='text' id='txFrecDilLev' style='width:50;' onKeyPress='return validarEntradaDecimal(event);'>";
			echo "<select id='slFrecDilLev'>";
			if( $numFdi > 1 ){
				echo "<option value=''>Seleccione...</option>";
				while( $rowsFre = mysql_fetch_array( $res ) ){
					echo "<option value='".$rowsFre[ 'Frecod' ]."'>".$rowsFre[ 'Fredes' ]."</option>";
				}
			}
			else{
				$rowsFre = mysql_fetch_array( $res );
				echo "<option selected value='".$rowsFre[ 'Frecod' ]."'>".$rowsFre[ 'Fredes' ]."</option>";
			}
			echo "</select>";
			echo "<td>";
			echo "<b>D. tto:</b> <input type='text' name='inDttoLEV' id='inDttoLEV' style='width:70px' onKeyUp='inhabilitarDosisMaximaModalLEV(this);' onkeypress='return validarEntradaEntera(event);'>";
			echo "</td>";
			echo "<td>";
			echo "<b>D. máx:</b> <input type='text' name='inDmaxLEV' id='inDmaxLEV' style='width:70px' onKeyUp='inhabilitarDiasTratamientoModalLEV(this);' onkeypress='return validarEntradaEntera(event);'>";
			echo "</td>";
			// echo "</td>";
			
			echo "</tr>";
			echo "</table>";
			
			echo "</td>";
			echo "</tr>";
			/****************************************************************/
			
			//Observaciones
			echo "<tr class='encabezadoTabla'>";
			echo "<td align='center' colspan=10>OBSERVACIONES</td>";
			echo "</tr>";
			echo "<tr class='fila1'>";
			echo "<td colspan='10'>";
			echo "<textarea id='txObservacionesLEV' style='width:100%;height:90'></textarea>";
			echo "</td>";
			echo "</tr>";
			echo "<tr class='fila1' trMod>";	//Para mostrar en modo de consulta
			echo "<td colspan='10'>";
			echo "<div id='dvObservacionesLEV' style='overflow:auto;width:100%;height:70px;background:#fff;border:1px #999 solid;font-size:9pt;text-align:left;'></div>";
			echo "</td>";
			echo "</tr>";
			
			// echo "<tr><td>&nbsp;</td></tr>";
			
			echo "<tr align=center id='trModificar'>";	//Esta es para cuando se va a actualizar un articulo
			echo "<td colspan='10' class='encabezadoTabla'>"; 
			// echo "Inicia el <b id='bLevFin'></b> a las <b id='bLevHin'></b> cada <b id='bLevFre'></b>";			
			echo "Inicia el <b id='bLevFin'></b> a las <b id='bLevHin'></b> <b id='bLevFre' style='display:none'></b>";			
			echo "</td>";
			echo "</tr>";
		
			echo "<tr align=center id='trNuevo' trNew>";		//Esta se muestra solo cuando se crea un LEV nuevo
			echo "<td colspan='10'>"; 
			echo "<br><INPUT type='button' value='Grabar' onClick=cerrarModalArticulos();>";
			echo "<INPUT type='button' value='Cancelar' onClick=cancerlarModalArticulosLEVIC()>";
			echo "</td>";
			echo "</tr>";
			
			echo "<tr trMod>";
			echo "<td colspan='10' align='center'>"; 
			echo "<INPUT type='button' id='btGrabarModLev' style='width:100' value='Grabar' onClick='modificarCambiosLEV();'>";
			echo "<INPUT type='button' style='width:100' value='Cerrar' onClick=$.unblockUI();>";
			echo "<INPUT type='hidden' id='idoMostrado'>";
			echo "</td>";
			echo "</tr>";
			
			echo "</table>";
			echo "</div>";
		}
	}
}


function esArticuloNutricion( $conexion, $wbasedatoCM, $codArticulo ){
	
	$sql = " SELECT *
			   FROM {$wbasedatoCM}_000002, {$wbasedatoCM}_000001
			  WHERE artcod = '$codArticulo'
				AND Tipcdo = 'off'
				AND Tippro = 'on'
				AND Tipnco = 'off'
				AND Arttip = Tipcod
				AND Artest = 'on'";	
	$res = mysql_query( $sql, $conexion ) or die( mysql_errno(). " - Error en el query - ".mysql_errno()  );
	$numrows = mysql_num_rows( $res );
	
	if( $numrows > 0 ){
		return true;
	}
	else{
		return false;
	}
}
/************************************************************************************************
 * Retorna el resulset con los principios activos de una familia
 ************************************************************************************************/
function consultarPrincipiosActivosPorFamilia( $conex, $wbasedato, $familia ){

	//Consulto los principios activos pertenecientes a la familia
	$sql = "SELECT Paccod, Pacdes, Pacest 
				FROM {$wbasedato}_000181 a, {$wbasedato}_000176 b
			   WHERE Parfam = '".$familia."'
				 AND Parpac = Paccod
				 AND Parest = 'on'
			";
	
	$desPrincipioActivo = '';
	$codPrincipioActivo = '';
	$resPac = mysql_query( $sql, $conex ) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
	
	return $resPac;
}

/**************************************************************************************************
 * Recibe un resulset devuelto por la función consultarPrincipiosActivosPorFamilia y separa por un 
 * caracter todos los codigos o descripciones de principios activos
 * Por defecto siempre separa los codigos
 * Si no se envia caracter por defecto separa por ','
 * La función deja de nuevo el puntero en el inicio del resulset
 **************************************************************************************************/
function codigosPrincipiosActivos( $res, $codigo = true, $sep = ',' ){

	$val = "";
	
	while( $rows = mysql_fetch_array( $res ) ){
		if( $codigo )
			$val .= $sep.$rows[ 'Paccod' ];
		else
			$val .= $sep.$rows[ 'Pacdes' ];
	}
	
	if( $val != '' ){
		$val = substr( $val, 1 );
	}
	
	@mysql_data_seek( $res, 0 );

	return $val;
}

function consultarDescripcionPrincipioActivo( $conex, $wbasedato, $cod ){

	$val = "";
	
	$sql = "SELECT *
			  FROM ".$wbasedato."_000176
			 WHERE Paccod = '".$cod."'";
			   
	$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
	
	if( $rows = mysql_fetch_array( $res ) ){
		$val = $rows[ 'Pacdes' ];
	}
	
	return $val;
}

function seguimiento($seguir)
{
    /*if (file_exists("seguimiento.txt")) {
        unlink("seguimiento.txt");
    }*/
	//Se coemtna esta función 2019-02-07
    // $fp = fopen("seguimiento_ordenes.txt","a+");
    // fwrite($fp, "[".date("Y-m-d H:i:s")."]".PHP_EOL.$seguir);
    // fclose($fp);
}

 
 
function verificarRegistroEnDefinitiva( $conex, $wbasedato, $his, $ing, $art, $feckar, $hini, $fini, $ido, $user ){
	
	//Verifico que efectivamente este el medicamento en la tabla temporal
	$sql = "SELECT *
			  FROM ".$wbasedato."_000060
			 WHERE Kadhis = '".$his."'
			   AND Kading = '".$ing."'
			   AND Kadart = '".$art."'
			   AND Kadfec = '".$feckar."'
			   AND Kadfin = '".$fini."'
			   AND Kadhin = '".$hini."'
			   AND Kadido = '".$ido."'";
			   
	$res60 = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
	$num60 = mysql_num_rows( $res60 );
	
	if( $num60 > 0 ){
	
		$sql = "SELECT *
				  FROM ".$wbasedato."_000054
				 WHERE Kadhis = '".$his."'
				   AND Kading = '".$ing."'
				   AND Kadart = '".$art."'
				   AND Kadfec = '".$feckar."'
				   AND Kadfin = '".$fini."'
				   AND Kadhin = '".$hini."'
				   AND Kadido = '".$ido."'";
				   
		$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
		
		if( $rows = mysql_fetch_array( $res ) ){
		
			$q = "DELETE FROM
					".$wbasedato."_000054
				WHERE
					id = '".$rows['id']."'
				";
				
			$resDel = mysql_query( $q, $conex ) or die( mysql_errno()."- Error en el query $sql - ".mysql_error() );
			
			if( mysql_affected_rows() == 0 ){
				$descripcion = "Aticulo NO ELIMINADO en Definitiva, articulo actualizado en temporal";
				$datos = "Kadhis: ".$his;
				$datos .= ", Kading: ".$ing;
				$datos .= ", Kadart: ".$art;
				$datos .= ", Kadfec: ".$feckar;
				$datos .= ", Kadfin: ".$fini;
				$datos .= ", Kadhin: ".$ini;
				$datos .= ", Kadido: ".$ido;
				$datos .= ", sql: ".str_replace( "'","\\'", $q );
				registrarAuditoriaCierreKardex( $his, $ing, $user, "*".$descripcion."*".$datos );
			}
			else{
				$descripcion = "Aticulo ELIMINADO en Definitiva, articulo actualizado en temporal";
				$datos = "Kadhis: ".$his;
				$datos .= ", Kading: ".$ing;
				$datos .= ", Kadart: ".$art;
				$datos .= ", Kadfec: ".$feckar;
				$datos .= ", Kadfin: ".$fini;
				$datos .= ", Kadhin: ".$ini;
				$datos .= ", Kadido: ".$ido;
				registrarAuditoriaCierreKardex( $his, $ing, $user, "*".$descripcion."*".$datos );
			}
		}
	}
}

function cantidadSaldoInc( $conex, $wbasedato, $historia, $ingreso, $art ){

	$saldo = 0;
	$sql = "SELECT Spauen, Spausa 
			  FROM ".$wbasedato."_000004 
			 WHERE Spahis = '".$historia."' 
			   AND Spaing = '".$ingreso."' 
			   AND Spaart = '".$art."'";
			   
	$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
	
	while($info = mysql_fetch_array($res)){
		$saldo += $info['Spauen'] - $info['Spausa'];
	}
	
	return $saldo;
}
 
/************************************************************************
 * Indica si un articulo fue aplicado en una fecha
 ************************************************************************/
function estaAplicadoPorRonda( $conex, $wbasedato, $historia, $ingreso, $articulo, $fecha, $ron, $ido, &$can ){

	$val = false;
	
	$q="SELECT
			*
		FROM
			{$wbasedato}_000015
		WHERE
			Aplhis = '$historia'
			AND Apling = '$ingreso'
			AND Aplart = '$articulo'
			AND Aplest = 'on'
			AND Aplfec = '$fecha'
			AND Aplron LIKE '$ron%'
			AND Aplido = '$ido'
		";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if($num > 0 ){
		$val = true;
		if( $rows = mysql_fetch_array( $res ) ){
			$can = $rows[ 'Aplcan' ];
		}
	}
	
	return $val;
}

 // Borra los registros anteriores a $ndias en la tabla de $tblog
function borrarLogsAntiguos($tblog,$ndias)
{
	global $conex;

	$nseg = 86400*$ndias;
	$antiguos = date("Y-m-d",time()-$nseg);

	// Borra registros antiguos de la tabla de log
	$q = "	DELETE FROM ".$tblog."
			 WHERE Fecha_data < '".$antiguos."'";
	$res1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
}
 
 //Guarda el log de ingreso a la historia e ingreso.
 function registrar_log_ingreso($conex, $wbasedato, $wcenmez, $whistoria, $wingreso){
	 
	global $user;
	$wuser = substr($user, (strpos($user, "-") + 1), strlen($user));
	
	$hora = date( "H:i:s" );
	$fecha = date( "Y-m-d" );
	
	$sql = "INSERT INTO ".$wbasedato."_000170 (Medico, Fecha_data, Hora_data, Loghis, Loging, Logest, Seguridad) VALUES( '$wbasedato', '$fecha', '$hora', '".$whistoria."', '".$wingreso."', 'on','C-$wuser')";	
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en la consulta - $sql - ". mysql_error() );
	 
 } 
 
 //Busca el tiempo transcurrido entre la fecha del ultimo ingreso a las ordenes del paciente y la fecha y hora de ingreso actual.
 function tiempo_transcurrido_apertura($conex, $wbasedato, $historia, $ingreso){	 
	 
	 global $conex;
	 
	 $fecha_hora_actual = date("Y-m-d H:i:s"); 
	 
	 $sql = " SELECT MAX(CONCAT(Fecha_data,' ', Hora_data)) as fechoring
				FROM {$wbasedato}_000170
			   WHERE loghis = '$historia'
				 AND loging = '$ingreso'";		
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en la consulta - $sql - ". mysql_error() );
	$row = mysql_fetch_array($res);
	
	$ultima_fechahora_ing = $row['fechoring'];
		
	$minutos = (strtotime($fecha_hora_actual) - strtotime($ultima_fechahora_ing)) / 60;
	$minutos = abs($minutos); 
	$minutos = floor($minutos);
	
	return $minutos;
	 
 }
 
 
//Busca si la familia tiene articulos pendientes.
function buscar_familias_pendientes($historia, $ingreso, $cod_familia){
	 
	global $conex;
	global $wbasedato;
	 
	$fecha = date('Y-m-d');
	
	//Busca los articulo con el codigo de la familia suspendida.
	$sql_pen = " SELECT kadpen
				   FROM {$wbasedato}_000060
			      WHERE kadhis = '$historia'
				    AND kading = '$ingreso'
				    AND kadfec = '$fecha'
				    AND kadctr = '$cod_familia'
				    AND kadpen = 'on'";				
	$res_pen = mysql_query( $sql_pen, $conex ) or die( mysql_errno()." - Error en la consulta - $sql_pen - ". mysql_error() );
	$num_pen = mysql_num_rows( $res_pen );
		
	if( $num_pen > 0 ){
		return true;
	}
	else{
		return false;
	}
	 
 }
 
//Busca si la familia asociada al paciente esta suspendida.
function buscar_familias_suspendidas($historia, $ingreso, $cod_familia){
	 
	global $conex;
	global $wbasedato;
	 
	$fecha = date('Y-m-d');
	
	//Busca los articulo con el codigo de la familia suspendida.
	$sql_sus = " SELECT kadsus
				   FROM {$wbasedato}_000060
			      WHERE kadhis = '$historia'
				    AND kading = '$ingreso'
				    AND kadfec = '$fecha'
				    AND kadctr = '$cod_familia'
				    AND kadsus = 'on'";				
	$res_sus = mysql_query( $sql_sus, $conex ) or die( mysql_errno()." - Error en la consulta - $sql_sus - ". mysql_error() );
	$num_sus = mysql_num_rows( $res_sus );
	
	//Busca los que no estan suspendidos.
	$sql_activo = " SELECT kadsus
					  FROM {$wbasedato}_000060
					 WHERE kadhis = '$historia'
					   AND kading = '$ingreso'
					   AND kadfec = '$fecha'
					   AND kadctr = '$cod_familia'
					   AND kadsus = 'off'";				
	$res_activo = mysql_query( $sql_activo, $conex ) or die( mysql_errno()." - Error en la consulta - $sql_activo - ". mysql_error() );
	$num_activo = mysql_num_rows( $res_activo );
	
	//Si el numero de suspendidos es mayor a cero y el numero de activos es cero entonces marcara toda la familia como suspendida.
	if( $num_sus > 0 and $num_activo == 0 ){
		return true;
	}
	else{
		return false;
	}
	 
 }


/************************************************************************
 * Agosto 6 de 2015 
 * Indica si una presentación permite no esteril
 ************************************************************************/
function presentacionPermiteNE( $conex, $wbasedato, $codigo ){

	$val = false;

	$sql = "SELECT * 
			  FROM {$wbasedato}_000027
			 WHERE Unicod = '$codigo'
			   AND Unines = 'on'
		   ";
	
	$res = mysql_query($sql, $conex) or die(mysql_error()." - Error en el query: $sql - ".mysql_error()); 
	$num = mysql_num_rows( $res );

	if( $num > 0 ){ 
		$val = true;
	}
	
	return $val;
}

/************************************************************************
 * Marzo 02 de 2015
 * Indica si una presentación permite dosis adaptada
 ************************************************************************/
function presentacionPermiteDA( $conex, $wbasedato, $codigo ){

	$val = false;

	$sql = "SELECT * 
			  FROM {$wbasedato}_000027
			 WHERE Unicod = '$codigo'
			   AND Unimda = 'on'
		   ";
	
	$res = mysql_query($sql, $conex) or die(mysql_error()." - Error en el query: $sql - ".mysql_error()); 
	$num = mysql_num_rows( $res );

	if( $num > 0 ){ 
		$val = true;
	}
	
	return $val;
}
 
 //Funcion que cambia el estado del examen por parte de la secretaria.
function cambiar_estado_examen($wemp_pmla, $wmovhos, $wfec, $wexam, $wing, $wfechadataexamen, $whoradataexamen, $wfechagk, $whis, $wordennro, $wordite, $westado, $wid, $wcco, $whce, $wcontrol_ordenes, $wtexto_examen, $westado_registro, $wuser)
   {

	  global $conex;
	  global $key;
	 
	  $whora = (string) date("H:i:s");
	  $wtexto = utf8_decode($wtexto);
	 
	  $audNuevo = "N:".$wexam.",".$wordennro.",".$wordite.",".str_replace( "_", " ", trim($wtexto_examen) ).",".$westado.",,".$wfechadataexamen;
	  $audAnterior = "A:".$wexam.",".$wordennro.",".$wordite.",".str_replace( "_", " ", trim($wtexto_examen) ).",".$westado_registro.",,".$wfechadataexamen;
		  	  
	  //Modifica la tabla ppal.
	  $query =   "UPDATE ".$wmovhos."_000050
					 SET Ekaest = '".$westado."'
				   WHERE id = '$wid'
					 AND Ekafec = '$wfec'
					 AND Ekahis = '$whis'
					 AND Ekaing = '$wing'";
	  $res = mysql_query($query, $conex) or die(mysql_error()." - Error en el query: $query - ".mysql_error()); 

	  //Modifica la tabla temporal.
	  $query =   "UPDATE ".$wmovhos."_000061
					 SET Ekaest = '".$westado."'
				   WHERE Ekaido = '$wid'
					 AND Ekafec = '$wfec'
					 AND Ekahis = '$whis'
					 AND Ekaing = '$wing'";
	  $res = mysql_query($query, $conex) or die(mysql_error()." - Error en el query: $query - ".mysql_error());	  

	   $mensajeAuditoria = obtenerMensaje('MSJ_EXAMEN_ACTUALIZADO');
		
		//Registro de auditoria
		$auditoria = new AuditoriaDTO();

		$auditoria->historia = $whis;
		$auditoria->ingreso = $wing;
		$auditoria->descripcion = "$audAnterior $audNuevo";
		$auditoria->fechaKardex = $wfec;
		$auditoria->mensaje = $mensajeAuditoria;
		$auditoria->seguridad = $wuser;
		
		registrarAuditoriaKardex($conex,$wmovhos,$auditoria);
	 
	}
 
 //Funcion que muestra los examenes que vienen desde kardex y que estan pendientes. 
function mostrar_examenes_kardex($conex, $wbasedato, $whis, $wing, $wuser){
	 
	global $wemp_pmla;
	
	$fecha_actual = date("Y-m-d");
	
	$query= " SELECT A.Fecha_data, A.Hora_data, Ekahis, Ekaing, Ekaest, Ekafec, Ekaobs, Ekafes, Ekacod, A.id
				FROM ". $wbasedato ."_000050 A, ". $wbasedato ."_000045 B
			   WHERE Ekahis = '".$whis."'
				 AND Ekaing = '".$wing."'
				 AND Ekaest = B.Eexcod
				 AND Eexpen = 'on'
				 AND Ekafec = '".$fecha_actual."'
			   UNION
			  SELECT A.Fecha_data, A.Hora_data, Ekahis, Ekaing, Ekaest, Ekafec, Ekaobs, Ekafes, Ekacod, Ekaido as id
				FROM ". $wbasedato ."_000061 A, ". $wbasedato ."_000045
			   WHERE Ekahis = '".$whis."'
				 AND Ekaing = '".$wing."'
				 AND Ekaest = Eexcod
				 AND Eexpen = 'on'
				 AND Ekafec = '".$fecha_actual."'
			ORDER BY Ekafes DESC";
	$res = mysql_query($query, $conex) or die(mysql_errno()." - Error en el query $sql - ".mysql_error());				
	$numK = mysql_num_rows($res);
	
	if($numK > 0){
		
		$i=1;
		echo "<table border=0 align=center>";
		echo "<tr class='encabezadoTabla' align=center><td colspan=4>Examenes registrados en kardex</td></tr>";
		echo "<tr class='encabezadoTabla'>";
		echo "<td align='center' nowrap><b>UNIDAD QUE REALIZA</b></td>";
		echo "<td align='center' nowrap><b>EXAMENES</b></td>";
		echo "<td align='center' nowrap><b>REALIZAR EN LA FECHA</b></td>";
		echo "<td align='center' nowrap><b>ESTADO</b></td>";
		echo "</tr>";		
		
		while ($row = mysql_fetch_array($res))
			{

				if (is_int($i / 2))
				{
				 $class = 'fila1';
				}
				else
				{
				 $class = 'fila2';
				}
				echo "<tr>";
				
				//Consulta el centro de costos.
				$sql_condi =   " SELECT Cconom "
							  ."   FROM ".$wbasedato."_000011 "
							  ."  WHERE Ccocod = '".$row['Ekacod']."'";			
				$res_condi = mysql_query( $sql_condi, $conex ) or die( mysql_errno()." - Error en el query $sql_condi - ".mysql_error() );
				$row_condi = mysql_fetch_array( $res_condi );
				$wser_relacionado = $row_condi['Cconom'];
				
				
				$wobservac = $row['Ekaobs'];
				echo "<td class =".$class." align=center>".$wser_relacionado."</td>";
				echo "<td class =".$class.">".$wobservac."<br>".$mensaje."</td>";
				echo "<td class =".$class." align='center'>".$row['Ekafes']."</td>";

				$westado_registro = $row['Ekaest'];
				
				$sql_est = "SELECT Eexcod, Eexdes
							  FROM ".$wbasedato."_000045
							 WHERE Eexord = 'on'
							   AND Eexest = 'on'";	
				$res_est = mysql_query( $sql_est, $conex ) or die( mysql_errno()." - Error en el query $sql_est - ".mysql_error() );
				$estado = "";
				
				$wexam = $row['Ekacod'];
				$wfechadataexamen = $row['Fecha_data'];
				$whoradataexamen = $row['Hora_data'];
				$wfechagk = $row['Ekafec'];
				$wid_a = $row['id'];
				$wcontrol_ordenes = "";
				$westado_actual = $row['Ekaest'];
				
				$estado1 = "<select id='estado_$wid_a' onchange='cambiar_estado_examen(\"$wemp_pmla\",\"$fecha_actual\",\"$wexam\",\"$wing\",\"$whis\",\"$wfechadataexamen\",\"$whoradataexamen\", \"$wfechagk\", \" \", \" \",this, \"$wid_a\", \"$wcco\", \"$whce\",\"$wcontrol_ordenes\", \"$wobservac\", \"$westado_actual\", \"$wuser\")'>";
				
				while($row_est = mysql_fetch_array( $res_est )){
					
					$seleccionar = "";
				
					if($row_est['Eexcod'] == $westado_registro){
					
					$seleccionar = "selected";
					
					}
					
					$estado.= "<option value='".$row_est['Eexcod']."' $seleccionar>".$row_est['Eexdes']."</option>";
				
				}
				$estado2 = "</select>";

				echo "<td class =".$class." align='center'>".$estado1.$estado.$estado2."</td>";				
				echo "</tr>";
				$i++;
			}
		echo "</table>";		
		echo "<br>";
	}	 
	 
	 
 }
 
 
/******************************************************************************************
 * Marca como leído la Bitacora de procedimientos
 *
 * Enero 26 de 2012
 ******************************************************************************************/
function marcandoLeidoBitacoraProcedimientos( $conex, $wbasedato, $usuario, $historia, $ingreso ){

	$val = false;
	
	$fecha = date( "Y-m-d" );
	$hora = date( "H:i:s" );

	$sql = "UPDATE {$wbasedato}_000121
			   SET dmousl = '$usuario',
				   dmofel = '".date( "Y-m-d" )."',
				   dmohol = '".date( "H:i:s" )."',
				   dmolei = 'on'
			 WHERE dmohis = '$historia'
			   AND dmoing = '$ingreso'
			   AND dmolei != 'on'";			
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql -".mysql_error() );
	
	if( mysql_affected_rows() ){
		$val = true;
	}
	
	return $val;
} 
 
 
//Consulta el protocolo para un examen.
function traer_protocolo_examen($wbasedatohce, $codcups){
		
	global $conex;
	
	$sql = "SELECT Protocolo 
			  FROM {$wbasedatohce}_000017
			 WHERE Codcups = '$codcups'";	
	$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$row = mysql_fetch_array( $res );
	
	return $row['Protocolo'];
	
}
 
 
 
/************************************************************************************************************************
 * actualiza el tipo de protocolo (campo Kadpro de la tabla movhos_000054) de acuerdo a la configuración de pestañas
 * para ordenes
 ************************************************************************************************************************/
function actualizarTipoProtocolo( $conex, $wemp_pmla, $wbasedato, $his, $ing, $fecha ){
	
	$sql = "SELECT Kadpro 
			  FROM {$wbasedato}_000054
			 WHERE kadhis = '$his'
			   AND kading = '$ing'
			   AND kadfec = '$fecha'
			   AND kadlev != 'on'
		  GROUP BY 1
			";
	
	$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows( $res );
	
	if( $num > 0 ){
	
		$pesMedicamentosBD = consultarAliasPorAplicacion( $conex, $wemp_pmla, "pesMedicamentos" );

		while( $rows = mysql_fetch_array( $res ) ){
			
			$pestanas = explode( ";", $pesMedicamentosBD );
			
			foreach( $pestanas as $key => $value ){
				
				$datPestanas = explode( "-", $value );
				
				//Reviso si el protocolo es diferente a la pestaña a la que le corresponde
				if( $datPestanas[1] != $rows[ 'Kadpro' ] ){
				
					//Se revisa que el protocolo pertenezca a al pestañas
					$tipProtocolos = explode( ",", $datPestanas[2] );
					
					if( in_array( $rows['Kadpro'], $tipProtocolos ) ){
						
						//Si se encuentra se actualiza el tipo de protocolo para todos lo registros del kardex
						$sql = "UPDATE {$wbasedato}_000054
								   SET kadpro = '".$datPestanas[1]."'
								 WHERE kadhis = '$his'
								   AND kading = '$ing'
								   AND kadfec = '$fecha'
								   AND kadlev != 'on'
								   AND kadpro = '".$rows[ 'Kadpro' ]."'
								";
						
						$resUpt = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
					}
				}
			}
		}
	}
}


/********************************************************************************************************************************
 * Esta función toma un arreglo de detalle de articulos y elimina del arreglo original los articulo que son lev y los pasa
 * a otro arreglo con los artiulos lev
 ********************************************************************************************************************************/
function consultarLactario( &$colDetalleLTR, &$colDetArt ){
	
	$val = Array();
	
	foreach( $colDetArt as $key => $value ){
		if( $value->esLactario ){
			$colDetalleLTR[] = $value;
		}
		else{
			$val[] = $value;
		}
	}
	
	$colDetArt = $val;
}
  
 
//Graba la auditoria cuando el medico no confirma realizar el CTC del articulo.
function grabarAuditoriaProcSinCTC( $wemp_pmla, $whistoria, $wingreso, $wfechagrabacion, $wbasedato, $wbasedatohce, $whce, $wcedula, $tipoDocumento, $wusuario, $codigo_procedimiento, $nombreExamen){
	
	global $conex;
	
	$mensajeAuditoria = obtenerMensaje( 'MSJ_SIN_CTC' );

	//Registro de auditoria
	$auditoria = new AuditoriaDTO();

	$auditoria->historia = $whistoria;
	$auditoria->ingreso = $wingreso;
	$auditoria->descripcion = "Codigo: {$codigo_procedimiento} - {$nombreExamen} , no generó CTC.";
	$auditoria->fechaKardex = $wfechagrabacion;
	$auditoria->mensaje = $mensajeAuditoria;
	$auditoria->seguridad = $wusuario;

	registrarAuditoriaKardex( $conex,$wbasedato,$auditoria );
	
} 

//Graba la auditoria cuando el medico no confirma realizar el CTC para el procedimiento.
function grabarAuditoriaArtSinCTC( $wemp_pmla, $whistoria, $wingreso, $wfechagrabacion, $wbasedato, $wbasedatohce, $whce, $wcedula, $tipoDocumento, $wusuario, $codigo_articulo){
	
	global $conex;
	
	$mensajeAuditoria = obtenerMensaje( 'MSJ_SIN_CTC' );

	//Registro de auditoria
	$auditoria = new AuditoriaDTO();

	$auditoria->historia = $whistoria;
	$auditoria->ingreso = $wingreso;
	$auditoria->descripcion = "Articulo: {$codigo_articulo}, no generó CTC.";
	$auditoria->fechaKardex = $wfechagrabacion;
	$auditoria->mensaje = $mensajeAuditoria;
	$auditoria->seguridad = $wusuario;

	registrarAuditoriaKardex( $conex,$wbasedato,$auditoria );
	
} 
 
 
function esArticuloLactario( $conex, $wbasedato, $art ){

	$val = false;
	
	$sql = "SELECT *
			  FROM {$wbasedato}_000026, {$wbasedato}_000011
			 WHERE artcod = '$art' 
			   AND FIND_IN_SET( SUBSTRING(artgru, 1 , 3 ), ccogka ) > 0
			   AND artest = 'on'
			   AND ccolac = 'on'
			   AND ccoest = 'on'
			";
			
	$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows( $res );
	
	if( $num > 0 ){
		$val = true;
	}
	else{
		$sql = "SELECT *
				  FROM {$wbasedato}_000068
				 WHERE arkcod = '$art' 
				   AND arktip = 'LC'
				   AND arkest = 'on'
				";
			
		$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
		$num = mysql_num_rows( $res );
		
		if( $num > 0 ){
			$val = true;
		}
	}
	
	return $val;
}
 
function registrarAlertasHCE( $conex, $wmovhos, $whce, $his, $ing, $fecha ){

	$tabla = "000133";

	$sql = "SELECT *
			  FROM {$whce}_{$tabla}
			 WHERE movhis = '$his' 
			   AND moving = '$ing'
			";
			
	$resHce = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$numHce = mysql_num_rows( $resHce );
			
	if( $numHce == 0 ){
	
		$sql = "SELECT Karale
				  FROM {$wmovhos}_000053
				 WHERE karhis = '$his' 
				   AND karing = '$ing'
				   AND fecha_data = '$fecha'
				   AND karcco = '*'
				";
			
		$resAle = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
		
		if( $rowsAle = mysql_fetch_array( $resAle ) ){
		
			$regFecha = date( "Y-m-d" );
			$regHora = date( "H:i:s" );
			
			//Inserto fecha
			$sql = "INSERT INTO {$whce}_{$tabla} VALUES( '$whce', '$regFecha', '$regHora', '$tabla', '2', '$his', '$ing', 'Fecha', '$regFecha', '$whce', 'C-$whce', NULL ) ";
			$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
			
			//Inserto Hora
			$sql = "INSERT INTO {$whce}_{$tabla} VALUES( '$whce', '$regFecha', '$regHora', '$tabla', '3', '$his', '$ing', 'Hora', '$regHora', '$whce', 'C-$whce', NULL ) ";
			$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
			
			//Inserto cheked
			$sql = "INSERT INTO {$whce}_{$tabla} VALUES( '$whce', '$regFecha', '$regHora', '$tabla', '6', '$his', '$ing', 'Booleano', 'CHECKED', '$whce', 'C-$whce', NULL ) ";
			$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
			
			//Inserto Texto
			$sql = "INSERT INTO {$whce}_{$tabla} VALUES( '$whce', '$regFecha', '$regHora', '$tabla', '7', '$his', '$ing', 'Texto', '".$rowsAle[ 'Karale' ]."', '$whce', 'C-$whce', NULL ) ";
			$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
			
			
			//Inserto firma
			$sql = "INSERT INTO {$whce}_{$tabla} VALUES( '$whce', '$regFecha', '$regHora', '$tabla', '1000', '$his', '$ing', 'Firma', 'Ordenes', '$whce', 'C-$whce', NULL ) ";
			$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
		}
	}
}
 
function actualizarFamiliaProductos( $conex, $wmovhos, $wcenpro, $his, $ing, $fecha ){
	
	//Dosis Adaptada
	$sql = "UPDATE {$wmovhos}_000054, {$wcenpro}_000002 d, {$wcenpro}_000001 a, {$wmovhos}_000115, {$wcenpro}_000009, {$wcenpro}_000003, {$wcenpro}_000002 b, {$wcenpro}_000001 c
			   SET Kadctr = relfam
			 WHERE kadfec = '$fecha'
			   AND Kadhis = '$his'
			   AND Kading = '$ing'
			   AND kadctr =  ''
			   AND kadori =  'CM'
			   AND kadart = d.artcod
			   AND a.tipcod = d.arttip
			   AND a.tipcod IN ( '03',  '21',  '22' )
			   AND pdepro = d.artcod
			   AND pdeins = appcod
			   AND pdeest =  'on'
			   AND appcod = pdeins
			   AND appest = 'on'
			   AND apppre = relart
			   AND pdeins = b.artcod
			   AND c.tipcod = b.arttip
			   AND c.tipcod !=  '12'
			   ";
	$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	
	//Nutriciones
	$sql = "UPDATE {$wmovhos}_000054, {$wcenpro}_000002, {$wcenpro}_000001
			   SET Kadctr = '1302'
			 WHERE kadfec = '$fecha'
			   AND Kadhis = '$his'
			   AND Kading = '$ing'
			   AND kadctr = ''
			   AND kadori = 'CM'
			   AND kadart = artcod
			   AND tipcod = arttip
			   AND tipcod IN ( '02', '19', '20' );
			   ";
	$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
		   
	//Quimioterapia	  
	$sql = "UPDATE {$wmovhos}_000054, {$wcenpro}_000002, {$wcenpro}_000001
			   SET Kadctr = '1303'
			 WHERE kadfec = '$fecha'
			   AND Kadhis = '$his'
			   AND Kading = '$ing'
			   AND kadctr = ''
			   AND kadori = 'CM'
			   AND kadart = artcod
			   AND tipcod = arttip
			   AND tipcod IN ( '11' );
			   ";
	$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
		   
	//NO ESTERIL
	$sql = "UPDATE {$wmovhos}_000054, {$wcenpro}_000002 d, {$wcenpro}_000001 a, {$wmovhos}_000115, {$wcenpro}_000009, {$wcenpro}_000003, {$wcenpro}_000002 b, {$wcenpro}_000001 c
			   SET Kadctr = relfam
			 WHERE kadfec = '$fecha'
			   AND Kadhis = '$his'
			   AND Kading = '$ing'
			   AND kadctr =  ''
			   AND kadori =  'CM'
			   AND kadart = d.artcod
			   AND a.tipcod = d.arttip
			   AND a.tipcod IN ( '16' )
			   AND pdepro = d.artcod
			   AND pdeins = appcod
			   AND pdeest =  'on'
			   AND appcod = pdeins
			   AND apppre = relart
			   AND pdeins = b.artcod
			   AND c.tipcod = b.arttip
			   AND c.tipcod !=  '12'
			   AND appest =  'on'
			   ";
	$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	
	//Articulos de SF sin familia
	$sql = "UPDATE {$wmovhos}_000054 a, {$wmovhos}_000115 b, {$wmovhos}_000026 c
			  SET Kadctr = relfam
			WHERE kadfec = '$fecha'
			  AND Kadhis = '$his'
			  AND Kading = '$ing'
			  AND kadctr =  ''
			  AND kadart = b.relart
			  AND kadart = artcod";
	$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	
	//Se intenta registrar las alertas
	registrarAlertasHCE( $conex, $wmovhos, "hce", $his, $ing, $fecha );
}
 
 
 function cargarMedicosATemporal($historia,$ingreso,$fecha){
	global $wbasedato;
	global $conex;

	$q = "INSERT INTO ".$wbasedato."_000063
		   	(Medico,Fecha_data,hora_data,Mettdo,Metdoc,Methis,Meting,Metfek,Metest,Metint,Metesp,seguridad)
		SELECT
			 Medico,Fecha_data,hora_data,Mettdo,Metdoc,Methis,Meting,Metfek,Metest,Metint,Metesp,seguridad
		FROM
			".$wbasedato."_000047
		WHERE
			Methis = '$historia'
			AND Meting = '$ingreso'
			AND Metfek = '$fecha'";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

	//Borrado de la definitiva
	$q = "DELETE FROM
			".$wbasedato."_000047
		WHERE
			Methis = '$historia'
			AND Meting = '$ingreso'
			AND Metfek = '$fecha'";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
}

/******************************************************************************************
 * Consulta la hubicación del paciente en urgencias
 ******************************************************************************************/
function consultaUbicacionPacienteUrgencias( $conex, $wbasedato, $historia, $ingreso, $cco ){
	
	$val = false;
	
	$tablaHabitaciones = consultarTablaHabitaciones( $conex, $wbasedato, $cco );
	
	$sql = "SELECT Habzon, Habcpa, Aredes
			  FROM ".$tablaHabitaciones." a, ".$wbasedato."_000169 b
			 WHERE habhis = '$historia'
			   AND habing = '$ingreso'
			   AND habzon = arecod
			   AND areest = 'on'
			   AND habest = 'on'
			";
			
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	
	if( $row = mysql_fetch_array($res) ){
		$val = $row[ 'Aredes' ]." - ".$row[ 'Habcpa' ];
	}
	
	return $val;
}
 
function puedeFirmarPorCodigo( $conex, $whce, $codigo ){
	
	$val = 'off';
	
	//Consulta de posibilidad de firmar si el rol lo permite
	$q4 = "SELECT
				Prorol,Proprg,Profir  
			FROM 
				{$whce}_000020 a, {$whce}_000030 b
			WHERE
				Usucod = '$codigo'
				AND usurol = prorol 
				AND Profir = 'on'
	";

	$res4 = mysql_query($q4, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q4 . " - " . mysql_error());
	$num4 = mysql_num_rows($res4);
	
	if( $rs4 = mysql_fetch_array($res4) ){
		$val = 'on';
		
	$sql = "SELECT usucod, usucla
			  FROM ".$whce."_000020
			 WHERE usucod = '".$codigo."'			 
			   AND usuest = 'on'";			   
	$res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$row = mysql_fetch_array( $res );
	$wfirma = $row['usucla'];
		
	}
	
	return $val."-".$wfirma;
}
 
 // Función que permite consultar el código actual de el centro de costos de Urgencias
function consultarCcoUrgencias(){
	global $wbasedato;
	global $conex;

	$q = "SELECT
			Ccocod
		FROM
			".$wbasedato."_000011
		WHERE
			Ccourg = 'on'
		AND Ccoest = 'on'; ";

	//	echo $q;

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$filas = mysql_num_rows($res);

	$cco = "";

	if($filas > 0){
		$fila = mysql_fetch_row($res);

		$cco = $fila[0];
	}
	return $cco;
}
 
 
 function sanear_string($string)
{

    $string = trim($string);

    $string = str_replace(
        array('à', 'ä', 'â', 'ª', 'Á', 'À', 'Â', 'Ä'),
        array('a', 'a', 'a', 'a', 'A', 'A', 'A', 'A'),
        $string
    );

    $string = str_replace(
        array('è', 'ë', 'ê', 'É', 'È', 'Ê', 'Ë'),
        array('e', 'e', 'e', 'E', 'E', 'E', 'E'),
        $string
    );

    $string = str_replace(
        array('ì', 'ï', 'î', 'Í', 'Ì', 'Ï', 'Î'),
        array('i', 'i', 'i', 'I', 'I', 'I', 'I'),
        $string
    );

    $string = str_replace(
        array('ò', 'ö', 'ô', 'Ó', 'Ò', 'Ö', 'Ô'),
        array('o', 'o', 'o', 'O', 'O', 'O', 'O'),
        $string
    );

    $string = str_replace(
        array('ù', 'ü', 'û', 'Ú', 'Ù', 'Û', 'Ü'),
        array('u', 'u', 'u', 'U', 'U', 'U', 'U'),
        $string
    );

    $string = str_replace(
        array('Ñ', 'ç', 'Ç'),
        array('N', 'c', 'C',),
        $string
    );

    //Esta parte se encarga de eliminar cualquier caracter extraño
    $string = str_replace(
        array("\\", "¨", "º", "~",
             "#", "@", "|", "·", "&", "/",
             "(", ")", "'", "¡", "[", "^", "`", "]",
             "}", "{", "¨", ">", "< "),'', $string);


    return $string;
}
 
 
  //Funcion que inactiva o activa la impresion de un examen de alta.
 function imprimirExamenAlta( $wemp_pmla, $whistoria, $wingreso, $wfechagrabacion, $wbasedato, $wbasedatohce, $whce, $wcedula, $tipoDocumento, $wusuario, $codigoArticulo, $imprimirExamen, $tipoDeOrden, $numeroDeOrden, $nroItem){
 
	$conexion = obtenerConexionBD("matrix");
	
	$datamensaje = array('mensaje'=>'', 'error'=>0);
	
	
	$sql = "UPDATE ".$whce."_000027 a, ".$whce."_000028 b
			   SET Detimp = '".$imprimirExamen."'
			 WHERE ordtor = dettor
			   AND ordnro = detnro
			   AND dettor = '".$tipoDeOrden."'
			   AND detnro = '".$numeroDeOrden."'
			   AND detite = '".$nroItem."'";
	$res = mysql_query($sql, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
	$modifico = mysql_affected_rows();
	
	if($modifico > 0){
		
		if($imprimirExamen == 'on'){
			$datamensaje['mensaje'] = 'El examen sera impreso';
		}else{
			$datamensaje['mensaje'] = 'El examen no sera impreso';
		}
	
	}
	
	
	echo json_encode($datamensaje);
	return;
 
 }
 
 //Funcion que inactiva o activa la impresion de un medicamento de alta.
 function imprimirArtAlta( $wemp_pmla, $whistoria, $wingreso, $wfechagrabacion, $wbasedato, $wbasedatohce, $whce, $wcedula, $tipoDocumento, $wusuario, $codigoArticulo, $imprimirArtAlta){
 
	$conexion = obtenerConexionBD("matrix");
	$cod_art = explode("-", $codigoArticulo);
	$datamensaje = array('mensaje'=>'', 'error'=>0);
	
	$q = "UPDATE ".$wbasedato."_000168 SET
				 Kadimp = '$imprimirArtAlta'
		   WHERE Kadhis = '$whistoria'
			 AND Kading = '$wingreso'
			 AND Kadart = '$cod_art[0]'";
	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$modifico = mysql_affected_rows();
	
	if($modifico > 0){
		
		if($imprimirArtAlta == 'on'){
			$datamensaje['mensaje'] = 'El articulo sera impreso';
		}else{
			$datamensaje['mensaje'] = 'El articulo no sera impreso';
		}
	
	}
	
	
	echo json_encode($datamensaje);
	return;
 
 }
 
 
 /******************************************************************************************
 * Consulta las observaciones de la secretaria
 ******************************************************************************************/
function consultarBitacora( $conex, $wbasedato, $historia, $ingreso, $nro_orden, $nro_item ){

	$val = Array();

	$sql = "SELECT *
              FROM {$wbasedato}_000121 a
	  		 WHERE dmohis = '$historia'
			   AND dmoing = '$ingreso'
			   AND dmoord = '$nro_orden'
			   AND dmoite = '$nro_item' 
		  ORDER BY Fecha_data DESC";	
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$num = mysql_num_rows($res);
	
	if( $num > 0 ){
	
		for( $i = 0; $rows = mysql_fetch_array( $res ); $i++ ){
			
			$sql = "SELECT 
						Descripcion as Usuario 
					FROM 
						usuarios 
					WHERE 
						Codigo = '".$rows['Dmousu']."'
					";
						
			$res1 = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q1 . " - " . mysql_error());
			$rowUsuario = mysql_fetch_array( $res1 );
			
			@$val[$i][ 'usuario' ] = $rows['Dmousu'];
			@$val[$i][ 'nombre' ] = $rowUsuario['Usuario'];
			@$val[$i][ 'fecha' ] = $rows['Fecha_data'];
			@$val[$i][ 'bitacora' ] = $rows['Dmoobs'];
		}
	}
	
	return $val;
}

 function estados_ordenes($wemp_pmla, $wbasedato, $conex, $estado){
 
		
	$sql = "SELECT Eexord
			  FROM ".$wbasedato."_000045
			 WHERE Eexcod = '".$estado."'
			   AND Eexord = 'on'
			   AND Eexest = 'on'";		
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$row = mysql_fetch_array($res);	
		
	return $row['Eexord'];
 
 }
 
 
 //Consultar medicamentos de consumo habitual de la historia clinica
 function consultarMedConsuHabitual( $wemp_pmla, $conex, $wmovhos, $whce, $aplicacion, $his, $ing ){

	$val = "";//array();

	$datosHCE = consultarAliasPorAplicacion( $conex, $wemp_pmla, $aplicacion );
	
	$exp = explode( "-", $datosHCE );
	$tabla = $exp[0];
	$campo = $exp[1];
	
	$sql = "SELECT movdat, fecha_data, Hora_data
			  FROM {$whce}_{$tabla}
			 WHERE movhis = '$his'
			   AND moving = '$ing'
			   AND movcon = '$campo'
		  ORDER BY fecha_data DESC, Hora_data DESC";				
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$row = mysql_fetch_array($res);	
		
	return $row['movdat'];
}

//Consulta el resumen de la historia
function consultarResumenHistoria($wemp_pmla,$basedatoshce,$historia,$ingreso){
	$conexion = obtenerConexionBD("matrix");

	// Se comenta porque se necesita saber si trajo resultados sin que saque el mensaje que saca esta función
	//$resumenHCE = consultarAliasPorAplicacion($conexion, $wemp_pmla, 'resumenHCE');
	
	$sql = " SELECT Detval
			   FROM root_000051
			  WHERE Detapl = 'resumenHCE'
				AND Detemp = '".$wemp_pmla."' ";
	$res = mysql_query( $sql, $conexion );
	$numrows = mysql_num_rows( $res );
	
	if( $numrows > 0 )
	{
		$rows = mysql_fetch_array( $res );
		$resumenHCE = $rows[ 'Detval' ];
	}
	else
	{
		$resumenHCE = "";
	}

	
	$tablasConsulta = explode(',',$resumenHCE);

	if($resumenHCE!="")
	{
		$q = "";
		$cont=0;
	
		foreach ($tablasConsulta as $tablaConsulta)
		{
			$tabla_con = explode('-',$tablaConsulta);
			$tabla = $tabla_con[0];
			$consecutivo = $tabla_con[1];
			$tabla = $basedatoshce."_".$tabla;
			
			if($cont>0)
				$q .= " UNION ALL ";
			
			$q .= " SELECT ".$tabla.".movdat, ".$tabla.".Fecha_data, ".$tabla.".Hora_data
					  FROM ".$tabla."
					 WHERE ".$tabla.".movcon = ".$consecutivo."
					   AND movhis = '".$historia."'
					   AND moving = '".$ingreso."' ";
			
			$cont++;
		}
		
		$q .= " ORDER BY Fecha_data DESC, Hora_data DESC ";
		
		$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
		$num = mysql_num_rows($res);
	}
	else
	{
		$num = 0;
	}
	
	if($num > 0)
	{
		$rs = mysql_fetch_array($res);
		$consulta = utf8_encode( $rs['movdat'] );
	} 
	else
	{
		$consulta = "";
	}
	
	return $consulta;
}

function registrarAuditoriaCierreKardex( $his, $ing, $usu, $texto = '' ){
	
	$conex = obtenerConexionBD("matrix");
	
	$hora = date( "H:i:s" );
	$fecha = date( "Y-m-d" );
	
	$sql = "INSERT INTO aud_cierre_kardex VALUES( '$fecha', '$hora', '$his', '$ing', '$usu', '$texto' )";
	
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en la consulta - $sql - ". mysql_error() );
//	$numrows = mysql_num_rows( $res );
	
	return true;
}
 
/********************************************************************************************************************************
 * Esta función toma un arreglo de detalle de articulos y elimina del arreglo original los articulo que son lev y los pasa
 * a otro arreglo con los artiulos lev
 ********************************************************************************************************************************/
function consultarLEV( &$colDetLEV, &$colDetArt ){
	
	$val = Array();
	
	foreach( $colDetArt as $key => $value ){
		if( $value->esLev ){
			$colDetLEV[] = $value;
		}
		else{
			$val[] = $value;
		}
	}
	
	$colDetArt = $val;
}

 /************************************************************************
  * Consulta los roles que pueden leer las ordenes pendientes
  ************************************************************************/
function permiteLecturaOrdenesPendientes( $conex, $wemp_pmla, $rol ){

	$val = false;

	$conRoles = consultarAliasPorAplicacion( $conex, $wemp_pmla, "lecturaOrdenesPendientes" );
	
	$roles = explode( ",", $conRoles );
	
	foreach( $roles as $key => $value ){
		if( $value == $rol ){
			$val = true;
			$break;
		}
	}
	
	return $val;
}
 
/**
 * Esta función marca los registros que se han creado y el usuario de ser enfermera
 * quedan como leídos
 */
function marcarRegistrosLeidos( $conex, $wbasedato, $whce, $codigo, $his, $ing, $pestanasVistas ){
	
	$usuario = consultarUsuarioOrdenes( $codigo );
	
	// if( $usuario->esEnfermeraRolHCE ){
	if( permiteLecturaOrdenesPendientes( $conex, "01", $usuario->codigoRolHCE ) ){
	
		$fecha = date( "Y-m-d" );
		$hora = date( "H:i:s" );
		
		$pestanas = explode(",",$pestanasVistas);
		
		if(in_array("4",$pestanas))
		{
			//Marco los campos como leídos de examenes
			$sql = "UPDATE 
						".$whce."_000027, ".$wbasedato."_000159
					SET
						Detpen = 'off',
						Detule = '$codigo',
						Detfle = '$fecha',
						Dethle = '$hora'
					WHERE
						Ordhis = '$his'
						AND Ording = '$ing'
						AND Ordtor = Dettor
						AND Ordnro = Detnro
						AND Ordest = 'on'
						AND Detpen = 'on'
						AND Detest = 'on'
					";
			
			$res = mysql_query( $sql, $conex ) or die( mysql_error()." - Error en el query $sql - ".mysql_errno() );
			
		}
		
		if(in_array("3",$pestanas))
		{
			//Marco los campos como leídos de medicamentos
			$sql = "UPDATE 
						".$wbasedato."_000060
					SET
						Kadpen = 'off',
						Kadule = '$codigo',
						Kadfle = '$fecha',
						Kadhle = '$hora'
					WHERE
						Kadhis = '$his'
						AND Kading = '$ing'
						AND Kadfec = '$fecha'
						AND Kadpen = 'on'
						AND Kadest = 'on'
					";
			
			$res = mysql_query( $sql, $conex ) or die( mysql_error()." - Error en el query $sql - ".mysql_errno() );
			
					
		}
		
		if(in_array("10",$pestanas))
		{
			//Marco los campos como leídos de dietas
			$sql = "UPDATE 
						".$wbasedato."_000064
					SET			
						Dikpen = 'off',
						Dikule = '$codigo',
						Dikfle = '$fecha',
						Dikhle = '$hora'
					WHERE
						Dikhis = '$his'
						AND Diking = '$ing'
						AND Dikfec = '$fecha'
						AND Dikpen = 'on'
						AND Dikest = 'on'
					";
			
			$res = mysql_query( $sql, $conex ) or die( mysql_error()." - Error en el query $sql - ".mysql_errno() );
			
			$sql = "UPDATE 
					".$wbasedato."_000053
				SET
					Karpen = 'off',
					Karule = '".$usuario->codigo."',
					Karfle = '".date( "Y-m-d" )."',
					Karhle = '".date( "H:i:s" )."'
				WHERE
					Karhis = '$his'
					AND Karing = '$ing'
					AND Karcco = '$usuario->centroCostosGrabacion'
					AND Fecha_data = '$fecha';";
					
			$res = mysql_query( $sql, $conex ) or die( mysql_error()." - Error en el query $sql - ".mysql_errno() );
			
		}
		
		if(in_array("1",$pestanas))
		{
			$sql = "UPDATE 
					".$wbasedato."_000053
				SET
					Karpen = 'off',
					Karule = '".$usuario->codigo."',
					Karfle = '".date( "Y-m-d" )."',
					Karhle = '".date( "H:i:s" )."'
				WHERE
					Karhis = '$his'
					AND Karing = '$ing'
					AND Karcco = '$usuario->centroCostosGrabacion'
					AND Fecha_data = '$fecha';";
					
			$res = mysql_query( $sql, $conex ) or die( mysql_error()." - Error en el query $sql - ".mysql_errno() );
		}
		
	}
} 

/**
 * Indica si un producto de CM es de control o no
 */
function esProductoControl( $conex, $wbasedato, $wcenmez, $art ){

	$val = false;
	
	$sql="SELECT
				Artpos
			FROM
				{$wcenmez}_000003 a, {$wcenmez}_000009 b, {$wbasedato}_000026 c
			WHERE
				pdepro='$art'
				AND pdeins = appcod
				AND pdeest = 'on'
				AND apppre = artcod
				AND SUBSTRING( artgru, 1 , 3 ) =  'CTR'
				AND artest = 'on'
			";
	
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query - $sql - ".mysql_error() );
	$num = mysql_num_rows( $res );
	
	if( $num > 0 ){
		$val = true;
	}
	
	return $val;
}
 
 function salirsigrabar( $wemp_pmla, $whistoria, $wingreso, $wfechagrabacion, $tipoDocumento,$wcedula, $editable, $pestanasVistas ){
 
	global $conex;
	global $whce;
	global $wbasedatohce;
	global $wbasedato;
	global $paciente;
	global $wusuario;
	global $usuario;
	
	$datamensaje = array('mensaje'=>'', 'error'=>0); 		
	
	if( $editable ){
		$firmaDigital = "";
		$esPrimerKardex = "";
		
		$paciente = consultarInfoPacienteOrdenHCE($tipoDocumento,$wcedula);
		$usuario = consultarUsuarioOrdenes($wusuario);
		
		// if(!existeEncabezadoKardex($paciente->historiaClinica, $paciente->ingresoHistoriaClinica, $wfechagrabacion)){
		if(!existeEncabezadoKardexSinCco($wbasedato,$conex,$paciente->historiaClinica,$paciente->ingresoHistoriaClinica,$wfechagrabacion, $datos )){
			replicarEncabezadoKardexAnterior($paciente->historiaClinica, $paciente->ingresoHistoriaClinica, $wfechagrabacion);
		}
		else{
			//Se desbloquea el kardex.
			$q="UPDATE ".$wbasedato."_000053
				   SET Kargra = 'on'
				 WHERE Karhis = '$paciente->historiaClinica'
				   AND Karing = '$paciente->ingresoHistoriaClinica'
				   
				   AND Fecha_data = '$wfechagrabacion'";
			$res = mysql_query( $q, $conex ) or die( mysql_errno()." - Error en el query - ".mysql_error() );
		}
		
		//marca los registros cómo leídos según el usuario
		//marcarRegistrosLeidos( $conex, $wbasedato, $wbasedatohce, $usuario->codigo, $paciente->historiaClinica, $paciente->ingresoHistoriaClinica );
		
		//Se habilita nuevamente esta funcion para que guarde las pestañas leidas sin necesidad de hacer clic en grabar
		marcarRegistrosLeidos( $conex, $wbasedato, $wbasedatohce, $usuario->codigo, $paciente->historiaClinica, $paciente->ingresoHistoriaClinica, $pestanasVistas); 
		
		cargarInfusionesADefinitivo($paciente->historiaClinica,$paciente->ingresoHistoriaClinica,$wfechagrabacion);
		cargarArticulosADefinitivo($paciente->historiaClinica,$paciente->ingresoHistoriaClinica,$wfechagrabacion,$esPrimerKardex,$firmaDigital);
		cargarExamenesADefinitivo($paciente->historiaClinica,$paciente->ingresoHistoriaClinica,$wfechagrabacion,$firmaDigital);
		cargarDietasADefinitivo($paciente->historiaClinica,$paciente->ingresoHistoriaClinica,$wfechagrabacion,$firmaDigital);
		actualizarUsuarioDextrometer( $conex, $wbasedato,$paciente->historiaClinica,$paciente->ingresoHistoriaClinica,$wfechagrabacion,$usuario->codigo,$firmaDigital);	
		cargarMedicoADefinitivo($paciente->historiaClinica,$paciente->ingresoHistoriaClinica,$wfechagrabacion);
		
		cargarProcedimientosTemporalADetalle( $paciente->historiaClinica, $paciente->ingresoHistoriaClinica );
		eliminarDatoTemporalProcedimiento( $wbasedato,$wbasedatohce, $paciente->historiaClinica, $paciente->ingresoHistoriaClinica );	
	}
	
	$_SESSION['wordenes'] = 0; //Asigna a la variable de sesion wordenes el valor de 0 para que el usuario pueda ingresar a otra orden.
	
	echo json_encode($datamensaje);
    return;
 }
 
 
/**
 * Valida si la contraseña escrita conincide con el usuario que esta realizando la orden. Jonatan Lopez / Mayo 8 2014.
 */ 
function validarusuarioycontrasena( $wemp_pmla, $wusuario_aux, $wpassword_aux ){

	global $conex;
	global $whce;
	global $basedatos;
	
	$datamensaje = array('mensaje'=>'', 'error'=>0); 	
	
	//Consulto en la tabla de usuarios hce.
	$sql = "SELECT usucod
			  FROM ".$whce."_000020
			 WHERE usucod = '".$wusuario_aux."'
			   AND usucla = '".$wpassword_aux."'
			   AND usuest = 'on'";			   
	$res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$num = mysql_num_rows( $res );	
	
	if($num > 0){
		$datamensaje['error'] = 1;
		$datamensaje['mensaje'] = "La firma no coincide con el usuario que esta realizando la orden.";
	}else{
		$datamensaje['error'] = 0;
		$datamensaje['mensaje'] = "La firma coincide con el usuario que esta realizando la orden.";
	}
	
	
	echo json_encode($datamensaje);
    return;

}
 
 
/**
 * Elimina la temporal de procedimientos al grabar ordenes
 */
function eliminarDatoTemporalProcedimiento( $wbasedato, $whce, $his, $ing ){

	global $conex;
		
	//Elimino todos los examenes sin firmar de la temporal
	//No se elimina del detalle por que en el detalle están todos los registros firmados
	$sql = "DELETE b FROM ".$whce."_000027 a, ".$wbasedato."_000159 b
			 WHERE a.ordhis = '".$his."'
			   AND a.ording = '".$ing."'
			   AND a.ordtor = dettor
			   AND a.ordnro = detnro
			   AND b.detfir = ''";
			   
	$res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	// $num = mysql_num_rows( $res );
	
	
	//Elimino de la temporal de procedimientos aquellos procedimientos que no sean de la fecha actual de ordenes
	$sql = "DELETE b FROM ".$whce."_000027 a, ".$wbasedato."_000159 b
			 WHERE a.ordhis = '".$his."'
			   AND a.ording = '".$ing."'
			   AND ordfec != '".date( "Y-m-d" )."'
			   AND a.ordtor = dettor
			   AND a.ordnro = detnro
			   ";
			   
	$res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	// $num = mysql_num_rows( $res );
	
	//Elimino los encabezados sin detalle de procedimientos
	$sql = "DELETE a FROM ".$whce."_000027 a
			 WHERE a.ordhis = '".$his."'
			   AND a.ording = '".$ing."'
			   AND a.ordtor NOT IN( 
						SELECT dettor
						  FROM ".$whce."_000028 b
						 WHERE ordtor = dettor
						   AND ordnro = detnro
						 UNION
						SELECT dettor
						  FROM ".$wbasedato."_000159  b
						 WHERE ordtor = dettor
						   AND ordnro = detnro
			   )";
			   
	$res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	// $num = mysql_num_rows( $res );
	
	
	$q = "  DELETE b FROM ".$whce."_000027 a, ".$wbasedato."_000159 b, ".$whce."_000028 c
		     WHERE a.ordhis = '".$his."'
			   AND a.ording = '".$ing."'
			   AND ordtor = b.dettor
			   AND ordnro = b.detnro
			   AND c.dettor = b.dettor
			   AND c.detnro = b.detnro
			   AND c.detite = b.detite
			   ";
			   
	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	
}

/****************************************************************************************************
 * Carga todos los procedimientos de la temporal al Detalle de procedimientos
 ****************************************************************************************************/
function cargarProcedimientosTemporalADetalle( $his, $ing ){

	global $conex;
	global $whce;
	global $user;
	global $basedatos;
	
	//Se consulta si no hay examenes o procedimientos en la temporal
	$sql = "SELECT Dettor, Detnro, Detite
			  FROM ".$whce."_000027 a, ".$basedatos."_000159 b
			 WHERE ordtor = dettor
			   AND ordnro = detnro
			   AND ordhis = '$his'
			   AND ording = '$ing'";
			   
			   
	$res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$num = mysql_num_rows( $res );
	
	while( $rows = mysql_fetch_array( $res ) ){
	
		cargarProcedimientosTemporalADetalleItem( $rows[ 'Dettor' ], $rows[ 'Detnro' ], $rows[ 'Detite' ] );
	}
}

function cargarProcedimientosTemporalADetalleItem( $tipoOrden, $nroOrden, $numeroItem ){
	
	global $conex;
	global $whce;
	global $user;
	global $basedatos;
	
	$datamensaje = array('mensaje'=>'', 'error'=>0); 	
	
	//Se consulta si no hay examenes o procedimientos en la temporal
	$sql = "SELECT a.Medico
			  FROM ".$whce."_000027 a, ".$whce."_000028 b
			 WHERE ordtor = dettor
			   AND ordnro = detnro
			   AND dettor = '".$tipoOrden."'
			   AND detnro = '".$nroOrden."'
			   AND detite = '".$numeroItem."'";
			   
	$res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$num = mysql_num_rows( $res );
	
	if($num == 0){
		
		//Busco el codigo para articulo nuevo
		$q_log_n = "SELECT Logcod
					FROM ".$basedatos."_000174
					WHERE Lognue = 'on'
					  AND Logest = 'on'";
		$res_log_n = mysql_query($q_log_n, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q_log_n . " - " . mysql_error());
		$row_log_n = mysql_fetch_array($res_log_n);
		$cod_log_nuevo = $row_log_n['Logcod'];
		
		
		//Si no hay registros en la tabla de detalle de examenes se inserta
		$sql = "INSERT INTO ".$whce."_000028( Medico, Fecha_data, Hora_data, Dettor, Detnro, Detcod, Detesi, Detrdo, Detfec, Detjus, Detest, Detite, Detusu, Detfir, Deture, Detalt, Detimp, Detifh, Detusp, Detpen, Detule, Detfle, Dethle, Detfmo, Dethmo, Detlog, Detenv, Detutm, Detcco, Detftm, Dethtm, Seguridad )
				SELECT '$whce' as Medico,         b.Fecha_data, b.Hora_data, Dettor, Detnro, Detcod, Detesi, Detrdo, Detfec, Detjus, Detest, Detite, Detusu, Detfir, Deture, Detalt, Detimp, Detifh, Detusp, Detpen, Detule, Detfle, Dethle, Detfmo, Dethmo, Detlog, Detenv, Detutm, Detcco, Detftm, Dethtm, 'C-$whce' as Seguridad
				  FROM ".$whce."_000027 a, ".$basedatos."_000159 b
				 WHERE a.ordtor = dettor
				   AND a.ordnro = detnro
				   AND dettor = '".$tipoOrden."'
				   AND detnro = '".$nroOrden."'
				   AND detite = '".$numeroItem."'
				   AND b.Detfir != ''";
		
		$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query - ".mysql_error() );
		
		//Si hay ordenes anexadas desmarco las ordenes anexada para que no se pueda volver a ordenar medicamentos
		$sql = "UPDATE ".$whce."_000027 a, ".$whce."_000027 c
				   SET c.ordanx = 'off'
				 WHERE a.ordtor = '".$tipoOrden."'
				   AND a.ordnro = '".$nroOrden."'
				   AND c.ordtor = a.ordtor
				   AND c.ordnro = a.ordana";
		
		$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query - $sql".mysql_error() );
	}
	else{
		
		//Se actualiza el registro de la tabla hce_000028
		$sql = "UPDATE ".$whce."_000028 a, ".$basedatos."_000159 b
				   SET a.Detjus = b.Detjus,
				       a.Detest = b.Detest,
					   a.Detfir = b.Detfir,
					   a.Detifh = b.Detifh,
					   a.Detesi = b.Detesi,
					   a.Detfec = b.Detfec,
					   a.Detusp = b.Detusp,
					   a.Detpen = b.Detpen,
					   a.Detule = b.Detule,
					   a.Detfle = b.Detfle,
					   a.Dethle = b.Dethle,
					   a.Detfmo = b.Detfmo,
					   a.Dethmo = b.Dethmo,
					   a.Detlog = b.Detlog,
					   a.Detenv = b.Detenv,
					   a.Detutm = b.Detutm,
					   a.Detftm = b.Detftm,
					   a.Dethtm = b.Dethtm
				 WHERE a.dettor = '".$tipoOrden."'
				   AND a.detnro = '".$nroOrden."'
				   AND a.detite = '".$numeroItem."'
				   AND a.dettor = b.dettor
				   AND a.detnro = b.detnro
				   AND a.detite = b.detite
				   AND b.Detfir != ''";
		
		$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query - ".mysql_error() );
	}
	
	
	
	echo json_encode($datamensaje);
    return;
	
	
}

/************************************************************************************
 * Pasa los procedimientos de la tabla de detalle a la temporal
 ************************************************************************************/
function cargarProcedimientosDetalleATemporal( $conex, $wbasedato, $wmovhos, $his, $ing, $fecha ){

	//Elimino todos los examenes sin firmar de la temporal
	//No se elimina del detalle por que en el detalle están todos los registros firmados
	$sql = "DELETE b FROM ".$wbasedato."_000027 a, ".$wmovhos."_000159 b
			 WHERE a.ordhis = '".$his."'
			   AND a.ording = '".$ing."'
			   AND a.ordtor = dettor
			   AND a.ordnro = detnro
			   AND b.detfir = ''";
			   
	$res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	// $num = mysql_num_rows( $res );
	
	
	//Elimino de la temporal de procedimientos aquellos procedimientos que no sean de la fecha actual de ordenes
	$sql = "DELETE b FROM ".$wbasedato."_000027 a, ".$wmovhos."_000159 b
			 WHERE a.ordhis = '".$his."'
			   AND a.ording = '".$ing."'
			   AND ordfec != '".date( "Y-m-d" )."'
			   AND a.ordtor = dettor
			   AND a.ordnro = detnro
			   ";
			   
	$res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	// $num = mysql_num_rows( $res );
	
	//Elimino los encabezados sin detalle de procedimientos
	$sql = "DELETE a FROM ".$wbasedato."_000027 a
			 WHERE a.ordhis = '".$his."'
			   AND a.ording = '".$ing."'
			   AND a.ordtor NOT IN( 
						SELECT dettor
						  FROM ".$wbasedato."_000028 b
						 WHERE ordtor = dettor
						   AND ordnro = detnro
						 UNION
						SELECT dettor
						  FROM ".$wmovhos."_000159  b
						 WHERE ordtor = dettor
						   AND ordnro = detnro
			   )";
			   
	$res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	// $num = mysql_num_rows( $res );
	
	
	//Se consulta si no hay examenes o procedimientos en la temporal
	$sql = "SELECT a.Medico
			  FROM ".$wbasedato."_000027 a, ".$wmovhos."_000159 b
			 WHERE a.ordhis = '".$his."'
			   AND a.ording = '".$ing."'
			   AND a.ordtor = dettor
			   AND a.ordnro = detnro
			   AND b.detest = 'on'";			
	$res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$num = mysql_num_rows( $res );
	
	if($num == 0){
		
		//Si la temporal está vacía se llena la temporal
		$sql = "INSERT INTO ".$wmovhos."_000159( Medico, Fecha_data, Hora_data, Dettor, Detnro, Detcod, Detesi, Detrdo, Detfec, Detjus, Detest, Detite, Detusu, Detfir, Deture, Detalt, Detimp, Detifh,Detusp, Detpen, Detule, Detfle, Dethle, Detfmo, Dethmo, Detpri, Detlog, Detenv, Detutm, Detcco, Detftm, Dethtm, Seguridad )
				SELECT '$wmovhos' as Medico,         b.Fecha_data, b.Hora_data, Dettor, Detnro, Detcod, Detesi, Detrdo, Detfec, Detjus, Detest, Detite, Detusu, Detfir, Deture, Detalt, Detimp, Detifh,Detusp, Detpen, Detule, Detfle, Dethle, Detfmo, Dethmo, Detpri, Detlog, Detenv, Detutm, Detcco, Detftm, Dethtm, 'C-$wmovhos' as Seguridad
				  FROM ".$wbasedato."_000027 a, ".$wbasedato."_000028 b
				 WHERE a.ordhis = '".$his."'
				   AND a.ording = '".$ing."'
				   AND a.ordtor = dettor
				   AND a.ordnro = detnro";
		
		$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query - ".mysql_error() );
	}
}


/****************************************************************************************************************
 * Crea el encabezado del kardex por una llamada ajax
 ****************************************************************************************************************/
function crearEncabezadoKardexCerrar( $his, $ing, $firmaDigital, $confirmado, $fechaKardex, $cco = '' ){

	global $conex;
	global $whce;
	global $basedatos;
	global $user;
	
	global $wbasedato;
	global $usuario;
	$wbasedato = $basedatos;
	
	$wfecha = $fechaKardex;
	
	$wuser = substr($user, (strpos($user, "-") + 1), strlen($user));
	
	@$usuario = consultarUsuarioOrdenes($wuser);
	
	if( !empty($cco) ){
		$usuario->centroCostosGrabacion = $cco;
	}
	
	$kardexGrabar = new kardexDTO();
	
	if($confirmado == 'off'){
		
		$kardexGrabar->confirmado = 'off';
		
	}else{
		
		$kardexGrabar->confirmado = 'on';
	}
	
	//Captura de parametros. Encabezado del kardex
	$kardexGrabar->historia = $his;
	$kardexGrabar->ingreso = $ing;
	$kardexGrabar->fechaCreacion = $wfecha;
	$kardexGrabar->horaCreacion = date("H:i:s");
	$kardexGrabar->fechaGrabacion = $wfecha;
	$kardexGrabar->usuario = $wuser;	
	$kardexGrabar->esPrimerKardex = false;
	$kardexGrabar->centroCostos = $usuario->centroCostosGrabacion;			
	$kardexGrabar->usuarioQueModifica = $usuario->codigo;
	$kardexGrabar->firmaDigital = $firmaDigital;
	$kardexGrabar->noAcumulaSaldoDispensacion = false;
	
	if(!existeEncabezadoKardex($his,$ing,$wfecha)){
		crearKardex( $kardexGrabar, 'off' );	
		$mensaje = "El kardex ha sido creado con éxito";
	} else {
		//Actualiza SOLO encabezado
		@actualizarKardex($kardexGrabar,$vecPestanaGrabacion, 'off' );
		$mensaje = "El kardex ha sido actualizado con éxito";
	}
}

/************************************************************************************************
 * Consulta Dxs según el CIE 10
 ************************************************************************************************/
function consultarDxCie10( $imp ){

		global $conex;
		
		

		
		$val = ""; 

		//Diagnostico
		$sql = "SELECT Codigo, Descripcion
				FROM root_000011
				WHERE (Descripcion LIKE '%".utf8_decode($imp)."%' or Codigo like '%".utf8_decode($imp)."%')
				ORDER BY Descripcion
				";
				
		$res = mysql_query( $sql, $conex )  or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
		$num = mysql_num_rows( $res );
				
		if( $num > 0 ){
			
			for( $i = 0; $rows = mysql_fetch_array( $res ); $i++ ){
			
					$rows[ 'Codigo' ] = trim( utf8_encode($rows[ 'Codigo' ]) );
					$rows[ 'Descripcion' ] = trim( utf8_encode($rows[ 'Descripcion' ] ) );
				
					//Creo el resultado como un json
					//Primero creo un array con los valores necesarios
					$data[ 'valor' ] = Array( "cod"=> $rows[ 'Codigo' ], "des"=> $rows[ 'Descripcion' ] );	//Este es el dato a procesar en javascript
					$data[ 'usu' ] = "{$rows[ 'Codigo' ]}-{$rows[ 'Descripcion' ]}";	//Este es el que ve el usuario
					$dat = Array();
					$dat[] = $data;
					
					$val .= json_encode( $dat )."\n";
				
			}
		}
		
		return $val;
}
 
 
function consultarCamposHCEHistorico( $wemp_pmla, $conex, $wmovhos, $whce, $aplicacion, $his, $ing ){

	$val = "";//array();

	$datosHCE = consultarAliasPorAplicacion( $conex, $wemp_pmla, $aplicacion );
	
	$exp = explode( ",", $datosHCE );
	
	if( !empty($exp) && count($exp) > 0 ){
		
		$i = 0;
		foreach( $exp as $key => $value ){
			
			//Los campos estan separados por - en el siguiente orden tabla-label-valor
			list( $tabla, $campo ) = explode( "-", $value );
			
			if( !empty($tabla) ){
			
				if( $i > 0 ){
					$sql .= " UNION ";
				}
				
				$sql .= "SELECT
							Fecha_data, Hora_data, Movdat
						FROM
							{$whce}_{$tabla}
						WHERE
							movhis = '$his'
							AND moving = '$ing'
							AND movcon = '$campo'
						";
			}
			$i++;
		}
		
		$sql .= " ORDER BY fecha_data ASC, Hora_data ASC";
		
		$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
		
		while( $rows = mysql_fetch_array($res) ){
			$val .= "\n".$rows[ 'Movdat' ];
		}
	}
	
	return trim( $val );
}
 

function consultarCamposHCEHistoricoAelergicos( $wemp_pmla, $conex, $wmovhos, $whce, $aplicacion, $his, $ing ){

	$val = "";//array();

	$datosHCE = consultarAliasPorAplicacion( $conex, $wemp_pmla, $aplicacion );
	
	$exp = explode( ",", $datosHCE );
	
	if( !empty($exp) && count($exp) > 0 ){
		
		$i = 0;
		foreach( $exp as $key => $value ){
			
			//Los campos estan separados por - en el siguiente orden tabla-label-valor
			list( $tabla, $campo, $activo ) = explode( "-", $value );
			
			if( !empty($tabla) ){
			
				if( $i > 0 ){
					$sql .= " UNION ";
				}
				
				$sql .= "SELECT
							Fecha_data, Hora_data, Movdat
						FROM
							{$whce}_{$tabla} a
						WHERE
							movhis = '$his'
							AND moving = '$ing'
							AND movcon = '$campo'
							AND movhis  IN(
								SELECT
									b.movhis
								FROM
									{$whce}_{$tabla} b
								WHERE
									b.movhis = a.movhis
									AND b.moving = a.moving
									AND b.fecha_data =  a.fecha_data
									AND b.hora_data = a.hora_data
									AND b.movcon = '$activo'
									AND movdat = 'CHECKED'
							)
						";
			}
			$i++;
		}
		
		$sql .= " ORDER BY fecha_data ASC, Hora_data ASC";
		
		$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
		
		while( $rows = mysql_fetch_array($res) ){
			$val .= "\n".$rows[ 'Movdat' ];
		}
	}
	
	return trim( $val );
} 

function consultarCamposHCE( $wemp_pmla, $conex, $wmovhos, $whce, $aplicacion, $his, $ing ){

	$val = "";//array();

	$datosHCE = consultarAliasPorAplicacion( $conex, $wemp_pmla, $aplicacion );
	
	$exp = explode( ",", $datosHCE );
	
	if( !empty($exp) && count($exp) > 0 ){
		
		$i = 0;
		foreach( $exp as $key => $value ){
			
			//Los campos estan separados por - en el siguiente orden tabla-label-valor
			list( $tabla, $campo ) = explode( "-", $value );
			
			if( !empty($tabla) ){
			
				if( $i > 0 ){
					$sql .= " UNION ";
				}
				
				$sql .= "SELECT
							Fecha_data, Hora_data, Movdat
						FROM
							{$whce}_{$tabla}
						WHERE
							movhis = '$his'
							AND moving = '$ing'
							AND movcon = '$campo'
						";
			}
			$i++;
		}
		
		$sql .= " ORDER BY fecha_data DESC, Hora_data DESC";
		
		$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
		
		if( $rows = mysql_fetch_array($res) ){
			$val = $rows[ 'Movdat' ];
		}
	}
	
	return $val;
}
 
/****************************************************************************************************************
 * Consulta datos de la historica Clínica y devuelve el label asociado al campo que se desea consultar
 ****************************************************************************************************************/
function consultarCampoHCELabelValor( $wemp_pmla, $conex, $wmovhos, $whce, $aplicacion, $his, $ing ){

	$val = "";//array();

	$datosHCE = consultarAliasPorAplicacion( $conex, $wemp_pmla, $aplicacion );
	
	$exp = explode( ",", $datosHCE );
	
	if( !empty($exp) && count($exp) > 0 ){
		
		foreach( $exp as $key => $value ){
			
			//Los campos estan separados por - en el siguiente orden tabla-label-valor
			list( $tabla, $campo, $label ) = explode( "-", $value );
			
			if( !empty($tabla) ){
				
				$sql = "SELECT	*
						  FROM {$whce}_{$tabla}
						 WHERE movhis = '$his'
						   AND moving = '$ing'
						   AND movcon = '$campo'
						   AND movdat LIKE '%Si'";				
				$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
				
				//Si se encuentra el dato busco el label para agregarlo
				if( mysql_num_rows( $res ) > 0 ){
				
					//Consulto el valor del Memo
					$sql = "SELECT *
							  FROM {$whce}_{$tabla}
							 WHERE movhis = '$his'
							   AND moving = '$ing'
							   AND movcon = '$label'";					
					$resMemo = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
					
					//Si se encuentra el dato busco el memo para agregarlo
					$memo = '';
					if( $rowsMemo = mysql_fetch_array( $resMemo ) ){
						$memo = $rowsMemo[ 'movdat' ];
					}
				
					$sqlLabel = "SELECT *
								   FROM {$whce}_000002
								  WHERE	Detpro = '$tabla'
									AND Detcon = '$campo'";					
					$resLabel = mysql_query( $sqlLabel, $conex ) or die( mysql_errno()." - Error en el query $sqlLabel - ".mysql_error() );
					if( $rows = mysql_fetch_array($resLabel) ){
						$val .= "\n".$rows[ 'Detdes' ].": ".$memo;
					}
				}
			}
		}
	}
	
	return $val;
}
 

function consultarDxs( $conex, $wemp_pmla, $whce, $his, $ing ){
	
	return consultarUltimoDiagnosticoHCE( $conex, $wemp_pmla, $whce, $his, $ing );

	// $val = "";

	// $camposRoot = consultarAliasPorAplicacion( $conex, $wemp_pmla, "dxsHce" );

	// if( !empty( $camposRoot ) ){
		
		// $campos = explode( ",", $camposRoot );
		
		// for( $i = 0; $i < count( $campos ); $i++ ){
		
			// list( $tabla, $cmp ) = explode( "-", $campos[$i] );
			
			// if( $i > 0 ){
				// $sql .= " UNION ";
			// }
			
			// $sql .= "SELECT
						// *
					// FROM
						// {$whce}_{$tabla}
					// WHERE
						// movhis = '$his'
						// AND moving = '$ing'
						// AND movcon = '$cmp'
					// ";
		// }
		
		// $sql .= " ORDER BY fecha_data DESC, hora_data DESC";
		
		// $res = mysql_query( $sql , $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
		
		// // for( $i = 0; $rows = mysql_fetch_array( $res ); $i++ ){
		// $i = 0;
		// if( $rows = mysql_fetch_array( $res ) ){
			
			// //Se hace de está manera por que el campo dxs de HCE puede ser tipo tabla
			// //El tipo tabla es un campo SELECT de HTML con selección multiple.
			// //Por tanto en el campo movdat puede haber varios options
			// //En el caso de que el campo sea tipo seleccion solo hay un option
			// $str = explode( "<option", trim( $rows[ 'movdat' ] ) );
			// foreach( $str as $valor )
			// {
				// if( !empty($valor) ){
					// if( $i == 0 ){
						// $val .= trim( strip_tags( trim( "<option".$valor ) ) );
					// }
					// else{
						// $val .= "\n".trim( strip_tags( trim( "<option".$valor ) ) );
					// }
					// $i++;
					// break;
				// }
			// }
			
			// // if( trim( strip_tags( trim( $rows[ 'movdat' ] ) ) ) != '' ){
				// // // echo "<br>".trim( strip_tags( trim( $rows[ 'movdat' ] ) ) );
				// // if( $i == 0 ){
					// // $val .= trim( strip_tags( trim( $rows[ 'movdat' ] ) ) );
				// // }
				// // else{
					// // $val .= "\n".trim( strip_tags( trim( $rows[ 'movdat' ] ) ) );
				// // }
			// // }
		// }
	// }
	
	// return $val;
}

 
// function consultarFormularioHCE($basedatoshce,$formTipoOrden,$historia,$ingreso)
// {
	// $conexion = obtenerConexionBD("matrix");

	// echo $q = "SELECT
			// movpro
		// FROM
			// {$basedatoshce}_{$formTipoOrden}
		// WHERE 
			// movhis = '".$historia."'
		// AND moving = '".$ingreso."' ";

	// $res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	// $num = mysql_num_rows($res);

	// if($num > 0)
		// return 'ok';
	// else
		// return 'no-data';
// }

function consultarFormularioHCE($basedatoshce,$formTipoOrden,$historia,$ingreso)
{
	$conexion = obtenerConexionBD("matrix");
	
	$num = false;
		
	$sql = "SELECT
				id
			FROM
				{$basedatoshce}_000036
			WHERE 
				Firpro = '{$formTipoOrden}'
			AND Firhis = '".$historia."'
			AND Firing = '".$ingreso."' 
			AND fecha_data='".date( "Y-m-d" )."'
			ORDER BY
				Fecha_data DESC, Hora_data DESC
		";

	$res = mysql_query($sql, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
	
	if( $rows = mysql_fetch_array( $res ) ){
		$num = $rows[ 'id' ];
		if($num != ''){
		
		$num = 'ok';
		}
	}
		
	return $num;
}
 
function consultarAyudasDiagnosticasPorTipo($basedatos,$tipoServicio = '%',$especialidad){
	
	// $nombre,$unidadRealiza
	
	global $conex;
	global $codigoAyudaHospitalaria;
	global $whce;
	global $wemp_pmla;

	$esHospitalario = "off";
	$consecutivo = "1";
	$auxConsecutivoAyudaHospitalaria = "1";

	$q = "SELECT
			Codigo,Descripcion,Servicio,Tipoestudio,Anatomia,Codcups,Estado,Ccocor cons,Cconom, (SELECT tiprju FROM {$whce}_000015 c WHERE c.codigo = Tipoestudio) reqJus, NoPos, (SELECT Tipgoi FROM {$whce}_000015 c WHERE c.codigo = Tipoestudio) Tipgoi 
		FROM
			{$whce}_000047 LEFT JOIN {$basedatos}_000011 ON Ccocod = Servicio
		WHERE
			Estado = 'on'			
			AND Tipoestudio LIKE '$tipoServicio'
			AND Tipoestudio IN (SELECT codigo FROM {$whce}_000015 c WHERE c.codigo = Tipoestudio)
			AND Tipoestudio NOT IN (
				SELECT
					Toetip
				FROM
					{$whce}_000045
				WHERE
					Toeesp != '".$especialidad."' 
				AND Toeest = 'on'			
				)
		UNION
		SELECT
			Codigo,Descripcion,Servicio,Tipoestudio,Anatomia,Codcups,Estado,Ccocor cons,Cconom, (SELECT tiprju FROM {$whce}_000015 c WHERE c.codigo = Tipoestudio) reqJus, NoPos, (SELECT Tipgoi FROM {$whce}_000015 c WHERE c.codigo = Tipoestudio) Tipgoi 
		FROM
			{$whce}_000017 LEFT JOIN {$basedatos}_000011 ON Ccocod = Servicio
		WHERE
			Estado = 'on'			
			AND Tipoestudio LIKE '$tipoServicio'
			AND Tipoestudio IN (SELECT codigo FROM {$whce}_000015 c WHERE c.codigo = Tipoestudio)
			AND Tipoestudio NOT IN (
				SELECT
					Toetip
				FROM
					{$whce}_000045
				WHERE
					Toeesp != '".$especialidad."' 
				AND Toeest = 'on'			
				)
			AND nuevo = 'on'
			;";
	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	//Consecutivo de ayudas hospitalarias
	//NO QUEMAR EL NRO EMPRESA
	$q2 = "SELECT
				Detval 
			FROM 
				root_000051
			WHERE
				Detemp = '$wemp_pmla'			
				AND Detapl = 'consecutivoAyudasHospitalarias';";

	$res2 = mysql_query($q2, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());
	$num2 = mysql_num_rows($res2);

	if($rs2 = mysql_fetch_array($res2)){
		$consecutivo = $rs2['Detval'];
		$auxConsecutivoAyudaHospitalaria = $rs2['Detval']; 
	}

	while ($rs = mysql_fetch_array($res)){
		//		$referencia = "seleccionarAyudaDiagnostica('".$rs['Servicio']."','".$rs['Codigo']."','".str_replace(" ","_",trim(htmlentities($rs['Descripcion'])))."','".str_replace(" ","_",trim(htmlentities($rs['Tipoestudio'])))."','".str_replace(" ","_",trim(htmlentities($rs['Anatomia'])))."','".str_replace(" ","_",trim(htmlentities($rs['Codcups'])))."','".str_replace(" ","_",trim(htmlentities($rs['cons'])))."','".str_replace(" ","_",trim(htmlentities($rs['Cconom'])))."');";
		//		$consulta = $consulta."<a href='#null' onclick=$referencia>".htmlentities($rs['Descripcion']).'</a><br/>';

		if(!empty($rs['Servicio']) && $rs['Servicio'] == $codigoAyudaHospitalaria){
			$esHospitalario = "on";
			$consecutivo = $auxConsecutivoAyudaHospitalaria;
		} else {
			$consecutivo = @$rs['cons'];
		}
		
		if( empty( $rs['reqJus'] ) ){
			$rs['reqJus'] = "off";
		}

		echo htmlentities(@$rs['Descripcion']).",".@$rs['Servicio'].",".@$rs['Codigo'].",".str_replace(" ","_",trim(htmlentities(@$rs['Descripcion']))).",".str_replace(" ","_",trim(htmlentities(@$rs['Tipoestudio']))).",".str_replace(" ","_",trim(htmlentities(@$rs['Anatomia']))).",".str_replace(" ","_",trim(htmlentities(@$rs['Codcups']))).",".@$consecutivo.",".str_replace(" ","_",trim(htmlentities(@$rs['Cconom']))).",".@$esHospitalario.",".@$rs['reqJus'].",".@$rs['NoPos'].",".@$rs['Tipgoi'].",\n";
	}
	//	return $consulta;
}
 
//Consulta si el tipo de orden tiene asociado u formulario de historia clínica electrónica
function consultarFormularioTipoOrden($basedatoshce,$wtipo)
{
	$conexion = obtenerConexionBD("matrix");

	$q = "SELECT
			Tipfrm
		FROM
			{$basedatoshce}_000015
		WHERE 
			Codigo = '".$wtipo."'
		AND Estado = 'on' ";

	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if($num > 0)
	{
		$rs = mysql_fetch_array($res);
		$formulario = $rs['Tipfrm'];
	}
	else
	{
		$formulario = "";
	}
	
	return $formulario;
}


function borrarFormularioHCE($basedatoshce,$wcco,$historia,$ingreso, $firmHce )
{
	$conexion = obtenerConexionBD("matrix");
	$formulario = "";

	// Consulto el tipo de orden
	$q = "SELECT
			a.Tipfrm
		FROM
			{$basedatoshce}_000015 a, {$basedatoshce}_000017 b
		WHERE 
			a.Codigo = b.Tipoestudio
		AND b.Servicio = '".$wcco."'
		AND a.Estado = 'on' 
		AND b.Estado = 'on'";

	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if($num > 0)
	{
		$rs = mysql_fetch_array($res);
		$formulario = trim( $rs['Tipfrm'] );
	}
	
	if($formulario != "")
	{			
		$q="DELETE a
			FROM {$basedatoshce}_{$formulario} a, {$basedatoshce}_000036 b
			WHERE 
				movhis = '".$historia."'
			AND moving = '".$ingreso."' 
			AND a.fecha_data = b.fecha_data
			AND a.hora_data = b.hora_data
			AND b.id = '$firmHce'
			";

		$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	}
	
	return 'ok';
}

function articuloTipoPos( $conex, $wbasedato, $articulo ){

	
	$sql = "SELECT Artpos
			  FROM {$wbasedato}_000026
			 WHERE artest = 'on' 
			   AND artcod = '".$articulo."'";				
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$row = mysql_fetch_array($res);
	
	return $row['Artpos'];
}
 
function esProductoNoPOSCM( $conex, $wbasedato, $wcenmez, $producto ){

	$val = false;
	
	$sql = "SELECT
				*
			FROM
				{$wcenmez}_000003 a, {$wcenmez}_000009 b, {$wbasedato}_000026 c
			WHERE
				pdepro='$producto'
				AND pdeins = appcod
				AND pdeest = 'on'
				AND apppre = artcod
				AND artpos = 'N'
				AND artest = 'on' ";
				
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$num = mysql_num_rows( $res );
	
	if( $num > 0 ){
		$val = true;
	}
	
	return $val;
}
 
 /**************************************************************************************************
 * Dice si un paciente tiene medicamentos activos para un dia
 **************************************************************************************************/
function tieneMedicamentosActivos( $conex, $wbasedato, $wcenmez, $historia, $ingreo, $cco, $fechaKardex ){

	$val = false;
	$conArts = cargarMedicamentosActivosAnterior( $conex, $wbasedato, $wcenmez, $historia, $ingreo, $cco, $fechaKardex );
	
	if( !empty($conArts) ){
		$val = true;
	}
	
	return $val;
}
 
/************************************************************************
 * Junio 15 de 2012
 *
 * Trae del día anterior medicamentos que quedaron activos el día 
 * anterior( No fueron suspendidos, para el día actual )
 ************************************************************************/
function cargarMedicamentosActivosAnterior( $conex, $wbasedato, $wcenmez, $historia, $ingreo, $cco, $fechaKardex )
{
	$val = "";

	//Consulto los medicamentos del día anterior
	$sql = "SELECT Artcod, Artcom, Kadori,Artgru,Kadffa,Artuni,Artpos,Kadufr,Kadcma,Defven,Defdie,Defdis,Defdup,Defdim,Defdom,Defvia,Kadpro,Kadess,Kadfin,Kadhin,Kadcfr,Kadper,Kadcnd,Kadcon,Kaddia,Kaddma,Kadvia 
			FROM 
				{$wbasedato}_000054 a, {$wbasedato}_000011 d, {$wbasedato}_000059 b, {$wbasedato}_000026 c
			WHERE
				kadhis = '$historia'
				AND kading = '$ingreo'
				AND kadfec = '$fechaKardex'
				AND kadcco = '$cco'
				AND kadsus != 'on'
				AND kadest = 'on'
				AND artcod = kadart
				AND artest = 'on'
				AND defart = artcod
				AND defest = 'on'
				AND ccocod = defcco
				AND ccoima != 'on'
			UNION
			SELECT Artcod, Artcom, Kadori,'' as Artgru,Kadffa,Artuni,'' as Artpos,Kadufr,Kadcma,Defven,Defdie,Defdis,Defdup,Defdim,Defdom,Defvia,Kadpro,Kadess,Kadfin,Kadhin,Kadcfr,Kadper,Kadcnd,Kadcon,Kaddia,Kaddma,Kadvia 
			FROM 
				{$wbasedato}_000054 a, {$wbasedato}_000011 d, {$wbasedato}_000059 b, {$wcenmez}_000002 c, {$wcenmez}_000001 e
			WHERE
				kadhis = '$historia'
				AND kading = '$ingreo'
				AND kadfec = '$fechaKardex'
				AND kadcco = '$cco'
				AND kadsus != 'on'
				AND kadest = 'on'
				AND artcod = kadart
				AND artest = 'on'
				AND defart = artcod
				AND defest = 'on'
				AND ccocod = defcco
				AND ccoima = 'on'
				AND arttip = tipcod
				AND tipcdo != 'on'
			";
			
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$num = mysql_num_rows( $res );
	
	if( $num > 0 ){
	
		for( $i = 0; $rs = mysql_fetch_array( $res ); $i++ ){
		
			$newFecHorIni = strtotime( date( "Y-m-d" )." ".$rs[ 'Kadhin' ] );
			
			//Si la fecha y hora de inicio es menor a la fecha actual, busco la siguiente hora par mas cercana
			if( time() > $newFecHorIni ){
				$horaPar = floor( date( "H", time()*2*3600 )/2 )*2*3600;
				
				$rs[ 'Kadfin' ] = date( "Y-m-d", time()+3600*2 );
				$rs[ 'Kadhin' ] = gmdate( "H:i:s", $horaPar );
			}
			else{
				$rs[ 'Kadfin' ] = date( "Y-m-d" );
			}
			
			//				0										1											2						3																4						5				6					7					8						9					10				11						12				13					14					15					16						17						18					19					20							21					22					23						24						25					26		
			$val .= "@".$rs['Artcod']."','".str_replace(" ","_",trim(htmlentities($rs['Artcom'])))."','".$rs['Kadori']."','".trim( substr( $rs['Artgru'], 0, strpos( $rs['Artgru'], '-' ) ) )."','".$rs['Kadffa']."','".$rs['Artuni']."','".$rs['Artpos']."','".$rs['Kadufr']."','".$rs['Kadcma']."','".$rs['Defven']."','".$rs['Defdie']."','".$rs['Defdis']."','".$rs['Defdup']."','".$rs['Defdim']."','".$rs['Defdom']."','".$rs['Defvia']."','".$rs[ 'Kadpro' ]."','".$rs[ 'Kadess' ]."','".$rs[ 'Kadfin' ]."','".$rs[ 'Kadhin' ]."','".$rs[ 'Kadcfr' ]."','".$rs[ 'Kadper' ]."','".$rs[ 'Kadcnd' ]."','".$rs[ 'Kadcon' ]."','".$rs[ 'Kaddia' ]."','".$rs[ 'Kaddma' ]."','".$rs[ 'Kadvia' ];
		}
		
		$val = substr( $val, 1 );
	}
	
	return $val;
}
 
/********************************************************************************************************************************************
 * Busca medicamento por codigo para la contingencia del kardex
 ********************************************************************************************************************************************/
function consultarMedicamentosPorCodigoContingencia($conex, $wbasedato,$codigo,$tipoMedicamento,$unidadMedida,$centroCostos,$gruposMedicamentos,$tipoProtocolo, $ccoPaciente = ''){

	$coleccion = array();
	$consulta = "";

	global $centroCostosServicioFarmaceutico;
	global $codigoServicioFarmaceutico;
	global $codigoCentralMezclas;
	global $centroCostosCentralMezclas;

	$esSF = $centroCostos == $centroCostosServicioFarmaceutico ? true : false;
	$esCM = $centroCostos == $centroCostosCentralMezclas ? true : false;

	$codigo = str_replace("-","%",$codigo);
	
	registrarFraccion( $conex, $wbasedato, "cenpro", $codigo, $centroCostosCentralMezclas, $wbasedato );	//Marzo 7 de 2011

	//*******************************Grupos que puede ver el centro de costos del usuario
	$tieneGruposIncluidos = false;
	$gruposIncluidos = "(";

	$q6 = "SELECT DISTINCT Ccogka FROM {$wbasedato}_000011 WHERE Ccoest='on' AND Ccogka != '*' AND Ccocod='$centroCostos';";
	$res6 = mysql_query($q6, $conex);

	while($rs6 = mysql_fetch_array($res6)){
		$tieneGruposIncluidos = true;
		if(strpos($rs6['Ccogka'],$gruposIncluidos) === false){
			$gruposIncluidos .= "'".str_replace(",","','",$rs6['Ccogka'])."',";
		}
	}
	$gruposIncluidos .= "'')";
	//********************************

	//Preproceso de los grupos de medicamentos.  De formato X00,Y00,Z00... a 'X00','Y00','Z00'
	$criterioGrupo = "";

	$vecGruposMedicamentos = explode(",",$gruposMedicamentos);

	$cont2 = 0;
	while($cont2 < count($vecGruposMedicamentos)){
		$criterioGrupo .= "'".$vecGruposMedicamentos[$cont2]."',";
		$cont2++;
	}
	$criterioGrupo .= "''";

	switch ($tipoProtocolo) {
		case 'A';
		case 'U';
		case 'Q':
			//Para cualquier servicio
			$q = "SELECT "
			."		Artcod, Artcom, Artuni, Unides, '$codigoServicioFarmaceutico' origen, SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru, Artfar, Artpos, Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia "
			."	FROM "
			."		{$wbasedato}_000068, {$wbasedato}_000026, {$wbasedato}_000059, {$wbasedato}_000027 "
			."	WHERE "
			."		Arktip = '$tipoProtocolo' "
			."		AND Arkest = 'on' "
			."		AND Arkcco = '$centroCostosServicioFarmaceutico' "
			."		AND Arkcod = Artcod "
			."		AND Artuni LIKE '$unidadMedida' "
			."		AND Artest = 'on' "
			."		AND Artuni = Unicod "
			."		AND artcod LIKE '%".$codigo."%' "
			."		AND Defart = Arkcod "
			."		AND Defest = 'on' ";
					if($tieneGruposIncluidos){
						$q .= " AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN $gruposIncluidos ";
					}
					$q .= " AND Defcco = Arkcco ";
					if($gruposMedicamentos != "*"){
						$q = $q."AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN (SELECT Melgru FROM {$wbasedato}_000066 WHERE Melest = 'on' AND Meltip = 'M' AND Melgru IN ($criterioGrupo)) ";
					} else {
						$q = $q."AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN (SELECT Melgru FROM {$wbasedato}_000066 WHERE Melest = 'on' AND Meltip = 'M') ";
					}

				$subConsulta = "SELECT "
							."	Artcod, Artcom, Artuni, Unides, '$codigoCentralMezclas' origen, '' Artgru, '00' Artfar, '' Artpos, Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia "
							." FROM "
							."	{$wbasedato}_000068, cenpro_000002, {$wbasedato}_000059, {$wbasedato}_000027 "
							." WHERE "
							."	artuni = unicod "
							."	AND Arktip = '$tipoProtocolo' "
							."	AND Arkest = 'on' "
							."	AND Defart = Arkcod "
							."	AND Arkcco = Defcco "
							."	AND Artuni = Unicod "
							."	AND artcod LIKE '%".$codigo."%' "
							."	AND Artuni LIKE '$unidadMedida' "
							."	AND Defest = 'on' "
							."	AND Defcco = '$centroCostosCentralMezclas' "
							."	AND artest = 'on' "
							."	AND Defart = Artcod";


				/****
				 * Si es usuario de central de mezclas SOLO se le permitirá ver lo de la central
				 */
				if($esCM){
					$q = $subConsulta;
				} else {
					if(!$tieneGruposIncluidos){
						$q = $q." UNION ".$subConsulta;
					}
				}
				$q = $q." LIMIT 100";
			break;
		case 'N':
			//Si el usuario no pertenece a SF ni a CM se consultan todos
			$q = "SELECT "
			."	Artcod, Artcom, Artuni, Unides, '$codigoServicioFarmaceutico' origen, SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru, IFNULL(Artfar,'00') Artfar, Artpos, Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia "
			." FROM "
			."	{$wbasedato}_000027, {$wbasedato}_000026, {$wbasedato}_000059 "
			." WHERE "
			."	artuni = unicod "
			."	AND artcod LIKE '%".$codigo."%' "
			."	AND Artuni LIKE '$unidadMedida' "
			."	AND artcod = Defart "
			."	AND artest = 'on' "
			."	AND Defest = 'on' ";
				if($tieneGruposIncluidos){
					$q .= " AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN $gruposIncluidos ";
				}
//				$q .= " AND Artcod NOT IN (SELECT Arkcod FROM {$wbasedato}_000068 WHERE Arkcod = Artcod AND Arkest = 'on' AND Arktip != 'I' AND Arktip != 'T' AND Arktip != 'N') "
				$q .= " AND Artcod NOT IN (SELECT Arkcod FROM {$wbasedato}_000068 WHERE Arkcod = Artcod AND Arkest = 'on' AND Arktip != 'I' AND Arktip != 'LC' AND Arktip NOT IN (SELECT tiptpr FROM cenpro_000001 WHERE tiptpr != '' AND tiptpr != 'NO APLICA' GROUP BY tiptpr) AND Arktip != 'N') "	//Marzo 2 DE 2011
			."	AND Defcco = '$centroCostosServicioFarmaceutico' ";
			if($gruposMedicamentos != "*"){
				$q = $q."AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN (SELECT Melgru FROM {$wbasedato}_000066 WHERE Melest = 'on' AND Meltip = 'M' AND Melgru IN ($criterioGrupo))";
			} else {
				$q = $q."AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN (SELECT Melgru FROM {$wbasedato}_000066 WHERE Melest = 'on' AND Meltip = 'M')";
			}

			$subConsulta = "SELECT "
						   ."		Artcod, Artcom, Artuni, Unides, '$codigoCentralMezclas' origen, '' Artgru, '00' Artfar, '' Artpos, Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia "
						   ."	FROM "
							."	{$wbasedato}_000027, cenpro_000002, {$wbasedato}_000059 "
							." WHERE "
							."	artuni = unicod "
							."	AND artcod LIKE '%".$codigo."%' "
							."	AND Artuni LIKE '$unidadMedida' "
							."	AND artcod = Defart "
							."	AND artest = 'on' "
//							."	AND Artcod NOT IN (SELECT Arkcod FROM {$wbasedato}_000068 WHERE Arkcod = Artcod AND Arkest = 'on' AND Arktip != 'I' AND Arktip != 'T' AND Arktip != 'N') "
							."	AND Artcod NOT IN (SELECT Arkcod FROM {$wbasedato}_000068 WHERE Arkcod = Artcod AND Arkest = 'on' AND Arktip != 'I' AND Arktip NOT IN (SELECT tiptpr FROM cenpro_000001 WHERE tiptpr != '' AND tiptpr != 'NO APLICA' GROUP BY tiptpr) AND Arktip != 'N') "	//Marzo 2 DE 2011
							."	AND Defest = 'on' "
							."	AND Defcco = '$centroCostosCentralMezclas'";

			/****
			 * Si es usuario de central de mezclas SOLO se le permitirá ver lo de la central
			 */
			if($esCM){
				$q = $subConsulta;
			} else {
				if(!$tieneGruposIncluidos){
					$q = $q." UNION ".$subConsulta;
				}
			}

			$q = $q." LIMIT 100";

			break;
		default:
			$q = "SELECT "
				." Artcod, Artcom, Artuni, Unides, '$codigoServicioFarmaceutico' origen, SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru, IFNULL(Artfar,'00') Artfar, Artpos, Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia "
			." FROM "
				." {$wbasedato}_000027, {$wbasedato}_000026, {$wbasedato}_000059 "
			." WHERE "
			."	artuni = unicod "
			."	AND artcod LIKE '%".$codigo."%' "
			."	AND Artuni LIKE '$unidadMedida' "
			."	AND artcod = Defart "
			."	AND artest = 'on' "
			."	AND Defest = 'on' ";
				if($tieneGruposIncluidos){
					$q .= " AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN $gruposIncluidos ";
				}
				$q .= " AND Defcco = '$centroCostosServicioFarmaceutico' ";
			if($gruposMedicamentos != "*"){
				$q = $q."AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN (SELECT Melgru FROM {$wbasedato}_000066 WHERE Melest = 'on' AND Meltip = 'M' AND Melgru IN ($criterioGrupo)) ";
			} else {
				$q = $q."AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN (SELECT Melgru FROM {$wbasedato}_000066 WHERE Melest = 'on' AND Meltip = 'M') ";
			}

			$subConsulta = "SELECT "
							."	Artcod, Artcom, Artuni, Unides, '$codigoCentralMezclas' origen, '' Artgru, '00' Artfar, '' Artpos, Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia "
							." FROM "
								." {$wbasedato}_000027, cenpro_000002, {$wbasedato}_000059 "
							." WHERE "
							."  artuni = unicod "
							."	AND artcod LIKE '%".$codigo."%' "
							."	AND Artuni LIKE '$unidadMedida' "
							."	AND artcod = Defart "
							."	AND artest = 'on' "
							."	AND Defest = 'on' "
							."	AND Defcco = '$centroCostosCentralMezclas'";

			/****
			 * Si es usuario de central de mezclas SOLO se le permitirá ver lo de la central
			 */
			if($esCM){
				$q = $q." UNION ".$subConsulta;
			} else {
				if(!$tieneGruposIncluidos){
					$q = $q." UNION ".$subConsulta;
				}
			}
			$q = $q." LIMIT 100";
			break;
	}

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$cont1 = 0;

	if($num > 0){
		while ($cont1 < 1)
		{
			$puedeAgregar = true;

			$rs = mysql_fetch_array($res);
			$color = "red";

			$fftica = $rs['Artfar'];

			if($rs['origen'] == $codigoCentralMezclas){
				$color = "blue";
				$fftica = '00';
				if(!$esCM && !$esSF && substr(strtoupper($rs['Artcod']),0,1) == "J"){
					$puedeAgregar = false;
				}
			}

			if($puedeAgregar){
				
				$noEnviar = ( esStock( $conex, $wbasedato, $rs['Artcod'], $ccoPaciente ) == true )? 'on' : 'off';	//Abril 25 de 2011
				
				// $referencia = "seleccionarMedicamento('".$rs['Artcod']."','".str_replace(" ","_",trim(htmlentities($rs[1])))."','".$rs['origen']."','".str_replace(" ","_",trim($rs['Artgru']))."','".str_replace(" ","_",trim($fftica))."','".str_replace(" ","_",trim($rs['Artuni']))."','".str_replace(" ","_",trim($rs['Artpos']))."','".str_replace(" ","_",trim($rs['Deffru']))."','".str_replace(" ","_",trim($rs['Deffra']))."','".str_replace(" ","_",trim($rs['Defven']))."','".str_replace(" ","_",trim($rs['Defdie']))."','".str_replace(" ","_",trim($rs['Defdis']))."','".str_replace(" ","_",trim($rs['Defdup']))."','".str_replace(" ","_",trim($rs['Defdim']))."','".str_replace(" ","_",trim($rs['Defdom']))."','".str_replace(" ","_",trim($rs['Defvia']))."','".$tipoProtocolo."','".$noEnviar."');";
				// $consulta = $consulta."<font color=$color>*[".$rs['origen']."]<a href='#null' onclick=$referencia>".htmlentities($rs[1]).'</a></font><br/>';
				
							 //         0        ,     1      ,    2              ,        3          ,    4        ,      5            ,         6         ,         7         ,         8         ,          9        ,        11         ,     12            ,        13         ,     14            ,       15          ,      16           ,      17            ,      18     
							 //        Codigo    ,  NOmbre    , Origen            , Grupo             , FFA         , Unidad            ,  POS              , unidad fraccion   , Fraccion          , Vencimiento       , ??                , dispensable       , duplicable        ,    ??             ,     ??            ,    via            ,         Protocolo  , No enviar
				$referencia = "".$rs['Artcod']."','".$rs[1]."','".$rs['origen']."','".$rs['Artgru']."','".$fftica."','".$rs['Artuni']."','".$rs['Artpos']."','".$rs['Deffru']."','".$rs['Deffra']."','".$rs['Defven']."','".$rs['Defdie']."','".$rs['Defdis']."','".$rs['Defdup']."','".$rs['Defdim']."','".$rs['Defdom']."','".$rs['Defvia']."','".$tipoProtocolo."','".$noEnviar."";
				$consulta = $referencia;
			}
			
			//        Codigo    ,  NOmbre    , Origen            , Grupo             , FFA         , Unidad            ,  POS              , unidad fraccion   , Fraccion          , Vencimiento       , ??                , dispensable       , duplicable        ,    ??             ,     ??            ,    via            ,         Protocolo  , No enviar
			//"'".$rs['Artcod']."','".$rs[1]."','".$rs['origen']."','".$rs['Artgru']."','".$fftica."','".$rs['Artuni']."','".$rs['Artpos']."','".$rs['Deffru']."','".$rs['Deffra']."','".$rs['Defven']."','".$rs['Defdie']."','".$rs['Defdis']."','".$rs['Defdup']."','".$rs['Defdim']."','".$rs['Defdom']."','".$rs['Defvia']."','".$tipoProtocolo."','".$noEnviar."'
			
			$cont1++;
		}
	} else {
		$consulta = $consulta."";
	}

	//liberarConexionBD($conex);

	return $consulta;
}
 

/************************************************************************************************************************
 * Consulta cuanto es el total de articulos creados automaticamente por contigencia en el kardex
 ************************************************************************************************************************/
function consultarArticuloAutomatico( $conex, $wbasedato, $historia, $ingreso ){

    $val = false;

    $sql = "SELECT 
                count(*)
            FROM 
                {$wbasedato}_000054
            WHERE 
                kadhis = '$historia'
                AND kading = '$ingreso'
                AND Kadusu = '$wbasedato'
            ;";
                 
    $res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
    
    if( $rows = mysql_fetch_array($res) ){
        $val = $rows[ 0 ];
    }
    
    return $val;
}
 
/************************************************************
 * Indica si un centro de costos es de ingreso
 * 
 * @param $conexion
 * @param $wbasedato
 * @param $cco
 * @return unknown_type
 ************************************************************/
function estaUrgenciaCirugia( $conexion, $wbasedato, $historia, $ingreso ){

	$val = false;

	$sql = "SELECT
				Ccourg, Ccoing, Ccocir
			FROM
				{$wbasedato}_000018, {$wbasedato}_000011
			WHERE
				ubihis = '$historia'
				AND ubiing = '$ingreso'
				AND ccocod = ubisac
				AND ccoest = 'on'
				AND ccoing = 'on'
			";
				
	$res = mysql_query( $sql, $conexion ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$num = mysql_num_rows( $res );
	
	if( $num > 0 ){
		$rows = mysql_fetch_array( $res );
		
		if( $rows[ 'Ccocir' ] == 'on' || $rows[ 'Ccourg' ] == 'on' ){
			$val = true;
		}
	}
	
	return $val;
}
 
/******************************************************************************************
 * Para un paciente que se encuentran en urgencia o cirugia, recalcula el kardex
 ******************************************************************************************/
function recalcularKardex( $conex, $wbasedato, $historia, $ingreso, $fecha ){

	$val = false;

	//Busco todos los articulos que tiene el paciente y que se encuentre en urgencias
	$sql = "SELECT
				a.Fecha_data as encFecha_data, a.Fecha_data as encHora_data, a.id as encId, b.*
			FROM
				{$wbasedato}_000053 a, {$wbasedato}_000054 b
			WHERE
				karhis = '$historia'
				AND karing = '$ingreso'
				AND a.fecha_data = '$fecha'
				AND karrca = 'on'
				AND karest = 'on'
				AND kadhis = karhis
				AND kading = karing
				AND kadfec = a.fecha_data
				AND karcco = kadcco
			";
	
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$num = mysql_num_rows( $res );
	
	$hrTraslado = '';
	
	//Si encuentro registros
	if( $num > 0 ){
	
		//Busco a que horas el paciente fue traslado a piso desde urgencia
		$horaTraslado = consultarHoraTrasladoUrgencias( $conex, $wbasedato, $historia, $ingreso, $fecha );
		
		//Si hora traslado es diferente a falso, significa que si lo han recibido en piso
		if( $horaTraslado ){
		
			//Recorro las filas del articulo
			for( $i = 0; $info = mysql_fetch_array( $res ); $i++ ){
				
				// //Consulto la frecuencia del medicamento
				$horasFrecuencia = consultarFrecuencia( $conex, $wbasedato, $info['Kadper'] );
				
				// echo "<br>fecha de inicio despues del traslado 2: {$info['Kadart']} : ".date( "Y-m-d H:i:s", $fhInicioTraslado );
				
				//Inicializo variables
				$cantGrabar = $saldo = $cantDispensar = $cantidadManejo = '';

				//Calculo de los dias de tratamiento actuales, Sumo 1 dia por el registro del dia actual que esta en temporal
				$diasTtoAcumulados = 0;
				$dosisTtoTotales = 0;
				obtenerDatosAdicionalesArticulo( $historia, $ingreso, $info['Kadart'], $diasTtoAcumulados, $dosisTtoTotales );
				
				//Calculo los datos necesarios
				$horasAplicacionDia = "";
				calcularSaldoActual( $conex,$wbasedato,$info['Kadhis'],$info['Kading'],$fecha,$info['Kadart'],$info['Kadfin'],$info['Kadhin'],$info['Kadcfr'],$horasFrecuencia,$info['Kaddma'],$info['Kadori'],$diasTtoAcumulados+1,$cantGrabar,$saldo,$cantDispensar,$cantidadManejo,$info['Kadsad'],$info['Kadpro'],$horasAplicacionDia, $info['Kaddia'], $info['Kadreg'] );
				
				//Consulto el cco al que pertenece el articulo
				if( strtoupper( $info['Kadori'] ) == "SF" ){
				
					$sqlCcoTras = "SELECT
								     Ccocod
								   FROM
										{$wbasedato}_000011
								   WHERE
										ccoest = 'on'
										AND ccotra = 'on'
										AND ccoima != 'on'
									";
				}
				else{
				
					$sqlCcoTras = "SELECT
								     Ccocod
								   FROM
										{$wbasedato}_000011
								   WHERE
										ccoest = 'on'
										AND ccotra = 'on'
										AND ccoima = 'on'
									";
				}
				
				$resCco = mysql_query( $sqlCcoTras, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
				$rowCco = mysql_fetch_array( $resCco );
				
				
				//Busco si el articulo es dispensable
				$qf = "SELECT
							Defart, Deffra, Defdup, Defdis, Defcco, Defdie
						FROM
							{$wbasedato}_000059
						WHERE
							Defart = '{$info['Kadart']}'
							AND Defcco = '{$rowCco['Ccocod']}'
							AND Defest = 'on' ";

				$respin = mysql_query( $qf, $conex ) or die ("Error: " . mysql_errno() . " - en el query: " . $qf . " - " . mysql_error());
				$numf = mysql_num_rows( $respin );

				$dispensable = "on";

				while( $infofr = mysql_fetch_array( $respin ) ){
					$dispensable 		= ( $infofr['Defdis'] == 'on' )? true: false;
				}
				
				if( !$dispensable || $info[ 'Kadess' ] == 'on' ){
					$cantGrabar = 0;
					$saldo = 0;
					$cantDispensar = 0;
				}
				
				$saldoDeDispensacionAnterior = 0;
					
				//De acuerdo a lo calculado actualizo la tabla para el articulo
				//Las campo a modificar son
				// - cantidad a dispensar
				// - saldo de dispensacion
				// - saldo del articulo
				// - cantidad a grabar
				// - horas aplicacion dia
				// - ultima ronda de grabacion
				// - fecha ultima ronda de grabacion				
				$sql = "UPDATE ".$wbasedato."_000054 SET
							Kadsal = '$saldo',
							Kadcdi = '$cantDispensar',
							Kadsad = '$saldoDeDispensacionAnterior',
							Kadcan = '$cantGrabar',
							Kadcpx = '$horasAplicacionDia',
							Kadron = '{$info['Kadron']}',
							Kadfro = '{$info['Kadfro']}',
							Kaddis = '{$info['Kaddis']}'						
						WHERE
							id = '{$info[ 'id' ]}' ";
				
				$resAct = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
			}
			
			//Coloco el encabezado del kardex como ya recalculado
			$sql = "UPDATE ".$wbasedato."_000053 
					SET
						Karrca = 'off'
					WHERE
						karhis = '$historia'
						AND karing = '$ingreso'
						AND fecha_data = '$fecha'
					";
					
			$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
			
			if( mysql_affected_rows() > 0 ){
				$val = true;
			}
		}
	}
	
	return $val;	
}
 
/************************************************************************************************
 * Consulta las familias de medicamentos
 *
 * Solo salen los medicamentos que esten activos tanto en el maesttro de articulos {$wbasedato}_000026
 * como en la definicion de articulos {$wbasedato}_000059.
 * @return unknown_type
 ************************************************************************************************/
function consultarFamiliaMedicamentos( $conex, $wbasedato, $wcenmez, $familia, $historia, $ingreso )
{
	
	// Esta es la variable que contendrá todos los datos de los artículos 
	// que correspondan con la búsqueda de la familia
	$val = "";
	
	//Principios activos por los que es alergico el paciente
	//La función siempre devuelve un array con toda la información
	$paAlergicosPacientes 	= consultarAlergiasPorPrincipioActivo( $conex, $wbasedato, $historia, $ingreso );
	$paAlergicos = array();
	
	//Convierto el arrray devuevlo en uno que solo contenga los códigos de los principios activos
	//por los que es alérgico el paciente
	if( is_array( $paAlergicosPacientes ) ){
		
		foreach( $paAlergicosPacientes as $key => $value ){
			$paAlergicos[] = $value['codigo'];
		}
	}
	
	/*
	----------- DESCRIPCION DE LAS TABLAS PARA LA SIGUIENTE CONSULTA ---------------
	{$wbasedato}_000114 -> Maestro de familias de medicamentos (Fam)
	{$wbasedato}_000027 -> Maestro de unidades (Uni)
	{$wbasedato}_000115 -> Relación familias de medicamentos con unidades (Rel)
	{$wbasedato}_000026 -> Maestro de artículos (Art)
	{$wbasedato}_000059 -> Definición fracciones artículos (Def)
	{$wbasedato}_000046 -> Formas farmacéuticas (Ffa)
	---------------------------------------------------------------------------------
	*/
			
	//Busco las familias que tengan en su nombre la familia buscada	
	$sql = "SELECT
				Famcod
			FROM
				{$wbasedato}_000114 h,
				{$wbasedato}_000115 i
			WHERE
				famcod = relfam
				AND famnom  LIKE '%$familia%'
				AND relest = 'on'
				AND famest = 'on'
			UNION
			SELECT
				Famcod
			FROM
				{$wbasedato}_000114 h,
				{$wbasedato}_000115 i
			WHERE
				famcod = relfam
				AND relart  LIKE '%$familia%'
				AND relest = 'on'
				AND famest = 'on'
			GROUP BY 1 ";
	
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	
	$strInFamCod = "''";
	for( $i = 0;$rows = mysql_fetch_array($res); $i++ ){
		// if($i == 0 )
			// $strInFamCod .= "'".$rows[ 'Famcod' ]."'";
		// else
			$strInFamCod .= ",'".$rows[ 'Famcod' ]."'";
	}
	
	
	//Consulto las familias que tienen articulo cuyo nombre generico o comercial tengan la familia buscada
	$sql = "SELECT
				Relfam
			FROM
				{$wbasedato}_000115 c,
				{$wbasedato}_000026 d
			WHERE relest = 'on'
				AND artcod = relart
				AND ( artgen LIKE '%$familia%' OR artcom LIKE '%$familia%' OR artcod LIKE '%$familia%' )
				AND artest = 'on'
				AND relfam NOT IN( $strInFamCod )
			GROUP BY 1";
	
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
		
	//$strInFamCod = '';
	for( ;$rows = mysql_fetch_array($res);  ){
		$strInFamCod .= ",'".$rows[ 'Relfam' ]."'";
	}	

		
	//Consulto las familias que tienen articulo cuyo nombre generico o comercial tengan la familia buscada
	$sql = "SELECT
				Relfam
			FROM
				{$wbasedato}_000115 c,
				{$wcenmez}_000002 d,
				{$wcenmez}_000001 e
			WHERE relest = 'on'
				AND artcod = relart
				AND ( artgen LIKE '%$familia%' OR artcom LIKE '%$familia%' )
				AND artest = 'on'
				AND relfam NOT IN( $strInFamCod )
				AND arttip = tipcod
				AND tipcdo != 'on'
			GROUP BY 1";
	
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
		
	//$strInFamCod = '';
	for( ;$rows = mysql_fetch_array($res);  ){
		$strInFamCod .= ",'".$rows[ 'Relfam' ]."'";
	}
			
	
	//Busco las familias con todos los datos		
	$sql = "( SELECT
				Relfam,Famnom,Famcod,Reluni,b.Unicod,b.Unides,Relart,Relcon*1 as Relcon, '' Famund,Relpre,Artpco as Ffacod,Pcodes as Ffanom,Defvia, Artgen, Artcom, Defart
			FROM
				{$wbasedato}_000114 a, 
				{$wbasedato}_000115 c,
				{$wbasedato}_000026 d,
				{$wbasedato}_000059 e,
				{$wbasedato}_000027 g,
				{$wbasedato}_000027 b,
				{$wbasedato}_000175 h
			WHERE
				famcod = relfam
				AND deffru =b.unicod
				AND relest = 'on'
				AND artcod = relart
				AND artest = 'on'
				AND defart = artcod
				AND defest = 'on' 
				AND relpre = g.unicod 
				AND famest = 'on'
				AND famcod IN ( $strInFamCod )
				AND artpco != ''
				AND artpco = pcocod
			)
			UNION
			( SELECT
				Relfam,Famnom,Famcod,Reluni,b.Unicod,b.Unides,Relart,Relcon*1 as Relcon, '' Famund,Relpre,Relpre as  Ffacod,g.Unides as  Ffanom,Defvia, Artgen, Artcom, Defart
			FROM
				{$wbasedato}_000114 a, 
				{$wbasedato}_000027 b,
				{$wbasedato}_000115 c,
				{$wcenmez}_000002 d,
				{$wcenmez}_000001 h,
				{$wbasedato}_000059 e,
				{$wbasedato}_000027 g,
				{$wbasedato}_000068 i
			WHERE
				famcod = relfam
				AND deffru =b.unicod
				AND relest = 'on'
				AND artcod = relart
				AND artest = 'on'
				AND arttip = tipcod
				AND tipcdo != 'on'
				AND defart = artcod
				AND defest = 'on'  
				AND famest = 'on'
				AND relpre = g.unicod
				AND famcod IN ( $strInFamCod )
				AND arkcod = relart
				)
			ORDER BY
				Famund DESC, relfam asc, reluni asc, relcon asc, relart asc
			";
			
	//Verificar si es un articulo el que se esta buscando.
	//Este query se usa más adelante
	$sql_art = " SELECT Artest, Artuni
			       FROM	{$wbasedato}_000026
			      WHERE Artcod = '".$familia."'";
	$res_art = mysql_query( $sql_art, $conex ) or die( mysql_errno()." - Error en el query $sql_art - ".mysql_error() );
	$num_art = mysql_num_rows($res_art);
			
	// 2012-07-09
	// Se agregó ORDER BY Famund DESC para poder ordenar según la unidad destacada para la familia de medicamentos

	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$num = mysql_num_rows( $res );
	
	$esAlergicoAPA = false;
	$paDesAlergicos = array();

	if( $num > 0 )
	{
		$famAnt = "";
		
		for( $i = 0; $rows = mysql_fetch_array( $res ); $i++ )
		{
			$rows[ 'Relcon' ] = str_replace( ".000", "", $rows[ 'Relcon' ] );
			
			if( stripos( $rows['Famnom'], $familia ) === false 
				&& stripos( $rows['Artcom'], $familia ) === false && stripos( $rows['Artgen'], $familia ) === false and stripos( $rows['Relart'], $familia ) === false)
			{
				continue;
			}
			
			$famcod = trim($rows[ 'Famcod' ]);
			$artcod = trim($rows[ 'Relart' ]);
			$unicod = trim($rows[ 'Unicod' ]);
			$ffacod = trim($rows[ 'Ffacod' ]);
			
			
			////////////////////// FAMILIA //////////////////////
			// Si es diferente a la familia de la iteracción anterior
			if( $famAnt != $famcod )
			{
				$textfind = trim($rows[ 'Famnom' ])."|".$famcod."";
				
				// Defino si la familia ya se encuentra en la variable $val
				$pos = strpos($val, $textfind);

				if( $i > 0 && $pos === false ){
					$val .= "|<$familia--".( $esAlergicoAPA ? '1' : '0' )."--".implode( ",", $paDesAlergicos )."\n";
					unset($arrFamilias);
					unset($arrFamiliasFfa);
				}

				if($pos === false)
					$val .= $textfind;
				
				$paDesAlergicos = array();
			}
			//////////////////////////////////////////////////////
			
			//Es alergico a principio activo(PA)
			$esAlergicoAPA = false;
			
			
			$paPorFamilia 	= consultarPrincipiosActivosPorFamilia( $conex, $wbasedato, $rows[ 'Famcod' ] );
			while( $rowsPA = mysql_fetch_array($paPorFamilia) ){
				// var_dump($rowsPA);
				$pos = array_search( $rowsPA['Paccod'], $paAlergicos );
				
				// if( in_array( $rowsPA['Paccod'], $paAlergicos ) ){
				if( $pos !== false ){
					
					$paAlergicosPacientes[ $pos ];
					
					if( !$paAlergicosPacientes[ $pos ]['limiteTiempo'] || time() <= $paAlergicosPacientes[ $pos ]['fechaLimiteUnix'] ){
						
						$esAlergicoAPA = true;
					
						if( !in_array( $rowsPA['Pacdes'], $paDesAlergicos ) )
							$paDesAlergicos[] = $rowsPA['Pacdes'];
					}
					else{
						$paDesAlergicos[] = "El paciente tuvo alergia a <b>".$paAlergicosPacientes[ $pos ]['descripcionAlergia']."</b> hasta el <b>".$paAlergicosPacientes[ $pos ]['fechaLimite']."</b>";
					}
				}
			}
			
			
			////////////////////// ARTICULO //////////////////////
			// Incluyo en la variable $val el código y la concentración o dosis del artículo
			if( !isset( $arrFamilias[ $famcod ][ $artcod ] ) )
			{
				$arrFamilias[ $famcod ][ $artcod ] = 1;
				$val .= "|-".$artcod."|".$rows[ 'Relcon' ];
			}
			//////////////////////////////////////////////////////

			
			////////////////// UNIDAD DE MEDIDA //////////////////
			// Incluyo en la variable $val las unidades de medida para el artículo
			if( !isset( $arrFamilias[ $famcod ][ $unicod ] ) )
			{
				$arrFamilias[ $famcod ][ $unicod ] = 1;
				$val .= "|@".$unicod."|".trim($rows[ 'Unides' ])."";
			}
			///////////////////////////////////////////////////////
			
			
			///////////////// FORMA FARMACEUTICA //////////////////
			// Incluyo en la variable $val la presentación o forma farmacéutica para el artículo
			if( !isset( $arrFamiliasFfa[ $famcod ][ $ffacod ] ) )
			{
				$arrFamiliasFfa[ $famcod ][ $ffacod ] = 1;
				$val .= "|&".$ffacod."|".trim($rows[ 'Ffanom' ])."";
			}
			///////////////////////////////////////////////////////


			/////////////// VIA DE ADMINISTRACION /////////////////
			// Si el campo via de administración no está vacio
			// Si se busco un articulo la via debe ser igual a la del articulo
			if( ( $num_art > 0 && strtoupper( $familia ) == strtoupper( $rows['Defart'] ) ) 
				|| $num_art == 0
			){
				if($rows['Defvia'] && $rows['Defvia']!="" && $rows['Defvia']!=" ")
				{
					// Se da formato a las vías para la sentencia IN del query
					$defvia_arr = str_replace(",","','",$rows['Defvia']);
					
					// Consulto descripcion de la via o vías de administracion
					$sql = " SELECT
								Viacod,Viades
							FROM
								{$wbasedato}_000040
							WHERE
								Viacod IN ('".$defvia_arr."')
							";
				}
				// Si no existen vías de administración asociadas se hace una consulta vacía
				else
				{
					// Consulto descripcion via de administracion
					$sql = " SELECT
								Viacod,Viades
							FROM
								{$wbasedato}_000040
							WHERE
								Viacod = -1
							";
				}
			}
			
			$resvia = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
			
			// Incluyo en la variable $val las vías de administración para el artículo
			while($rowsvia = mysql_fetch_array( $resvia ))
			{
				$viacod = trim($rowsvia[ 'Viacod' ]);
				if( !isset( $arrFamilias[ $famcod ][ $viacod ] ) )
				{
					$arrFamilias[ $famcod ][ $viacod ] = 1;
					$val .= "|#".$viacod."|".htmlentities(trim($rowsvia[ 'Viades' ]))."";
				}
			}
			///////////////////////////////////////////////////////
			
			
			// Defino los valores para la iteración actual que servirán para comprarar
			// como valor anterior en la siguiente iteración, si la hay
			$famAnt = $famcod;
		}

		unset($arrFamilias);
	}
	
	if($num_art > 0 ){
		
		$row_art = mysql_fetch_array($res_art);
		$westado_art = $row_art['Artest'];
		$wunidad_pre_art = $row_art['Artuni'];
		
		//Si es un articulo buscara el estado actual del articulo en la tabla movhos_000026
		if($westado_art != 'on'){
			
			$val = "EL ARTICULO SE ENCUENTRA INACTIVO EN EL MAESTRO DE ARTICULOS||||||||||";
			
		}else{
		
			//Si esta activo buscara en la tabla de Relacion Familias de Medicamentos con Unidades
			$sql_fam = " SELECT Relest, Relpre
						   FROM	{$wbasedato}_000115
						  WHERE Relart = '".$familia."'";
			$res_fam = mysql_query( $sql_fam, $conex ) or die( mysql_errno()." - Error en el query $sql_fam - ".mysql_error() );
			$num_fam = mysql_num_rows($res_fam);
			
			if($num_fam > 0){
				
				$row_fam = mysql_fetch_array($res_fam);
				$westado_fam = $row_fam['Relest'];				
				
				//Si esta en la familia de articulos buscara si esta activo en esa tabla.
				if($westado_fam != 'on'){
					$val = "EL ARTICULO TIENE LA FAMILIA INACTIVA||||||||||";
				}
				else{
					
					//Si esta activo el articulo y la familia, busca en la tabla de definicion de fracciones.
					$sql_fra = " SELECT Defest
								   FROM	{$wbasedato}_000059
								  WHERE Defart = '".$familia."'";
					$res_fra = mysql_query( $sql_fra, $conex ) or die( mysql_errno()." - Error en el query $sql_fra - ".mysql_error() );
					$num_fra = mysql_num_rows($res_fra);
					
					if($num_fra > 0){
					
						$westado_fra = false;
						while( $row_fra = mysql_fetch_array($res_fra) ){
							if( strtolower( $row_fra['Defest'] ) == 'on' )
								 $westado_fra = true;
						}
						
						//Si esta en la tabla de definicion de fracciones, busco si esta activo.
						if( !$westado_fra ){
							$val = "LA DEFINICION DE FRACCIONES PARA EL ARTICULO SE ENCUENTRA INACTIVA||||||||||";
						}
						else{
							
							//Si esta activo el articulo, la familia y la fraccion busca en la tabla de unidades.
							$sql_uni = " SELECT Uniest
										   FROM	{$wbasedato}_000027
										  WHERE Unicod = '".$wunidad_pre_art."'";
							$res_uni = mysql_query( $sql_uni, $conex ) or die( mysql_errno()." - Error en el query $sql_uni - ".mysql_error() );
							$num_uni = mysql_num_rows($res_uni);
							
							if($num_uni > 0){
																
								$row_uni = mysql_fetch_array($res_uni);
								$westado_uni = $row_uni['Uniest'];
								
								//Si esta en la tabla de unidades, busco si esta activa la unidad.
								if($westado_uni != 'on'){
									$val = "LA UNIDAD DE PRESENTACION SE ENCUENTRA INACTIVA EN EL MAESTRO||||||||||";
								}								
							//Si no esta activa la unidad de presentacion muestra este mensaje.
							}
							else{
								$val = "LA UNIDAD DE PRESENTACION NO SE ENCUENTRA REGISTRADA EN EL MAESTRO||||||||||";
							}
						}
					//Si esta inactiva la definicion de fracciones muestra este mensaje.
					}
					else{
						$val = "NO HAY DEFINICION DE FRACCIONES PARA EL ARTICULO||||||||||";
					}
				}
			//Si el articulo no tiene familia asociada, muestra este mensaje.
			}
			else{
				$val = "EL ARTICULO NO TIENE LA FAMILIA ASOCIADA||||||||||";
			}
		}
	}
	
	return ( $val."|<$familia--".( $esAlergicoAPA ? '1' : '0' )."--".implode( ",", $paDesAlergicos )."\n" );
}

/************************************************************************************************
 * Consulta la presentación unidad de medida y vias de administración de la familia de medicamentos
 * según las selecciones hechas en el formulario de adición de medicamentos
 *
 * @return unknown_type
 ************************************************************************************************/
function filtrarFamiliaMedicamentos( $conex, $wbasedato, $wcenmez, $familia, $presentacion, $unidad, $bsq )
{
	//Verificar si es un articulo el que se esta buscando.
	//Este query se usa más adelante
	$sql_art = " SELECT Artest, Artuni
			       FROM	{$wbasedato}_000026
			      WHERE Artcod = '".$bsq."'";
	$res_art = mysql_query( $sql_art, $conex ) or die( mysql_errno()." - Error en el query $sql_art - ".mysql_error() );
	$num_art = mysql_num_rows($res_art);
	
	$whereArt = "";
	if( $num_art > 0 ){
		$whereArt = "AND relart='".$bsq."'"; 
	}

	$familia = utf8_decode( trim($familia) );
	// Esta es la variable que contendrá todos los datos de los artículos 
	// que correspondan con la búsqueda de la familia
	$val = "";

	/*
	----------- DESCRIPCION DE LAS TABLAS PARA LA SIGUIENTE CONSULTA ---------------
	{$wbasedato}_000114 -> Maestro de familias de medicamentos (Fam)
	{$wbasedato}_000027 -> Maestro de unidades (Uni)
	{$wbasedato}_000115 -> Relación familias de medicamentos con unidades (Rel)
	{$wbasedato}_000026 -> Maestro de artículos (Art)
	{$wbasedato}_000059 -> Definición fracciones artículos (Def)
	{$wbasedato}_000046 -> Formas farmacéuticas (Ffa)
	{$wbasedato}_000040 -> Vías de administración (Ffa)
	{$wcenmez}_000002 -> Maestro de artículos de Central de Mezclas (Art)
	---------------------------------------------------------------------------------
	*/
			
	 // Se consultan los medicamentos asociados a la familia seleccionada
	 $sql = "( SELECT
				Relfam,Famnom,Famcod,Reluni,b.Unicod,b.Unides,Relart,Relcon*1 as Relcon, '' Famund,Relpre,Artpco as Ffacod,Pcodes as Ffanom,Defvia, Defart 
			FROM
				{$wbasedato}_000114 a, 
				{$wbasedato}_000115 c,
				{$wbasedato}_000026 d,
				{$wbasedato}_000059 e,
				{$wbasedato}_000027 b,
				{$wbasedato}_000027 g,
				{$wbasedato}_000175 h
			WHERE
				famcod = relfam
				AND deffru LIKE '$unidad'
				AND artpco LIKE '$presentacion'
				AND deffru =b.unicod
				AND relpre =g.unicod
				AND famnom = '$familia'
				AND relest = 'on'
				AND artcod = relart
				AND artest = 'on'
				AND defart = artcod
				AND defest = 'on' 
				AND artpco != ''
				AND artpco = pcocod 
				$whereArt
			)
			UNION
			( SELECT
				Relfam,Famnom,Famcod,Reluni,b.Unicod,b.Unides,Relart,Relcon*1 as Relcon, '' Famund,Relpre,Relpre as Ffacod,g.unides as Ffanom,Defvia , Defart
			FROM
				{$wbasedato}_000114 a, 
				{$wbasedato}_000115 c,
				{$wcenmez}_000002 d,
				{$wcenmez}_000001 h,
				{$wbasedato}_000059 e,
				{$wbasedato}_000027 g,
				{$wbasedato}_000027 b,
				{$wbasedato}_000068 i
			WHERE
				famcod = relfam
				AND deffru LIKE '$unidad'
				AND relpre LIKE '$presentacion'
				AND deffru =b.unicod
				AND relpre =g.unicod
				AND famnom  = '$familia'
				AND relest = 'on'
				AND artcod = relart
				AND artest = 'on'
				AND arttip = tipcod
				AND tipcdo != 'on'
				AND defart = artcod
				AND defest = 'on' 
				AND arkcod = artcod 
				$whereArt
			)
			ORDER BY
				Famund DESC, relfam asc, reluni asc, relcon asc, relart asc
			";
			
	
	
	// 2012-07-09
	// Se agregó ORDER BY Famund DESC para poder ordenar según la unidad destacada para la familia de medicamentos


	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$num = mysql_num_rows( $res );

	if( $num > 0 ){
		
		$famAnt = "";
		
		for( $i = 0; $rows = mysql_fetch_array( $res ); $i++ ){
			
			$famcod = trim($rows[ 'Famcod' ]);
			$artcod = trim($rows[ 'Relart' ]);
			$unicod = trim($rows[ 'Unicod' ]);
			$ffacod = trim($rows[ 'Ffacod' ]);
			$rows[ 'Relcon' ] = str_replace( ".000", "", $rows[ 'Relcon' ]);
			
			
			////////////////////// FAMILIA //////////////////////
			// Si es diferente a la familia de la iteracción anterior
			if( $famAnt != $famcod )
			{
				$textfind = trim($rows[ 'Famnom' ])."|".$famcod."";
				
				// Defino si la familia ya se encuentra en la variable $val
				$pos = strpos($val, $textfind);

				if( $i > 0 && $pos === false )
					$val .= "\n";

				if($pos === false)
					$val .= $textfind;
			}
			//////////////////////////////////////////////////////
			
			
			////////////////////// ARTICULO //////////////////////
			// Incluyo en la variable $val el código y la concentración o dosis del artículo
			// Incluyo en la variable $val el código y la concentración o dosis del artículo
			$val .= "|-".$artcod."|".$rows[ 'Relcon' ];
			//////////////////////////////////////////////////////
			
			
			////////////////// UNIDAD DE MEDIDA //////////////////
			// Incluyo en la variable $val las unidades de medida para el artículo
			$textfind2 = "|@".$unicod."|".trim($rows[ 'Unides' ])."";
			$pos2 = strpos($val, $textfind2);
			if($pos2 === false)
				$val .= $textfind2;
			//////////////////////////////////////////////////////

			
			///////////////// FORMA FARMACEUTICA //////////////////
			// Incluyo en la variable $val la presentación o forma farmacéutica para el artículo
			$textfind3 = "|&".$ffacod."|".trim($rows[ 'Ffanom' ])."";
			$pos3 = strpos($val, $textfind3);
			if($pos3 === false)
				$val .= $textfind3;
			///////////////////////////////////////////////////////
			

			/////////////// VIA DE ADMINISTRACION /////////////////
			// Si existe vía o vías de administración asociadas se consultan
			if( ( $num_art > 0 && strtoupper( $bsq ) == strtoupper( $rows['Defart'] ) ) 
				|| $num_art == 0
			){
				if($rows['Defvia'] && $rows['Defvia']!="" && $rows['Defvia']!=" ")
				{
					$defvia_arr = str_replace(",","','",$rows['Defvia']);
					
					// Consulto descripcion via de administracion
					$sql = " SELECT
								Viacod,Viades
							FROM
								{$wbasedato}_000040
							WHERE
								Viacod IN ('".$defvia_arr."')
							";
				}
				// Si no existen vías de administración asociadas se hace una consulta vacía
				else
				{
					// Consulto descripcion via de administracion
					$sql = " SELECT
								Viacod,Viades
							FROM
								{$wbasedato}_000040
							WHERE
								Viacod = -1
							";
				}

				// Incluyo en la variable $val las unidades de medida para el artículo
				$resvia = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );

				// Incluyo en la variable $val las vías de administración para el artículo
				while($rowsvia = mysql_fetch_array( $resvia ))
				{
					$viacod = trim($rowsvia[ 'Viacod' ]);
					$textfind4 = "|#".$viacod."|".htmlentities(trim($rowsvia[ 'Viades' ]))."";
					$pos4 = strpos($val, $textfind4);
					if($pos4 === false)
						$val .= $textfind4;
				}
			}
			///////////////////////////////////////////////////////
			
			/////////////// CONCENTRACIÓN O DOSIS /////////////////
			$textfind5 = "|$".$rows[ 'Relcon' ]."|";
			$pos5 = strpos($val, $textfind5);
			if($pos5 === false)
				$val .= "|$".$rows[ 'Relcon' ];
			///////////////////////////////////////////////////////

			
			// Defino los valores para la iteración actual que servirán para comprarar
			// como valor anterior en la siguiente iteración, si la hay
			$famAnt = $rows[ 'Relfam' ];
		}
	}
	
	echo $val."\n";
}
 
/****************************************************************************************************
 * Indica si un articulo tiene saldo de articulo o no
 ****************************************************************************************************/
function tieneSaldo( $conex, $wbasedato, $historia, $ingreso, $articulo ){

	$val = false;

	$sql = "SELECT
				SUM( Spauen ) as Spauen, SUM( Spausa ) as Spausa
			FROM
				{$wbasedato}_000004
			WHERE
				spahis = '$historia'
				AND spaing = '$ingreso'
				AND spaart = '$articulo'
			GROUP BY
				spaart
			";
	
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()."".mysql_error() );
	$numrows = mysql_num_rows( $res );
	
	if( $numrows > 0 ){
		
		$rows = mysql_fetch_array( $res );
		
		if( $rows[ 'Spauen' ] == $rows['Spausa'] ){
			$val = false;
		}
		else{
			$val = true;
		}
	}
	
	return $val;
}

/************************************************************************
 * Indica si un articulo fue aplicado en una fecha
 ************************************************************************/
function esAplicado( $conex, $wbasedato, $historia, $ingreso, $articulo, $fecha ){

	$val = false;
	
	$q="SELECT
			COUNT(*)
		FROM
			{$wbasedato}_000015
		WHERE
			Aplhis = '$historia'
			AND Apling = '$ingreso'
			AND Aplart = '$articulo'
			AND Aplest = 'on'
			AND Aplfec = '$fecha'
		HAVING
			count(*) > 0
		";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if($num > 0 ){
		$val = true;
	}
	
	return $val;
}
 
/********************************************************************************
 * Borra la tabla temporal dejando los dos ultimos dias
 ********************************************************************************/
function borrarTablaTemporal( $conex, $wbasedato ){

	$val = false;

	$fecha = date( "Y-m-d", time() - 24*3600 );	//Busco

	$sql = "DELETE FROM
				{$wbasedato}_000060
			WHERE
				kadfec < '$fecha'
			";
	
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	
	if( mysql_affected_rows() > 0 ){
		$val = true;
	}
	
	return $val;
}

 /****************************************************************************************
  * Octubre 24 de 2011
  *
  * Consulta los pacientes por cco para el perfil.  Esta funcion devuelve una tabla
  * con todos los pacientes que se encuentre en un cco especificado en la variable $servicio.
  * La tabla contiene la informacion de habitacion, historia, nombre del paciente, accion y
  * mensajes sin leer para el perfil
  ****************************************************************************************/
function consultarHabitacionPacienteServicioPerfil($basedatos,$servicio){
	
	global $wemp_pmla;
	
	$conexion = obtenerConexionBD("matrix");		
	
	$tablaHabitaciones = consultarTablaHabitaciones( $conex, $wbasedato, $servicio );
		
	$q = "SELECT
			Habcod, Habcco, Habhis, Habing,
			CONCAT(pacno1,' ', pacno2,' ', pacap1,' ', pacap2, '|', Pactid, '|', Pacced ) as nombre, 'off' Ubiptr
		FROM
			{$tablaHabitaciones}, root_000036, root_000037
		WHERE
			Habcco = '$servicio'
			AND Habdis = 'off'
			AND Habhis != ''
			AND Habest = 'on'
			AND oriced = pacced 
			AND oriori = '$wemp_pmla' 
			AND orihis = Habhis 
			AND oriing = Habing 
			AND Oritid = Pactid
		UNION
		SELECT 
			'Urgencias'Habcod, Ubisac Habcco, Ubihis Habhis, Ubiing Habing, 
			CONCAT( pacno1, ' ', pacno2, ' ', pacap1, ' ', pacap2, '|', Pactid, '|', Pacced ) AS nombre,
			Ubiptr
		FROM
			{$basedatos}_000011, {$basedatos}_000018, root_000036, root_000037
		WHERE
			Ccourg = 'on'
			AND Ccocod = Ubisac
			AND Ccoest = 'on'
			AND Ccocod = '$servicio'
			AND {$basedatos}_000018.fecha_data >= DATE_FORMAT(DATE_SUB(NOW(),INTERVAL 2 DAY),'%Y-%m-%d')
			AND oriced = pacced 
			AND oriori = '$wemp_pmla' 
			AND orihis = Ubihis 
			AND oriing = Ubiing 
			AND Oritid = Pactid
		UNION
		SELECT 
			'Cirugia'Habcod, Ubisac Habcco, Ubihis Habhis, Ubiing Habing, 
			CONCAT( pacno1, ' ', pacno2, ' ', pacap1, ' ', pacap2, '|', Pactid, '|', Pacced ) as nombre,
			Ubiptr
		FROM
			{$basedatos}_000011, {$basedatos}_000018, root_000036, root_000037
		WHERE
			Ccocir = 'on'
			AND Ccocod = Ubisac
			AND Ccoest = 'on'
			AND Ccocod = '$servicio'
			AND ubiald = 'off'
			AND oriced = pacced 
			AND oriori = '$wemp_pmla' 
			AND orihis = Ubihis 
			AND oriing = Ubiing 
			AND Oritid = Pactid
		ORDER by 1,5;";
			
	$res = mysql_query($q, $conexion);
	$num = mysql_num_rows($res);

	//Con tabla
	$consulta = "<table>";

	$cont1 = 0;
	$clase = 'fila1';

	if($num > 0){
		$consulta = $consulta."<tr class=encabezadoTabla align=center>";
		$consulta = $consulta."<td>Habitacion</td>";
		$consulta = $consulta."<td>Historia</td>";
		$consulta = $consulta."<td>Paciente</td>";
		$consulta = $consulta."<td>Accion</td>";
		$consulta = $consulta."<td>Mensajes<br>sin leer</td>";
		$consulta = $consulta."<td>Afinidad</td>";
		$consulta = $consulta."</tr>";

		while ($cont1 < $num)
		{
			$rs = mysql_fetch_array($res);

			if( $rs['Ubiptr'] != 'on' ){
				
				if(isset($rs['nombre']) && $rs['nombre'] != ''){
				
					@list( $rs['nombre'], $rs['Pactid'], $rs['Pacced'] ) = explode( "|", $rs['nombre'] );
					
					$consulta = $consulta."<tr class='$clase'>";
					if($clase == 'fila2'){
						$clase = 'fila1';
					} else {
						$clase = 'fila2';
					}

					$consulta = $consulta."<td align=center>".$rs['Habcod']."</td>";
					$consulta = $consulta."<td align=center>".$rs['Habhis']."-".$rs['Habing']."</td>";
					$consulta = $consulta."<td>".$rs['nombre']."</td>";
					$consulta = $consulta."<td><a href='irAPerfil(\"{$rs['Habhis']}\");'>Ir al Perfil</a></td>";
					
					$sinLeer = consultarMensajesSinLeer($conexion, $basedatos, 'Perfil', $rs['Habhis'],$rs['Habing'] );
					
					if( $sinLeer > 0 ){
						$consulta = $consulta."<td align='center'><blink><b>".$sinLeer."</b></blink></td>";
					}
					else{
						$consulta = $consulta."<td align='center'></td>";
					}
					
					//Afinidad
					$tipo = $color = '';
					clienteMagenta( $rs['Pacced'], $rs['Pactid'], $tipo, $color );
					
					if( !empty( $tipo ) ){
						$consulta = $consulta."<td style='font-size:10pt;color:$color' align='center'><b>";
						$consulta = $consulta.$tipo;
						$consulta = $consulta."</b></td>";
					}
					else{
						$consulta = $consulta."<td></td>";
					}
					
					$consulta = $consulta."</tr>";
				}
			}
			$cont1++;
		}
	} else {
		$consulta = $consulta."<tr><td colspan=3 class=encabezadoTabla>No se encontraron pacientes</td></tr>";
	}
	
	$consulta = $consulta."</table>";

	return $consulta;
}
 
/********************************************************************************
 * Consutla cuantos mensajes no se han leido de la Mensajeria Kardex
 ********************************************************************************/
function consultarMensajesSinLeer( $conex, $wbasedato, $programa, $historia, $ingreso, $fecha, $hora ){

	$val = false;

	$sql = "SELECT 
				count(*)
			FROM 
				{$wbasedato}_000117
			WHERE 
				Menhis = '$historia'
				AND Mening = '$ingreso'
				AND Menprg != '$programa'
				AND Menlei != 'on'
			;";
				 
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	
	if( $rows = mysql_fetch_array($res) ){
		$val = $rows[ 0 ];
	}
	
	return $val;
}
 
/************************************************************************************
 * Consulta la frecuencia en horas segun el codigo pasado por parametro
 *
 * Octubre 5 de 2011
 ************************************************************************************/
function consultarFrecuencia( $conex, $wbasedato, $codigo ){

	$val = false;

	$sql = "SELECT 
				*
			FROM 
				{$wbasedato}_000043
			WHERE 
				Percod = '{$codigo}'
			;";
				 
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	
	if( $rows = mysql_fetch_array($res) ){
		$val = $rows[ 'Perequ' ];
	}
	
	return $val;
}
 
 
 
 /*************************************************************************************************
 * Calcula la cantidad dispensada hasta una ronda dada
 * 
 * @return unknown_type
 *
 * Modificaciones:
 * Agosto 19 de 2011.		Se verifica que ronda se debe mirar, la primera o la segunda hora
 *************************************************************************************************/
function cantidadADispensarRondaKardex( $horasAplicar, $ronda ){
	
	$val = 0;
	
	if( empty( $horasAplicar ) ){
		return $val;
	}
	
	//Verifico si es la primera o segunda hora en la regleta
	//para esto se mira si ya paso la hora de la ronda
	//La ronda siempre es la que sigue, nunca se muestra rondas antes que la actual
	$timeRonda = strtotime( date( "Y-m-d" )." $ronda" );
	if( time() > $timeRonda ){
		$esPrimera = false;
	}
	else{
		$esPrimera = true;
	}
	
	if( $ronda == "00:00:00" ){
		$esPrimera = true;
	}
	
	//echo "<br>...$ronda...?".$esPrimera;
	
	$exp = explode( ",", $horasAplicar );
	
	for( $i = 0; $i < count( $exp ); $i++ ){
		
		$valores = explode( "-", $exp[$i] );
		
		if( $ronda == $valores[0] && $esPrimera ){
			
			$val = $valores[1];
			break;
		}
		elseif( $ronda == $valores[0] ){
			$esPrimera = true;
		}
	}
	
	return $val;
}
 
/************************************************************************************************************************
 * Dada una regleta de la forma hora1-cdi1-dis1,hora2-cdi2-dis2,hora3-cdi3-dis3..., cambia todas las cdin por la nueva
 * unidad de articulo
 ************************************************************************************************************************/
function nuevaDosis( $unidadArticulo, $regleta ){

	$val = "";
	
	if( empty( $regleta ) ){
		return $val;
	}
 
	$rondas = explode( ",", $regleta );
	
	for( $i = 0; $i < count($rondas); $i++ ){
		
		$valores = explode( "-", $rondas[$i] );
		
		if( true || $valores[0] != "Ant" ){
			
			if( $valores[1] > 0 ){
				$val .= ",".$valores[0]."-".round( $unidadArticulo, 3 )."-0";
			}
			else{
				$val .= ",".$valores[0]."-".$valores[1]."-".$valores[2];
			}
		}
	} 
	
	return substr( $val, 1 );
}

/*********************************************************************************************************************
 * Devuelve la hora de traslado de un paciente desde cualquier centro de costos que no se maneje ciclos de produccion
 * 
 * Nota: La primera del día
 * 
 * @param $conexion
 * @param $wbasedato
 * @param $historia
 * @param $ingreso
 * @param $fecha
 * @param $urgencia
 * @return unknown_type
 * 
 * Septiembre 26 de 2011
 *********************************************************************************************************************/
function consultarHoraTraslado( $conexion, $wbasedato, $historia, $ingreso, $fecha ){
	
	$qMv = "SELECT
				a.Hora_data
			FROM
				".$wbasedato."_000011 b,".$wbasedato."_000017 a
			WHERE
				Eyrhis = '$historia'
				AND Eyring = '$ingreso'
				AND Eyrtip = 'Recibo'
				AND a.Fecha_data = '".$fecha."'
				AND Ccocod = Eyrsor
				AND Ccocpx != 'on'
				AND Eyrest='on'
			ORDER BY
				Hora_data asc
			";
	
	$res = mysql_query( $qMv, $conexion ) or die( mysql_errno()." - Error en el query $qMv - ".mysql_error() );
	$numrows = mysql_num_rows( $res );
	
	if($numrows > 0 ){
		$rows = mysql_fetch_array( $res );
		
		return $rows['Hora_data'];
	}
	else{
		return false;
	}
}
 

/***********************************************************************************************************
 * Consulta la hora militar, sin minutos y segundos, de la ultima ronda dispensada
 *
 * Modificaciones:
 * - Noviembre 1 de 2011	(Edwin MG)	Se  modifica funcion para poder determinar si la 
 *										ultima ronda grabada corresponde al dia actual o al siguiente
 ***********************************************************************************************************/
function consultarUltimaRondaDispensadaKardex( $vectorAplicaciones ){
 
	$val = "|";
	
	if( empty( $vectorAplicaciones ) ){
		return $val;
	}
	
	$hoy = true;
 
	$rondas = explode( ",", $vectorAplicaciones );
	
	for( $i = 0; $i < count($rondas); $i++ ){
		
		$valores = explode( "-", $rondas[$i] );
		
		if( $valores[0] != "Ant" ){
		
			if( $valores[0] == "00:00:00" ){
				$hoy = false;
			}
			
			if( $valores[2] > 0 ){
				$val = $valores[0];
				list( $val ) = explode( ":", $val );
				
				$val .= "|".$hoy;
			}
		}
	} 
	
	return $val;
}

/************************************************************************************************************
 * Indica si un centro de costos comenzo ya con el ciclo de producción
 * 
 * @param $cco
 * @return unknown_type
 ************************************************************************************************************/
function tieneCpx( $conex, $bd, $cco ){
	
	$val = false;
	
	$sql = "SELECT
				*
			FROM
				{$bd}_000011
			WHERE
				ccocod = '$cco'
				AND ccocpx = 'on'
				AND ccoest = 'on'
				AND ccourg != 'on'
			";
				
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en elquery $sql - ".mysql_error() );
	$numrows = mysql_num_rows( $res );
	
	if( $numrows > 0 ){
		$val = true;
	}
	
	return $val;
}

/****************************************************************************************************
 * Indica si el paciente se encuentra en un centro de costos que tiene actualmente cpx 
 ****************************************************************************************************/
function tieneCpxPorHistoria( $conex, $bd, $his, $ing ){
	
	$val = false;
	
	$sql = "SELECT *
			  FROM {$bd}_000011 a, {$bd}_000018 b
			 WHERE ccocpx = 'on'
			   AND ccoest = 'on'		
			   AND ubihis = '$his'
			   AND ubiing = '$ing'
			   AND ubisac = ccocod"; //echo ".....<pre>$sql</pre>";				
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en elquery $sql - ".mysql_error() );
	$numrows = mysql_num_rows( $res );
	
	if( $numrows > 0 ){
		$val = true;
	}
	
	return $val;
}

 /**
  * Combina dos vectores
  */
 function cantidadCargadaDiaSiguiente( $vector ){
	
	if( !empty( $vector ) ){
		return;
	}
	
	$valoresVec = explode( ",", $vector );
	
	for( $i = 0; $i < count($valoresVec); $i++ ){
		
		$valVector = explode( "-", $valoresVec );
		
		
	}
	
	return substr( $subString, 1 );
 }
 
 /********************************************************************************
  * Agosto 3 de 2011
  * Si el kardex fue generado automaticamente, los campos karcon y kadare son
  * desactivados 
  ********************************************************************************/
function quitandoKardexAutomatico( $conex, $wbasedato, $his, $ing, $fecha ){
	
	//Agosto 25 de 2011. Se deja el kardex como venga, solo se quita el indicador		
	$sql = "UPDATE
				{$wbasedato}_000053 a
			SET
				karaut = 'off'
			WHERE
				a.fecha_data = '$fecha'
				AND karhis = '$his'
				AND karing = '$ing'
				AND karaut = 'on'
			"; //echo "<pre>....$sql</pre>";
			
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	
	if( mysql_affected_rows() > 0 ){
		return true;
	}
	
	return false;
}

/********************************************************************************
  * Agosto 25 de 2011
  * Si el kardex fue generado automaticamente, los campos karcon y kadare son
  * desactivados 
  ********************************************************************************/
function esAutomatico( $conex, $wbasedato, $his, $ing, $fecha ){
	
	$sql = "SELECT *
			FROM
				{$wbasedato}_000053 a
			WHERE
				a.fecha_data = '$fecha'
				AND karhis = '$his'
				AND karing = '$ing'
				AND karaut = 'on'
			"; //echo "<pre>....$sql</pre>";
			
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$numrows = mysql_num_rows( $res );
	
	if( $numrows > 0 ){
		return true;
	}
	
	return false;
}
 
 /********************************************************************************
  * Agosto 3 de 2011
  * Indica si un centro de costo maneja ciclos de produccion
  ********************************************************************************/
 function manejaCPX( $conex, $wbasedato, $cco ){
	
	$val = false;
	
	$sql = "SELECT
				*
			FROM
				{$wbasedato}_000011
			WHERE
				ccocod = '$cco'
				AND ccourg != 'on'
				AND ccocpx = 'on'
			";
			
	$res = mysql_query( $sql, $conex ) or die( mysql_errno(). " - Error en el query $sql - ".mysql_error() );
	$numrows = mysql_num_rows( $res );
	
	if( $numrows > 0 ){
		$val = true;
	}
	
	return $val;
 }
 
 /************************************************************************************************************************
 * Consulta la hora de corte de produccion para un tipo de articulo
 * 
 * @param $conexion
 * @param $wbasedatoMH
 * @param $wbasedatoCM
 * @param $codArticulo
 * @return unknown_type
 *
 * Agosto 3 de 2011
 ************************************************************************************************************************/
 function consultarHoraCorteDispensacionCpx( $conex, $wbasedato, $tipo, &$tiempoProduccion ){
 
	$val = false;
 
	$sql = "SELECT
				*
			FROM
				{$wbasedato}_000099
			WHERE
				tarcod = '$tipo'
				AND tarpdx = 'on'
				AND tarest = 'on'
			";
	
	$res = mysql_query( $sql, $conex ) or die( mysql_errno(). " - Error en el query - ".mysql_errno()  );
	$numrows = mysql_num_rows( $res );
	
	if( $numrows > 0 ){
		$rows = mysql_fetch_array( $res );
		$val = $rows['Tarhcp'];
		$tiempoProduccion = $rows['Tarpre'];
	}
	
	return $val;
 }
 
 
 /************************************************************************************************************************
 * Determina si un articulo es generico y devuelve el tipo de articulo al que pertenece
 * 
 * @param $conexion
 * @param $wbasedatoMH
 * @param $wbasedatoCM
 * @param $codArticulo
 * @return unknown_type
 *
 * Agosto 3 de 2011
 ************************************************************************************************************************/
function esArticuloGenericoCpx( $conexion, $wbasedatoMH, $wbasedatoCM, $codArticulo ){
	
	$sql = "SELECT
				*
			FROM
				{$wbasedatoMH}_000068,
				{$wbasedatoCM}_000002,
				{$wbasedatoCM}_000001
			WHERE
				artcod = '$codArticulo'
				AND arttip = tipcod
				AND tiptpr = arktip
				AND artest = 'on'
				AND arkest = 'on'
				AND tipest = 'on' 
			";
	
	$res = mysql_query( $sql, $conexion ) or die( mysql_errno(). " - Error en el query - ".mysql_errno()  );
	$numrows = mysql_num_rows( $res );
	
	if( $numrows > 0 ){
		
		$rows = mysql_fetch_array( $res );
		return $rows['Arktip'];
	}
	else{
		return false;
	}
}

/************************************************************************
 * Consulta cada cuanto se va a dispensar los articulos
 ************************************************************************/
function consultarTiempoDispensacion( $conex, $wemp ){
	return 2;
	$val = '';
	
	$sql = "SELECT
				Detval
			FROM
				root_000051
			WHERE
				Detapl = 'Dispensacion'
				AND Detemp = '$wemp'
			";
	
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$numrows = mysql_num_rows( $res ) or die( mysql_errno()." - Error en el query $sql - ".msyql_error() );
	
	if( $numrows > 0 ){
		$rows = mysql_fetch_array( $res );
		
		$val = $rows[ 'Detval' ];
	}
	
	return $val;
}

/**
 * Dado un vector con las horas a apllicar un medicamento, crea un vector de cantidad a aplicar por fecha
 * de la siguiente manera:
 * 
 * Hora1-Cantidadadispensar1-0, Hora2-Cantidadadispensar2-0, Hora3-Cantidadadispensar3-0,...
 * 
 * El campo $horasAplicar debe tener el siguiente formato
 * 
 * [ hora ] = 'contador'
 * 
 * contador: puede ser * o -. (*) indica que a esa hora se aplica y (-) que no se aplicar
 * hora: es la hora de aplicacion, como entero de 2-24
 * 
 * @param $horasAplicar
 * @param $horaIncio
 * @param $frecuencia
 * @param $tiempoDispensacion	Enteros pares (0,2,4,6,..)
 * @return unknown_type
 *
 * Modificaciones:
 * Agosto 19 de 2011.  Se tiene en cuenta el tiempo de dispensacion para crear la regleta.
 *
 */
function crearVectorAplicaciones( $horasAplicar, $frecuencia, $can, $tiempoDispensacion ){
	
	global $diasDispensacion;
	
	$can = round( $can, 3 );
	
	$val = "";
	$apl = 0;
	
	// 2012-09-04
	// Se aumenta hora máxima a 30
	if( $tiempoDispensacion > 2 ){
		$horaMaxima = ($diasDispensacion*24+6) + ceil( $tiempoDispensacion/2 )*2-2;
	}
	else{
		$horaMaxima = $diasDispensacion*24+6;
	}

	if( count($horasAplicar) > 0 ){
		
		$j = 0;
		$k = 0;
		
		for( $i = 0; $k <= $horaMaxima; $i += 2, $j += 2 ){
			
			if( $j == $frecuencia ){
				
				$j = 0;
				
				if( $j == 0 ){
					
					if( $k != 0 ){
						
						$k = $k%24;
						
						if( $k < 10 ){
							$val .= ",0".($k).":00:00-".($apl*$can)."-0";
						}
						else{
							if( $k < 24 ){
								$val .= ",".($k).":00:00-".($apl*$can)."-0";
							}
							else{
								if( $k - 24 < 10 ){
									$val .= ",0".($k - 24).":00:00-".($apl*$can)."-0";
								}
								else{
									$val .= ",".($k - 24).":00:00-".($apl*$can)."-0";
								}
							}
						}
					}
					$k = $i;
					$apl = 0;
				}
			}
			
			if( @$horasAplicar[$i] == "*" ){
				$apl++;
			}
		}
	}
	
	return substr( $val, 1 );
}


// $a = obtenerVectorAplicacionMedicamentos( "2011-07-29", "2011-07-29", "16:00:00", 6 );
// $b = obtenerVectorAplicacionMedicamentos( "2011-07-30", "2011-07-29", "16:00:00", 6 );
// echo "<pre>"; var_dump($b); echo "</pre>";
// foreach( $b as $keyB => $valueB ){
	// $a[] = $valueB;
// }
// echo "....<pre>"; var_dump($a ); echo "</pre>";
// echo crearVectorAplicaciones( $a, 2, 1, 6 );


/********************************************************************************************************************************************
 * Consulta la ultima ronda creada para un tipo de articulo
 * 
 * @param $tipo
 * @return unknown_type
 ********************************************************************************************************************************************/
function consultarUltimaRondaKardex( $conex, $wbasedato, $tipo ){
	
	$val = date("Y-m-d 00:00:00");
	
	$fecha = date( "Y-m-d", strtotime( date("Y-m-d H:i:s") )-24*3600 );
	
	
	
	//Consulto la ultima ronda que se hizo para un tipo de articulo
	//desde el día anterior, esto por que la siguiente ronda puede ser a la medianoche

	$sql = "SELECT
				*
			FROM
				{$wbasedato}_000106
			WHERE
				ecptar = '$tipo'
				AND ecpfec >= '$fecha'
				AND ecpest = 'on'
				AND ( ecpmod = 'P'
				OR ( 
					ecpmod = 'N'
					AND  UNIX_TIMESTAMP( NOW() )  > UNIX_TIMESTAMP(CONCAT( ecpfec,' ',ecpron ) ) 
				) )				
			ORDER BY
				ecpfec desc, ecpron desc 
			"; //echo "<BR>.......A: ".$sql; return;
	
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	
	if( $rows = mysql_fetch_array( $res) ){
		$val = $rows[ 'Ecpfec' ]." ".$rows[ 'Ecpron' ];
	}
	
	return $val;
}

/************************************************************************************************************************
 * Proxima ronda de produccion
 * 
 * @return unknown_type
 ************************************************************************************************************************/
function proximaRondaProduccionKardex( $fecha, $hora, $tiempo ){
	
	$val = strtotime( "$fecha $hora" )+3600*$tiempo;
	
	return $val;
}

/**************************************************************************************************************************
 * Calcula la cantidad total a dispensar para segun $horasAplicar
 **************************************************************************************************************************/
function calcularCantidadTotalACargarPorDia( $horasAplicar ){

	$val = 0;
	
	if( empty( $horasAplicar ) ){
		return $val;
	}
	
	$exp = explode( ",", $horasAplicar );
	
	for( $i = 0; $i < count( $exp ); $i++ ){
		
		$valores = explode( "-", $exp[$i] );
		
		$val += $valores[1];
	}
	
	return $val;
}

/**************************************************************************************************************************
 * Calcula la cantidad total a dispensar para segun $horasAplicar
 **************************************************************************************************************************/
function calcularCantidadTotalDispensadaPorDia( $horasAplicar ){

	$val = 0;
	
	if( empty( $horasAplicar ) ){
		return $val;
	}
	
	$exp = explode( ",", $horasAplicar );
	
	for( $i = 0; $i < count( $exp ); $i++ ){
		
		$valores = explode( "-", $exp[$i] );
		
		$val += $valores[2];
	}
	
	return $val;
}



/**************************************************************************************************************************
 * 
 **************************************************************************************************************************/
function calcularCantidadTotalADispensadaDia( $horasAplicar ){

	$val = 0;
	
	if( empty( $horasAplicar ) ){
		return $val;
	}
	
	$exp = explode( ",", $horasAplicar );
	
	for( $i = 0; $i < count( $exp ); $i++ ){
		
		$valores = explode( "-", $exp[$i] );
		
		$val += $valores[2];
	}
	
	return $val;
}

/****************************************************************************************
 * Calcula la cantidad a dispensar hasta una ronda dada
 * 
 * @return unknown_type
 ****************************************************************************************/
function cantidadTotalADispensarRonda( $horasAplicar, $ronda ){
	
	$val = 0;
	
	if( empty( $horasAplicar ) ){
		return $val;
	}
	
	$exp = explode( ",", $horasAplicar );
	
	for( $i = 0; $i < count( $exp ); $i++ ){
		
		$valores = explode( "-", $exp[$i] );
		
		$val += $valores[1];
		
		if( $ronda == $valores[0] ){
			break;
		}
	}
	
	return $val;
}


/****************************************************************************************
 * Calcula la cantidad dispensada hasta una ronda dada
 * 
 * @return unknown_type
 ****************************************************************************************/
function cantidadTotalDispensadaRonda( $horasAplicar, $ronda ){
	
	$val = 0;
	
	if( empty( $horasAplicar ) ){
		return $val;
	}
	
	$exp = explode( ",", $horasAplicar );
	
	for( $i = 0; $i < count( $exp ); $i++ ){
		
		$valores = explode( "-", $exp[$i] );
		
		$val += $valores[2];
		
		if( $ronda == $valores[0] ){
			break;
		}
	}
	
	return $val;
}

/*************************************************************************************************
 * Calcula la cantidad dispensada hasta una ronda dada
 * 
 * @return unknown_type
 *
 * Modificaciones:
 * Agosto 19 de 2011.		Se verifica que ronda se debe mirar, la primera o la segunda hora
 *************************************************************************************************/
function cantidadDispensadaRondaKardex( $horasAplicar, $ronda ){
	
	$val = 0;
	
	if( empty( $horasAplicar ) ){
		return $val;
	}
	
	//Verifico si es la primera o segunda hora en la regleta
	//para esto se mira si ya paso la hora de la ronda
	//La ronda siempre es la que sigue, nunca se muestra rondas antes que la actual
	$timeRonda = strtotime( date( "Y-m-d" )." $ronda" );
	if( time() > $timeRonda ){
		$esPrimera = false;
	}
	else{
		$esPrimera = true;
	}
	
	$exp = explode( ",", $horasAplicar );
	
	for( $i = 0; $i < count( $exp ); $i++ ){
		
		$valores = explode( "-", $exp[$i] );
		
		if( $ronda == $valores[0] && $esPrimera ){
			
			$val = $valores[2];
			break;
		}
		elseif( $ronda == $valores[0] ){
			$esPrimera = true;
		}
	}
	
	return $val;
}

/************************************************************************************************
 * crea un vector con las cantidades cargadas durante el dia segun la hora de aplicaciones
 * @return unknown_type
 * 
 * Julio 14 de 2011
 ************************************************************************************************/
function crearAplicacionesCargadasPorHorasKardex( $vector, $cantidad ){
	
	if( $cantidad == 0 ){
		return $vector;
	}
	
	if( empty( $vector ) ){
		return "";
	}
	elseif( !empty( $vector ) ){
		//Obtengo las horas de aplicacion del medicamento para el paciente
		$exp = explode( ",", $vector );
	}
	
	$nuevoAplicaciones = "";
	
	if( !empty($vector) ){
		
		$acumuloFraccionCargada = 0;
		
		for( $acumuloFraccionCargada = 0, $j = 0; $acumuloFraccionCargada < $cantidad; $j++ ){
			
			if( $j < count($exp) ){
				
				/************************************
				 * Formato para valores
				 * [0]	Hora
				 * [1]	Cantidad a dispensar
				 * [2]	Cantidad dispensada
				 * @var unknown_type
				 ************************************/
				$valores = explode( "-", $exp[$j] );
				
				if( $valores[1] - $valores[2] > 0 ){
					
					if( $cantidad - $acumuloFraccionCargada >= $valores[1] - $valores[2] ){
						$fraccionCargada = $valores[1] - $valores[2];
					}
					else{
						$fraccionCargada = $cantidad - $acumuloFraccionCargada;
					}
					
					$acumuloFraccionCargada += $fraccionCargada;
					
					$exp[$j] = $valores[0]."-".$valores[1]."-".( round( $valores[2]+$fraccionCargada, 3 ) );
					
					$j--;
				}
			}
			else{
				break;
			}
		}
		
		for( $i = 0; $i < count($exp); $i++ ){
			
			if( $i == 0 ){
				$nuevoAplicaciones = $exp[$i];
			}
			else{
				$nuevoAplicaciones .= ",".$exp[$i];
			}
		}
	}
	
	return $nuevoAplicaciones;
}

//echo "...........".crearAplicacionesCargadasPorHorasKardex( "02:00:00-0-0,04:00:00-0-0,06:00:00-0-0,08:00:00-0-0,10:00:00-0.9-0,12:00:00-0.7-0,14:00:00-0.5-0,16:00:00-0.5-0,18:00:00-0.5-0,20:00:00-0.5-0,22:00:00-0.5-0,00:00:00-0.5-0", 2 );

/************************************************************************************************
 * Trae la informacion correspondiente al tipo de articulo
 * 
 * @param $conex
 * @param $wbasedato
 * @param $tipo
 * @return unknown_type
 ************************************************************************************************/
function consultarinfotipoarticulosKardex( $conex, $wbasedato ){
	
	$val = "";
	
	$tiposAriculos = Array();
	
	//Consultando los tipos de protocolo
	$sql = "SELECT 
				* 
			FROM
				{$wbasedato}_000099 a
			WHERE
				Tarest = 'on'
				AND tarhcp != '00:00:00'
				AND tarhcd != '00:00:00'
			";
				
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$numrows = mysql_num_rows( $res );
				
	if( $numrows > 0 ){

		for( $i = 0; $rows = mysql_fetch_array( $res ); $i++ ){
			$tiposAriculos[ $rows[ 'Tarcod' ] ]['codigo'] = $rows[ 'Tarcod' ];
			$tiposAriculos[ $rows[ 'Tarcod' ] ]['nombre'] = $rows[ 'Tardes' ];
			$tiposAriculos[ $rows[ 'Tarcod' ] ]['tiempoPreparacion'] = consultarTiempoDispensacion( $conex, '01' ); //$rows[ 'Tarpre' ];
			$tiposAriculos[ $rows[ 'Tarcod' ] ]['horaCorteProduccion'] = $rows[ 'Tarhcp' ];
			$tiposAriculos[ $rows[ 'Tarcod' ] ]['horaCaroteDispensacion'] = $rows[ 'Tarhcd' ];
			
			$aux = consultarUltimaRondaKardex( $conex, $wbasedato, $rows[ 'Tarcod' ] );
			
			$auxfec = ""; 
			@list( $auxfec, $tiposAriculos[ $rows[ 'Tarcod' ] ]['ronda'] ) = explode( " ", $aux );
			
			$tiposAriculos[ $rows[ 'Tarcod' ] ]['proximaRonda'] = proximaRondaProduccionKardex( $auxfec, $tiposAriculos[ $rows[ 'Tarcod' ] ]['ronda'], $tiposAriculos[ $rows[ 'Tarcod' ] ]['tiempoPreparacion'] );
			
			$tiposAriculos[ $rows[ 'Tarcod' ] ]['tieneArticulos'] = 0;
			$tiposAriculos[ $rows[ 'Tarcod' ] ]['totalArticulosSinFiltro'] = 0;
//			if( $i > 10 ){ die(".....Se paso"); }
		}
	}
	
	return $tiposAriculos;
}

/************************************************************************************************
 * Verifica que un usuario tenga permiso de usar el kardex de enfermería editable.
 * @return unknown_type
 ************************************************************************************************/
function verficacionKardexEditable(){
	
	global $wuser;
	global $conex;
	
	$val = false;
	
	$sql = "SELECT
				*
			FROM
				root_000021
			WHERE
				codgru = '110'
				AND codopt = '1586'
			";
	
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$numrows = mysql_num_rows( $res );
	
	if( $numrows > 0 ){
		
		$rows = mysql_fetch_array( $res );

		$exp = explode( "-", $rows['Usuarios'] );
		
		foreach( $exp as $keyUsuario => $valueUsuario ){
			
			if( $valueUsuario == $wuser ){
				return true;
			}
		}
	}
	
	return false;
}

/************************************************************************************
 * Verifico que los articulos si esten guardados
 * 
 * @param $conex
 * @param $wbasedato
 * @param $tabla
 * @param $articulos
 * @return unknown_type
 * 
 * Mayo 20 de 2011
 ************************************************************************************/
function verificacionArticulosGuardados( $conex, $wbasedato, $tabla, $articulos, $descripcion ){
	
	global $usuario;
	
	$malos = Array();
	
	for( $i = 0; $i < count( $articulos ); $i++ ){
		
		//Busco articulos repetidos para un paciente
		//No se permite tener para un paciente, articulos repetidos con la misma fecha y hora de inicio
		$sql = "SELECT
					* 
				FROM
					{$wbasedato}_{$tabla}
				WHERE
					kadfec = '{$articulos[$i][16]}'
					AND kadhis = '{$articulos[$i]['Kadhis']}'
					AND kading = '{$articulos[$i]['Kading']}'
					AND kadhin = '{$articulos[$i]['Kadhin']}'
					AND kadfin = '{$articulos[$i]['Kadfin']}'
					AND kadart = '{$articulos[$i]['Kadart']}'
					AND kadido = '{$articulos[$i]['Kadido']}'
				";

		$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
		$numrows = mysql_num_rows( $res );

		//Si hay mas de un articulo borro un articulo, ya que no esta
		if( $numrows > 1 ){
			
			// $malos[$i] = $i;
			
			$rows = mysql_fetch_array( $res, MYSQL_ASSOC );
			
			//Creo un array con toda la informacion del articulo
			$datos = "";
			foreach( $rows as $keyDatos => $valueDatos ){
				$datos .= ",".$keyDatos.":".$valueDatos;
			}
			
			if( !empty($datos) ){
				$datos = substr( $datos, 1);
			}
			
			$tabla_ext = $tabla == "000054" ? "000208": "000209";
			
			//Borro solo el primer registro encontrado
			$sql = "DELETE {$wbasedato}_{$tabla_ext} 
			          FROM {$wbasedato}_{$tabla_ext}, {$wbasedato}_{$tabla} 
					 WHERE {$wbasedato}_{$tabla}.id = '{$rows[ 'id' ]}'
					   AND Ekxhis = Kadhis
					   AND Ekxing = Kading
					   AND Ekxfec = Kadfec
					   AND Kadart = Ekxart
					   AND Kadido = Ekxido";
			
			$resDeleteExt = mysql_query( $sql, $conex );
			
			//Borro solo el primer registro encontrado
			$sql = "DELETE FROM {$wbasedato}_{$tabla} 
					 WHERE id = '{$rows[ 'id' ]}'";
			
			$resDelete = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
			
			//registro en auditoria cierre kardex el articulo que se borro por duplicado
			registrarAuditoriaCierreKardex( $articulos[0]['Kadhis'], $articulos[0]['Kading'], $usuario->codigo, "*".$descripcion."*".$datos );
		}
		elseif( $numrows == 0 ){
		
			$malos[$i] = $i;
		
			//Si es 0 significa que el registro no se insertó en la nueva tabla
			//Creo un array con toda la informacion del articulo
			$datos = "";
			foreach( $articulos[$i] as $keyDatos => $valueDatos ){
				if( !is_numeric( $keyDatos ) ){
					$datos .= ",".$keyDatos.":".$valueDatos;
				}
			}
			
			if( !empty($datos) ){
				$datos = substr( $datos, 1);
			}
		
			registrarAuditoriaCierreKardex( $articulos[0]['Kadhis'], $articulos[0]['Kading'], $usuario->codigo, "*".$descripcion."*No insertado*".$datos );
		}
	}
	
	return $malos;
}

/************************************************************************************
 * Guardo en un array todos los elementos de una consulta
 * @return unknown_type
 * 
 * Mayo 20 de 2011
 ************************************************************************************/
function elementosGrabados( $conex, &$array, $consulta ){
	
	$array = Array();
	
	$sql = "$consulta";
//	echo "<br>.......".$sql;
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$numrows = mysql_num_rows( $res );
	
	if( $numrows > 0 ){
		for( $i = 0; $rows = mysql_fetch_array( $res ); $i++ ){
			$array[$i] = $rows; 
		}
	}
}

/**********************************************************************************************************************************
 * Indica si un articulo peretenece al stock
 * 
 * @param $conex
 * @param $wbasedato
 * @param $articulo
 * @param $cco
 * @return unknown_type
 **********************************************************************************************************************************/
function esStock( $conex, $wbasedato, $articulo, $cco ){
	
	$val = false;
	
	$sql = "SELECT
				Arscod
			FROM
				{$wbasedato}_000091,
				{$wbasedato}_000011
			WHERE
				arscco = '$cco'
				AND arscod = '$articulo'
				AND arsest = 'on'
				AND ccocod = arscco
				AND ccourg != 'on'
			"; //echo $sql;
				
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".msyql_error() );
	$numrows = mysql_num_rows( $res );
	
	if( $numrows > 0 ){
		$val = true;
	}
	
	return $val;
}

/************************************************************************************************************************
 * Dados una fecha actual, frecuencia y una fecha y hora de inicio del medicamento, retorna la ultima hora
 * de suministro antes de la fecha de corte
 * 
 * @param $fechaActual
 * @param $fechaIncio
 * @param $horaInicio
 * @param $frecuencia
 * @return unknown_type
 * 
 * Nota: La frecuencia esta dada en horas
 * 
 * Abril 13 1 de 2011
 ************************************************************************************************************************/
function suministroAntesFechaCorte( $fechaActual, $horaCorte, $fechaIncio, $horaInicio, $frecuencia ){
	
	$horaIncioActual = false;
	
	//Fecha actual debe ser menor o igual que la fecha de inicio
	if( $fechaIncio <= $fechaActual ){
		
		//convierto las fechas
		$fechorActual = strtotime( "$fechaActual $horaCorte" );
		$fechorInicio = strtotime( "$fechaIncio $horaInicio" );
		
		if( $fechorActual >= $fechorInicio ){
		
			$horaIncioActual = $horaInicio;
			
			//Sumo la frecuencia hasta el día en que comience el medicamento
			for( $i = 0 ; $fechorInicio <= $fechorActual; $i++ ){

				$fechorInicio += $frecuencia*3600;
				$horaIncioActual = $fechorInicio;
			}
			$horaIncioActual = $fechorInicio-$frecuencia*3600;
		}
	}
	
	return $horaIncioActual;
}

/************************************************************************************************************************
 * Registra la auditoria de los articulos que van a ser borrados por que se inactivaron en el sistema
 * 
 * @param $conex
 * @param $wbasedato
 * @param $historia
 * @param $ingreso
 * @param $fecha
 * @return unknown_type
 * 
 * Creacion: Abril 5 de 2011
 ************************************************************************************************************************/
function articulosBorradosInactivos( $conex, $wbasedato, $historia, $ingreso, $fecha, $usuario, $tieneGruposIncluidos, $tipoProtocolo ){
	
	global $codigoServicioFarmaceutico;
	
//	$sql = "SELECT 
//				*
//			FROM
//				{$wbasedato}_000054 a, {$wbasedato}_000026 b
//			WHERE
//				kadhis = '$historia'
//				AND kadori = '$codigoServicioFarmaceutico'
//				AND kading = '$ingreso'
//				AND kadfec = '$fecha'
//				AND kadart = artcod
//				AND artest != 'on' ";
	
	$sql = "SELECT 
				*
			FROM
				".$wbasedato."_000054, {$wbasedato}_000026 b
			WHERE
				Kadhis = '$historia'
				AND Kading = '$ingreso'
				AND Kadpro LIKE '$tipoProtocolo' 
				AND Kadori = '$codigoServicioFarmaceutico'" ;
				if($tieneGruposIncluidos){
					$sql .= " AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN $usuario->gruposMedicamentosQuery ";
				}
				$sql .= " AND Kadfec = '$fecha'
				AND Kadcco = '$usuario->centroCostosGrabacion'
				AND kadart = artcod
				AND artest != 'on'
			"; //echo ".......<pre>$sql</pre>";
				
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query: $sql - ".mysql_error() );
	
	for( $i = 0; $rows = mysql_fetch_array( $res ); $i++ ){

		$mensajeAuditoria = obtenerMensaje( 'MSJ_ARTICULO_ELIMINADO' );

		//Registro de auditoria
		$auditoria = new AuditoriaDTO();

		$auditoria->historia = $historia;
		$auditoria->ingreso = $ingreso;
		$auditoria->descripcion = "{$rows['Kadart']}, inactivo en el sistema";
		$auditoria->fechaKardex = $fecha;
		$auditoria->mensaje = $mensajeAuditoria;
		$auditoria->idOriginal = $rows['Kauido'];
		$auditoria->seguridad = $usuario->codigo;

		registrarAuditoriaKardex( $conex,$wbasedato,$auditoria );
	}
}

function consultaInformacionMedico( $conex, $wbasedato, $codigoMatrix ){
	
	$informacion = false;
	
	$sql = "SELECT * 
			  FROM ".$wbasedato."_000048 
			 WHERE Meduma = '".$codigoMatrix."' 
			   AND Medest='on';"; //echo "....$sql";
				
	$res = mysql_query( $sql, $conex ) or die ( "Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error() );
	$num = mysql_num_rows($res);

	if( $num > 0 ){
		
		$rows = mysql_fetch_array( $res );
		
		$informacion['nombres'] = $rows['Medno1']." ".$rows['Medno2'];
		$informacion['apellidos'] = $rows['Medap1']." ".$rows['Medap2'];
		$informacion['tipoDocumento'] = $rows['Medtdo'];
		$informacion['nroDocumento'] = $rows['Meddoc'];
		$informacion['especialidad'] = $rows['Medesp'];
		$informacion['registroMedico'] = $rows['Medreg'];
	}
				
	return $informacion;
}

///--------------------
function consultarInfoPacienteOrdenHCEPorHistoria( $conex, $wbasedato, $historia ){

	
	global $wemp_pmla;
	$paciente = new pacienteKardexDTO();

	$q = "SELECT pacno1, pacno2, pacap1, pacap2, pactid, pacced, Ubisac, Ubihac, Ubisan, Ubihan, Ubialp, Ubiald, Ubiptr,
				 d.fecha_data fecha_data, d.hora_data hora_data, Pacnac,
				 Ingres, Ingnre, '' fechaServicio, '' horaServicio, e.Cconom, Orihis, Oriing, e.Ccourg, e.Ccocir, Pacsex, 
				 f.Ccocod AS Ubiste, e.Ccoayu, f.Cconom as Cconal, f.Ccourg as Ccoual, f.Ccocir as Ccocal, f.Ccoayu as Ccoaal
			FROM root_000036 a, 
				 root_000037 b, 
				 ".$wbasedato."_000016 c, 
				 ".$wbasedato."_000018 d
	   LEFT JOIN ".$wbasedato."_000011 e
			  ON d.Ubisac = e.Ccocod
	   LEFT JOIN ".$wbasedato."_000011 f
			  ON d.Ubiste = f.Ccocod
		   WHERE oriced = pacced
				 AND Ubihis = Orihis
				 AND Ubiing = Oriing
				 AND Inghis = Orihis
				 AND Inging = Oriing
				 AND Oriori = '$wemp_pmla'
				 AND Orihis = '$historia'
			";	

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if ($num > 0)
	{
		$info = mysql_fetch_array($res);
		
		$paciente->servicioRealActual = $info['Ubisac'];
		$paciente->nombreRealServicioActual = $info['Cconom'];
		
		if( $info['Ubiste'] != NULL && $info['Ccoaal'] == 'on' ){
			$info['Cconom'] = $info['Cconal'];
			$info['Ccourg'] = $info['Ccoual'];
			$info['Ccocir'] = $info['Ccocal'];
			$info['Ccoayu'] = $info['Ccoaal'];
			$info['Ubisac'] = $info['Ubiste'];
		}

		$paciente->historiaClinica = $info['Orihis'];
		$paciente->ingresoHistoriaClinica = $info['Oriing'];
		$paciente->nombre1 = $info['pacno1'];
		$paciente->nombre2 = $info['pacno2'];
		$paciente->apellido1 = $info['pacap1'];
		$paciente->apellido2 = $info['pacap2'];
		$paciente->documentoIdentidad = $info['pacced'];
		$paciente->tipoDocumentoIdentidad = $info['pactid'];
		$paciente->fechaNacimiento = $info['Pacnac'];
		$paciente->servicioActual = $info['Ubisac'];
		$paciente->servicioAnterior = $info['Ubisan'];
		$paciente->habitacionActual = $info['Ubihac'];
		$paciente->habitacionAnterior = $info['Ubihan'];
		$paciente->numeroIdentificacionResponsable = $info['Ingres'];
		$paciente->nombreResponsable = $info['Ingnre'];
		
		//Consulto la fecha y hora de traslado al piso
		$qMv = "SELECT
					".$wbasedato."_000017.Fecha_data,".$wbasedato."_000017.hora_data
				FROM 
					".$wbasedato."_000017, ".$wbasedato."_000011 
				WHERE 
					Eyrhis = '$paciente->historiaClinica' 
					AND Eyring = '$paciente->ingresoHistoriaClinica' 
					AND Eyrtip = 'Recibo'
					AND Ccocod = Eyrsor	
					AND Eyrest='on'
				ORDER BY 1 DESC, 2 DESC";

		$resMv = mysql_query($qMv,$conex) or die ("Error: " . mysql_errno() . " - en el querys: $qMv - " . mysql_error());
		$contMv = mysql_num_rows($resMv);
		
		if( $rowsMv = mysql_fetch_array( $resMv ) ){
			$info['fechaServicio'] = $rowsMv['Fecha_data'];
			$info['horaServicio'] = $rowsMv['hora_data'];
		}

		$paciente->fechaHoraIngresoServicio = $info['fechaServicio']." ".$info['horaServicio'];

		$paciente->fechaIngreso = $info['fecha_data'];
		$paciente->horaIngreso = $info['hora_data'];

		$paciente->altaDefinitiva = $info['Ubiald'];
		$paciente->altaProceso = $info['Ubialp'];
		
		$paciente->sexo = $info['Pacsex'];
		
		$paciente->esDeAyudaDx = ( $info['Ubiste'] != NULL || $info['Ccoayu'] == 'on' || $info['Ccoaal'] == 'on' ) ? true: false;

		$estado = false;
		if($info['Ubiptr'] == 'on'){
			$paciente->ultimoMvtoHospitalario = "En proceso de traslado";
			$estado = true;
		}

		if ($info['Ubialp'] == 'on'){
			$paciente->ultimoMvtoHospitalario = "Alta en proceso";
			$estado = true;
		}

		if ($info['Ubiald'] == 'on') {
			$paciente->ultimoMvtoHospitalario = "Alta definitiva";
			$estado = true;
		}

		if(!$estado){
			$paciente->ultimoMvtoHospitalario = "En habitaci&oacute;n";
		}
		$paciente->nombreServicioActual = $info['Cconom'];
		
		//El paciente se encuentra en cirugia o en urgencias
		$paciente->enCirugia = isset($info['Ccocir']) && $info['Ccocir'] == "on" ? true : false;
		$paciente->enUrgencias = isset($info['Ccourg']) && $info['Ccourg'] == "on" ? true : false;

		//Edad
		$ann=(integer)substr($paciente->fechaNacimiento,0,4)*360 +(integer)substr($paciente->fechaNacimiento,5,2)*30 + (integer)substr($paciente->fechaNacimiento,8,2);
		$aa=(integer)date("Y")*360 +(integer)date("m")*30 + (integer)date("d");
		$ann1=($aa - $ann)/360;
		$meses=(($aa - $ann) % 360)/30;
		if ($ann1<1){
			$dias1=(($aa - $ann) % 360) % 30;
			$wedad=(string)(integer)$meses." mes(es) ".(string)$dias1." dia(s)";
			$anos = 0;
		} else {
			$dias1=(($aa - $ann) % 360) % 30;
			$wedad=(string)(integer)$ann1." a&ntilde;o(s) ".(string)(integer)$meses." mes(es) ".(string)$dias1." dia(s)";
			$anos = (integer)$ann1;
		}
		$paciente->edadPaciente = $wedad;
		$paciente->anosPaciente = $anos;  		
	}
	return $paciente;
}

/******************************************************************************************************
 * Indica si hay articulos en la temporal para un paciente
 * 
 * @param $conex
 * @param $wbasedato
 * @param $historia
 * @param $ingreso
 * @param $fecha
 * @return unknown_type
 * 
 * Marzo 8 de 2011
 ******************************************************************************************************/
function hayArticulosEnTemporal( $conex, $wbasedato, $historia, $ingreso, $fecha ){

	$sql = "SELECT 
				*
			FROM
				{$wbasedato}_000060
			WHERE
				kadhis = '$historia'
				AND kading = '$ingreso'
				AND kadfec = '$fecha'
			";
				
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en la consulta - $sql - ". mysql_error() );
	$numrows = mysql_num_rows( $res );
	
	if( $numrows > 0 ){
		return true;
	}
	else{
		return false;
	}
}


function ConectarFTP( $server, $port, $user, $password, $modo ){
	
	//Permite conectarse al Servidor FTP
	$id_ftp = ftp_connect( $server, $port ); //Obtiene un manejador del Servidor FTP
	
	if( $id_ftp ){
		
		$login = ftp_login( $id_ftp, $user, $password ); //Se loguea al Servidor FTP
		
		if( $login ){
			$pasv = ftp_pasv( $id_ftp, $modo ); //Establece el modo de conexión
			
			if( !$pasv ){
				$id_ftp = false;
			}
		}
		else{
			$id_ftp = false;
		}
	}
	
	return $id_ftp; //Devuelve el manejador a la función
}

function subirArchivosFtp( $archivo_remoto, $archivo_local, $wemp_pmla = '01' ){
	
	$val = false;
	
	$ftpLaboratorio = consultarAliasPorAplicacion( $conex, $wemp_pmla, 'ftpLaboratorio' );
	
	list( $server, $port, $user, $password, $carpeta ) = explode( ",", $ftpLaboratorio );
	
	//Sube archivo de la maquina Cliente al Servidor (Comando PUT)
	$id_ftp = ConectarFTP( $server, $port, $user, $password, $modo = true ); //Obtiene un manejador y se conecta al Servidor FTP
	
	if( $id_ftp ){
		
		$put = ftp_put( $id_ftp, $carpeta.$archivo_remoto, $archivo_local, FTP_ASCII );

		if( $put ){
			$val = true;
			
			//Sube un archivo al Servidor FTP en modo Binario
			ftp_quit($id_ftp); //Cierra la conexion FTP
		}
	}
		
	return $val;
}

function crearMensajesHL7OLM( $conex, $wemp_pmla, $wbasedato, $historia, $ingreso, $usuario ){
	
	$autorizacion 		= consultarAliasPorAplicacion( $conex, $wemp_pmla, 'LMAautorizacion' );
	$ipLabTomaMuestra 	= consultarAliasPorAplicacion( $conex, $wemp_pmla, 'ipLMATomaMuestra' );
	
	$whce = consultarAliasPorAplicacion( $conex, $wemp_pmla, 'hce' );
	$wcliame = consultarAliasPorAplicacion( $conex, $wemp_pmla, 'cliame' );
	
	$mensaje_tm	= "";
	$encHl7 	= "";
	$tip_orden 	= "";
	$nro_orden 	= "";
	
	$sql = "SELECT *
			  FROM ".$whce."_000027
			 WHERE Ordhis = '".$historia."'
			   AND Ording = '".$ingreso."'
			   AND Ordest = 'on'
			   AND Ordfec = '".date("Y-m-d")."'
			";
			
	$sql = "SELECT *
			  FROM ".$whce."_000027 a
			 WHERE Ordhis = '".$historia."'
			   AND Ording = '".$ingreso."'
			   AND Ordest = 'on'
			   AND Ordtor IN ( SELECT Dettor 
								 FROM ".$whce."_000028 b 
								WHERE b.Dettor = a.Ordtor 
								  AND b.Detnro = a.Ordnro 
								  AND Detenv = 'on' 
								  AND b.Detest = 'on' )
			";
	
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	
	$paciente	= consultarInfoPacienteOrdenHCEPorHistoria( $conex, $wbasedato, $historia );
	
	//Está función se encuentra en el script interoperabilidad/procesos/funcionesGeneralesEnvioHL7.php
	$pac = informacionPaciente( $conex, $wemp_pmla, $historia, $ingreso );
	
	$idstm = [];
	
	while( $rows = mysql_fetch_array($res) )
	{	
		$tablaOfertas 	= "";
		$campoOferta	= "";
		$campoEstado	= "";
				
		
		//Consulto si existe cups ofertados por tipo de orden
		$sql = "SELECT Valtoc, Valcoc, Valeoc
				  FROM ".$wbasedato."_000267
				 WHERE valtor = '".$rows['Ordtor']."'
				   AND valest = 'on'
			  GROUP BY 1,2,3";
		
		$resToOfertado 	= mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
		$numToOfertado	= mysql_num_rows($resToOfertado);
		
		if( $numToOfertado > 0 ){
			
			if( $rowsToOfertado = mysql_fetch_array( $resToOfertado ) ){
				$tablaOfertas 	= $rowsToOfertado['Valtoc'];
				$campoOferta	= $rowsToOfertado['Valcoc'];
				$campoEstado	= $rowsToOfertado['Valeoc'];
			}
		}
		else{
			//Si no se encuentra en la tabla entonces no se puede enviar el mensaje
			continue;
		}
		
		$medico		= informacionMedico( $conex, $wbasedato, $wemp_pmla, $rows['Ordusu'] );
			
		$sql = "SELECT a.Dettor, a.Detnro, a.Detite, a.Detcod, c.Codigo, c.Nombre, b.Codcups, a.id, Detesi, Detlog, Detfec, Detutm, Detjus
				  FROM ".$whce."_000028 a, ".$whce."_000047 b, root_000012 c
				 WHERE a.Dettor = '".$rows['Ordtor']."'
				   AND a.Detnro = '".$rows['Ordnro']."'
				   AND a.Detcod = b.codigo
				   AND a.Detest = 'on'
				   AND b.Estado = 'on'
				   AND b.Codcups= c.Codigo
				   AND a.Detenv = 'on'
				 UNION
				SELECT a.Dettor, a.Detnro, a.Detite, a.Detcod, c.Codigo, c.Nombre, b.Codcups, a.id, Detesi, Detlog, Detfec, Detutm, Detjus
				  FROM ".$whce."_000028 a, ".$whce."_000017 b, root_000012 c
				 WHERE a.Dettor = '".$rows['Ordtor']."'
				   AND a.Detnro = '".$rows['Ordnro']."'
				   AND a.Detcod = b.codigo
				   AND a.Detest = 'on'
				   AND b.Nuevo  = 'on'
				   AND b.Estado = 'on'
				   AND b.Codcups= c.Codigo
				   AND a.Detenv = 'on'
				";
		
		$resOrden	= mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
		$num		= mysql_num_rows( $resOrden );
		// $ordenAnexa = $rows['Ordana'] > 0 ? $rows['Ordtor']."-".$rows['Ordana'] : '';
		// $ordenAnexa = $rows['Ordana'] > 0 ? $rows['Ordotr'] : '';
		
		$ordenAnexa = "";
		//Si es una orden anexa, se debe buscar la orden de laboratorio anterior
		if( $rows['Ordana'] > 0 ){
			
			$sql = "SELECT Ordotr
					  FROM ".$whce."_000027 a
					 WHERE a.Ordtor = '".$rows['Ordtor']."'
					   AND a.Ordnro = '".$rows['Ordana']."'
					";
			
			$resOrdenAnexaLab	= mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
			
			if( $rowOrdenLaboratorioAnex = mysql_fetch_array($resOrdenAnexaLab) ){
				$ordenAnexa = $rowOrdenLaboratorioAnex['Ordotr'];
			}
		}
		
		if( $num > 0 )
		{
			$ids = [];
			
			// $medico->tipoDocumento = $info['Medtdo'];
			// $medico->numeroDocumento = $info['Meddoc'];
			
			$mensajes 		= [];
			// $mensaje_tm		= "";
			$estadoPorOrden = '';
			$conEstudios	= false;	//Indica si la orden tiene uno o más estudios para enviar por HL7
						
			while( $rowOrden = mysql_fetch_array( $resOrden ) )
			{
				//Consulto si el examen está ofertado
				$sql = "SELECT *
						  FROM ".$tablaOfertas."
						 WHERE ".$campoOferta." = '".$rowOrden['Codcups']."'
						   AND ".$campoEstado." = 'on'";
				
				$resHasOffert = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
				$numHasOffert = mysql_num_rows($resHasOffert);
				
				//Si el examen no está ofertado, continuo con el siguiente item
				if( $numHasOffert == 0 ){
					continue;
				}
				
				$conEstudios = true;
				
				$estOrden = 'O';	//Estado por estudio
				
				$estadoPorOrden = $rowOrden['Detlog'] == 'N' ? 'NW' : '' ;
				$estadoPorOrden = $rowOrden['Detlog'] == 'M' ? 'XO' : $estadoPorOrden ;
				$estadoPorOrden = $rowOrden['Detesi'] == 'C' ? 'OC' : $estadoPorOrden ;

				$justificacion = str_replace( [ "\n","\r" ]," ",$rowOrden['Detjus'] );
				
				
				// //Busco el estado del examen
				// //Solo cambia si es estado cancelado
				// $sql = "SELECT b.*
						  // FROM ".$wbasedato."_000045 a, ".$wbasedato."_000257 b
						 // WHERE Eexcod = '".$rowOrden['Detesi']."'
						   // AND Eexcan = 'on'
						   // AND Eexest = 'on'
						   // AND Estepc = Eexcod
						// ";
				
				// $resEst	= mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
				// if( $rowEst = mysql_fetch_array( $resEst ) ){
					// $estOrden = $rowEst['Esthl7'];
				// }
				
				//Busco el estado del examen
				//Solo cambia si es estado cancelado
				$sql = "SELECT *
						  FROM ".$wbasedato."_000045 a
						 WHERE Eexcod = '".$rowOrden['Detesi']."'
						   AND Eexcan = 'on'
						   AND Eexest = 'on'
						";
				
				$resEst	= mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
				if( $rowEst = mysql_fetch_array( $resEst ) ){
					$estOrden = 'X';
				}
				
				
				$sql = "SELECT *
						  FROM ".$wbasedato."_000258
						 WHERE Saotor = '".$rows['Ordtor']."'
						   AND Saonro = '".$rows['Ordnro']."'
						   AND Saoite = '".$rowOrden['Detite']."'
						   AND Saoest = 'on'
						";
				
				$resMuestras	= mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
				$numMuestras	= mysql_num_rows( $resMuestras );
				
				$fechaOrden = str_replace( "-", "", $rowOrden['Detfec'] );
				
				$usuarioTomaMuestra = '';
				if( !empty($rowOrden['Detutm']) ){
					
					//Buscar en la tabla de usuario que cco le pertenece al usuario.
					$q_user = "SELECT Codigo, Descripcion
								 FROM usuarios
								WHERE Codigo = '".$rowOrden['Detutm']."'";
					$res_user = mysql_query($q_user, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q_user . " - " . mysql_error());
					if( $rowsUtm = mysql_fetch_array( $res_user ) ){
						$usuarioTomaMuestra = $rowsUtm['Codigo']."^".( $rowsUtm['Descripcion'] );
						$estOrden = '';
					}
				}
				
				$_msg = '';
				if( $numMuestras > 0 ){
					while( $rMuestras = mysql_fetch_array($resMuestras) ){
						$_msg .= "\nOBR|||".$rowOrden['Dettor']."-".$rowOrden['Detnro']."-".$rowOrden['Detite']."|".$rowOrden['Codcups']."^".$rowOrden['Nombre']."||".date("YmdHis")."||||".$usuarioTomaMuestra."|||".$justificacion."||".$rMuestras['Saocor']."-".$rMuestras['Saodor']."^^^".$rMuestras['Saocsa']."-".$rMuestras['Saodsa']."^^".$rMuestras['Saocns']."||||||||||".$estOrden."|||||||||||".$fechaOrden."|";
					}
				}
				else{
					$_msg .= "\nOBR|||".$rowOrden['Dettor']."-".$rowOrden['Detnro']."-".$rowOrden['Detite']."|".$rowOrden['Codcups']."^".$rowOrden['Nombre']."||".date("YmdHis")."||||".$usuarioTomaMuestra."|||".$justificacion."||^^^^^||||||||||".$estOrden."|||||||||||".$fechaOrden."|";
				}
				
				$tip_orden 	= $rowOrden['Dettor'];
				$nro_orden 	= $rowOrden['Detnro'];
				
				if( empty( $usuarioTomaMuestra ) ){
					
					$mensajes[ $estadoPorOrden ] .= $_msg;
				
					$ids[ $estadoPorOrden ][] = [
								'tor' => $rowOrden['Dettor'],
								'nor' => $rowOrden['Detnro'],
								'ite' => $rowOrden['Detite'],
							];
				}
				else{
					$mensaje_tm .= $_msg;
					
					$idstm[] = [
								'tor' => $rowOrden['Dettor'],
								'nor' => $rowOrden['Detnro'],
								'ite' => $rowOrden['Detite'],
							];
				}
			}
			
			if( $conEstudios )
			{
				$encHl7tm =  "MSH|^~\\&|MATRIX|PMLA|LIS4D|LMLA|".date("YmdHis")."||OML^O21|".$rows['Ordnro']."|P|2.5|"
							."\nPID||".trim( $pac['nroDocumento'] )."^".trim( $pac['tipoDocumento'] )."|".$historia."||".$pac['apellido1']."&".$pac['apellido2']."^".$pac['nombresCompletos']."||".str_replace( "-", "", $pac['fechaNacimiento'] )."|".$pac['genero']."|||".$pac['direccion']."^^".$pac['municipio']."^".$pac['departamento']."^^".$pac['pais']."||".$pac['celular']."^^^".$pac['correoElectronico']."^^^".$pac['telefono']."|"
							."\nPV1||I|^^".$pac['habitacion']."^CLA^^^^".$paciente->servicioRealActual."-".$paciente->nombreRealServicioActual."||||||||||||||||".$ingreso."|"
							."\nIN1|||".$pac['codigoResponsable']."|".$pac['nombreResponsable']."|||||||||||".$pac['tarifa']."|"
							."\nORC|XO|".$rows['Ordotr']."|".$rows['Ordtor']."-".$rows['Ordnro']."^".$ordenAnexa."||IP||^^^".date("YmdHis")."^^R|||".$medico->apellido1."^".$medico->apellido2."^".trim( $medico->nombre1." ".$medico->nombre2 )."^^^^MD^".$medico->numeroDocumento."|";
		
				foreach( $mensajes as $estadoGeneralPorOrden => $mensaje )
				{
					$encHl7 =   "MSH|^~\\&|MATRIX|PMLA|LIS4D|LMLA|".date("YmdHis")."||OML^O21|".$rows['Ordnro']."|P|2.5|"
								."\nPID||".trim( $pac['nroDocumento'] )."^".trim( $pac['tipoDocumento'] )."|".$historia."||".$pac['apellido1']."&".$pac['apellido2']."^".$pac['nombresCompletos']."||".str_replace( "-", "", $pac['fechaNacimiento'] )."|".$pac['genero']."|||".$pac['direccion']."^^".$pac['municipio']."^".$pac['departamento']."^^".$pac['pais']."||".$pac['celular']."^^^".$pac['correoElectronico']."^^^".$pac['telefono']."|"
								."\nPV1||I|^^".$pac['habitacion']."^CLA^^^^".$paciente->servicioRealActual."-".$paciente->nombreRealServicioActual."||||||||||||||||".$ingreso."|"
								."\nIN1|||".$pac['codigoResponsable']."|".$pac['nombreResponsable']."|||||||||||".$pac['tarifa']."|"
								."\nORC|".$estadoGeneralPorOrden."|".$rows['Ordotr']."|".$rows['Ordtor']."-".$rows['Ordnro']."^".$ordenAnexa."||IP||^^^".date("YmdHis")."^^R|||".$medico->apellido1."^".$medico->apellido2."^".trim( $medico->nombre1." ".$medico->nombre2 )."^^^^MD^".$medico->numeroDocumento."|";
					
					if( !empty($mensaje ) )
					{				
						$mensaje =   $encHl7.$mensaje;
						
						/******************************************************************
						 * Creando archivo
						 ******************************************************************/
						$archivo = fopen( $nombreArchivo = date("YmdHis")."-$historia-$ingreso-".$rows['Ordnro']."-".$estadoGeneralPorOrden.".txt", "w+b ");
							
						if( $archivo == false ){
							echo "Error al crear el archivo";
							$ids[$estadoGeneralPorOrden] = [];
						}
						else
						{
							// Escribir en el archivo:
							fwrite($archivo,$mensaje );
							 
							// Fuerza a que se escriban los datos pendientes en el buffer:
							fflush($archivo);

							// Cerrar el archivo:
							fclose($archivo);
							
							$subirArchivo = subirArchivosFtp( $nombreArchivo, $nombreArchivo, $wemp_pmla );
							
							if( $subirArchivo ){
								registrarMsgLogHl7( $conex, $wbasedato, $historia, $ingreso, $pac['tipoDocumento'], $pac['nroDocumento'], 'MATRIX-LMLA', $rows['Ordtor'], $rows['Ordnro'], 0, $mensaje );
							}
							else{
								$ids[$estadoGeneralPorOrden] = [];
							}
							
							unlink( $nombreArchivo );
						}
					}
				}	
			}
			
			if( count( $ids ) > 0 )
			{	
				foreach( $ids as $keyRegistros => $registros )
				{
					foreach( $registros as $key => $reg )
					{
					
						$sql = "UPDATE ".$whce."_000028 a
								   SET Detenv = 'off', 
									   Deteex = 'E'
								 WHERE Dettor = '".$reg['tor']."'
								   AND Detnro = '".$reg['nor']."'
								   AND Detite = '".$reg['ite']."'
							";
					
						$resEnv	= mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
							
						$sql = "UPDATE ".$wbasedato."_000159 a
								   SET Detenv = 'off', 
									   Deteex = 'E'
								 WHERE Dettor = '".$reg['tor']."'
								   AND Detnro = '".$reg['nor']."'
								   AND Detite = '".$reg['ite']."'
							";
					
						$resEnv	= mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
					}
				}
			}
			
			
			/******************************************************************/
		}
	}

	if( !empty( $mensaje_tm ) ){
					
		$mensaje_tm =   $encHl7tm.$mensaje_tm;
		
		$ch = curl_init();
		
		$data = array( 
				// 'msg'		=> curl_escape( $ch, $mensaje_tm ), 
				'msg'		=> utf8_encode( $mensaje_tm ), 
			);

		// set URL and other appropriate options
		$options = array(
					CURLOPT_URL 			=> $ipLabTomaMuestra,
					CURLOPT_HEADER 			=> false,
					CURLOPT_POSTFIELDS 		=> json_encode( $data ),
					CURLOPT_POST			=> true,
					CURLOPT_RETURNTRANSFER 	=> true,
					CURLOPT_HTTPHEADER 		=> [ 
													'Content-Type: application/json',
													$autorizacion,
												],
				);

		$opts = curl_setopt_array($ch, $options);
		
		// if( $opts === false )
			// echo "Opciones mal configuradas...";

		// grab URL and pass it to the browser
		$exec = curl_exec($ch);
		
		if( $exec === false ){
			echo "No hizo nada....";
		}
		else{
			registrarMsgLogHl7( $conex, $wbasedato, $historia, $ingreso, $pac['tipoDocumento'], $pac['nroDocumento'], 'MATRIX-LMLA', $tip_orden, $nro_orden, 0, $mensaje_tm );
			
			if( count( $idstm ) > 0 ){
					
				foreach( $idstm as $key => $reg ){
					
					$sql = "UPDATE ".$whce."_000028 a
							   SET Detenv = 'off'
							 WHERE Dettor = '".$reg['tor']."'
							   AND Detnro = '".$reg['nor']."'
							   AND Detite = '".$reg['ite']."'
						";
				
					$resEnv	= mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
						
					$sql = "UPDATE ".$wbasedato."_000159 a
							   SET Detenv = 'off'
							 WHERE Dettor = '".$reg['tor']."'
							   AND Detnro = '".$reg['nor']."'
							   AND Detite = '".$reg['ite']."'
						";
				
					$resEnv	= mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
				}
			}
		}
		
		curl_close($ch);
	}
}

function crearMensajeORMInbound( $conex, $wbasedatoMH, $wbasedatoHCE, $historia, $ingreso, $cco, $codExamen, $nombreExamen, $nroOrden, $item, $datosMsjInbound ){
	
	$infoPaciente = consultarInfoPacienteOrdenHCEPorHistoria( $conex, $wbasedatoMH, $historia );
	
//	$infoPaciente = new pacienteKardexDTO();

	$fechaActualCorta = date( "ymd" );
	$fechaActual = date( "Ymd" );
	$horaActual = date( "His" );
	
//	$datosMsjInbound['codMedicoDefecto'] = $rows000015['Tipmed'];
//	$datosMsjInbound['nomMedicoDefecto'] = $rows000015['Tipnme'];
	
	$codMedico = $datosMsjInbound['codMedicoDefecto'];
	$nomMedico = $datosMsjInbound['nomMedicoDefecto'];
	$consecutivo = $nroOrden.$datosMsjInbound['caracterSeparacion'].$item;
	$nombres = $infoPaciente->nombre1." ".$infoPaciente->nombre2;
	$apellidos = $infoPaciente->apellido1." ".$infoPaciente->apellido2;
	$documento = $infoPaciente->tipoDocumentoIdentidad.$infoPaciente->documentoIdentidad;
	$fechaNacimiento = str_replace( "-", "",$infoPaciente->fechaNacimiento );
	$sexo = $infoPaciente->sexo;
	$direccion = "SIN DEFINIR";
	
	$nombreSolicitante = $datosMsjInbound['solicitante']['nombres']." ".$datosMsjInbound['solicitante']['apellidos'];
	$documentoSolicitante = $datosMsjInbound['solicitante']['nroDocumento'];
	
	$opcional = "";
	
	$mensaje = "MSH|^~\\&|QDOC|AGFA|XXXX|XXXX|$fechaActual$horaActual||ORM^O01^ORM_O01|$consecutivo|P|2.4||||||8859/1".chr(13).chr(10)
			  ."PID|1|$documento|$documento|$consecutivo|$apellidos^$nombres|$apellidos^$nombres^^^^^B|$fechaNacimiento|$sexo|$apellidos^$nombres^^^^^B||$direccion^^MEDELLIN^^05001^CO||3019141".chr(13).chr(10)
			  ."PV1||O||||||||||||||||A".chr(13).chr(10)
			  ."ORC|SC|5010^{$datosMsjInbound['abreviaturaEmpresa']}|{$fechaActualCorta}0002^01|5010|IP||^^^$fechaActual$horaActual^^R|||quadrat||{$datosMsjInbound['codMedicoDefecto']}^{$datosMsjInbound['nomMedicoDefecto']}^^^^DR||||||||||||NA |A^PATIENT TOEGEKOMEN^QDOC".chr(13).chr(10)
			  ."OBR||5010^{$datosMsjInbound['abreviaturaEmpresa']}|{$fechaActualCorta}0002^01|$codExamen^$nombreExamen^{$datosMsjInbound['abreviaturaEmpresa']}||$fechaActual$horaActual|$fechaActual$horaActual||||||$opcional|||{$datosMsjInbound['codMedicoDefecto']}^{$datosMsjInbound['nomMedicoDefecto']}^^^^DR||132978|125153|||$fechaActual$horaActual|||S||^^^$fechaActual$horaActual^^R|||||$documentoSolicitante&$nombreSolicitante||^^^^RMN||$fechaActual$horaActual"
			  .chr(13).chr(10);
	
	return $mensaje;
}

/************************************************************************************************************************
 * Dados una fecha actual, frecuencia y una fecha y hora de inicio del medicamento, retorna la hora en que
 * comienza un medicamento en la fecha actual
 * 
 * @param $fechaActual
 * @param $fechaIncio
 * @param $horaInicio
 * @param $frecuencia
 * @return unknown_type
 * 
 * Nota: La frecuencia esta dada en horas
 * 
 * Febrero 29 de 2011
 ************************************************************************************************************************/
function horaInicioMedicamento( $fechaActual, $fechaIncio, $horaInicio, $frecuencia ){
	
	$horaIncioActual = false;
	
	//Fecha actual debe ser menor o igual que la fecha de inicio
	if( $fechaIncio <= $fechaActual ){
		
		//convierto las fechas
		$fechorActual = strtotime( "$fechaActual 00:00:00" );
		$fechorInicio = strtotime( "$fechaIncio $horaInicio" );
		
		$horaIncioActual = $horaInicio;
		
		//Sumo la frecuencia hasta el día en que comience el medicamento
		for( $i = 0 ; date( "Y-m-d", $fechorInicio ) < date( "Y-m-d", $fechorActual ); $i++ ){

			$fechorInicio += $frecuencia*3600;
			$horaIncioActual = date( "H:i:s", $fechorInicio );
		}
	}
	
	return $horaIncioActual;
}

/************************************************************
 * Indica si un centro de costos es de ingreso
 * 
 * @param $conexion
 * @param $wbasedato
 * @param $cco
 * @return unknown_type
 ************************************************************/
function esCcoIngreso( $conexion, $wbasedato, $cco ){

	$sql = "SELECT
				Ccourg, Ccoing, Ccocir
			FROM
				{$wbasedato}_000011
			WHERE
				ccocod = '$cco'
				AND ccoest = 'on'
				AND ccoing = 'on'
			";
				
	$res = mysql_query( $sql, $conexion ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$num = mysql_num_rows( $res );
	
	if( $num > 0 ){
		
		return true;
	}
	
	return false;
}


/************************************************************************************************************************
 * Actualiza la firma de los campos de dextrometer si el usuario fue quien creo o modifico el esquema de dextrometer
 * 
 * @param $conex
 * @param $wbasedato
 * @param $historia
 * @param $ingreso
 * @param $fecha
 * @param $codigoUsuario
 * @param $firma
 * @return unknown_type
 ************************************************************************************************************************/
function actualizarUsuarioDextrometer( $conex,$wbasedato,$historia,$ingreso,$fecha,$codigoUsuario,$firma ){
	
	$sql = "UPDATE
				{$wbasedato}_000071
			SET
				Indfir = '$firma'
			WHERE
				Indhis = '$historia'
				AND Inding = '$ingreso'
				AND Indfec = '$fecha'
				AND Indusu = '$codigoUsuario'
			";
	
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	
	if( mysql_affected_rows() > 0 ){
		return true;
	}
	else{
		return false;
	}
}

/******************************************************************************************
 * Desactiva un registro en la tabla correpondiente HL7 de movhos
 * 
 * @param $conex
 * @param $wbasedato
 * @param $tabla
 * @param $id
 * @return unknown_type
 ******************************************************************************************/
function cancelarDatosHL7( $conex, $wbasedato, $tabla, $id = '' ){
	
	if( $tabla != '' ){
		
		$sql = "UPDATE
					{$wbasedato}_{$tabla}
				SET
					hl7est = 'off'
				WHERE
					id = '$id'
				";
		
		$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
		
		if( mysql_affected_rows() > 0 ){
			return true;
		}
		else{
			return false;
		}
	}
}

/**************************************************************************************************
 * Actualiza los datos de la tabla HL7
 * @param $conex
 * @param $wbasedato
 * @param $tabla
 * @param $estado
 * @param $id
 * @return unknown_type
 **************************************************************************************************/
function actualizarDatosHL7( $conex, $wbasedato, $tabla, $estado, $id = '' ){
	
	if( $tabla != "" ){
		
		$sql = "UPDATE {$wbasedato}_{$tabla}
				   SET hl7edo = '$estado', hl7est = 'on'
				 WHERE id = '$id'";		
		$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
		$filas_actualizadas = mysql_affected_rows();
		
		if( $filas_actualizadas > 0 ){
			return true;
		}
		else{
			return false;
		}
	}
}

/********************************************************************************************************************************
 * Registra los datos correspondientes a la tabla HL7
 * 
 * @return unknown_type
 ********************************************************************************************************************************/
function registrarDatosHL7( $conex, $wbasedato, $tabla, $ori, $des, $nor, $nit, $historia, $ingreso, $inbound, $oru, $edo ){
	
	if( $tabla != "" ){
		$fecha = date( "Y-m-d" );
		$hora = date( "H:i:s" );
		
		$sql = "INSERT INTO {$wbasedato}_{$tabla}(     Medico    , Fecha_data, Hora_data, hl7ori, hl7des, hl7nor, hl7nit     ,    hl7his  , hl7ing   ,   hl7inb  , hl7rdo , hl7edo, hl7est, hl7env,   Seguridad    )
					  					   VALUES( '{$wbasedato}',  '$fecha' , '$hora'  , '$ori', '$des', '$nor', '$nor-$nit', '$historia', '$ingreso', '$inbound', '$oru', '$edo',  'on' , 'off' ,'C-{$wbasedato}')
				";
		
		$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
		
		if( mysql_affected_rows() > 0 ){
			return true;
		}
		else{
			return false;
		}
	}
}

/**************************************************************************************************************
 * Busco si el examen tiene tabla hcl7, si la tiene registro o actualizo los datos correspondientes segun el 
 * caso
 * 
 * @param $conex
 * @param $wbasedato
 * @param $tabla
 * @param $historia
 * @param $ingreso
 * @param $examen
 * @param $consecutivo
 * @param $estadoExamen
 * @return unknown_type
 **************************************************************************************************************/
function datosHL7( $conex, $bdMH, $wbasedato, $historia, $ingreso, $examen, $nroOrden, $destino, $nroItem, $estadoExamen, $solicitante ){
	
	//Busco si tiene tabla HCL7
	$sql = "SELECT
				Arc_HL7, Tipcse, Tipabr, Tipmed, Tipnme, Tipcun, Tipnun, b.Descripcion, Servicio
			FROM
				{$wbasedato}_000015 a, {$wbasedato}_000017 b
			WHERE
				b.codigo = '$examen'
				AND tipoestudio = a.codigo
				AND Arc_HL7 != ''
				AND Arc_HL7 != 'NO APLICA'
			";
				
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$numrows = mysql_num_rows( $res );
	
	if( $numrows > 0 ){
		
		$rows000015 = mysql_fetch_array( $res );
		
		//Datos para crear el mensaje
		$datosMsjInbound = Array();
		
		$datosMsjInbound['caracterSeparacion'] = $rows000015['Tipcse'];
		$datosMsjInbound['abreviaturaEmpresa'] = $rows000015['Tipabr'];
		$datosMsjInbound['codMedicoDefecto'] = $rows000015['Tipmed'];
		$datosMsjInbound['nomMedicoDefecto'] = $rows000015['Tipnme'];
		$datosMsjInbound['codigoUnidadProveedor'] = $rows000015['Tipcun'];
		$datosMsjInbound['nombreUnidadProveedor'] = $rows000015['Tipnun'];
		
		//Consulto la informacion del medico Solicitante
		$datosMsjInbound['solicitante'] = consultaInformacionMedico( $conex, $bdMH, $solicitante );
		
		$servicio = $rows000015['Servicio'];
		$nombreExamen = $rows000015['Descripcion'];;
		
		$tabla = $rows000015['Arc_HL7'];
			
		//Busco si el mensaje HL7 existe para dicho examen
		$sql = "SELECT
					*
				FROM
					{$wbasedato}_{$tabla} 
				WHERE
					hl7his = '$historia'
					AND hl7ing = '$ingreso'
					AND hl7des = '$destino'
					AND hl7nor = '$nroOrden'
					AND hl7nit = '$nroOrden-$nroItem'
				";
		
		$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
		$numHL7 = mysql_num_rows( $res );
		
		if( $numHL7 <= 0 ){
			
			$nor = $nit = $inbound = $edo = "";
			$inbound = crearMensajeORMInbound( $conex, $bdMH, $wbasedato, $historia, $ingreso, $servicio, $examen, $nombreExamen, $nroOrden, $nroItem, $datosMsjInbound );
			$oru= '';
			
			//Consulto el cco en quq  se encuentra el paciente
			$sql = "SELECT
						Ubisac
					FROM
						{$bdMH}_000018
					WHERE
						Ubihis = '$historia'
						AND Ubiing = '$ingreso'
					";
			
			$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
			
			if( $rows = mysql_fetch_array( $res ) ){
				$origen = $rows['Ubisac'];
				
				registrarDatosHL7( $conex, $wbasedato, $tabla, $origen, $destino, $nroOrden, $nroItem, $historia, $ingreso, $inbound, $oru, $estadoExamen );
			}
		}
		else{
			
			$rowsHL7 = mysql_fetch_array( $res );
			
			actualizarDatosHL7( $conex, $wbasedato, $tabla, $estadoExamen, $rowsHL7['id'] );
		}
	}
	else{
		return false;
	}
}

/******************************************************************************************************************************
 * Devuelve todos los tipos diangositocs en un string, con forma codigo1-descripción,codigo2-descripción2
 * 
 * @param $conexion
 * @param $wbasedato
 * @return unknown_type
 * 
 * Enero 24 de 2011
 ******************************************************************************************************************************/
function tiposAyudasDiagnosticas( $conexion, $wbasedatohce, $ccoPaciente ){
	
	global $wbasedato;
	
	$val = "";
	
	$sql = "SELECT
				Codigo, Descripcion, Tipagr
			FROM
				{$wbasedatohce}_000015
			WHERE
				estado = 'on'
			Order by
				2 asc
			";
	
	$res = mysql_query( $sql, $conexion ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	
	$num = mysql_num_rows( $res );
	
	if( $num > 0 ){
		
		for( $i = 0; $rows = mysql_fetch_array( $res ); $i++ ){
			
			$mostrar = true;
			if($rows[ 'Tipagr' ]=="on")
			{
				$mostrar = false;
				
				$query = "SELECT Tpacco 
							FROM ".$wbasedato."_000187 
						   WHERE Tpacod = '".$rows[ 'Codigo' ]."' 
							 AND Tpaest = 'on';";
							 
				$respuesta = mysql_query( $query, $conexion ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	
				$numCco = mysql_num_rows( $respuesta );
				
				if( $numCco > 0 ){
					$rowsCco = mysql_fetch_array( $respuesta );
					
					$ccostos = explode(",",$rowsCco['Tpacco']);
					
					for($j=0;$j<count($ccostos);$j++)
					{
						if( $ccostos[$j] == $ccoPaciente || $ccostos[$j] == "*")
						{
							$mostrar = true;
							break;
						}
					}
					
					
					
				}
			}	
			
			if( $mostrar ){
				if( $i == 0 ){
					$val = $rows[ 'Codigo' ]."-".$rows[ 'Descripcion' ];
				}
				else{
					$val .= "|".$rows[ 'Codigo' ]."-".$rows[ 'Descripcion' ];
				}
			}
			

		
		}
	}
	
	return $val;
}
 
 // function tiposAyudasDiagnosticas( $conexion, $wbasedato ){
	
	// $val = "";
	
	// $sql = "SELECT
				// Codigo, Descripcion
			// FROM
				// {$wbasedato}_000015
			// WHERE
				// estado = 'on'
			// Order by
				// 2 asc
			// ";
	
	// $res = mysql_query( $sql, $conexion ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	
	// $num = mysql_num_rows( $res );
	
	// if( $num > 0 ){
		
		// for( $i = 0; $rows = mysql_fetch_array( $res ); $i++ ){
			
			// if( $i == 0 ){
				// $val = $rows[ 'Codigo' ]."-".$rows[ 'Descripcion' ];
			// }
			// else{
				// $val .= "|".$rows[ 'Codigo' ]."-".$rows[ 'Descripcion' ];
			// }		
		// }
	// }
	
	// return $val;
// }

/********************************************************************************************************
 * Devuelve la hora de traslado de un paciente desde urgencia o cirugia.
 * 
 * Nota: La primera del día
 * 
 * @param $conexion
 * @param $wbasedato
 * @param $historia
 * @param $ingreso
 * @param $fecha
 * @param $urgencia
 * @return unknown_type
 * 
 * Enero 14 de 2011
 ********************************************************************************************************/
function consultarHoraTrasladoUrgencias( $conexion, $wbasedato, $historia, $ingreso, $fecha ){
	
	$qMv = "SELECT
				a.Hora_data
			FROM
				".$wbasedato."_000017 a, ".$wbasedato."_000011 b 
			WHERE
				Eyrhis = '$historia'
				AND Eyring = '$ingreso'
				AND Eyrtip = 'Recibo'
				AND a.Fecha_data = '".$fecha."'
				AND Ccocod = Eyrsor
				AND ( Ccourg = 'on' OR Ccocir = 'on' OR Ccoing = 'on' )
				AND Eyrest='on'
			ORDER BY
				Hora_data asc
			";  //echo ".........".$qMv;
	
	$res = mysql_query( $qMv, $conexion ) or die( mysql_errno()." - Error en el query $qMv - ".mysql_error() );
	$numrows = mysql_num_rows( $res );
	
	if($numrows > 0 ){
		$rows = mysql_fetch_array( $res );
		
		return $rows['Hora_data'];
	}
	else{
		return false;
	}
}


/******************************************************************************************
 * Inidca si un articulo es un génerico o no
 * 
 * @param $conexion			Conexión a la BD
 * @param $wbasedatoMH		Base de datos de movimiento hospitalario
 * @param $wbasedatoCM		Base de datos de Central de Mezclas
 * @param $codArticulo		Codigo del articulo
 * @return unknown_type		Booleano
 * 
 * Enero 05 de 2011
 ******************************************************************************************/
function esArticuloGenerico( $conexion, $wbasedatoMH, $wbasedatoCM, $codArticulo ){
	
	$sql = "SELECT
				*
			FROM
				{$wbasedatoMH}_000068,
				{$wbasedatoCM}_000002,
				{$wbasedatoCM}_000001
			WHERE
				arkcod = '$codArticulo'
				AND artcod = arkcod
				AND arttip = tipcod
				AND tiptpr = arktip
				AND artest = 'on'
				AND arkest = 'on'
				AND tipest = 'on' 
			";
	
	$res = mysql_query( $sql, $conexion ) or die( mysql_errno(). " - Error en el query - ".mysql_errno()  );
	$numrows = mysql_num_rows( $res );
	
	if( $numrows > 0 ){
		return true;
	}
	else{
		return false;
	}
}


/************************************************************************************************************
 * Diciembre 17 de 2010
 * Determina si un articulo es creado por primera vez en el kardex, basandose en el kardex del día anterior
 * 
 * @param $conexion
 * @param $wbasedato
 * @param $codArticulo
 * @param $idRegDiaAnterior		id del registro anterior
 * @param $fechaKardex			Fecha del kardex
 * @param $fechaInicio			Fecha de Incio del medicamento
 * @param $horaInicio			Hora de inicio del medicamento
 * @param $fechaUsar			La fecha que se debe usar para el calculo de cantidad a dispensar
 * @return unknown_type
 * 
 * Modificacion:  Enero 14 de 2011
 * - Se agrega campo FechaUsar en la función
 * - Se agrega condición: si el paciente fue trasladado de urgencias o cirugía antes de que el kardex sea
 * 	 sea creado, los medicamentos se toman como primera vez.  Además si esto ocurre, al día siguiente se tomo
 * 	 como segunda vez, esto último debido a que habría conflicto al día siguiente con la regla de que si viene
 *   del día anterior y no fue dispensado, se calcula el medicamento como si fuera primera vez
 * - Se agrega condición: Si el medicamento comienza al día siguiente antes de la hora de dispensación,
 *   calcular como si fuera primera vez. 
 * 
 ************************************************************************************************************/
function esPrimeraVez( $conexion, $wbasedato, $historia, $ingreso, $codArticulo, $idRegDiaAnterior, $fechaKardex, $fechaInicio, $horaInicio, $frecuencia, &$fechaUsar, &$horaUsar, &$dejarSaldoArticulo ){
	
	global $horaCorteDispensacion;
	
	$encabezado = false;
	$horaTrasladoUrgencias = false;
	$esTrasladadoUrgenciaCirugia = false;
	$existeEncabezado = false;
	$antesCrearKardex = false;	//Indica si un kardex fue creado despues de la hora de traslado del paciente
	$esModificado = false;	//Indica si el articulo fue modificado
	
	$fechaUsar = $fechaInicio;
	$horaUsar = $horaInicio;
	
	if( $idRegDiaAnterior != '' ){
		
		$sql = "SELECT
					*
				FROM
					{$wbasedato}_000043 b, {$wbasedato}_000054 a
				WHERE
					a.id = '$idRegDiaAnterior'
					AND percod = kadper
				";
	
		$res = mysql_query( $sql, $conexion ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
		$numrows = mysql_num_rows( $res );

		if( $numrows > 0 ){
			
			$fila = mysql_fetch_array($res);
			
			//Un articulo no puede ser creado dias posteriores a la fecha del kardex
			//Si ocurre significa que el se comenzo a crear el kardex el día anterior pero se terminó de crear al día siguiente (Despues de las 23:59:59)
			//Por tal motivo se deja con la fecha y hora máxima para los calculos de la creacion del kardex
			if( $fila['Fecha_data'] > $fila['Kadfec'] ){
				
				$fila['Fecha_data'] = $fila['Kadfec'];
				$fila['Hora_data'] = "23:59:59";
			}
			
			//No es primera vez
			//Diciembre 9 de 2010
			//Diciembre 6 de 2010
			//Si fue trasladado de urgencia a piso, se trata el articulo como si fuera primera vez y si no fue dispensado el dia anterior
			if(isset($fila) && isset($fila['Kadart']) && $fila['Kadart'] != '' ){
				
				/**********************************************************************
				 * Enero 14 de 2011
				 **********************************************************************/
				//Verifico si hubo traslado desde urgencias el dia actual
				$esTrasladadoUrgenciaCirugia = esTrasladoDeUregnciasDiaAnterior( $conexion, $wbasedato, $fila['Kadhis'], $fila['Kading'], date( "Y-m-d", strtotime( $fechaKardex )+24*3600 ) );
				
				$esTrasladadoUrgenciaCirugiaHoy = $esTrasladadoUrgenciaCirugia;	//Marzo 31 de 2011
				$horaTrasladoHoy = false;										//Marzo 31 de 2011
				
				//si hubo recibo de pacientes en el piso, miro la hora de creación del kardex
				//si la hora de recibo de kardex es menor a la hora traslado significa que los medicamentos son tratados como primera vez 
				if( $esTrasladadoUrgenciaCirugia ){
					
					$horaTraslado = consultarHoraTrasladoUrgencias( $conexion, $wbasedato, $fila['Kadhis'], $fila['Kading'], $fechaKardex );
					$existeEncabezado = existeEncabezadoKardexSinCco( $wbasedato, $conexion, $fila['Kadhis'], $fila['Kading'], $fechaKardex, $encabezado );
					
					$horaTrasladoHoy = $horaTraslado;							//Marzo 31 de 2011

					if( $horaTraslado < $encabezado['Hora_data'] ){
						$antesCrearKardex = true;
					}
				}
				/***********************************************************************/

				if( !$esTrasladadoUrgenciaCirugia ){	//Enero 14 de 2010.  Si fue trasladado a piso desde urgencia y no se le ha hecho kardex ni el articulo ha sido dispensado el día anterior se calcula como primera vez
					
					/**********************************************************************
				 	 * Enero 14 de 2011
				 	 **********************************************************************/
					//verifico que el dia anterior no haya sido cosiderado como primera vez por el caso de
					//que si el paciente fue recibido desde urgencias a piso y no se había hecho el kardex al paciente
					$antesCrearKardex = false;
					
					$esTrasladadoUrgenciaCirugia = esTrasladoDeUregnciasDiaAnterior( $conexion, $wbasedato, $fila['Kadhis'], $fila['Kading'], $fechaKardex );
					
					if( $esTrasladadoUrgenciaCirugia ){
							
						$horaTraslado = consultarHoraTrasladoUrgencias( $conexion, $wbasedato, $fila['Kadhis'], $fila['Kading'], date( "Y-m-d", strtotime( $fechaKardex )-24*3600 ) );
						$existeEncabezado = existeEncabezadoKardexSinCco( $wbasedato, $conexion, $fila['Kadhis'], $fila['Kading'], date( "Y-m-d", strtotime( $fechaKardex )-24*3600 ), $encabezado );

						$ayer = date( "Y-m-d", strtotime( $fechaKardex )-24*3600 );
						
						if( $horaTraslado < $encabezado['Hora_data'] || $ayer < $fila['Fecha_data'] || ( $ayer == $fila['Fecha_data'] && $horaTraslado < $fila['Hora_data'] ) ){
							$antesCrearKardex = true;
						}
					}
					/**********************************************************************/

					if( ($fila['Kaddis'] > 0 && $fila['Kadhdi'] != "00:00:00")
						 || !esTrasladoDeUregnciasDiaAnterior( $conexion, $wbasedato, $fila['Kadhis'], $fila['Kading'], $fechaKardex )
						 || $antesCrearKardex
						 || true
					  ){	//Evaluo si viene de Urgencias o Cirugía del día anterior
						
					   	if( !( trim( $fechaInicio ) == date( "Y-m-d", strtotime( date("Y-m-d") )+24*3600 ) && trim( $horaInicio ) <= $horaCorteDispensacion ) ){
					   		
					   		/************************************************************************************************************************************
					   		 * Enero 24 de 2011
					   		 ************************************************************************************************************************************/
					   		//Si el articulo tiene la misma fecha, hora de inicio y frecuencia que el registro anterior, se considera que no fue modificado
					   		// echo "...kadfin: ".$fila['Kadfin'], "...fecini: ".trim( $fechaInicio ), "...kadhin: ".$fila['Kadhin'], "...horini: ".trim( $horaInicio ), "...equ: ".$fila['Perequ'], "....fre: ".$frecuencia;
					   		
					   		if( $fila['Kadfin'] == trim( $fechaInicio ) && $fila['Kadhin'] == trim( $horaInicio ) && $fila['Perequ'] == $frecuencia ){
					   			$esModificado = false;
					   		}
					   		else{
					   			$esModificado = true;
					   		}
					   		/************************************************************************************************************************************/
					   		
					   		if( !$esModificado ){	//Enero 24 de 2011 verifico si el articulo no fue modificado
					   		
								//===========================================================================================================================
								//Diciembre 16 de 2010
								//===========================================================================================================================
								if( ( ( trim( $fila['Kadfin'] ) == date("Y-m-d") ) && ( trim( $fila['Kadhin'] ) > $horaCorteDispensacion ) )
									|| ( ( trim( $fila['Kadfin'] ) == date( "Y-m-d", strtotime( date("Y-m-d") )+24*3600 ) ) && ( trim( $fila['Kadhin'] ) <= $horaCorteDispensacion ) )
								){
									return true;
								}
								else{
									$horaUsar = $horaCorteDispensacion.":00:00";
									// echo "<br>..........Holaassssssaaassss....";
									// $horaUsar = "08:00:00";
									// $fechaUsar = "2012-02-24";
									// return true;
									return false;
								}
								//===========================================================================================================================
					   		}
					   		else{
								
					   			/****************************************************************************************************************
					   			 * Marzo 31 de 2011
					   			 * 
					   			 * Si un paciente es traslado desde urgencia a piso y se modifica el medicamento y no fue dispensado el día anterior
					   			 * el calculo de la cantidad a dispensar se hace como si fuera primera vez
					   			 ****************************************************************************************************************/
								if( $esTrasladadoUrgenciaCirugiaHoy && $horaTrasladoHoy && $horaTrasladoHoy < date("H:i:s")
									&& ($fila['Kaddis'] == 0 && $fila['Kadhdi'] == "00:00:00") 
								){
									$dejarSaldoArticulo = false;
									return true;
								}
								/****************************************************************************************************************/
					   			
					   			/************************************************************************************************************************************
					   		 	* Enero 24 de 2011
					   		 	************************************************************************************************************************************/
					   			if( $fechaInicio <= $fechaKardex && $horaInicio <= $horaCorteDispensacion ){
									
									return true;
					   			}
					   			elseif( $fechaInicio < $fechaKardex && $horaInicio > $horaCorteDispensacion ){
									
					   				$fechaUsar = $fechaKardex;	//Enero 25 de 2011
					   				return true;
					   			}
					   			else{
					   				return true;
					   			}
					   			/************************************************************************************************************************************/
					   		}//Enero 24 de 2011
					   	}
					   	else{
					   		return true;
					   	}
					}
					else{
						
						$dejarSaldoArticulo = false;
						
						if( $fechaInicio < $fechaKardex ){	//Enero 17 de 2011
							
							$horaUsar = horaInicioMedicamento( $fechaKardex, $fechaInicio, $horaInicio, $frecuencia );	//Marzo 1 de 2011
							$fechaUsar = $fechaKardex;
						}
						return true;
					}
				}
				else{	//Si es traslado de urgencia cirugia el dia actual
					
					$dejarSaldoArticulo = false;
					
					//Caculo a partir de que horas debe calcular el kardex
					//Esta es siempre a partir de la siguiente ronda de trasaldo
					list( $hrTraslado ) = explode( ":", $horaTraslado );
					
					//Esto calclo la hora para posterior
					$hrTraslado = intval( $hrTraslado/2 )*2;
					
					//Consulto fecha de inicio despues de la hora de traslado
					$fhInicioTraslado = suministroAntesFechaCorte( $fechaKardex, gmdate( "H:i:s", $hrTraslado*3600 ), $fechaInicio, $horaInicio, $frecuencia );
					
					//Si ultimo suministro es  falso es por la fecha de inicio es posterior a la hora de traslado 
					//Por tanto la fecha y hora de inicio se mantiene
					//Si es verdadero cambio la fecha y hora de inicio por la fecha y hora de inicio despues del traslado
					if( $fhInicioTraslado ){
					
						//Cambio la fecha y hora de inicio por la nueva
						//Siempre sumo uno a la frecuencia ya que la funcion suministroAntesFechaCorte devuelve el ultimo suministro
						//o aplicacion antes o igual a las fecha dada
						//Recordar que $horasFrecuencia esta dada en horas
						$fechaUsar = date( "Y-m-d", $fhInicioTraslado + $frecuencia*3600 );
						$horaUsar= date( "H:i:s", $fhInicioTraslado + $frecuencia*3600 );
					}
					else{
						$horaUsar = $horaInicio;
						$fechaUsar = $fechaInicio;
					}
					
					return true;               //Es primera vez
				}
			}
			else{
				return false;
			}
		}
		else{
			return true;
		}
	}
	else{
	
		/************************************************************************************************************
		 * Abril 23 de 2012
		 *
		 * Si el paciente es trasladado a piso el día actual el kardex se recalcula a partir de la ronda siguiente
		 * de la fecha y hora de traslado
		 ************************************************************************************************************/
		$esTrasladadoUrgenciaCirugia = esTrasladoDeUregnciasDiaAnterior( $conexion, $wbasedato, $historia, $ingreso, date( "Y-m-d", strtotime( $fechaKardex )+24*3600 ) );
		
		if( $esTrasladadoUrgenciaCirugia ){

			$horaTraslado = consultarHoraTrasladoUrgencias( $conexion, $wbasedato, $historia, $ingreso, $fechaKardex );
			
			//Si es traslado de urgencia cirugia el dia actual
			$dejarSaldoArticulo = false;
			
			//Caculo a partir de que horas debe calcular el kardex
			//Esta es siempre a partir de la siguiente ronda de trasaldo
			list( $hrTraslado ) = explode( ":", $horaTraslado );
			
			//Esto calclo la hora par posterior
			$hrTraslado = intval( $hrTraslado/2 )*2;
			
			//Consulto fecha de inicio despues de la hora de traslado
			$fhInicioTraslado = suministroAntesFechaCorte( date( "Y-m-d", strtotime( $fechaKardex." 00:00:00" ) + $hrTraslado*3600 ), 
														   date( "H:i:s", strtotime( $fechaKardex." 00:00:00" ) + $hrTraslado*3600 ), 
														   $fechaInicio, $horaInicio, 
														   $frecuencia );

			//Si ultimo suministro es  falso es por la fecha de inicio es posterior a la hora de traslado 
			//Por tanto la fecha y hora de inicio se mantiene
			//Si es verdadero cambio la fecha y hora de inicio por la fecha y hora de inicio despues del traslado
			if( $fhInicioTraslado ){
				//Cambio la fecha y hora de inicio por la nueva
				//Siempre sumo uno a la frecuencia ya que la funcion suministroAntesFechaCorte devuelve el ultimo suministro
				//o aplicacion antes o igual a las fecha dada
				//Recordar que $horasFrecuencia esta dada en horas
				$fechaUsar = date( "Y-m-d", $fhInicioTraslado + $frecuencia*3600 );
				$horaUsar= date( "H:i:s", $fhInicioTraslado + $frecuencia*3600 );
			}
		}
		/************************************************************************************************************/
		
		return true; 
	}
}

/**
 * Dice si un centro de costos tiene kardex o no
 * 
 * @param $conexion
 * @param $wbasedato
 * @param $cco				Centro de costos donde se encuentra el paciente
 * @param $ccoUsuario		Centro de costos al que pertenece el usuario
 * @return unknown_type
 * 
 * Diciembre 7 de 2010
 */
function servicioConKardex( $conexion, $wbasedato, $cco, $ccoUsuario ){
	
	global $centroCostosServicioFarmaceutico;
	global $centroCostosCentralMezclas;
	
	if( $centroCostosServicioFarmaceutico == $ccoUsuario || $centroCostosCentralMezclas == $ccoUsuario ){
		
		$qMv = "SELECT
					ccokar
				FROM
					{$wbasedato}_000011
				WHERE
					ccocod = '$cco'
					AND ccokar = 'on'
					AND ccoest = 'on'
				";  //echo ".........".$qMv;
		
//		$centroCostosServicioFarmaceutico = "1050";
//		$centroCostosCentralMezclas = "1051";
					
		$res = mysql_query( $qMv, $conexion ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
		$numrows = mysql_num_rows( $res );
		
		if($numrows > 0 ){
			return true;
		}
		else{
			return false;
		}
	}
	else{
		return false;
	}
}

function esTrasladoDeUregnciasDiaAnterior( $conexion, $wbasedato, $historia, $ingreso, $fecha ){
	
	$qMv = "SELECT
				Ccourg, Ccocir, Ccoing
			FROM
				".$wbasedato."_000017, ".$wbasedato."_000011 
			WHERE
				Eyrhis = '$historia'
				AND Eyring = '$ingreso'
				AND Eyrtip = 'Recibo'
				AND ".$wbasedato."_000017.Fecha_data = DATE_SUB('".$fecha."',INTERVAL 1 DAY)
				AND Ccocod = Eyrsor
				AND Eyrest='on'
			";  //echo ".........".$qMv;
	
	$res = mysql_query( $qMv, $conexion ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$numrows = mysql_num_rows( $res );
	
	if($numrows > 0 ){
		
		if( $rows = mysql_fetch_array( $res ) ){
			
			if( ( isset($rows['Ccourg']) && $rows['Ccourg'] == 'on') || ( isset($rows['Ccocir']) && $rows['Ccocir'] == 'on' ) || ( isset($rows['Ccoing']) && $rows['Ccoing'] == 'on' ) ){
				return true;
			}
		}
		else{
			return false;
		}
	}
	else{
		return false;
	}
}


function consultarUnidadManejo( $codigoArticulo, $cco ){
	
	global $conex;
	global $wbasedato;
	
	$sql = "SELECT
				*
			FROM
				cenpro_000002, cenpro_000001
			WHERE
				artcod = '$codigoArticulo'
				AND arttip = tipcod
				AND tipcod != ''
				AND tipcod != 'NO APLICA'
			";
	
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$numrows = mysql_num_rows( $res );
	
	if( $numrows > 0 ){
		
		$sql = "SELECT
					*
				FROM
					{$wbasedato}_000059
				WHERE
					Defcco = '$cco'
					AND defart = '$codigoArticulo'
					AND defest = 'on'
				";
	
		$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
		$numrows = mysql_num_rows( $res );
		
		if( $rows = mysql_affected_rows($res) ){
			return $rows['Deffru'];
		}
	}
	else{
		return;
	}
}

function obtenerMensaje($clave){
	$texto = 'No encontrado';
	global $user;

	$wuser = substr($user, (strpos($user, "-") + 1), strlen($user));
	
	$usuario = consultarUsuarioOrdenes($wuser);
	
	//Si es medico en lugar de kardex debe aparecer Orden
	//En caso contrario debe aparacer kardex
	
	
	switch ($clave) {
		case 'MSJ_KARDEX_CREADO':
			if( $usuario->esMedicoRolHCE )
				$texto = "Orden creada";
			else
				$texto = "Kardex creado";
			break;
		case 'MSJ_KARDEX_ACTUALIZADO':
			if( $usuario->esMedicoRolHCE )
				$texto = "Orden actualizada";
			else
				$texto = "Kardex actualizado";
			break;
		case 'MSJ_ARTICULO_CREADO':
			$texto = "Articulo creado";
			break;
		case 'MSJ_ARTICULO_ACTUALIZADO':
			$texto = "Articulo actualizado";
			break;
		case 'MSJ_ARTICULO_ELIMINADO':
			$texto = "Articulo eliminado";
			break;
		case 'MSJ_ARTICULO_NO_CREADO':
			$texto = "No se pudo crear articulo";
			break;
		case 'MSJ_EXAMEN_CREADO':
			$texto = "Examen creado";
			break;
		case 'MSJ_EXAMEN_ACTUALIZADO':
			$texto = "Examen actualizado";
			break;
		case 'MSJ_EXAMEN_ELIMINADO':
			$texto = "Examen eliminado";
			break;
		case 'MSJ_EXAMEN_NO_CREADO':
			$texto = "No se pudo crear el examen";
			break;
		case 'MSJ_INFUSION_CREADA':
			$texto = "Líquido endovenoso creado";
			break;
		case 'MSJ_INFUSION_ACTUALIZADA':
			$texto = "Liquido endovenoso actualizado";
			break;
		case 'MSJ_INFUSION_ELIMINADA':
			$texto = "Liquido endovenoso eliminado";
			break;
		case 'MSJ_INFUSION_NO_CREADA':
			$texto = "No se pudo crear el liquido endovenoso";
			break;
		case 'MSJ_MEDICO_ASOCIADO':
			$texto = "Medico asociado";
			break;
		case 'MSJ_MEDICO_RETIRADO':
			$texto = "Medico retirado";
			break;
		case 'MSJ_DIETA_ASOCIADA':
			$texto = "Dieta asociada";
			break;
		case 'MSJ_DIETA_RETIRADA':
			$texto = "Dieta retirada";
			break;
		case 'MSJ_ARCHIVO_CARGADO':
			$texto = "Archivo cargado";
			break;
		case 'MSJ_SUSPENDER_MEDICAMENTO':
			$texto = "Articulo suspendido";
			break;
		case 'MSJ_ACTIVAR_MEDICAMENTO':
			$texto = "Articulo activado";
			break;
		case 'MSJ_SUPENSION_NO_MODIFICADA':
			$texto = "Estado de suspension no modificado";
			break;
		case 'MSJ_ARTICULO_MODIFICADO_DESDE_PERFIL':
			$texto = "Articulo modificado desde el perfil farmacologico";
			break;
		case 'MSJ_ARTICULO_NO_MODIFICADO_DESDE_PERFIL':
			$texto = "Articulo no pudo ser modificado desde el perfil farmacologico";
			break;
		case 'MSJ_ARTICULO_REEMPLAZADO_DESDE_PERFIL':
			$texto = "Articulo ha sido reemplazado desde el perfil farmacologico";
			break;
		case 'MSJ_KARDEX_DESAPROBADO':
			$texto = "Kardex no aprobado por parte del regente";
			break;
		case 'MSJ_KARDEX_APROBADO':
			$texto = "Kardex aprobado por parte del regente";
			break;
		case 'MSJ_ALERGIA_MODIFICADA':
			$texto = "Alergia modificada";
			break;
		case 'MSJ_ESQUEMA_GRABADO':
			$texto = "Esquema de insulina grabado";
			break;
		case 'MSJ_ESQUEMA_ELIMINADO':
			$texto = "Esquema de insulina eliminado";
			break;
		case 'MSJ_CANTIDAD_CTC_MODIFICADA':
			$texto = "Cantidad CTC modificada";
			break;
		case 'MSJ_CANTIDAD_CTC_CREADA':
			$texto = "Cantidad CTC creada";
			break;
		case 'MSJ_CANTIDAD_CTC_NO_ALTERADA':
			$texto = "No se pudo crear cantidad CTC";
			break;
		case 'MSJ_ORDEN_CREADA':
			$texto = "Orden creada";
			break;
		case 'MSJ_ORDEN_NO_CREADA':
			$texto = "No se pudo crear la orden";
			break;
		case 'MSJ_ORDEN_CANCELADA':
			$texto = "La orden ha sido cancelada";
			break;
		case 'MSJ_OBSERVACIONES_ORDEN_MODIFICADAS':
			$texto = "Las observaciones de la orden han sido modificadas";
			break;
		case 'MSJ_ARTICULO_APROBADO':
			$texto = "Articulo aprobado";
			break;
		case 'MSJ_ARTICULO_NO_APROBADO':
			$texto = "No se pudo aprobar el articulo";
			break;
		case 'MSJ_SUSPENDIDO_AUTOMATICAMENTE_PERFIL':
			$texto = "Suspendido automaticamente por reemplazo desde el perfil";
			break;
		case 'MSJ_SIN_CTC':
			$texto = "Sin CTC";
			break;
		case 'MSJ_VEL_INF_MODIFICADO':
			$texto = "Velocidad de infusion modificado";
			break;
		case 'MSJ_DOS_CAL_MODIFICADO':
			$texto = "Dosis calculada modificada para IC";
			break;
		case 'MSJ_IC_MEDICAMENTO':
			$texto = "Medicamento de IC modificado";
			break;
		case 'MSJ_IC_SOLUCION':
			$texto = "Solucion de IC modificado";
			break;
		case 'MSJ_LEV_ELECTROLITO':
			$texto = "Electrolito de LEV modificado";
			break;
		case 'MSJ_LEV_SOLUCION':
			$texto = "Solución de LEV modificado";
			break;
		case 'MSJ_IC_SOLUCION_ELIMINADO':
			$texto = "Solución de IC eliminado";
			break;
		case 'MSJ_IC_MEDICAMENTO_ELIMINADO':
			$texto = "Medicamento de IC eliminado";
			break;
		case 'MSJ_LEV_SOLUCION_ELIMINADO':
			$texto = "Solución de LEV eliminado";
			break;
		case 'MSJ_LEV_ELECTROLITO_ELIMINADO':
			$texto = "Electrolito de LEV eliminado";
			break;
		
		case 'TOMA_MUESTRAS_GESTION':
			$texto = "Toma de muestras desde Gestión de enfermería";
			break;
			
		case 'TOMA_MUESTRAS_ORDENES':
			$texto = "Toma de muestras desde ordenes Ordenes";
			break;
			
		default:
			$texto = "Mensaje no especificado";
			break;
	}
	return $texto;
}
/***************************************************************************
 * Prepara el comodin espacio por '%' de sql
 ***************************************************************************/
function prepararCriterio($criterio){
	return str_replace(" ","%",$criterio);
}
/***************************************************************************
 *
 ***************************************************************************/
function inicializarAccionesPestana(){
	$acciones = new AccionPestanaDTO();

	//Inicializacion con todas las acciones
	$acciones->nroPestana = "";
	$acciones->codigoAccion = "";
	$acciones->nombreAccion = "";
	$acciones->crear = false;
	$acciones->leer = false;
	$acciones->borrar = false;
	$acciones->actualizar = false;

	return $acciones;
}

/***************************************************************************
 * FUNCIONES DE VISTAS
 ***************************************************************************/
//Genera la convencion de los articulos
function generarListaProtocolos($nombreCampo,$codigoUsuario,$codigoCco,$filtro = '%'){
	
	global $conex;
	global $wbasedato;

	// Se consulta la especialidad del médico
	$sql =  " SELECT Esmcod
				FROM ".$wbasedato."_000048,".$wbasedato."_000065
			   WHERE Meduma = '".$codigoUsuario."'
				 AND Medest = 'on'
				 AND Esmtdo=Medtdo
				 AND Esmndo=Meddoc;";
	
	$resEspecialidad =  mysql_query($sql,$conex) or die ("Error: ".mysql_errno()." - en el query: ".$sql." - ".mysql_error());
	$numEspecialidad = mysql_num_rows($resEspecialidad);	
	
	$arrayEspecialidades = array();
	if($numEspecialidad > 0)
	{
		while($rowEspecialidad = mysql_fetch_array($resEspecialidad))
		{
			$arrayEspecialidades[] = $rowEspecialidad['Esmcod'];
		}
	}
	
	$especialidades = implode("','",$arrayEspecialidades);
	
	$sql = "SELECT
					Pronom, Dprpes
				FROM
					".$wbasedato."_000137, ".$wbasedato."_000138
				WHERE
						Procod = Dprpro 
					AND Protip = 'Ordenes'
					AND Proest = 'on'
					AND
					(   Dprpes = 'Medicamentos'
					 OR Dprpes = 'Procedimientos'
					)
					AND
					(   Promed = '".$codigoUsuario."'
					 OR Promed = '*'
					)
					AND
					(   Proesp IN ('".$especialidades."')
					 OR Proesp = '*'
					)
					AND
					(   Procco = '".$codigoCco."'
					 OR Procco = '*'
					)
				ORDER BY Pronom ASC
			";

	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$numrows = mysql_num_rows( $res );
	$Pestanas = array();
	
	//Agrupo todo en una pestaña
	if( $numrows > 0 )
	{
		while($rows = mysql_fetch_array($res))
		{
			$Pestanas[ $rows[ 'Pronom' ] ][ $rows[ 'Dprpes' ] ] = 1;
		}
	}

	
	$listaProtocolo .= "<select name='".$nombreCampo."' id='".$nombreCampo."'>";	
	
	$listaProtocolo .= "<option value='' selected> -- seleccione el protocolo -- </option>";
	
	if( count( $Pestanas ) > 0 ){
	
		foreach( $Pestanas as $key => $value ){
			if( $filtro == "%" ){
				$listaProtocolo .= "<option value='".$key."'>".$key."</option>";
			}
			else if( isset( $value[ $filtro ] ) ){
				$listaProtocolo .= "<option value='".$key."'>".$key."</option>";
			}
		}
	}
	
	
	$listaProtocolo .= "</select>";
	return $listaProtocolo;
	
	
	// if( $numrows > 0 )
	// {
		// while($rows = mysql_fetch_array($res))
		// {
			// $listaProtocolo .= "<option value='".$rows['Pronom']."'>".$rows['Pronom']."</option>";
		// }
	// }
	
	// $listaProtocolo .= "</select>";
	// return $listaProtocolo;
}

/***************************************************************************
 * FUNCIONES DE VISTAS
 ***************************************************************************/
//Genera la convencion de los articulos
function vista_generarConvencion($listaProtocolo){
	echo "<div align='center'>";
	echo "<table width='100%' align='center'>";
	echo "<tr align=center>";
	
	if($listaProtocolo != ""){
		echo "<td align='left' valign='bottom' style='font-size:10pt'><b>Nota:</b> Los articulos con saldo no pueden ser eliminados";
		echo "<br /><br />".$listaProtocolo." <input type='button' name='btnImport' value='Importar protocolo' onclick='eleccionMedicamento(1)'>"; 
		echo "</td>";
	}else{		
		echo "<td align='left'>";		
		echo "</td>";
	}
	
	echo "<td class='fila1' width=80>Normal</td>";
	echo "<td class='fila2' width=80>Normal</td>";
	echo "<td class='fila2' width=80 style='background-color:#3CB648;'>Nuevo o modificado</td>";
	echo "<td class='suspendido' width=80>Suspendido</td>";
	echo "<td class='articuloControl' width=80>Control</td>";
	echo "<td class='fondoAlertaConfirmar' width=80 style='text-decoration: blink'>Sin confirmar</td>";	//Marzo 7 de 2011
	echo "<td class='fondoAlertaEliminar' width=80 style='text-decoration: blink'>Inactivo en el<br>Maestro</td>";	//Abril 1 de 2011
	echo "<td class='esCompuesta' width=80>Multidosis</td>";	//Octubre 29 de 2012	
	echo "<td class='celdaResaltadaRojo' width=80  style='font-size:10pt'>Falta<br>configuraci&oacute;n</td>";
	echo "</tr>";
	echo "</table>";
	echo "</div>";
	
	if($listaProtocolo != ""){
		echo "<br>";
	}
}


//Despliega la lista de articulos de acuerdo a los tipos de protocolos
function vista_desplegarListaArticulos($colDetalle,$cantidadElementos,$tipoProtocolo,$esEditable,$colUnidades,$colPeriodicidades,$colVias,$colCondicionesSuministro,$accionesPestana,$indicePestana){
	
	global $strPendientesCTC;
	
	global $grupoControl;
	global $wfecha;
	global $topePorcentualCtc;

	global $conex;
	global $wbasedato;
	global $usuario;		//Información de usuario
	
	global $codigoServicioFarmaceutico;
	
	global $regletaFamilia;
	
	global $paciente;
	
	global $wemp_pmla;
	
	global $wcenmez;

	//Detalle
	global $contArticulos;
	$contArticulos = 0;
	$clase = 'fila1';
	$clasef = 'fila2';
	$mostrarArticulo = false;
	// $tipoProtocoloAux = "N";
	
	$gruposNoVisibles = array();
	if( !$paciente->enUrgencias ){
		$gruposNoVisibles = consultarAliasPorAplicacion( $conex, "01", "gruposNoVisiblesPerfil" );
		$gruposNoVisibles = explode( ',', $gruposNoVisibles );
	}
	
	/********************************************************************************************************************************
	 * Creo dos arryas,uno para la familia y otro para los articulos. Estos arryas solo indican si una familia o articulo se ve en 
	 * pantalla para el usuario
	 ********************************************************************************************************************************/
	$arFam = array();
	$arArt = array();
	$arFamSinConfirmar = array();
	$mostrarLevViejos = false;
	foreach ($colDetalle as $articulo){
		$esLevAnterior = false;
		$mostrarFila = "";
		if( $tipoProtocolo == "LQ" ){
			
			if( !isset( $arFam[ $articulo->codigoFamilia ] ) ){
				$arFam[ $articulo->codigoFamilia ] = false;
			}
		
			$esLevAnterior = esLevAnterior( $conex, $wbasedato, $paciente->historiaClinica, $paciente->ingresoHistoriaClinica, $articulo->consultarCodigoArticulo(), $articulo->idOriginal );
			if( !$esLevAnterior ){
				$mostrarFila = "display:none;";
				$arArt[ $articulo->consultarCodigoArticulo()."-".$articulo->idOriginal ] = false;
			}
			else{
				$arFam[ $articulo->codigoFamilia ] = true;
				$arArt[ $articulo->consultarCodigoArticulo()."-".$articulo->idOriginal ] = true;
				$mostrarLevViejos = true;
			}
		}
		else{
			$arFam[ $articulo->codigoFamilia ] = true;
			$arArt[ $articulo->consultarCodigoArticulo()."-".$articulo->idOriginal ] = true;
			$mostrarLevViejos = true;
			
			if($articulo->origen == 'CM'){
				if($articulo->estaConfirmado != 'on'){
					@$arFamSinConfirmar[ $articulo->codigoFamilia ] = true;
				}
			}
		}
	}
	/******************************************************************************************************************************/
	
	
	
	//Si no hay articulos agrego todas las acciones correspondientes a la pestaña
	// if( count($colDetalle) == 0 ){
		$auxtipoProtocolo="N";
		echo "<INPUT TYPE='hidden' name='wacc$auxtipoProtocolo.2' id='wacc$auxtipoProtocolo.2' value='".accionesATexto(@$accionesPestana[$indicePestana.".$auxtipoProtocolo"."2"])."'>";
		echo "<INPUT TYPE='hidden' name='wacc$auxtipoProtocolo.3' id='wacc$auxtipoProtocolo.3' value='".accionesATexto(@$accionesPestana[$indicePestana.".$auxtipoProtocolo"."3"])."'>";
		echo "<INPUT TYPE='hidden' name='wacc$auxtipoProtocolo.4' id='wacc$auxtipoProtocolo.4' value='".accionesATexto(@$accionesPestana[$indicePestana.".$auxtipoProtocolo"."4"])."'>";
		echo "<INPUT TYPE='hidden' name='wacc$auxtipoProtocolo.5' id='wacc$auxtipoProtocolo.5' value='".accionesATexto(@$accionesPestana[$indicePestana.".$auxtipoProtocolo"."5"])."'>";
		echo "<INPUT TYPE='hidden' name='wacc$auxtipoProtocolo.7' id='wacc$auxtipoProtocolo.7' value='".accionesATexto(@$accionesPestana[$indicePestana.".$auxtipoProtocolo"."7"])."'>";
		echo "<INPUT TYPE='hidden' name='wacc$auxtipoProtocolo.8' id='wacc$auxtipoProtocolo.8' value='".accionesATexto(@$accionesPestana[$indicePestana.".$auxtipoProtocolo"."8"])."'>";
		echo "<INPUT TYPE='hidden' name='wacc$auxtipoProtocolo.9' id='wacc$auxtipoProtocolo.9' value='".accionesATexto(@$accionesPestana[$indicePestana.".$auxtipoProtocolo"."9"])."'>";
		echo "<INPUT TYPE='hidden' name='wacc$auxtipoProtocolo.10' id='wacc$auxtipoProtocolo.10' value='".accionesATexto(@$accionesPestana[$indicePestana.".$auxtipoProtocolo"."10"])."'>";
		echo "<INPUT TYPE='hidden' name='wacc$auxtipoProtocolo.11' id='wacc$auxtipoProtocolo.11' value='".accionesATexto(@$accionesPestana[$indicePestana.".$auxtipoProtocolo"."11"])."'>";
		echo "<INPUT TYPE='hidden' name='wacc$auxtipoProtocolo.12' id='wacc$auxtipoProtocolo.12' value='".accionesATexto(@$accionesPestana[$indicePestana.".$auxtipoProtocolo"."12"])."'>";
		echo "<INPUT TYPE='hidden' name='wacc$auxtipoProtocolo.13' id='wacc$auxtipoProtocolo.13' value='".accionesATexto(@$accionesPestana[$indicePestana.".$auxtipoProtocolo"."13"])."'>";
		echo "<INPUT TYPE='hidden' name='wacc$auxtipoProtocolo.14' id='wacc$auxtipoProtocolo.14' value='".accionesATexto(@$accionesPestana[$indicePestana.".$auxtipoProtocolo"."14"])."'>";
		echo "<INPUT TYPE='hidden' name='wacc$auxtipoProtocolo.15' id='wacc$auxtipoProtocolo.15' value='".accionesATexto(@$accionesPestana[$indicePestana.".$auxtipoProtocolo"."15"])."'>";
		echo "<INPUT TYPE='hidden' name='wacc$auxtipoProtocolo.20' id='wacc$auxtipoProtocolo.20' value='".accionesATexto(@$accionesPestana[$indicePestana.".$auxtipoProtocolo"."20"])."'>";
		echo "<INPUT TYPE='hidden' name='wacc$auxtipoProtocolo.21' id='wacc$auxtipoProtocolo.21' value='".accionesATexto(@$accionesPestana[$indicePestana.".$auxtipoProtocolo"."21"])."'>";
		echo "<INPUT TYPE='hidden' name='wacc$auxtipoProtocolo.22' id='wacc$auxtipoProtocolo.22' value='".accionesATexto(@$accionesPestana[$indicePestana.".$auxtipoProtocolo"."22"])."'>";
		echo "<INPUT TYPE='hidden' name='wacc$auxtipoProtocolo.23' id='wacc$auxtipoProtocolo.23' value='".accionesATexto(@$accionesPestana[$indicePestana.".$auxtipoProtocolo"."23"])."'>";
		unset( $auxtipoProtocolo );
	// }

	echo "<table align='center' border='0' id='tbDetalleAdd$tipoProtocolo'>";

	/******************************************************************************************
	 * Esta tabla se comenta, puede haber una por cada tipo de protocolo
	 * En caso de requerirse descomentar y organizar en el javascript la tabla de agregado
	 * según el protocolo
	 ******************************************************************************************/
	// /////////////////////////////////////////
	// // Encabezado articulos agregados
	// echo "<tr align='center' class='encabezadoTabla' id='trEncabezadoTbAdd' style='display:none;'>";
	// // $tipoProtocolo="N";
	// echo "<td>Acciones</td>";
	// echo "<td>Medicamento<span class='obligatorio'>(*)</span></td>";
	// echo "<td style='display:none'>Protocolo</td>";
	// echo "<td>No enviar</td>";
	// echo "<td>Dosis a aplicar<span class='obligatorio'>(*)</span></td>";
	// echo "<td>Frecuencia<span class='obligatorio'>(*)</span></td>";
	// echo "<td>Via<span class='obligatorio'>(*)</span></td>";
	// echo "<td>Fecha y hora inicio<span class='obligatorio'>(*)</span></td>";
	// echo "<td>Condici&oacute;n</td>";
	// echo "<td>Cnf.</td>";
	// echo "<td>Dias tto.</td>";
	// echo "<td>Dosis máx.</td>";
	// echo "<td>Observaciones</td>";
	// echo "</tr>";
	// /////////////////////////////////////////

	// echo "<tbody id='detKardexAdd$tipoProtocolo'>";
	// echo "</tbody>";

	// echo "</table>";

	if( !$mostrarLevViejos && $tipoProtocolo == "LQ" )
		echo "<br /><table align='center' border='0' id='tbDetalle$tipoProtocolo' style='display:none'>";
		
	else
		echo "<br /><table align='center' border='0' id='tbDetalle$tipoProtocolo'>";
	echo "<tbody id='detKardex$tipoProtocolo'>";

	if(isset($cantidadElementos) && $cantidadElementos > 0)	
	{
		echo "<tr align='center' class='encabezadoTabla' id='trEncabezadoTb$tipoProtocolo'>";
		// $tipoProtocolo="N";
		//echo "<td>Acciones</td>";
		echo "<td>MEDICAMENTO</td>";
		echo "<td>02</td>";
		echo "<td>04</td>";
		echo "<td>06</td>";
		echo "<td>08</td>";
		echo "<td>10</td>";
		echo "<td>12</td>";
		echo "<td>14</td>";
		echo "<td>16</td>";
		echo "<td>18</td>";
		echo "<td>20</td>";
		echo "<td>22</td>";
		echo "<td>24</td>";
		echo "</tr>";
	}
	
	$aux = $esEditable;
	$auxFamilia = "";
	$contFamilia = 1;
	$contArtsFam = 1;
	
	foreach ($colDetalle as &$articulo){
		
		$esEditable = $aux;
		$aElminiar = false;
		$clase_pendientes = "";
		$pendiente_lectura= "";
		
		//Agrego la propiedad al articulo si esInsulina
		//ESto para indicar que el articulo fue agregado por dextrometer
		//Es del dextrometer si y solo si tiene una frecuencia de tipo Insulina (Esta se agrega solo por dextrometer)
		//objPeriocidad es un objeto PeriodicidadDTO
		//Solo se puede modicar la fecha y hora de inicio si es un articulo de insulina (agregado por dextrometer)
		@$articulo->objPeriocidad = consultarPeriodicidadesPorCodigo( $conex, $wbasedato, $articulo->periodicidad );
		@$articulo->esInsulina = $articulo->objPeriocidad->esTipoInsulina;
		
		if( $articulo->estadoArticulo != "on" && $articulo->origen == $codigoServicioFarmaceutico ){
			$esEditable = false;
			$aElminiar = true;
		}

		// Inicio cambio de familia de medicamentos
		if($articulo->codigoFamilia!=$auxFamilia)
		{

			if($contArtsFam==0)
			{
				$actFamilia = $contFamilia-1;
				echo "<script> cambiarDisplay('filaTituloFamilia".$tipoProtocolo.$actFamilia."'); cambiarDisplay('trEncabezadoTb".$tipoProtocolo.$actFamilia."');  </script>";
			}

			$contArtsFam = 0;
			
			if($clasef == 'fila2')
				$clasef = 'fila1';
			else
				$clasef = 'fila2';

			if(isset($regletaFamilia[$articulo->codigoFamilia]['esCompuestaFamilia']) && $regletaFamilia[$articulo->codigoFamilia]['esCompuestaFamilia']=='1')
				$clasef = 'esCompuesta';
			
			$classfSinConfirmar = "";
			if( isset( $arFamSinConfirmar[ $articulo->codigoFamilia ] ) && $arFamSinConfirmar[ $articulo->codigoFamilia ] ){
				$classfSinConfirmar = "fondoAlertaConfirmar";
			}
			
			$buscar_familia_pendientes = buscar_familias_pendientes($paciente->historiaClinica, $paciente->ingresoHistoriaClinica, $articulo->codigoFamilia);
			
			if( permiteLecturaOrdenesPendientes( $conex, $wemp_pmla, $usuario->codigoRolHCE ) ){				
				if($buscar_familia_pendientes){
					$clase_pendientes = 'background-color:#3CB648;';
				}
			}
			
			//Busca si los articulos asociados a una familia se encuentran suspendidos.
			$buscar_familia_suspendida = buscar_familias_suspendidas($paciente->historiaClinica, $paciente->ingresoHistoriaClinica, $articulo->codigoFamilia);
			
			//Si toda la familia esta suspendida para el paciente se marca el tr como suspendido.
			if($buscar_familia_suspendida){
				$clasef = 'suspendido';
				
			}			
			
			if($contFamilia>1)
			{
				echo "</table>";
				echo "</div>";
				echo "</td></tr>";
				echo "<tr><td colspan='13'>&nbsp;</td></tr>";
				echo "</tbody>";
			}
			
			$resFam = consultarPrincipiosActivosPorFamilia( $conex, $wbasedato, $articulo->codigoFamilia );
			$codsFam = codigosPrincipiosActivos( $resFam, false,'-' );
			
			$mostrarFila = $arFam[ $articulo->codigoFamilia ] ? "": "display:none;";
			echo "<tr pActivo='".$articulo->codigoPrincipioActivo."' title='".$codsFam."' class='".$clasef."' id='filaTituloFamilia".$tipoProtocolo.$contFamilia."' style='cursor: pointer;$mostrarFila' onclick='mostrarDetalleFlia(this,\"detKardex".$tipoProtocolo.$contFamilia."\",\"divDetalle".$tipoProtocolo.$contFamilia."\",\"filaTituloFamilia".$tipoProtocolo.$contFamilia."\",\"".$clasef."\");'><td style='$clase_pendientes' class='$classfSinConfirmar'><b>".$articulo->codigoFamilia." - ".$articulo->nombreFamilia."</b></td>";

			// echo "<td colspan='8'>";
			// echo "<table><tr>";
			//print_r($regletaFamilia[$articulo->codigoFamilia]);
			/*********************************************************
			 * 	GRAFICA DE LOS HORARIOS DE SUMINISTRO DE FAMILIAS.
			 *
			 *
			 * 1.  Si la fecha de inicio es menor o igual a la de consulta del kardex se muestra la info
			 * 2.  Si se encuentra suspendido no se muestra la grafica
			 *********************************************************/
			//Grafica de los horarios ... 24 horas del dia.  Debe convertirse a horas cada periodicidad

			$horaArranque = 2;

			$cont3 = 1;
			$cont4 = $horaArranque;   //Desplazamiento desde la hora inicial
			//$claseGrafica = "fondoVerde";

			while($cont3 <= 24)
			{
				if(isset($regletaFamilia[$articulo->codigoFamilia][$cont4]['valor']) && $regletaFamilia[$articulo->codigoFamilia][$cont4]['valor'] > 0){
					echo "<td class='msg_tooltip' title='".$regletaFamilia[$articulo->codigoFamilia][$cont4]['tooltip']."' align='center' onMouseOver='mostrarTooltip(this, $cont4)' width='100'>";
					echo $regletaFamilia[$articulo->codigoFamilia][$cont4]['valor']." ".$regletaFamilia[$articulo->codigoFamilia][$cont4]['unidad'];
					echo "</td>";
				} else {
					echo "<td class='msg_tooltip' title='".$regletaFamilia[$articulo->codigoFamilia][$cont4]['tooltip']."' onMouseOver='mostrarTooltip(this, $cont4)' width='50'>&nbsp;</td>";
				}

				if($cont4 == 24){
					$cont4 = 0;
				}

				$cont3++;
				$cont4++;

				if($cont4 % 2 != 0){
					$cont4++;
				}
				if($cont3 % 2 != 0){
					$cont3++;
				}

				if($cont4 == $horaArranque){
					break;
				}
			}
			//echo "</tr></table>";


			//echo "</td>";
			echo "</tr>";
			echo "<tbody id='detKardex$tipoProtocolo$contFamilia' style='display:none;'>";
			echo "<tr><td colspan='13'>";
			echo "<div id='divDetalle$tipoProtocolo$contFamilia' style='display:none;'>";
			echo "<table align='center'>";

			$contFamilia++;

			// Inicio encabezado articulos
			echo "<tr align='center' class='encabezadoTabla' id='trEncabezadoTb$tipoProtocolo$contFamilia'>";

			// $tipoProtocolo="N";
			if($esEditable){
				echo "<td>";
				echo "Acciones";
				
				// echo "<INPUT TYPE='hidden' name='wacc$tipoProtocolo.15' id='wacc$tipoProtocolo.15' value='".accionesATexto(@$accionesPestana[$indicePestana.".$tipoProtocolo"."15"])."'>";
				// echo "<INPUT TYPE='hidden' name='wacc$tipoProtocolo.2' id='wacc$tipoProtocolo.2' value='".accionesATexto(@$accionesPestana[$indicePestana.".$tipoProtocolo"."2"])."'>";
				// echo "<INPUT TYPE='hidden' name='wacc$tipoProtocolo.3' id='wacc$tipoProtocolo.3' value='".accionesATexto(@$accionesPestana[$indicePestana.".$tipoProtocolo"."3"])."'>";
				echo "</td>";
				echo "<td>Imprimir</span></td>";
				echo "<td>Medicamento<span class='obligatorio'>(*)</span></td>";
				echo "<td style='display:none'>Protocolo</td>";
				echo "<td>";
				echo "No enviar";
				// echo "<INPUT TYPE='hidden' name='wacc$tipoProtocolo.4' id='wacc$tipoProtocolo.4' value='".accionesATexto(@$accionesPestana[$indicePestana.".$tipoProtocolo"."4"])."'>";
				echo "</td>";
				echo "<td>";
				echo "Dosis a aplicar<span class='obligatorio'>(*)</span>";
				// echo "<INPUT TYPE='hidden' name='wacc$tipoProtocolo.5' id='wacc$tipoProtocolo.5' value='".accionesATexto(@$accionesPestana[$indicePestana.".$tipoProtocolo"."5"])."'>";
				echo "</td>";
				echo "<td>";
				echo "Frecuencia<span class='obligatorio'>(*)</span>";
				// echo "<INPUT TYPE='hidden' name='wacc$tipoProtocolo.7' id='wacc$tipoProtocolo.7' value='".accionesATexto(@$accionesPestana[$indicePestana.".$tipoProtocolo"."7"])."'>";
				echo "</td>";
				echo "<td>";
				echo "Via<span class='obligatorio'>(*)</span>";
				// echo "<INPUT TYPE='hidden' name='wacc$tipoProtocolo.8' id='wacc$tipoProtocolo.8' value='".accionesATexto(@$accionesPestana[$indicePestana.".$tipoProtocolo"."8"])."'>";
				echo "</td>";
				echo "<td>";
				echo "Fecha y hora inicio<span class='obligatorio'>(*)</span>";
				// echo "<INPUT TYPE='hidden' name='wacc$tipoProtocolo.9' id='wacc$tipoProtocolo.9' value='".accionesATexto(@$accionesPestana[$indicePestana.".$tipoProtocolo"."9"])."'>";
				echo "</td>";
				echo "<td>";
				echo "Condici&oacute;n";
				// echo "<INPUT TYPE='hidden' name='wacc$tipoProtocolo.10' id='wacc$tipoProtocolo.10' value='".accionesATexto(@$accionesPestana[$indicePestana.".$tipoProtocolo"."10"])."'>";
				echo "</td>";
				echo "<td>";
				echo "Cnf.";
				// echo "<INPUT TYPE='hidden' name='wacc$tipoProtocolo.11' id='wacc$tipoProtocolo.11' value='".accionesATexto(@$accionesPestana[$indicePestana.".$tipoProtocolo"."11"])."'>";
				echo "</td>";
				echo "<td>";
				echo "DA.";				
				echo "</td>";
				echo "<td>";
				echo "NE.";				
				echo "</td>";
				echo "<td>";
				echo "Filtro<br>antibi&oacute;ticos";
				echo "</td>";
				echo "<td>";
				echo "Dias tto.";
				// echo "<INPUT TYPE='hidden' name='wacc$tipoProtocolo.12' id='wacc$tipoProtocolo.12' value='".accionesATexto(@$accionesPestana[$indicePestana.".$tipoProtocolo"."12"])."'>";
				echo "</td>";
				echo "<td>";
				echo "Dosis máx.</td>";
				// echo "<INPUT TYPE='hidden' name='wacc$tipoProtocolo.13' id='wacc$tipoProtocolo.13' value='".accionesATexto(@$accionesPestana[$indicePestana.".$tipoProtocolo"."13"])."'>";
				echo "<td>";
				echo "Observaciones";
				// echo "<INPUT TYPE='hidden' name='wacc$tipoProtocolo.14' id='wacc$tipoProtocolo.14' value='".accionesATexto(@$accionesPestana[$indicePestana.".$tipoProtocolo"."14"])."'>";
				echo "</td>";
				echo "<td>02</td>";
				echo "<td>04</td>";
				echo "<td>06</td>";
				echo "<td>08</td>";
				echo "<td>10</td>";
				echo "<td>12</td>";
				echo "<td>14</td>";
				echo "<td>16</td>";
				echo "<td>18</td>";
				echo "<td>20</td>";
				echo "<td>22</td>";
				echo "<td>24</td>";
			} else {
				echo "<td>Acciones</td>";
				echo "<td width='100px'>Articulo</td>";
				echo "<td style='display:none'>Protocolo</td>";
				echo "<td>No enviar</td>";
				echo "<td>Dosis a aplicar</td>";
				echo "<td>Frecuencia</td>";
				echo "<td>Via</td>";
				echo "<td>Fecha y hora inicio</td>";
				echo "<td>Condici&oacute;n</td>";				
				echo "<td>Cnf.</td>";
				echo "<td>DA.</td>";
				echo "<td>NE.</td>";
				echo "<td>Filtro<br>antibi&oacute;ticos</td>";
				echo "<td>Dias tto.</td>";
				echo "<td>Dosis máx.</td>";
				echo "<td>Observaciones</td>";
				echo "<td>02</td>";
				echo "<td>04</td>";
				echo "<td>06</td>";
				echo "<td>08</td>";
				echo "<td>10</td>";
				echo "<td>12</td>";
				echo "<td>14</td>";
				echo "<td>16</td>";
				echo "<td>18</td>";
				echo "<td>20</td>";
				echo "<td>22</td>";
				echo "<td>24</td>";
			}
			echo "</tr>";
			// Fin encabezado articulos
			
		}	// Fin cambio de familia de medicamentos

		$auxFamilia = $articulo->codigoFamilia;
		
		// var_dump($articulo->historia);
		// var_dump($articulo->ingreso);
		// var_dump($articulo->consultarCodigoArticulo());
		// var_dump($articulo->idOriginal);
		
		$funcionOnclickAbrirNPT = consultarSiEsNutricionNPT($wbasedato,$articulo->historia,$articulo->ingreso,$articulo->consultarCodigoArticulo(),$articulo->idOriginal);
		
		//Mirar si esto funciona!
		// $articulo->tipoProtocolo = $tipoProtocoloAux;
		
		$mostrarArticulo = true;
		if($mostrarArticulo){
			
			$articulo->consecutivoArticuloOrden = $contArticulos;
			
			$mostrarFila = $arArt[ $articulo->consultarCodigoArticulo()."-".$articulo->idOriginal ] ? "": "display:none";
			
			$claseEliminar = "";
			
			$existeFraccion = existeFraccion( $conex, $wbasedato, $articulo->consultarCodigoArticulo(), $articulo->origen );
			if( !$existeFraccion ){
				$claseEliminar = "class='celdaResaltadaRojo'";
			}
			
			if( $aElminiar ){
				$claseEliminar = "class='fondoAlertaEliminar'";
			}
			
			if( permiteLecturaOrdenesPendientes( $conex, "01", $usuario->codigoRolHCE ) ){
				if($articulo->pendiente_leer=="on"){				
					$pendiente_lectura = "style='background-color:#3CB648'";
				}
			}
			
			if($articulo->suspendido == 'on'){
				$clase = 'suspendido';
			}else{
				if($clase == 'fila2'){
					$clase = 'fila1';
				} else {
					$clase = 'fila2';
				}

				//Si el articulo es del grupo de control se resalta con color morado
				if($articulo->grupo == $grupoControl){
					$clase = "articuloControl";
				}
			}

			//Informacion adicional del articulo
			// $informacion = "<strong>$articulo->codigoArticulo</strong><br>";
			$informacion = "<strong>$articulo->nombreGenerico</strong><br>";
			
			// $informacion .= "<br><strong>Nombre Comercial: </strong>$articulo->nombreGenerico<br>";
			$informacion .= "<br><strong>Nombre Comercial: </strong>".$articulo->consultarNombreArticulo()."<br>";

			$informacion .= "<br>$articulo->maximoUnidadManejo ".descripcionMaestroPorCodigo($colUnidades,$articulo->unidadMaximoManejo)." POR ".descripcionMaestroPorCodigo($colUnidades,$articulo->unidadManejo)."</strong><br><br>";

			//Ctc
			if(isset($articulo->cantidadAutorizadaCtc) && !empty($articulo->cantidadAutorizadaCtc)){
				$miniClase = "";
				$diferenciaCtc = intval($articulo->cantidadAutorizadaCtc)-intval($articulo->cantidadUtilizadaCtc);
				$porcentajeUsoCtc = ($articulo->cantidadUtilizadaCtc/$articulo->cantidadAutorizadaCtc)*100;

				$informacion .= "<br><strong>ESTADO DE CTC</strong><br>";
				$informacion .= "Autorizado: $articulo->cantidadAutorizadaCtc<br>";
				$informacion .= "Utilizado	: $articulo->cantidadUtilizadaCtc<br>";
				if($diferenciaCtc > 0){
					$miniClase = "fondoVerde";
				} else {
					$miniClase = "fondoRojo";
				}

				//Alerta si se llega al tope
				if($porcentajeUsoCtc >= $topePorcentualCtc){
					$miniClase = "fondoRojo";
					// mensajeEmergente("El articulo ".trim($articulo->codigoArticulo)." está a punto de agotarse o se agotó por CTC.  Utilización: ".intval($porcentajeUsoCtc)."%");
					$msg = "El articulo ".trim($articulo->codigoArticulo)." está a punto de agotarse o se agotó por CTC.  Utilización: ".intval($porcentajeUsoCtc)."%";
					echo "<script>";
					echo "alertsIniciales[alertsIniciales.length] = '$msg';";
					echo "</script>";
				}
				$informacion .= "<span class=$miniClase><strong>DISPONIBLE</strong>: $diferenciaCtc</span><br>";
				$informacion .= "<br>";
			}

			if($articulo->esDispensable == 'on'){
				$informacion .= "-Es dispensable<br>";
			} else {
				$informacion .= "-No es dispensable<br>";
			}

			if($articulo->esDuplicable == 'on'){
				$informacion .= "-Es duplicable<br>";
			} else {
				$informacion .= "-No es duplicable<br>";
			}

			if($articulo->diasTotalesTto > 0){
				$informacion .= "-D&iacute;as acumulados: ".$articulo->diasTotalesTto."<br>";
			} else {
				$informacion .= "-D&iacute;as acumulados: 0<br>";
			}

			if($articulo->dosisTotalesTto > 0){
				$informacion .= "-Dosis acumuladas: ".$articulo->dosisTotalesTto."<br>";
				
			} else {
				$informacion .= "-Dosis acumuladas: 0<br>";
			}
			
			$filaVisible = "";
			if($articulo->altaArticulo=="on")
				$filaVisible = " style='display:none;'";
			else
				$contArtsFam++;
			
			
			
			$dosisDelArticulo = $articulo->cantidadDosis;
			if( $articulo->esPediatrico ){
				$dosisDelArticulo = $articulo->conInsumoCalculado1;
			}
			
			$unidadArticulo = $articulo->unidadDosis;
			$formaFarmaceuticaArticulo = $articulo->formaFarmaceutica;
			
			// validar si es producto de central de mezclas
			$detalleDosisPurga = "";
			if($articulo->origen=="CM")
			{
				$artCM = $articulo->codigoArticulo;
				$artCM = explode("-",$artCM);
				
				// si es una DA con purga debe mostrar la dosis ordenada (sin purga)
				$articuloSinPurga = consultarDosisSinPurgaDA($conex,$wbasedato,$wcenmez,$articulo->historia,$articulo->ingreso,$artCM[0],$articulo->idOriginal,$articulo->cantidadDosis,$unidadArticulo,$formaFarmaceuticaArticulo);
				
				$dosisDelArticulo = $articuloSinPurga['dosis'];
				$unidadArticulo = $articuloSinPurga['unidad'];
				$formaFarmaceuticaArticulo = $articuloSinPurga['formaFarmaceutica'];
				
				$detalleDosisPurga = pintarDetalleDosisPurgaDA($dosisDelArticulo,$articulo->cantidadDosis,$unidadArticulo,$articulo->unidadDosis,$esEditable,$formaFarmaceuticaArticulo);
				
				if( !$esEditable )
				{
					$informacion .= $detalleDosisPurga;
				}
			}
			
			$informacion .= " - Justificaci&oacute;n para actualizar: ".$articulo->jusParaAutorizar;
			
			echo "<tr id='trFil".$contArticulos."' idtr=trFil".$tipoProtocolo.$contArticulos." title=' - ".$informacion."' class='".$clase."'".$filaVisible." style='$mostrarFila'>";
			
			if( $esEditable ){
				$eventosQuitarTooltip = " onMouseOver='quitarTooltip( this )' onMouseOut='reestablecerTooltip( this );'";	//Creo los eventos que quitan el tooltip si el kardex es editable
			}

			$classAutRequerido = '';
			if( !$articulo->autorizadoPorDirector ){
				$classAutRequerido = " style='background : brown;' ";
			}

			//Acciones			
			echo "<td align=center $eventosQuitarTooltip $pendiente_lectura>";
			if($esEditable && $articulo->permiteModificar){
				
				$tieneSaldo = tieneSaldo( $conex, $wbasedato, $articulo->historia, $articulo->ingreso, $articulo->consultarCodigoArticulo() );
				
				$usuario->permisosPestanas[ $indicePestana ]['modifica'];
				
				$puedeEliminar = true;
				if( $usuario->permisosPestanas[ $indicePestana ]['modifica'] ){
				
					if( $articulo->codigoCreador != $usuario->codigo ){
						$puedeEliminar = false;
					}
				}
				
				//Si es un articulo del stock no se puede eliminar
				if( $puedeEliminar && esStock( $conex, $wbasedato, $articulo->consultarCodigoArticulo(), $paciente->servicioActual ) ){
					$puedeEliminar = false;
				}
				
				//Se comenta esta parte del codigo para que no muestre la x de eliminar articulo.
				// if( $puedeEliminar && !$tieneSaldo ){
					// crearCampo("4","",@$accionesPestana[$indicePestana.".$tipoProtocolo"."2"],array("onClick"=>"quitarArticulo($contArticulos,'$articulo->tipoProtocolo',this);"),"<img src='../../images/medical/root/borrar.png' border='0' width='17' height='17' />");
					
					// echo "&nbsp;";
				// }

				$rolNoSuspenden = consultarAliasPorAplicacion( $conex, $wemp_pmla, "rolNoSuspenden" ); 
				$rolNoSuspenden = explode( ",", $rolNoSuspenden );
				
				$usuCreador = consultarUsuarioOrdenes( $articulo->codigoCreador );
				
				// if( !in_array( $usuario->codigoRolHCE, $rolNoSuspenden ) || ( in_array( $usuario->codigoRolHCE, $rolNoSuspenden ) && $articulo->codigoCreador == $usuario->codigo ) ){
				if( !in_array( $usuario->codigoRolHCE, $rolNoSuspenden ) || ( in_array( $usuario->codigoRolHCE, $rolNoSuspenden ) && in_array( $usuCreador->codigoRolHCE, $rolNoSuspenden ) ) ){
					//$mostarBotonSuspender = $articulo->esInsulina ? "display:none;":"display:";
					//crearCampo("4","",@$accionesPestana[$indicePestana.".$tipoProtocolo"."3"],array("style"=>$mostarBotonSuspender,"onClick"=>"suspenderArticulo($contArticulos,'$articulo->tipoProtocolo');"),"<img src='../../images/medical/root/suspender.png' border='0' width='17' height='17' />");

					$esMedAgrupado = consultarMedicamentosRelacionadosProcAgrup($articulo->historia, $articulo->ingreso, $articulo->consultarCodigoArticulo(), $articulo->idOriginal);
				
					if($esMedAgrupado == false)
					{
						//crearCampo("4","",@$accionesPestana[$indicePestana.".$tipoProtocolo"."3"],array("onClick"=>"suspenderArticulo($contArticulos,'$articulo->tipoProtocolo');"),"<img src='../../images/medical/root/suspender.png' border='0' width='17' height='17' />");


						$mostarBotonSuspender = $articulo->esInsulina ? "display:none;":"display:";
						crearCampo("4","",@$accionesPestana[$indicePestana.".$tipoProtocolo"."3"],array("style"=>$mostarBotonSuspender,"onClick"=>"suspenderArticulo($contArticulos,'$articulo->tipoProtocolo');"),"<img src='../../images/medical/root/suspender.png' border='0' width='17' height='17' />");
					}
					// crearCampo("4","",@$accionesPestana[$indicePestana.".$tipoProtocolo"."3"],array("onClick"=>"suspenderArticulo($contArticulos,'$articulo->tipoProtocolo');"),"<img src='../../images/medical/root/suspender.png' border='0' width='17' height='17' />");
				}
				
				if($articulo->grupo == $grupoControl){
					echo "<a id='wcontrolimp$articulo->tipoProtocolo.$contArticulos' href=#null onclick='mostrarMedicamentoControlAImprimir( \"".$articulo->tipoProtocolo.$contArticulos."\" )'><img src='../../images/medical/root/americassu.png' width=17 height=17 border=0 title='ver formato de control'></a>";
				}
				
				echo "<td align=center $classAutRequerido>";
				echo "<div id='imgImprimir' style='display:inline'>";
				echo "<img width='18' height='18' border='0' src='../../images/medical/hce/icono_imprimir.png'><br>";		
				crearCampo("5","wchkimp_art$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."20"], array("onClick"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');","checked"=>"checked"),"");
				echo "</td>";
			} else {
				echo "&nbsp;";
			}
			echo "</td>";
			
			//Articulo
			echo "<td $claseEliminar  ".$funcionOnclickAbrirNPT." $classAutRequerido>";
			if($esEditable){
				echo "<div id='wnmmed$articulo->tipoProtocolo$contArticulos'>$articulo->codigoArticulo</div>";
			} else {
				echo $articulo->codigoArticulo;
			}
			echo "</td>";
			

			//Nombre del protocolo
			echo "<td align=center style='display:none'>";
			if($esEditable){
				echo $articulo->nombreProtocolo;
			}
			echo "</td>";
			
			//No dispensar
			echo "<td align=center $eventosQuitarTooltip>";
			if($esEditable){
				
				$disableNoEnviar = "";
				if( $articulo->esInsulina ){
					$disableNoEnviar = "disabled";
				}
				
				//Julio 17 de 2019. Se comenta está condición
				//Aclaración: Si el articulo es de ayuda dx y se deja como no enviar, el medicamento no se ve en las ordenes y tampoco en el perfil
				// if( $articulo->porProtocolo ){
					// $disableNoEnviar = "disabled";
				// }
				
				if( in_array( $articulo->grupo, $gruposNoVisibles ) ){
					$disableNoEnviar = "disabled";
				}
				
				if($articulo->estadoAdministracion == 'on'){
					crearCampo("5","wchkdisp$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."4"],array("$disableNoEnviar"=>"","checked"=>"","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');"),"");
					//					echo "<input type='checkbox' name='wchkdisp$articulo->tipoProtocolo$contArticulos' id='wchkdisp$articulo->tipoProtocolo$contArticulos' alt='No dispensar' checked onChange='marcarCambio(\"$articulo->tipoProtocolo\",\"$contArticulos\");'>";
				} else {
					crearCampo("5","wchkdisp$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."4"],array("$disableNoEnviar"=>"","unchecked"=>"","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');"),"");
					//					echo "<input type='checkbox' name='wchkdisp$articulo->tipoProtocolo$contArticulos' id='wchkdisp$articulo->tipoProtocolo$contArticulos' alt='No dispensar' onChange='marcarCambio(\"$articulo->tipoProtocolo\",\"$contArticulos\");'>";
				}
			} else {
				if($articulo->estaConfirmado == 'on'){
					echo "Si";
				} else {
					echo "No";
				}
			}
			echo "</td>";

			
			//Dosis y unidad de medida
			echo "<td $eventosQuitarTooltip>";
			if($esEditable)
			{
				echo $detalleDosisPurga;
				// 2012-06-27
				// // Se adiciona el atributo "readonly" para que este campo siempre sea de solo lectura, que no se pueda modificar
				// crearCampo("1","wdosis$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."5"],array("size"=>"7","maxlength"=>"7","class"=>"campo2","readonly"=>"readonly","onKeyPress"=>"return validarEntradaDecimal(event)","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');"),"$articulo->cantidadDosis");
				
				if($esMedAgrupado == true)
				{
					crearCampo("1","wdosis$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."5"],array("size"=>"7","maxlength"=>"7","class"=>"campo2","readonly"=>"readonly","onKeyPress"=>"return validarEntradaDecimal(event)","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');"),"$articulo->cantidadDosis");
					
				}
				else
				{
					// Se adiciona el atributo "readonly" para que este campo siempre sea de solo lectura, que no se pueda modificar
					crearCampo("1","wdosis$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."5"],array("size"=>"7","maxlength"=>"7","class"=>"campo2","readonly"=>"readonly","onKeyPress"=>"return validarEntradaDecimal(event)","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');"),"$dosisDelArticulo");
				}
				
				echo "<input type='hidden' name='wdosisori$articulo->tipoProtocolo$contArticulos' id='wdosisori$articulo->tipoProtocolo$contArticulos' value='$articulo->cantidadDosis' />";
				//				echo "<INPUT TYPE='text' NAME='wdosis$articulo->tipoProtocolo$contArticulos' id='wdosis$articulo->tipoProtocolo$contArticulos' size=7 maxlength=7 onkeypress='return validarEntradaDecimal(event);' class='campo2' value='$articulo->cantidadDosis' onChange='marcarCambio(\"$articulo->tipoProtocolo\",\"$contArticulos\");'>";
				$opcionesSeleccion = "";
				foreach ($colUnidades as $unidad){
					if(trim($unidad->codigo) == trim($unidadArticulo)){
						$opcionesSeleccion .= "<option value='".$unidad->codigo."' selected>$unidad->descripcion</option>";
					}
				}
				
				if($esMedAgrupado == true)
				{
					crearCampo("6","wudosis$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."6"],array("style"=>"width:120","disabled"=>"disabled","class"=>"seleccion","disabled"=>""),"$opcionesSeleccion");
				}
				else
				{
					crearCampo("6","wudosis$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."6"],array("style"=>"width:120","class"=>"seleccion","disabled"=>""),"$opcionesSeleccion");
				}
								
				// crearCampo("6","wudosis$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."6"],array("style"=>"width:120","class"=>"seleccion","disabled"=>""),"$opcionesSeleccion");
				
				echo "<input type='hidden' name='wudosisori$articulo->tipoProtocolo$contArticulos' id='wudosisori$articulo->tipoProtocolo$contArticulos' value='$articulo->unidadDosis' />";

				$colFormasFarmaceuticas = consultarFormasFarmaceuticas();
				$opcionesSeleccion2 = "";
				foreach ($colFormasFarmaceuticas as $formasFticas){
					if(trim($formasFticas->codigo) == trim($formaFarmaceuticaArticulo)){
						$opcionesSeleccion2 .= "<option value='".$formasFticas->codigo."' selected>$formasFticas->descripcion</option>";
					}
				}
				crearCampo("6","wfftica$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."6"],array("style"=>"width:120","class"=>"seleccion","disabled"=>""),"$opcionesSeleccion2");
				echo "<input type='hidden' name='wffticaori$articulo->tipoProtocolo$contArticulos' id='wffticaori$articulo->tipoProtocolo$contArticulos' value='$articulo->formaFarmaceutica' />";

				
			}
			else
			{
				if($detalleDosisPurga=="")
				{
					echo "&nbsp;".$dosisDelArticulo." ";
				}
				else
				{
					echo "&nbsp;".$dosisDelArticulo." <img src='../../images/medical/root/info.png' alt='' border='0' align='right' width='17px'>";
				}
				

				foreach ($colUnidades as $unidad){
					if($unidad->codigo == $unidadArticulo){
						echo $unidad->descripcion;
					}
				}
				echo " (S)";
			}
			
			echo "</td>";

			//NPT
			$esNPT = "off";
			if(esArticuloNutricion( $conex, $wcenmez, $articulo->consultarCodigoArticulo() ) == true)
			{
				$esNPT = "on";
			}
			
			//Unidad de manejo
			if($articulo->permiteModificar){
				echo "<INPUT TYPE='hidden' name='wmodificado$articulo->tipoProtocolo$contArticulos' id='wmodificado$articulo->tipoProtocolo$contArticulos' value='N'>";
			}
			echo "<INPUT TYPE='hidden' NAME='whcmanejo$articulo->tipoProtocolo$contArticulos' id='whcmanejo$articulo->tipoProtocolo$contArticulos' value='$articulo->maximoUnidadManejo'>";
			echo "<INPUT TYPE='hidden' NAME='whvence$articulo->tipoProtocolo$contArticulos' id='whvence$articulo->tipoProtocolo$contArticulos' value='$articulo->vencimiento'>";
			echo "<INPUT TYPE='hidden' NAME='whdiasvence$articulo->tipoProtocolo$contArticulos' id='whdiasvence$articulo->tipoProtocolo$contArticulos' value='$articulo->diasVencimiento'>";
			echo "<INPUT TYPE='hidden' NAME='whdispensable$articulo->tipoProtocolo$contArticulos' id='whdispensable$articulo->tipoProtocolo$contArticulos' value='$articulo->esDispensable'>";
			echo "<INPUT TYPE='hidden' NAME='whduplicable$articulo->tipoProtocolo$contArticulos' id='whduplicable$articulo->tipoProtocolo$contArticulos' value='$articulo->esDuplicable'>";
			echo "<INPUT TYPE='hidden' name='wfftica$articulo->tipoProtocolo$contArticulos' id='wfftica$articulo->tipoProtocolo$contArticulos' value='$articulo->formaFarmaceutica'>";
			echo "<INPUT TYPE='hidden' name='wcundmanejo$articulo->tipoProtocolo$contArticulos' id='wcundmanejo$articulo->tipoProtocolo$contArticulos' value='$articulo->unidadManejo'>";
			echo "<INPUT TYPE='hidden' name='widoriginal$articulo->tipoProtocolo$contArticulos' id='widoriginal$articulo->tipoProtocolo$contArticulos' value='$articulo->idOriginal'>";
			//Indica si el articulo está pendiente de leer por la enfermera
			echo "<INPUT TYPE='hidden' name='wpendiente$articulo->tipoProtocolo$contArticulos' id='wpendiente$articulo->tipoProtocolo$contArticulos' value='".$articulo->pendiente_leer."'>";
			echo "<INPUT TYPE='hidden' name='wesantibiotico$articulo->tipoProtocolo$contArticulos' id='wesantibiotico$articulo->tipoProtocolo$contArticulos' value='".($articulo->esAntibiotico ? 'on': 'off')."'>";
			echo "<INPUT TYPE='hidden' name='wesnpt$articulo->tipoProtocolo$contArticulos' id='wesnpt$articulo->tipoProtocolo$contArticulos' value='".$esNPT."'>";
			
			echo "<INPUT TYPE='hidden' name='wtieneCTC$articulo->tipoProtocolo$contArticulos' id='wtieneCTC$articulo->tipoProtocolo$contArticulos' value='".(artTieneCTC( $conex, $wbasedato, $articulo->historia, $articulo->ingreso, $articulo->consultarCodigoArticulo(), $articulo->idOriginal ) ? 'on': 'off')."'>";
			echo "<INPUT TYPE='hidden' name='wespediatrico$articulo->tipoProtocolo$contArticulos' id='wespediatrico$articulo->tipoProtocolo$contArticulos' value='".( $articulo->esPediatrico ? 'on' : 'off' )."'>";
			echo "<INPUT TYPE='hidden' name='wconmed1$articulo->tipoProtocolo$contArticulos' id='wconmed1$articulo->tipoProtocolo$contArticulos' value='".$articulo->conInsumo1."'>";
			echo "<INPUT TYPE='hidden' name='wconmed2$articulo->tipoProtocolo$contArticulos' id='wconmed2$articulo->tipoProtocolo$contArticulos' value='".$articulo->conInsumo2."'>";
			echo "<INPUT TYPE='hidden' name='wporprotocolo$articulo->tipoProtocolo$contArticulos' id='wporprotocolo$articulo->tipoProtocolo$contArticulos' value='".( $articulo->porProtocolo ? 'on' : 'off' )."'>";
			
			//Campo que indica si es requerido para que el director médico lo autorice
			echo "<INPUT TYPE='hidden' name='wdrautorizado$articulo->tipoProtocolo$contArticulos' id='wdrautorizado$articulo->tipoProtocolo$contArticulos' value='".( $articulo->autorizadoPorDirector ? 'on' : 'off' )."'>";
			
			//Campo de justificacion para autorizar
			echo "<INPUT TYPE='hidden' name='wjusparaautorizar$articulo->tipoProtocolo$contArticulos' id='wjusparaautorizar$articulo->tipoProtocolo$contArticulos' value='".( $articulo->jusParaAutorizar ? 'on' : 'off' )."'>";
			
			//Busco la última aplicación del articulo y cuanto tiempo de acuerdo a la frecuencia
			//Este cambio se hace para saber a partir de que momento se puede cambiar la fecha y hora de inicio en caso de tener ya una aplicación
			$unixUltimaAplicacion = $articulo->consultarUltimaAplicacion();
			$unixUltimaAplicacion = $unixUltimaAplicacion['unix']*1000+( $articulo->objPeriocidad->equivalencia-2 )*3600*1000;
			echo "<INPUT TYPE='hidden' name='wtimeultimaaplicacion$articulo->tipoProtocolo$contArticulos' id='wtimeultimaaplicacion$articulo->tipoProtocolo$contArticulos' value='".$unixUltimaAplicacion."'>";
			
			$familiasATC = $articulo->consultarFamiliaATC( $conex, $wbasedato );
			
			if( count($familiasATC) > 0 ){
				
				$atcs = "";
				foreach( $familiasATC as $key => $value ){
					$atcs .= " data-atc-".$value['codigo']."='".$value['descripcion']."'";
				}
				
				echo "<INPUT TYPE='hidden' name='watc$articulo->tipoProtocolo$contArticulos' id='watc$articulo->tipoProtocolo$contArticulos' $atcs value='".$articulo->codigoArticulo."'>";
			}
			
			
			$conCTC = false;
			//Medicamentos no pos
			if( !$articulo->esPos ){
				
				$conCTC = artTieneCTC( $conex, $wbasedato, $articulo->historia, $articulo->ingreso, $articulo->consultarCodigoArticulo(), $articulo->idOriginal );
				
				global $wentidades_confirmanCTC; //parametro root_000051
				
				// $responsableEmpresa = explode("-",$paciente->numeroIdentificacionResponsable); //responsable
				
				$responsableEmpresa = consultarNitResponsable($wemp_pmla,$paciente->numeroIdentificacionResponsable);
				
				$responsableEmpresasConfirman = explode(",",$wentidades_confirmanCTC);
				
				$responsableConCtcNoObligatorio = false;
				for($b=0;$b < count($responsableEmpresasConfirman);$b++)
				{
					if($responsableEmpresa == $responsableEmpresasConfirman[$b])
					{
						$responsableConCtcNoObligatorio = true;
						break;
					}
				}
				
				//Medicamento no tiene CTC
				// if(!$conCTC)
				if(!$conCTC && $responsableConCtcNoObligatorio == false)
				{
					// $pedirCTC = pedirCTCArticulosGrabados( $conex, $wbasedato, $articulo->historia, $articulo->ingreso, $articulo->consultarCodigoArticulo(),$usuario->codigo);
					$pedirCTC = pedirCTCArticulosGrabados( $conex, $wbasedato, $articulo->historia, $articulo->ingreso, $articulo->consultarCodigoArticulo(),$usuario->codigo, $articulo->idOriginal);
					//Debe pedir CTC al usuario actual
					if($pedirCTC)
					{
						if( strpos( $strPendientesCTC, $articulo->consultarCodigoArticulo() ) === false ){
							$strPendientesCTC .= $articulo->consultarCodigoArticulo().','.$articulo->tipoProtocolo.','.$contArticulos.','.($contFamilia-1).";";
						}
					}
				}
			}
			
			//Periodicidad
			$equivalenciaPeriodicidad = 0;
			echo "<td $eventosQuitarTooltip>";
			if($esEditable){
				if( !$articulo->esInsulina ){
					$opcionesSeleccion = "<option value=''>Seleccione</option>";
					foreach ($colPeriodicidades as $periodicidad){
						if($periodicidad->codigo == $articulo->periodicidad){
							$opcionesSeleccion .= "<option value='".$periodicidad->codigo."' selected>$periodicidad->descripcion</option>";
							$equivalenciaPeriodicidad = $periodicidad->equivalencia;
						}
						elseif( $periodicidad->esTipoCorriente ) {
							$opcionesSeleccion .= "<option value='".$periodicidad->codigo."'>$periodicidad->descripcion</option>";
						}
					}
				}
				else{
					$opcionesSeleccion = "<option value='".$articulo->objPeriocidad->codigo."' selected>".$articulo->objPeriocidad->descripcion."</option>";
				}

				$esMedAgrupado = consultarMedicamentosRelacionadosProcAgrup($articulo->historia, $articulo->ingreso, $articulo->consultarCodigoArticulo(), $articulo->idOriginal);
				
				if($esMedAgrupado == true)
				{
					crearCampo("6","wperiod$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."7"],array("class"=>"seleccion","disabled"=>"disabled","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos', this );"),"$opcionesSeleccion");
				}
				else
				{
					crearCampo("6","wperiod$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."7"],array("class"=>"seleccion","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos', this );"),"$opcionesSeleccion");	
				}
					
				//crearCampo("6","wperiod$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."7"],array("class"=>"seleccion","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos', this );"),"$opcionesSeleccion");
				echo "<input type='hidden' name='wperiodori$articulo->tipoProtocolo$contArticulos' id='wperiodori$articulo->tipoProtocolo$contArticulos' value='$articulo->periodicidad' />";
				
			} else {
				if( !$articulo->esInsulina ){
					foreach ($colPeriodicidades as $periodicidad){
						if($periodicidad->codigo == $articulo->periodicidad){
							echo $periodicidad->descripcion;
						}
					}
				}
				else{
					//objPeriocidad es una propiedad agregado en el cilco de impresion del articulo
					echo $articulo->objPeriocidad->descripcion;
				}
			}
			echo "<input type='hidden' id='wequdosis$articulo->tipoProtocolo$contArticulos' value='$equivalenciaPeriodicidad'>";
			echo "</td>";
			
			$viasArticulo = buscarViasArticulo($conex, $wbasedato, $articulo->codigoArticulo);
			//Via administracion
			echo "<td $eventosQuitarTooltip>";
			if($esEditable){
				$opcionesSeleccion = "";
				foreach ($viasArticulo as $via){
					if( !$articulo->esInsulina ){
						if($via['Viacod'] == $articulo->via){
							$opcionesSeleccion .= "<option value='".$via['Viacod']."' selected>".$via['Viades']."</option>";
						} else {
							$opcionesSeleccion .= "<option value='".$via['Viacod']."'>".$via['Viades']."</option>";
						}
					}
					else{
						if($via['Viacod'] == $articulo->via){
							$opcionesSeleccion = "<option value='".$via['Viacod']."' selected>".$via['Viades']."</option>";
						}
					}
				}

				$esMedAgrupado = consultarMedicamentosRelacionadosProcAgrup($articulo->historia, $articulo->ingreso, $articulo->consultarCodigoArticulo(), $articulo->idOriginal);
				
				if($esMedAgrupado == true)
				{
					crearCampo("6","wviadmon$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."8"],array("class"=>"seleccion","disabled"=>"disabled","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');"),"$opcionesSeleccion");
				}
				else
				{
					crearCampo("6","wviadmon$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."8"],array("class"=>"seleccion","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');"),"$opcionesSeleccion");
				}
				
				//crearCampo("6","wviadmon$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."8"],array("class"=>"seleccion","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');"),"$opcionesSeleccion");
				
			}else{
				foreach ($colVias as $via){
					if($via->codigo == $articulo->via){
						echo $via->descripcion;
					}
				}
			}
			echo "</td>";
				
			//Fecha y hora inicio
			echo "<td $eventosQuitarTooltip>"; 
			if($esEditable){
				echo "<INPUT TYPE='hidden' NAME='whfinicio$articulo->tipoProtocolo$contArticulos' id='whfinicio$articulo->tipoProtocolo$contArticulos' SIZE=22 readonly class='campo2' value='$articulo->fechaInicioAdministracion a las:$articulo->horaInicioAdministracion'>";

				echo "<INPUT TYPE='text' NAME='wfinicio$articulo->tipoProtocolo$contArticulos' id='wfinicio$articulo->tipoProtocolo$contArticulos' SIZE=25 readonly class='campo2' value='$articulo->fechaInicioAdministracion a las:$articulo->horaInicioAdministracion' onChange='marcarCambio(\"$articulo->tipoProtocolo\",\"$contArticulos\");'>";
				crearCampo("3","btnFecha$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."9"],array("onClick"=>"calendario($contArticulos,'$articulo->tipoProtocolo');"),"*");
				echo "<input type='hidden' name='wfinicioori$articulo->tipoProtocolo$contArticulos' id='wfinicioori$articulo->tipoProtocolo$contArticulos' value='$articulo->fechaInicioAdministracion a las:$articulo->horaInicioAdministracion' />";
				//				echo "<input type='button' id='btnFecha$articulo->tipoProtocolo$contArticulos' onclick='calendario($contArticulos,\"$articulo->tipoProtocolo\");' value='*'>";
			}else{
				echo "$articulo->fechaInicioAdministracion a las:$articulo->horaInicioAdministracion";
			}
			echo "</td>";
			
			$permiteDma = false;	//Verifica si permite Dma por condición
			$permiteDtt = false;	//Verifica si permite Dtt por condición
			//Condicion de suministro
			echo "<td onMouseOver='quitarTooltip( this )' onMouseOut='reestablecerTooltip( this );'>";
			if($esEditable){
				
				if( !$articulo->esInsulina ){
					$opcionesSeleccion = "<option value=''>Seleccione</option>";
				}
				else{
					if( trim( $articulo->condicionSuministro ) != '' ){
						$opcionesSeleccion = "<option value='' style='display:none' disabled>Seleccione</option>";
					}
					else{
						$opcionesSeleccion = "<option value=''>Seleccione</option>";
					}
				}
				
				foreach ($colCondicionesSuministro as $condicion){
					if( !$articulo->esInsulina ){
						if($condicion->codigo == $articulo->condicionSuministro){
							$opcionesSeleccion .= "<option value='".$condicion->codigo."' selected>$condicion->descripcion</option>";
							$permiteDma = $condicion->permiteDma;
							$permiteDtt = $condicion->permiteDtt;
						}
						else {
							$opcionesSeleccion .= "<option value='".$condicion->codigo."'>$condicion->descripcion</option>";
						}
					}
					else{
						if($condicion->codigo == $articulo->condicionSuministro){
							$opcionesSeleccion .= "<option value='".$condicion->codigo."' selected>$condicion->descripcion</option>";
							$permiteDma = false;
							$permiteDtt = false;
						}
						else {
							$opcionesSeleccion .= "<option value='".$condicion->codigo."' style='display:none' disabled>$condicion->descripcion</option>";
						}
					}
				}

				$esMedAgrupado = consultarMedicamentosRelacionadosProcAgrup($articulo->historia, $articulo->ingreso, $articulo->consultarCodigoArticulo(), $articulo->idOriginal);
				
				if($esMedAgrupado == true)
				{
					crearCampo("6","wcondicion$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."10"],array("class"=>"seleccion","disabled"=>"disabled","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos', this );"),"$opcionesSeleccion");
				}
				else
				{
					crearCampo("6","wcondicion$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."10"],array("class"=>"seleccion","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos', this );"),"$opcionesSeleccion");
				}

				//  crearCampo("6","wcondicion$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."10"],array("class"=>"seleccion","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos', this );"),"$opcionesSeleccion");

			}
			else{
				foreach ($colCondicionesSuministro as $condicion){
					if($condicion->codigo == $articulo->condicionSuministro){
						echo $condicion->descripcion;
					}
				}
			}
			echo "&nbsp;</td>";

			//Confirmacion
			echo "<td $eventosQuitarTooltip>";
			if($esEditable){
				if($articulo->origen == 'CM'){
					if($articulo->estaConfirmado == 'on'){
						crearCampo("5","wchkconf$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."11"],array("checked"=>"","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');"),"");
						//						echo "<input type='checkbox' name='wchkconf$articulo->tipoProtocolo$contArticulos' id='wchkconf$articulo->tipoProtocolo$contArticulos' alt='Confirmar preparacion' checked onChange='marcarCambio(\"$articulo->tipoProtocolo\",\"$contArticulos\");'>";
					}
					else{
						crearCampo("5","wchkconf$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."11"],array("unchecked"=>"","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');"),"");
						//						echo "<input type='checkbox' name='wchkconf$articulo->tipoProtocolo$contArticulos' id='wchkconf$articulo->tipoProtocolo$contArticulos' alt='Confirmar preparacion' onChange='marcarCambio(\"$articulo->tipoProtocolo\",\"$contArticulos\");'>";
					}
				}
				else{
					crearCampo("5","wchkconf$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."11"],array("unchecked"=>"","disabled"=>"","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');"),"");
					//					echo "<input type='checkbox' name='wchkconf$articulo->tipoProtocolo$contArticulos' alt='Confirmar preparacion' disabled onChange='marcarCambio(\"$articulo->tipoProtocolo\",\"$contArticulos\");'>";
				}
			}else{
				if($articulo->estaConfirmado == 'on'){
					echo "Si";
				}else{
					echo "No";
				}
			}
			echo "</td>";
			
			//Dosis Adaptada
			echo "<td $eventosQuitarTooltip>";
			if($esEditable){
					$daReadOnly = $articulo->presentacionPermiteDA === true ? "": "disabled";
					$daReadOnly = $articulo->esInsulina ? "disabled" : $daReadOnly;
					if($articulo->dosisAdaptada == 'on'){
						crearCampo("5","wchkDA$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."23"],array("$daReadOnly"=>"","checked"=>"","class"=>"msg_tooltip_DA","title"=>"Dosis adaptada para preparar en central de mezclas","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');","onClick"=>"validarHoraInicioPorDA(this,'$articulo->tipoProtocolo','$contArticulos')"),"");
						//						echo "<input type='checkbox' name='wchkconf$articulo->tipoProtocolo$contArticulos' id='wchkconf$articulo->tipoProtocolo$contArticulos' alt='Confirmar preparacion' checked onChange='marcarCambio(\"$articulo->tipoProtocolo\",\"$contArticulos\");'>";
					} else {
						crearCampo("5","wchkDA$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."23"],array("$daReadOnly"=>"","unchecked"=>"","class"=>"msg_tooltip_DA","title"=>"Dosis adaptada para preparar en central de mezclas","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');","onClick"=>"validarHoraInicioPorDA(this,'$articulo->tipoProtocolo','$contArticulos')"),"");
						//						echo "<input type='checkbox' name='wchkconf$articulo->tipoProtocolo$contArticulos' id='wchkconf$articulo->tipoProtocolo$contArticulos' alt='Confirmar preparacion' onChange='marcarCambio(\"$articulo->tipoProtocolo\",\"$contArticulos\");'>";
					}				
			}else{
				if($articulo->dosisAdaptada == 'on'){
					echo "Si";
				}else{
					echo "No";
				}
			}
			echo "</td>";
			
			//NE
			echo "<td $eventosQuitarTooltip>";			
			if($esEditable){
					$ReadOnlyNE = $articulo->presentacionPermiteNE === true ? "": "disabled";				
					$ReadOnlyNE = $articulo->esInsulina ? "disabled": $ReadOnlyNE;
					if($articulo->noEsteril == 'on'){
						crearCampo("5","wchkNE$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."23"],array("$ReadOnlyNE"=>"","checked"=>"","class"=>"msg_tooltip_NE","title"=>"Articulo No Esteril","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');","onClick"=>"validarHoraInicioPorDA(this,'$articulo->tipoProtocolo','$contArticulos')"),"");
						//						echo "<input type='checkbox' name='wchkconf$articulo->tipoProtocolo$contArticulos' id='wchkconf$articulo->tipoProtocolo$contArticulos' alt='Confirmar preparacion' checked onChange='marcarCambio(\"$articulo->tipoProtocolo\",\"$contArticulos\");'>";
					} else {
						crearCampo("5","wchkNE$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."23"],array("$ReadOnlyNE"=>"","unchecked"=>"","class"=>"msg_tooltip_NE","title"=>"Articulo No Esteril","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');","onClick"=>"validarHoraInicioPorDA(this,'$articulo->tipoProtocolo','$contArticulos')"),"");
						//						echo "<input type='checkbox' name='wchkconf$articulo->tipoProtocolo$contArticulos' id='wchkconf$articulo->tipoProtocolo$contArticulos' alt='Confirmar preparacion' onChange='marcarCambio(\"$articulo->tipoProtocolo\",\"$contArticulos\");'>";
					}				
			}else{
				if($articulo->noEsteril == 'on'){
					echo "Si";
				}else{
					echo "No";
				}
			}
			echo "</td>";
			
			
			echo "<td>";
			if($esEditable){
				if( $articulo->esAntibiotico ){
					$chkTratamiento = 'disabled';
					$chkProfilaxis = 'disabled';
					if( $articulo->tratamiento ){
						$chkTratamiento = 'checked';
					}
					if( $articulo->profilaxis ){
						$chkProfilaxis = 'checked';
					}
					
					$chkPediatrico = '';
					if( $articulo->esPediatrico ){
						$chkPediatrico = 'checked';
					}
					echo "<input type='radio' name='wfiltroantibiotico$articulo->tipoProtocolo$contArticulos' id='wprofilaxis$articulo->tipoProtocolo$contArticulos' $chkProfilaxis><label>Profilaxis</label><br>";
					echo "<input type='radio' name='wfiltroantibiotico$articulo->tipoProtocolo$contArticulos' id='wtratamiento$articulo->tipoProtocolo$contArticulos' $chkTratamiento><label>Tratamiento</label>";
					
					if( $articulo->esAntibioticoCompuesto ){
						echo "<input type='checkbox' disabled $chkPediatrico><label>Pediatrico?</label>";
					}
					else{
						echo "<input type='checkbox' disabled $chkPediatrico style='display:none'><label style='display:none'>Pediatrico?</label>";
					}
				}
				else{
					echo "<input type='radio' name='wfiltroantibiotico$articulo->tipoProtocolo$contArticulos' id='wprofilaxis$articulo->tipoProtocolo$contArticulos' style='display:none'><label style='display:none'>Profilaxis</label><br>";
					echo "<input type='radio' name='wfiltroantibiotico$articulo->tipoProtocolo$contArticulos' id='wtratamiento$articulo->tipoProtocolo$contArticulos' style='display:none'><label style='display:none'>Tratamiento</label>";
				}
			}
			else{
				if( $articulo->esAntibiotico ){
					if( $articulo->tratamiento ){
						echo "Profilaxis";
					}
					else{
						echo "Tratamiento";
					}
				}
			}
			echo "</td>";

			$articulo->diasTratamiento = trim( $articulo->diasTratamiento );
			//Dias tratamiento, debe mostrarse en un alt la fecha de terminación y los dias restantes
			if($articulo->diasTratamiento != ''){
				$vecFechaKardex = explode("-",$wfecha);

				$diasFaltantes = intval($articulo->diasTratamiento) - diasDiferenciaFechas($wfecha,$articulo->fechaInicioAdministracion);
				$fechaFinal = date("Y-m-d", mktime(0,0,0,$vecFechaKardex[1],$vecFechaKardex[2],(int)$vecFechaKardex[0]) + ($diasFaltantes*60*60*24));
			}
			else {
				$diasFaltantes = 0;
				$fechaFinal = "-";
			}

			echo "<td $eventosQuitarTooltip>";
			if($esEditable){
				if( empty( $articulo->dosisMaxima ) ){
					//Verifica si permite Dtt por condición
					$valDttxCon = !$permiteDtt ? 'readOnly': '';	
					crearCampo("1","wdiastto$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."12"],array("size"=>"3","maxlength"=>"3","class"=>"campo2","onKeyPress"=>"return validarEntradaEntera(event);","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');","onKeyUp"=>"inhabilitarDosisMaxima( this,'$articulo->tipoProtocolo', $contArticulos );", "$valDttxCon"=>""),"$articulo->diasTratamiento");
				}
				else{
					crearCampo("1","wdiastto$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."12"],array("size"=>"3","maxlength"=>"3","class"=>"campo2","onKeyPress"=>"return validarEntradaEntera(event);","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');","readOnly"=>"","onKeyUp"=>"inhabilitarDosisMaxima( this,'$articulo->tipoProtocolo', $contArticulos );"),"$articulo->diasTratamiento");
				}

				if($articulo->diasTratamiento != ""){
					if($diasFaltantes < 0){
						echo "<img src='../../images/medical/root/inactivo.gif' alt='Cumplido'/>";
					}
					else{
						echo "<img src='../../images/medical/root/activo.gif' alt='Hasta: $fechaFinal - dias restantes: $diasFaltantes'/>";
					}
				}
			}else{
				echo $articulo->diasTratamiento;
			}
			echo "&nbsp;</td>";

			//Dosis máximas
			echo "<td $eventosQuitarTooltip>";
			if($esEditable){
				$permiteDma = false;	//Verifica si permite Dma por condición
				$valDttxCon = !$permiteDtt ? 'readOnly': '';	
				if( empty( $articulo->diasTratamiento ) ){
					crearCampo("1","wdosmax$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."13"],array("size"=>"6","maxlength"=>"6","class"=>"campo2","onKeyPress"=>"return validarEntradaEntera(event);","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');","onKeyUp"=>"inhabilitarDiasTratamiento( this,'$articulo->tipoProtocolo', $contArticulos);","$valDttxCon"=>""),"$articulo->dosisMaxima");
				}
				else{
					crearCampo("1","wdosmax$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."13"],array("size"=>"6","maxlength"=>"6","class"=>"campo2","onKeyPress"=>"return validarEntradaEntera(event);","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');","readOnly"=>"","onKeyUp"=>"inhabilitarDiasTratamiento( this,'$articulo->tipoProtocolo', $contArticulos);"),"$articulo->dosisMaxima");
				}
			}
			else{
				echo $articulo->dosisMaxima;
			}
			echo "&nbsp;</td>";

			//Observaciones
			echo "<td $eventosQuitarTooltip>";
			echo "<table>";
			echo "<tr>";
				echo "<td>";
					echo "<div style='overflow:auto;width:270px;height:70px;background:#fff;border:1px #999 solid;font-size:9pt;text-align:left;'>";
					echo nl2br( $articulo->observaciones );
					echo "</div>";
				echo "</td>";
			echo "<td>";
			
			$reaOnlyObs = "";
			if($esEditable){
				$reaOnlyObs = $articulo->esInsulina ? "readonly": "";
				crearCampo("2","wtxtobsadd$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."14"],array("$reaOnlyObs"=>"","cols"=>"30","rows"=>"2","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');"),"");
			}
			else {
				crearCampo("2","wtxtobsadd$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."14"],array("cols"=>"30","rows"=>"2","readonly"=>""),"");
			}
			// ~ENT_COMPAT en la función htmlspecialchars indica que solo convertíra las comillas simples en html
			echo "<input type='hidden' name='wtxtobsori$articulo->tipoProtocolo$contArticulos' id='wtxtobsori$articulo->tipoProtocolo$contArticulos' value='".htmlspecialchars( $articulo->observaciones, ~ENT_COMPAT )."' />";
			echo "</table>";
			echo "</td>";

			/*********************************************************
			 * 	GRAFICA DE LOS HORARIOS DE SUMINISTRO DE MEDICAMENTOS.
			 *
			 *
			 * 1.  Si la fecha de inicio es menor o igual a la de consulta del kardex se muestra la info
			 * 2.  Si se encuentra suspendido no se muestra la grafica
			 *********************************************************/
			//Grafica de los horarios ... 24 horas del dia.  Debe convertirse a horas cada periodicidad
			foreach ($colPeriodicidades as $periodicidad){
				if($periodicidad->codigo == $articulo->periodicidad){
					$horasPeriodicidad = intval($periodicidad->equivalencia);
					break;
				}
			}
			

			/**********************************************************************************************************************************************************
			 * Diciembre 15 de 2011
			 *
			 * Si falta un 80% o menos de los días de tratamiento, sale un mensaje
			 * diciendo cuanto falta para terminar el medicamento por dias de tratamiento
			 **********************************************************************************************************************************************************/
			if( $articulo->diasTratamiento != '' && $articulo->diasTratamiento > 0 && !$paciente->enUrgencias ){
				if($esEditable){
					//Calculo total de tiempo transcurrido desde la fecha de inicio del medicamento
					//hasta el actual
					$tiempoTranscurrido = intval( ( strtotime( date( "Y-m-d" )." 00:00:00" ) - strtotime( $articulo->fechaInicioAdministracion." 00:00:00" ) )/(24*3600) )+1;

					if( $tiempoTranscurrido >= intval( intval($articulo->diasTratamiento)*$topePorcentualCtc/100 ) ){
						// mensajeEmergente( "El articulo ".trim($articulo->codigoArticulo)." le faltan ".intval( intval( intval($articulo->diasTratamiento) ) - $tiempoTranscurrido )." día(s) más tratamiento ");
						$msg = "El articulo ".trim($articulo->codigoArticulo)." le faltan ".intval( intval( intval($articulo->diasTratamiento) ) - $tiempoTranscurrido )." día(s) más tratamiento ";
						echo "<script>";
						echo "alertsIniciales[alertsIniciales.length] = '$msg';";
						echo "</script>";
					}
				}
			}
			/**********************************************************************************************************************************************************/
			
			//Esta se deja como terminación del aritculo en caso de que no tenga dosis maxima
			$fecHorPorDosis = time()+48*3600;
			
			/**********************************************************************************************************************************************************
			 * Junio 04 de 2014
			 **********************************************************************************************************************************************************/
			//Se saca mensaje si se va a terminar la dosis maxima
			//No se hace con días de tto por que los días de tto se convierten a dosis máxima internamente por el programa
			if( $articulo->dosisMaxima > 0 && !$paciente->enUrgencias ){
				if( !esArticuloGenerico( $conex, $wbasedato, $wcenmez, $articulo->consultarCodigoArticulo() ) ){	//Si no es articulo genérico
				
					$nombreAlterno = $articulo->codigoArticulo;
					$mostrarMensajeAlertaDmax = mostrarMensajeAlertaDmax( $conex, $wbasedato, $paciente->historiaClinica, $paciente->ingresoHistoriaClinica, $articulo->consultarCodigoArticulo(), $articulo->idOriginal, $nombreAlterno );
					
					if( $mostrarMensajeAlertaDmax ){
						
						//Se debe buscar cuantas dosis se han aplicado hasta el momento y cuantas faltas
						//Esto para poder saber efectivamente cuando termina el medicamento
						$cantidadAplicada = 0;
						$cantidadAplicaciones = cantidadAplicadoPorArticulo( $conex, $wbasedato, $paciente->historiaClinica, $paciente->ingresoHistoriaClinica, $articulo->consultarCodigoArticulo(), $articulo->idOriginal, $cantidadAplicada, $articulo->fechaInicioAdministracion, $articulo->horaInicioAdministracion );

						if( $cantidadAplicaciones < $articulo->dosisMaxima ){
							//Si no se ha terminado de aplicar el medicamento por dosis máxima se busca cuando termina el medicamento
							
							//Calculo cuanta es la diferencia Entre lo que debería estar aplicada a la actualidad
							//Para ello calculo primero cuanta es la cantidad que puede ser aplicada hasta la actualidad sin tener en cuenta las últimas 4 horas 
							//ya que en este tiempo puede ser aplicado
							$cantidadMaximaAplicadaActual = floor( ( time() - strtotime( $articulo->fechaInicioAdministracion." ".$articulo->horaInicioAdministracion ) )/($horasPeriodicidad*3600) )+1;
							
							//las dosis faltantes son por tanto es la diferencia de lo que debería estar aplicado con la cantidad de aplicaciones que hay hasta el momento
							$dosisMaximasFaltantes = 0;
							$dosisMaximasFaltantes = $cantidadMaximaAplicadaActual - $cantidadAplicaciones;
							
							//Las dosis máximas nunca son menores a 0
							if( $dosisMaximasFaltantes < 0 )
								$dosisMaximasFaltantes = 0;
						
							//Calculo la fecha anterior en que termina el kardex
							$fecHorPorDosis = strtotime( $articulo->fechaInicioAdministracion." ".$articulo->horaInicioAdministracion ) + $horasPeriodicidad*3600*( $articulo->dosisMaxima-1 + $dosisMaximasFaltantes );
						}
						else{
							//Cómo las dosis aplicadas ya terminaron se busca cuando termíno el medicamento, esto es la última vez que fue aplicado
							//Consulta la última aplicación del medicamento
							$ultimaAplicacion = ultimaAplicacion( $conex, $wbasedato, $paciente->historiaClinica, $paciente->ingresoHistoriaClinica, $articulo->consultarCodigoArticulo(), $articulo->idOriginal );
							$fecHorPorDosis = $ultimaAplicacion;
						}
						
						// if( time() >= strtotime( date( "Y-m-d", $fecHorPorDosis-24*3600 ) ) ){
						if( time() >= $fecHorPorDosis-24*3600 ){
							// mensajeEmergente("El articulo ".trim($articulo->codigoArticulo)." termina el ".date( "Y-m-d \a \l\a\s H:i:s", $fecHorPorDosis ) );
							if( $articulo->esAntibiotico )
								$msg = "@El <b>ANTIBI&Oacute;TICO</b> ".trim($nombreAlterno)." termina el ".date( "Y-m-d \a \l\a\s H:i:s", $fecHorPorDosis ) ;
							else
								$msg = "El articulo ".trim($nombreAlterno)." termina el ".date( "Y-m-d \a \l\a\s H:i:s", $fecHorPorDosis ) ;
							echo "<script>";
							echo "alertsIniciales[alertsIniciales.length] = '$msg';";
							echo "</script>";
						}
					}
				}
			}
			/**********************************************************************************************************************************************************/
			

			$arrAplicacion = obtenerVectorAplicacionMedicamentos(date("Y-m-d"),$articulo->fechaInicioAdministracion,$articulo->horaInicioAdministracion,$horasPeriodicidad);
			
			$horaArranque = 2;
			$aplicaGraficaSuministro = true;

			$cont1 = 1;
			$cont2 = $horaArranque;   //Desplazamiento desde la hora inicial
			$caracterMarca = "*";
			$claseGrafica = "";

			$articulo->suspendido == 'on' ? $claseGrafica = "suspendido" : $claseGrafica = "fondoVerde";

			while($cont1 <= 24){
				if( $fecHorPorDosis <= strtotime( date( "Y-m-d 00:00:00" ) )+$cont1*3600 ){
					$arrAplicacion[$cont2] = '';
				}
				
				if(isset($arrAplicacion[$cont2]) && $arrAplicacion[$cont2] == $caracterMarca && $aplicaGraficaSuministro){
					echo "<td class='$claseGrafica' align='center' onMouseOver='mostrarTooltip(this, $cont2)'>";
					echo $caracterMarca;
					echo "</td>";
				} else {
					echo "<td onMouseOver='mostrarTooltip(this, $cont2)'>&nbsp;</td>";
				}

				if($cont2 == 24){
					$cont2 = 0;
				}

				$cont1++;
				$cont2++;

				if($cont2 % 2 != 0){
					$cont2++;
				}
				if($cont1 % 2 != 0){
					$cont1++;
				}

				if($cont2 == $horaArranque){
					break;
				}
			}
			echo "</tr>";
			
			$contArticulos++;
		}
	}
	
	if($contArtsFam==0)
	{
		$actFamilia = $contFamilia-1;
		echo "<script> cambiarDisplay('filaTituloFamilia".$tipoProtocolo.$actFamilia."'); cambiarDisplay('trEncabezadoTb".$tipoProtocolo.$actFamilia."');  </script>";
	}
	
	if($contFamilia>1)
	{
		echo "</table>";
		echo "</div>";
		echo "</td></tr>";
		echo "<tr><td colspan='24'>&nbsp;</td></tr>";
		echo "</tbody>";
	}

	echo "</tbody>";
	echo "</table>";
	echo "<p>&nbsp;</p>";
}


//Despliega la lista de articulos de acuerdo a los tipos de protocolos
function vista_desplegarListaArticulosAlta($colDetalle,$cantidadElementos,$tipoProtocolo,$esEditable,$colUnidades,$colPeriodicidades,$colVias,$colCondicionesSuministro,$accionesPestana,$indicePestana){
	global $grupoControl;
	global $wfecha;
	global $topePorcentualCtc;

	global $conex;
	global $wbasedato;
	global $usuario;		//Información de usuario
	
	global $codigoServicioFarmaceutico;
	
	global $regletaFamilia;
	global $contArticulos;
	
	$contArticulos = $contArticulos+1000;
	
	$clase = 'fila1';
	$clasef = 'fila2';
	$mostrarArticulo = false;
	$tipoProtocoloAux = "N";

	$arrEspecialidades = array();
	$especialidades = consultarEspecialidadesUsuarios();
	foreach ($especialidades as $especialidad){
		$arrEspecialidades[$especialidad->codigo] = $especialidad->descripcion;
	}
	
	// switch($tipoProtocolo){
		// case 'N':
			// echo "<input type='HIDDEN' name='elementosKardex' id=elementosKardex value='$cantidadElementos'/>";
			// break;
		// case 'A':
			// echo "<input type='HIDDEN' name='elementosAnalgesia' id=elementosAnalgesia value='$cantidadElementos'/>";
			// break;
		// case 'U':
			// echo "<input type='HIDDEN' name='elementosNutricion' id=elementosNutricion value='$cantidadElementos'/>";
			// break;
		// case 'Q':
			// echo "<input type='HIDDEN' name='elementosQuimioterapia' id=elementosQuimioterapia value='$cantidadElementos'/>";
			// break;
		// default:
			// echo "<input type='HIDDEN' name='elementosKardex' id=elementosKardex value='$cantidadElementos'/>";
			// break;
	// }

	echo "<table align='center' border='0' id='tbDetalleAddImp$tipoProtocolo'>";

	/////////////////////////////////////////
	// Encabezado articulos agregados
	echo "<tr align='center' class='encabezadoTabla' id='trEncabezadoTbAddImp' style='display:none;'>";
	$tipoProtocolo="N";
	echo "<td>Acciones</td>";
	echo "<td>Medicamento<span class='obligatorio'>(*)</span></td>";
	echo "<td style='display:none'>Protocolo</td>";
	echo "<td style='display:none'>No enviar</td>";
	echo "<td>Dosis a aplicar<span class='obligatorio'>(*)</span></td>";
	echo "<td>Frecuencia<span class='obligatorio'>(*)</span></td>";
	echo "<td>Via<span class='obligatorio'>(*)</span></td>";
	echo "<td>Fecha y hora inicio<span class='obligatorio'>(*)</span></td>";
	echo "<td>Cantidad<span class='obligatorio'>(*)</span></td>";
	echo "<td style='display:none'>Condici&oacute;n</td>";
	echo "<td style='display:none'>Cnf.</td>";
	echo "<td style='display:none'>Dias tto.</td>";
	echo "<td style='display:none'>Dosis máx.</td>";
	echo "<td>Observaciones</td>";
	echo "</tr>";
	/////////////////////////////////////////

	echo "<tbody id='detKardexAddImp$tipoProtocolo'>";
	echo "</tbody>";

	echo "</table>";

	
	echo "<table align='center' border='0' id='tbDetalleImp$tipoProtocolo'>";
	echo "<tbody id='detKardexImp$tipoProtocolo'>";

	$aux = $esEditable;

	// Inicio encabezado articulos
	echo "<tr align='center' class='encabezadoTabla' id='trEncabezadoTbImp$tipoProtocolo'>";

	$tipoProtocolo="N";
	if($esEditable){
		echo "<td>Quitar";		
		echo "<INPUT TYPE='hidden' name='waccimp$tipoProtocolo.15' id='waccimp$tipoProtocolo.15' value='".accionesATexto(@$accionesPestana[$indicePestana.".$tipoProtocolo"."15"])."'>";
		echo "<INPUT TYPE='hidden' name='waccimp$tipoProtocolo.2' id='waccimp$tipoProtocolo.2' value='".accionesATexto(@$accionesPestana[$indicePestana.".$tipoProtocolo"."2"])."'>";
		echo "<INPUT TYPE='hidden' name='waccimp$tipoProtocolo.3' id='waccimp$tipoProtocolo.3' value='".accionesATexto(@$accionesPestana[$indicePestana.".$tipoProtocolo"."3"])."'>";
		echo "</td>";
		echo "<td>Imprimir<input type=checkbox onclick='marcar_todos_art_alta()' id='marcarTodosArtAlta' title='Marcar Todos'></td>";
		echo "<td>Medicamento<span class='obligatorio'>(*)</span></td>";
		echo "<td style='display:none'>Protocolo</td>";
		echo "<td style='display:none'>";
		echo "No enviar";
		echo "<INPUT TYPE='hidden' name='waccimp$tipoProtocolo.4' id='waccimp$tipoProtocolo.4' value='".accionesATexto(@$accionesPestana[$indicePestana.".$tipoProtocolo"."4"])."'>";
		echo "</td>";
		echo "<td>";
		echo "Dosis a aplicar<span class='obligatorio'>(*)</span>";
		echo "<INPUT TYPE='hidden' name='waccimp$tipoProtocolo.5' id='waccimp$tipoProtocolo.5' value='".accionesATexto(@$accionesPestana[$indicePestana.".$tipoProtocolo"."5"])."'>";
		echo "</td>";
		echo "<td>";
		echo "Frecuencia<span class='obligatorio'>(*)</span>";
		echo "<INPUT TYPE='hidden' name='waccimp$tipoProtocolo.7' id='waccimp$tipoProtocolo.7' value='".accionesATexto(@$accionesPestana[$indicePestana.".$tipoProtocolo"."7"])."'>";
		echo "</td>";
		echo "<td>";
		echo "Via<span class='obligatorio'>(*)</span>";
		//echo "<INPUT TYPE='hidden' name='waccimp$tipoProtocolo.7' id='waccimp$tipoProtocolo.7' value='".accionesATexto(@$accionesPestana[$indicePestana.".$tipoProtocolo"."7"])."'>";
		echo "</td>";
		echo "<td>";
		echo "Cantidad<span class='obligatorio'>(*)</span>";
		echo "<INPUT TYPE='hidden' name='waccimp$tipoProtocolo.8' id='waccimp$tipoProtocolo.8' value='".accionesATexto(@$accionesPestana[$indicePestana.".$tipoProtocolo"."8"])."'>";
		echo "</td>";
		echo "<td>";
		echo "Fecha y hora inicio<span class='obligatorio'>(*)</span>";
		echo "<INPUT TYPE='hidden' name='waccimp$tipoProtocolo.9' id='waccimp$tipoProtocolo.9' value='".accionesATexto(@$accionesPestana[$indicePestana.".$tipoProtocolo"."9"])."'>";
		echo "</td>";
		echo "<td style='display:none'>";
		echo "Condici&oacute;n";
		echo "<INPUT TYPE='hidden' name='waccimp$tipoProtocolo.10' id='waccimp$tipoProtocolo.10' value='".accionesATexto(@$accionesPestana[$indicePestana.".$tipoProtocolo"."10"])."'>";
		echo "</td>";
		echo "<td style='display:none'>";
		echo "Cnf.";
		echo "<INPUT TYPE='hidden' name='waccimp$tipoProtocolo.11' id='waccimp$tipoProtocolo.11' value='".accionesATexto(@$accionesPestana[$indicePestana.".$tipoProtocolo"."11"])."'>";
		echo "</td>";
		echo "<td style='display:none'>";
		echo "Dias tto.";
		echo "<INPUT TYPE='hidden' name='waccimp$tipoProtocolo.12' id='waccimp$tipoProtocolo.12' value='".accionesATexto(@$accionesPestana[$indicePestana.".$tipoProtocolo"."12"])."'>";
		echo "</td>";
		echo "<td style='display:none'>";
		echo "Dosis máx.</td>";
		echo "<INPUT TYPE='hidden' name='waccimp$tipoProtocolo.13' id='waccimp$tipoProtocolo.13' value='".accionesATexto(@$accionesPestana[$indicePestana.".$tipoProtocolo"."13"])."'>";
		echo "<td>";
		echo "Observaciones";
		echo "<INPUT TYPE='hidden' name='waccimp$tipoProtocolo.14' id='waccimp$tipoProtocolo.14' value='".accionesATexto(@$accionesPestana[$indicePestana.".$tipoProtocolo"."14"])."'>";
		echo "</td>";
		echo "<td>";
		echo "Especialidad";
		echo "<INPUT TYPE='hidden' name='waccimp$tipoProtocolo.16' id='waccimp$tipoProtocolo.16' value='".accionesATexto(@$accionesPestana[$indicePestana.".$tipoProtocolo"."16"])."'>";
		echo "</td>";
	} else {
		echo "<td>Quitar</td>";
		echo "<td>Imprimir<input type=checkbox onclick='marcar_todos_art_alta();' id='marcar_todos_art_alta' title='Marcar Todos'></td>";
		echo "<td width='100px'>Articulo</td>";
		echo "<td style='display:none'>Protocolo</td>";
		echo "<td style='display:none'>No enviar</td>";
		echo "<td>Dosis a aplicar</td>";
		echo "<td>Frecuencia</td>";
		echo "<td>Via</td>";
		echo "<td>Cantidad</td>";
		echo "<td>Fecha y hora inicio</td>";
		echo "<td style='display:none'>Condici&oacute;n</td>";
		echo "<td style='display:none'>Cnf.</td>";
		echo "<td style='display:none'>Dias tto.</td>";
		echo "<td style='display:none'>Dosis máx.</td>";
		echo "<td>Observaciones</td>";
		echo "<td>Especialidad</td>";
	}
	echo "</tr>";
	// Fin encabezado articulos
	
	
	foreach ($colDetalle as $articulo){
		
		$esEditable = $aux;
		$aElminiar = false;
		
		if( $articulo->estadoArticulo != "on" && $articulo->origen == $codigoServicioFarmaceutico ){
			$esEditable = false;
			$aElminiar = true;
		}
		
		//Mirar si esto funciona!
		$articulo->tipoProtocolo = $tipoProtocoloAux;
		
		$mostrarArticulo = true;
		if($mostrarArticulo)
		{
			
			$str_codigo_articulo = explode('-',$articulo->codigoArticulo);
			$codigo_articulo = $str_codigo_articulo[0];
			
			$qfam = "SELECT
						Famnom
					FROM
						{$wbasedato}_000114 a, {$wbasedato}_000115 b
					WHERE
						Relart = '$codigo_articulo'
						AND Relest = 'on'
						AND Relfam = Famcod
						AND Famest = 'on'
					";
		
			$resfam = mysql_query( $qfam, $conex ) or die( mysql_errno()." - Error en el query $qfam - ".mysql_error() );
			$numfam = mysql_num_rows( $resfam );
			$rowfam = mysql_fetch_array($resfam);
			$nombre_familia = $rowfam['Famnom'];		

			$claseEliminar = "";
			if( $aElminiar ){
				$claseEliminar = "class='fondoAlertaEliminar'";
			}
			
			if($articulo->suspendido == 'on'){
				$clase = 'suspendido';
			}else{
				if($clase == 'fila2'){
					$clase = 'fila1';
				} else {
					$clase = 'fila2';
				}

				//Si el articulo es del grupo de control se resalta con color morado
				if($articulo->grupo == $grupoControl){
					$clase = "articuloControl";
				}
			}

			//Informacion adicional del articulo
			$informacion = "<strong>$articulo->codigoArticulo</strong><br>";
			
			$informacion .= "<br><strong>Nombre Comercial: </strong>$articulo->nombreGenerico<br>";

			$informacion .= "<br>$articulo->maximoUnidadManejo ".descripcionMaestroPorCodigo($colUnidades,$articulo->unidadMaximoManejo)." POR ".descripcionMaestroPorCodigo($colUnidades,$articulo->unidadManejo)."</strong><br><br>";

			//Ctc
			if(isset($articulo->cantidadAutorizadaCtc) && !empty($articulo->cantidadAutorizadaCtc)){
				$miniClase = "";
				$diferenciaCtc = intval($articulo->cantidadAutorizadaCtc)-intval($articulo->cantidadUtilizadaCtc);
				$porcentajeUsoCtc = ($articulo->cantidadUtilizadaCtc/$articulo->cantidadAutorizadaCtc)*100;

				$informacion .= "<br><strong>ESTADO DE CTC</strong><br>";
				$informacion .= "Autorizado: $articulo->cantidadAutorizadaCtc<br>";
				$informacion .= "Utilizado	: $articulo->cantidadUtilizadaCtc<br>";
				if($diferenciaCtc > 0){
					$miniClase = "fondoVerde";
				} else {
					$miniClase = "fondoRojo";
				}

				//Alerta si se llega al tope
				if($porcentajeUsoCtc >= $topePorcentualCtc){
					$miniClase = "fondoRojo";
					// mensajeEmergente("El articulo ".trim($articulo->codigoArticulo)." está a punto de agotarse o se agotó por CTC.  Utilización: ".intval($porcentajeUsoCtc)."%");
					$msg = "El articulo ".trim($articulo->codigoArticulo)." está a punto de agotarse o se agotó por CTC.  Utilización: ".intval($porcentajeUsoCtc)."%";
					echo "<script>";
					echo "alertsIniciales[alertsIniciales.length] = '$msg';";
					echo "</script>";
				}
				$informacion .= "<span class=$miniClase><strong>DISPONIBLE</strong>: $diferenciaCtc</span><br>";
				$informacion .= "<br>";
			}

			if($articulo->esDispensable == 'on'){
				$informacion .= "-Es dispensable<br>";
			} else {
				$informacion .= "-No es dispensable<br>";
			}

			if($articulo->esDuplicable == 'on'){
				$informacion .= "-Es duplicable<br>";
			} else {
				$informacion .= "-No es duplicable<br>";
			}

			if($articulo->diasTotalesTto > 0){
				$informacion .= "-Dias acumulados: ".$articulo->diasTotalesTto."<br>";
			} else {
				$informacion .= "-Dias acumulados: 0<br>";
			}

			if($articulo->dosisTotalesTto > 0){
				$informacion .= "-Dosis acumuladas: ".$articulo->dosisTotalesTto."<br>";
			} else {
				$informacion .= "-Dosis acumuladas: 0<br>";
			}
			
			echo "<tr id='trFilImp".$contArticulos."' class='".$clase."'>";
			
			if( $esEditable ){
				$eventosQuitarTooltip = " onMouseOver='quitarTooltip( this )' onMouseOut='reestablecerTooltip( this );'";	//Creo los eventos que quitan el tooltip si el kardex es editable
			}

			//Acciones			
			echo "<td align=center $eventosQuitarTooltip>";
			if($esEditable && $articulo->permiteModificar){
				
				$tieneSaldo = tieneSaldo( $conex, $wbasedato, $articulo->historia, $articulo->ingreso, $articulo->consultarCodigoArticulo() );
				
				$usuario->permisosPestanas[ $indicePestana ]['modifica'];
				
				$puedeEliminar = true;
				if( $usuario->permisosPestanas[ $indicePestana ]['modifica'] ){
				
					if( $articulo->codigoCreador != $usuario->codigo ){
						$puedeEliminar = false;
					}
				}
				
				$chkimp = "checked";
				if($articulo->imprimirArticulo!='on')
					$chkimp = "";

				/*crearCampo("5","wchkimp$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."3"], array($chkimp=>"","style"=>"","onChange"=>"marcarImpresion(this,'".$articulo->historia."','".$articulo->ingreso."','$codigo_articulo','$articulo->fechaKardex','$articulo->fechaInicioAdministracion','$articulo->horaInicioAdministracion');"),"");*/
				
				
				// echo "<div id='trFilImp".$examen->numeroDeOrden."' style='display:inline' title='Click para no imprimir este medicamento'><img onClick='quitarFilaAlta(\"trFilImp".$contArticulos."\",\"wchkimp$articulo->tipoProtocolo$contArticulos\");marcarImpresion(\"quitar\",\"".$articulo->historia."\",\"".$articulo->ingreso."\",\"$codigo_articulo\",\"$articulo->fechaKardex\",\"$articulo->fechaInicioAdministracion\",\"$articulo->horaInicioAdministracion\");' src='../../images/medical/root/borrar.png' width='17' height='17' border='0'/> &nbsp;&nbsp; </div>";
				
				//echo "<div id='trFilImp".$examen->numeroDeOrden."' style='display:inline' title='Click para no imprimir este medicamento'><img onClick='quitarArticulo($contArticulos,\"$articulo->tipoProtocolo\",this);' src='../../images/medical/root/borrar.png' width='17' height='17' border='0'/> &nbsp;&nbsp; </div>";
				
				// Si la especialidad del usuario actual es igual a la del médico que grabó el medicamento se permite borrar el medicamento de alta
				//if($arrEspecialidades[$articulo->codigoCreador] == $arrEspecialidades[$usuario->codigo]){
					//Se comenta esta parte del codigo para que no muestre la x de eliminar articulo.
					//crearCampo("4","",@$accionesPestana[$indicePestana.".$tipoProtocolo"."2"],array("onClick"=>"quitarArticulo($contArticulos,'$articulo->tipoProtocolo',this,'imp');"),"<img src='../../images/medical/root/borrar.png' border='0' width='17' height='17' />");
					//}
				
			} else {
				echo "&nbsp;";
			}
					
			echo "<input type='hidden' name='wimp$articulo->tipoProtocolo$contArticulos' id='wimp$articulo->tipoProtocolo$contArticulos' value='$articulo->altaArticulo' />";			
			echo "</td>";
			
			//Imprimir articulo alta.
			echo "<td align=center>";
			echo "<div id='imgImprimir0' style='display:inline'><img width='18' height='18' border='0' src='../../images/medical/hce/icono_imprimir.png'><br>";
			crearCampo("5","wchkimp_alta$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."21"], array($chkimp=>"", "OnClick"=>"imprimirArtAlta('$articulo->historia','$articulo->ingreso', '$articulo->codigoArticulo', '$articulo->tipoProtocolo', '$contArticulos');"),"");
			echo "</td>";
			
			//Articulo
			echo "<td $claseEliminar>";
			echo "<div id='wnmmedimp$articulo->tipoProtocolo$contArticulos' style='display:none;'>$articulo->codigoArticulo</div>";
			echo "<div id='wnmfamimp$articulo->tipoProtocolo$contArticulos'>$nombre_familia</div>";
			echo "</td>";

			//Nombre del protocolo
			echo "<td align=center style='display:none'>";
			if($esEditable){
				echo $articulo->nombreProtocolo;
			}
			echo "</td>";
			
			//No dispensar
			echo "<td align=center $eventosQuitarTooltip  style='display:none'>";
			if($esEditable){
				if($articulo->estadoAdministracion == 'on'){
					crearCampo("5","wchkdispimp$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."4"],array("checked"=>"","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');"),"");
					//					echo "<input type='checkbox' name='wchkdisp$articulo->tipoProtocolo$contArticulos' id='wchkdisp$articulo->tipoProtocolo$contArticulos' alt='No dispensar' checked onChange='marcarCambio(\"$articulo->tipoProtocolo\",\"$contArticulos\");'>";
				} else {
					crearCampo("5","wchkdispimp$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."4"],array("unchecked"=>"","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');"),"");
					//					echo "<input type='checkbox' name='wchkdisp$articulo->tipoProtocolo$contArticulos' id='wchkdisp$articulo->tipoProtocolo$contArticulos' alt='No dispensar' onChange='marcarCambio(\"$articulo->tipoProtocolo\",\"$contArticulos\");'>";
				}
			} else {
				if($articulo->estaConfirmado == 'on'){
					echo "Si";
				} else {
					echo "No";
				}
			}
			echo "</td>";

			//Dosis y unidad de medida
			echo "<td $eventosQuitarTooltip>";
			if($esEditable){
				// 2012-06-27
				// Se adiciona el atributo "readonly" para que este campo siempre sea de solo lectura, que no se pueda modificar
				crearCampo("1","wdosisimp$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."5"],array("size"=>"7","maxlength"=>"7","class"=>"campo2","onKeyPress"=>"return validarEntradaDecimal(event)","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');"),"$articulo->cantidadDosis");
				echo "<input type='hidden' name='wdosisori$articulo->tipoProtocolo$contArticulos' id='wdosisori$articulo->tipoProtocolo$contArticulos' value='$articulo->cantidadDosis' />";
				//				echo "<INPUT TYPE='text' NAME='wdosis$articulo->tipoProtocolo$contArticulos' id='wdosis$articulo->tipoProtocolo$contArticulos' size=7 maxlength=7 onkeypress='return validarEntradaDecimal(event);' class='campo2' value='$articulo->cantidadDosis' onChange='marcarCambio(\"$articulo->tipoProtocolo\",\"$contArticulos\");'>";
				$opcionesSeleccion = "";
				foreach ($colUnidades as $unidad){
					if(trim($unidad->codigo) == trim($articulo->unidadDosis))
						$opcionesSeleccion .= "<option value='".$unidad->codigo."' selected>$unidad->descripcion</option>";
					else
						$opcionesSeleccion .= "<option value='".$unidad->codigo."'>$unidad->descripcion</option>";					
				}
				crearCampo("6","wudosisimp$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."6"],array("style"=>"width:120","class"=>"seleccion","disabled"=>""),"$opcionesSeleccion");
				echo "<input type='hidden' name='wudosisori$articulo->tipoProtocolo$contArticulos' id='wudosisori$articulo->tipoProtocolo$contArticulos' value='$articulo->unidadDosis' />";
				//				echo "<select id='wudosis$articulo->tipoProtocolo$contArticulos' style='width:120' class='seleccion' disabled>";
				//				echo "<option value=''>Seleccione</option>";
				//				foreach ($colUnidades as $unidad){
				//					if(trim($unidad->codigo) == trim($articulo->unidadDosis)){
				//						echo "<option value='".$unidad->codigo."' selected>$unidad->descripcion</option>";
				//					}else{
				//						echo "<option value='".$unidad->codigo."'>$unidad->descripcion</option>";
				//					}
				//				}
				//				echo "</select>";

				$colFormasFarmaceuticas = consultarFormasFarmaceuticas();
				$opcionesSeleccion2 = "";
				foreach ($colFormasFarmaceuticas as $formasFticas){
					if(trim($formasFticas->codigo) == trim($articulo->formaFarmaceutica))
						$opcionesSeleccion2 .= "<option value='".$formasFticas->codigo."' selected>$formasFticas->descripcion</option>";
					else
						$opcionesSeleccion2 .= "<option value='".$formasFticas->codigo."'>$formasFticas->descripcion</option>";
				}
				crearCampo("6","wffticaimp$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."6"],array("style"=>"width:120","class"=>"seleccion","disabled"=>""),"$opcionesSeleccion2");
				echo "<input type='hidden' name='wffticaori$articulo->tipoProtocolo$contArticulos' id='wffticaori$articulo->tipoProtocolo$contArticulos' value='$articulo->formaFarmaceutica' />";
				
			}else{
				echo "&nbsp;".$articulo->cantidadDosis." ";

				foreach ($colUnidades as $unidad){
					if($unidad->codigo == $articulo->unidadDosis){
						echo $unidad->descripcion;
					}
				}
				echo " (S)";
			}
			echo "</td>";

			//Unidad de manejo
			if($articulo->permiteModificar){
				echo "<INPUT TYPE='hidden' name='wmodificadoimp$articulo->tipoProtocolo$contArticulos' id='wmodificadoimp$articulo->tipoProtocolo$contArticulos' value='N'>";
			}
			echo "<INPUT TYPE='hidden' NAME='whcmanejoimp$articulo->tipoProtocolo$contArticulos' id='whcmanejoimp$articulo->tipoProtocolo$contArticulos' value='$articulo->maximoUnidadManejo'>";
			echo "<INPUT TYPE='hidden' NAME='whvenceimp$articulo->tipoProtocolo$contArticulos' id='whvenceimp$articulo->tipoProtocolo$contArticulos' value='$articulo->vencimiento'>";
			echo "<INPUT TYPE='hidden' NAME='whdiasvenceimp$articulo->tipoProtocolo$contArticulos' id='whdiasvenceimp$articulo->tipoProtocolo$contArticulos' value='$articulo->diasVencimiento'>";
			echo "<INPUT TYPE='hidden' NAME='whdispensableimp$articulo->tipoProtocolo$contArticulos' id='whdispensableimp$articulo->tipoProtocolo$contArticulos' value='$articulo->esDispensable'>";
			echo "<INPUT TYPE='hidden' NAME='whduplicableimp$articulo->tipoProtocolo$contArticulos' id='whduplicableimp$articulo->tipoProtocolo$contArticulos' value='$articulo->esDuplicable'>";
			echo "<INPUT TYPE='hidden' name='wffticaimp$articulo->tipoProtocolo$contArticulos' id='wffticaimp$articulo->tipoProtocolo$contArticulos' value='$articulo->formaFarmaceutica'>";
			echo "<INPUT TYPE='hidden' name='wcundmanejoimp$articulo->tipoProtocolo$contArticulos' id='wcundmanejoimp$articulo->tipoProtocolo$contArticulos' value='$articulo->unidadManejo'>";

			//Periodicidad
			$equivalenciaPeriodicidad = 0;
			echo "<td $eventosQuitarTooltip>";
			if($esEditable){
				$opcionesSeleccion = "<option value=''>Seleccione</option>";
				foreach ($colPeriodicidades as $periodicidad){
					if($periodicidad->codigo == $articulo->periodicidad){
						$opcionesSeleccion .= "<option value='".$periodicidad->codigo."' selected>$periodicidad->descripcion</option>";
						$equivalenciaPeriodicidad = $periodicidad->equivalencia;
					} else {
						$opcionesSeleccion .= "<option value='".$periodicidad->codigo."'>$periodicidad->descripcion</option>";
					}
				}
				crearCampo("6","wperiodimp$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."7"],array("class"=>"seleccion","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');"),"$opcionesSeleccion");
				echo "<input type='hidden' name='wperiodori$articulo->tipoProtocolo$contArticulos' id='wperiodori$articulo->tipoProtocolo$contArticulos' value='$articulo->periodicidad' />";
				//				echo "<select name='wperiod$articulo->tipoProtocolo$contArticulos' id='wperiod$articulo->tipoProtocolo$contArticulos' class='seleccion' onChange='marcarCambio(\"$articulo->tipoProtocolo\",\"$contArticulos\");'>";
				//				echo "<option value=''>Seleccione</option>";
				//
				//				foreach ($colPeriodicidades as $periodicidad){
				//					if($periodicidad->codigo == $articulo->periodicidad){
				//						echo "<option value='".$periodicidad->codigo."' selected>$periodicidad->descripcion</option>";
				//						$equivalenciaPeriodicidad = $periodicidad->equivalencia;
				//					}else{
				//						echo "<option value='".$periodicidad->codigo."'>$periodicidad->descripcion</option>";
				//					}
				//				}
				//				echo "</select>";
			} else {
				foreach ($colPeriodicidades as $periodicidad){
					if($periodicidad->codigo == $articulo->periodicidad){
						echo $periodicidad->descripcion;
					}
				}
			}
			echo "<input type='hidden' id='wequdosisimp$articulo->tipoProtocolo$contArticulos' value='$equivalenciaPeriodicidad'>";
			echo "</td>";
			
			//Via
			echo "<td $eventosQuitarTooltip>";
			echo "<input type='hidden' id='wviadmonimp$articulo->tipoProtocolo$contArticulos' value='".$articulo->via."'>";
			echo "<select name='wviadmon$articulo->tipoProtocolo$contArticulos' id='wviadmon$articulo->tipoProtocolo$contArticulos' class='seleccion' disabled>";
			echo "<option value=''>Seleccione</option>";

			foreach ($colVias as $via){
				if($via->codigo == $articulo->via){
					echo "<option value='".$via->codigo."' selected>$via->descripcion</option>";
				}else{
					echo "<option value='".$via->codigo."'>$via->descripcion</option>";
				}
			}
			echo "</select>";

			echo "</td>";
			
			
			//Cantidad ordenada al egreso
			echo "<td $eventosQuitarTooltip>";

			crearCampo("1","wcantaltaimp$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."8"],array("size"=>"14","class"=>"campo2","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');"),"$articulo->cantidadAlta");

			echo "<input type='hidden' id='wviadmonimp$articulo->tipoProtocolo$contArticulos' value='".$articulo->via."'>";
			//				echo "<select name='wviadmon$articulo->tipoProtocolo$contArticulos' id='wviadmon$articulo->tipoProtocolo$contArticulos' class='seleccion' onChange='marcarCambio(\"$articulo->tipoProtocolo\",\"$contArticulos\");'>";
			//				echo "<option value=''>Seleccione</option>";
			//
			//				foreach ($colVias as $via){
			//					if($via->codigo == $articulo->via){
			//						echo "<option value='".$via->codigo."' selected>$via->descripcion</option>";
			//					}else{
			//						echo "<option value='".$via->codigo."'>$via->descripcion</option>";
			//					}
			//				}
			//				echo "</select>";

			echo "</td>";
				
			//Fecha y hora inicio
			echo "<td $eventosQuitarTooltip>";
			if($esEditable){
				echo "<INPUT TYPE='hidden' NAME='whfinicioimp$articulo->tipoProtocolo$contArticulos' id='whfinicioimp$articulo->tipoProtocolo$contArticulos' SIZE=22 readonly class='campo2' value='$articulo->fechaInicioAdministracion a las:$articulo->horaInicioAdministracion'>";

				echo "<INPUT TYPE='text' NAME='wfinicioimp$articulo->tipoProtocolo$contArticulos' id='wfinicioimp$articulo->tipoProtocolo$contArticulos' SIZE=25 readonly class='campo2' value='$articulo->fechaInicioAdministracion a las:$articulo->horaInicioAdministracion' onChange='marcarCambio(\"$articulo->tipoProtocolo\",\"$contArticulos\");'>";
				crearCampo("3","btnFechaimp$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."9"],array("onClick"=>"calendarioimp($contArticulos,'$articulo->tipoProtocolo');"),"*");
				
				echo "<input type='hidden' name='wfinicioori$articulo->tipoProtocolo$contArticulos' id='wfinicioori$articulo->tipoProtocolo$contArticulos' value='$articulo->fechaInicioAdministracion a las:$articulo->horaInicioAdministracion' />";
				//				echo "<input type='button' id='btnFecha$articulo->tipoProtocolo$contArticulos' onclick='calendario($contArticulos,\"$articulo->tipoProtocolo\");' value='*'>";
			}else{
				echo "$articulo->fechaInicioAdministracion a las:$articulo->horaInicioAdministracion";
			}
			echo "</td>";

			//Condicion de suministro
			echo "<td onMouseOver='quitarTooltip( this )' onMouseOut='reestablecerTooltip( this );' style='display:none'>";
			if($esEditable){
				$opcionesSeleccion = "<option value=''>Seleccione</option>";
				foreach ($colCondicionesSuministro as $condicion){
					if($condicion->codigo == $articulo->condicionSuministro){
						$opcionesSeleccion .= "<option value='".$condicion->codigo."' selected>$condicion->descripcion</option>";
					} else {
						$opcionesSeleccion .= "<option value='".$condicion->codigo."'>$condicion->descripcion</option>";
					}
				}
				crearCampo("6","wcondicionimp$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."10"],array("class"=>"seleccion","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos', this );"),"$opcionesSeleccion");

				//				echo "<select name='wcondicion$articulo->tipoProtocolo$contArticulos' id='wcondicion$articulo->tipoProtocolo$contArticulos' class='seleccion' onChange='marcarCambio(\"$articulo->tipoProtocolo\",\"$contArticulos\");'>";
				//				echo "<option value=''>Seleccione</option>";
				//
				//				foreach ($colCondicionesSuministro as $condicion){
				//					if($condicion->codigo == $articulo->condicionSuministro){
				//						echo "<option value='".$condicion->codigo."' selected>$condicion->descripcion</option>";
				//					} else {
				//						echo "<option value='".$condicion->codigo."'>$condicion->descripcion</option>";
				//					}
				//				}
				//				echo "</select>";
			}else{
				foreach ($colCondicionesSuministro as $condicion){
					if($condicion->codigo == $articulo->condicionSuministro){
						echo $condicion->descripcion;
					}
				}
			}
			echo "&nbsp;</td>";

			//Confirmacion
			echo "<td $eventosQuitarTooltip style='display:none'>";
			if($esEditable){
				if($articulo->origen == 'CM'){
					if($articulo->estaConfirmado == 'on'){
						crearCampo("5","wchkconfimp$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."11"],array("checked"=>"","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');"),"");
						//						echo "<input type='checkbox' name='wchkconf$articulo->tipoProtocolo$contArticulos' id='wchkconf$articulo->tipoProtocolo$contArticulos' alt='Confirmar preparacion' checked onChange='marcarCambio(\"$articulo->tipoProtocolo\",\"$contArticulos\");'>";
					} else {
						crearCampo("5","wchkconfimp$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."11"],array("unchecked"=>"","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');"),"");
						//						echo "<input type='checkbox' name='wchkconf$articulo->tipoProtocolo$contArticulos' id='wchkconf$articulo->tipoProtocolo$contArticulos' alt='Confirmar preparacion' onChange='marcarCambio(\"$articulo->tipoProtocolo\",\"$contArticulos\");'>";
					}
				} else {
					crearCampo("5","wchkconfimp$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."11"],array("unchecked"=>"","disabled"=>"","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');"),"");
					//					echo "<input type='checkbox' name='wchkconf$articulo->tipoProtocolo$contArticulos' alt='Confirmar preparacion' disabled onChange='marcarCambio(\"$articulo->tipoProtocolo\",\"$contArticulos\");'>";
				}
			}else{
				if($articulo->estaConfirmado == 'on'){
					echo "Si";
				}else{
					echo "No";
				}
			}
			echo "</td>";

			//Dias tratamiento, debe mostrarse en un alt la fecha de terminación y los dias restantes
			if($articulo->diasTratamiento != ''){
				$vecFechaKardex = explode("-",$wfecha);

				$diasFaltantes = intval($articulo->diasTratamiento) - diasDiferenciaFechas($wfecha,$articulo->fechaInicioAdministracion);
				$fechaFinal = date("Y-m-d", mktime(0,0,0,$vecFechaKardex[1],$vecFechaKardex[2],(int)$vecFechaKardex[0]) + ($diasFaltantes*60*60*24));
			} else {
				$diasFaltantes = 0;
				$fechaFinal = "-";
			}

			echo "<td $eventosQuitarTooltip style='display:none'>";
			if($esEditable){
				if( empty( $articulo->dosisMaxima ) ){
					crearCampo("1","wdiasttoimp$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."12"],array("size"=>"3","maxlength"=>"3","class"=>"campo2","onKeyPress"=>"return validarEntradaEntera(event);","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');","onKeyUp"=>"inhabilitarDosisMaxima( this,'$articulo->tipoProtocolo', $contArticulos );"),"$articulo->diasTratamiento");
				}
				else{
					crearCampo("1","wdiasttoimp$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."12"],array("size"=>"3","maxlength"=>"3","class"=>"campo2","onKeyPress"=>"return validarEntradaEntera(event);","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');","readOnly"=>"","onKeyUp"=>"inhabilitarDosisMaxima( this,'$articulo->tipoProtocolo', $contArticulos );"),"$articulo->diasTratamiento");
				}

				if($articulo->diasTratamiento != ""){
					if($diasFaltantes < 0){
						echo "<img src='../../images/medical/root/inactivo.gif' alt='Cumplido'/>";
					}else{
						echo "<img src='../../images/medical/root/activo.gif' alt='Hasta: $fechaFinal - dias restantes: $diasFaltantes'/>";
					}
				}
			}else{
				echo $articulo->diasTratamiento;
			}
			echo "&nbsp;</td>";

			//Dosis máximas
			echo "<td $eventosQuitarTooltip style='display:none'>";
			if($esEditable){
				if( empty( $articulo->diasTratamiento ) ){
					crearCampo("1","wdosmaximp$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."13"],array("size"=>"6","maxlength"=>"6","class"=>"campo2","onKeyPress"=>"return validarEntradaEntera(event);","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');","onKeyUp"=>"inhabilitarDiasTratamiento( this,'$articulo->tipoProtocolo', $contArticulos);"),"$articulo->dosisMaxima");
				}
				else{
					crearCampo("1","wdosmaximp$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."13"],array("size"=>"6","maxlength"=>"6","class"=>"campo2","onKeyPress"=>"return validarEntradaEntera(event);","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');","readOnly"=>"","onKeyUp"=>"inhabilitarDiasTratamiento( this,'$articulo->tipoProtocolo', $contArticulos);"),"$articulo->dosisMaxima");
				}
			}else{
				echo $articulo->dosisMaxima;
			}
			echo "&nbsp;</td>";

			//Observaciones
			echo "<td $eventosQuitarTooltip>";
			
			echo "<table>";
			echo "<tr>";
				echo "<td>";
					echo "<div style='overflow:auto;width:270px;height:70px;background:#fff;border:1px #999 solid;font-size:9pt;text-align:left;'>";
					echo $articulo->observaciones;
					echo "</div>";
				echo "</td>";
			echo "<td>";
			
			
			//Se comenta esta parte para que no permita editar la observacion de un medicamento de alta.
			// if($esEditable){
				// crearCampo("2","wtxtobsimp$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."14"],array("cols"=>"40","rows"=>"2","onKeyPress"=>"return validarEntradaAlfabetica(event);","onChange"=>"marcarCambio('$articulo->tipoProtocolo','$contArticulos');"),"");
				// echo "<input type='hidden' name='wtxtobsori$articulo->tipoProtocolo$contArticulos' id='wtxtobsori$articulo->tipoProtocolo$contArticulos' value='$articulo->observaciones' />";
				
				// //				echo "<textarea id='wtxtobs$articulo->tipoProtocolo$contArticulos' rows=2 cols=10 onkeypress='return validarEntradaAlfabetica(event);' onChange='marcarCambio(\"$articulo->tipoProtocolo\",\"$contArticulos\");'>";
				// //				echo $articulo->observaciones;
				// //				echo "</textarea>";
			// } else {
				// crearCampo("2","wtxtobsimp$articulo->tipoProtocolo$contArticulos",@$accionesPestana[$indicePestana.".$tipoProtocolo"."14"],array("cols"=>"40","rows"=>"2","readonly"=>""),"");
				// //				echo "<textarea id='wtxtobs$articulo->tipoProtocolo$contArticulos' rows=2 cols=10 readonly>";
				// //				echo $articulo->observaciones;
				// //				echo "</textarea>";
			// }
			echo "</table>";
			echo "</td>";

			echo "<td>";
			echo $arrEspecialidades[$articulo->codigoCreador];
			echo "</td>";
			
			echo "</tr>";
			
			/**********************************************************************************************************************************************************
			 * Diciembre 15 de 2011
			 *
			 * Si falta un 80% o menos de los días de tratamiento, sale un mensaje
			 * diciendo cuanto falta para terminar el medicamento por dias de tratamiento
			 **********************************************************************************************************************************************************/
			if( $articulo->diasTratamiento != '' && $articulo->diasTratamiento > 0 ){
				if($esEditable){
					//Calculo total de tiempo transcurrido desde la fecha de inicio del medicamento
					//hasta el actual
					$tiempoTranscurrido = intval( ( strtotime( date( "Y-m-d" )." 00:00:00" ) - strtotime( $articulo->fechaInicioAdministracion." 00:00:00" ) )/(24*3600) )+1;

					if( $tiempoTranscurrido >= intval( intval($articulo->diasTratamiento)*$topePorcentualCtc/100 ) ){
						// mensajeEmergente( "El articulo ".trim($articulo->codigoArticulo)." le faltan ".intval( intval( intval($articulo->diasTratamiento) ) - $tiempoTranscurrido )." día(s) más tratamiento ");
						$msg = "El articulo ".trim($articulo->codigoArticulo)." le faltan ".intval( intval( intval($articulo->diasTratamiento) ) - $tiempoTranscurrido )." día(s) más tratamiento ";
						echo "<script>";
						echo "alertsIniciales[alertsIniciales.length] = '$msg';";
						echo "</script>";
					}
				}
			}
			/**********************************************************************************************************************************************************/
			
			$contArticulos++;
		}
	}

	echo "</tbody>";
	echo "</table>";
	echo "<p>&nbsp;</p>";
}



//Realiza el despliegue de la lista de articulos en el historial
function vista_desplegarListaArticulosHistorial($colDetalle,$tipoProtocolo,$colUnidades,$colPeriodicidades,$colCondicionesSuministro,$colFormasFarmaceuticas,$colVias, $wbasedato){
	global $grupoControl;

	global $centroCostosServicioFarmaceutico;
	global $centroCostosCentralMezclas;
	global $codigoServicioFarmaceutico;
	global $codigoCentralMezclas;

	global $usuario;		//Información de usuario
	
	global $topePorcentualCtc;

	global $regletaFamiliaHist;
	
	global $paciente;
	
	global $conex;
	global $wcenmez;
	
	
	// //Muestra el detalle de medicamentos del kardex consultado
	// echo '<span class="subtituloPagina2" align="center" style="cursor:pointer;" onclick="ver_articulos_anteriores(\''.$tipoProtocolo.'\');">';
	// echo "Detalle de articulos anteriores (Ver)";
	// echo "</span><br><br>";

	$cont1=0;
	$fechaTmp = "";
	$clase = "";
	$mostrarArticulo = false;

	$auxFamilia = "";
	$contFamilia = 1;
	// echo "<div id='lista_articulos_anteriores$tipoProtocolo' style='display:none;'>";
	foreach ($colDetalle as $articulo){

		/*
		 $mostrarArticulo = ((isset($articulo->grupo) && $articulo->grupo != '' && strpos($gruposCco,$articulo->grupo) !== false) || $gruposCco == "*");

		 if($esCM){
			if($articulo->origen == $codigoCentralMezclas){
			$mostrarArticulo = true;
			} else {
			$mostrarArticulo = false;
			}
			}*/

		$mostrarArticulo = true;

		if($mostrarArticulo){
			$cumplido = false;

			$pintarFinFAmilia = false;
			if($articulo->codigoFamilia!=$auxFamilia && $contFamilia>1)
			{
				echo "</table></div></td></tr></tbody>";
				$pintarFinFAmilia = true;
			}
			
			
			if($fechaTmp != $articulo->fecha){
				//Seccion nueva del acordeon
				if($cont1 > 0){
				
					if(!$pintarFinFAmilia)
					{
						echo "</table></div></td></tr></tbody>";
						$auxFamilia = "";
					}
				
					echo "</table>";
					echo "</p>";
					echo "</div>";
				}
				echo "<a href='#null' onclick=intercalarMedicamentoAnterior('$articulo->fecha',\"$tipoProtocolo\");>$articulo->fecha</a></br>";
				echo "<div id='medAnt$tipoProtocolo$articulo->fecha' style='display:none'>";

				echo "<p>";
				echo "<table align='center' border=0>";

				echo "<tr align='center' class='encabezadoTabla' id='trEncabezadoTbHist$tipoProtocolo'>";
				// $tipoProtocolo="N";
				//echo "<td>Acciones</td>";
				echo "<td>Medicamento</td>";
				echo "<td>02</td>";
				echo "<td>04</td>";
				echo "<td>06</td>";
				echo "<td>08</td>";
				echo "<td>10</td>";
				echo "<td>12</td>";
				echo "<td>14</td>";
				echo "<td>16</td>";
				echo "<td>18</td>";
				echo "<td>20</td>";
				echo "<td>22</td>";
				echo "<td>24</td>";
				echo "</tr>";
			}	// FIN if($fechaTmp != $articulo->fecha)
					
			$fecha_ciclo = str_replace("-","",$articulo->fecha);
					
			// Inicio cambio de familia de medicamentos
			if($articulo->codigoFamilia!=$auxFamilia)
			{
				
				if($clasef == 'fila2')
					$clasef = 'fila1';
				else
					$clasef = 'fila2';

				if(isset($regletaFamiliaHist[$fecha_ciclo][$articulo->codigoFamilia]['esCompuestaFamilia']) && $regletaFamiliaHist[$fecha_ciclo][$articulo->codigoFamilia]['esCompuestaFamilia']=='1')
					$clasef = 'esCompuesta';
				
				echo "<tr class='".$clasef."' id='filaTituloFamiliaHist".$tipoProtocolo.$contFamilia."'	onclick='mostrarDetalleFlia(this,\"detKardexHist".$tipoProtocolo.$contFamilia."\",\"divDetalleHist".$tipoProtocolo.$contFamilia."\",\"filaTituloFamiliaHist".$tipoProtocolo.$contFamilia."\",\"".$clasef."\");'><td><a style='cursor: pointer;'><b>".utf8_encode( $articulo->codigoFamilia." - ".$articulo->nombreFamilia )."</b></a></td>";

				// echo "<td colspan='8'>";
				// echo "<table><tr>";
				//print_r($regletaFamiliaHist[$articulo->codigoFamilia]);
				/*********************************************************
				 * 	GRAFICA DE LOS HORARIOS DE SUMINISTRO DE FAMILIAS.
				 *
				 *
				 * 1.  Si la fecha de inicio es menor o igual a la de consulta del kardex se muestra la info
				 * 2.  Si se encuentra suspendido no se muestra la grafica
				 *********************************************************/
				//Grafica de los horarios ... 24 horas del dia.  Debe convertirse a horas cada periodicidad

				$horaArranque = 2;

				$cont3 = 1;
				$cont4 = $horaArranque;   //Desplazamiento desde la hora inicial
				//$claseGrafica = "fondoVerde";

				while($cont3 <= 24)
				{

					if(isset($regletaFamiliaHist[$fecha_ciclo][$articulo->codigoFamilia][$cont4]['valor']) && $regletaFamiliaHist[$fecha_ciclo][$articulo->codigoFamilia][$cont4]['valor'] > 0){
						echo "<td class='msg_tooltip' title='".$regletaFamiliaHist[$fecha_ciclo][$articulo->codigoFamilia][$cont4]['tooltip']."' align='center' onMouseOver='mostrarTooltip(this, $cont4)' width='100'>";
						echo $regletaFamiliaHist[$fecha_ciclo][$articulo->codigoFamilia][$cont4]['valor']." ".$regletaFamiliaHist[$fecha_ciclo][$articulo->codigoFamilia][$cont4]['unidad'];
						echo "</td>";
					} else {
						echo "<td class='msg_tooltip' title='".$regletaFamiliaHist[$fecha_ciclo][$articulo->codigoFamilia][$cont4]['tooltip']."' onMouseOver='mostrarTooltip(this, $cont4)' width='50'>&nbsp;</td>";
					}

					if($cont4 == 24){
						$cont4 = 0;
					}

					$cont3++;
					$cont4++;

					if($cont4 % 2 != 0){
						$cont4++;
					}
					if($cont3 % 2 != 0){
						$cont3++;
					}

					if($cont4 == $horaArranque){
						break;
					}
				}
				//echo "</tr></table>";


				//echo "</td>";
				echo "</tr>";
				
				echo "<tbody id='detKardexHist$tipoProtocolo$contFamilia' style='display:none;'>";
				
				echo "<tr><td colspan='13'>";
				echo "<div id='divDetalleHist$tipoProtocolo$contFamilia' style='display:none;'>";

				$contFamilia++;

			
				echo "<table align='center' border=0>";

				echo "<tr align='center' class='encabezadoTabla'>";
	
				$auxEspacios = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
				
				//Encabezado detalle kardex
				echo "<td nowrap> $auxEspacios $auxEspacios $auxEspacios Articulo $auxEspacios $auxEspacios $auxEspacios </td>";
				echo "<td style='display:none'>Protocolo</td>";
				echo "<td>Dosis</td>";
				echo "<td>Frecuencia</td>";
				echo "<td>Condicion</td>";
				echo "<td>Forma farmaceutica</td>";
				echo "<td>Fecha y hora inicio</td>";
				echo "<td>Via</td>";
				echo "<td>Conf.</td>";
				echo "<td>DA.</td>";
				echo "<td>NE.</td>";
				echo "<td>Dias tto.</td>";
				echo "<td>Dosis max.</td>";
				echo "<td>Susp.</td>";
				echo "<td nowrap> $auxEspacios $auxEspacios Observaciones $auxEspacios $auxEspacios </td>";
				echo "<td>02</td>";
				echo "<td>04</td>";
				echo "<td>06</td>";
				echo "<td>08</td>";
				echo "<td>10</td>";
				echo "<td>12</td>";
				echo "<td>14</td>";
				echo "<td>16</td>";
				echo "<td>18</td>";
				echo "<td>20</td>";
				echo "<td>22</td>";
				echo "<td>24</td>";

				echo "</tr>";
			}	// FIN if($articulo->codigoFamilia!=$auxFamilia)

			$auxFamilia = $articulo->codigoFamilia;
		
			if($clase == "fila1"){
				$clase = "fila2";
			} else {
				$clase = "fila1";
			}

			if($articulo->grupo == $grupoControl){
				$clase = "articuloControl";
			}

			if($articulo->suspendido == 'on'){
				$clase = "suspendido";
			}
			
			echo "<tr id='tr$cont1' class='$clase'>";

			//Fecha del kardex
			$fechaTmp = $articulo->fecha;

			$funcionOnclickAbrirNPT = consultarSiEsNutricionNPT($wbasedato,$articulo->historia,$articulo->ingreso,$articulo->consultarCodigoArticulo(),$articulo->idOriginal);	
			//Articulo
			if($cumplido){
				echo "<td ".$funcionOnclickAbrirNPT.">".utf8_encode( $articulo->codigoArticulo )." - C</td>";
			} else {
				echo "<td ".$funcionOnclickAbrirNPT.">".utf8_encode( $articulo->codigoArticulo )."</td>";
			}
			
			//Nombre protocolo
			echo "<td style='display:none'>".utf8_encode( $articulo->nombreProtocolo )."</td>";

			$dosisDelArticulo = $articulo->cantidadDosis;
			
			$unidadArticulo = $articulo->unidadDosis;
			$formaFarmaceuticaArticulo = $articulo->formaFarmaceutica;
			// validar si es producto de central de mezclas, si es DA, si el centro de costos tiene purga
			$detalleDosisPurga = "";
			if($articulo->origen=="CM")
			{
				$artCM = $articulo->codigoArticulo;
				$artCM = explode("-",$artCM);
				
				// si es una DA con purga debe mostrar la dosis ordenada (sin purga)
				$articuloSinPurga = consultarDosisSinPurgaDA($conex,$wbasedato,$wcenmez,$articulo->historia,$articulo->ingreso,$artCM[0],$articulo->idOriginal,$articulo->cantidadDosis,$unidadArticulo,$formaFarmaceuticaArticulo);
				
				$dosisDelArticulo = $articuloSinPurga['dosis'];
				$unidadArticulo = $articuloSinPurga['unidad'];
				$formaFarmaceuticaArticulo = $articuloSinPurga['formaFarmaceutica'];
				
				$detalleDosisPurga = pintarDetalleDosisPurgaDA($dosisDelArticulo,$articulo->cantidadDosis,$unidadArticulo,$articulo->unidadDosis,true,$formaFarmaceuticaArticulo);
			}
			
			
			//Dosis y unidad de medida
			echo "<td>";
			echo $detalleDosisPurga;
			echo $dosisDelArticulo." ";

			foreach ($colUnidades as $unidad){
				if($unidad->codigo == $unidadArticulo){
					echo $unidad->descripcion;
				}
			}
			echo " (S)";
			echo "</td>";
			
			//Periodicidad
			echo "<td>";
			foreach ($colPeriodicidades as $periodicidad){
				if($periodicidad->codigo == $articulo->periodicidad){
					echo $periodicidad->descripcion;
				}
			}
			echo "</td>";

			//Condicion
			echo "<td>";
			foreach ($colCondicionesSuministro as $condicion){
				if($condicion->codigo == $articulo->condicionSuministro){
					echo $condicion->descripcion;
				}
			}
			echo "</td>";

			//Forma farmaceutica
			echo "<td>";

			foreach ($colFormasFarmaceuticas as $formasFarmaceutica){
				if($formasFarmaceutica->codigo == $formaFarmaceuticaArticulo){
					echo utf8_encode( $formasFarmaceutica->descripcion );
				}
			}

			echo "</td>";

			//Fecha y hora inicio
			echo "<td>";
			echo "$articulo->fechaInicioAdministracion a las:$articulo->horaInicioAdministracion";
			echo "</td>";

			//Via administracion
			echo "<td>";
			foreach ($colVias as $via){
				if($via->codigo == $articulo->via){
					echo utf8_encode( $via->descripcion );
				}
			}
			echo "</td>";

			//Confirmacion
			echo "<td>";
			if($articulo->estaConfirmado == 'on'){
				echo "Si";
			}else{
				echo "No";
			}
			echo "</td>";
			
			//DA
			echo "<td>";
			if($articulo->dosisAdaptada == 'on'){
				echo "Si";
			}else{
				echo "No";
			}
			echo "</td>";
			
			//NE
			echo "<td>";
			if($articulo->noEsteril == 'on'){
				echo "Si";
			}else{
				echo "No";
			}
			echo "</td>";

			//Dias tratamiento
			echo "<td>";
			echo $articulo->diasTratamiento;
			echo "</td>";

			//Dosis maxima
			echo "<td>";
			echo $articulo->dosisMaxima;
			echo "</td>";

			//Suspendido o no
			echo "<td>";
			if($articulo->suspendido == 'on'){
				echo "Si";
			}else{
				echo "No";
			}
			echo "</td>";

			//Observaciones
			echo "<td>";
			echo '<div style="overflow:auto;width:270px;height:70px;background:#fff;border:1px #999 solid;font-size:9pt;text-align:left;">';
			
			echo utf8_encode( $articulo->observaciones );
			
			echo "</div>";
			echo "</td>";

			//Grafica de administracion de medicamentos
			foreach ($colPeriodicidades as $periodicidad){
				if($periodicidad->codigo == $articulo->periodicidad){
					$horasPeriodicidad = intval($periodicidad->equivalencia);
					break;
				}
			}

			$arrAplicacion = obtenerVectorAplicacionMedicamentos($articulo->fecha,$articulo->fechaInicioAdministracion,$articulo->horaInicioAdministracion,$horasPeriodicidad);
			$horaArranque = 2;
			$aplicaGraficaSuministro = true;

			$cont1 = 1;
			$cont2 = $horaArranque;   //Desplazamiento desde la hora inicial
			$caracterMarca = "*";

			while($cont1 <= 24){
				if(isset($arrAplicacion[$cont2]) && $arrAplicacion[$cont2] == $caracterMarca && $aplicaGraficaSuministro){
					echo "<td class='fondoVerde' align='center'>";
					echo $caracterMarca;
					echo "</td>";
				} else {
					echo "<td>&nbsp;</td>";
				}

				if($cont2 == 24){
					$cont2 = 0;
				}

				$cont1++;
				$cont2++;

				if($cont2 % 2 != 0){
					$cont2++;
				}
				if($cont1 % 2 != 0){
					$cont1++;
				}

				if($cont2 == $horaArranque){
					break;
				}
			}

			echo "</tr>";
			
			$cont1++;
		}	// FIN if($mostrarArticulo)

	}	// FOR($colDetalle as $articulo)

	echo "</table></div></td></tr></tbody>";
	echo "</table>";
	echo "</p>";
	echo "</div>";
	// echo "</div>";
}


//Realiza los movimientos necesarios de definitivo a temporal al abrir el kardex
/* Bajo el esquema de tablas temporales se trabajará asi:
 * APLICA PARA:
 * a. Articulos
 * b. Examenes
 * c. Liquidos endovenosos
 * d. Medicos
 * e. Dietas
 *
 * 1. Consulta de estructura temporal.
 * 1.1. Si hay registros, carga en pantalla
 * 1.2. No hay registros
 * 1.2.1. Consulta de estructura definitiva
 * 1.2.2. Si hay registros, carga en estructura temporal y carga en pantalla
 * 1.2.3. No hay registros, carga pantalla (sin registros), graba movimientos en temporal
 *
 * 02-Jun-10 (Msanchez):  Carga de articulos dependiente del centro de costos y los grupos de medicamentos que puede ver.
 */

function realizarMovimientosArticulos($kardexActual, $paciente, $esFechaActual, $fechaConsulta, $fechaGrabacion, $tipoProtocolo, &$elementosActuales, &$colDetalle,$esDePiso){
	global $usuario;    //Usuario que ingresa al kardex
	global $protocoloNormal;
	
	global $wbasedato;
	global $conex;

	$esEditable = $kardexActual->editable;
	$esAnterior = $kardexActual->esAnterior;
	$descontarDispensaciones = $kardexActual->descontarDispensaciones;

	$historia = $paciente->historiaClinica;
	$ingreso = $paciente->ingresoHistoriaClinica;
	/*************************************************************************************************
	 * Las condiciones para los centros de costos son las siguientes (sin importar el protocolo):
	 *
	 * 1.  Central de mezclas.  	Mueve unicamente los articulos del 1051
	 * 2.  Lactario.				Mueve los articulos del 1050 y solo los que tenga ccogka
	 * 3.  Servicio farmaceutico.	Mueve los articulos del 1050 y solo los que tenga ccogka
	 * 4.  Cualquier otro.			Mueve todos los articulos.
	 *************************************************************************************************/
	if($esEditable){
		//Verifica que si no existe detalle temporal, se cargue el detalle definitivo del dia anterior
		if($esEditable && $esAnterior && $esFechaActual){
			$colTemporal = consultarDetalleTemporalKardex($historia,$ingreso,$fechaConsulta,$tipoProtocolo);
			if(count($colTemporal) == 0){
				//antes de cargar los articulos a la temporal recalculo nuevamente
				//esto por si viene de urgencias o cirugia y no se encuentre recalculado
				recalcularKardex( $conex, $wbasedato, $historia, $ingreso, date( "Y-m-d", strtotime( $fechaGrabacion." 00:00:00" ) - 24*3600 ) );
				cargarArticulosAnteriorATemporal($historia,$ingreso,$fechaConsulta,$fechaGrabacion,$tipoProtocolo,$descontarDispensaciones,$kardexActual->horaDescuentoDispensaciones);
				$fechaConsulta = $fechaGrabacion;
			}
		}

		$colDetalle = consultarDetalleTemporalKardex($historia,$ingreso,$fechaConsulta,$tipoProtocolo);
		$elementosActuales = count($colDetalle);

		if($elementosActuales == 0){
			//1.2.1. Consulta de estructura definitiva
			$colDetalle = consultarDetalleDefinitivoKardex($paciente,$historia,$ingreso,$fechaConsulta,$tipoProtocolo,$esDePiso );
			$elementosActuales = count($colDetalle);

			if($elementosActuales > 0 && $esFechaActual){
				//1.2.2. Si hay registros, carga en estructura temporal y carga en pantalla
				cargarArticulosATemporal($historia,$ingreso,$fechaConsulta,$fechaConsulta,$tipoProtocolo, $paciente,$esDePiso );
			}
		}
	} else {
		$colDetalle = consultarDetalleDefinitivoKardex($paciente,$historia,$ingreso,$fechaConsulta,$tipoProtocolo,$esDePiso );
		$elementosActuales = count($colDetalle);
	}

	//Los articulos de central de mezclas deben verse en el kardex en forma editable.  Solo para el servicio farmaceutico
	if($usuario->esUsuarioSF && $tipoProtocolo == $protocoloNormal){
		$colDetalle = array_merge($colDetalle,consultarArticulosCMParaSF($historia,$ingreso,$fechaConsulta,$tipoProtocolo));
	}

	//Articulos del lactario
	if(!$usuario->esUsuarioSF && !$usuario->esUsuarioCM && !$usuario->esUsuarioLactario && $tipoProtocolo == $protocoloNormal){
		$colDetalle = array_merge($colDetalle,consultarArticulosLactario($historia,$ingreso,$fechaConsulta,$tipoProtocolo));
	}
}

function realizarMovimientosArticulosAlta($kardexActual, $paciente, $esFechaActual, $fechaConsulta, $fechaGrabacion, $tipoProtocolo, &$elementosActualesAlta, &$colDetalleAlta, &$elementosActualesAltaAux, &$colDetalleAltaAux){
	global $usuario;    //Usuario que ingresa al kardex
	global $protocoloNormal;
	
	global $wbasedato;
	global $conex;

	$esEditable = $kardexActual->editable;
	$esAnterior = $kardexActual->esAnterior;
	$descontarDispensaciones = $kardexActual->descontarDispensaciones;

	$historia = $paciente->historiaClinica;
	$ingreso = $paciente->ingresoHistoriaClinica;
	/*************************************************************************************************
	 * Las condiciones para los centros de costos son las siguientes (sin importar el protocolo):
	 *
	 * 1.  Central de mezclas.  	Mueve unicamente los articulos del 1051
	 * 2.  Lactario.				Mueve los articulos del 1050 y solo los que tenga ccogka
	 * 3.  Servicio farmaceutico.	Mueve los articulos del 1050 y solo los que tenga ccogka
	 * 4.  Cualquier otro.			Mueve todos los articulos.
	 *************************************************************************************************/
	// $colDetalleAlta = consultarDetalleKardexAlta($historia,$ingreso,$fechaConsulta,$tipoProtocolo);
	// $elementosActualesAlta = count($colDetalleAlta);

	if($esEditable){
		//Verifica que si no existe detalle temporal, se cargue el detalle definitivo del dia anterior

		$colDetalleAlta = consultarDetalleTemporalKardex($historia,$ingreso,$fechaConsulta,$tipoProtocolo,'on');
		$elementosActualesAlta = count($colDetalleAlta);
		
		//Arreglo con lo medicamentos de alta. Jonatan 7 oct 2014
		$colDetalleAltaAux = consultarDetalleTemporalKardexAlta($historia,$ingreso,$fechaConsulta,$tipoProtocolo,'on');
		$elementosActualesAlta = count($colDetalleAlta) + count($colDetalleAltaAux);
		
		//Agrega los articulos de alta al arreglo de articulos para el paciente.
		$colDetalleAlta = array_merge($colDetalleAltaAux,$colDetalleAlta);


		if($elementosActualesAlta == 0){
			//1.2.1. Consulta de estructura definitiva
			$colDetalleAlta = consultarDetalleDefinitivoKardex($paciente,$historia,$ingreso,$fechaConsulta,$tipoProtocolo,'','on');
			$elementosActualesAlta = count($colDetalleAlta);

		}
	} else {
		$colDetalleAlta = consultarDetalleDefinitivoKardex($paciente,$historia,$ingreso,$fechaConsulta,$tipoProtocolo,'','on');
		$elementosActualesAlta = count($colDetalleAlta);
		
		//Arreglo con lo medicamentos de alta. Jonatan 7 oct 2014
		$colDetalleAltaAux = consultarDetalleTemporalKardexAlta($historia,$ingreso,$fechaConsulta,$tipoProtocolo,'on');		
		$elementosActualesAlta = count($colDetalleAlta) + count($colDetalleAltaAux);
		
		//Agrega los articulos de alta al arreglo de articulos para el paciente.
		$colDetalleAlta = array_merge($colDetalleAltaAux,$colDetalleAlta);
	}

	//Los articulos de central de mezclas deben verse en el kardex en forma editable.  Solo para el servicio farmaceutico
	if($usuario->esUsuarioSF && $tipoProtocolo == $protocoloNormal){
		$colDetalleAlta = array_merge($colDetalleAlta,consultarArticulosCMParaSF($historia,$ingreso,$fechaConsulta,$tipoProtocolo));
		
	}

	//Articulos del lactario
	if(!$usuario->esUsuarioSF && !$usuario->esUsuarioCM && !$usuario->esUsuarioLactario && $tipoProtocolo == $protocoloNormal){
		$colDetalleAlta = array_merge($colDetalleAlta,consultarArticulosLactario($historia,$ingreso,$fechaConsulta,$tipoProtocolo));
	}
}


/************************************************************************************************************************
 * CONSULTA DE ACCIONES POR CADA CAMPO DE UNA PESTAÑA
 *
 * Precedencia de operaciones:
 *
 * 1.Lectura.   Inhibe o permite el resto de operaciones
 ************************************************************************************************************************/
function consultarAccionesPestana($indicePestana){
	global $wbasedato;
	global $conex;
	global $codigoAplicacion;
	global $usuario;
	global $wbasedatohce;
	
	$acciones = array();

	//Dias de tratamiento
	$q = "SELECT
				Accpma,Accpes,Accopc,Accrol,Acccre,Accrea,Accupd,Accdel,Accest
			FROM
				".$wbasedatohce."_000029
			WHERE 
				Accpma = '$codigoAplicacion'
				AND Accpes = '$indicePestana'
				AND Accrol = '$usuario->codigoRolHCE'
				AND Accest = 'on'
				;";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	while($info = mysql_fetch_array($res)){
		$accion = inicializarAccionesPestana();

		$accion->nroPestana = $indicePestana;
		$accion->codigoAccion = $info['Accopc'];
		$accion->actualizar = $info['Accupd'] == "on" ? true : false;
		$accion->borrar = $info['Accdel'] == "on" ? true : false;
		$accion->crear = $info['Acccre'] == "on" ? true : false;
		$accion->leer = $info['Accrea'] == "on" ? true : false;

		//Forma de indizacion de acciones
		$acciones[$indicePestana.".".$accion->codigoAccion] = $accion;
	}
	
	return $acciones;
}

/************************************************************************************************************************
 * Coloca un campo en html
 *
 * Tipo:
 *
 * 1.Text
 * 2.Textarea
 ************************************************************************************************************************/
function crearCampo($tipo,$id,$acciones,$atributos,$valor){
	$salida = "";

	//SI no hay accion por BD, se otorgan todos los permisos
	if(empty($acciones)){
		$acciones = inicializarAccionesPestana();
	}

	switch ($tipo){
		case '1':		//Texto
			$salida = "<input type=text name='$id' id='$id' ";
			foreach ($atributos as $clave => $vr){
				if(!empty($vr)){
					$salida .= " $clave=\"$vr\" ";
				} else {
					$salida .= " $clave ";
				}
			}
			//Valor
			$salida .= " value=\"$valor\"";
				
			//Lectura
			if(!$acciones->leer){
				$salida .= " readonly=readonly disabled=disabled ";
			}
			$salida .= "/>";
			break;
		case '2':		//Textarea
			$salida = "<textarea name='$id' id='$id' ";
			foreach ($atributos as $clave => $vr){
				if(!empty($vr)){
					$salida .= " $clave=\"$vr\" ";
				} else {
					$salida .= " $clave ";
				}
			}
				
			//Lectura
			if(!$acciones->leer){
				$salida .= " readonly=readonly ";
			}
				
			$salida .= ">$valor";
			$salida .= "</textarea>";
			break;
		case '3':		//Boton
			$salida = "<input type='button' name='$id' id='$id' ";
			foreach ($atributos as $clave => $vr){
				if(!empty($vr)){
					$salida .= " $clave=\"$vr\" ";
				} else {
					$salida .= " $clave ";
				}
			}
			//Valor
			$salida .= " value=\"$valor\"";
				
			//Lectura
			if(!$acciones->leer){
				$salida .= " disabled ";
			}
				
			$salida .= "/>";
			break;
		case '4':		//Link
			$salida = "<a href='#null' name='$id' id='$id' ";
			foreach ($atributos as $clave => $vr){
				if(!empty($vr)){
					$salida .= " $clave=\"$vr\" ";
				} else {
					$salida .= " $clave ";
				}
			}
			//Valor
			$salida .= ">$valor";
			$salida .= "</a>";

			//Lectura
			if(!$acciones->leer){
				$salida = " ";
			}

			break;
		case '5':		//Checkbox
			$salida = "<input type='checkbox' name='$id' id='$id' ";
			foreach ($atributos as $clave => $vr){
				if(!empty($vr)){
					$salida .= " $clave=\"$vr\" ";
				} else {
					$salida .= " $clave ";
				}
			}
			//Valor
			$salida .= " value=\"$valor\"";
				
			//Lectura
			if(!$acciones->leer){
				$salida .= " disabled ";
			}
				
			$salida .= "/>";
			break;
		case '6':		//Select
			$salida = "<select name='$id' id='$id' ";

			//Lectura
			if(!$acciones->leer){
				$salida .= " disabled ";
			}
				
			foreach ($atributos as $clave => $vr){
				if(!empty($vr)){
					$salida .= " $clave=\"$vr\" ";
				} else {
					$salida .= " $clave ";
				}
			}
			$salida .= ">";
			// 2012-07-09
			//Valor
			$salida .= " $valor ";
			$salida .= "</select>";
			break;
		case '7':		//Rama de arbol
			$salida = "$valor";
				
			//Lectura
			if(!$acciones->leer){
				$salida = " ";
			}
			break;
		case '8':		//Link
			$salida = "<a href='#null' name='$id' id='$id' ";
			foreach ($atributos as $clave => $vr){
				if(!empty($vr)){
					$salida .= " $clave=\"$vr\" ";
				} else {
					$salida .= " $clave ";
				}
			}
			//Valor
			$salida .= ">$valor";
			$salida .= "</a>";

			//Lectura
			if(!$acciones->leer){
				$salida = $valor;
			}
			break;
		default:
			break;
	}
	echo $salida;
}
/*
 * Para comunicar PHP con el javascript de creacion dinamico, se serializan las acciones separadas por coma
 */
function accionesATexto($acciones){
	$texto = "";

	if(isset($acciones)){
		$texto .= $acciones->leer ? "S":"N";
		$texto .= $acciones->actualizar ? ",S":",N";
		$texto .= $acciones->borrar ? ",S":",N";
		$texto .= $acciones->crear ? ",S":",N";
	} else {
		$texto .= "S";
		$texto .= ",S";
		$texto .= ",S";
		$texto .= ",S";
	}

	return $texto;
}

//Obtiene los datos adicionales de un articulo por paciente
function obtenerDatosAdicionalesArticulo($historia, $ingreso, $articulo, &$diasTratamiento, &$dosisTotalesTto){
	global $wbasedato;
	global $conex;

	//
	/*Dias de tratamiento
	$q = "SELECT
				A.Kadhis,A.Kading,A.Kadart,SUM(DATEDIFF(Kadfec,A.Kadfin)) diasTto
			FROM
				(
					SELECT
						Kadhis,Kading,Kadart,Kadfin
					FROM
						movhos_000054
					WHERE
						Kadhis = '$historia'
						AND Kading = '$ingreso'
						AND Kadart = '$articulo'
					GROUP BY
						Kadfin
				) A,
				(
					SELECT
						Kadhis,Kading,Kadart,Kadfin,max( kadfec ) Kadfec
					FROM
						movhos_000054
					WHERE
						Kadhis = '$historia'
						AND Kading = '$ingreso'
						AND Kadart = '$articulo'
					GROUP BY
						Kadfin
				) B
			WHERE
				A.Kadhis = B.Kadhis
				AND A.Kading = B.Kading
				AND A.Kadart = B.Kadart
				AND A.Kadfin = B.Kadfin
			GROUP BY
				Kadhis,Kading,Kadart";
*/
	$q="SELECT 
			COUNT(*) diasTto
		FROM (
			SELECT 
				COUNT(*) 
			FROM 
				{$wbasedato}_000015
			WHERE 
				Aplhis = '$historia' 
				AND Apling = '$ingreso' 
				AND Aplart = '$articulo' 
				AND Aplest = 'on'
			GROUP BY 
				Aplfec
			)Apl";
	
	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if($num > 0 ){
			$info = mysql_fetch_array($res);
			$diasTratamiento = $info['diasTto'];
	}

	//Dosis aplicadas BASADAS SOLO en el kardex
	/*
	$q = "SELECT
			SUM(Kadcan * Kadcfr) cantFr, Kadufr
		FROM
			movhos_000054
		WHERE
			Kadhis = '$historia'
			AND Kading = '$ingreso'
			AND Kadart = '$articulo'
			AND Kadfin != Kadfec
		GROUP BY
			Kadcfr, Kadufr";
	*/
	$q = "SELECT
			IFNULL( COUNT(Aplcan),0 ) aplicaciones
		FROM
			{$wbasedato}_000015
		WHERE
			Aplest = 'on'
			AND Aplcan > 0
			AND Aplhis  = '$historia'
			AND Apling = '$ingreso'
			AND Aplart = '$articulo'";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if($num > 0 ){
			$info = mysql_fetch_array($res);
			$dosisTotalesTto = $info['aplicaciones'];
	}
}

function consultarEstadoGrabacionKardex($historia, $ingreso, $fecha){
	global $wbasedato;
	global $conex;

	$grabado = "";

	$q = "SELECT
			Kargra
		FROM 
		{$wbasedato}_000053
		WHERE
			Fecha_data = '$fecha'
			AND Karhis = '".$historia."'
			AND Karing = '".$ingreso."';";

		$coleccion = array();

		$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
		$num = mysql_num_rows($res);

		$cont1 = 0;
		while($cont1 <= $num){
			$info = mysql_fetch_array($res);
			$grabado = $info['Kargra'];
			$cont1++;
		}
		return $grabado;
}

//Itera basado en RegistroGenericoDTO
function descripcionMaestroPorCodigo($coleccion, $valor){
	$descripcion = "";

	foreach ($coleccion as $elemento){
		if(trim($elemento->codigo) == $valor){
			$descripcion = $elemento->descripcion;
			break;
		}
	}

	return $descripcion;
}

function consultarDietasTemporalPaciente($historia, $ingreso, $fecha){
	global $wbasedato;
	global $conex;

	$q = "SELECT
			".$wbasedato."_000064.id, Dikcod, Diedes, Dikhis, Diking, Dikfec, Dikest
		FROM 
			".$wbasedato."_000064, ".$wbasedato."_000041 
		WHERE
			Diecod = Dikcod
			AND Dikhis = '".$historia."'
			AND Diking = '".$ingreso."'
			AND Dikfec = '".$fecha."';";

	$coleccion = array();

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$cont1 = 0;
	if($num > 0 ){
		while($cont1 <= $num)
		{
			$info = mysql_fetch_array($res);

			$dieta = new dietaKardexDTO();

			$dieta->id = $info['id'];

			$dieta->codigoDieta = $info['Dikcod'];
			$dieta->descripcionDieta = $info['Diedes'];
			$dieta->historia = $info['Dikhis'];
			$dieta->ingreso = $info['Diking'];
			$dieta->fechaKardex = $info['Dikfec'];
			$dieta->estado = $info['Dikest'];

			$cont1++;

			$coleccion[] = $dieta;
		}
	}
	return $coleccion;
}

function consultarDietasDefinitivoPaciente($historia, $ingreso, $fecha){
	global $wbasedato;
	global $conex;

	$q = "SELECT
			".$wbasedato."_000052.id, Dikcod, Diedes, Dikhis, Diking, Dikfec, Dikest
		FROM 
			".$wbasedato."_000052, ".$wbasedato."_000041 
		WHERE
			Diecod = Dikcod
			AND Dikhis = '".$historia."'
			AND Diking = '".$ingreso."'
			AND Dikfec = '".$fecha."';";

	$coleccion = array();

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$cont1 = 0;
	while($cont1 <= $num)
	{
		$info = mysql_fetch_array($res);

		$dieta = new dietaKardexDTO();

		$dieta->id = $info['id'];

		$dieta->codigoDieta = $info['Dikcod'];
		$dieta->descripcionDieta = $info['Diedes'];
		$dieta->historia = $info['Dikhis'];
		$dieta->ingreso = $info['Diking'];
		$dieta->fechaKardex = $info['Dikfec'];
		$dieta->estado = $info['Dikest'];

		$cont1++;

		$coleccion[] = $dieta;
	}

	return $coleccion;
}

function consultarEsquemaInsulina($historia,$ingreso,$fecha){
	global $wbasedato;
	global $conex;

	$q = "SELECT
			Infade, Inffde, Infcde
		FROM 
		{$wbasedato}_000070
		WHERE
			Infhis = '$historia' 
			AND Infing = '$ingreso'
			AND Inffec = '$fecha'
		;";

		$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
		$num = mysql_num_rows($res);

		$cont1 = 0;
		$registro = new ArticuloDTO();

		if($num > 0)
		{
			$info = mysql_fetch_array($res);

			$registro->codigo = $info['Infade'];
			$registro->frecuencia = $info['Inffde'];
			$registro->codEsquema = $info['Infcde'];

			$cont1++;
		}

		return $registro;
}

function consultarIntervalosDextrometer($historia,$ingreso,$fecha){
	global $wbasedato;
	global $conex;

	$q = "SELECT
			Indime,Indima,Inddos,Indudo,Indobs,Indvia  
		FROM 
			".$wbasedato."_000071
		WHERE
			Indhis = '$historia'
			AND Inding = '$ingreso'
			AND Indfec = '$fecha'
			AND Indest != 'off'
		ORDER BY
			Indime ASC;";

	$coleccion = array();

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$cont1 = 0;
	while($cont1 < $num)
	{
		$info = mysql_fetch_array($res);

		$registro = new IntervaloDextrometerDTO();

		$registro->minimo = $info['Indime'];
		$registro->maximo = $info['Indima'];
		$registro->dosis = $info['Inddos'];
		$registro->unidadDosis = $info['Indudo'];
		$registro->observaciones = $info['Indobs'];
		$registro->via = $info['Indvia'];

		$cont1++;

		$coleccion[] = $registro;
	}

	return $coleccion;
}


function consultarUnidadesMedida(){
	global $wbasedato;
	global $conex;

	$q = "SELECT
			Unicod, Unides
		FROM 
			".$wbasedato."_000027
		WHERE
			Uniest = 'on'
		ORDER BY Unicod
		;";

	$coleccion = array();

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$cont1 = 0;
	while($cont1 < $num)
	{
		$info = mysql_fetch_array($res);

		$unidad = new RegistroGenericoDTO();

		$unidad->codigo = $info['Unicod'];
		$unidad->descripcion = $info['Unides'];

		$cont1++;

		$coleccion[] = $unidad;
	}

	return $coleccion;
}

function consultarViasAdministracion(){
	global $wbasedato;
	global $conex;

	$q = "SELECT
			Viacod, Viades 
		FROM 
			".$wbasedato."_000040		
		ORDER BY
			Viades ASC;";

	$coleccion = array();

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$cont1 = 0;
	while($cont1 < $num)
	{
		$info = mysql_fetch_array($res);

		$via = new RegistroGenericoDTO();

		$via->codigo = $info['Viacod'];
		$via->descripcion = $info['Viades'];

		$cont1++;

		$coleccion[] = $via;
	}

	return $coleccion;
}

function consultarFormasFarmaceuticas(){
	global $wbasedato;
	global $conex;

	$q = "SELECT
			Ffacod, Ffanom 
		FROM 
			".$wbasedato."_000046
		ORDER BY 
			Ffanom
		;";

	$coleccion = array();

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$cont1 = 0;
	while($cont1 < $num)
	{
		$info = mysql_fetch_array($res);

		$via = new RegistroGenericoDTO();

		$via->codigo = trim($info['Ffacod']);
		$via->descripcion = trim($info['Ffanom']);

		$cont1++;

		$coleccion[] = $via;
	}

	return $coleccion;
}

function consultarPeriodicidades( $tipo = 'C' ){
	global $wbasedato;
	global $conex;

	$q = "SELECT
			Percod, Percan, Peruni, Perequ, Perdma, Percon, Pertip
		FROM 
			".$wbasedato."_000043
		WHERE Pertip = '".$tipo."'
		  AND Perest = 'on'
	;";

	$coleccion = array();

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$cont1 = 0;
	while($cont1 < $num)
	{
		$info = mysql_fetch_array($res);

		$reg = new PeriodicidadDTO();

		$reg->codigo = $info['Percod'];
		
		if( $tipo == 'I' ){
			$reg->descripcion = strtoupper($info['Peruni']);
		}
		else{
			$reg->descripcion = $info['Percan']." - ".strtoupper($info['Peruni'])."(S)";
		}
		
		$reg->equivalencia = $info['Perequ'];
		$reg->dosisMax = trim( $info['Perdma'] );
		$reg->condicion = trim( $info['Percon'] );
		
		//Actualmente se manejan dos tipos
		//C - Corriento
		//I - Insulina, frecuencia que se pone en el dextrometer
		$reg->tipo = trim( $info['Pertip'] );
		$reg->esTipoInsulina = $reg->tipo == 'I' ? true: false;
		$reg->esTipoCorriente = $reg->tipo == 'C' ? true: false;

		$cont1++;

		$coleccion[] = $reg;
	}

	return $coleccion;
}

function puedeCambiarEstado() {
	
	global $conex;
	global $usuario;
	global $wbasedato;

	$q = "SELECT
			Reerol
		FROM 
			{$wbasedato}_000162
		WHERE
			Reerol = '".$usuario->codigoRolHCE."';";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if($num>0)
		return true;
	else
		return false;

}

function consultarDescripcionEstado($estadoActual) {
	global $wbasedato;
	global $conex;
	
	$q = "SELECT Eexdes
		    FROM {$wbasedato}_000045
		   WHERE Eexcod = '".$estadoActual."';";
	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$info = mysql_fetch_array($res);
		
	return $info['Eexdes'];
}

function consultarEstadosExamenes(){
	global $wbasedato;
	global $conex;
	global $usuario;
	$coleccion = array();
	
	$usuario->codigoRolHCE;
	$q = "SELECT Eexcod,Eexdes
		    FROM {$wbasedato}_000045
		   WHERE Eexest = 'on'
		     AND Eexord = 'on'";
	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$cont1 = 0;
	while($cont1 < $num)
	{
		$info = mysql_fetch_array($res);

		$reg = new RegistroGenericoDTO();

		$reg->codigo = $info['Eexcod'];
		$reg->descripcion = $info['Eexdes'];

		$cont1++;

		$coleccion[] = $reg;
	}

	return $coleccion;
}

//Busca los estados de los examenes activos para la enfermera.
function estados_por_rol_enf(){
	
	global $wbasedato;
	global $conex;
	global $usuario;
	global $wemp_pmla;
	
	$whce = consultarAliasPorAplicacion($conex, $wemp_pmla, 'hce');
	
	$coleccion_estados = array();
	
	$dato_rol = $usuario->codigoRolHCE;
	
	$q = "SELECT *
		    FROM {$wbasedato}_000045, {$whce}_000019
		   WHERE Eexest = 'on'
		     AND Eexord = 'on'
			 AND Eexenf = Rolenf 
			 AND Rolcod = '".$dato_rol."'";
	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	
	while($info = mysql_fetch_assoc($res))
	{
		if(!array_key_exists($info['Eexcod'], $coleccion_estados)){
			
			$coleccion_estados[$info['Eexcod']] = $info;
		}

	}

	return $coleccion_estados;
}

function consultarEstadosAyudasDx(){
	global $wbasedato;
	global $conex;

	$coleccion = array();
	
	$q = "SELECT Eexcod,Eexdes,Eexcpe,Eexcan,Eexrea,Eexpen
		    FROM ".$wbasedato."_000045
		   WHERE Eexord = 'on'
		     AND Eexest = 'on'";
	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$cont1 = 0;
	while($cont1 < $num)
	{
		$info = mysql_fetch_array($res);

		$reg = new RegistroGenericoDTO();

		$reg->codigo = $info['Eexcod'];
		$reg->descripcion = $info['Eexdes'];
		$reg->codigo_permiso = $info['Eexcpe'];
		$reg->esCancelado = strtolower( $info['Eexcan'] ) == 'on';
		$reg->esRealizado = strtolower( $info['Eexrea'] ) == 'on';
		$reg->esPendiente = strtolower( $info['Eexpen'] ) == 'on';

		$cont1++;

		$coleccion[] = $reg;
	}

	return $coleccion;
}



// function consultarEstadosExamenesRol(){
	// global $wbasedato;
	// global $conex;
	// global $usuario;
	
	// $usuario->codigoRolHCE;
	// $q = "SELECT
			// Esecod,Esedes
		// FROM 
			// {$wbasedato}_000161, {$wbasedato}_000162
		// WHERE
			// Esecod = Reecod
		// AND Reerol = '".$usuario->codigoRolHCE."';";

	// $coleccion = array();

	// $res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	// $num = mysql_num_rows($res);

	// $cont1 = 0;
	// while($cont1 < $num)
	// {
		// $info = mysql_fetch_array($res);

		// $reg = new RegistroGenericoDTO();

		// $reg->codigo = $info['Esecod'];
		// $reg->descripcion = $info['Esedes'];

		// $cont1++;

		// $coleccion[] = $reg;
	// }

	// return $coleccion;
// }

function consultarEstadosExamenesLaboratorio(){
	global $wbasedato;
	global $conex;
	
	$coleccion = array();
	
	$q = "SELECT Eexcod,Eexdes
		    FROM ".$wbasedato."_000045
		   WHERE Eexest = 'on' ";
	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$cont1 = 0;
	while($cont1 < $num)
	{
		$info = mysql_fetch_array($res);

		$reg = new RegistroGenericoDTO();

		$reg->codigo = $info['Eexcod'];
		$reg->descripcion = $info['Eexdes'];

		$cont1++;

		$coleccion[] = $reg;
	}

	return $coleccion;
}

// function consultarEstadosDetalleOrdenes(){
	// global $wbasedato;
	// global $conex;
	// global $wbasedatohce;

	// $q = "SELECT
			// Detesi
		// FROM 
			// ".$wbasedatohce."_000028
		// GROUP BY Detesi;";

	// $coleccion = array();

	// $res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	// $num = mysql_num_rows($res);

	// $cont1 = 0;
	// while($cont1 < $num)
	// {
		// $info = mysql_fetch_array($res);

		// $reg = new RegistroEstadoDet();

		// $reg->estado = $info['Detesi'];

		// $cont1++;

		// $coleccion[] = $reg;
	// }

	// return $coleccion;
// }

function consultarExamenesLaboratorio(){
	global $wbasedato;
	global $conex;

	$q = "SELECT
			Ccocod,Cconom 
		FROM 
			".$wbasedato."_000011
		WHERE 
			Ccoest = 'on'
			AND Ccoayu = 'on';";

	$coleccion = array();

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$cont1 = 0;
	while($cont1 < $num)
	{
		$info = mysql_fetch_array($res);

		$reg = new RegistroGenericoDTO();

		$reg->codigo = $info['Ccocod'];
		$reg->descripcion = $info['Cconom'];

		$cont1++;

		$coleccion[] = $reg;
	}
	return $coleccion;
}

function consultarCentrosAyudasDiagnosticas($wbasedatohce, $historia="",$ingreso=""){
	global $wbasedato;
	global $conex;
		
	$coleccion = array();
	
	if($historia!="" && $ingreso!="")
	{
		$q = "SELECT Codigo as Ccocod, Descripcion as Cconom, '' as Ccocor
			    FROM ".$wbasedatohce."_000027, ".$wbasedatohce."_000015
			   WHERE Codigo = Ordtor 
				 AND Ordhis = '".$historia."'  				
				 AND Ording = '".$ingreso."' 				
				 AND Ordest = 'on' 
			GROUP BY Codigo 			
			ORDER BY Descripcion ";	
	}
	else
	{
		$q = "SELECT
				Ccocod,Cconom,Ccocor
			FROM 
				".$wbasedato."_000011
			WHERE 
				Ccoest = 'on'
				AND Ccoayu = 'on';";
	}
	
	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$cont1 = 0;
	while($cont1 < $num)
	{
		$info = mysql_fetch_array($res);

		$reg = new CentroCostosOrdenesDTO();

		$reg->codigo = $info['Ccocod'];
		$reg->nombre = $info['Cconom'];
		$reg->consecutivoOrden = $info['Ccocor'];

		$cont1++;

		$coleccion[] = $reg;
	}
	return $coleccion;
}

function consultarCentrosCostosActivos(){
	global $wbasedato;
	global $conex;

	$q = "SELECT
			Ccocod,Cconom 
		FROM 
			".$wbasedato."_000011
		WHERE 
			Ccoest = 'on';";

	$coleccion = array();

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$cont1 = 0;
	while($cont1 < $num)
	{
		$info = mysql_fetch_array($res);

		$reg = new RegistroGenericoDTO();

		$reg->codigo = $info['Ccocod'];
		$reg->descripcion = $info['Cconom'];

		$cont1++;

		$coleccion[] = $reg;
	}
	return $coleccion;
}

function consultarCondicionesSuministroMedicamentos($tipo){
	global $wbasedato;
	global $conex;

	switch ($tipo){
		case 'I':
			$q = "SELECT Concod,condes,Condma,Conpdm,Conpdt,Conpdv 
			        FROM ".$wbasedato."_000042 
				   WHERE Contip = '$tipo' 
				     AND conest = 'on' 
				ORDER BY Condes;";
			break;
		default:
			$q = "SELECT Concod,condes,Condma,Conpdm,Conpdt,Conpdv 
			        FROM ".$wbasedato."_000042 
				   WHERE Contip != 'I' 
				     AND conest = 'on' 
				ORDER BY Condes;";
			break;
	}

	$coleccion = array();

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$cont1 = 0;
	while($cont1 < $num)
	{
		$info = mysql_fetch_array($res);

		$reg = new CondicionesDTO();

		$reg->codigo = $info['Concod'];
		$reg->descripcion = $info['condes'];
		
		$reg->valDefecto = trim( $info['Condma'] );	//Junio 13 de 2012
		$reg->permiteDma = $info['Conpdm'] == 'on' ? true: false;	//Febrero 17 de 2015
		$reg->permiteDtt = $info['Conpdt'] == 'on' ? true: false;	//Febrero 17 de 2015
		$reg->esANEC = ( strtoupper( $info['Contip'] ) == "AN" )? true: false;	//Febrero 17 de 2015
		$reg->permiteDva = ( $info['Conpdv'] == "on" )? true: false;	//Febrero 17 de 2015

		//Si no permite dosis máxima, entonces si la condición tiene por defecto dosis máxima se desactiva
		if( !$reg->permiteDma ){
			$reg->valDefecto = '';
		}
		
		
		$cont1++;

		$coleccion[] = $reg;
	}
	return $coleccion;
}

/**
 * Listado de medicos del sistema
 *
 */
function consultarMedicos(){
	global $wbasedato;
	global $conex;

	$coleccion = array();

	$q = "SELECT Meddoc, Medtdo, Medno1, Medno2, Medap1, Medap2, Medreg, Medtel, Meduma, Medesp, a.id  
			FROM ".$wbasedato."_000048 a,".$wbasedato."_000065 
		   WHERE Medest='on'
			 AND Meduma != ''
			 AND Meduma != 'NO APLICA'
			 AND Esmtdo=Medtdo
			 AND Esmndo=Meddoc
		GROUP BY Meddoc, Medtdo
		ORDER BY Medap1, Medno1;";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if ($num > 0)
	{
		$cont1 = 0;
		while ($cont1 < $num){
			$cont1++;
				
			$medico = new medicoDTO();
				
			$info = mysql_fetch_array($res);

			$medico->tipoDocumento = $info['Medtdo'];
			$medico->numeroDocumento = $info['Meddoc'];
			$medico->nombre1 = $info['Medno1'];
			$medico->nombre2 = $info['Medno2'];
			$medico->apellido1 = $info['Medap1'];
			$medico->apellido2 = $info['Medap2'];
			$medico->registroMedico = $info['Medreg'];
			$medico->telefono = $info['Medtel'];
			$medico->codigoEspecialidad = $info['Medesp'];
			$medico->usuarioMatrix = $info['Meduma'];
			$medico->id = $info['id'];
				
			$coleccion[] = $medico;
				
		}
	}
	return $coleccion;
}


function consultarEspecialidadesUsuarios(){

	global $wbasedato;
	global $conex;
	$coleccion = array();
   
	$q = " SELECT Meduma, Espcod, Espnom 
			 FROM ".$wbasedato."_000044,".$wbasedato."_000065,".$wbasedato."_000048
			WHERE Esmcod=Espcod
			  AND Medtdo=Esmtdo
			  AND Meddoc=Esmndo
			  AND Medest='on'
			  AND Meduma != ''   
			  AND Meduma IS NOT NULL
		 ORDER BY Espnom;";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if ($num > 0)
	{
		$cont1 = 0;
		while ($cont1 < $num){
			$cont1++;
				
			$registro = new RegistroGenericoDTO();
				
			$info = mysql_fetch_array($res);

			$registro->codigo = $info['Meduma'];
			$registro->descripcion = $info['Espnom'];
				
			$coleccion[] = $registro;
		}
	}
	return $coleccion;
}

function consultarEspecialidades(){

	global $wbasedato;
	global $conex;
	$coleccion = array();

	$q = "SELECT
			Espcod, Espnom
		FROM 
			".$wbasedato."_000044
		ORDER BY Espnom";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if ($num > 0)
	{
		$cont1 = 0;
		while ($cont1 < $num){
			$cont1++;
				
			$registro = new RegistroGenericoDTO();
				
			$info = mysql_fetch_array($res);

			$registro->codigo = $info['Espcod'];
			$registro->descripcion = $info['Espnom'];
				
			$coleccion[] = $registro;
		}
	}
	return $coleccion;
}
/**
 * Consulta los articulos especiales del kardex.
 *
 * Indica tipos de articulos para las secciones del kardex, este maestro es por articulo y no fue incluido en fracciones por articulo movhos_000058 debido a que
 * un articulo por centro de costos puede ser de varios tipos, en caso de que un grupo completo sea de un tipo dado, ya existe el maestro de grupos por tipo
 *
 * I : Insulina
 *
 * @param $centroCostos
 * @param $tipo
 * @return unknown_type
 */
function consultarArticulosEspeciales($centroCostos,$tipo){
	global $wbasedato;
	global $wcenmez;
	global $conex;
	global $centroCostosServicioFarmaceutico;

	$coleccion = array();

	if(empty($centroCostos)){
		$centroCostos = "%";
	}
	 
	$q = "SELECT
			Arkcod, Arkest, Arkcco, Arktip, Artcom as Nombre, Defvia, Deffru
		FROM 
			".$wbasedato."_000068 a, ".$wbasedato."_000059 b, ".$wbasedato."_000026 c
		WHERE
			Arkest = 'on'
			AND Arkcco LIKE '$centroCostos'
			AND Arktip = '$tipo'
			AND Defcco = Arkcco
			AND Defart = Arkcod
			AND Defest = 'on'
			AND Artcod = Defart
			AND Artest = 'on'
		UNION
		SELECT
			Arkcod, Arkest, Arkcco, Arktip, Artcom as Nombre, Defvia, Deffru
		FROM 
			".$wbasedato."_000068 a, ".$wbasedato."_000059 b, ".$wcenmez."_000002 c, ".$wcenmez."_000001 d
		WHERE
			Arkest = 'on'
			AND Arkcco LIKE '$centroCostos'
			AND Arktip = '$tipo'
			AND Defcco = Arkcco
			AND Defart = Arkcod
			AND Defest = 'on'
			AND Artcod = Defart
			AND Artest = 'on'
			AND Arttip = Tipcod
			AND Tipcdo != 'on'
			";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if ($num > 0)
	{
		$cont1 = 0;
		while ($cont1 < $num){
			$cont1++;
				
			$registro = new ArticuloDTO();
				
			$info = mysql_fetch_array($res);

			$registro->codigo = $info['Arkcod'];
			$registro->centroCostos = $info['Arkcco'];
			$registro->nombre = @$info['Nombre'];
			$registro->tipo = $info['Arktip'];
			
			@$registro->vias = trim( strtoupper( $info['Defvia'] ) );
			@$registro->unidadDeMedida = trim( strtoupper( $info['Deffru'] ) );
				
			$coleccion[] = $registro;
		}
	}
	return $coleccion;
}

function consultarMaestroEsquemasInsulina(){

	global $wbasedato;
	global $conex;

	$coleccion = array();

	$q = "SELECT
			Esdcod, Esdest, Esdime, Esdima, Esddos, Esdudo, Esdobs, Esdvia  
		FROM 
			".$wbasedato."_000069
		WHERE
			Esdest = 'on'
		GROUP BY 
			Esdcod";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if ($num > 0)
	{
		$cont1 = 0;
		while ($cont1 < $num){
			$cont1++;
				
			$registro = new RegistroGenericoDTO();
				
			$info = mysql_fetch_array($res);

			$registro->codigo = $info['Esdcod'];
				
			$coleccion[] = $registro;
		}
	}
	return $coleccion;
}

/*
 * CONSULTA DE DATOS DEMOGRAFICOS DEL PACIENTE A TRAVÉS DE SU DOCUMENTO Y TIPO DE DOCUMENTO DE IDENTIDAD
 */
function consultarInfoPacienteOrdenHCE($tipoDocumento,$nroDocumento){
	global $wbasedato;
	global $conex;
	global $wemp_pmla;
	
	$paciente = new pacienteKardexDTO();

	//Consulta la informacion del paciente con respecto al numero de identificacion y el tipo de documento.
	$q = "SELECT pacno1, pacno2, pacap1, pacap2, pactid, pacced, Ubisac, Ubihac, Ubisan, Ubihan, Ubialp, Ubiald, Ubiptr,
				 d.fecha_data fecha_data, d.hora_data hora_data, Pacnac,
				 Ingres,Ingnre, '' fechaServicio, '' horaServicio, e.Cconom, Orihis, Oriing, e.Ccourg, e.Ccocir, Pacsex,
				 f.Ccocod as Ubiste, e.Ccoayu, f.Cconom as Cconal, f.Ccourg as Ccoual, f.Ccocir as Ccocal, f.Ccoayu as Ccoaal
			FROM root_000036 a, 
				 root_000037 b, 
				 ".$wbasedato."_000016 c, 
				 ".$wbasedato."_000018 d 
	   LEFT JOIN ".$wbasedato."_000011 e
	          ON Ubisac = Ccocod
	   LEFT JOIN ".$wbasedato."_000011 f
			  ON d.Ubiste = f.Ccocod
		   WHERE oriced = pacced
			 AND Ubihis = Orihis
			 AND Ubiing = Oriing
			 AND Inghis = Orihis
			 AND Inging = Oriing
			 AND Oriori = '$wemp_pmla'
			 AND Oritid = Pactid
			 AND Oriced = '$nroDocumento'
			 AND Oritid = '$tipoDocumento';";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if ($num > 0)
	{
		$info = mysql_fetch_array($res);
		
		$paciente->servicioRealActual = $info['Ubisac'];
		$paciente->nombreRealServicioActual = $info['Cconom'];
		
		if( $info['Ubiste'] != NULL && $info['Ccoaal'] == 'on' ){
			$info['Cconom'] = $info['Cconal'];
			$info['Ccourg'] = $info['Ccoual'];
			$info['Ccocir'] = $info['Ccocal'];
			$info['Ccoayu'] = $info['Ccoaal'];
			$info['Ubisac'] = $info['Ubiste'];
		}

		$paciente->historiaClinica = $info['Orihis'];
		$paciente->ingresoHistoriaClinica = $info['Oriing'];
		$paciente->nombre1 = $info['pacno1'];
		$paciente->nombre2 = $info['pacno2'];
		$paciente->apellido1 = $info['pacap1'];
		$paciente->apellido2 = $info['pacap2'];
		$paciente->documentoIdentidad = $info['pacced'];
		$paciente->tipoDocumentoIdentidad = $info['pactid'];
		$paciente->fechaNacimiento = $info['Pacnac'];
		$paciente->servicioActual = $info['Ubisac'];
		$paciente->servicioAnterior = $info['Ubisan'];
		$paciente->habitacionActual = $info['Ubihac'];
		$paciente->habitacionAnterior = $info['Ubihan'];
		$paciente->numeroIdentificacionResponsable = $info['Ingres'];
		$paciente->nombreResponsable = $info['Ingnre'];
		
		//Consulto la fecha y hora de traslado al piso
		$qMv = "SELECT
					".$wbasedato."_000017.Fecha_data,".$wbasedato."_000017.hora_data
				FROM 
					".$wbasedato."_000017, ".$wbasedato."_000011 
				WHERE 
					Eyrhis = '$paciente->historiaClinica' 
					AND Eyring = '$paciente->ingresoHistoriaClinica' 
					AND Eyrtip = 'Recibo'
					AND Ccocod = Eyrsor	
					AND Eyrest='on'
				ORDER BY 1 DESC, 2 DESC";

		$resMv = mysql_query($qMv,$conex) or die ("Error: " . mysql_errno() . " - en el querys: $qMv - " . mysql_error());
		$contMv = mysql_num_rows($resMv);
		
		if( $rowsMv = mysql_fetch_array( $resMv ) ){
			$info['fechaServicio'] = $rowsMv['Fecha_data'];
			$info['horaServicio'] = $rowsMv['hora_data'];
		}

		$paciente->fechaHoraIngresoServicio = $info['fechaServicio']." ".$info['horaServicio'];

		$paciente->fechaIngreso = $info['fecha_data'];
		$paciente->horaIngreso = $info['hora_data'];

		$paciente->altaDefinitiva = $info['Ubiald'];
		$paciente->altaProceso = $info['Ubialp'];
		
		$paciente->sexo = $info['Pacsex'];
		
		$paciente->esDeAyudaDx = ( $info['Ubiste'] != NULL || $info['Ccoayu'] == 'on' || $info['Ccoaal'] == 'on' ) ? true: false;

		$estado = false;
		if($info['Ubiptr'] == 'on'){
			$paciente->ultimoMvtoHospitalario = "En proceso de traslado";
			$estado = true;
		}

		if ($info['Ubialp'] == 'on'){
			$paciente->ultimoMvtoHospitalario = "Alta en proceso";
			$estado = true;
		}

		if ($info['Ubiald'] == 'on') {
			$paciente->ultimoMvtoHospitalario = "Alta definitiva";
			$estado = true;
		}

		if(!$estado){
			$paciente->ultimoMvtoHospitalario = "En habitaci&oacute;n";
		}
		$paciente->nombreServicioActual = $info['Cconom'];
		
		//El paciente se encuentra en cirugia o en urgencias
		$paciente->enCirugia = isset($info['Ccocir']) && $info['Ccocir'] == "on" ? true : false;
		$paciente->enUrgencias = isset($info['Ccourg']) && $info['Ccourg'] == "on" ? true : false;
		
		if( $paciente->enUrgencias ){
			$paciente->habitacionActual = consultaUbicacionPacienteUrgencias( $conex, $wbasedato, $paciente->historiaClinica, $paciente->ingresoHistoriaClinica, $paciente->servicioRealActual );
			
			if( !$paciente->habitacionActual )
				$paciente->habitacionActual = $info['Ubihac'];

		}		

		//Edad
		$ann=(integer)substr($paciente->fechaNacimiento,0,4)*360 +(integer)substr($paciente->fechaNacimiento,5,2)*30 + (integer)substr($paciente->fechaNacimiento,8,2);
		$aa=(integer)date("Y")*360 +(integer)date("m")*30 + (integer)date("d");
		$ann1=($aa - $ann)/360;
		$meses=(($aa - $ann) % 360)/30;
		if ($ann1<1){
			$dias1=(($aa - $ann) % 360) % 30;
			$wedad=(string)(integer)$meses." mes(es) ".(string)$dias1." dia(s)";
			$anos = 0;
		} else {
			$dias1=(($aa - $ann) % 360) % 30;
			$wedad=(string)(integer)$ann1." año(s) ".(string)(integer)$meses." mes(es) ".(string)$dias1." dia(s)";
			$anos = (integer)$ann1;
		}
		$paciente->edadPaciente = $wedad;
		$paciente->anosPaciente = $anos; 		
	}
	return $paciente;
}

function consultarInfoPacienteKardex($whistoria, $ingresoAnterior){
	global $wbasedato;
	global $conex;
	global $wemp_pmla;

	$paciente = new pacienteKardexDTO();

	if(isset($ingresoAnterior) && $ingresoAnterior != ''){
		$ingreso = $ingresoAnterior;
	} else {
		$ingreso = consultarUltimoIngresoHistoria($conex,$whistoria);
	}

	//Informacion del paciente por historia
	$q = "SELECT
			pacno1, pacno2, pacap1, pacap2, pactid, pacced, Ubisac, Ubihac, Ubisan, Ubihan, Ubialp, Ubiald, Ubiptr,
			".$wbasedato."_000018.fecha_data fecha_data, ".$wbasedato."_000018.hora_data hora_data, Pacnac,
			Ingres,Ingnre, '' fechaServicio, '' horaServicio, Cconom, Ccourg, Ccocir
		FROM
			root_000036, root_000037, ".$wbasedato."_000016, ".$wbasedato."_000018 LEFT JOIN ".$wbasedato."_000011 ON Ubisac = Ccocod
		WHERE
			oriced = pacced
			AND Ubihis = Orihis
			AND Ubiing = Oriing
			AND Inghis = Orihis
			AND Inging = Oriing
			AND orihis = '".$whistoria."'
			AND Oriori = '$wemp_pmla';";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if ($num > 0)
	{
		$info = mysql_fetch_array($res);

		$paciente->historiaClinica = $whistoria;
		$paciente->ingresoHistoriaClinica = $ingreso;
		$paciente->nombre1 = $info['pacno1'];
		$paciente->nombre2 = $info['pacno2'];
		$paciente->apellido1 = $info['pacap1'];
		$paciente->apellido2 = $info['pacap2'];
		$paciente->documentoIdentidad = $info['pacced'];
		$paciente->tipoDocumentoIdentidad = $info['pactid'];
		$paciente->fechaNacimiento = $info['Pacnac'];

		$paciente->servicioActual = $info['Ubisac'];
		$paciente->servicioAnterior = $info['Ubisan'];
		$paciente->habitacionActual = $info['Ubihac'];
		$paciente->habitacionAnterior = $info['Ubihan'];
		$paciente->numeroIdentificacionResponsable = $info['Ingres'];
		$paciente->nombreResponsable = $info['Ingnre'];
		
		
		//Consulto la fecha y hora de traslado al piso
		$qMv = "SELECT
					".$wbasedato."_000017.Fecha_data,".$wbasedato."_000017.hora_data
				FROM 
					".$wbasedato."_000017, ".$wbasedato."_000011 
				WHERE 
					Eyrhis = '$paciente->historiaClinica' 
					AND Eyring = '$paciente->ingresoHistoriaClinica' 
					AND Eyrtip = 'Recibo'
					AND Ccocod = Eyrsor	
					AND Eyrest='on'
				ORDER BY 1 DESC, 2 DESC";

		$resMv = mysql_query($qMv,$conex) or die ("Error: " . mysql_errno() . " - en el querys: $qMv - " . mysql_error());
		$contMv = mysql_num_rows($resMv);
		
		if( $rowsMv = mysql_fetch_array( $resMv ) ){
			$info['fechaServicio'] = $rowsMv['Fecha_data'];
			$info['horaServicio'] = $rowsMv['hora_data'];
		}

		$paciente->fechaHoraIngresoServicio = $info['fechaServicio']." ".$info['horaServicio'];

		$paciente->fechaIngreso = $info['fecha_data'];
		$paciente->horaIngreso = $info['hora_data'];

		$paciente->altaDefinitiva = $info['Ubiald'];
		$paciente->altaProceso = $info['Ubialp'];

		$estado = false;
		if($info['Ubiptr'] == 'on'){
			$paciente->ultimoMvtoHospitalario = "En proceso de traslado";
			$estado = true;
		}

		if ($info['Ubialp'] == 'on'){
			$paciente->ultimoMvtoHospitalario = "Alta en proceso";
			$estado = true;
		}

		if ($info['Ubiald'] == 'on') {
			$paciente->ultimoMvtoHospitalario = "Alta definitiva";
			$estado = true;
		}

		if(!$estado){
			$paciente->ultimoMvtoHospitalario = "En habitaci&oacute;n";
		}
		$paciente->nombreServicioActual = $info['Cconom'];

		//El paciente se encuentra en cirugia o en urgencias
		$paciente->enCirugia = isset($info['Ccocir']) && $info['Ccocir'] == "on" ? true : false;
		$paciente->enUrgencias = isset($info['Ccourg']) && $info['Ccourg'] == "on" ? true : false;

		//Edad
		$ann=(integer)substr($paciente->fechaNacimiento,0,4)*360 +(integer)substr($paciente->fechaNacimiento,5,2)*30 + (integer)substr($paciente->fechaNacimiento,8,2);
		$aa=(integer)date("Y")*360 +(integer)date("m")*30 + (integer)date("d");
		$ann1=($aa - $ann)/360;
		$meses=(($aa - $ann) % 360)/30;
		if ($ann1<1){
			$dias1=(($aa - $ann) % 360) % 30;
			$wedad=(string)(integer)$meses." mes(es) ".(string)$dias1." dia(s)";
			$anos = 0;
		} else {
			$dias1=(($aa - $ann) % 360) % 30;
			$wedad=(string)(integer)$ann1." año(s) ".(string)(integer)$meses." mes(es) ".(string)$dias1." dia(s)";
			$anos = (integer)$ann1;
		}
		$paciente->edadPaciente = $wedad;
		$paciente->anosPaciente = $anos; 
	}
	return $paciente;
}

function consultarCentrosCostosHospitalarios(){  
	global $wbasedato;
	global $conex;

	$q = "SELECT
				ccocod, UPPER(Cconom)
			FROM 
				".$wbasedato."_000011
			WHERE  
  				Ccohos = 'on'
			ORDER by 1;";
	 
	$res1 = mysql_query($q,$conex);
	$num1 = mysql_num_rows($res1);
	 
	$coleccion = array();
	 
	if ($num1 > 0 )
	{
		for ($i=1;$i<=$num1;$i++)
		{
			$row1 = mysql_fetch_array($res1);
				
			$consulta = new centroCostosDTO();
				
			$consulta->codigo = $row1[0];
			$consulta->nombre = $row1[1];
				
			$coleccion[] = $consulta;
		}
	}
	return $coleccion;
}

function consultarHabitacionesOcupadasServicio($servicio){
	global $wbasedato;
	global $conex;
	
	$tablaHabitaciones = consultarTablaHabitaciones( $conex, $wbasedato, $servicio );

	$q = "SELECT
				Habcod
			FROM 
				".$tablaHabitaciones."
			WHERE 
  				Habdis = 'off'
  				AND Habest = 'on'
  				AND Habcco = '$servicio'
			ORDER by 1";
	 
	//	echo "Hab:".$q;

	$res1 = mysql_query($q,$conex);
	$num1 = mysql_num_rows($res1);
	 
	$coleccion = array();
	 
	if ($num1 > 0 )
	{
		for ($i=1;$i<=$num1;$i++)
		{
			$row1 = mysql_fetch_array($res1);
				
			$consulta = new habitacionDTO();
				
			$consulta->codigo = $row1[0];
				
			$coleccion[] = $consulta;
		}
	}
	return $coleccion;
}

function consultarMedicosTratantesHCE($whistoria,$wingreso){
	
	global $wbasedato;
	global $conex;
	
	$wfecha = date("Y-m-d");
	
	$q = "SELECT a.id, Mettdo , Metdoc, Medno1, Medno2, Medap1, Medap2, Medreg, Medtel, Metint, Metesp
			FROM ".$wbasedato."_000063 a,".$wbasedato."_000065,".$wbasedato."_000048 
		   WHERE Methis = '".$whistoria."'
			 AND Meting = '".$wingreso."'
			 AND Metfek = '".$wfecha."'
			 AND Metest = 'on'
			 AND Esmtdo=Mettdo
			 AND Esmndo=Metdoc
			 AND Esmcod=Metesp
			 AND Medtdo=Mettdo
			 AND Meddoc=Metdoc
			 AND Medest='on';";

	$coleccion = array();

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$cont1 = 0;
	if($num > 0 ){
		while($cont1 <= $num)
		{
			$info = mysql_fetch_array($res);

			$medico = new medicoDTO();

			$medico->id = $info['id'];

			$medico->tipoDocumento = $info['Mettdo'];
			$medico->numeroDocumento = $info['Metdoc'];

			$medico->nombre1 = $info['Medno1'];
			$medico->nombre2 = $info['Medno2'];
			$medico->apellido1 = $info['Medap1'];
			$medico->apellido2 = $info['Medap2'];

			$medico->registroMedico = $info['Medreg'];
			$medico->telefono = $info['Medtel'];

			$medico->interconsultante = $info['Metint'];
			$medico->codigoEspecialidad = $info['Metesp'];

			$cont1++;

			$coleccion[] = $medico;
		}
	}

	return $coleccion;
	
	
	// global $wbasedato;
	// global $conex;

	// global $esquemaBDHce;

	// //Mtrhis  Mtring  Mtrmed  Mtrest  Medno1  Medno2  Medap1  Medap2
	// $q = "SELECT DISTINCT
			// Mtrmed,Medno1,Medno2,Medap1,Medap2,Mtrtra  
		// FROM 
			// ".$esquemaBDHce."_000022, {$wbasedato}_000048  
		// WHERE
			// Mtrhis = '$whistoria'
			// AND Mtring = '$wingreso'
			// AND Meduma = Mtrmed
			// AND Mtrest = 'on';";
	
	// //Mtrhis  Mtring  Mtrmed  Mtrest  Medno1  Medno2  Medap1  Medap2
	// $q = "SELECT DISTINCT
			// Mtrmed,Medno1,Medno2,Medap1,Medap2,Mtrtra  
		// FROM 
			// ".$esquemaBDHce."_000022, {$wbasedato}_000048  
		// WHERE
			// Mtrhis = '$whistoria'
			// AND Mtring = '$wingreso'
			// AND SUBSTRING_INDEX( Medesp, '-', 1 ) = SUBSTRING_INDEX( Mtrmed ,'-',-1 )
			// AND CONCAT( Medtdo, '-', Meddoc ) = SUBSTRING_INDEX( Mtrmed ,'-',2 )
			// AND Mtrest = 'on';";

	// $coleccion = array();

	// $res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	// $num = mysql_num_rows($res);

	// $cont1 = 0;
	// if($num > 0 ){
		// while($cont1 < $num)
		// {
			// $info = mysql_fetch_array($res);

			// $medico = new medicoDTO();

			// //Mtrhis,Mtring,Mtrmed,Mtrest,Medno1,Medno2,Medap1,Medap2
			// $medico->usuarioMatrix = $info['Mtrmed'];
				
			// $medico->nombre1 = $info['Medno1'];
			// $medico->nombre2 = $info['Medno2'];
			// $medico->apellido1 = $info['Medap1'];
			// $medico->apellido2 = $info['Medap2'];
			// $medico->tratante = $info['Mtrtra'];

			// $cont1++;

			// $coleccion[] = $medico;
		// }
	// }

	// return $coleccion;
}

function consultarMedicosTratantesTemporalKardex($historia, $ingreso, $fecha){
	global $wbasedato;
	global $conex;

	// $q = "SELECT
			// ".$wbasedato."_000048.id, Mettdo , Metdoc, Medno1, Medno2, Medap1, Medap2, Medreg, Medtel, Metint, Metesp
		// FROM 
			// ".$wbasedato."_000063, ".$wbasedato."_000048
		// WHERE
			// Metest = 'on'
			// AND Mettdo = Medtdo
			// AND Meddoc = Metdoc
			// AND Methis = '".$historia."'
			// AND Meting = '".$ingreso."'
			// AND Metfek = '".$fecha."'
			// AND Metesp = SUBSTRING_INDEX(Medesp,'-',1)
			// AND Medest = 'on'
		// ;";

	$q = "SELECT a.id, Mettdo , Metdoc, Medno1, Medno2, Medap1, Medap2, Medreg, Medtel, Metint, Metesp
			FROM ".$wbasedato."_000063 a,".$wbasedato."_000065,".$wbasedato."_000048 
		   WHERE Methis = '".$historia."'
			 AND Meting = '".$ingreso."'
			 AND Metfek = '".$fecha."'
			 AND Metest = 'on'
			 AND Esmtdo=Mettdo
			 AND Esmndo=Metdoc
			 AND Esmcod=Metesp
			 AND Medtdo=Mettdo
			 AND Meddoc=Metdoc
			 AND Medest='on';";	
		
	$coleccion = array();

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$cont1 = 0;
	if($num > 0 ){
		while($cont1 <= $num)
		{
			$info = mysql_fetch_array($res);

			$medico = new medicoDTO();

			$medico->id = $info['id'];

			$medico->tipoDocumento = $info['Mettdo'];
			$medico->numeroDocumento = $info['Metdoc'];

			$medico->nombre1 = $info['Medno1'];
			$medico->nombre2 = $info['Medno2'];
			$medico->apellido1 = $info['Medap1'];
			$medico->apellido2 = $info['Medap2'];

			$medico->registroMedico = $info['Medreg'];
			$medico->telefono = $info['Medtel'];
				
			$medico->interconsultante = $info['Metint'];
			$medico->codigoEspecialidad = $info['Metesp'];

			$cont1++;

			$coleccion[] = $medico;
		}
	}

	return $coleccion;
}

function consultarMedicosTratantesDefinitivoKardex($historia, $ingreso, $fecha){
	global $wbasedato;
	global $conex;

	// $q = "SELECT
			// ".$wbasedato."_000048.id, Mettdo , Metdoc, Medno1, Medno2, Medap1, Medap2, Medreg, Medtel, Metint, Metesp
		// FROM 
			// ".$wbasedato."_000047, ".$wbasedato."_000048
		// WHERE
			// Metest = 'on'
			// AND Mettdo = Medtdo
			// AND Meddoc = Metdoc
			// AND Methis = '".$historia."'
			// AND Meting = '".$ingreso."'
			// AND Metfek = '".$fecha."'
			// AND Metesp = SUBSTRING_INDEX(Medesp,'-',1)
			// AND Medest = 'on'
		// ;";
	
	$q = "SELECT a.id, Mettdo , Metdoc, Medno1, Medno2, Medap1, Medap2, Medreg, Medtel, Metint, Metesp
			FROM ".$wbasedato."_000047 a,".$wbasedato."_000065,".$wbasedato."_000048 
		   WHERE Methis = '".$historia."'
			 AND Meting = '".$ingreso."'
			 AND Metfek = '".$fecha."'
			 AND Metest = 'on'
			 AND Esmtdo=Mettdo
			 AND Esmndo=Metdoc
			 AND Esmcod=Metesp
			 AND Medtdo=Mettdo
			 AND Meddoc=Metdoc
			 AND Medest='on';";

	$coleccion = array();

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$cont1 = 0;
	while($cont1 <= $num)
	{
		$info = mysql_fetch_array($res);

		$medico = new medicoDTO();

		$medico->id = $info['id'];

		$medico->tipoDocumento = $info['Mettdo'];
		$medico->numeroDocumento = $info['Metdoc'];

		$medico->nombre1 = $info['Medno1'];
		$medico->nombre2 = $info['Medno2'];
		$medico->apellido1 = $info['Medap1'];
		$medico->apellido2 = $info['Medap2'];

		$medico->registroMedico = $info['Medreg'];
		$medico->telefono = $info['Medtel'];
		$medico->interconsultante = $info['Metint'];
		$medico->codigoEspecialidad = $info['Metesp'];

		$cont1++;

		$coleccion[] = $medico;
	}

	return $coleccion;
}

function consultarDietas(){
	global $wbasedato;
	global $conex;

	$q = "SELECT
				Diecod, UPPER(Diedes)
			FROM 
				".$wbasedato."_000041
			WHERE  
  				Dieest = 'on'
			ORDER by 1;";
	 
	$res1 = mysql_query($q,$conex);
	$num1 = mysql_num_rows($res1);
	 
	$coleccion = array();
	 
	if ($num1 > 0 )
	{
		for ($i=1;$i<=$num1;$i++)
		{
			$row1 = mysql_fetch_array($res1);
				
			$consulta = new DietaDTO();
				
			$consulta->codigo = $row1[0];
			$consulta->descripcion = $row1[1];
				
			$coleccion[] = $consulta;
		}
	}
	return $coleccion;
}

/**
 * Verifica si el encabezado del kardex existe o no
 *
 * @param unknown_type $conex
 * @param unknown_type $kardexGrabar
 */
function existeEncabezadoKardex($historia,$ingreso,$fecha){
	global $wbasedato;
	global $conex;
	global $usuario;

	$existe = false;

	//Consulta el kardex del dia seleccionado, si es diferente al dia actual sera de consulta
	$q = "SELECT * FROM
			".$wbasedato."_000053
		WHERE
			Karest = 'on'
			AND Fecha_data = '".$fecha."' 
			AND Karhis = '".$historia."'
			AND Karing = '".$ingreso."'
			AND Karcco = '$usuario->centroCostosGrabacion';";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if($num > 0){
		$existe = true;
	}
	return $existe;
}

/************************************************************************************
 * Busco la hora de creación del kardex y devuelvo los datos del encabezado, el mas 
 * antiguo de los encabezado en caso de tener varios.  Si tiene encabezado la función
 * retorna verdadero, de lo contrario retorna falso
 *
 * @param unknown_type $conex
 * @param unknown_type $kardexGrabar
 * 
 * Enero 14 de 2011
 ************************************************************************************/
function existeEncabezadoKardexSinCco($wbasedato,$conex,$historia,$ingreso,$fecha, &$datos ){
	
	$existe = false;

	//Consulta el kardex del dia seleccionado, si es diferente al dia actual sera de consulta
	$q = "SELECT *
		   	FROM ".$wbasedato."_000053
		  WHERE Karest = 'on'
		    AND Karhis = '".$historia."'
		    AND Karing = '".$ingreso."'
		    AND Fecha_data = '$fecha'
		  ORDER BY
		  	hora_data asc
		";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if($num > 0){
		
		$datos = mysql_fetch_array( $res );
		$existe = true;
	}

	return $existe;
}

function marcarGrabacionKardex($historia,$ingresoHistoria,$wfecha,$estado){
	global $wbasedato;
	global $conex;

	global $usuario;		//Información de usuario

	$marcado = false;
	$q = "UPDATE ".$wbasedato."_000053 SET
				Kargra = '$estado',
				Karusu = '$usuario->codigo'
			WHERE 
				Fecha_data = '$wfecha'
				AND Karhis = '$historia'
				AND Karing = '$ingresoHistoria'
				";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	if(mysql_affected_rows() > 0){
		$marcado = true;
	}
	return $marcado;
}

function marcarAprobacionRegente($wbasedato,$historia,$ingresoHistoria,$wfecha,$estado,$usuario){
	$conexion = obtenerConexionBD("matrix");

	$marcado = "1";

	$q = "UPDATE ".$wbasedato."_000053 SET
				Karare = '$estado'
			WHERE 
				Fecha_data = '$wfecha'
				AND Karhis = '$historia'
				AND Karing  = '$ingresoHistoria'";

	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

	//Registro de auditoria de kardex
	$auditoria = new AuditoriaDTO();

	$auditoria->historia = $historia;
	$auditoria->ingreso = $ingresoHistoria;
	$auditoria->descripcion = "-";
	$auditoria->fechaKardex = $wfecha;
	if($estado == "on"){
		$auditoria->mensaje = obtenerMensaje('MSJ_KARDEX_DESAPROBADO');
	} else {
		$auditoria->mensaje = obtenerMensaje('MSJ_KARDEX_APROBADO');
	}
	$auditoria->seguridad = $usuario;

	registrarAuditoriaKardex($conexion,$wbasedato,$auditoria);

	return $marcado;
}

function crearEncabezadoKardexAnterior($historia,$ingreso,$fecha){
	global $wbasedato;
	global $conex;

	global $usuario;		//Información de usuario

	$creado = false;

	//Consulta el kardex del dia seleccionado, si es diferente al dia actual sera de consulta Karmeg,
	$q = "INSERT INTO {$wbasedato}_000053 (Medico,Fecha_data,Hora_data,Karhis,Karing,Karobs,Karest,Kardia,Karrut,Kartal,Karpes,Karale,Karcui,Karter,Karcon,Karson,Karcur,Karint,Kardec,Kardie,Kardem,Karcip,Kartef,Karrec,Kargra,Karanp,Karais,Karare,Karcco,Karusu,Karfir,Karpal,Karmez,Seguridad)
				SELECT 
			Medico,'$fecha',Hora_data,Karhis,Karing,Karobs,Karest,Kardia,Karrut,Kartal,Karpes,Karale,Karcui,Karter,Karcon,Karson,Karcur,Karint,Kardec,Kardie,Kardem,Karcip,Kartef,Karrec,Kargra,Karanp,Karais,Karare,Karcco,'$usuario->codigo','',Karpal,Karmez,Seguridad
		FROM 
			".$wbasedato."_000053
		WHERE
			Karest = 'on'
			AND Fecha_data = DATE_ADD('".$fecha."', INTERVAL -1 DAY) 
			AND Karhis = '".$historia."'
			AND Karing = '".$ingreso."'
			AND Karcco = '$usuario->centroCostosGrabacion';";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

	if(mysql_affected_rows() > 0){
		$creado = true;
	}
	return $creado;
}

function grabadoEncabezadoKardexFecha($historia,$ingreso,$fecha){
	global $wbasedato;
	global $conex;
	global $usuario;		//Información de usuario

	$grabado = false;

	//Consulta el kardex del dia seleccionado, si es diferente al dia actual sera de consulta
	$q = "SELECT
			Kargra
		FROM 
			".$wbasedato."_000053
		WHERE
			Karest = 'on'
			AND Fecha_data = '".$fecha."' 
			AND Karhis = '".$historia."'
			AND Karing = '".$ingreso."'
			AND Karcco = '".$usuario->centroCostosGrabacion."';";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$fila = mysql_fetch_array($res);
	$num = mysql_num_rows($res);

	if($fila['Kargra'] == 'on'){
		$grabado = true;
	}
	return $grabado;
}

/**
 * Consulta el kardex para su modificacion (actual) o si no se encuentra el actual para su creación .
 *
 * Reglas:
 *
 * 1. Si se ingresa una fecha de consulta diferente a la fecha presente y ademas antes del dia anterior a la fecha actual, el kardex
 * será solo de consulta.
 * 2. Si se ingresa una fecha de consulta del dia actual, se consultará el kardex del dia y si no se encuentra se traerá el del dia anterior
 * para modificación.
 *
 * (2010-06-03):> 3. El kardex ahora diferencia los centros de costos, se discrimina el centro de costos de acuerdo a root_000025
 *
 * @param unknown_type $wfecha
 * @param unknown_type $paciente
 * @return unknown
 */
function consultarKardexPorFechaPaciente($wfecha, $paciente){
	global $wbasedato;
	global $conex;

	global $usuario;			//Usuario que ingresa al kardex

	$kardex = new kardexDTO();

	$kardex->editable = false;
	$kardex->esAnterior = false;
	$kardex->esPrimerKardex = true;
	
	$esFechaActual = ($wfecha == date("Y-m-d"));

	//Consulta el kardex del dia seleccionado, pero con el cco de costos no correspondiente al usuario
	//Esto para lugo mirar que el no este abierto por otra personar
	$qOtr = "SELECT
				Fecha_data,Hora_data,Karhis,Karing,Karobs,Karest,Kardia,Karrut,Kartal,Karpes,Karale,Karcui,Karter,Karcon,Karson,Karcur,Karint,Kardec,Kardie,Kardem,Karcip,Kartef,Karrec,Kargra,Karanp,Karais,Karare,Karcco,Karusu,Karmeg,Karprc
			FROM 
				".$wbasedato."_000053
			WHERE
				Karest = 'on'
				AND Fecha_data = '".$wfecha."' 
				AND Karhis = '".$paciente->historiaClinica."'
				AND Karing = '".$paciente->ingresoHistoriaClinica."'
				AND Karcco != '$usuario->centroCostosGrabacion'
				AND Kargra != 'on'
				AND TRIM(karcco) != '';";
			
	//Consulta el kardex del dia seleccionado, si es diferente al dia actual sera de consulta
	$q = "SELECT
			Fecha_data,Hora_data,Karhis,Karing,Karobs,Karest,Kardia,Karrut,Kartal,Karpes,Karale,Karcui,Karter,Karcon,Karson,Karcur,Karint,Kardec,Kardie,Kardem,Karcip,Kartef,Karrec,Kargra,Karanp,Karais,Karare,Karcco,Karusu,Karmeg,Karprc
		FROM 
			".$wbasedato."_000053
		WHERE
			Karest = 'on'
			AND Fecha_data = '".$wfecha."' 
			AND Karhis = '".$paciente->historiaClinica."'
			AND Karing = '".$paciente->ingresoHistoriaClinica."'
			AND Karcco = '$usuario->centroCostosGrabacion';";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if($num > 0){
		if($esFechaActual){
			$kardex->editable = true;
		}
	}

	//Si se consulta el dia actual y no hay kardex del dia actual se consulta el dia anterior
	if($num == 0 && $esFechaActual){
		
		//Consulta el kardex del dia seleccionado, pero con el cco de costos no correspondiente al usuario
		//Esto para lugo mirar que el no este abierto por otra personar
		$qOtr = "SELECT
				Fecha_data,Hora_data,Karhis,Karing,Karobs,Karest,Kardia,Karrut,Kartal,Karpes,Karale,Karcui,Karter,Karcon,Karson,Karcur,Karint,Kardec,Kardie,Kardem,Karcip,Kartef,Karrec,Kargra,Karanp,Karais,Karare,Karcco,Karusu,Karmeg,Karprc
			FROM 
				".$wbasedato."_000053
			WHERE
				Karest = 'on'
				AND Fecha_data = '".$wfecha."' 
				AND Karhis = '".$paciente->historiaClinica."'
				AND Karing = '".$paciente->ingresoHistoriaClinica."'
				AND Karcco != '$usuario->centroCostosGrabacion'
				AND Kargra != 'on'
				AND TRIM(karcco) != '';";
				
		$q = "SELECT
				Fecha_data,Hora_data,Karhis,Karing,Karobs,Karest,Kardia,Karrut,Kartal,Karpes,Karale,Karcui,Karter,Karcon,Karson,Karcur,Karint,Kardec,Kardie,Kardem,Karcip,Kartef,Karrec,Kargra,Karanp,Karais,Karare,Karcco,Karusu,Karmeg,Karprc
			FROM 
				".$wbasedato."_000053
			WHERE
				Karest = 'on'
				AND Fecha_data = DATE_SUB('".$wfecha."',INTERVAL 1 DAY) 
				AND Karhis = '".$paciente->historiaClinica."'
				AND Karing = '".$paciente->ingresoHistoriaClinica."'
				AND Karcco = '$usuario->centroCostosGrabacion';";

		$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
		$num = mysql_num_rows($res);

		if($num > 0 ){
			if($esFechaActual){
				$kardex->editable = true;
				$kardex->esAnterior = true;
			}
		}
	}

	if ($num > 0){
		$info = mysql_fetch_array($res);

		$kardex->historiaClinica 			= $info['Karhis'];
		$kardex->ingresoHistoriaClinica 	= $info['Karing'];
		$kardex->fechaCreacion 				= $info['Fecha_data'];
		$kardex->horaCreacion 				= $info['Hora_data'];
		$kardex->observaciones 				= $info['Karobs'];
		$kardex->estado 					= $info['Karest'];
		$kardex->diagnostico 				= $info['Kardia'];
		$kardex->rutaOrdenMedica 			= $info['Karrut'];
		$kardex->talla 						= $info['Kartal'];
		$kardex->peso 						= $info['Karpes'];
		$kardex->antecedentesAlergicos 		= $info['Karale'];
		$kardex->cuidadosEnfermeria 		= $info['Karcui'];
		$kardex->terapiaRespiratoria 		= $info['Karter'];
		$kardex->confirmado 				= $info['Karcon'];
		$kardex->sondasCateteres 			= $info['Karson'];
		$kardex->curaciones 				= $info['Karcur'];
		$kardex->interconsulta 				= $info['Karint'];
		$kardex->consentimientos 			= $info['Kardec'];
		$kardex->medidasGenerales 			= $info['Karmeg'];
		$kardex->obsDietas 					= $info['Kardie'];
		$kardex->procedimientos				= $info['Karprc'];
		$kardex->dextrometer 				= $info['Kardem'];
		$kardex->cirugiasPendientes 		= $info['Karcip'];
		$kardex->terapiaFisica 				= $info['Kartef'];
		$kardex->rehabilitacionCardiaca 	= $info['Karrec'];
		$kardex->antecedentesPersonales 	= $info['Karanp'];
		$kardex->aislamientos 				= $info['Karais'];
		$kardex->aprobado 					= $info['Karare'] == 'on' ? true : false;
		$kardex->esPrimerKardex 			= false;
		$kardex->grabado 					= $info['Kargra'];

		$kardex->centroCostos 				= $info['Karcco'];
		
		$q1 = "SELECT CONCAT(Codigo,' - ',Descripcion) Usuario FROM usuarios WHERE Codigo = '{$info['Karusu']}'";
		$res1 = mysql_query($q1, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q1 . " - " . mysql_error());
		$num1 = mysql_num_rows($res1);
		if($num1 > 0){
			$info1 = mysql_fetch_array($res1);
		}
//		$paciente = $info1['Usuario'];

		$kardex->usuarioQueModifica 		= $info['Karusu'];
		$kardex->nombreUsuarioQueModifica	= $info1['Usuario'];
		
		/****************************************************************************************************
		 * Se revisa que el kardex no este abierto por otra persona
		 ****************************************************************************************************/
		//Se revisa que el kardex no este abierto por otra persona
		$resOtr = mysql_query($qOtr, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q1 . " - " . mysql_error());
		
		if( $rowsOtr = mysql_fetch_array( $resOtr ) ){
		
			$kardex->grabado = $rowsOtr['Kargra'];
			
			$q2 = "SELECT CONCAT(Codigo,' - ',Descripcion) Usuario FROM usuarios WHERE Codigo = '{$rowsOtr['Karusu']}'";
			$res2 = mysql_query($q2, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());
			$num2 = mysql_num_rows($res2);
			if($num2 > 0){
				$info2 = mysql_fetch_array($res2);
				$kardex->usuarioQueModifica 		= $rowsOtr['Karusu'];
				$kardex->nombreUsuarioQueModifica	= $info2['Usuario'];
			}
			
		}
		/****************************************************************************************************/
	}
	//****************2010-10-07****Consulto el ultimo movimiento hospitalario
	/*La no acumulacion de saldos depende de lo siguiente:
	 * 0. Los indicadores estan en el objeto paciente y estan marcados como enCirugia y enUrgencias
	 * 1. Si el paciente se encuentra en urgencias o cirugia NO acumula saldos, debido a que no se graba por matrix:
	 * 		Los medicamentos no se envian con el paciente en ninguno de los dos servicios por lo tanto hay un corte en la dispensacion que debe simularse.
	 * 		NOTA:: Cuando el paciente se encuentra en urgencias no hay movimientos en la tabla 17
	 * 2. Si no se encuentra en urgencias o cirugia se debe preguntar por la fecha y hora del ultimo traslado y si el kardex ha sido generado.
	 * 		Si el servicio anterior es urgencias y el encabezado del kardex no ha sido generado consulto
	 */
	$kardex->noAcumulaSaldoDispensacion = false;
	$kardex->descontarDispensaciones = false;

	if($paciente->enCirugia || $paciente->enUrgencias){
		$kardex->noAcumulaSaldoDispensacion = true;
	} else {
		/* El Paciente no esta en urgencias ni en cirugia (Los demás servicios acumulan de saldos de dispensación).
		 * 1. Consulta del traslado del dia anterior.
		 * 2. Consulta si el servicio anterior es de urgencias o cirugia
		 * 3. Consulta de la fecha y hora del ultimo traslado para compararlo con la creación de encabezado de kardex
		 */
		$qMv = "SELECT
						".$wbasedato."_000017.Fecha_data,".$wbasedato."_000017.hora_data,Eyrsor,Eyrsde,Eyrhor,Ccourg,Ccocir,Ccoing 
					FROM 
						".$wbasedato."_000017, ".$wbasedato."_000011 
					WHERE 
						Eyrhis = '$paciente->historiaClinica' 
						AND Eyring = '$paciente->ingresoHistoriaClinica' 
						AND Eyrtip = 'Recibo' 
						AND ".$wbasedato."_000017.Fecha_data = DATE_SUB('".$wfecha."',INTERVAL 1 DAY) 
						AND Ccocod = Eyrsor	
						AND Eyrest='on';";

		$resMv = mysql_query($qMv,$conex) or die ("Error: " . mysql_errno() . " - en el querys: $qMv - " . mysql_error());
		$contMv = mysql_num_rows($resMv);
		if($contMv>0){
			$infoMv = mysql_fetch_array($resMv);
			//Si hubo traslado el dia anterior, se verifica que sea de urgencias o cirugia
			if(isset($infoMv['Ccourg']) && isset($infoMv['Ccocir']) && isset($infoMv['Ccoing']) && ($infoMv['Ccourg'] == "on" || $infoMv['Ccocir'] == "on" || $infoMv['Ccoing'] == "on")){
				//Si el kardex no fue creado en la misma fecha del traslado, no acumula saldo
				if($kardex->fechaCreacion != $wfecha){
					$kardex->descontarDispensaciones = true; 
					$kardex->noAcumulaSaldoDispensacion = true;	
				} else { //Si el kardex fue creado en la misma fecha del traslado, si acumula saldo
					$kardex->noAcumulaSaldoDispensacion = false;
				}
			} //El paciente en el traslado anterior no estuvo en urgencias o cirugia, necesariamente, debe estar en un serv. hospitalario
			$kardex->horaDescuentoDispensaciones = $infoMv['hora_data'];
		} else {
			//Si no hubo traslado el dia anterior consulto posibles traslados en el dia actual
			$qMv = "SELECT
						".$wbasedato."_000017.Fecha_data,".$wbasedato."_000017.hora_data,Eyrsor,Eyrsde,Eyrhor,Ccourg,Ccocir,Ccoing 
					FROM 
						".$wbasedato."_000017, ".$wbasedato."_000011 
					WHERE 
						Eyrhis = '$paciente->historiaClinica' 
						AND Eyring = '$paciente->ingresoHistoriaClinica' 
						AND Eyrtip = 'Recibo' 
						AND ".$wbasedato."_000017.Fecha_data = '".$wfecha."' 
						AND Ccocod = Eyrsor	
						AND Eyrest='on';";

			if($contMv>0){
				$infoMv = mysql_fetch_array($resMv);
				//Si hubo traslado del dia, se verifica que sea de urgencias o cirugia
				if(isset($infoMv['Ccourg']) && isset($infoMv['Ccocir']) && isset($infoMv['Ccoing']) && ($infoMv['Ccourg'] == "on" || $infoMv['Ccocir'] == "on" || $infoMv['Ccoing'] == "on")){
					//Si el kardex no fue creado en la misma fecha del traslado, no acumula saldo
					if($kardex->fechaCreacion != $wfecha){
						$kardex->noAcumulaSaldoDispensacion = false;
					} else { //Si el kardex fue creado en la misma fecha del traslado, si acumula saldo
						$kardex->noAcumulaSaldoDispensacion = true;
					}
				} //El paciente en el traslado anterior no estuvo en urgencias o cirugia, necesariamente, debe estar en un serv. hospitalario
				$kardex->horaDescuentoDispensaciones = $infoMv['hora_data'];
			}
		}
	}
	return $kardex;
}

function crearKardex($kardex){
	global $wbasedato;
	global $conex;
	global $user;
	
	$usuario = consultarUsuarioOrdenes( substr( $user, 2 ) );
	
	//Consulto si el paciente se encuentra en urgencias o cirugia
	$recalcular = 'off';
	if( estaUrgenciaCirugia( $conex, $wbasedato, $kardex->historia,$kardex->ingreso ) ){
		$recalcular = 'on';
	}

	
	$penUsu = $kardex->usuario;
	$penEstado = 'off';
	$penUsuarioLee = $kardex->usuario;
	$penFecha = date( "Y-m-d" );
	$penHora = date( "H:i:s" );
	
	if( !permiteLecturaOrdenesPendientes( $conex, "01", $usuario->codigoRolHCE ) ){
	
		if( empty( $kardexGrabar->medidasGenerales ) || empty( $kardexGrabar->procedimientos ) || empty( $kardexGrabar->terapiaRespiratoria ) || empty( $kardexGrabar->observaciones ) 
			|| empty( $kardexGrabar->curaciones ) || empty( $kardexGrabar->interconsulta ) || empty( $kardexGrabar->sondasCateteres ) || empty( $kardexGrabar->consentimientos ) 
			|| empty( $kardexGrabar->preparacionAlta ) || empty( $kardexGrabar->obsDietas ) || empty( $kardexGrabar->mezclas ) || empty( $kardexGrabar->dextrometer ) 
			|| empty( $kardexGrabar->cirugiasPendientes ) || empty( $kardexGrabar->terapiaFisica ) || empty( $kardexGrabar->rehabilitacionCardiaca ) || empty( $kardexGrabar->aislamientos )
			|| empty( $kardexGrabar->cuidadosEnfermeria )|| empty( $kardexGrabar->observaciones ) 
		){
			$penUsu = $kardex->usuario;
			$penEstado = 'on';
			$penUsuarioLee = '';
			$penFecha = '0000-00-00';
			$penHora = '00:00:00';
		}
	}
	
	$indicaciones_text = sanear_string($kardex->indicaciones);
	
	$q="INSERT INTO
			".$wbasedato."_000053(Medico,Fecha_data,Hora_data,Karhis,Karing,Karobs,Karest,Kardia,Karrut,Kartal,Karpes,Karale,Karcui,Karter,Karcon,Karson,Karcur,Karint,Kardec,Karmeg,Kardie,Karprc,Kardem,Karcip,Kartef,Karrec,Kargra,Karanp,Karais,Karare,Karcco,Karusu,Karfir,Karpal,Karmez,Karrca,Karegr,Karupe,Karpen,Karule,Karfle,Karhle,Karord,Seguridad)
		VALUES
			('movhos','$kardex->fechaCreacion','$kardex->horaCreacion','$kardex->historia','$kardex->ingreso','".mysqli_real_escape_string( $conex, $kardex->observaciones )."','on','".mysqli_real_escape_string( $conex, $kardex->diagnostico )."','$kardex->rutaOrdenMedica','$kardex->talla','$kardex->peso','".mysqli_real_escape_string( $conex, $kardex->antecedentesAlergicos )."','".mysqli_real_escape_string( $conex, $kardex->cuidadosEnfermeria )."','$kardex->terapiaRespiratoria','$kardex->confirmado','".mysqli_real_escape_string( $conex, $kardex->sondasCateteres )."','$kardex->curaciones','$kardex->interconsulta','$kardex->consentimientos','".mysqli_real_escape_string( $conex, $kardex->medidasGenerales )."',
			'$kardex->obsDietas','$kardex->procedimientos','$kardex->dextrometer','$kardex->cirugiasPendientes','$kardex->terapiaFisica','$kardex->rehabilitacionCardiaca','on','".mysqli_real_escape_string( $conex, $kardex->antecedentesPersonales )."','$kardex->aislamientos','off',
			'$kardex->centroCostos','$kardex->usuarioQueModifica','$kardex->firmaDigital','','','$recalcular','$indicaciones_text','$penUsu','$penEstado','$penUsuarioLee','$penFecha','$penHora','on','A-$kardex->usuario');";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

	//Registro de auditoria de kardex
	$auditoria = new AuditoriaDTO();

	$auditoria->historia = $kardex->historia;
	$auditoria->ingreso = $kardex->ingreso;
	$auditoria->descripcion = "-";
	$auditoria->fechaKardex = $kardex->fechaCreacion;

	if(isset($kardex->confirmado) && $kardex->confirmado == "on"){
		$auditoria->descripcion = "Confirmado";
	} else {
		$auditoria->descripcion = "No confirmado";
	}

	$auditoria->mensaje = obtenerMensaje('MSJ_KARDEX_CREADO');
	$auditoria->seguridad = $kardex->usuario;

	registrarAuditoriaKardex($conex,$wbasedato,$auditoria);
	
	
	
	
	$sqlInfAnt = "  SELECT * 
					  FROM ".$wbasedato."_000053
					 WHERE Karhis = '$kardex->historia'
					   AND Karing = '$kardex->ingreso'
					   AND Karcco = '$usuario->centroCostosGrabacion'
					   AND Fecha_data = '".date( "Y-m-d", strtotime( $kardex->fechaCreacion." 00:00:00" ) - 24*3600 )."';";
	
	$resInfAnt = mysql_query( $sqlInfAnt, $conex ) or die( mysql_errno()." - Error en el query $sqlInfAnt - ".mysql_error() );
	$rowsInf = mysql_fetch_array( $resInfAnt );	//Guara la información anterior del kardex
	
	
	//Un array para compara los datos anteriores con el actual
	//La clave del array corresponde al campo a actualizar en el programa de ordenes
	//El valor corresponde a un array donde la primer posición es el nombre del campo en la base de datos y la segunda
	//correspende al valor en la base de datos a actualizar
	$arCompararDatosInf = Array(  "Talla" 					=> Array( "Kartal", $kardex->talla ),
								  "Peso" 					=> Array( "Karpes", $kardex->peso ),
								  "Diagnostico" 			=> Array( "Kardia", $kardex->diagnostico ),
								  "Antecedentes alérgicos" 	=> Array( "Karale", $kardex->antecedentesAlergicos ),
								  "Antecedentes personales" => Array( "Karanp", $kardex->antecedentesPersonales )
								);
	
	//Medidas generales
	$arCompararDatosMG = Array(  "Medidas generales" 			=> Array( "Karmeg", $kardex->medidasGenerales ),
								  "Procedimientos" 				=> Array( "Karprc", $kardex->procedimientos ),
								  "Terapia respiratoria"		=> Array( "Karter", $kardex->terapiaRespiratoria ),
								  "Observaciones" 				=> Array( "Karobs", $kardex->observaciones ),
								  "Curaciones" 					=> Array( "Karcur", $kardex->curaciones ),
								  "Interconsulta" 				=> Array( "Karint", $kardex->interconsulta ),
								  "Sondas, cateteres y drenes" 	=> Array( "Karson", $kardex->sondasCateteres ),
								  "Decisiones" 					=> Array( "Kardec", $kardex->consentimientos ),
								  "Preparacion alta" 			=> Array( "Karpal", $kardex->preparacionAlta ),
								  "Observaciones de dietas"		=> Array( "Kardie", $kardex->obsDietas ),
								  "Mezclas" 					=> Array( "Karmez", $kardex->mezclas ),
								  "Cirugías pendientes" 		=> Array( "Karcip", $kardex->cirugiasPendientes ),
								  "Terapia física" 				=> Array( "Kartef", $kardex->terapiaFisica ),
								  "Rehablitación cardiaca" 		=> Array( "Karrec", $kardex->rehabilitacionCardiaca ),
								  "Aislamientos" 				=> Array( "Karais", $kardex->aislamientos ),
								  "Cuidados de enfermería" 		=> Array( "Karcui", $kardex->cuidadosEnfermeria )
								);
	
	
	//Auditoria para información demográfica
	foreach( $arCompararDatosInf as $key => $value ){
		
		//Solo se guarda si hay alguna diferencia en los campos
		// echo "<br> ".$value[0].": ".$rowsInf[ $value[0] ]." - ".$value[1];
		if( $rowsInf[ $value[0] ] != $value[1] ){	//la comparación es el valor anterior en la base de datos con el valor recien guardado
			// Registro auditoria información demográfica
			$auditoria->mensaje = "Informacion demografica - ".obtenerMensaje('MSJ_KARDEX_ACTUALIZADO');
			$auditoria->descripcion = $key.": ".$value[1];	//Esto es nombre del campo en el programa de ordnes: Valor actualizado
			registrarAuditoriaKardex($conex,$wbasedato,$auditoria);
		}
	}
	
	
	//Auditoria para información demográfica
	foreach( $arCompararDatosMG as $key => $value ){
			
		//Solo se guarda si hay alguna diferencia en los campos
		// echo "<br> ".$value[0].": ".$rowsInf[ $value[0] ]." - ".$value[1];
		if( $rowsInf[ $value[0] ] != $value[1] ){	//la comparación es el valor anterior en la base de datos con el valor recien guardado
			// Registro auditoria información demográfica
			$auditoria->mensaje = "Medidas generales - ".obtenerMensaje('MSJ_KARDEX_ACTUALIZADO');
			$auditoria->descripcion = $key.": ".$value[1];	//Esto es nombre del campo en el programa de ordnes: Valor actualizado
			registrarAuditoriaKardex($conex,$wbasedato,$auditoria);
		}
	}
}

function actualizarKardex($kardexGrabar,$vecPestanas){
	global $wbasedato;
	global $conex;

	global $usuario;		//Información de usuario
	$indicePestana = 1;
	
	$sqlInfAnt = "  SELECT * 
					  FROM ".$wbasedato."_000053
					 WHERE Karhis = '$kardexGrabar->historia'
					   AND Karing = '$kardexGrabar->ingreso'
					   AND Karcco = '$usuario->centroCostosGrabacion'
					   AND Fecha_data = '$kardexGrabar->fechaCreacion';";
	
	$resInfAnt = mysql_query( $sqlInfAnt, $conex ) or die( mysql_errno()." - Error en el query $sqlInfAnt - ".mysql_error() );
	$rowsInf = mysql_fetch_array( $resInfAnt );	//Guara la información anterior del kardex
	
	//Un array para compara los datos anteriores con el actual
	//La clave del array corresponde al campo a actualizar en el programa de ordenes
	//El valor corresponde a un array donde la primer posición es el nombre del campo en la base de datos y la segunda
	//correspende al valor en la base de datos a actualizar
	$arCompararDatosInf = Array(  "Talla" 					=> Array( "Kartal", $kardexGrabar->talla ),
								  "Peso" 					=> Array( "Karpes", $kardexGrabar->peso ),
								  "Diagnostico" 			=> Array( "Kardia", $kardexGrabar->diagnostico ),
								  "Antecedentes alérgicos" 	=> Array( "Karale", $kardexGrabar->antecedentesAlergicos ),
								  "Antecedentes personales" => Array( "Karanp", $kardexGrabar->antecedentesPersonales )
								);
	
	//Medidas generales
	$arCompararDatosMG = Array(  "Medidas generales" 			=> Array( "Karmeg", $kardexGrabar->medidasGenerales ),
								  "Procedimientos" 				=> Array( "Karprc", $kardexGrabar->procedimientos ),
								  "Terapia respiratoria"		=> Array( "Karter", $kardexGrabar->terapiaRespiratoria ),
								  "Observaciones" 				=> Array( "Karobs", $kardexGrabar->observaciones ),
								  "Curaciones" 					=> Array( "Karcur", $kardexGrabar->curaciones ),
								  "Interconsulta" 				=> Array( "Karint", $kardexGrabar->interconsulta ),
								  "Sondas, cateteres y drenes" 	=> Array( "Karson", $kardexGrabar->sondasCateteres ),
								  "Decisiones" 					=> Array( "Kardec", $kardexGrabar->consentimientos ),
								  "Preparacion alta" 			=> Array( "Karpal", $kardexGrabar->preparacionAlta ),
								  "Observaciones de dietas"		=> Array( "Kardie", $kardexGrabar->obsDietas ),
								  "Mezclas" 					=> Array( "Karmez", $kardexGrabar->mezclas ),
								  "Cirugías pendientes" 		=> Array( "Karcip", $kardexGrabar->cirugiasPendientes ),
								  "Terapia física" 				=> Array( "Kartef", $kardexGrabar->terapiaFisica ),
								  "Rehablitación cardiaca" 		=> Array( "Karrec", $kardexGrabar->rehabilitacionCardiaca ),
								  "Aislamientos" 				=> Array( "Karais", $kardexGrabar->aislamientos ),
								  "Cuidados de enfermería" 		=> Array( "Karcui", $kardexGrabar->cuidadosEnfermeria )
								);

	//Verificacion de la fecha actual del sistema
	$esFechaActual = ($kardexGrabar->fechaCreacion == $kardexGrabar->fechaGrabacion);

	//Actualizo los campos del kardex
	$q="UPDATE ".$wbasedato."_000053
		SET
			Kargra = 'on',
			Karord = 'on',
			Karusu = '$usuario->codigo',		
			Karcon = '$kardexGrabar->confirmado',
			Karfir = '$kardexGrabar->firmaDigital'";
	
	if(isset($vecPestanas[$indicePestana]) && $vecPestanas[$indicePestana]){
		$q = $q.",Kartal = '$kardexGrabar->talla',
			Karpes = '$kardexGrabar->peso',
			Kardia = '".mysqli_real_escape_string( $conex, $kardexGrabar->diagnostico )."',
			Karale = '".mysqli_real_escape_string( $conex, $kardexGrabar->antecedentesAlergicos )."',
			Karanp = '".mysqli_real_escape_string( $conex, $kardexGrabar->antecedentesPersonales )."'";
	}


	$indicePestana = 6;
	if(isset($vecPestanas[$indicePestana]) && $vecPestanas[$indicePestana]){
		$q = $q.",Kardem = '$kardexGrabar->dextrometer'";
	}

	$indicePestana = 11;
	if(isset($vecPestanas[$indicePestana]) && $vecPestanas[$indicePestana]){
		$windicaciones_egre = utf8_decode($kardexGrabar->indicaciones);
		
		$indicaciones_text = sanear_string($windicaciones_egre);
		
		$q = $q.",Karegr = '$indicaciones_text'";
	}
	
	$indicePestana = 10;
	if(isset($vecPestanas[$indicePestana]) && $vecPestanas[$indicePestana]){
		$q = $q.",Karmeg = '".mysqli_real_escape_string( $conex, $kardexGrabar->medidasGenerales )."',
			Karprc = '$kardexGrabar->procedimientos',
			Karter = '$kardexGrabar->terapiaRespiratoria',
			Karobs = '".mysqli_real_escape_string( $conex, $kardexGrabar->observaciones )."',
			Karcur = '$kardexGrabar->curaciones',
			Karint = '$kardexGrabar->interconsulta',
			Karson = '".mysqli_real_escape_string( $conex, $kardexGrabar->sondasCateteres )."',
			Kardec = '$kardexGrabar->consentimientos',
			Karpal = '$kardexGrabar->preparacionAlta',
			Kardie = '$kardexGrabar->obsDietas',
			Karmez = '$kardexGrabar->mezclas',
			Karcip = '$kardexGrabar->cirugiasPendientes',
			Kartef = '$kardexGrabar->terapiaFisica',
			Karrec = '$kardexGrabar->rehabilitacionCardiaca',
			Karais = '$kardexGrabar->aislamientos',
			Kardec = '$kardexGrabar->consentimientos',
			Karcui = '".mysqli_real_escape_string( $conex, $kardexGrabar->cuidadosEnfermeria )."'";
			
			//Verifico si cambio algo de las medidas generales
			if( true ){
				
				//Consulto si va a ver algún cambio para estos campos
				$sql = "SELECT *
						FROM ".$wbasedato."_000053
						WHERE
							Karhis = '$kardexGrabar->historia'
							AND Karing = '$kardexGrabar->ingreso'
							AND Karcco = '$usuario->centroCostosGrabacion'
							AND Fecha_data = '$kardexGrabar->fechaCreacion'
							AND Karmeg = '".mysqli_real_escape_string( $conex, $kardexGrabar->medidasGenerales )."'
							AND Karprc = '$kardexGrabar->procedimientos'
							AND Karter = '$kardexGrabar->terapiaRespiratoria'
							AND Karobs = '".mysqli_real_escape_string( $conex, $kardexGrabar->observaciones )."'
							AND Karcur = '$kardexGrabar->curaciones'
							AND Karint = '$kardexGrabar->interconsulta'
							AND Karson = '".mysqli_real_escape_string( $conex, $kardexGrabar->sondasCateteres )."'
							AND Kardec = '$kardexGrabar->consentimientos'
							AND Karpal = '$kardexGrabar->preparacionAlta'
							AND Kardie = '$kardexGrabar->obsDietas'
							AND Karmez = '$kardexGrabar->mezclas'
							AND Karcip = '$kardexGrabar->cirugiasPendientes'
							AND Kartef = '$kardexGrabar->terapiaFisica'
							AND Karrec = '$kardexGrabar->rehabilitacionCardiaca'
							AND Karais = '$kardexGrabar->aislamientos'
							AND Kardec = '$kardexGrabar->consentimientos'
							AND Karcui = '".mysqli_real_escape_string( $conex, $kardexGrabar->cuidadosEnfermeria )."'
						";
					
				$resChange = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
				$numRowsChange = mysql_num_rows( $resChange );
				
				if( $numRowsChange == 0 ){
					
					// if( !$usuario->esEnfermeraRolHCE ){
					if( !permiteLecturaOrdenesPendientes( $conex, "01", $usuario->codigoRolHCE ) ){
						$q .= ",Karupe = '".$usuario->codigo."',
							   Karpen = 'on',
							   Karule = '".$usuario->codigo."',
							   Karfle = '0000-00-00',
							   Karhle = '00:00:00'
						";
					}
					else{
						$q .= ",Karupe = '".$usuario->codigo."',
							   Karpen = 'off',
							   Karule = '".$usuario->codigo."',
							   Karfle = '".date( "Y-m-d" )."',
							   Karhle = '".date( "H:i:s" )."'
						";
					}
				}
				elseif( permiteLecturaOrdenesPendientes( $conex, "01", $usuario->codigoRolHCE ) ){
					$q .= ",Karupe = '".$usuario->codigo."',
						    Karpen = 'off',
						    Karule = '".$usuario->codigo."',
						    Karfle = '".date( "Y-m-d" )."',
						    Karhle = '".date( "H:i:s" )."'
						";
				}
			}
	}
	
	$q.=" WHERE
			Karhis = '$kardexGrabar->historia'
			AND Karing = '$kardexGrabar->ingreso'
			
			AND Fecha_data = '$kardexGrabar->fechaCreacion';";

	$res = mysql_query( $q, $conex ) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

	//Registro de auditoria de kardex
	$auditoria = new AuditoriaDTO();

	$auditoria->historia = $kardexGrabar->historia;
	$auditoria->ingreso = $kardexGrabar->ingreso;
	$auditoria->descripcion = "-";

	if(isset($kardexGrabar->confirmado) && $kardexGrabar->confirmado == "on"){
		$auditoria->descripcion = "Confirmado";
	} else {
		$auditoria->descripcion = "No confirmado";
	}
	$auditoria->fechaKardex = $kardexGrabar->fechaCreacion;
	$auditoria->mensaje = obtenerMensaje('MSJ_KARDEX_ACTUALIZADO');
	$auditoria->seguridad = $kardexGrabar->usuario;

	registrarAuditoriaKardex($conex,$wbasedato,$auditoria);

	//Auditoria para información demográfica
	if(isset($vecPestanas[1]) && $vecPestanas[1]){
		foreach( $arCompararDatosInf as $key => $value ){
			
			//Solo se guarda si hay alguna diferencia en los campos
			// echo "<br> ".$value[0].": ".$rowsInf[ $value[0] ]." - ".$value[1];
			if( $rowsInf[ $value[0] ] != $value[1] ){	//la comparación es el valor anterior en la base de datos con el valor recien guardado
				// Registro auditoria información demográfica
				$auditoria->mensaje = "Informacion demografica - ".obtenerMensaje('MSJ_KARDEX_ACTUALIZADO');
				$auditoria->descripcion = $key.": ".$value[1];	//Esto es nombre del campo en el programa de ordnes: Valor actualizado
				registrarAuditoriaKardex($conex,$wbasedato,$auditoria);
			}
		}
	}
	
	
	//Auditoria para información demográfica
	if(isset($vecPestanas[10]) && $vecPestanas[10]){
		foreach( $arCompararDatosMG as $key => $value ){
			
			//Solo se guarda si hay alguna diferencia en los campos
			// echo "<br> ".$value[0].": ".$rowsInf[ $value[0] ]." - ".$value[1];
			if( $rowsInf[ $value[0] ] != $value[1] ){	//la comparación es el valor anterior en la base de datos con el valor recien guardado
				// Registro auditoria información demográfica
				$auditoria->mensaje = "Medidas generales - ".obtenerMensaje('MSJ_KARDEX_ACTUALIZADO');
				$auditoria->descripcion = $key.": ".$value[1];	//Esto es nombre del campo en el programa de ordnes: Valor actualizado
				registrarAuditoriaKardex($conex,$wbasedato,$auditoria);
			}
		}
	}
	
	// // Registro auditoria información demográfica
	// $auditoria->mensaje = "Informacion demografica - ".obtenerMensaje('MSJ_KARDEX_ACTUALIZADO');
	// $auditoria->descripcion = $kardexGrabar->diagnostico.",".$kardexGrabar->antecedentesAlergicos.",".$kardexGrabar->antecedentesPersonales;
	// registrarAuditoriaKardex($conex,$wbasedato,$auditoria);
	
	// // Registro auditoria medidas generales
	// $auditoria->mensaje = "Medidas generales - ".obtenerMensaje('MSJ_KARDEX_ACTUALIZADO');
	// $auditoria->descripcion = $kardexGrabar->procedimientos.",".$kardexGrabar->aislamientos.",".$kardexGrabar->terapiaRespiratoria.",".$kardexGrabar->interconsulta.",".$kardexGrabar->cirugiasPendientes.",".$kardexGrabar->sondasCateteres.",".$kardexGrabar->curaciones.",".$kardexGrabar->medidasGenerales;
	// registrarAuditoriaKardex($conex,$wbasedato,$auditoria);
}

function incrementarConsecutivoCentroCostos($historia,$ingreso,$wfecha){
	global $wbasedato;
	global $conex;
	global $wbasedatohce;

	//Verificacion de que las ordenes existan y firmadas
	//Medico  Fecha_data  Hora_data  Ordfec  Ordhor  Ordhis  Ording  Ordtor  Ordnro  Ordobs  Ordesp  Ordest  Ordfir  Seguridad  id
	$q = "SELECT DISTINCT
			Ordtor
		FROM 
			".$wbasedatohce."_000027
		WHERE
			Ordhis = '$historia'
			AND Ording = '$ingreso'
			AND Ordest = 'on'
			AND Ordfir != ''
			AND Ordesp = 'P'
			AND Ordfec = '$wfecha';";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

	while($info = mysql_fetch_array($res)){
		//Actualizar centro de costos
		$q2 = "UPDATE ".$wbasedato."_000011 SET
					Ccocor = Ccocor + 1
				WHERE 
					Ccocod = '{$info['Ordtor']}';";

		$res2 = mysql_query($q2, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());
	}
}

function grabarAlertaHCE($historia,$ingreso,$wfecha,$alertas,$codUsuario){
	return;
	global $wbasedato;
	global $conex;
	global $wbasedatohce;

	//Verificacion de que las ordenes existan y firmadas
	//Detpro  Detcon  Detorp  Dettip  Detdes  Detarc  Detcav  Detvde  Detnpa  Detvim  Detume  Detcol  Dethl7  Detjco  Detsiv  Detase  Detved  Detimp  Detimc  Detvco  Detvcr  Detobl  Detdep  Detcde  Deturl  Detfor  Detcco  Detcac  Detnse  Detfac  Detest  Detcoa  Detprs  Detalm  Detanm  Detlrb  Detdde  detcbu  detnbu  dettta  detcua  detccu  detcro  dettii  Detdpl
	$q = "SELECT
			Encpro,Encdes,Enctus,Enctfo,Enctim,Encale,Enccol,Encnfi,Encnco,Encest,Encvis,Encmax,Detpro,Detcon,Detorp,Dettip 
		FROM 
			".$wbasedatohce."_000001, ".$wbasedatohce."_000002
		WHERE
			Encale = 'on'
			AND Encest = 'on'
			AND Encpro = Detpro;";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

	if($info = mysql_fetch_array($res)){
		$q2 = "UPDATE ".$wbasedatohce."_{$info['Encpro']} SET
					movdat = '$alertas'
				WHERE
					movpro = '{$info['Encpro']}'
					AND movcon = '{$info['Detcon']}'
					AND movtip = '{$info['Dettip']}'
					AND movhis = '$historia'
					AND moving = '$ingreso'
					AND fecha_data = '$wfecha';";

		$res2 = mysql_query($q2, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());
		if(mysql_affected_rows() == 0){
			$q2 = "INSERT INTO ".$wbasedatohce."_{$info['Encpro']}
						(Medico,Fecha_data,Hora_data,movpro,movcon,movhis,moving,movtip,movdat,movusu,Seguridad)
					VALUES 
						('HCE', '$wfecha','".date("H:i:s")."', '{$info['Encpro']}', '{$info['Detcon']}', '$historia', '$ingreso', '{$info['Dettip']}', '$alertas', '$codUsuario','C-HCE');";

			$res2 = mysql_query($q2, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());
		}
	}
}

function ultimaFechaKardexHistoriaIngreso($whistoria,$wingreso){
	global $wbasedato;
	global $conex;

	$fecha = "";

	$q = "SELECT
			MAX(Fecha_data) fechaKardex
		FROM 
			".$wbasedato."_000053
		WHERE
			Karest = 'on'
			AND Karhis = '".$whistoria."'
			AND Karing = '".$wingreso."';";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if($num > 0){
		$info = mysql_fetch_array($res);

		$fecha = $info['fechaKardex'];
	}
	return $fecha;
}

function actualizarRutaArchivoKardex($historia,$ingreso,$fecha,$ruta,$usuario){
	global $conex;
	global $wbasedato;

	//Actualizo los campos del kardex
	$q="UPDATE ".$wbasedato."_000053
		SET
			Karrut = '$ruta'		
		WHERE
			Karhis = '$historia'
			AND Karing = '$ingreso'
			AND Fecha_data = '$fecha'";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
		
	//Registro de auditoria de kardex
	$auditoria = new AuditoriaDTO();

	$auditoria->historia = $historia;
	$auditoria->ingreso = $ingreso;
	$auditoria->descripcion = "<a href=$ruta target=_blank>$ruta</a>";
	$auditoria->fechaKardex = $fecha;
	$auditoria->mensaje = obtenerMensaje('MSJ_ARCHIVO_CARGADO');
	$auditoria->seguridad = $usuario;

	registrarAuditoriaKardex($conex,$wbasedato,$auditoria);
}


function consultarDetalleTemporalKardexAlta($historia,$ingreso,$fecha,$tipoProtocolo,$pestAlta='off'){
	//,$centroCostosMovimiento,$gruposMedicamentosMovimiento
	global $wbasedato;
	global $conex;
	global $wemp_pmla;
	global $codigoServicioFarmaceutico;
	global $codigoCentralMezclas;
	global $centroCostosServicioFarmaceutico;
	global $centroCostosCentralMezclas;
	global $usuario;		//Información de usuario

	//Protocolos
	global $protocoloNormal;
	global $protocoloNutricion;
	global $protocoloAnalgesia;
	global $protocoloQuimioterapia;

	global $nombreProtocoloNormal;
	global $nombreProtocoloNutricion;
	global $nombreProtocoloAnalgesia;
	global $nombreProtocoloQuimioterapia;
	
	global $regletaFamilia;
	
	$pac = consultarInfoPacienteOrdenHCEPorHistoria( $conex, $wbasedato, $historia );
	
	$coleccion = array();

	//*******************************Grupos que puede ver el centro de costos del usuario
	$tieneGruposIncluidos = false;
	if($usuario->gruposMedicamentos != "*" && $usuario->gruposMedicamentos != '' && $usuario->gruposMedicamentos != 'NO APLICA'){
		$tieneGruposIncluidos = true;
	}
	

	/****************************************************************************************
	 * Junio 14 de 2012
	 ****************************************************************************************/
	$validarCco = "";
	
	if( $usuario->centroCostosGrabacion != '*' ){
		$validarCco = " AND Kadcco = '$usuario->centroCostosGrabacion'";
	}
	/****************************************************************************************/

		$q = "SELECT
				a.Hora_data, Kadart,Artcom,Artgen,Artuni,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kadcdi,Kaddis,Kadpro,Kadcco,SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru,Kaddis,Kaduma,Kadcma,Kadnar, Artest, Kadusu, Famcod, Famnom, Kadimp, Kadalt, Kadcal, Kadlev, Kadido, Artpos
			FROM
				".$wbasedato."_000168 a, ".$wbasedato."_000026, ".$wbasedato."_000115, ".$wbasedato."_000114
			WHERE
				Kadhis = '$historia'
				AND Kading = '$ingreso'";
				if($tieneGruposIncluidos){
					$q .= " AND Kadori = '$codigoServicioFarmaceutico' ";
					$q .= " AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN $usuario->gruposMedicamentosQuery ";
				}
				$q .= " AND Kadpro LIKE '$tipoProtocolo'
				AND Artcod = Kadart
				AND kadori = '$codigoServicioFarmaceutico'				
				AND Kadart = Relart
				AND Relfam = Famcod
				AND Kadalt = 'on'
				$validarCco";

	$subConsulta = " SELECT
						a.Hora_data, Kadart,Artcom,Artgen,Artuni,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kadcdi,Kaddis,Kadpro,Kadcco,'' Artgru,Kaddis,Kaduma,Kadcma,Kadnar, Artest, Kadusu, Famcod, Famnom, Kadimp, Kadalt, Kadcal, Kadlev, Kadido, '' as Artpos
					FROM
						".$wbasedato."_000168 a, {$wcenmez}_000002, ".$wbasedato."_000115, ".$wbasedato."_000114
					WHERE
						Kadhis = '$historia'
						AND Kading = '$ingreso'
						AND Kadpro LIKE '$tipoProtocolo'
						AND Kadori = '$codigoCentralMezclas'
						AND Artcod = Kadart						
						AND Kadart = Relart
						AND Relfam = Famcod
						AND Kadalt = 'on'
						$validarCco ";

	if($usuario->esUsuarioCM){
		$q = $subConsulta;
	} else {
		if(!$tieneGruposIncluidos){
			$q = $q." UNION ".$subConsulta;
		}
	}
	$q = $q." ORDER BY Famcod, Artcom ";
	
	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if ($num > 0)
	{
		$cont1 = 0;
		$auxFamilia = "";

		while ($cont1 < $num){
			$cont1++;
				
			$detalle = new detalleKardexDTO();

			//$rondasFamilia = array();
			
			$vectorDosis = array();
			
			$info = mysql_fetch_array($res);

			$detalle->historia = $historia;
			$detalle->ingreso = $ingreso;
			$detalle->fecha = $fecha;
			
			$nombreArticulo = "";
			if(isset($info['Kadnar']) && !empty($info['Kadnar'])){
				$detalle->nombreArticulo	= $info['Kadnar'];
				$nombreArticulo = $detalle->nombreArticulo;
			} else {
				$nombreArticulo = $info['Artcom'];
			}
			
			$detalle->codigoFamilia = $info['Famcod'];
			$detalle->nombreFamilia = $info['Famnom'];
			$codFamilia = $info['Famcod'];

			/***********************************************************************/
			/******************* Calculo de regleta por familia ********************/
			/***********************************************************************/

			$colPeriodicidades = consultarPeriodicidades();
			foreach ($colPeriodicidades as $periodicidad){
				if($periodicidad->codigo == $info['Kadper']){
					$horaPeriodicidad = intval($periodicidad->equivalencia);
					break;
				}
			}
			
			if( $info['Kadlev'] != 'on' ){	
				$arrAplicacion = array();
				
				$arrAplicacion = obtenerVectorAplicacionMedicamentos(date("Y-m-d"),$info['Kadfin'],$info['Kadhin'],$horaPeriodicidad,$info['Kadcfr']);
				
				$horaArranque = 2;

				$cont3 = 1;
				$cont2 = $horaArranque;   //Desplazamiento desde la hora inicial
				$caracterMarca = $info['Kadcfr'];

				while($cont3 <= 24)
				{
				
					if(!isset($arrAplicacion[$cont2]) || $arrAplicacion[$cont2]=="" || $arrAplicacion[$cont2]==" " || $arrAplicacion[$cont2]=="-")
						$arrAplicacion[$cont2] = 0;
					
					if(!array_key_exists($codFamilia,$regletaFamilia))
						$regletaFamilia[$codFamilia] = array();
					
					if(array_key_exists($cont2,$regletaFamilia[$codFamilia]))
					{
						$regletaFamilia[$codFamilia][$cont2]['valor'] += $arrAplicacion[$cont2]*1;
					} 
					else 
					{
						$regletaFamilia[$codFamilia][$cont2] = array();
						$regletaFamilia[$codFamilia][$cont2]['valor'] = $arrAplicacion[$cont2]*1;
					}

					if($arrAplicacion[$cont2] > 0)
					{
						if(isset($regletaFamilia[$codFamilia][$cont2]['condicion']) && $regletaFamilia[$codFamilia][$cont2]['condicion']!="")
						{
							$pos = strpos($regletaFamilia[$codFamilia][$cont2]['condicion'], "|".$info['Kadcnd']);
							if ($pos === false && $regletaFamilia[$codFamilia][$cont2]['condicion'] != $info['Kadcnd'])
								$regletaFamilia[$codFamilia][$cont2]['condicion'] .= "|".$info['Kadcnd'];
						}
						else
						{
							$regletaFamilia[$codFamilia][$cont2]['condicion'] = $info['Kadcnd'];
						}	

						if(isset($regletaFamilia[$codFamilia][$cont2]['unidad']) && $regletaFamilia[$codFamilia][$cont2]['unidad']!="")
						{
							$pos = strpos($regletaFamilia[$codFamilia][$cont2]['unidad'], "|".$info['Kadufr']);
							if ($pos === false && $regletaFamilia[$codFamilia][$cont2]['unidad'] != $info['Kadufr'])
								$regletaFamilia[$codFamilia][$cont2]['unidad'] .= "|".$info['Kadufr'];
						}
						else
						{
							$regletaFamilia[$codFamilia][$cont2]['unidad'] = $info['Kadufr'];
						}
						
						if(!isset($regletaFamilia[$codFamilia][$cont2]['cont']))
							$regletaFamilia[$codFamilia][$cont2]['cont'] = 1; 
						else
							$regletaFamilia[$codFamilia][$cont2]['cont']++; 
							
						if(isset($regletaFamilia[$codFamilia][$cont2]['cont']) && $regletaFamilia[$codFamilia][$cont2]['cont'] % 2 != 0)
							$bgTooltip = "#C3D9FF";
						else
							$bgTooltip = "#E8EEF7";
						
						if(!isset($regletaFamilia[$codFamilia][$cont2]['tooltip']) || $regletaFamilia[$codFamilia][$cont2]['tooltip']=="")
						{
							$regletaFamilia[$codFamilia][$cont2]['tooltip'] = '<table cellspacing=4>';
							$regletaFamilia[$codFamilia][$cont2]['tooltip'] .= '<tr style=background-color:#2A5DB0;color:#ffffff><td align=center> Código </td><td align=center> Nombre </td><td align=center> Dosis </td><td align=center> Unidad </td><td align=center> Frecuencia </td><td align=center> Vía </td><td align=center> Inicio </td><td align=center> Condición </td></tr>';
						}
						
						if(isset($regletaFamilia[$codFamilia][$cont2]['tooltip']))
						{
							$regletaFamilia[$codFamilia][$cont2]['tooltip'] .= '<tr style=background-color:'.$bgTooltip.'><td> '.$info['Kadart'].' </td><td> '.trim($info['Artgen']).' </td><td> '.$info['Kadcfr'].' '.$info['Kadufr'].' </td><td align=center> '.$info['Artuni'].' </td><td align=center> '.$info['Kadper'].' </td><td align=center> '.$info['Kadvia'].' </td><td align=center> '.$info['Kadfin'].' </td><td align=center> '.$info['Kadcnd'].' </td></tr>';
						}
					}
					
					if($cont2 == 24){
						$cont2 = 0;
					}

					$cont3++;
					$cont2++;

					if($cont2 % 2 != 0){
						$cont2++;
					}
					if($cont3 % 2 != 0){
						$cont3++;
					}

					if($cont2 == $horaArranque){
						break;
					}
				}
				
				// Indico si hay mas de un articulo en la familia
				if($auxFamilia == $codFamilia)
					$regletaFamilia[$codFamilia]['esCompuestaFamilia'] = '1';

				$auxFamilia = $codFamilia;
				
				//$regletaFamilia = $rondasFamilia;
			}	
			unset($arrAplicacion);
			//unset($rondasFamilia);
			unset($colPeriodicidades);
			
			/********************************************************************/
			
			$detalle->codigoArticulo = $info['Kadart']."-".$info['Kadori']."-".$info['Artgen'];
			$detalle->cantidadDosis = $info['Kadcfr'];
			$detalle->unidadDosis = $info['Kadufr'];
			$detalle->diasTratamiento = $info['Kaddia'];
			$detalle->estadoRegistro = $info['Kadest'];
			$detalle->estadoAdministracion = $info['Kadess'];
			$detalle->periodicidad = $info['Kadper'];
			$detalle->condicionSuministro = $info['Kadcnd'];
			$detalle->dosisMaxima = $info['Kaddma'];
			$detalle->formaFarmaceutica = $info['Kadffa'];
			$detalle->fechaInicioAdministracion = $info['Kadfin'];
			$detalle->horaInicioAdministracion = $info['Kadhin'];
			$detalle->via = $info['Kadvia'];
			$detalle->fechaKardex = $info['Kadfec'];
			$detalle->suspendido = $info['Kadsus'];
			$detalle->estaConfirmado = $info['Kadcon'];
			$detalle->origen = $info['Kadori'];
			$detalle->observaciones = $info['Kadobs'];
			$detalle->cantidadUnidadManejo = $info['Kadcma'];
			$detalle->unidadManejo = $info['Artuni'];
			$detalle->grupo = $info['Artgru'];
			$detalle->cantidadADispensar = $info['Kadcdi'];
			$detalle->cantidadDispensada = $info['Kaddis'];
			$detalle->tipoProtocolo = $info['Kadpro'];
			$detalle->centroCostos	= $info['Kadcco'];
			$detalle->estadoArticulo =  $info['Artest'];
			$detalle->imprimirArticulo =  $info['Kadimp'];
			$detalle->altaArticulo =  $info['Kadalt'];
			$detalle->cantidadAlta = $info['Kadcal'];			
			
			$detalle->codigoCreador = $info['Kadusu'];
			
			$resFam = consultarPrincipiosActivosPorFamilia( $conex, $wbasedato, $info['Famcod'] );
			$codsFam = codigosPrincipiosActivos( $resFam );
			$detalle->codigoPrincipioActivo = $codsFam;		//Junio 16 de 2015
			
			$detalle->nombreGenerico = $nombreArticulo;		//Agosto 27 de 2012
			
			$gruposAntibioticos = consultarAliasPorAplicacion( $conex, $wemp_pmla, "gruposMedicamentosAntibioticos" );
			$gruposAntibioticos = explode(",", $gruposAntibioticos );
			
			$detalle->esAntibiotico = in_array( $info['Artgru'], $gruposAntibioticos );
			
			$detalle->presentacionPermiteDA = presentacionPermiteDA( $conex, $wbasedato, $detalle->unidadManejo );
			$detalle->presentacionPermiteNE = presentacionPermiteNE( $conex, $wbasedato, $detalle->unidadManejo );
			
			switch($detalle->tipoProtocolo){
				case $protocoloNormal:
					$detalle->nombreProtocolo = $nombreProtocoloNormal;
					break;
				case $protocoloNutricion:
					$detalle->nombreProtocolo = $nombreProtocoloNutricion;
					break;
				case $protocoloAnalgesia:
					$detalle->nombreProtocolo = $nombreProtocoloAnalgesia;
					break;
				case $protocoloQuimioterapia:
					$detalle->nombreProtocolo = $nombreProtocoloQuimioterapia;
					break;
				default:
					$detalle->nombreProtocolo = $nombreProtocoloNormal;
					break;
						
			}
			
			$detalle->idOriginal = $info[ 'Kadido' ];
			
			$detalle->esLev = false;
			if( $info['Kadlev'] == 'on' ){
				$detalle->tipoProtocolo = 'LQ';
				$detalle->esLev = true;
			}
			
			$detalle->esLactario = false;
			if( esArticuloLactario( $conex, $wbasedato, $info['Kadart'] ) ){
				$detalle->esLactario = true;
			}

			//Kadcma-Kadufr
			if(isset($info['Kadcma']) && !empty($info['Kadcma'])){
				$detalle->maximoUnidadManejo = $info['Kadcma'];
				$detalle->unidadMaximoManejo = $info['Kadufr'];
//				$detalle->vencimiento		 = $info['Defven'];
//				$detalle->diasVencimiento	 = $info['Defdie'];
//				$detalle->esDispensable		 = $info['Defdis'];
//				$detalle->esDuplicable		 = $info['Defdup'];

				//No modificar
				$detalle->permiteModificar	 = true;

				//Consulta de los dias de tratamiento de este articulo
				obtenerDatosAdicionalesArticulo($historia, $ingreso, $info['Kadart'], $detalle->diasTotalesTto, $detalle->dosisTotalesTto);

				//Consulta de cantidades ctc
				//****************************Consulta de las cantidades del CTC autorizado acumulado y usado
				$q2 = "SELECT Ctccau,Ctccus,Ctcuca FROM {$wbasedato}_000095 WHERE Ctchis = '".$historia."' AND Ctcing = '".$ingreso."' AND Ctcart = '".$info['Kadart']."'";
				$res2 = mysql_query($q2, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());
				while($info2 = mysql_fetch_array($res2)){
					$detalle->cantidadAutorizadaCtc 	= $info2['Ctccau'];
					$detalle->cantidadUtilizadaCtc 		= consultarCantidadAcumuladaDispensada($conex,$wbasedato,$historia,$ingreso,$info['Kadart']);
					$detalle->unidadesCantidadesCtc 	= $info2['Ctcuca'];
				}
				//***************************

				//Consulta de vias del articulo
				//****************************
				$q3 = "SELECT Defcco,Defart,Deffra,Deffru,Defest,Defven,Defdie,Defdis,Defdup,Defcon,Defnka,Defdim,Defdom,Defvia FROM {$wbasedato}_000059 WHERE Defart = '".$info['Kadart']."' AND Defest = 'on'";
				$res3 = mysql_query($q3, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q3 . " - " . mysql_error());
				if($info3 = mysql_fetch_array($res3)){
					$detalle->viasPosibles 	= $info3['Defvia'];
					
					//Consulto si es dispensable y duplicable
					$detalle->esDispensable = $info3['Defdis'];	//Marzo 3 de 2011
					$detalle->esDuplicable =  $info3['Defdup'];	//Marzo 3 de 2011
				}
				//***************************
				
				$detalle->setDatosExtension();
				
				$coleccion[] = $detalle;
			}
		}
	}
	return $coleccion;
}



/**
 * Consulta el detalle del kardex del dia anterior para mostrarlo en pantalla (en caso de no tener uno el dia seleccionado)
 * @param unknown_type $historia
 * @param unknown_type $ingreso
 * @param unknown_type $wfecha
 */
function consultarDetalleTemporalKardex($historia,$ingreso,$fecha,$tipoProtocolo,$pestAlta='off'){
	//,$centroCostosMovimiento,$gruposMedicamentosMovimiento
	global $wbasedato;
	global $conex;
	global $wemp_pmla;
	global $codigoServicioFarmaceutico;
	global $codigoCentralMezclas;
	global $centroCostosServicioFarmaceutico;
	global $centroCostosCentralMezclas;
	global $usuario;		//Información de usuario

	//Protocolos
	global $protocoloNormal;
	global $protocoloNutricion;
	global $protocoloAnalgesia;
	global $protocoloQuimioterapia;

	global $nombreProtocoloNormal;
	global $nombreProtocoloNutricion;
	global $nombreProtocoloAnalgesia;
	global $nombreProtocoloQuimioterapia;
	
	global $regletaFamilia;
	global $wcenmez;
	
	$pac = consultarInfoPacienteOrdenHCEPorHistoria( $conex, $wbasedato, $historia );
	
	$coleccion = array();

	//*******************************Grupos que puede ver el centro de costos del usuario
	$tieneGruposIncluidos = false;
	if($usuario->gruposMedicamentos != "*" && $usuario->gruposMedicamentos != '' && $usuario->gruposMedicamentos != 'NO APLICA'){
		$tieneGruposIncluidos = true;
	}
	//********************************
	
	$condicionFecha = " AND Kadfec = '$fecha' ";
	$condicionAlta = " AND Kadalt != 'on' ";
	$condicionGroupBy = "";
	if($pestAlta=='on')
	{
		$condicionAlta = "  AND Kadimp = 'on' ";
		
		if( $pac->enUrgencias ){
			$condicionAlta = "  AND Kadalt = 'on' ";
		}
		
		//$condicionFecha = "";
		$condicionGroupBy = " GROUP BY Kadart ";
	}
		
	/****************************************************************************************
	 * Junio 14 de 2012
	 ****************************************************************************************/
	$validarCco = "";
	
	if( $usuario->centroCostosGrabacion != '*' ){
		$validarCco = " AND Kadcco = '$usuario->centroCostosGrabacion'";
	}
	/****************************************************************************************/

		$q = "SELECT
				Kadart,Artcom,Artgen,Artuni,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kadcdi,Kaddis,Kadpro,Kadcco,SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru,Kaddis,Kaduma,Kadcma,Kadnar, Artest, Kadusu, Famcod, Famnom, Kadimp, Kadalt, Kadcal, Kadlev, Famctr, Kaddoa, Kadido, Kadpen, Kadnes, Artpos
			FROM
				".$wbasedato."_000060, ".$wbasedato."_000026, ".$wbasedato."_000115, ".$wbasedato."_000114
			WHERE
				Kadhis = '$historia'
				AND Kading = '$ingreso'
				$condicionFecha ";
				if($tieneGruposIncluidos){
					$q .= " AND Kadori = '$codigoServicioFarmaceutico' ";
					$q .= " AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN $usuario->gruposMedicamentosQuery ";
				}
				$q .= " AND Kadpro LIKE '$tipoProtocolo'
				AND Artcod = Kadart
				AND kadori = '$codigoServicioFarmaceutico'
				
				AND Kadart = Relart
				AND Relfam = Famcod
				$condicionAlta
				$validarCco
				$condicionGroupBy 
				
			UNION
			
			SELECT
				Kadart,Artcom,Artgen,Artuni,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kadcdi,Kaddis,Kadpro,Kadcco,SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru,Kaddis,Kaduma,Kadcma,Kadnar, Artest, Kadusu, Famcod, Famnom, Kadimp, Kadalt, Kadcal, Kadlev, Famctr, Kaddoa, Kadido, Kadpen, Kadnes, Artpos
			FROM
				".$wbasedato."_000060, ".$wbasedato."_000026, ".$wbasedato."_000114
			WHERE
				Kadhis = '$historia'
				AND Kading = '$ingreso'
				$condicionFecha ";
				if($tieneGruposIncluidos){
					$q .= " AND Kadori = '$codigoServicioFarmaceutico' ";
					$q .= " AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN $usuario->gruposMedicamentosQuery ";
				}
				$q .= " AND Kadpro LIKE '$tipoProtocolo'
				AND Artcod = Kadart
				AND kadori = '$codigoServicioFarmaceutico'
				
				AND Kadctr = Famcod
				AND Kadart NOT IN ( SELECT relart FROM ".$wbasedato."_000115  )
				$condicionAlta
				$validarCco
				$condicionGroupBy 
				";

	$subConsulta = " SELECT
						Kadart,Artcom,Artgen,Artuni,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kadcdi,Kaddis,Kadpro,Kadcco,'' Artgru,Kaddis,Kaduma,Kadcma,Kadnar, Artest, Kadusu, Famcod, Famnom, Kadimp, Kadalt, Kadcal, Kadlev, Famctr, Kaddoa, Kadido, Kadpen, Kadnes, '' as Artpos
					FROM
						".$wbasedato."_000060, {$wcenmez}_000002, ".$wbasedato."_000115, ".$wbasedato."_000114
					WHERE
						Kadhis = '$historia'
						AND Kading = '$ingreso'
						$condicionFecha
						AND Kadpro LIKE '$tipoProtocolo'
						AND Kadori = '$codigoCentralMezclas'
						AND Artcod = Kadart
						
						AND Kadart = Relart
						AND Relfam = Famcod
						$condicionAlta
						$validarCco
						$condicionGroupBy 
				
					UNION
					
					SELECT
						Kadart,Artcom,Artgen,Artuni,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kadcdi,Kaddis,Kadpro,Kadcco,'' Artgru,Kaddis,Kaduma,Kadcma,Kadnar, Artest, Kadusu, Famcod, Famnom, Kadimp, Kadalt, Kadcal, Kadlev, Famctr, Kaddoa, Kadido, Kadpen, Kadnes, '' as Artpos
					FROM
						".$wbasedato."_000060, {$wcenmez}_000002, ".$wbasedato."_000114
					WHERE
						Kadhis = '$historia'
						AND Kading = '$ingreso'
						$condicionFecha 
						AND Kadpro LIKE '$tipoProtocolo'
						AND Artcod = Kadart
						AND kadori = '$codigoCentralMezclas'
						
						AND Kadctr = Famcod
						AND Kadart NOT IN ( SELECT relart FROM ".$wbasedato."_000115  )
						$condicionAlta
						$validarCco
						$condicionGroupBy  ";

	if($usuario->esUsuarioCM){
		$q = $subConsulta;
	} else {
		if(!$tieneGruposIncluidos){
			$q = $q." UNION ".$subConsulta;
		}
	}
	$q = $q." ORDER BY Famcod, Artcom ";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if ($num > 0)
	{
		$cont1 = 0;
		$auxFamilia = "";

		while ($cont1 < $num){
			$cont1++;
				
			$detalle = new detalleKardexDTO();

			//$rondasFamilia = array();
			
			$vectorDosis = array();
			
			$info = mysql_fetch_array($res);

			$detalle->historia = $historia;
			$detalle->ingreso = $ingreso;
			$detalle->fecha = $fecha;
			
			$nombreArticulo = "";
			if(isset($info['Kadnar']) && !empty($info['Kadnar'])){
				$detalle->nombreArticulo	= $info['Kadnar'];
				$nombreArticulo = $detalle->nombreArticulo;
			} else {
				$nombreArticulo = $info['Artcom'];
			}
			
			$detalle->codigoFamilia = $info['Famcod'];
			$detalle->nombreFamilia = $info['Famnom'];
			$codFamilia = $info['Famcod'];

			/***********************************************************************/
			/******************* Calculo de regleta por familia ********************/
			/***********************************************************************/

			$colPeriodicidades = consultarPeriodicidades();
			$colPeriodicidades = array_merge( $colPeriodicidades, consultarPeriodicidades( 'I' ) );
			foreach ($colPeriodicidades as $periodicidad){
				if($periodicidad->codigo == $info['Kadper']){
					$horaPeriodicidad = intval($periodicidad->equivalencia);
					break;
				}
			}
		
			if( $info['Kadlev'] != 'on' ){	
				$arrAplicacion = array();
				
				// se debe enviar la dosis 
				$dosisArticulo = $info['Kadcfr'];
				$unidadArticulo = $info['Kadufr'];
				
				// validar si es producto de central de mezclas
				if($info['Kadori']==$codigoCentralMezclas)
				{
					// si es una DA con purga debe mostrar la dosis ordenada (sin purga)
					$articuloSinPurga = consultarDosisSinPurgaDA($conex,$wbasedato,$wcenmez,$historia,$ingreso,$info['Kadart'],$info['Kadido'],$dosisArticulo,$unidadArticulo,$formaFarmaceuticaArticulo);
					$dosisArticulo = $articuloSinPurga['dosis'];
					$unidadArticulo = $articuloSinPurga['unidad'];
				}
				
				$arrAplicacion = obtenerVectorAplicacionMedicamentos(date("Y-m-d"),$info['Kadfin'],$info['Kadhin'],$horaPeriodicidad,$dosisArticulo);
				// $arrAplicacion = obtenerVectorAplicacionMedicamentos(date("Y-m-d"),$info['Kadfin'],$info['Kadhin'],$horaPeriodicidad,$info['Kadcfr']);
				
				$horaArranque = 2;

				$cont3 = 1;
				$cont2 = $horaArranque;   //Desplazamiento desde la hora inicial
				$caracterMarca = $info['Kadcfr'];

				while($cont3 <= 24)
				{
				
					if(!isset($arrAplicacion[$cont2]) || $arrAplicacion[$cont2]=="" || $arrAplicacion[$cont2]==" " || $arrAplicacion[$cont2]=="-")
						$arrAplicacion[$cont2] = 0;
					
					if(!array_key_exists($codFamilia,$regletaFamilia))
						$regletaFamilia[$codFamilia] = array();
					
					if(array_key_exists($cont2,$regletaFamilia[$codFamilia]))
					{
						$regletaFamilia[$codFamilia][$cont2]['valor'] += $arrAplicacion[$cont2]*1;
					} 
					else 
					{
						$regletaFamilia[$codFamilia][$cont2] = array();
						$regletaFamilia[$codFamilia][$cont2]['valor'] = $arrAplicacion[$cont2]*1;
					}

					if($arrAplicacion[$cont2] > 0)
					{
						if(isset($regletaFamilia[$codFamilia][$cont2]['condicion']) && $regletaFamilia[$codFamilia][$cont2]['condicion']!="")
						{
							$pos = strpos($regletaFamilia[$codFamilia][$cont2]['condicion'], "|".$info['Kadcnd']);
							if ($pos === false && $regletaFamilia[$codFamilia][$cont2]['condicion'] != $info['Kadcnd'])
								$regletaFamilia[$codFamilia][$cont2]['condicion'] .= "|".$info['Kadcnd'];
						}
						else
						{
							$regletaFamilia[$codFamilia][$cont2]['condicion'] = $info['Kadcnd'];
						}	

						if(isset($regletaFamilia[$codFamilia][$cont2]['unidad']) && $regletaFamilia[$codFamilia][$cont2]['unidad']!="")
						{
							$pos = strpos($regletaFamilia[$codFamilia][$cont2]['unidad'], "|".$unidadArticulo);
							if ($pos === false && $regletaFamilia[$codFamilia][$cont2]['unidad'] != $unidadArticulo)
								$regletaFamilia[$codFamilia][$cont2]['unidad'] .= "|".$unidadArticulo;
						}
						else
						{
							$regletaFamilia[$codFamilia][$cont2]['unidad'] = $unidadArticulo;
						}
						
						if(!isset($regletaFamilia[$codFamilia][$cont2]['cont']))
							$regletaFamilia[$codFamilia][$cont2]['cont'] = 1; 
						else
							$regletaFamilia[$codFamilia][$cont2]['cont']++; 
							
						if(isset($regletaFamilia[$codFamilia][$cont2]['cont']) && $regletaFamilia[$codFamilia][$cont2]['cont'] % 2 != 0)
							$bgTooltip = "#C3D9FF";
						else
							$bgTooltip = "#E8EEF7";
						
						if(!isset($regletaFamilia[$codFamilia][$cont2]['tooltip']) || $regletaFamilia[$codFamilia][$cont2]['tooltip']=="")
						{
							$regletaFamilia[$codFamilia][$cont2]['tooltip'] = '<table cellspacing=4>';
							$regletaFamilia[$codFamilia][$cont2]['tooltip'] .= '<tr style=background-color:#2A5DB0;color:#ffffff><td align=center> Código </td><td align=center> Nombre </td><td align=center> Dosis </td><td align=center> Unidad </td><td align=center> Frecuencia </td><td align=center> Vía </td><td align=center> Inicio </td><td align=center> Condición </td></tr>';
						}
						
						if(isset($regletaFamilia[$codFamilia][$cont2]['tooltip']))
						{
							$regletaFamilia[$codFamilia][$cont2]['tooltip'] .= '<tr style=background-color:'.$bgTooltip.'><td> '.$info['Kadart'].' </td><td> '.trim($info['Artgen']).' </td><td> '.$dosisArticulo.' '.$unidadArticulo.' </td><td align=center> '.$info['Artuni'].' </td><td align=center> '.$info['Kadper'].' </td><td align=center> '.$info['Kadvia'].' </td><td align=center> '.$info['Kadfin'].' </td><td align=center> '.$info['Kadcnd'].' </td></tr>';
						}
					}
					
					if($cont2 == 24){
						$cont2 = 0;
					}

					$cont3++;
					$cont2++;

					if($cont2 % 2 != 0){
						$cont2++;
					}
					if($cont3 % 2 != 0){
						$cont3++;
					}

					if($cont2 == $horaArranque){
						break;
					}
				}
				
				// Indico si hay mas de un articulo en la familia
				if($auxFamilia == $codFamilia)
					$regletaFamilia[$codFamilia]['esCompuestaFamilia'] = '1';

				$auxFamilia = $codFamilia;
			}	
			//$regletaFamilia = $rondasFamilia;
			
			unset($arrAplicacion);
			//unset($rondasFamilia);
			unset($colPeriodicidades);
			
			/********************************************************************/
			
			$detalle->codigoArticulo = $info['Kadart']."-".$info['Kadori']."-".$info['Artgen'];
			$detalle->cantidadDosis = $info['Kadcfr'];
			$detalle->unidadDosis = $info['Kadufr'];
			$detalle->diasTratamiento = $info['Kaddia'];
			$detalle->estadoRegistro = $info['Kadest'];
			$detalle->estadoAdministracion = $info['Kadess'];
			$detalle->periodicidad = $info['Kadper'];
			$detalle->condicionSuministro = $info['Kadcnd'];
			$detalle->dosisMaxima = $info['Kaddma'];
			$detalle->formaFarmaceutica = $info['Kadffa'];
			$detalle->fechaInicioAdministracion = $info['Kadfin'];
			$detalle->horaInicioAdministracion = $info['Kadhin'];
			$detalle->via = $info['Kadvia'];
			$detalle->fechaKardex = $info['Kadfec'];
			$detalle->suspendido = $info['Kadsus'];
			$detalle->estaConfirmado = $info['Kadcon'];
			$detalle->origen = $info['Kadori'];
			$detalle->observaciones = $info['Kadobs'];
			$detalle->cantidadUnidadManejo = $info['Kadcma'];
			$detalle->unidadManejo = $info['Artuni'];
			$detalle->grupo = $info['Famctr'] == 'on' ? 'CTR' : $info['Artgru'];
			$detalle->cantidadADispensar = $info['Kadcdi'];
			$detalle->cantidadDispensada = $info['Kaddis'];
			$detalle->tipoProtocolo = $info['Kadpro'];
			$detalle->centroCostos	= $info['Kadcco'];
			$detalle->estadoArticulo =  $info['Artest'];
			$detalle->imprimirArticulo =  $info['Kadimp'];
			$detalle->altaArticulo =  $info['Kadalt'];
			$detalle->cantidadAlta = $info['Kadcal'];
			$detalle->dosisAdaptada = $info['Kaddoa'];
			$detalle->noEsteril = $info['Kadnes'];
			$detalle->pendiente_leer = $info['Kadpen'];
			
			$detalle->codigoCreador = $info['Kadusu'];
			
			// $detalle->esPos = $info['Artcod'] == "N" ? false : true;
			$detalle->esPos = $info['Artpos'] == "N" ? false : true;
			
			$resFam = consultarPrincipiosActivosPorFamilia( $conex, $wbasedato, $info['Famcod'] );
			$codsFam = codigosPrincipiosActivos( $resFam );
			$detalle->codigoPrincipioActivo = $codsFam;		//Junio 16 de 2015
			
			$detalle->nombreGenerico = $nombreArticulo;		//Agosto 27 de 2012
			
			$gruposAntibioticos = consultarAliasPorAplicacion( $conex, $wemp_pmla, "gruposMedicamentosAntibioticos" );
			$gruposAntibioticos = explode(",", $gruposAntibioticos );
			
			$detalle->esAntibiotico = in_array( $info['Artgru'], $gruposAntibioticos );
			
			$detalle->presentacionPermiteDA = presentacionPermiteDA( $conex, $wbasedato, $detalle->unidadManejo );
			$detalle->presentacionPermiteNE = presentacionPermiteNE( $conex, $wbasedato, $detalle->unidadManejo );
			
			switch($detalle->tipoProtocolo){
				case $protocoloNormal:
					$detalle->nombreProtocolo = $nombreProtocoloNormal;
					break;
				case $protocoloNutricion:
					$detalle->nombreProtocolo = $nombreProtocoloNutricion;
					break;
				case $protocoloAnalgesia:
					$detalle->nombreProtocolo = $nombreProtocoloAnalgesia;
					break;
				case $protocoloQuimioterapia:
					$detalle->nombreProtocolo = $nombreProtocoloQuimioterapia;
					break;
				default:
					$detalle->nombreProtocolo = $nombreProtocoloNormal;
					break;
						
			}
			
			$detalle->idOriginal = $info[ 'Kadido' ];
			
			$detalle->esLev = false;
			if( $info['Kadlev'] == 'on' ){
				$detalle->tipoProtocolo = 'LQ';
				$detalle->esLev = true;
			}
			
			$detalle->esLactario = false;
			if( esArticuloLactario( $conex, $wbasedato, $info['Kadart'] ) ){
				$detalle->esLactario = true;
			}

			//Kadcma-Kadufr
			if(isset($info['Kadcma']) && !empty($info['Kadcma'])){
				$detalle->maximoUnidadManejo = $info['Kadcma'];
				$detalle->unidadMaximoManejo = $info['Kadufr'];
//				$detalle->vencimiento		 = $info['Defven'];
//				$detalle->diasVencimiento	 = $info['Defdie'];
//				$detalle->esDispensable		 = $info['Defdis'];
//				$detalle->esDuplicable		 = $info['Defdup'];

				//No modificar
				$detalle->permiteModificar	 = true;

				//Consulta de los dias de tratamiento de este articulo
				obtenerDatosAdicionalesArticulo($historia, $ingreso, $info['Kadart'], $detalle->diasTotalesTto, $detalle->dosisTotalesTto);

				//Consulta de cantidades ctc
				//****************************Consulta de las cantidades del CTC autorizado acumulado y usado
				$q2 = "SELECT Ctccau,Ctccus,Ctcuca FROM {$wbasedato}_000095 WHERE Ctchis = '".$historia."' AND Ctcing = '".$ingreso."' AND Ctcart = '".$info['Kadart']."'";
				$res2 = mysql_query($q2, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());
				while($info2 = mysql_fetch_array($res2)){
					$detalle->cantidadAutorizadaCtc 	= $info2['Ctccau'];
					$detalle->cantidadUtilizadaCtc 		= consultarCantidadAcumuladaDispensada($conex,$wbasedato,$historia,$ingreso,$info['Kadart']);
					$detalle->unidadesCantidadesCtc 	= $info2['Ctcuca'];
				}
				//***************************

				//Consulta de vias del articulo
				//****************************
				$q3 = "SELECT Defcco,Defart,Deffra,Deffru,Defest,Defven,Defdie,Defdis,Defdup,Defcon,Defnka,Defdim,Defdom,Defvia FROM {$wbasedato}_000059 WHERE Defart = '".$info['Kadart']."' AND Defest = 'on'";
				$res3 = mysql_query($q3, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q3 . " - " . mysql_error());
				if($info3 = mysql_fetch_array($res3)){
					$detalle->viasPosibles 	= $info3['Defvia'];
					
					//Consulto si es dispensable y duplicable
					$detalle->esDispensable = $info3['Defdis'];	//Marzo 3 de 2011
					$detalle->esDuplicable =  $info3['Defdup'];	//Marzo 3 de 2011
				}
				//***************************
				
				$detalle->setDatosExtension();
				
				$coleccion[] = $detalle;
			}
		}
	}
	return $coleccion;
}

function consultarDetalleDefinitivoKardex($paciente,$historia,$ingreso,$fecha,$tipoProtocolo,$esDePiso,$pestAlta='off'){
	global $wbasedato;
	global $conex;
	global $wemp_pmla;

	global $centroCostosServicioFarmaceutico;
	global $codigoServicioFarmaceutico;
	global $codigoCentralMezclas;
	global $centroCostosCentralMezclas;
	
	//Protocolos
	global $protocoloNormal;
	global $protocoloNutricion;
	global $protocoloAnalgesia;
	global $protocoloQuimioterapia;

	global $nombreProtocoloNormal;
	global $nombreProtocoloNutricion;
	global $nombreProtocoloAnalgesia;
	global $nombreProtocoloQuimioterapia;

	global $usuario;		//Información de usuario
	
	global $regletaFamilia;
	global $wcenmez;

	$coleccion = array();

	$condicionFecha = " AND Kadfec = '$fecha' ";
	$condicionAlta = " AND Kadalt != 'on' ";
	$condicionGroupBy = "";
	if($pestAlta=='on')
	{
		$condicionAlta = " AND Kadimp = 'on' ";
		//$condicionFecha = "";
		$condicionGroupBy = " GROUP BY Kadart ";
	}
		
	//*******************************Grupos que puede ver el centro de costos del usuario
	$tieneGruposIncluidos = false;
	if($usuario->gruposMedicamentos != "*" && $usuario->gruposMedicamentos != '' && $usuario->gruposMedicamentos != 'NO APLICA'){
		$tieneGruposIncluidos = true;
	}
	//********************************
	
	/************************************************************
	 * Junio 14 de 2012
	 ************************************************************/
	$valCcoquery = '';
	if( $usuario->centroCostosGrabacion != '*' ){
		$valCcoquery = " AND Kadcco = '$usuario->centroCostosGrabacion' ";
	}
	/************************************************************/
	
	/********************************************************************************
	 * Noviembre 07 de 2017
	 * Si el paciente es de ayuda dx, solo cargo los articulos de la respectiva ayuda dx
	 ********************************************************************************/
	$ccoAyudaDx = '';
	
	$validarCcoAyudaDx = " AND ( Kadhis IN( 
		SELECT Ekxhis 
		  FROM ".$wbasedato."_000208
		 WHERE Ekxhis = Kadhis
		   AND Ekxing = Kading
		   AND Ekxfec = Kadfec
		   AND Ekxart = Kadart
		   AND Ekxido = Kadido
		   AND ( Ekxayu = '".$ccoAyudaDx."'
		    OR ( Ekxayu != '' AND Kadess != 'on' ) ) ) 
			OR Kadhis NOT IN ( 
		SELECT Ekxhis 
		  FROM ".$wbasedato."_000208
		 WHERE Ekxhis = Kadhis
		   AND Ekxing = Kading
		   AND Ekxfec = Kadfec
		   AND Ekxart = Kadart
		   AND Ekxido = Kadido ) )";
		   
	if( $paciente->esDeAyudaDx && !$esDePiso ){
		$ccoAyudaDx =  $paciente->servicioActual;
		$validarCcoAyudaDx = "";
	}
	
		   
	// $validarCcoAyudaDx = " AND ( Kadhis IN( 
		// SELECT Ekxhis 
		  // FROM ".$wbasedato."_000208
		 // WHERE Ekxhis = Kadhis
		   // AND Ekxing = Kading
		   // AND Ekxfec = Kadfec
		   // AND Ekxart = Kadart
		   // AND Ekxido = Kadido
		   // AND ( Ekxayu = '".$ccoAyudaDx."'
		    // OR ( Ekxayu != '' AND Kadess != 'on' ) ) ) 
			// OR Kadhis NOT IN ( 
		// SELECT Ekxhis 
		  // FROM ".$wbasedato."_000208
		 // WHERE Ekxhis = Kadhis
		   // AND Ekxing = Kading
		   // AND Ekxfec = Kadfec
		   // AND Ekxart = Kadart
		   // AND Ekxido = Kadido ) )";
	/********************************************************************************/

	$q = "	SELECT
				Kadart,Artcom,Artgen,Artuni,SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kaddis,Kaduma,Kadcma,Kadpro,Kadcco,Kadnar, Artest, Kadusu, Famcod, Famnom, Kadimp, Kadalt, Kadcal, Kadlev, Famctr, Kaddoa, Kadido, Kadpen, Kadnes, Artpos
			FROM
				".$wbasedato."_000054, ".$wbasedato."_000026, ".$wbasedato."_000115, ".$wbasedato."_000114
			WHERE
				Kadhis = '$historia'
				AND Kading = '$ingreso'
				$condicionFecha ";
				if($tieneGruposIncluidos){
					$q .= " AND Kadori = '$codigoServicioFarmaceutico' ";
					$q .= " AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN $usuario->gruposMedicamentosQuery ";
				}
				$q .= " AND Kadpro LIKE '$tipoProtocolo'
				$valCcoquery
				AND Kadori = '$codigoServicioFarmaceutico' 
				
				AND Artcod = Kadart 
				AND Kadart = Relart
				AND Relfam = Famcod 
				$condicionAlta
				$condicionGroupBy 
				$validarCcoAyudaDx
			UNION
			
			SELECT
				Kadart,Artcom,Artgen,Artuni,SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kaddis,Kaduma,Kadcma,Kadpro,Kadcco,Kadnar, Artest, Kadusu, Famcod, Famnom, Kadimp, Kadalt, Kadcal, Kadlev, Famctr, Kaddoa, Kadido, Kadpen, Kadnes, Artpos
			FROM
				".$wbasedato."_000054, ".$wbasedato."_000026, ".$wbasedato."_000114
			WHERE
				Kadhis = '$historia'
				AND Kading = '$ingreso'
				$condicionFecha ";
				if($tieneGruposIncluidos){
					$q .= " AND Kadori = '$codigoServicioFarmaceutico' ";
					$q .= " AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN $usuario->gruposMedicamentosQuery ";
				}
				$q .= " AND Kadpro LIKE '$tipoProtocolo'
				$valCcoquery
				AND Kadori = '$codigoServicioFarmaceutico' 
				
				AND Artcod = Kadart 
				AND Kadctr = Famcod 
				AND Kadart NOT IN( SELECT relart FROM ".$wbasedato."_000115 )
				$condicionAlta
				$condicionGroupBy
				$validarCcoAyudaDx
				 ";

	$subConsulta = " SELECT
						Kadart,Artcom,Artgen,Artuni,'' Artgru,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kaddis,Kaduma,Kadcma,Kadpro,Kadcco,Kadnar, Artest, Kadusu, Famcod, Famnom, Kadimp, Kadalt, Kadcal, Kadlev, Famctr, Kaddoa, Kadido, Kadpen, Kadnes,'' as Artpos
					FROM
						".$wbasedato."_000054, {$wcenmez}_000002, ".$wbasedato."_000115, ".$wbasedato."_000114
					WHERE
						Kadhis = '$historia'
						AND Kading = '$ingreso'
						$condicionFecha
						AND Kadpro LIKE '$tipoProtocolo'
						AND Kadori = '$codigoCentralMezclas'
						
						$valCcoquery
						AND Artcod = Kadart 
						AND Kadart = Relart
						AND Relfam = Famcod 
						$condicionAlta 
						$condicionGroupBy 
						$validarCcoAyudaDx
					UNION
					
					SELECT
						Kadart,Artcom,Artgen,Artuni,'' Artgru,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kaddis,Kaduma,Kadcma,Kadpro,Kadcco,Kadnar, Artest, Kadusu, Famcod, Famnom, Kadimp, Kadalt, Kadcal, Kadlev, Famctr, Kaddoa, Kadido, Kadpen, Kadnes, '' as Artpos
					FROM
						".$wbasedato."_000054, {$wcenmez}_000002, ".$wbasedato."_000114
					WHERE
						Kadhis = '$historia'
						AND Kading = '$ingreso'
						$condicionFecha 

						AND Kadpro LIKE '$tipoProtocolo'
						$valCcoquery
						AND Kadori = '$codigoCentralMezclas' 
						
						AND Artcod = Kadart 
						AND Kadctr = Famcod 
						AND Kadart NOT IN( SELECT relart FROM ".$wbasedato."_000115 )
						$condicionAlta
						$condicionGroupBy 
						$validarCcoAyudaDx
						";

	if($usuario->esUsuarioCM){
		$q = $subConsulta;
	} else {
		if(!$tieneGruposIncluidos){
			$q = $q." UNION ".$subConsulta;
		}
	}
	$q = $q." ORDER BY Famcod, Artcom ";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if ($num > 0)
	{
		$cont1 = 0;
		$auxFamilia = "";

		while ($cont1 < $num){
			$cont1++;
				
			$detalle = new detalleKardexDTO();
				
			//$rondasFamilia = array();
			
			$info = mysql_fetch_array($res);

			$detalle->historia = $historia;
			$detalle->ingreso = $ingreso;
			$detalle->fecha = $fecha;
			
			$nombreArticulo = "";
			if(isset($info['Kadnar']) && !empty($info['Kadnar'])){
				$detalle->nombreArticulo	= $info['Kadnar'];
				$nombreArticulo = $detalle->nombreArticulo;
			} else {
				$nombreArticulo = $info['Artcom'];
			}
			
			$detalle->codigoFamilia = $info['Famcod'];
			$detalle->nombreFamilia = $info['Famnom'];
			$codFamilia = $info['Famcod'];

			/***********************************************************************/
			/******************* Calculo de regleta por familia ********************/
			/***********************************************************************/

			$colPeriodicidades = consultarPeriodicidades();
			$colPeriodicidades = array_merge( $colPeriodicidades, consultarPeriodicidades( 'I' ) );
			foreach ($colPeriodicidades as $periodicidad){
				if($periodicidad->codigo == $info['Kadper']){
					$horaPeriodicidad = intval($periodicidad->equivalencia);
					break;
				}
			}
			
			if( $info['Kadlev'] != 'on' ){	
				$arrAplicacion = array();
				
				// se debe enviar la dosis 
				$dosisArticulo = $info['Kadcfr'];
				$unidadArticulo = $info['Kadufr'];
				
				// validar si es producto de central de mezclas
				if($info['Kadori']==$codigoCentralMezclas)
				{
					// si es una DA con purga debe mostrar la dosis ordenada (sin purga)
					$articuloSinPurga = consultarDosisSinPurgaDA($conex,$wbasedato,$wcenmez,$historia,$ingreso,$info['Kadart'],$info['Kadido'],$dosisArticulo,$unidadArticulo,$formaFarmaceuticaArticulo);
					$dosisArticulo = $articuloSinPurga['dosis'];
					$unidadArticulo = $articuloSinPurga['unidad'];
				}
				
				$arrAplicacion = obtenerVectorAplicacionMedicamentos(date("Y-m-d"),$info['Kadfin'],$info['Kadhin'],$horaPeriodicidad,$dosisArticulo);
				
				$horaArranque = 2;

				$cont3 = 1;
				$cont2 = $horaArranque;   //Desplazamiento desde la hora inicial
				$caracterMarca = $info['Kadcfr'];

				while($cont3 <= 24){
				
					if(!isset($arrAplicacion[$cont2]) || $arrAplicacion[$cont2]=="" || $arrAplicacion[$cont2]==" " || $arrAplicacion[$cont2]=="-")
						$arrAplicacion[$cont2] = 0;
					
					if(!array_key_exists($codFamilia,$regletaFamilia))
					{
						$regletaFamilia[$codFamilia] = array();
						$regletaFamilia[$codFamilia]['esCompuestaFamilia'] = '0';
					}
					
					if(array_key_exists($cont2,$regletaFamilia[$codFamilia]))
					{
						if($info['Kadsus'] != 'on' ){
							$regletaFamilia[$codFamilia][$cont2]['valor'] += $arrAplicacion[$cont2]*1;
						}
					} 
					else 
					{
						if($info['Kadsus'] != 'on' ){
							$regletaFamilia[$codFamilia][$cont2] = array();
							$regletaFamilia[$codFamilia][$cont2]['valor'] = $arrAplicacion[$cont2]*1;
						}
					}

					if($arrAplicacion[$cont2] > 0)
					{
						if(isset($regletaFamilia[$codFamilia][$cont2]['condicion']) && $regletaFamilia[$codFamilia][$cont2]['condicion']!="")
						{
							$pos = strpos($regletaFamilia[$codFamilia][$cont2]['condicion'], "|".$info['Kadcnd']);
							if ($pos === false && $regletaFamilia[$codFamilia][$cont2]['condicion'] != $info['Kadcnd'])
								$regletaFamilia[$codFamilia][$cont2]['condicion'] .= "|".$info['Kadcnd'];
						}
						else
						{
							if($info['Kadcnd']!="")
								$regletaFamilia[$codFamilia][$cont2]['condicion'] = "|".$info['Kadcnd'];
							else
								$regletaFamilia[$codFamilia][$cont2]['condicion'] = "";
						}
					
						if(isset($regletaFamilia[$codFamilia][$cont2]['unidad']) && $regletaFamilia[$codFamilia][$cont2]['unidad']!="")
						{
							$pos = strpos($regletaFamilia[$codFamilia][$cont2]['unidad'], "|".$unidadArticulo);
							if ($pos === false && $regletaFamilia[$codFamilia][$cont2]['unidad'] != $unidadArticulo)
								$regletaFamilia[$codFamilia][$cont2]['unidad'] .= $unidadArticulo;
						}
						else
							$regletaFamilia[$codFamilia][$cont2]['unidad'] = $unidadArticulo;
							

						if(!isset($regletaFamilia[$codFamilia][$cont2]['cont']))
							$regletaFamilia[$codFamilia][$cont2]['cont'] = 1; 
						else
							$regletaFamilia[$codFamilia][$cont2]['cont']++; 
							
						if(isset($regletaFamilia[$codFamilia][$cont2]['cont']) && $regletaFamilia[$codFamilia][$cont2]['cont'] % 2 != 0)
							$bgTooltip = "#C3D9FF";
						else
							$bgTooltip = "#E8EEF7";
						
						if(!isset($regletaFamilia[$codFamilia][$cont2]['tooltip']) || $regletaFamilia[$codFamilia][$cont2]['tooltip']=="")
						{
							$regletaFamilia[$codFamilia][$cont2]['tooltip'] = '<table cellspacing=4>';
							$regletaFamilia[$codFamilia][$cont2]['tooltip'] .= '<tr style=background-color:#2A5DB0;color:#ffffff><td align=center> Código </td><td align=center> Nombre </td><td align=center> Dosis </td><td align=center> Unidad </td><td align=center> Frecuencia </td><td align=center> Vía </td><td align=center> Inicio </td><td align=center> Condición </td></tr>';
						}
						
						if(isset($regletaFamilia[$codFamilia][$cont2]['tooltip']) and $info['Kadsus'] != 'on')
						{
							$regletaFamilia[$codFamilia][$cont2]['tooltip'] .= '<tr style=background-color:'.$bgTooltip.'><td> '.$info['Kadart'].' </td><td> '.trim($info['Artgen']).' </td><td> '.$dosisArticulo.' '.$unidadArticulo.' </td><td align=center> '.$info['Artuni'].' </td><td align=center> '.$info['Kadper'].' </td><td align=center> '.$info['Kadvia'].' </td><td align=center> '.$info['Kadfin'].' </td><td align=center> '.$info['Kadcnd'].' </td></tr>';
						}
					}
					
					
					if($cont2 == 24){
						$cont2 = 0;
					}

					$cont3++;
					$cont2++;

					if($cont2 % 2 != 0){
						$cont2++;
					}
					if($cont3 % 2 != 0){
						$cont3++;
					}

					if($cont2 == $horaArranque){
						break;
					}
				}

				// Indico si hay mas de un articulo en la familia
				if($auxFamilia == $codFamilia)
					$regletaFamilia[$codFamilia]['esCompuestaFamilia'] = '1';

				$auxFamilia = $codFamilia;
			}	
			
			//$regletaFamilia = $rondasFamilia;
			
			unset($arrAplicacion);
			//unset($rondasFamilia);
			unset($colPeriodicidades);
			
			/********************************************************************/
			
			$detalle->codigoArticulo = $info['Kadart']."-".$info['Kadori']."-".$nombreArticulo;
			$detalle->cantidadDosis = $info['Kadcfr'];
			$detalle->unidadDosis = $info['Kadufr'];
			$detalle->diasTratamiento = $info['Kaddia'];
			$detalle->estadoRegistro = $info['Kadest'];
			$detalle->estadoAdministracion = $info['Kadess'];
			$detalle->periodicidad = $info['Kadper'];
			$detalle->condicionSuministro = $info['Kadcnd'];
			$detalle->formaFarmaceutica = $info['Kadffa'];
			$detalle->dosisMaxima = $info['Kaddma'];
			$detalle->fechaInicioAdministracion = $info['Kadfin'];
			$detalle->horaInicioAdministracion = $info['Kadhin'];
			$detalle->via = $info['Kadvia'];
			$detalle->fechaKardex = $info['Kadfec'];
			$detalle->suspendido = $info['Kadsus'];
			$detalle->estaConfirmado = $info['Kadcon'];
			$detalle->origen = $info['Kadori'];
			$detalle->observaciones = $info['Kadobs'];
			$detalle->cantidadUnidadManejo = $info['Kadcma'];
			$detalle->unidadManejo = $info['Artuni'];
			$detalle->grupo = $info[ 'Famctr' ] == 'on' ? 'CTR' : $info['Artgru'];
			$detalle->tipoProtocolo = $info['Kadpro'];
			$detalle->nombreArticulo	= $info['Kadnar'];
			$detalle->estadoArticulo = $info['Artest'];
			$detalle->imprimirArticulo = $info['Kadimp'];
			$detalle->altaArticulo = $info['Kadalt'];
			$detalle->cantidadAlta = $info['Kadcal'];
			$detalle->dosisAdaptada = $info['Kaddoa'];
			$detalle->noEsteril = $info['Kadnes'];
			$detalle->pendiente_leer = $info['Kadpen'];
			
			$detalle->codigoCreador = $info['Kadusu'];
			
			
			$detalle->esPos = $info['Artpos'] == "N" ? false : true;
			
			$resFam = consultarPrincipiosActivosPorFamilia( $conex, $wbasedato, $info['Famcod'] );
			$codsFam = codigosPrincipiosActivos( $resFam );
			$detalle->codigoPrincipioActivo = $codsFam;		//Junio 16 de 2015
			
			$detalle->nombreGenerico = $info['Artgen'];		//Agosto 27 de 2012
			
			$gruposAntibioticos = consultarAliasPorAplicacion( $conex, $wemp_pmla, "gruposMedicamentosAntibioticos" );
			$gruposAntibioticos = explode(",", $gruposAntibioticos );
			
			$detalle->esAntibiotico = in_array( $info['Artgru'], $gruposAntibioticos );
			
			$detalle->presentacionPermiteDA = presentacionPermiteDA( $conex, $wbasedato, $detalle->unidadManejo );	//Marzo 02 de 2015
			$detalle->presentacionPermiteNE = presentacionPermiteNE( $conex, $wbasedato, $detalle->unidadManejo );	//Marzo 02 de 2015

			switch($detalle->tipoProtocolo){
				case $protocoloNormal:
					$detalle->nombreProtocolo = $nombreProtocoloNormal;
					break;
				case $protocoloNutricion:
					$detalle->nombreProtocolo = $nombreProtocoloNutricion;
					break;
				case $protocoloAnalgesia:
					$detalle->nombreProtocolo = $nombreProtocoloAnalgesia;
					break;
				case $protocoloQuimioterapia:
					$detalle->nombreProtocolo = $nombreProtocoloQuimioterapia;
					break;
				default:
					$detalle->nombreProtocolo = $nombreProtocoloNormal;
					break;
						
			}
			
			$detalle->idOriginal = $info[ 'Kadido' ];
			
			$detalle->esLev = false;
			if( $info['Kadlev'] == 'on' ){
				$detalle->tipoProtocolo = 'LQ';
				$detalle->esLev = true;
			}
			
			$detalle->esLactario = false;
			if( esArticuloLactario( $conex, $wbasedato, $info['Kadart'] ) ){
				$detalle->esLactario = true;
			}
			
			//Kadcma-Kadufr
			if(isset($info['Kadcma']) && !empty($info['Kadcma'])){
				$detalle->maximoUnidadManejo = $info['Kadcma'];
				$detalle->unidadMaximoManejo = $info['Kadufr'];
//				$detalle->vencimiento		 = $info['Defven'];
//				$detalle->esDispensable		 = $info['Defdis'];
//				$detalle->esDuplicable		 = $info['Defdup'];

				$detalle->permiteModificar 	 = true;

				//Consulta de los dias de tratamiento de este articulo
				obtenerDatosAdicionalesArticulo($historia, $ingreso, $info['Kadart'], $detalle->diasTotalesTto, $detalle->dosisTotalesTto);

				//Consulta de cantidades ctc
				//****************************Consulta de las cantidades del CTC autorizado acumulado y usado
				$q2 = "SELECT Ctccau,Ctccus,Ctcuca FROM {$wbasedato}_000095 WHERE Ctchis = '".$historia."' AND Ctcing = '".$ingreso."' AND Ctcart = '".$info['Kadart']."'";
				$res2 = mysql_query($q2, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());
				while($info2 = mysql_fetch_array($res2)){
					$detalle->cantidadAutorizadaCtc 	= $info2['Ctccau'];
					$detalle->cantidadUtilizadaCtc 		= consultarCantidadAcumuladaDispensada($conex,$wbasedato,$historia,$ingreso,$info['Kadart']);
					$detalle->unidadesCantidadesCtc 	= $info2['Ctcuca'];
				}
				//***************************
				
				//Consulta de vias del articulo
				//*****************************
				$q3 = "SELECT Defcco,Defart,Deffra,Deffru,Defest,Defven,Defdie,Defdis,Defdup,Defcon,Defnka,Defdim,Defdom,Defvia FROM {$wbasedato}_000059 WHERE Defart = '".$info['Kadart']."' AND Defest = 'on'";
				$res3 = mysql_query($q3, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q3 . " - " . mysql_error());
				if($info3 = mysql_fetch_array($res3)){
					$detalle->viasPosibles 	= $info3['Defvia'];
					
					//Consulto si es dispensable y duplicable
					$detalle->esDispensable = $info3['Defdis'];	//Marzo 3 de 2011
					$detalle->esDuplicable =  $info3['Defdup'];	//Marzo 3 de 2011
				}
				//***************************
				
				$detalle->setDatosExtension();
				
				$coleccion[] = $detalle;
			}
		}
	}
	return $coleccion;
}



/**
 * Consulta el detalle del kardex del dia anterior para mostrarlo en pantalla (en caso de no tener uno el dia seleccionado)
 * @param unknown_type $historia
 * @param unknown_type $ingreso
 * @param unknown_type $wfecha
 */
function consultarDetalleKardexAlta($historia,$ingreso,$fecha,$tipoProtocolo,$pestAlta='off'){
	//,$centroCostosMovimiento,$gruposMedicamentosMovimiento
	global $wbasedato;
	global $conex;
	global $wemp_pmla;
	global $codigoServicioFarmaceutico;
	global $codigoCentralMezclas;
	global $centroCostosServicioFarmaceutico;
	global $centroCostosCentralMezclas;
	global $usuario;		//Información de usuario

	//Protocolos
	global $protocoloNormal;
	global $protocoloNutricion;
	global $protocoloAnalgesia;
	global $protocoloQuimioterapia;

	global $nombreProtocoloNormal;
	global $nombreProtocoloNutricion;
	global $nombreProtocoloAnalgesia;
	global $nombreProtocoloQuimioterapia;
	
	global $regletaFamilia;
	
	$coleccion = array();

	//*******************************Grupos que puede ver el centro de costos del usuario
	$tieneGruposIncluidos = false;
	if($usuario->gruposMedicamentos != "*" && $usuario->gruposMedicamentos != '' && $usuario->gruposMedicamentos != 'NO APLICA'){
		$tieneGruposIncluidos = true;
	}
	//********************************
	
	$condicionAlta = "";
	$condicionFecha = "";
	$condicionGroupBy = " GROUP BY Kadart ";
	/****************************************************************************************
	 * Junio 14 de 2012
	 ****************************************************************************************/
	$validarCco = "";
	
	if( $usuario->centroCostosGrabacion != '*' ){
		$validarCco = " AND Kadcco = '$usuario->centroCostosGrabacion'";
	}
	/****************************************************************************************/

		$q = "	SELECT
					Kadart,Artcom,Artgen,Artuni,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kadcdi,Kaddis,Kadpro,Kadcco,SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru,Kaddis,Kaduma,Kadcma,Kadnar, Artest, Kadusu, Famcod, Famnom, Kadimp, Kadalt, Kadcal, Kadlev, Kaddoa, Kadido, Kadpen, Kadnes, Famctr, Artpos
				FROM
					".$wbasedato."_000054, ".$wbasedato."_000026, ".$wbasedato."_000115, ".$wbasedato."_000114
				WHERE
					Kadhis = '$historia'
					AND Kading = '$ingreso'
					$condicionFecha ";
					if($tieneGruposIncluidos){
						$q .= " AND Kadori = '$codigoServicioFarmaceutico' ";
						$q .= " AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN $usuario->gruposMedicamentosQuery ";
					}
					$q .= " AND Kadpro LIKE '$tipoProtocolo'
					$valCcoquery
					AND Kadori = '$codigoServicioFarmaceutico' 
					AND Kadsus != 'on'
					AND Artcod = Kadart 
					AND Kadart = Relart
					AND Relfam = Famcod 
					$condicionAlta
					$condicionGroupBy ";
		
		$q .= " UNION ";
		
		$q .= "SELECT
				Kadart,Artcom,Artgen,Artuni,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kadcdi,Kaddis,Kadpro,Kadcco,SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru,Kaddis,Kaduma,Kadcma,Kadnar, Artest, Kadusu, Famcod, Famnom, Kadimp, Kadalt, Kadcal, Kadlev, Kaddoa, Kadido, Kadpen, Kadnes, Famctr, Artpos
			FROM
				".$wbasedato."_000060, ".$wbasedato."_000026, ".$wbasedato."_000115, ".$wbasedato."_000114
			WHERE
				Kadhis = '$historia'
				AND Kading = '$ingreso'
				$condicionFecha ";
				if($tieneGruposIncluidos){
					$q .= " AND Kadori = '$codigoServicioFarmaceutico' ";
					$q .= " AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN $usuario->gruposMedicamentosQuery ";
				}
				$q .= " AND Kadpro LIKE '$tipoProtocolo'
				AND Artcod = Kadart
				AND kadori = '$codigoServicioFarmaceutico'
				AND Kadsus != 'on'
				AND Kadart = Relart
				AND Relfam = Famcod
				$condicionAlta
				$validarCco
				$condicionGroupBy ";

	$subConsulta = " SELECT
						Kadart,Artcom,Artgen,Artuni,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kadcdi,Kaddis,Kadpro,Kadcco,'' Artgru,Kaddis,Kaduma,Kadcma,Kadnar, Artest, Kadusu, Famcod, Famnom, Kadimp, Kadalt, Kadcal, Kadlev, Kaddoa, Kadido, Kadpen, Kadnes, Famctr, '' as Artpos
					FROM
						".$wbasedato."_000060, cenpro_000002, ".$wbasedato."_000115, ".$wbasedato."_000114
					WHERE
						Kadhis = '$historia'
						AND Kading = '$ingreso'
						$condicionFecha
						AND Kadpro LIKE '$tipoProtocolo'
						AND Kadori = '$codigoCentralMezclas'
						AND Artcod = Kadart
						AND Kadsus != 'on'
						AND Kadart = Relart
						AND Relfam = Famcod
						$condicionAlta
						$validarCco
						$condicionGroupBy ";

	if($usuario->esUsuarioCM){
		$q = $subConsulta;
	} else {
		if(!$tieneGruposIncluidos){
			$q = $q." UNION ".$subConsulta;
		}
	}
	$q = $q." ORDER BY Famcod, Artcom ";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if ($num > 0)
	{
		$cont1 = 0;
		$auxFamilia = "";

		while ($cont1 < $num){
			$cont1++;
				
			$detalle = new detalleKardexDTO();

			//$rondasFamilia = array();
			
			$vectorDosis = array();
			
			$info = mysql_fetch_array($res);

			$detalle->historia = $historia;
			$detalle->ingreso = $ingreso;
			$detalle->fecha = $fecha;
			
			$nombreArticulo = "";
			if(isset($info['Kadnar']) && !empty($info['Kadnar'])){
				$detalle->nombreArticulo	= $info['Kadnar'];
				$nombreArticulo = $detalle->nombreArticulo;
			} else {
				$nombreArticulo = $info['Artcom'];
			}
			
			$detalle->codigoFamilia = $info['Famcod'];
			$detalle->nombreFamilia = $info['Famnom'];
			$codFamilia = $info['Famcod'];

			/***********************************************************************/
			/******************* Calculo de regleta por familia ********************/
			/***********************************************************************/

			$colPeriodicidades = consultarPeriodicidades();
			foreach ($colPeriodicidades as $periodicidad){
				if($periodicidad->codigo == $info['Kadper']){
					$horaPeriodicidad = intval($periodicidad->equivalencia);
					break;
				}
			}
			
			if( $info['Kadlev'] != 'on' ){	
				$arrAplicacion = array();
				
				$arrAplicacion = obtenerVectorAplicacionMedicamentos(date("Y-m-d"),$info['Kadfin'],$info['Kadhin'],$horaPeriodicidad,$info['Kadcfr']);
				
				$horaArranque = 2;

				$cont3 = 1;
				$cont2 = $horaArranque;   //Desplazamiento desde la hora inicial
				$caracterMarca = $info['Kadcfr'];

				while($cont3 <= 24)
				{
				
					if(!isset($arrAplicacion[$cont2]) || $arrAplicacion[$cont2]=="" || $arrAplicacion[$cont2]==" " || $arrAplicacion[$cont2]=="-")
						$arrAplicacion[$cont2] = 0;
					
					if(!array_key_exists($codFamilia,$regletaFamilia))
						$regletaFamilia[$codFamilia] = array();
					
					if(array_key_exists($cont2,$regletaFamilia[$codFamilia]))
					{
						$regletaFamilia[$codFamilia][$cont2]['valor'] += $arrAplicacion[$cont2]*1;
					} 
					else 
					{
						$regletaFamilia[$codFamilia][$cont2] = array();
						$regletaFamilia[$codFamilia][$cont2]['valor'] = $arrAplicacion[$cont2]*1;
					}

					if($arrAplicacion[$cont2] > 0)
					{
						if(isset($regletaFamilia[$codFamilia][$cont2]['condicion']) && $regletaFamilia[$codFamilia][$cont2]['condicion']!="")
						{
							$pos = strpos($regletaFamilia[$codFamilia][$cont2]['condicion'], "|".$info['Kadcnd']);
							if ($pos === false && $regletaFamilia[$codFamilia][$cont2]['condicion'] != $info['Kadcnd'])
								$regletaFamilia[$codFamilia][$cont2]['condicion'] .= "|".$info['Kadcnd'];
						}
						else
						{
							$regletaFamilia[$codFamilia][$cont2]['condicion'] = $info['Kadcnd'];
						}

						if(isset($regletaFamilia[$codFamilia][$cont2]['unidad']) && $regletaFamilia[$codFamilia][$cont2]['unidad']!="")
						{
							$pos = strpos($regletaFamilia[$codFamilia][$cont2]['unidad'], "|".$info['Kadufr']);
							if ($pos === false && $regletaFamilia[$codFamilia][$cont2]['unidad'] != $info['Kadufr'])
								$regletaFamilia[$codFamilia][$cont2]['unidad'] .= "|".$info['Kadufr'];
						}
						else
						{
							$regletaFamilia[$codFamilia][$cont2]['unidad'] = $info['Kadufr'];
						}
						
						if(!isset($regletaFamilia[$codFamilia][$cont2]['cont']))
							$regletaFamilia[$codFamilia][$cont2]['cont'] = 1; 
						else
							$regletaFamilia[$codFamilia][$cont2]['cont']++; 
							
						if(isset($regletaFamilia[$codFamilia][$cont2]['cont']) && $regletaFamilia[$codFamilia][$cont2]['cont'] % 2 != 0)
							$bgTooltip = "#C3D9FF";
						else
							$bgTooltip = "#E8EEF7";
						
						if(!isset($regletaFamilia[$codFamilia][$cont2]['tooltip']) || $regletaFamilia[$codFamilia][$cont2]['tooltip']=="")
						{
							$regletaFamilia[$codFamilia][$cont2]['tooltip'] = '<table cellspacing=4>';
							$regletaFamilia[$codFamilia][$cont2]['tooltip'] .= '<tr style=background-color:#2A5DB0;color:#ffffff><td align=center> Código </td><td align=center> Nombre </td><td align=center> Dosis </td><td align=center> Unidad </td><td align=center> Frecuencia </td><td align=center> Vía </td><td align=center> Inicio </td><td align=center> Condición </td></tr>';
						}
						
						if(isset($regletaFamilia[$codFamilia][$cont2]['tooltip']))
						{
							$regletaFamilia[$codFamilia][$cont2]['tooltip'] .= '<tr style=background-color:'.$bgTooltip.'><td> '.$info['Kadart'].' </td><td> '.trim($info['Artgen']).' </td><td> '.$info['Kadcfr'].' '.$info['Kadufr'].' </td><td align=center> '.$info['Artuni'].' </td><td align=center> '.$info['Kadper'].' </td><td align=center> '.$info['Kadvia'].' </td><td align=center> '.$info['Kadfin'].' </td><td align=center> '.$info['Kadcnd'].' </td></tr>';
						}
					}
					
					if($cont2 == 24){
						$cont2 = 0;
					}

					$cont3++;
					$cont2++;

					if($cont2 % 2 != 0){
						$cont2++;
					}
					if($cont3 % 2 != 0){
						$cont3++;
					}

					if($cont2 == $horaArranque){
						break;
					}
				}
				
				// Indico si hay mas de un articulo en la familia
				if($auxFamilia == $codFamilia)
					$regletaFamilia[$codFamilia]['esCompuestaFamilia'] = '1';

				$auxFamilia = $codFamilia;
				
				//$regletaFamilia = $rondasFamilia;
			}	
			unset($arrAplicacion);
			//unset($rondasFamilia);
			unset($colPeriodicidades);
			
			/********************************************************************/
			
			$detalle->codigoArticulo = $info['Kadart']."-".$info['Kadori']."-".$info['Artgen'];
			$detalle->cantidadDosis = $info['Kadcfr'];
			$detalle->unidadDosis = $info['Kadufr'];
			$detalle->diasTratamiento = $info['Kaddia'];
			$detalle->estadoRegistro = $info['Kadest'];
			$detalle->estadoAdministracion = $info['Kadess'];
			$detalle->periodicidad = $info['Kadper'];
			$detalle->condicionSuministro = $info['Kadcnd'];
			$detalle->dosisMaxima = $info['Kaddma'];
			$detalle->formaFarmaceutica = $info['Kadffa'];
			$detalle->fechaInicioAdministracion = $info['Kadfin'];
			$detalle->horaInicioAdministracion = $info['Kadhin'];
			$detalle->via = $info['Kadvia'];
			$detalle->fechaKardex = $info['Kadfec'];
			$detalle->suspendido = $info['Kadsus'];
			$detalle->estaConfirmado = $info['Kadcon'];
			$detalle->origen = $info['Kadori'];
			$detalle->observaciones = $info['Kadobs'];
			$detalle->cantidadUnidadManejo = $info['Kadcma'];
			$detalle->unidadManejo = $info['Artuni'];
			$detalle->grupo = $info['Famctr'] == 'on' ? 'CTR' : $info['Artgru']; //$info['Artgru'];
			$detalle->cantidadADispensar = $info['Kadcdi'];
			$detalle->cantidadDispensada = $info['Kaddis'];
			$detalle->tipoProtocolo = $info['Kadpro'];
			$detalle->centroCostos	= $info['Kadcco'];
			$detalle->estadoArticulo =  $info['Artest'];
			$detalle->imprimirArticulo =  $info['Kadimp'];
			$detalle->altaArticulo =  $info['Kadalt'];
			$detalle->cantidadAlta = $info['Kadcal'];
			$detalle->dosisAdaptada = $info['Kaddoa'];
			$detalle->noEsteril = $info['Kadnes'];
			$detalle->pendiente_leer = $info['Kadpen'];
			
			$detalle->codigoCreador = $info['Kadusu'];
			
			$detalle->esPos = $info['Artpos'] == "N" ? false : true;
			
			$gruposAntibioticos = consultarAliasPorAplicacion( $conex, $wemp_pmla, "gruposMedicamentosAntibioticos" );
			$gruposAntibioticos = explode(",", $gruposAntibioticos );
			
			$detalle->esAntibiotico = in_array( $info['Artgru'], $gruposAntibioticos );
			
			$resFam = consultarPrincipiosActivosPorFamilia( $conex, $wbasedato, $info['Famcod'] );
			$codsFam = codigosPrincipiosActivos( $resFam );
			$detalle->codigoPrincipioActivo = $codsFam;		//Junio 16 de 2015
			
			$detalle->nombreGenerico = $nombreArticulo;		//Agosto 27 de 2012
			
			$detalle->presentacionPermiteDA = presentacionPermiteDA( $conex, $wbasedato, $detalle->unidadManejo );
			$detalle->presentacionPermiteNE = presentacionPermiteNE( $conex, $wbasedato, $detalle->unidadManejo );
			
			switch($detalle->tipoProtocolo){
				case $protocoloNormal:
					$detalle->nombreProtocolo = $nombreProtocoloNormal;
					break;
				case $protocoloNutricion:
					$detalle->nombreProtocolo = $nombreProtocoloNutricion;
					break;
				case $protocoloAnalgesia:
					$detalle->nombreProtocolo = $nombreProtocoloAnalgesia;
					break;
				case $protocoloQuimioterapia:
					$detalle->nombreProtocolo = $nombreProtocoloQuimioterapia;
					break;
				default:
					$detalle->nombreProtocolo = $nombreProtocoloNormal;
					break;
						
			}
			
			$detalle->idOriginal = $info[ 'Kadido' ];
			
			$detalle->esLev = false;
			if( $info['Kadlev'] == 'on' ){
				$detalle->tipoProtocolo = 'LQ';
				$detalle->esLev = true;
			}
			
			$detalle->esLactario = false;
			if( esArticuloLactario( $conex, $wbasedato, $info['Kadart'] ) ){
				$detalle->esLactario = true;
			}

			//Kadcma-Kadufr
			if(isset($info['Kadcma']) && !empty($info['Kadcma'])){
				$detalle->maximoUnidadManejo = $info['Kadcma'];
				$detalle->unidadMaximoManejo = $info['Kadufr'];
//				$detalle->vencimiento		 = $info['Defven'];
//				$detalle->diasVencimiento	 = $info['Defdie'];
//				$detalle->esDispensable		 = $info['Defdis'];
//				$detalle->esDuplicable		 = $info['Defdup'];

				//No modificar
				$detalle->permiteModificar	 = true;

				//Consulta de los dias de tratamiento de este articulo
				obtenerDatosAdicionalesArticulo($historia, $ingreso, $info['Kadart'], $detalle->diasTotalesTto, $detalle->dosisTotalesTto);

				//Consulta de cantidades ctc
				//****************************Consulta de las cantidades del CTC autorizado acumulado y usado
				$q2 = "SELECT Ctccau,Ctccus,Ctcuca FROM {$wbasedato}_000095 WHERE Ctchis = '".$historia."' AND Ctcing = '".$ingreso."' AND Ctcart = '".$info['Kadart']."'";
				$res2 = mysql_query($q2, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());
				while($info2 = mysql_fetch_array($res2)){
					$detalle->cantidadAutorizadaCtc 	= $info2['Ctccau'];
					$detalle->cantidadUtilizadaCtc 		= consultarCantidadAcumuladaDispensada($conex,$wbasedato,$historia,$ingreso,$info['Kadart']);
					$detalle->unidadesCantidadesCtc 	= $info2['Ctcuca'];
				}
				//***************************

				//Consulta de vias del articulo
				//****************************
				$q3 = "SELECT Defcco,Defart,Deffra,Deffru,Defest,Defven,Defdie,Defdis,Defdup,Defcon,Defnka,Defdim,Defdom,Defvia FROM {$wbasedato}_000059 WHERE Defart = '".$info['Kadart']."' AND Defest = 'on'";
				$res3 = mysql_query($q3, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q3 . " - " . mysql_error());
				if($info3 = mysql_fetch_array($res3)){
					$detalle->viasPosibles 	= $info3['Defvia'];
					
					//Consulto si es dispensable y duplicable
					$detalle->esDispensable = $info3['Defdis'];	//Marzo 3 de 2011
					$detalle->esDuplicable =  $info3['Defdup'];	//Marzo 3 de 2011
				}
				//***************************
				
				$detalle->setDatosExtension();
				
				$coleccion[] = $detalle;
			}
		}
	}
	return $coleccion;
}




/**
 * La idea de este metodo es agregar los articulos de central de mezclas en modo editable
 *
 * @param $historia
 * @param $ingreso
 * @param $fechaConsulta
 * @param $tipoProtocolo
 * @return unknown_type
 */
function consultarArticulosCMParaSF($historia,$ingreso,$fecha,$tipoProtocolo){
	global $wbasedato;
	global $conex;
	global $wemp_pmla;

	global $centroCostosServicioFarmaceutico;
	global $codigoServicioFarmaceutico;
	global $codigoCentralMezclas;
	global $centroCostosCentralMezclas;

	global $usuario;		//Información de usuario
	
	$wcenmez = consultarAliasPorAplicacion( $conex, $wemp_pmla, "cenmez" );

	$coleccion = array();

	$q = " SELECT
				Kadart,Artcom,Artgen,Artuni,'' Artgru,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kaddis,Kaduma,Kadcma,Kadpro,Kadcco,Kadare,Deffra,Deffru,Defven,Defdis,Defdup, Artest, Kadusu, Kadlev, Kadido, Artpos
			FROM 
				".$wbasedato."_000054, {$wcenmez}_000002 LEFT JOIN ( SELECT Deffra, Deffru, Defart, Defven,Defdis,Defdup  FROM {$wbasedato}_000059 WHERE Defest = 'on' AND Defcco = '$centroCostosCentralMezclas') a ON a.Defart = Artcod  
			WHERE 
				Kadhis = '$historia' 
				AND Kading = '$ingreso'				 
				AND Kadfec = '$fecha'
				AND Kadpro = '$tipoProtocolo'
				AND Kadori = '$codigoCentralMezclas'
				AND Kadcco = '$centroCostosCentralMezclas'
				AND Artcod = Kadart 
			UNION
			SELECT 
				Kadart,Artcom,Artgen,Artuni,'' Artgru,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kaddis,Kaduma,Kadcma,Kadpro,Kadcco,Kadare,Deffra,Deffru,Defven,Defdis,Defdup, Artest, Kadusu, Kadlev, Kadido, '' as Artpos
			FROM 
				".$wbasedato."_000060, {$wcenmez}_000002 LEFT JOIN ( SELECT Deffra, Deffru, Defart, Defven,Defdis,Defdup  FROM {$wbasedato}_000059 WHERE Defest = 'on' AND Defcco = '$centroCostosCentralMezclas') a ON a.Defart = Artcod  
			WHERE 
				Kadhis = '$historia' 
				AND Kading = '$ingreso'				 
				AND Kadfec = '$fecha'
				AND Kadpro = '$tipoProtocolo'
				AND Kadori = '$codigoCentralMezclas'
				AND Kadcco = '$centroCostosCentralMezclas'
				AND Artcod = Kadart 
			ORDER BY Artcom ";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if ($num > 0)
	{
		$cont1 = 0;

		while ($cont1 < $num){
			$cont1++;
				
			$detalle = new detalleKardexDTO();
				
			$info = mysql_fetch_array($res);

			$detalle->historia = $historia;
			$detalle->ingreso = $ingreso;
			$detalle->fecha = $fecha;
			$detalle->codigoArticulo = $info['Kadart']."-".$info['Kadori']."-".$info['Artcom'];
			$detalle->cantidadDosis = $info['Kadcfr'];
			$detalle->unidadDosis = $info['Kadufr'];
			$detalle->diasTratamiento = $info['Kaddia'];
			$detalle->estadoRegistro = $info['Kadest'];
			$detalle->estadoAdministracion = $info['Kadess'];
			$detalle->periodicidad = $info['Kadper'];
			$detalle->condicionSuministro = $info['Kadcnd'];
			$detalle->formaFarmaceutica = $info['Kadffa'];
			$detalle->dosisMaxima = $info['Kaddma'];
			$detalle->fechaInicioAdministracion = $info['Kadfin'];
			$detalle->horaInicioAdministracion = $info['Kadhin'];
			$detalle->via = $info['Kadvia'];
			$detalle->fechaKardex = $info['Kadfec'];
			$detalle->suspendido = $info['Kadsus'];
			$detalle->estaConfirmado = $info['Kadcon'];
			$detalle->origen = $info['Kadori'];
			$detalle->observaciones = $info['Kadobs'];
			$detalle->cantidadUnidadManejo = $info['Kadcma'];
			$detalle->unidadManejo = $info['Artuni'];
			$detalle->grupo = $info['Artgru'];
			$detalle->tipoProtocolo = $info['Kadpro'];
			$detalle->estadoArticulo = $info['Artest'];
			
			$detalle->codigoCreador = $info['Kadusu'];
			
			$detalle->esPos = $info['Artpos'] == "N" ? false: true;
			
			$resFam = consultarPrincipiosActivosPorFamilia( $conex, $wbasedato, $info['Famcod'] );
			$codsFam = codigosPrincipiosActivos( $resFam );
			$detalle->codigoPrincipioActivo = $codsFam;		//Junio 16 de 2015
			
			$detalle->nombreGenerico = $info['Artgen'];		//Agosto 27 de 2012
			
			$gruposAntibioticos = consultarAliasPorAplicacion( $conex, $wemp_pmla, "gruposMedicamentosAntibioticos" );
			$gruposAntibioticos = explode(",", $gruposAntibioticos );
			
			$detalle->esAntibiotico = in_array( $info['Artgru'], $gruposAntibioticos );
			
			$gruposAntibioticos = consultarAliasPorAplicacion( $conex, $wemp_pmla, "gruposMedicamentosAntibioticos" );
			$gruposAntibioticos = explode(",", $gruposAntibioticos );
			
			$detalle->esAntibiotico = in_array( $info['Artgru'], $gruposAntibioticos );
			
			$detalle->presentacionPermiteDA = presentacionPermiteDA( $conex, $wbasedato, $detalle->unidadManejo );	//Marzo 02 de 2015
			$detalle->presentacionPermiteNE = presentacionPermiteNE( $conex, $wbasedato, $detalle->unidadManejo );	//Marzo 02 de 2015
				
			if(isset($info['Deffra']) && !empty($info['Deffra'])){
				$detalle->maximoUnidadManejo = $info['Deffra'];
				$detalle->unidadMaximoManejo = $info['Deffru'];
				$detalle->vencimiento		 = $info['Defven'];
				$detalle->esDispensable		 = $info['Defdis'];
				$detalle->esDuplicable		 = $info['Defdup'];
				
				$detalle->permiteModificar 	 = false;
				
				//Consulta de los dias de tratamiento de este articulo
				obtenerDatosAdicionalesArticulo($historia, $ingreso, $info['Kadart'], $detalle->diasTotalesTto, $detalle->dosisTotalesTto);
					
				//Consulta de cantidades ctc
				//****************************Consulta de las cantidades del CTC autorizado acumulado y usado
				$q2 = "SELECT Ctccau,Ctccus,Ctcuca FROM {$wbasedato}_000095 WHERE Ctchis = '".$historia."' AND Ctcing = '".$ingreso."' AND Ctcart = '".$info['Kadart']."'";
				$res2 = mysql_query($q2, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());
				while($info2 = mysql_fetch_array($res2)){
					$detalle->cantidadAutorizadaCtc 	= $info2['Ctccau'];
					$detalle->cantidadUtilizadaCtc 		= consultarCantidadAcumuladaDispensada($conex,$wbasedato,$historia,$ingreso,$info['Kadart']);
					$detalle->unidadesCantidadesCtc 	= $info2['Ctcuca'];
				}
				//***************************
				$coleccion[] = $detalle;
			}
			
			$detalle->idOriginal = $info[ 'Kadido' ];
			
			$detalle->setDatosExtension();
			
			$detalle->esLev = false;
			if( $info['Kadlev'] == 'on' ){
				$detalle->tipoProtocolo = 'LQ';
				$detalle->esLev = true;
			}
			
			$detalle->esLactario = false;
			if( esArticuloLactario( $conex, $wbasedato, $info['Kadart'] ) ){
				$detalle->esLactario = true;
			}
		}
	}
	return $coleccion;
}

/**
 * Muestra a modo de consulta para enfermeria los articulos del lactario
 *
 * @param $historia
 * @param $ingreso
 * @param $fechaConsulta
 * @param $tipoProtocolo
 * @return unknown_type
 */
function consultarArticulosLactario($historia,$ingreso,$fecha,$tipoProtocolo){
	global $wbasedato;
	global $conex;
	global $wemp_pmla;

	global $centroCostosServicioFarmaceutico;
	global $codigoServicioFarmaceutico;
	global $codigoCentralMezclas;
	global $centroCostosCentralMezclas;

	//Protocolos
	global $protocoloNormal;
	global $protocoloNutricion;
	global $protocoloAnalgesia;
	global $protocoloQuimioterapia;

	global $nombreProtocoloNormal;
	global $nombreProtocoloNutricion;
	global $nombreProtocoloAnalgesia;
	global $nombreProtocoloQuimioterapia;

	global $usuario;		//Información de usuario

	$coleccion = array();

	$q = " SELECT
				Kadart,Artcom,Artgen,Artuni,'' Artgru,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kaddis,Kaduma,Kadcma,Kadpro,Kadcco,Kadare,Deffra,Deffru,Defven,Defdis,Defdup,Kadnar, Artest, Kadusu, Kadido, Artpos
			FROM
				".$wbasedato."_000054, ".$wbasedato."_000026 LEFT JOIN ( SELECT Deffra, Deffru, Defart, Defven,Defdis,Defdup  FROM {$wbasedato}_000059 WHERE Defest = 'on' AND Defcco = '$centroCostosServicioFarmaceutico') a ON a.Defart = Artcod
			WHERE
				Kadhis = '$historia'
				AND Kading = '$ingreso'
				AND Kadfec = '$fecha'
				AND Kadpro LIKE '$tipoProtocolo'
				AND Kadori = 'SF'
				AND Kadcco = '1120'
				AND Artcod = Kadart			
			ORDER BY Artcom ";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if ($num > 0)
	{
		$cont1 = 0;

		while ($cont1 < $num){
			$cont1++;

			$detalle = new detalleKardexDTO();

			$info = mysql_fetch_array($res);

			$detalle->historia = $historia;
			$detalle->ingreso = $ingreso;
			$detalle->fecha = $fecha;
			$detalle->codigoArticulo = $info['Kadart']."-".$info['Kadori']."-".$info['Artcom'];
			$detalle->cantidadDosis = $info['Kadcfr'];
			$detalle->unidadDosis = $info['Kadufr'];
			$detalle->diasTratamiento = $info['Kaddia'];
			$detalle->estadoRegistro = $info['Kadest'];
			$detalle->estadoAdministracion = $info['Kadess'];
			$detalle->periodicidad = $info['Kadper'];
			$detalle->condicionSuministro = $info['Kadcnd'];
			$detalle->formaFarmaceutica = $info['Kadffa'];
			$detalle->dosisMaxima = $info['Kaddma'];
			$detalle->fechaInicioAdministracion = $info['Kadfin'];
			$detalle->horaInicioAdministracion = $info['Kadhin'];
			$detalle->via = $info['Kadvia'];
			$detalle->fechaKardex = $info['Kadfec'];
			$detalle->suspendido = $info['Kadsus'];
			$detalle->estaConfirmado = $info['Kadcon'];
			$detalle->origen = $info['Kadori'];
			$detalle->observaciones = $info['Kadobs'];
			$detalle->cantidadUnidadManejo = $info['Kadcma'];
			$detalle->unidadManejo = $info['Artuni'];
			$detalle->grupo = $info['Artgru'];
			$detalle->tipoProtocolo = $info['Kadpro'];
			$detalle->nombreArticulo = $info['Kadnar'];
			$detalle->estadoArticulo = $info['Artest'];
			
			$detalle->codigoCreador = $info['Kadusu'];
			
			$detalle->codigoCreador = $info['Artpos'] == "N" ? false: true;
			
			$detalle->nombreGenerico = $info['Artgen'];		//Agosto 27 de 2012
			
			$gruposAntibioticos = consultarAliasPorAplicacion( $conex, $wemp_pmla, "gruposMedicamentosAntibioticos" );
			$gruposAntibioticos = explode(",", $gruposAntibioticos );
			
			$detalle->esAntibiotico = in_array( $info['Artgru'], $gruposAntibioticos );
			
			$detalle->presentacionPermiteDA = presentacionPermiteDA( $conex, $wbasedato, $detalle->unidadManejo );	//Marzo 02 de 2015
			$detalle->presentacionPermiteNE = presentacionPermiteNE( $conex, $wbasedato, $detalle->unidadManejo );	//Marzo 02 de 2015

			switch($detalle->tipoProtocolo){
				case $protocoloNormal:
					$detalle->nombreProtocolo = $nombreProtocoloNormal;
					break;
				case $protocoloNutricion:
					$detalle->nombreProtocolo = $nombreProtocoloNutricion;
					break;
				case $protocoloAnalgesia:
					$detalle->nombreProtocolo = $nombreProtocoloAnalgesia;
					break;
				case $protocoloQuimioterapia:
					$detalle->nombreProtocolo = $nombreProtocoloQuimioterapia;
					break;
				default:
					$detalle->nombreProtocolo = $nombreProtocoloNormal;
					break;
						
			}
			
			$detalle->idOriginal = $info[ 'Kadido' ];
			
			$detalle->esLev = false;
			if( $info['Kadlev'] == 'on' ){
				$detalle->tipoProtocolo = 'LQ';
				$detalle->esLev = true;
			}
			
			$detalle->esLactario = false;
			if( esArticuloLactario( $conex, $wbasedato, $info['Kadart'] ) ){
				$detalle->esLactario = true;
			}
			
			if(isset($info['Deffra']) && !empty($info['Deffra'])){
				$detalle->maximoUnidadManejo = $info['Deffra'];
				$detalle->unidadMaximoManejo = $info['Deffru'];
				$detalle->vencimiento		 = $info['Defven'];
				$detalle->esDispensable		 = $info['Defdis'];
				$detalle->esDuplicable		 = $info['Defdup'];

				$detalle->permiteModificar 	 = false;

				//Consulta de los dias de tratamiento de este articulo
				obtenerDatosAdicionalesArticulo($historia, $ingreso, $info['Kadart'], $detalle->diasTotalesTto, $detalle->dosisTotalesTto);

				//Consulta de cantidades ctc
				//****************************Consulta de las cantidades del CTC autorizado acumulado y usado
				$q2 = "SELECT Ctccau,Ctccus,Ctcuca FROM {$wbasedato}_000095 WHERE Ctchis = '".$historia."' AND Ctcing = '".$ingreso."' AND Ctcart = '".$info['Kadart']."'";
				$res2 = mysql_query($q2, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());
				while($info2 = mysql_fetch_array($res2)){
					$detalle->cantidadAutorizadaCtc 	= $info2['Ctccau'];
					$detalle->cantidadUtilizadaCtc 		= consultarCantidadAcumuladaDispensada($conex,$wbasedato,$historia,$ingreso,$info['Kadart']);
					$detalle->unidadesCantidadesCtc 	= $info2['Ctcuca'];
				}
				//***************************
				$detalle->setDatosExtension();
				
				$detalle->setDatosExtension();
				
				$coleccion[] = $detalle;
			}
		}
	}
	return $coleccion;
}
/**
 * Consulta el detalle del perfil farmacoterapeutico basado en el detalle historico del kardex por fecha y paciente
 * @param $historia
 * @param $ingreso
 * @param $fecha
 * @return unknown_type
 *
 * NOTAS:
 *
 * 20-Sep-10:  La consulta de los articulos se hará por la fracción que tenga en el registro no en la 59, el kardex tendra la responsabilidad de asignar la fracción adecuada.
 */
function consultarDetalleDefinitivoPerfil($historia,$ingreso,$fecha){
	global $wbasedato;
	global $conex;
	global $usuario;		//Información de usuario
	global $wemp_pmla;

	global $centroCostosServicioFarmaceutico;
	global $codigoServicioFarmaceutico;
	global $codigoCentralMezclas;
	global $centroCostosCentralMezclas;

	$coleccion = array();

	$q = "SELECT
			{$wbasedato}_000054.Fecha_data,{$wbasedato}_000054.Hora_data,Kadart,Artcom,Artgen,Artgru,Artpos,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kadcan,Kaddis,Kaduma,Kadcma,Kadcdi,Kadpri,Kadare,Kadsad,Kadusu, Kadlev, Kadido
		FROM
			{$wbasedato}_000054, {$wbasedato}_000026
		WHERE
			Kadhis = '$historia'
			AND Kading = '$ingreso'
			AND Kadfec = '$fecha'
			AND Kadsus = 'off'
			AND Kadori = '$codigoServicioFarmaceutico'
			AND Artcod = Kadart
			AND Kadcdi > 0 ";

	$subConsulta = " SELECT
			{$wbasedato}_000054.Fecha_data,{$wbasedato}_000054.Hora_data,Kadart,Artcom,Artgen,'' Artgru,'' Artpos,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kadcan,Kaddis,Kaduma,Kadcma,Kadcdi,Kadpri,Kadare,Kadsad,Kadusu, Kadlev, Kadido
		FROM
			cenpro_000002, {$wbasedato}_000054
		WHERE
			Kadhis = '$historia'
			AND Kading = '$ingreso'
			AND Kadfec = '$fecha'
			AND Kadsus = 'off'
			AND Kadori = '$codigoCentralMezclas'
			AND Artcod = Kadart
			AND Kadcdi > 0 ";
			
//	if($usuario->esUsuarioCM){
//		$q = $subConsulta;
//	}

//	if($usuario->esUsuarioCTC){
		$q .= " UNION ".$subConsulta;
//	}

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if ($num > 0)
	{
		$cont1 = 0;

		while ($cont1 < $num){
			$cont1++;

			$detalle = new detalleKardexDTO();
			
			$info = mysql_fetch_array($res);
			
			$detalle->historia = $historia;
			$detalle->ingreso = $ingreso;
			$detalle->fecha = $fecha;
			$detalle->codigoArticulo = $info['Kadart']."-".$info['Kadori']."-".$info['Artcom'];
			$detalle->cantidadDosis = $info['Kadcfr'];
			$detalle->unidadDosis = $info['Kadufr'];
			$detalle->diasTratamiento = $info['Kaddia'];
			$detalle->estadoRegistro = $info['Kadest'];
			$detalle->estadoAdministracion = $info['Kadess'];
			$detalle->periodicidad = $info['Kadper'];
			$detalle->condicionSuministro = $info['Kadcnd'];
			$detalle->formaFarmaceutica = $info['Kadffa'];
			$detalle->dosisMaxima = $info['Kaddma'];
			$detalle->fechaInicioAdministracion = $info['Kadfin'];
			$detalle->horaInicioAdministracion = $info['Kadhin'];
			$detalle->via = $info['Kadvia'];
			$detalle->fechaKardex = $info['Kadfec'];
			$detalle->suspendido = $info['Kadsus'];
			$detalle->estaConfirmado = $info['Kadcon'];
			$detalle->origen = $info['Kadori'];
			$detalle->observaciones = $info['Kadobs'];
			$detalle->cantidadGrabar = $info['Kadcdi'];
			$detalle->cantidadUnidadManejo = $info['Kadcma'];
			$detalle->unidadManejo = $info['Kaduma'];
			$detalle->grupo = $info['Artgru'];
			$detalle->tienePrioridad = $info['Kadpri'];
			$detalle->aprobado = $info['Kadare'];
			$detalle->fechaCreacion = $info['Fecha_data'];
			$detalle->horaCreacion = $info['Hora_data'];
			$detalle->saldoDispensacion = $info['Kadsad'];
			$detalle->esPos = $info['Artpos'] == "N" ? false: true;
			
			$detalle->codigoCreador = $info['Kadusu'];
			
			$detalle->nombreGenerico = $info['Artgen'];		//Agosto 27 de 2012
			
			
			$gruposAntibioticos = consultarAliasPorAplicacion( $conex, $wemp_pmla, "gruposMedicamentosAntibioticos" );
			$gruposAntibioticos = explode(",", $gruposAntibioticos );
			
			$detalle->esAntibiotico = in_array( $info['Artgru'], $gruposAntibioticos );
			
			
			$detalle->presentacionPermiteDA = presentacionPermiteDA( $conex, $wbasedato, $detalle->unidadManejo ); 	//Marzo 02 de 2015
			$detalle->presentacionPermiteNE = presentacionPermiteNE( $conex, $wbasedato, $detalle->unidadManejo ); 	//Marzo 02 de 2015
			
			/****************************************************************************************
			 * Junio 7 de 2012
			 ****************************************************************************************/
			if( isset($detalle->origen) && $detalle->origen == $codigoCentralMezclas ){
				if( esProductoNoPOSCM( $conex, $wbasedato, $wcenmez, $info['Kadart'] ) ){
					$detalle->esPos = false;
				}
			}
			/****************************************************************************************/

			//****************************Consulta de las cantidades del CTC autorizado acumulado y usado
			$q2 = "SELECT Ctccau,Ctccus,Ctcuca FROM {$wbasedato}_000095 WHERE Ctchis = '$historia' AND Ctcing = '$ingreso' AND Ctcart = '".$info['Kadart']."'";
			$res2 = mysql_query($q2, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());
			while($info2 = mysql_fetch_array($res2)){
				$detalle->cantidadAutorizadaCtc 	= $info2['Ctccau'];
				$detalle->cantidadUtilizadaCtc 		= consultarCantidadAcumuladaDispensada($conex,$wbasedato,$historia,$ingreso,$info['Kadart']);
				$detalle->unidadesCantidadesCtc 	= $info2['Ctcuca'];
			}
			//***************************

			//****************************Puede reemplazar
			$q3 = "SELECT Spauen, Spausa FROM {$wbasedato}_000004 WHERE Spahis = '".$historia."' AND Spaing = '".$ingreso."' AND Spaart = '".$info['Kadart']."'";
			$res3 = mysql_query($q3, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q3 . " - " . mysql_error());
			$detalle->puedeReemplazar = true;
			while($info3 = mysql_fetch_array($res3)){
				$detalle->puedeReemplazar 	= $info3['Spauen'] == $info3['Spausa'] ? true : false;
			}

			/*
			//Si ya hay una cantidad dispensada diferente de la solicitada
			if($info['Kadcdi'] == $info['Kaddis'] && $info['Kadcdi'] > 0){
				$detalle->puedeReemplazar = false;
			}
			//Si ya hay una cantidad dispensada diferente de la solicitada
			if($info['Kadcdi'] != $info['Kaddis'] && $info['Kaddis'] == 0){
				$detalle->puedeReemplazar = false;
			}
			*/
			//***************************
			
			//Si no esta confirmado el articulo siendo de central de mezclas, no se incluye
			if(isset($detalle->origen) && $detalle->origen == $codigoCentralMezclas){
				if(isset($detalle->estaConfirmado) && $detalle->estaConfirmado == "on"){
					$coleccion[] = $detalle;
				}
			} else {
				$coleccion[] = $detalle;
			}
			
			$detalle->idOriginal = $info[ 'Kadido' ];
			$detalle->setDatosExtension();
			
			$detalle->esLev = false;
			if( $info['Kadlev'] == 'on' ){
				$detalle->tipoProtocolo = 'LQ';
				$detalle->esLev = true;
			}
			
			$detalle->esLactario = false;
			if( esArticuloLactario( $conex, $wbasedato, $info['Kadart'] ) ){
				$detalle->esLactario = true;
			}
		}
	}
	return $coleccion;
}
/**
 * Consulta el detalle del perfil farmacoterapeutico basado en el detalle historico del kardex por fecha y paciente
 * @param $historia
 * @param $ingreso
 * @param $fecha
 * @return unknown_type
 * 
 * NOTAS:
 * 
 * 20-Sep-10:  La consulta de los articulos se hará por la fracción que tenga en el registro no en la 59, el kardex tendra la responsabilidad de asignar la fracción adecuada.
 */
function consultarDetallePerfilKardex($historia,$ingreso,$fecha){
	global $wbasedato;
	global $conex;
	global $usuario;		//Información de usuario
	global $wemp_pmla;

	$coleccion = array();

	global $centroCostosServicioFarmaceutico;
	global $codigoServicioFarmaceutico;
	global $codigoCentralMezclas;
	global $centroCostosCentralMezclas;
	
	$wcenmez = consultarAliasPorAplicacion( $conex, $wemp_pmla, "cenmez" );

	//*******************************Grupos que puede ver el centro de costos del usuario
	$tieneGruposIncluidos = false;
	if($usuario->gruposMedicamentos != "*" && $usuario->gruposMedicamentos != '' && $usuario->gruposMedicamentos != 'NO APLICA'){
		$tieneGruposIncluidos = true;
	}
	//********************************

	$q = "SELECT
			Kadart,Artcom,Artgen,Artgru,Artpos,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kadcan,Kaddis,Kaduma,Kadcma,Kadcdi,Kadpri,Kadare,Kadusu, Kadido, Artpos
		FROM
			".$wbasedato."_000054, ".$wbasedato."_000026
		WHERE 
			Kadhis = '$historia'
			AND Kading = '$ingreso'
			AND Kadfec < '$fecha'";
			if($tieneGruposIncluidos){
				$q .= " AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN $usuario->gruposMedicamentosQuery ";
			}
			$q .= "
			AND Kadori = '$codigoServicioFarmaceutico'
			AND Kadcco = '$usuario->centroCostosGrabacion'
			AND Artcod = Kadart ";

	$subConsulta = "SELECT
			Kadart,Artcom,Artgen,'' Artgru,'' Artpos,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kadcan,Kaddis,Kaduma,Kadcma,Kadcdi,Kadpri,Kadare,Kadusu, Kadido, '' as Artpos
		FROM
			{$wcenmez}_000002, ".$wbasedato."_000054
		WHERE
			Kadhis = '$historia'
			AND Kading = '$ingreso'
			AND Kadfec < '$fecha'
			AND Kadori = '$codigoCentralMezclas' 
			AND Kadcco = '$usuario->centroCostosGrabacion'
			AND Artcod = Kadart ";

	if($usuario->esUsuarioCM){
		$q = $q." UNION ".$subConsulta;
	} else {
		if(!$tieneGruposIncluidos){
			$q = $q." UNION ".$subConsulta;
		}
	}
	$q = $q." ORDER BY Kadfec DESC";
	
	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if ($num > 0)
	{
		$cont1 = 0;

		while ($cont1 < $num){
			$cont1++;
				
			$detalle = new detalleKardexDTO();
				
			$info = mysql_fetch_array($res);

			$detalle->historia = $historia;
			$detalle->ingreso = $ingreso;
			$detalle->fecha = $info['Kadfec'];
			$detalle->codigoArticulo = $info['Kadart']."-".$info['Kadori']."-".$info['Artcom'];
			$detalle->cantidadDosis = $info['Kadcfr'];
			$detalle->unidadDosis = $info['Kadufr'];
			$detalle->diasTratamiento = $info['Kaddia'];
			$detalle->estadoRegistro = $info['Kadest'];
			$detalle->estadoAdministracion = $info['Kadess'];
			$detalle->periodicidad = $info['Kadper'];
			$detalle->condicionSuministro = $info['Kadcnd'];
			$detalle->dosisMaxima = $info['Kaddma'];
			$detalle->formaFarmaceutica = $info['Kadffa'];
			$detalle->fechaInicioAdministracion = $info['Kadfin'];
			$detalle->horaInicioAdministracion = $info['Kadhin'];
			$detalle->via = $info['Kadvia'];
			$detalle->fechaKardex = $info['Kadfec'];
			$detalle->suspendido = $info['Kadsus'];
			$detalle->estaConfirmado = $info['Kadcon'];
			$detalle->origen = $info['Kadori'];
			$detalle->observaciones = $info['Kadobs'];
			$detalle->cantidadGrabar = $info['Kadcdi'];
			$detalle->cantidadUnidadManejo = $info['Kadcma'];
			$detalle->unidadManejo = $info['Kaduma'];
			$detalle->grupo = $info['Artgru'];
			$detalle->tienePrioridad = $info['Kadpri'];
			$detalle->aprobado = $info['Kadare'];
			$detalle->esPos = $info['Artpos'] == "N" ? false: true;
			
			$detalle->codigoCreador = $info['Kadusu'];
			
			$detalle->esPos = $info['Artpos'] == "N" ? false : true ;
			
			$detalle->nombreGenerico = $info['Artgen'];		//Agosto 27 de 2012
			
			$detalle->idOriginal = $info[ 'Kadido' ];
			
			$gruposAntibioticos = consultarAliasPorAplicacion( $conex, $wemp_pmla, "gruposMedicamentosAntibioticos" );
			$gruposAntibioticos = explode(",", $gruposAntibioticos );
			
			$detalle->esAntibiotico = in_array( $info['Artgru'], $gruposAntibioticos );
			
			$detalle->presentacionPermiteDA = presentacionPermiteDA( $conex, $wbasedato, $detalle->unidadManejo );	//Marzo 02 de 2015
			$detalle->presentacionPermiteNE = presentacionPermiteNE( $conex, $wbasedato, $detalle->unidadManejo );	//Marzo 02 de 2015
			
			/****************************************************************************************
			 * Junio 7 de 2012
			 ****************************************************************************************/
			$wcenmez = consultarAliasPorAplicacion( $conex, $wemp_pmla, "cenmez" );
			 
			if( isset($detalle->origen) && $detalle->origen == $codigoCentralMezclas ){
				if( esProductoNoPOSCM( $conex, $wbasedato, $wcenmez, $info['Kadart'] ) ){
					$detalle->esPos = false;
				}
			}
			/****************************************************************************************/

			$detalle->setDatosExtension();
			
			$coleccion[] = $detalle;
		}
	}
	return $coleccion;
}

function consultarUsuariosCtc($servicio){
	global $wbasedato;
	global $conex;

	$usuarios = "";

	$q = "SELECT
			Ccouct
		FROM 
			".$wbasedato."_000011
		WHERE
			Ccocod = '$servicio'
			AND Ccoest = 'on';";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if ($num > 0)
	{
		$info = mysql_fetch_array($res);

		$usuarios = $info['Ccouct'];
	}
	return $usuarios;
}

function esUsuarioCtc($centroCostosUsuario,$codigoUsuario){
	global $wbasedato;
	global $conex;

	$esUsuarioCtc = false;

	$q 	 = "SELECT Ccouct FROM ".$wbasedato."_000011 WHERE Ccocod = '$centroCostosUsuario' AND Ccoest = 'on';";
	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if ($num > 0)
	{
		$info = mysql_fetch_array($res);

		$usuarios = $info['Ccouct'];
	}

	//Verifico si el codigo del usuario esta matriculado en el ccouct
	$pos = strpos($usuarios, $codigoUsuario);

	if ($pos !== false) {
		$esUsuarioCtc = true;
	}

	return $esUsuarioCtc;
}

/**
 * Consulta los medicamentos anteriores a la fecha del kardex
 *
 * @param unknown_type $conexion
 * @param unknown_type $historia
 * @param unknown_type $ingreso
 * @param unknown_type $fecha
 * @return unknown
 */
function consultarDetalleMedicamentosAnterioresKardex($historia,$ingreso,$fecha,$tipoProtocolo,$mostrarDatos=false){
	global $wbasedato;
	global $conex;
	global $wemp_pmla;

	global $centroCostosServicioFarmaceutico;
	global $codigoServicioFarmaceutico;
	global $codigoCentralMezclas;
	global $centroCostosCentralMezclas;

	global $usuario;		//Información de usuario

	//Protocolos
	global $protocoloNormal;
	global $protocoloNutricion;
	global $protocoloAnalgesia;
	global $protocoloQuimioterapia;

	global $nombreProtocoloNormal;
	global $nombreProtocoloNutricion;
	global $nombreProtocoloAnalgesia;
	global $nombreProtocoloQuimioterapia;
	
	global $regletaFamiliaHist;
	global $wcenmez;
	
	//$usuario->centroCostos
	$coleccion = array();

	//*******************************Grupos que puede ver el centro de costos del usuario
	$tieneGruposIncluidos = false;
	if($usuario->gruposMedicamentos != "*" && $usuario->gruposMedicamentos != '' && $usuario->gruposMedicamentos != 'NO APLICA'){
		$tieneGruposIncluidos = true;
	}
	//********************************
	
	$filtroLEV = '';
	if( !$mostrarDatos && $tipoProtocolo == 'LQ' ){
		$filtroLEV = " AND kadlev = 'on'";
		$tipoProtocolo = '%';
	}

	//CONSULTA DE RANGO DE FECHAS ANTERIORES DE KARDEX::
	$qFechas = "SELECT
					MIN(Fecha_data) fMin,MAX(Fecha_data) fMax
				FROM
					{$wbasedato}_000053
				WHERE
					Karhis = '$historia'
					AND Karing = '$ingreso'
					AND Fecha_data < '$fecha'";

	$resFechas = mysql_query($qFechas, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qFechas . " - " . mysql_error());
	if($rsFechas = mysql_fetch_array($resFechas)){

		if(isset($rsFechas['fMin']) && !empty($rsFechas['fMin'])){
			$q = "SELECT
				Kadart,Artcom,Artgen,SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadnar,Kadpro,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kaddis,Kaduma,Kadcma,Kadusu, Famcod, Famnom, Artuni, Kadlev, Kaddoa, Kadido, Kadpen, Kadnes, Famctr
			FROM
				".$wbasedato."_000054, ".$wbasedato."_000026, ".$wbasedato."_000115, ".$wbasedato."_000114
			WHERE
				Kadhis = '$historia'
				AND Kading = '$ingreso'
				AND Kadfec BETWEEN '{$rsFechas['fMin']}' AND '{$rsFechas['fMax']}'";

			if($tieneGruposIncluidos){
				$q .=" AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN $usuario->gruposMedicamentosQuery ";
			}
			$q .=" AND Kadpro LIKE '$tipoProtocolo'
				
				AND Kadori = '$codigoServicioFarmaceutico'
				AND Kadalt != 'on'
				AND Artcod = Kadart
				AND Kadart = Relart
				AND Relfam = Famcod
				$filtroLEV				
			UNION
			SELECT
				Kadart,Artcom,Artgen,'' Artgru,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadnar,Kadpro,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kaddis,Kaduma,Kadcma,Kadusu, Famcod, Famnom, Artuni, Kadlev, Kaddoa, Kadido, Kadpen, Kadnes, Famctr
			FROM
				{$wcenmez}_000002, ".$wbasedato."_000054, ".$wbasedato."_000115, ".$wbasedato."_000114
			WHERE
				Kadhis = '$historia'
				AND Kading = '$ingreso'
				AND Kadfec BETWEEN '{$rsFechas['fMin']}' AND '{$rsFechas['fMax']}'
				AND Kadpro LIKE '$tipoProtocolo'
				
				AND Kadori = '$codigoCentralMezclas'
				AND Kadalt != 'on'
				AND Artcod = Kadart
				AND Kadart = Relart
				AND Relfam = Famcod 
				$filtroLEV
			UNION
			
			SELECT
				Kadart,Artcom,Artgen,SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadnar,Kadpro,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kaddis,Kaduma,Kadcma,Kadusu, Famcod, Famnom, Artuni, Kadlev, Kaddoa, Kadido, Kadpen, Kadnes, Famctr
			FROM
				".$wbasedato."_000054, ".$wbasedato."_000026, ".$wbasedato."_000114
			WHERE
				Kadhis = '$historia'
				AND Kading = '$ingreso'
				$condicionFecha ";
				if($tieneGruposIncluidos){
					$q .= " AND Kadori = '$codigoServicioFarmaceutico' ";
					$q .= " AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN $usuario->gruposMedicamentosQuery ";
				}
				$q .= " AND Kadpro LIKE '$tipoProtocolo'
				$valCcoquery
				AND Kadori = '$codigoServicioFarmaceutico' 
				
				AND Artcod = Kadart 
				AND Kadctr = Famcod 
				AND Kadart NOT IN( SELECT relart FROM ".$wbasedato."_000115 )
				$condicionAlta
				$condicionGroupBy 				
			UNION
			SELECT
				Kadart,Artcom,Artgen,'' Artgru,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadnar,Kadpro,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kaddis,Kaduma,Kadcma,Kadusu, Famcod, Famnom, Artuni, Kadlev, Kaddoa, Kadido, Kadpen, Kadnes, Famctr
			FROM
				".$wbasedato."_000054, ".$wcenmez."_000002, ".$wbasedato."_000114
			WHERE
				Kadhis = '$historia'
				AND Kading = '$ingreso'
				$condicionFecha 

				AND Kadpro LIKE '$tipoProtocolo'
				$valCcoquery
				AND Kadori = '$codigoCentralMezclas' 
				
				AND Artcod = Kadart 
				AND Kadctr = Famcod 
				AND Kadart NOT IN( SELECT relart FROM ".$wbasedato."_000115 )
				$condicionAlta
				$condicionGroupBy 
			ORDER BY
				Kadfec DESC, Famcod, Artcom ";

			$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
			$num = mysql_num_rows($res);

			if( !$mostrarDatos ){
				return $num;
			}
			else{
				
				if( $num > 0 )
				{
					$cont1 = 0;

					while ($cont1 < $num){
						$cont1++;

						$detalle = new detalleKardexDTO();

						$info = mysql_fetch_array($res);

						$detalle->historia = $historia;
						$detalle->ingreso = $ingreso;
						$detalle->fecha = $info['Kadfec'];

						$fecha_ciclo = str_replace("-","",$info['Kadfec']);

						$detalle->codigoFamilia = $info['Famcod'];
						$detalle->nombreFamilia = $info['Famnom'];
						$codFamilia = $info['Famcod'];

						if(@!array_key_exists($codFamilia,$regletaFamiliaHist[$fecha_ciclo]))
						{
							$regletaFamiliaHist[$fecha_ciclo][$codFamilia] = array();
						}
						/***********************************************************************/
						/******************* Calculo de regleta por familia ********************/
						/***********************************************************************/

						$colPeriodicidades = consultarPeriodicidades();
						$colPeriodicidades = array_merge( $colPeriodicidades, consultarPeriodicidades('I') );
						foreach ($colPeriodicidades as $periodicidad){
							if($periodicidad->codigo == $info['Kadper']){
								$horaPeriodicidad = intval($periodicidad->equivalencia);
								break;
							}
						}
						
						$arrAplicacion = array();
						
						
						// se debe enviar la dosis 
						$dosisArticulo = $info['Kadcfr'];
						$unidadArticulo = $info['Kadufr'];
						
						// validar si es producto de central de mezclas
						if($info['Kadori']==$codigoCentralMezclas)
						{
							// si es una DA con purga debe mostrar la dosis ordenada (sin purga)
							$articuloSinPurga = consultarDosisSinPurgaDA($conex,$wbasedato,$wcenmez,$historia,$ingreso,$info['Kadart'],$info['Kadido'],$dosisArticulo,$unidadArticulo,$formaFarmaceuticaArticulo);
							
							$dosisArticulo = $articuloSinPurga['dosis'];
							$unidadArticulo = $articuloSinPurga['unidad'];
						}
						
						$arrAplicacion = obtenerVectorAplicacionMedicamentos(date("Y-m-d"),$info['Kadfin'],$info['Kadhin'],$horaPeriodicidad,$dosisArticulo);
						
						$horaArranque = 2;

						$cont3 = 1;
						$cont2 = $horaArranque;   //Desplazamiento desde la hora inicial
						$caracterMarca = $info['Kadcfr'];

						while($cont3 <= 24){
						
							if(!isset($arrAplicacion[$cont2]) || $arrAplicacion[$cont2]=="" || $arrAplicacion[$cont2]==" " || $arrAplicacion[$cont2]=="-")
								$arrAplicacion[$cont2] = 0;
							
							if(@!array_key_exists($codFamilia,$regletaFamiliaHist[$fecha_ciclo]))
							{
								$regletaFamiliaHist[$fecha_ciclo][$codFamilia] = array();
								$regletaFamiliaHist[$fecha_ciclo][$codFamilia]['esCompuestaFamilia'] = '0';
							}
							
							//Si el articulo esta suspendido no sume la cantidad de aplicacion. Jonatan 5 Junio 2015
							if($info['Kadsus'] != 'on'){
								if(array_key_exists($cont2,$regletaFamiliaHist[$fecha_ciclo][$codFamilia]))
								{
									$regletaFamiliaHist[$fecha_ciclo][$codFamilia][$cont2]['valor'] += $arrAplicacion[$cont2]*1;
								} 
								else 
								{
									$regletaFamiliaHist[$fecha_ciclo][$codFamilia][$cont2] = array();
									$regletaFamiliaHist[$fecha_ciclo][$codFamilia][$cont2]['valor'] = $arrAplicacion[$cont2]*1;
								}
							}
							if($arrAplicacion[$cont2] > 0)
							{
								if(isset($regletaFamiliaHist[$fecha_ciclo][$codFamilia][$cont2]['condicion']) && $regletaFamiliaHist[$fecha_ciclo][$codFamilia][$cont2]['condicion']!="")
									$regletaFamiliaHist[$fecha_ciclo][$codFamilia][$cont2]['condicion'] .= "|".$info['Kadcnd'];
								else
									if($info['Kadcnd']!="")
										$regletaFamiliaHist[$fecha_ciclo][$codFamilia][$cont2]['condicion'] = "|".$info['Kadcnd'];
									else
										$regletaFamiliaHist[$fecha_ciclo][$codFamilia][$cont2]['condicion'] = "";
							
								if(isset($regletaFamiliaHist[$fecha_ciclo][$codFamilia][$cont2]['unidad']) && $regletaFamiliaHist[$fecha_ciclo][$codFamilia][$cont2]['unidad']!="")
									$regletaFamiliaHist[$fecha_ciclo][$codFamilia][$cont2]['unidad'] = $unidadArticulo;
								else
									$regletaFamiliaHist[$fecha_ciclo][$codFamilia][$cont2]['unidad'] = $unidadArticulo;
									

								if(!isset($regletaFamiliaHist[$fecha_ciclo][$codFamilia][$cont2]['cont']))
									$regletaFamiliaHist[$fecha_ciclo][$codFamilia][$cont2]['cont'] = 1; 
								else
									$regletaFamiliaHist[$fecha_ciclo][$codFamilia][$cont2]['cont']++; 
									
								if(isset($regletaFamiliaHist[$fecha_ciclo][$codFamilia][$cont2]['cont']) && $regletaFamiliaHist[$fecha_ciclo][$codFamilia][$cont2]['cont'] % 2 != 0)
									$bgTooltip = "#C3D9FF";
								else
									$bgTooltip = "#E8EEF7";
								
								if(!isset($regletaFamiliaHist[$fecha_ciclo][$codFamilia][$cont2]['tooltip']) || $regletaFamiliaHist[$fecha_ciclo][$codFamilia][$cont2]['tooltip']=="")
								{
									$regletaFamiliaHist[$fecha_ciclo][$codFamilia][$cont2]['tooltip'] = '<table cellspacing=4>';
									$regletaFamiliaHist[$fecha_ciclo][$codFamilia][$cont2]['tooltip'] .= '<tr style=background-color:#2A5DB0;color:#ffffff><td align=center> Código </td><td align=center> Nombre </td><td align=center> Dosis </td><td align=center> Unidad </td><td align=center> Frecuencia </td><td align=center> Vía </td><td align=center> Inicio </td><td align=center>Condición</td></tr>';
								}
								
								if(isset($regletaFamiliaHist[$fecha_ciclo][$codFamilia][$cont2]['tooltip']))
								{
									$regletaFamiliaHist[$fecha_ciclo][$codFamilia][$cont2]['tooltip'] .= '<tr style=background-color:'.$bgTooltip.'><td> '.$info['Kadart'].' </td><td> '.trim($info['Artgen']).' </td><td> '.$dosisArticulo.' '.$unidadArticulo.' </td><td align=center> '.$info['Artuni'].' </td><td align=center> '.$info['Kadper'].' </td><td align=center> '.$info['Kadvia'].' </td><td align=center> '.$info['Kadfin'].' </td><td align=center> '.$info['Kadcnd'].' </td></tr>';
								}

							}
							
							
							if($cont2 == 24){
								$cont2 = 0;
							}

							$cont3++;
							$cont2++;

							if($cont2 % 2 != 0){
								$cont2++;
							}
							if($cont3 % 2 != 0){
								$cont3++;
							}

							if($cont2 == $horaArranque){
								break;
							}
						}

						// Indico si hay mas de un articulo en la familia
						if($auxFamilia == $codFamilia)
							$regletaFamiliaHist[$fecha_ciclo][$codFamilia]['esCompuestaFamilia'] = '1';

						$auxFamilia = $codFamilia;
						
						$detalle->codigoArticulo = $info['Kadart']."-".$info['Kadori']."-".$info['Artcom'];
						$detalle->cantidadDosis = $info['Kadcfr'];
						$detalle->unidadDosis = $info['Kadufr'];
						$detalle->diasTratamiento = $info['Kaddia'];
						$detalle->estadoRegistro = $info['Kadest'];
						$detalle->estadoAdministracion = $info['Kadess'];
						$detalle->periodicidad = $info['Kadper'];
						$detalle->condicionSuministro = $info['Kadcnd'];
						$detalle->dosisMaxima = $info['Kaddma'];
						$detalle->formaFarmaceutica = $info['Kadffa'];
						$detalle->fechaInicioAdministracion = $info['Kadfin'];
						$detalle->horaInicioAdministracion = $info['Kadhin'];
						$detalle->via = $info['Kadvia'];
						$detalle->fechaKardex = $info['Kadfec'];
						$detalle->suspendido = $info['Kadsus'];
						$detalle->estaConfirmado = $info['Kadcon'];
						$detalle->origen = $info['Kadori'];
						$detalle->observaciones = $info['Kadobs'];
						$detalle->cantidadUnidadManejo = $info['Kadcma'];
						$detalle->unidadManejo = $info['Kaduma'];
						$detalle->grupo = $info['Famctr'] == 'on' ? 'CTR' : $info['Artgru']; //$info['Artgru'];
						$detalle->nombreArticulo	= $info['Kadnar'];
						$detalle->tipoProtocolo = $info['Kadpro'];
						$detalle->dosisAdaptada = $info['Kaddoa'];
						$detalle->noEsteril = $info['Kadnes'];
						$detalle->pendiente_leer = $info['Kadpen'];
						
						$gruposAntibioticos = consultarAliasPorAplicacion( $conex, $wemp_pmla, "gruposMedicamentosAntibioticos" );
						$gruposAntibioticos = explode(",", $gruposAntibioticos );
						
						$detalle->esAntibiotico = in_array( $info['Artgru'], $gruposAntibioticos );
						
						$detalle->codigoCreador = $info['Kadusu'];
						
						$resFam = consultarPrincipiosActivosPorFamilia( $conex, $wbasedato, $info['Famcod'] );
						$codsFam = codigosPrincipiosActivos( $resFam );
						$detalle->codigoPrincipioActivo = $codsFam;		//Junio 16 de 2015
						
						$detalle->nombreGenerico = $info['Artgen'];		//Agosto 27 de 2012
						
						$detalle->presentacionPermiteDA = presentacionPermiteDA( $conex, $wbasedato, $detalle->unidadManejo );	//Marzo 02 de 2015
						$detalle->presentacionPermiteNE = presentacionPermiteNE( $conex, $wbasedato, $detalle->unidadManejo );	//Marzo 02 de 2015

						switch($detalle->tipoProtocolo){
							case $protocoloNormal:
								$detalle->nombreProtocolo = $nombreProtocoloNormal;
								break;
							case $protocoloNutricion:
								$detalle->nombreProtocolo = $nombreProtocoloNutricion;
								break;
							case $protocoloAnalgesia:
								$detalle->nombreProtocolo = $nombreProtocoloAnalgesia;
								break;
							case $protocoloQuimioterapia:
								$detalle->nombreProtocolo = $nombreProtocoloQuimioterapia;
								break;
							default:
								$detalle->nombreProtocolo = $nombreProtocoloNormal;
								break;
									
						}
						
						$detalle->idOriginal = $info[ 'Kadido' ];
						
						$detalle->esLev = false;
						if( $info['Kadlev'] == 'on' ){
							$detalle->tipoProtocolo = 'LQ';
							$detalle->esLev = true;
						}
						
						$detalle->esLactario = false;
						if( esArticuloLactario( $conex, $wbasedato, $info['Kadart'] ) ){
							$detalle->esLactario = true;
						}
						
						$detalle->setDatosExtension();
							
						$coleccion[] = $detalle;
					}
				}
			}
		}
		else{
			if( !$mostrarDatos ){
				return 0;
			}
		}
	}
	else{
		if( !$mostrarDatos ){
			return 0;
		}
	}
	
	return $coleccion;
}

function consultarCambiosKardexPorTiempo($servicio, $minutos){
	global $wbasedato;
	global $conex;

	$coleccion = array();

	$q = "SELECT
			Kauhis,Kauing,Kaufec,Kaumen,Kaudes, (SELECT CONCAT(Usuario,' - ',Descripcion) FROM usuarios WHERE Codigo = Usuario) Usuario, Fecha_registro, Hora_registro, Ubisac servicio,
			(SELECT Cconom FROM ".$wbasedato."_000011 WHERE	Ccocod = Ubisac) nomServicio, Karcon
		FROM 
			".$wbasedato."_000018,
			(
				SELECT
					Kauhis, Kauing, Kaufec, Kaumen, Kaudes, SUBSTRING(".$wbasedato."_000055.Seguridad FROM INSTR(".$wbasedato."_000055.Seguridad,'-')+1) Usuario, ".$wbasedato."_000055.Fecha_data Fecha_registro, ".$wbasedato."_000055.Hora_data Hora_registro, Karcon
				FROM 
					".$wbasedato."_000055,".$wbasedato."_000053
				WHERE 
					CONCAT(".$wbasedato."_000055.Fecha_data,' ',".$wbasedato."_000055.Hora_data) >= now() - INTERVAL $minutos MINUTE
					AND Kaumen LIKE 'ARTICULO%'
					AND ".$wbasedato."_000053.Fecha_data = Kaufec
					AND Karhis = Kauhis
					AND Karing = Kauing
			) auditoria			
		WHERE 
			auditoria.Kauhis = Ubihis
			AND auditoria.Kauing = Ubiing
			AND Ubisac LIKE '$servicio'";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if ($num > 0)
	{
		$cont1 = 0;

		while ($cont1 < $num){
			$cont1++;
				
			$detalle = new AuditoriaDTO();
				
			$info = mysql_fetch_array($res);

			$detalle->historia 			= 		$info['Kauhis'];
			$detalle->ingreso 			= 		$info['Kauing'];
			$detalle->fechaKardex 		= 		$info['Kaufec'];
			$detalle->fechaRegistro		= 		$info['Fecha_registro'];
			$detalle->horaRegistro		= 		$info['Hora_registro'];
			$detalle->mensaje			= 		$info['Kaumen'];
			$detalle->descripcion		= 		$info['Kaudes'];
			$detalle->seguridad			= 		$info['Usuario'];
			$detalle->servicio			= 		$info['nomServicio'];
			$detalle->confirmadoKardex  = 		$info['Karcon'];
				
			$coleccion[] = $detalle;
		}
	}
	return $coleccion;
}

function consultarMedicamentosPendientesHorario($wservicio, $fecha, $whabitacion){
	global $wbasedato;
	global $conex;
	global $codigoServicioFarmaceutico;
	global $wemp_pmla;

	global $usuario;
	
	$tablaHabitaciones = consultarTablaHabitaciones( $conex, $wbasedato, $wservicio );

	$coleccion = array();

	$q = "SELECT
			Karhis, Karing, Kadfec, Kadart, Kadfin, Kadhin, Kadper, Kadcnd, Perequ, Habcod, Kadcfr, Kadufr, Kadvia,
			(
				CASE WHEN Kadori = '$codigoServicioFarmaceutico' THEN (
												SELECT Artcom
												
												FROM {$wbasedato}_000026
												WHERE artcod = kadart
										) ELSE (
												SELECT Artcom
												FROM cenpro_000002
												WHERE artcod = kadart
										)
				END) Nombre
		FROM
		{$tablaHabitaciones}, {$wbasedato}_000053, {$wbasedato}_000054, {$wbasedato}_000043
		WHERE
			Habest='on'
			AND Habdis = 'off'
			AND Karhis = Habhis
			AND Karing = Habing	
			AND Karcon = 'on'
			AND Karest = 'on'
			AND Kadsus = 'off'
			AND Kadper = Percod
			AND Kadhis = Karhis
			AND Karcco = Kadcco			
			AND Kading = Kading
			AND Kadfec = {$wbasedato}_000053.Fecha_data
			AND {$wbasedato}_000053.Fecha_data = '$fecha' 
			AND Habcco LIKE '$wservicio' 
			AND Habcod LIKE '$whabitacion'
		ORDER BY
			Kadfec,Habcod,Karhis ASC";

		$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
		$num = mysql_num_rows($res);

		//Historia e ingreso para traer los nombres del paciente
		$historia = "";
		$ingreso = "";
		$paciente = "";

		if ($num > 0)
		{
			$cont1 = 0;

			while ($cont1 < $num){
					
				$detalle = new MedicamentoHorarioDTO();
					
				$info = mysql_fetch_array($res);

				$detalle->historia 						= 		$info['Karhis'];
				$detalle->ingreso 						= 		$info['Karing'];
					
				if($historia != $detalle->historia){
					$q1 = "SELECT
						CONCAT(pacno1,' ', pacno2,' ', pacap1,' ', pacap2) nombre	
					FROM 
						root_000036, root_000037
					WHERE 
						oriced = pacced 
						AND orihis = '$detalle->historia'
						AND oriing = '$detalle->ingreso'
						AND oriori = '$wemp_pmla'
					";

					$res1 = mysql_query($q1, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q1 . " - " . mysql_error());
					$num1 = mysql_num_rows($res1);

					if($num1 > 0){
						$info1 = mysql_fetch_array($res1);
					}
					$paciente = $info1['nombre'];

					//				echo "$cont1 $paciente";
				}
					
				$detalle->fechaKardex 					= 		$info['Kadfec'];
				$detalle->codigoArticulo				= 		$info['Kadart']." - ".$info['Nombre'];
				$detalle->fechaInicioAdministracion		= 		$info['Kadfin'];
				$detalle->horaInicioAdministracion		= 		$info['Kadhin'];
				$detalle->horasFrecuencia				= 		$info['Perequ'];
				$detalle->servicio						= 		$wservicio;
					
				$q2 = "SELECT
							Unides unidadDosis
						FROM 
							{$wbasedato}_000027
						WHERE 
							Unicod = '{$info['Kadufr']}';";

					$res2 = mysql_query($q2, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());
					$num2 = mysql_num_rows($res2);

					if($num2 > 0){
						$info2 = mysql_fetch_array($res2);
					}
						
					$detalle->dosis							= 		$info['Kadcfr']." ".$info2['unidadDosis'];
					$detalle->habitacion					= 		$info['Habcod'];
					$detalle->paciente						= 		$paciente;

					$condicion = "&nbsp;";
						
					if(!empty($info['Kadcnd'])){

						$q3 = "SELECT
						Condes
					FROM 
					{$wbasedato}_000042
					WHERE 
						Concod = '{$info['Kadcnd']}';";

					$res3 = mysql_query($q3, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q3 . " - " . mysql_error());
					$num3 = mysql_num_rows($res3);

					if($num3 > 0){
						$info3 = mysql_fetch_array($res3);
					}
					$condicion = $info3['Condes'];
					}
					$detalle->condicion						= 		$condicion;
						
					//Frecuencia
					$frecuencia = "&nbsp;";
						
					if(!empty($info['Kadper'])){

						$q4 = "SELECT
						Percan, Peruni  
					FROM 
					{$wbasedato}_000043
					WHERE 
						Percod = '{$info['Kadper']}';";

					$res4 = mysql_query($q4, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q4 . " - " . mysql_error());
					$num4 = mysql_num_rows($res4);

					if($num4 > 0){
						$info4 = mysql_fetch_array($res4);
					}
					$frecuencia = $info4['Percan']." ".strtoupper($info4['Peruni'])."S";
					}
					$detalle->frecuencia					= 		$frecuencia;
					//Fin frecuencia
						
					//Via
					$via = "&nbsp;";
						
					if(!empty($info['Kadvia'])){
						$q5 = "SELECT
							Viacod,Viades
						FROM 
						{$wbasedato}_000040
						WHERE 
							Viacod = '{$info['Kadvia']}';";

						$res5 = mysql_query($q5, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q5 . " - " . mysql_error());
						$num5 = mysql_num_rows($res5);

						if($num5 > 0){
							$info5 = mysql_fetch_array($res5);
						}
						$via = strtoupper($info5['Viades']);
					}
					$detalle->via					= 		$via;
					//Fin frecuencia
						
					$historia = $detalle->historia;
					$ingreso = $detalle->ingreso;

					$coleccion[] = $detalle;
						
					$cont1++;
			}

		}
		return $coleccion;
}

/*Listado de articulos por kardex
 *
 * 2010-04-30: (Msanchez) - Consulta de todos los pacientes que se encuentren en el servicio, si tienen kardex del dia actual se muestra en pantalla (actualizado)
 * 							si se encuentran en el servicio pero tienen el kardex actualizado del dia anterior (no generado hoy) se muestran,
 */
function consultarListadoArticulosPacientes($wservicio, $fecha){
	global $conex;
	global $wbasedato;

	$coleccion = array();
	global $codigoServicioFarmaceutico;

	$caso = "";
	
	$tablaHabitaciones = consultarTablaHabitaciones( $conex, $wbasedato, $wservicio );

	//Consulta pacientes en las habitaciones
	$q3 = "SELECT
				Habhis, Habing, Habcod, Habcco
			FROM 
			{$tablaHabitaciones}
			WHERE 
				Habcco LIKE '$wservicio' 
				AND Habest = 'on' 
				AND Habdis = 'off' 
				AND Habhis != '' 
				AND Habing != ''
			ORDER BY
				Habcod";

			$res3 = mysql_query($q3, $conex) or die ("Error: ".mysql_errno()." - en el query: $q3 - " . mysql_error());
			$num3 = mysql_num_rows($res3);

			if ($num3 > 0){
				$cont1 = 0;

				while ($cont1 < $num3){
					$cont1++;

					$info = mysql_fetch_array($res3);

					/* Busqueda del encabezado del dia actual, si no se encuentra kardex generado se consulta el dia anterior por kardex, si no se
					 * encuentra
					 */
					$fechaActual		= $fecha;
					$fechaActualMilis 	= time();
					$ayerMilis			= time() - (24 * 60 * 60);
					$fechaAyer			= date("Y-m-d", $ayerMilis);

						
					//Consulto encabezado de kardex del dia
					$q4 = "SELECT
						Fecha_data,Hora_data,Karhis,Karing,Karobs,Karest,Kardia,Karrut,Kartal,Karpes,Karale,Karcui,Karter,Karcon,Karson,Karcur,Karint,Kardec,Karmeg,Kardie,Karprc,Kardem,Karcip,Kartef,Karrec,Kargra,Karanp,Karais,Karare
					FROM 
						".$wbasedato."_000053
					WHERE
						Karest = 'on'
						AND Karcon = 'on'
						AND Fecha_data = '".$fecha."' 
						AND Karhis = '".$info['Habhis']."'
						AND Karing = '".$info['Habing']."';";

					$res4 = mysql_query($q4, $conex) or die ("Error: ".mysql_errno()." - en el query: $q4 - " . mysql_error());
					$num4 = mysql_num_rows($res4);

					//Se verifica tambien el detalle
					$q6 = "SELECT Kadhis, Kading FROM ".$wbasedato."_000054 WHERE Kadhis = '".$info['Habhis']."' AND Kading = '".$info['Habing']."' AND Kadfec = '$fecha';";
					$res6 = mysql_query($q6, $conex) or die ("Error: ".mysql_errno()." - en el query: $q6 - " . mysql_error());
					$num6 = mysql_num_rows($res6);
						
					//			echo "<br><br>4".$q4." 6 $q6 Num4: $num4 Num6: $num6<br><br>";
						
					if($num4 > 0 && $num6 > 0){		//Encontro encabezado
						$caso = "1";
					} else {			//No encontro encabezado en el dia actual
						$q5 = "SELECT
						Fecha_data,Hora_data,Karhis,Karing,Karobs,Karest,Kardia,Karrut,Kartal,Karpes,Karale,Karcui,Karter,Karcon,Karson,Karcur,Karint,Kardec,Karmeg,Kardie,Karprc,Kardem,Karcip,Kartef,Karrec,Kargra,Karanp,Karais,Karare
					FROM 
						".$wbasedato."_000053
					WHERE
						Karest = 'on'
						AND Karcon = 'on'
						AND Fecha_data = '".$fechaAyer."' 
						AND Karhis = '".$info['Habhis']."'
						AND Karing = '".$info['Habing']."';";
							
						//				echo "<br><br>5".$q5."<br><br>";
							
						$res5 = mysql_query($q5, $conex) or die ("Error: ".mysql_errno()." - en el query: $q5 - " . mysql_error());
						$num5 = mysql_num_rows($res5);
							
						if($num5 > 0){
							$caso = "2";
						} else {
							$caso = "3";
						}
					}

					//Se consultan los kardex por fecha los resultados
					//						echo "<br><br>El caso es: '$caso' <br><br>";
					$estadoKardex = "";

					switch ($caso){
						case '1':		//Kardex actualizado
							$estadoKardex = "Actualizado";
							$fechaConsulta = $fecha;
							break;
						case '2':		//Kardex no actualizado
							$estadoKardex = "No actualizado";
							$fechaConsulta = $fechaAyer;
							break;
						default:
							$estadoKardex = "Sin generar";
							$fechaConsulta = "";
							break;
					}

					//			echo "<br><br>el caso es '$caso' y el estado kardex es '$estadoKardex'";
					if(!empty($fechaConsulta)){
						$q = "SELECT
								Karhis, Karing, Kadfec, Kadart, Kadfin, Kadhin, Kadper, Perequ, Kadcfr, Kadufr, Kaddma, Kaddia, Kadobs, Kadcdi, Kaddis,
							(
							CASE WHEN Kadori = '$codigoServicioFarmaceutico' THEN (
												SELECT Artcom
												FROM {$wbasedato}_000026
												WHERE artcod = kadart
										) ELSE (
												SELECT Artcom
												FROM cenpro_000002
												WHERE artcod = kadart
										)
							END) Nombre
						FROM
						{$wbasedato}_000053, {$wbasedato}_000054, {$wbasedato}_000043
						WHERE
							Karhis = '{$info['Habhis']}'
							AND Karing = '{$info['Habing']}'
							AND Karcon = 'on'
							AND Karest = 'on' 
							AND Kadsus = 'off'
							AND Kadper = Percod
							AND Kadhis = Karhis
							AND Kading = Kading
							AND Kadfec = {$wbasedato}_000053.Fecha_data
							AND {$wbasedato}_000053.Fecha_data = '$fechaConsulta'
						ORDER BY
							Karhis ASC";
							
						$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
						$num = mysql_num_rows($res);

						//Historia e ingreso para traer los nombres del paciente
						$historia = "";
						$ingreso = "";
						$paciente = "";

						if ($num > 0)
						{
							$cont7 = 0;

							while ($cont7 < $num){
								$cont7++;

								$detalle = new MedicamentoHorarioDTO();

								$info9 = mysql_fetch_array($res);

								$detalle->historia 						= 		$info9['Karhis'];
								$detalle->ingreso 						= 		$info9['Karing'];
								$detalle->fechaKardex					= 		$info9['Kadfec'];
								$detalle->fechaInicioAdministracion 	= 		$info9['Kadfin'];
								$detalle->horaInicioAdministracion 		= 		$info9['Kadhin'];
								$detalle->diasTratamiento 				= 		$info9['Kaddma'];
								$detalle->dosisMaximas 					= 		$info9['Kaddia'];
								$detalle->observaciones 				= 		$info9['Kadobs'];
								$detalle->cantidadADispensar 			= 		$info9['Kadcdi'];
								$detalle->cantidadDispensada 			= 		$info9['Kaddis'];
								$detalle->estadoKardex 					= 		$estadoKardex;

								if($historia != $detalle->historia){
									$q1 = "SELECT CONCAT(pacno1,' ', pacno2,' ', pacap1,' ', pacap2) nombre FROM root_000036, root_000037 WHERE oriced = pacced AND orihis = '$detalle->historia' AND oriing = '$detalle->ingreso' AND oriori = '01'";

									$res1 = mysql_query($q1, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q1 . " - " . mysql_error());
									$num1 = mysql_num_rows($res1);

									if($num1 > 0){
										$info1 = mysql_fetch_array($res1);
									}
									$paciente = $info1['nombre'];

									//				echo "$cont1 $paciente";
								}

								$detalle->fechaKardex 					= 		$info9['Kadfec'];
								$detalle->codigoArticulo				= 		$info9['Kadart']." - ".$info9['Nombre'];
								$detalle->fechaInicioAdministracion		= 		$info9['Kadfin'];
								$detalle->horaInicioAdministracion		= 		$info9['Kadhin'];
								$detalle->horasFrecuencia				= 		$info9['Perequ'];
								$detalle->servicio						= 		$wservicio;

								$q2 = "SELECT Unides unidadDosis FROM {$wbasedato}_000027 WHERE Unicod = '{$info9['Kadufr']}';";

								$res2 = mysql_query($q2, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());
								$num2 = mysql_num_rows($res2);

								if($num2 > 0){
									$info2 = mysql_fetch_array($res2);

									$detalle->dosis							= 		$info9['Kadcfr']." ".$info2['unidadDosis'];
									$detalle->habitacion					= 		$info['Habcod'];
									$detalle->paciente						= 		$paciente;

									$historia = $detalle->historia;
									$ingreso = $detalle->ingreso;

									$coleccion[] = $detalle;
								}
							}
						}
					}
				}
			} else {
				//No hay habitaciones con pacientes
			}
			return $coleccion;
}

//Listado de articulos por kardex
function consultarListadoArticulosPacientesCentral($wservicio, $fecha){
	global $conex;
	global $wbasedato;
	global $wemp_pmla;

	$coleccion = array();
	global $codigoCentralMezclas;

	$tablaHabitaciones = consultarTablaHabitaciones( $conex, $wbasedato, $wservicio );

	$q = "SELECT
			Karhis, Karing, Kadfec, Kadart, Kadfin, Kadhin, Kadper, Perequ, Habcod, Kadcfr, Kadufr, Kaddma, Kaddia, Kadobs, Kadcdi, Kaddis
		FROM
		{$tablaHabitaciones}, {$wbasedato}_000053, {$wbasedato}_000054, {$wbasedato}_000043
		WHERE
			Habest='on'
			AND Habdis = 'off'
			AND Karhis = Habhis
			AND Karing = Habing	
			AND Karcon = 'on'
			AND Karest = 'on'
			AND Kadsus = 'off'
			AND Kadori = '$codigoCentralMezclas'
			AND Kadper = Percod
			AND Kadhis = Karhis
			AND Kading = Kading
			AND Kadfec = {$wbasedato}_000053.Fecha_data
			AND {$wbasedato}_000053.Fecha_data = '$fecha'
			AND Habcco LIKE '$wservicio' 
		ORDER BY
			Habcod,Karhis ASC";

		$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
		$num = mysql_num_rows($res);

		//Historia e ingreso para traer los nombres del paciente
		$historia = "";
		$ingreso = "";
		$paciente = "";

		if ($num > 0)
		{
			$cont1 = 0;

			while ($cont1 < $num){
				$cont1++;
					
				$detalle = new MedicamentoHorarioDTO();
					
				$info = mysql_fetch_array($res);

				$detalle->historia 						= 		$info['Karhis'];
				$detalle->ingreso 						= 		$info['Karing'];
				$detalle->fechaKardex					= 		$info['Kadfec'];
				$detalle->fechaInicioAdministracion 	= 		$info['Kadfin'];
				$detalle->horaInicioAdministracion 		= 		$info['Kadhin'];
				$detalle->diasTratamiento 				= 		$info['Kaddma'];
				$detalle->dosisMaximas 					= 		$info['Kaddia'];
				$detalle->observaciones 				= 		$info['Kadobs'];
				$detalle->cantidadADispensar 			= 		$info['Kadcdi'];
				$detalle->cantidadDispensada 			= 		$info['Kaddis'];
					
				if($historia != $detalle->historia){
					$q1 = "SELECT
						CONCAT(pacno1,' ', pacno2,' ', pacap1,' ', pacap2) nombre	
					FROM 
						root_000036, root_000037
					WHERE 
						oriced = pacced 
						AND orihis = '$detalle->historia'
						AND oriing = '$detalle->ingreso'
						AND oriori = '$wemp_pmla'
					";

					$res1 = mysql_query($q1, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q1 . " - " . mysql_error());
					$num1 = mysql_num_rows($res1);

					if($num1 > 0){
						$info1 = mysql_fetch_array($res1);
					}
					$paciente = $info1['nombre'];

					//				echo "$cont1 $paciente";
				}
					
					
				$detalle->fechaKardex 					= 		$info['Kadfec'];
				$nombreArticulo = "";

				if(isset($info['Kadart']) && $info['Kadart'] != ''){
					$q2 = "SELECT
						Artcom
					FROM 
						cenpro_000002
					WHERE 
						artcod = '{$info['Kadart']}'";

					$res2 = mysql_query($q2, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());
					$num2 = mysql_num_rows($res2);

					if($num2 > 0){
						$info2 = mysql_fetch_array($res2);
					}
					$nombreArticulo = $info2['Artcom'];
				}
					
				$detalle->codigoArticulo				= 		$info['Kadart']." - ".$nombreArticulo;
				$detalle->fechaInicioAdministracion		= 		$info['Kadfin'];
				$detalle->horaInicioAdministracion		= 		$info['Kadhin'];
				$detalle->horasFrecuencia				= 		$info['Perequ'];
				$detalle->servicio						= 		$wservicio;
					
				$q2 = "SELECT
						Unides unidadDosis
					FROM 
					{$wbasedato}_000027
					WHERE 
						Unicod = '{$info['Kadufr']}';";

					$res2 = mysql_query($q2, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());
					$num2 = mysql_num_rows($res2);

					if($num2 > 0){
						$info2 = mysql_fetch_array($res2);
					}
						
					$detalle->dosis							= 		$info['Kadcfr']." ".$info2['unidadDosis'];
					$detalle->habitacion					= 		$info['Habcod'];
					$detalle->paciente						= 		$paciente;
						
					$historia = $detalle->historia;
					$ingreso = $detalle->ingreso;

					$coleccion[] = $detalle;
			}
		}
		return $coleccion;
}

function consultarKardexModificadosFecha($wservicio, $fecha){
	global $wbasedato;
	global $conex;
	
	$tablaHabitaciones = consultarTablaHabitaciones( $conex, $wbasedato, $wservicio );

	$coleccion = array();

	$q = "SELECT
				Habhis, Habing, Habcod,( 
								IFNULL((SELECT DISTINCT
											CONCAT(Codigo, ' - ', Descripcion, ' Modifico el ', {$wbasedato}_000055.Fecha_data, ' a las ', {$wbasedato}_000055.Hora_data)
										FROM 
											{$wbasedato}_000053, {$wbasedato}_000055, Usuarios
										WHERE 
											Karhis = Habhis 
											AND Karing = Habing 
											AND Karcon = 'on'
											AND Karest = 'on' 
											AND Kauhis = Habhis
											AND Kauing = Habing			
											AND Kaufec = {$wbasedato}_000053.Fecha_data
											AND Codigo = SUBSTRING({$wbasedato}_000055.Seguridad FROM INSTR({$wbasedato}_000055.Seguridad,'-')+1)
											AND {$wbasedato}_000053.Fecha_data = '$fecha' 
											AND Habcco = '$wservicio' 
										LIMIT 1
								),'Kardex sin modificaciones, no creado o sin confirmar') ) detalle,
				(SELECT  
					CONCAT(pacno1,' ', pacno2,' ', pacap1,' ', pacap2) nombre	
				FROM 
					root_000036, root_000037
				WHERE 
					oriced = pacced
					AND oriori = 01 
					AND orihis = Habhis
					AND oriing = Habing
				) paciente
		FROM
			{$tablaHabitaciones}
		WHERE
			Habest='on'
			AND Habdis = 'off'		
			AND Habcco = '$wservicio'";
		
	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if ($num > 0)
	{
		$cont1 = 0;

		while ($cont1 < $num){
			$cont1++;
				
			$detalle = new ReportesKardexDTO();
				
			$info = mysql_fetch_array($res);

			if(isset($info['Habhis']) && $info['Habhis'] != '' && isset($info['Habing']) && $info['Habing'] != ''){

				$detalle->historia 						= 		$info['Habhis'];
				$detalle->ingreso 						= 		$info['Habing'];
				$detalle->habitacion 					= 		$info['Habcod'];
				$detalle->paciente 						= 		$info['paciente'];
				$detalle->detalle						= 		$info['detalle'];
				$detalle->fecha							= 		$fecha;
					
				$coleccion[] = $detalle;
			}
		}
	}
	return $coleccion;
}

/************************************************************************************************************************************************
 * Marca las horas de aplicacion o suministro de los medicamentos, iniciando a partir de la 1 hasta las 24 horas
 *
 * Parametros:
 *
 * 1.Hora pivote: 	Hora de consulta... Mejor dejarla fija
 * 2.Fecha inicio del suministro:  En formato AAAA-MM-DD
 * 3.Hora inicio del suministro: En formato HH:00:00  TENER EN CUENTA que son HORAS sin minutos, ni segundos
 *
 * @return unknown
 * 
 * Modificaciones:
 * Febrero 22 de 2011.	(Edwin MG)	Si un medicamento comienza al día siguiente a 00:00, 
 * 									no se muestra para el día actual en la regleta
 ************************************************************************************************************************************************/
function obtenerVectorAplicacionMedicamentos($fechaActual, $fechaInicioSuministro, $horaInicioSuministro, $horasPeriodicidad, $caracterMarca = "*"){
	$arrAplicacion = array();

	$horaPivote = 1;

	//$caracterMarca = "*";

	$vecHoraInicioSuministro   = explode(":",$horaInicioSuministro);
	$vecFechaInicioSuministro  = explode("-",$fechaInicioSuministro);

	$vecFechaActual			   = explode("-",$fechaActual);

	$fechaActualGrafica 	= mktime($horaPivote, 0, 0, date($vecFechaActual[1]), date($vecFechaActual[2]), date($vecFechaActual[0]));
	$fechaSuministroGrafica = mktime(intval($vecHoraInicioSuministro[0]), 0, 0, date($vecFechaInicioSuministro[1]), date($vecFechaInicioSuministro[2]), date($vecFechaInicioSuministro[0]));

	$horasDiferenciaHoyFechaSuministro = ROUND(($fechaActualGrafica - $fechaSuministroGrafica)/(60*60));

	if($horasDiferenciaHoyFechaSuministro <= 0 && abs($horasDiferenciaHoyFechaSuministro) >= 24){
		$caracterMarca = "";
	}
	
	/************************************************************************************************************************************************
	 * Febrero 22 de 2011
	 ************************************************************************************************************************************************/
	if( date( "Y-m-d", $fechaActualGrafica+(24*3600) ) == date( "Y-m-d", $fechaSuministroGrafica ) && $vecHoraInicioSuministro[0] == "00" ){
		$caracterMarca = "";
	}
	/************************************************************************************************************************************************/

	if($horasPeriodicidad <= 0){
		$horasPeriodicidad = 1;
	}

	$horaUltimaAplicacion = abs($horasDiferenciaHoyFechaSuministro) % $horasPeriodicidad;
	

	$cont1 = 1;   //Desplazamiento de 24 horas
	$cont2 = 0;   //Desplazamiento desde la hora inicial

	$inicio = false;	//Guia de marca de hora inicial

	if( $fechaActual == $fechaInicioSuministro){
		$cont1 = intval($vecHoraInicioSuministro[0]);
		$arrAplicacion[$cont1] = $caracterMarca;

		while($cont1 <= 24){
			$out = "-";
			if($cont2 % $horasPeriodicidad == 0){
				$out = $caracterMarca;
			}
			$cont2++;

			$arrAplicacion[$cont1] = $out;
			$cont1++;
		}
	} else {
		
		while($cont1 <= 24){
			$out = "-";
			
			//Hasta llegar a la aplicacion
			if($cont1 == abs($horaPivote+$horasPeriodicidad-$horaUltimaAplicacion) || ($cont1==1 && $horaUltimaAplicacion == 0)){
				
				$out = $caracterMarca;
				$inicio = true;
			}

			if($inicio){
				
				if($cont2 % $horasPeriodicidad == 0){
					$out = $caracterMarca;
				}
				$cont2++;
			}
			$arrAplicacion[$cont1] = $out;
			$cont1++;
		}
	}
	return $arrAplicacion;
}

/******************************************************************************************************************************************
 * Inserta los articulo de la tabla definitaiva (movhos-000054) y los inserta en la tabla temporal(movhos-000060), por ultimo borra
 * los registros de la tabla definitiva
 * 
 * @param $historia
 * @param $ingreso
 * @param $fecha
 * @param $fechaGrabacion
 * @param $tipoProtocolo
 * @return unknown_type
 ******************************************************************************************************************************************/
function cargarArticulosATemporal($historia,$ingreso,$fecha,$fechaGrabacion,$tipoProtocolo, $paciente, $esDePiso ){
	global $wbasedato;
	global $conex;
	global $usuario;		//Información de usuario

	//$centroCostosMovimiento,$gruposMedicamentosMovimiento
	global $centroCostosServicioFarmaceutico;
	global $codigoServicioFarmaceutico;
	global $codigoCentralMezclas;
	global $centroCostosCentralMezclas;

	//*******************************Grupos que puede ver el centro de costos del usuario
	$tieneGruposIncluidos = false;
	if($usuario->gruposMedicamentos != "*" && $usuario->gruposMedicamentos != '' && $usuario->gruposMedicamentos != 'NO APLICA'){
		$tieneGruposIncluidos = true;
	}
	//********************************
	
	/********************************************************************************
	 * Junio 14 de 2012
	 ********************************************************************************/
	if( $usuario->centroCostosGrabacion == "*" ){
		$validarCcoQuery = "";
	}
	else{
		$validarCcoQuery = " AND Kadcco = '$usuario->centroCostosGrabacion' ";
	}
	/********************************************************************************/
	
	/********************************************************************************
	 * Noviembre 07 de 2017
	 * Si el paciente es de ayuda dx, solo cargo los articulos de la respectiva ayuda dx
	 ********************************************************************************/
	$ccoAyudaDx = '';
	
	$validarCcoAyudaDx = " AND ( Kadhis IN( 
		SELECT Ekxhis 
		  FROM ".$wbasedato."_000208
		 WHERE Ekxhis = Kadhis
		   AND Ekxing = Kading
		   AND Ekxfec = Kadfec
		   AND Ekxart = Kadart
		   AND Ekxido = Kadido
		   AND ( Ekxayu = '".$ccoAyudaDx."'
		    OR ( Ekxayu != '' AND Kadess != 'on' ) ) ) 
			OR Kadhis NOT IN ( 
		SELECT Ekxhis 
		  FROM ".$wbasedato."_000208
		 WHERE Ekxhis = Kadhis
		   AND Ekxing = Kading
		   AND Ekxfec = Kadfec
		   AND Ekxart = Kadart
		   AND Ekxido = Kadido ) )";
		   
	if( $paciente->esDeAyudaDx && !$esDePiso ){
		$ccoAyudaDx =  $paciente->servicioActual;
		$validarCcoAyudaDx = "";
	}
		   
	// $validarCcoAyudaDx = " AND ( Kadhis IN( 
		// SELECT Ekxhis 
		  // FROM ".$wbasedato."_000208
		 // WHERE Ekxhis = Kadhis
		   // AND Ekxing = Kading
		   // AND Ekxfec = Kadfec
		   // AND Ekxart = Kadart
		   // AND Ekxido = Kadido
		   // AND ( Ekxayu = '".$ccoAyudaDx."'
		    // OR ( Ekxayu != '' AND Kadess != 'on' ) ) ) 
			// OR Kadhis NOT IN ( 
		// SELECT Ekxhis 
		  // FROM ".$wbasedato."_000208
		 // WHERE Ekxhis = Kadhis
		   // AND Ekxing = Kading
		   // AND Ekxfec = Kadfec
		   // AND Ekxart = Kadart
		   // AND Ekxido = Kadido ) )";
	/********************************************************************************/

	

	//Parte 1:  Parametros de inserción en la tabla temporal
	$q = "INSERT INTO ".$wbasedato."_000060
		   	(Medico,Fecha_data,hora_data,Kadhis,Kading,Kadart,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kadcan,Kaddis,Kaduma,Kadcma,Kadhdi,Kadsal,Kadcdi,Kadpri,Kadpro,Kadcco,Kadare,Kadsad,Kadnar,Kadreg,Kadusu,Kadfir,Kadcpx,Kadron,Kadfro,Kadaan,Kadcda,Kadcdt,Kaddan,Kadfum,Kadhum,Kadido,Kadfra,Kadfcf,Kadhcf,Kadimp,Kadalt,Kadcal,Kadusp,Kadpen,Kadule,Kadfle,Kadhle,Kadctr,Kadlev,Kaddoa,Kadlog,Kadnes,seguridad) ";

	//Parte 1:  Consulta de servicio farmaceutico y grupos de medicamentos si aplica
	$subConsulta1 =	" SELECT
			 ".$wbasedato."_000054.Medico,".$wbasedato."_000054.Fecha_data,".$wbasedato."_000054.hora_data,Kadhis,Kading,Kadart,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,'$fechaGrabacion',Kadcon,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kadcan,Kaddis,Kaduma,Kadcma,Kadhdi,Kadsal,Kadcdi,Kadpri,Kadpro,Kadcco,Kadare,Kadsad,Kadnar,Kadreg,Kadusu,Kadfir,Kadcpx,Kadron,Kadfro,Kadaan,Kadcda,Kadcdt,Kaddan,Kadfum,Kadhum,Kadido,Kadfra,Kadfcf,Kadhcf,Kadimp,Kadalt,Kadcal,Kadusp,Kadpen,Kadule,Kadfle,Kadhle,Kadctr,Kadlev,Kaddoa,Kadlog,Kadnes,".$wbasedato."_000054.Seguridad
		FROM
			".$wbasedato."_000054, ".$wbasedato."_000026
		WHERE
			Kadhis = '$historia'
			AND Kadart = Artcod
			AND Artest = 'on'
			AND Kading = '$ingreso'
			AND Kadori = '$codigoServicioFarmaceutico' ";
			if($tieneGruposIncluidos){
				$subConsulta1 .= " AND Kadart IN (SELECT Artcod FROM ".$wbasedato."_000026 WHERE SUBSTRING_INDEX( Artgru, '-', 1 ) IN $usuario->gruposMedicamentosQuery AND Artest='on') ";
			}
			$subConsulta1 .= " AND Kadpro LIKE '$tipoProtocolo'
			$validarCcoQuery
			AND Kadfec = '$fecha'
			$validarCcoAyudaDx
		GROUP BY
			".$wbasedato."_000054.Medico,".$wbasedato."_000054.Fecha_data,".$wbasedato."_000054.hora_data,Kadhis,Kading,Kadart,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kadcan,Kaddis,Kaduma,Kadcma,Kadhdi,Kadsal,Kadcdi,Kadpri,Kadpro,Kadcco,Kadare,Kadsad,Kadusp,Kadpen,Kadule,Kadfle,Kadhle,Kadctr,Kadlev,Kadido,".$wbasedato."_000054.Seguridad ";

	$subConsulta2 = " SELECT
			 Medico,Fecha_data,hora_data,Kadhis,Kading,Kadart,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,'$fechaGrabacion',Kadcon,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kadcan,Kaddis,Kaduma,Kadcma,Kadhdi,Kadsal,Kadcdi,Kadpri,Kadpro,Kadcco,Kadare,Kadsad,Kadnar,Kadreg,Kadusu,Kadfir,Kadcpx,Kadron,Kadfro,Kadaan,Kadcda,Kadcdt,Kaddan,Kadfum,Kadhum,Kadido,Kadfra,Kadfcf,Kadhcf,Kadimp,Kadalt,Kadcal,Kadusp,Kadpen,Kadule,Kadfle,Kadhle,Kadctr,Kadlev,Kaddoa,Kadlog,Kadnes,seguridad
		FROM
			".$wbasedato."_000054
		WHERE
			Kadhis = '$historia'
			AND Kadori = '$codigoCentralMezclas'
			AND Kading = '$ingreso'
			$validarCcoQuery
			AND Kadpro LIKE '$tipoProtocolo'
			AND Kadfec = '$fecha'
			$validarCcoAyudaDx
		GROUP BY
			Medico,Fecha_data,hora_data,Kadhis,Kading,Kadart,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kadcan,Kaddis,Kaduma,Kadcma,Kadhdi,Kadsal,Kadcdi,Kadpri,Kadpro,Kadcco,Kadare,Kadsad,Kadnar,Kadido,seguridad ";

	if($usuario->esUsuarioCM){
		$q .= $subConsulta2;
		$q1 = $subConsulta2;
	} else {
		if(!$tieneGruposIncluidos){
			$q .= $subConsulta1." UNION ".$subConsulta2;
			$q1 = $subConsulta1." UNION ".$subConsulta2;
		} else {
			$q .= $subConsulta1;
			$q1 = $subConsulta1;
		}
	}
	
	elementosGrabados( $conex, $articulos, $q1 );	//Mayo 20 de 2011
// echo "<pre>$q</pre>";
	$res = mysql_query($q, $conex) or die ( "Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error() );
	
	//Busco si hay un articulo a elminar por inactivación en el sistema
	articulosBorradosInactivos( $conex, $wbasedato, $historia, $ingreso, $fecha, $usuario, $tieneGruposIncluidos, $tipoProtocolo );	//Abril 5 de 2011
	
	/************************************************************************************************************************************
	 * Mayo 20 de 2011
	 * 
	 * Borro uno a uno los registros que efectivamente pasaron a la tabla temporal, por historia, ingreso, fecha del kardex, hora de inicio
	 * y fecha de inicio
	 ************************************************************************************************************************************/
	$malos = verificacionArticulosGuardados( $conex, $wbasedato, "000060", $articulos, "Cargando articulos a la temporal" );
	
	if( count( $articulos ) > 0 ){
		
		foreach( $articulos as $key => $value ){
	
			if( !isset( $malos[$key] ) ){
						
				$sql = "SELECT 
							id
						FROM
							".$wbasedato."_000054
						WHERE
							Kadhis = '$historia'
							AND Kading = '$ingreso'
							AND Kadart = '{$value['Kadart']}'
							AND Kadfec = '$fecha'
							AND Kadfin = '{$value['Kadfin']}'
							AND Kadhin = '{$value['Kadhin']}'
							AND Kadido = '{$value['Kadido']}'";
				
				$resSql = mysql_query( $sql, $conex ) or die( mysql_errno()."- Error en el query $sql - ".mysql_error() );
				$numSql = mysql_num_rows( $resSql );
				
				if( $numSql > 0 ){
				
					$rowsSql = mysql_fetch_array( $resSql );
				
					$q = "DELETE FROM
							".$wbasedato."_000054
						WHERE
							id = '".$rowsSql['id']."'";
						
					$resDel = mysql_query( $q, $conex ) or die( mysql_errno()."- Error en el query $sql - ".mysql_error() );
					
					if( mysql_affected_rows() == 0 ){
						$descripcion = "Aticulo NO eliminado en Definitiva";
						$datos = "Kadhis: ".$historia;
						$datos .= ", Kading: ".$ingreso;
						$datos .= ", Kadart: ".$value['Kadart'];
						$datos .= ", Kadfec: ".$fecha;
						$datos .= ", Kadfin: ".$value['Kadfin'];
						$datos .= ", Kadhin: ".$value['Kadhin'];
						$datos .= ", Kadido: ".$value['Kadido'];
						$datos .= ", sql: ".str_replace( "'","\\'", $q );
						registrarAuditoriaCierreKardex( $historia, $ingreso, $usuario->codigo, "*".$descripcion."*".$datos );
					}
				}
				else{
					$descripcion = "Aticulo NO encontrado para eliminar en Definitiva";
					$datos = "Kadhis: ".$historia;
					$datos .= ", Kading: ".$ingreso;
					$datos .= ", Kadart: ".$value['Kadart'];
					$datos .= ", Kadfec: ".$fecha;
					$datos .= ", Kadfin: ".$value['Kadfin'];
					$datos .= ", Kadhin: ".$value['Kadhin'];
					$datos .= ", Kadido: ".$value['Kadido'];
					$datos .= ", sql: ".str_replace( "'","\\'", $sql );
					registrarAuditoriaCierreKardex( $historia, $ingreso, $usuario->codigo, "*".$descripcion."*".$datos );
				}
			}
		}
	}
	/************************************************************************************************************************************/
	
	
	//Carga los articulos del la extensión del detalle del kardex a la temporal
	$sql = "INSERT INTO ".$wbasedato."_000209
					(Medico  , Fecha_data  , Hora_data  , Ekxhis, Ekxing, Ekxfec, Ekxart, Ekxido, Ekxest, Ekxpro, Ekxtra, Ekxped, Ekxin1, Ekxin2, Ekxayu, Ekxaut, Ekxjus, Ekxfau, Ekxhau, Ekxmau, Ekxjau, Seguridad  )
				SELECT
					 a.Medico, a.Fecha_data, a.Hora_data, Ekxhis, Ekxing, Ekxfec, Ekxart, Ekxido, Ekxest, Ekxpro, Ekxtra, Ekxped, Ekxin1, Ekxin2, Ekxayu, Ekxaut, Ekxjus, Ekxfau, Ekxhau, Ekxmau, Ekxjau, a.Seguridad
				FROM
					".$wbasedato."_000208 a, ".$wbasedato."_000060 b
				WHERE
					Ekxhis = '".$historia."'
					AND Ekxing = '".$ingreso."'
					AND Ekxfec = '".$fecha."'
					AND Kadhis = Ekxhis
					AND Kading = Ekxing
					AND Kadfec = Ekxfec
					AND Kadart = Ekxart
					AND Kadido = Ekxido
					AND kadido NOT IN(
							SELECT
								c.Ekxido
							FROM
								".$wbasedato."_000209 c
							WHERE c.Ekxhis = a.Ekxhis
						      AND c.Ekxing = a.Ekxing 
							  AND c.Ekxfec = a.Ekxfec 
							  AND c.Ekxart = a.Ekxart
							  AND c.Ekxido = a.Ekxido
					)
					";
	
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	
	// if( mysql_affected_rows() > 0 ){
		
		$sql = "DELETE ".$wbasedato."_000208 FROM
					".$wbasedato."_000208, ".$wbasedato."_000060
				WHERE
					Ekxhis = '".$historia."'
					AND Ekxing = '".$ingreso."'
					AND Ekxfec = '".$fecha."'
					AND Kadhis = Ekxhis
					AND Kading = Ekxing
					AND Kadfec = Ekxfec
					AND Kadart = Ekxart
					AND Kadido = Ekxido ";
			
		$resDelEx = mysql_query( $sql, $conex ) or die( mysql_errno()."- Error en el query $sql - ".mysql_error() );
	// }
}
 
/********************************************************************************************************************************
 * Consulta la cantidad de aplicaciones dado un artículo por paciente.  Basado unicamente en la cantidad dispensada del articulo 
 * de días anteriores
 * 
 * @param $historia
 * @param $ingreso
 * @param $codigoArticulo
 * @param $fechaInicial
 * @param $fechaFinal
 * @return unknown_type
 * 
 * Enero 05 de 2011
 ********************************************************************************************************************************/
function consultarAplicacionesArticuloPaciente( $conex, $wbasedato, $idRegistroAnterior ){

	$dosisAplicadas = 0;
	$rows = false;

	//Se suman las cantidades dispensadas de dicho articulo mientras la dosis maxima sea > 0
	do{
		//Cuenta de dosis
		$q = "SELECT
				  Kaddis, Kaddma, Kadreg, Kadcfr, Kadcma
			  FROM
				  {$wbasedato}_000054
			  WHERE
				  id = '$idRegistroAnterior'
				  AND kaddma > 0
				  AND kaddma != ''
			  ";
	
		$res = mysql_query( $q, $conex ) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
		$num = mysql_num_rows($res);
	
		if ($num > 0){
			
			$rows = mysql_fetch_array( $res );
			
			$dosisAplicadas += intval( $rows['Kaddis']/($rows['Kadcfr']/$rows['Kadcma']) );	//Abril 18 de 2011
			
			$idRegistroAnterior = $rows['Kadreg'];
		}
		else{
			$rows = false;
		}
	}
	while( $rows && ( $rows['Kaddma'] != '' || $rows['Kaddma'] > 0 ) && !empty( $idRegistroAnterior ) );
	
	return $dosisAplicadas;
}

/********************************************************************************************************************************
 * Coloca las horas faltantes a la regleta. Siempre faltan las horas antes del inicio del medicamento
 ********************************************************************************************************************************/
function arreglarVectorKardex( $array ){

	$val = "";

	if( empty($array) ){	
		return "";
	}
	
	foreach( $array as $key => $value ){
		$inicial = $key;
		break;
	}
	
	for( $i = 1; $i < $inicial; $i++ ){
	
		$array2[ $i ] = '-';
	}
	
	for( $i = $inicial; $i < count( $array )+$inicial; $i++ ){	
		$array2[ $i ] = $array[ $i ];
	}
	
	return $array2;
}



/**
 * Consulta el detalle de articulos del dia anterior a la fecha introducida que no se encuentren suspendidos
 *
 *Se seleccionan los articulos anteriores y se insertarán en la tabla temporal solo los que cumplan las siguientes condiciones:
	-Si no se encuentra suspendido (Hecho en query)
	-Si el articulo tiene dias de tratamiento pendientes, deberá compararse asi:  (Dias tratamiento - (FechaActual - FechaInicioAdministracion) (Logica php)

 * @param unknown_type $conexion
 * @param unknown_type $historia
 * @param unknown_type $ingreso
 * @param unknown_type $fecha
 * @param unknown_type $fechaGrabacion
 */
function cargarArticulosAnteriorATemporal($historia,$ingreso,$fecha,$fechaGrabacion,$tipoProtocolo,$descontarDispensaciones,$horaTrasladoDescuento){
	global $wbasedato;
	global $wcenmez;
	global $conex;
	global $usuario;		//Información de usuario

	global $centroCostosServicioFarmaceutico;
	global $codigoServicioFarmaceutico;
	global $codigoCentralMezclas;
	global $centroCostosCentralMezclas;
	global $grupoControl;
	
	global $horaCorteDispensacion;
	global $diasDispensacion;
	
	global $wemp_pmla;
	
	$diasDispensacion = consultarDiasDispensacion( $conex, $wbasedato, $historia, $ingreso );

	$tieneCpx = tieneCpxPorHistoria( $conex, $wbasedato, $historia, $ingreso );
	
	$adicionar = true;
	$noAdicionaPorDosis = false;
	$saldoDispensacion = 0;
	$cantidadADispensar = 0;
	$aprobado="'off'";
	$noEnviar="";
	$diasTratamiento = "";
	
	$horaTraslado = false;
	
	//*******************************SI ES PERSONAL DEL LACTARIO, LOS ARTICULOS SE CARGAN APROBADOS
	if($usuario->esUsuarioLactario){
		$aprobado="'on'";
	}
	//********************************
	
	/****************************************************************************************************************
	 * Septiembre 15 de 2011
	 *
	 * Si el centro de costos donde se encuentra el paciente manejan ciclos de produccion, la aprobacion del 
	 * articulo es tal como viene del día anterior
	 ****************************************************************************************************************/
	if( !$usuario->esUsuarioLactario && $tieneCpx ){
		$aprobado = '';
	}
	/****************************************************************************************************************/
	
	//*******************************Grupos que puede ver el centro de costos del usuario
	$tieneGruposIncluidos = false;
	if($usuario->gruposMedicamentos != "*" && $usuario->gruposMedicamentos != '' && $usuario->gruposMedicamentos != 'NO APLICA'){
		$tieneGruposIncluidos = true;
	}
	//********************************
	$q = "SELECT
		 	Medico,Fecha_data,hora_data,Kadhis,Kading,Kadart,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,'$fechaGrabacion',Kadfec,Kadcon,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kadcan,Kaddis,Kaduma,Kadcma,Kadhdi,Kadsal,Kadcdi,'off' Kadpri,Kadpro,Kadcco,$aprobado Kadare,Kadsad,Kadnar,Kadron,Kadimp,Kadlog,seguridad,
		 	(SELECT Perequ FROM ".$wbasedato."_000043 WHERE Percod = Kadper) periodicidad, id, Kadusu, Kadfir,Kadcpx, Kadreg, Kadfro, Kadaan, Kadcda,Kadcdt, Kadido, Kadusp, Kadpen, Kadule, Kadfle, Kadhle, Kadctr, Kadlev, Kaddoa, Kadnes
		FROM
			".$wbasedato."_000054
		WHERE
			Kadhis = '$historia'
			AND Kading = '$ingreso'
			AND Kadpro LIKE '$tipoProtocolo'			
			AND Kadsus = 'off'
			AND Kadfec = DATE_SUB('".$fecha."',INTERVAL 1 DAY)
		GROUP BY
			Medico,Fecha_data,hora_data,Kadhis,Kading,Kadart,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kadcan,Kaddis,Kaduma,Kadcma,Kadhdi,Kadsal,Kadcdi,Kadpri,Kadpro,Kadcco,Kadare,Kadsad,kadido,seguridad";

	$res1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res1);
	
	$articulos = Array();

	if ($num > 0)
	{
		$cont1 = 0;
		
		while ($cont1 < $num){
			
			$aplArticulos = 0; //Aplicaciones anteriores del articulo
			
			$adicionar = true;
			$noAdicionaPorDosis = false;
			$cont1++;
			
			$esDeControl = false;

			$info = mysql_fetch_array($res1);
			
			$auxFecha = $info['Fecha_data'];
			$auxHora = $info['hora_data'];
			
			//Quito espacios			
			$info['Kaddma'] = trim( $info['Kaddma'] );
			$info['Kaddia'] = trim( $info['Kaddia'] );

			if( $info['Fecha_data'] > $info['Kadfec'] ){
				$info['Fecha_data'] = $info['Kadfec'];
				$info['hora_data'] = "23:59:59";
			}
			
			//Busca la hora de traslado
			//Si el articulo fue creado despues de la hora de traslado, entonces, el articulo fue creado en piso
			if( $cont1 == 1 ){
				$horaTraslado = consultarHoraTrasladoUrgencias( $conex, $wbasedato, $historia, $ingreso, $info['Kadfec'] );
			}
			

			//Si se cumplieron los dias de suministro, no se incluyen en el detalle a cargar
			if( isset($info['Kaddia']) && $info['Kaddia'] != "" ){
				$vecFechaKardex = explode("-",$fecha);
				$diasFaltantes = intval($info['Kaddia']) - diasDiferenciaFechas($fecha,$info['Kadfin']);

				if($diasFaltantes <= 0){
					$adicionar = false;
				}
			}

			//Control de aplicaciones máximas
			/************************************************************************
			* Enero 05 de 2011 
			* 
			* Modificación: Enero 24 de 2011
			************************************************************************/
			if( isset($info['Kaddma']) && $info['Kaddma'] != "" ){
				//Consulta el numero de aplicaciones realizadas entre la fecha de inicio del tratamiento y la fecha del kardex
				// $aplArticulos = consultarAplicacionesArticuloPaciente( $conex, $wbasedato, $info['id'] );
				 
				// $faltantesDosisMaximas = $info['Kaddma']-$aplArticulos;	//Indica cuantas cantidades de las dosis maximas faltan por aplicar
				
				// if( $faltantesDosisMaximas <= 0 ){
					
					$finFechaDosisMaximas = explode( "-", $info['Kadfin'] );
					$finHoraDosisMaximas = explode( ":", $info['Kadhin'] );
					// $finFechaDosisMaximas = date( "Y-m-d", mktime( $finHoraDosisMaximas[0], $finHoraDosisMaximas[1], $finHoraDosisMaximas[2], $finFechaDosisMaximas[1], $finFechaDosisMaximas[2], $finFechaDosisMaximas[0] )+$info['periodicidad']*($info['Kaddma']-1)*3600 );
					
					/********************************************************************************
					 * Septiembre 20 de 2012
					 *
					 * Verifico cuando termina el medicamento por dosis máxima y que la fecha actual
					 * de generación de kardex, sea menor a la fecha de terminación del medicamento.
					 * Al medicamento se le dan 2 horas de gracia, esto para que los medicamentos
					 * que tengan aplicación a las 22 no desaparezcan para que despues de media noche
					 * puedan ser cargados.
					 *
					 * Diciembre 28 de 2015
					 * Cuento el total aplicada por medicamento que tenga dosis máxima. Si ya fueron
					 * aplicados todas las dosis el medicamento no pasa al día siguiente
					 ********************************************************************************/
					if( $info['Kadlev'] != 'on' ){
						$cantidadAplicada = '';
						// $totalAplicaciones = cantidadAplicadoPorArticulo( $conex, $wbasedato, $historia, $ingreso, $info['Kadart'], $info['Kadido'], $cantidadAplicada, $info['Kadfin'], $info['Kadhin'] );
						$totalAplicaciones = consultarTotalAplicacionesEfectivasIncOrdenesINC( $conex, $wbasedato, $historia, $ingreso, $info['Kadart'], strtotime( $info['Kadfin']." ".$info['Kadhin'] ), strtotime( "$fecha 22:00:00" )-24*3600, $info['Kadido'] );
						
						//verifico el saldo
						// $canSaldo = cantidadSaldoInc( $conex, $wbasedato, $historia, $ingreso,  $info['Kadart'] );
						
						if( $totalAplicaciones >= $info[ 'Kaddma' ] ){
							$adicionar = false;
							$noAdicionaPorDosis = false;
						}
					}
					else{
						//si es un LEV o IC
						//Busco cuales insumos se aplican
						$sql = "SELECT a.*
								  FROM ".$wbasedato."_000054 a
								 WHERE a.kadhis = '".$historia."'
								   AND a.kading = '".$ingreso."'
								   AND a.Kadfec = DATE_SUB('".$fecha."',INTERVAL 1 DAY)
								   AND a.kadido IN(
										SELECT c.levidi 
										  FROM ".$wbasedato."_000171 b, ".$wbasedato."_000171 c
										 WHERE b.levins = '".$info['Kadart']."'
										   AND b.levidi = '".$info['Kadido']."'
										   AND b.levhis = a.kadhis
										   AND b.leving = a.kading
										   AND c.levhis = b.levhis
										   AND c.leving = b.leving
										   AND c.levido = b.levido
										   AND b.levest = 'on'
										 UNION
										SELECT b.levido 
										  FROM ".$wbasedato."_000171 b
										 WHERE b.levins = '".$info['Kadart']."'
										   AND b.levidi = '".$info['Kadido']."'
										   AND b.levhis = a.kadhis
										   AND b.leving = a.kading
										   AND b.levest = 'on'
										 UNION
										SELECT b.levidi 
										  FROM ".$wbasedato."_000171 b
										 WHERE b.levido = '".$info['Kadido']."'
										   AND b.levhis = a.kadhis
										   AND b.leving = a.kading
										   AND b.levest = 'on'
										 UNION
										SELECT '".$info['Kadido']."'
									)
								";
						$resLevIC = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
						$numLevIC = mysql_num_rows($resLevIC);
						
						while( $rowsLevIC = mysql_fetch_array( $resLevIC ) ){
							if( $rowsLevIC['Kadess']!='on' && !esArticuloGenericoLevICOrdenes( $conex, $wbasedato, $rowsLevIC['Kadart'], $rowsLevIC['Kadido'], $historia, $ingreso ) ){
								$cantidadAplicada = '';
								$totalAplicaciones = cantidadAplicadoPorArticulo( $conex, $wbasedato, $historia, $ingreso, $rowsLevIC['Kadart'], $rowsLevIC['Kadido'], $cantidadAplicada, $rowsLevIC['Kadfin'], $rowsLevIC['Kadhin'] );
								
								//verifico el saldo
								// $canSaldo = cantidadSaldoInc( $conex, $wbasedato, $historia, $ingreso,  $rowsLevIC['Kadart'] );
								
								//Si la cantidad aplicada es mayor a la cantidad de dosis el medicamento no pasa
								//Esto se hace por que cuando es un LEV la cantidad de dosis es aplicada con cantidades menores hasta completar la dosis completa del medicamento
								if( $cantidadAplicada >= $rowsLevIC[ 'Kadcfr' ] ){
									$adicionar = false;
									$noAdicionaPorDosis = false;
								}
							}
						}
					}
			}
			/************************************************************************/

			//Control de dosis y dias maximos
			if(isset($info['Kaddia']) && $info['Kaddia'] != "" && isset($info['Kaddma']) && $info['Kaddma'] != "" && !$adicionar){
				$noAdicionaPorDosis = false;
			}

			//Control de la cantidad dispensada
			$cantidadDispensada = $info['Kaddis'];
			$horaDispensacion = $info['Kadhdi'];
			if(trim($info['Kadfec']) != trim($fechaGrabacion)){
				$cantidadDispensada = 0;
				$horaDispensacion = "00:00:00";
			}

			//No adiciono al temporal del dia actual en los siguientes casos:
			//El centro de costos del usuario es diferente del del articulo
//			if($info['Kadori'] == $codigoCentralMezclas && !$usuario->esUsuarioCM && !$usuario->centroCostosHospitalario){
			if($usuario->centroCostosGrabacion == "*" && $usuario->esUsuarioLactario){
				//Articulo de la central de mezclas pero usuario no de la central...
				$adicionar = false;
			} else {
				if($tieneGruposIncluidos){
					//Articulo en uno de los grupos, eso aplica unicamente para el servicio farmaceutico ya que la cm no tiene grupos
					if($info['Kadori'] == $codigoServicioFarmaceutico){
						//*************************Consulta del grupo del medicamento
						$q2 = "SELECT * FROM ".$wbasedato."_000026 WHERE Artcod = '{$info['Kadart']}' AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN $usuario->gruposMedicamentosQuery;";
						$res2 = mysql_query($q2,$conex) or die ("Error: " . mysql_errno() . " - en el querys: " . $q2 . " - " . mysql_error());
						$contArticulo = mysql_num_rows($res2);
						//*************************

						if($contArticulo == 0){
							$adicionar = false;
						}
					}
				}
			}

			//Cálculo de las cantidades SIN DISPENSAR del dia anterior.
			if(isset($info['Kadcdi']) && $info['Kadcdi'] != "" && isset($info['Kaddis']) && $info['Kaddis'] != ""){
				$saldoDispensacion = $info['Kadcdi'] - $info['Kaddis'];
			}

			/* El saldo de dispensación es cero si:
			 *
			 *	-Es medicamento de control.
			 *	-El servicio actual es urgencias.
			 *	-El paciente viene trasladado desde urgencias el dia anterior
			 */
			if(intval($saldoDispensacion) < 0){
				$saldoDispensacion = 0;
			}

			//*************************
			if( $descontarDispensaciones ){	//$descontarDispensaciones es verdadero si el día anterior estaba en un cco de urgencias o cirugia
				
				$dosisUsadasServicioAnterior = 0;

				$horaActual = date("H");

				if($horaActual == "00"){
					$horaActual = "24";
				}

				$arrAplicacion = obtenerVectorAplicacionMedicamentos(date("Y-m-d"),$info['Kadfin'],$info['Kadhin'],$info['periodicidad']);
				$cntAplicaciones = 1;
				$dosisUsadasServicioAnterior = 0;
				$horasDelDia = "24";
				$indicadorDeMarca = "*";

				/* Contabilizar las dosis totales del dia, esto se hace con la cantidad de horas del dia / frecuencia.
				 * Esto se puede hacer con base en 24 horas por lo siguiente:
				 * -La dispensación se basa en 24 horas, si el articulo esta siendo analizado aqui es por que no es primera vez (dosis: 24/frec)
				 * -Lo que se dejó de usar de esas dosis debe pasar al dia siguiente
				 * -La fecha y hora del traslado no afecta los calculos de dosis que pasan, esto debido a las dos premisas anteriores
				 */
				foreach ($arrAplicacion as $apl){
					if($apl == $indicadorDeMarca){

						if($cntAplicaciones < intval(substr($horaTrasladoDescuento,0,2))){
							$dosisUsadasServicioAnterior++;
						}
					}
					$cntAplicaciones++;

				}
				$dosisTotalesDia = $horasDelDia/$info['periodicidad'];
				$dosisACargarDiaSiguiente = $dosisTotalesDia-$dosisUsadasServicioAnterior;

				//Obtiene los dias y dosis de tratamiento acumulado
				obtenerDatosAdicionalesArticulo($info['Kadhis'],$info['Kading'],$info['Kadart'],$diasTtoAcumulados,$dosisTtoTotales);

				//La variable $dosisACargarDiaSiguiente esta expresada en cantidad de dosis pero no representa las unidades a cargar o dispensar
				//La idea entonces es limitar via dosis maximas esta cantidad para calcular CUANTAS UNIDADES FRACCIONADAS representan las dosis a sumar
				//Calculo de las cantidades por articulo
				calcularSaldoActual($conex,$wbasedato,$info['Kadhis'],$info['Kading'],$fecha,$info['Kadart'],$info['Kadfin'],$info['Kadhin'],$info['Kadcfr'],$info['periodicidad'],$dosisACargarDiaSiguiente,$info['Kadori'],$diasTtoAcumulados+1,$cantGrabar,$saldo,$cantDispensar,$cantidadManejo,0,$tipoProtocolo,$horasAplicacionDia, $info['Kaddia'], '');
				
				//Si ya hay dispensación, el sistema no deberá realizar calculos de dias anteriores
				if($info['Kaddis'] != 0 || $info['Kadcdi'] == 0){
					$cantDispensar = 0;
				}

				//$saldoDispensacion = 0; //$cantDispensar; //Abril 23 de 2012, se deja saldo de dispensacion
//				$saldoDispensacion = $cantDispensar;
			}

			$esArticuloNecesidad = false;
			if( !$tieneCpx ){
			
				//No debo contabilizar saldos de dispensacion para articulos de CONTROL
				if($info['Kadori'] == $codigoServicioFarmaceutico){
					//*************************Grupo de control no acumula saldo dispensacion
					$qGru = "SELECT SUBSTRING_INDEX( Artgru, '-', 1 ) grupo FROM ".$wbasedato."_000026 WHERE Artcod = '{$info['Kadart']}';";
					$resGru = mysql_query($qGru,$conex) or die ("Error: " . mysql_errno() . " - en el querys: " . $qGru . " - " . mysql_error());
					$contArticulo = mysql_num_rows($resGru);

					$gruposDeControl =  consultarAliasPorAplicacion( $conex, $wemp_pmla, "gruposControl" );
					
					if($infoGru = mysql_fetch_array($resGru)){
						
						$esDeControl = ( array_search( $infoGru['grupo'], explode( ",", $gruposDeControl ) ) !== false ) ? true : false ;
						
						// if(isset($infoGru['grupo']) && $infoGru['grupo'] == $grupoControl){
						if( $esDeControl ){
							// $esDeControl = true;
							$saldoDispensacion = 0;
						}
					}
					//*************************
				}
			}

			
			//*************************Si el paciente se encuentra en urgencias o cirugia no deberá acumularse saldo bajo ninguna circunstancia
			$qCco = "SELECT Ubisac,Ccourg,Ccocir,Ccoing FROM ".$wbasedato."_000018, ".$wbasedato."_000011 WHERE Ubihis = '$historia' AND Ubiing = '$ingreso' AND Ccocod = Ubisac;";
			$resCco = mysql_query($qCco,$conex) or die ("Error: " . mysql_errno() . " - en el querys: " . $qCco . " - " . mysql_error());

			if($infoCco = mysql_fetch_array($resCco)){
				if(isset($infoCco['Ccourg']) && $infoCco['Ccourg'] == "on" || isset($infoCco['Ccocir']) && $infoCco['Ccocir'] == "on"  || isset($infoCco['Ccoing']) && $infoCco['Ccoing'] == "on"){
					$saldoDispensacion = 0;
				}
			}
			//*************************
			
				
			
			//****************************************************************************************************
			//Febrero 17 de 2011
			//
			// Si el paciente se encuentra en urgencias o cirugia y esta en proceso de traslado, servicio anterior se considera como actual
			// por tanto, si el servicio anterior es de urgencia o cirugia o ingreso y esta en proceso de traslado, el saldo de dispensacion del dia anterior es 0
			//****************************************************************************************************/
			$qCco = "SELECT 
						Ubisac,Ccourg,Ccocir,Ccoing 
					 FROM 
					 	".$wbasedato."_000018, ".$wbasedato."_000011 
					 WHERE 
					 	Ubihis = '$historia' 
					 	AND Ubiing = '$ingreso' 
					 	AND Ccocod = Ubisan
					 	AND Ubiptr = 'on'
					 ";
			$resCco = mysql_query($qCco,$conex) or die ("Error: " . mysql_errno() . " - en el querys: " . $qCco . " - " . mysql_error());
		

			if( $infoCco = mysql_fetch_array($resCco) ){
				if(isset($infoCco['Ccourg']) && $infoCco['Ccourg'] == "on" || isset($infoCco['Ccocir']) && $infoCco['Ccocir'] == "on"  || isset($infoCco['Ccoing']) && $infoCco['Ccoing'] == "on"){
					$saldoDispensacion = 0;
				}
			}
			//*****************************************************************************************************************************
			
			//================================================================================================================================================
			//Diciembre 17 de 2010
			//================================================================================================================================================
			// Si el paciente es trasaldo de urgencias a cirugia en el día actual y no se ha creado kardex (No tiene encabezado)
			// el saldo del dia anterior debe ser 0
			if( !existeEncabezadoKardex( $historia, $ingreso, $fecha ) && esTrasladoDeUregnciasDiaAnterior( $conex, $wbasedato, $historia, $ingreso, date( "Y-m-d", strtotime( $fecha )+24*3600 ) ) ){
				$saldoDispensacion = 0;
			}
			//================================================================================================================================================
			
			/****************************************************************************************
			 * Marzo 1 de 2011
			 * 
			 * Si el articulo es creado en piso el dia anterior, se trae el saldo de dispensacion
			 ****************************************************************************************/
			if( $horaTraslado != false && !$esDeControl ){
				
				if( $horaTraslado < $info['hora_data'] ){
					$saldoDispensacion = $info['Kadcdi'] - $info['Kaddis'];
				}
			}
			
			if(intval($saldoDispensacion) < 0){
				$saldoDispensacion = 0;
			}
			/****************************************************************************************/
			
			/******************************************************************************************************
			 * Abril 25 de 2011
			 * 
			 * Si un articulo es a necesidad el saldo de dispensacion del dia anterior es 0
			 *
			 * Modificaciones:
			 * Septiembre 02 de 2011. Se requiere saber si un articulo es a necesidad
			 ******************************************************************************************************/
			$esArticuloNecesidad = false;
			if( $info['Kadcnd'] != '' || $saldoDispensacion > 0 ){	//Septiembre 02 de 2011
				
				$sql = "SELECT Contip "
	     			   ."   FROM ".$wbasedato."_000042 "      //Tabla condiciones de administracion
	     			   ."  WHERE concod = '".$info['Kadcnd']."'";
				
				$resAN = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
				$numrowsAN = mysql_num_rows( $resAN );
				
				if( $numrowsAN ){
					$rowsAN = mysql_fetch_array( $resAN );
					if( $rowsAN[ 'Contip' ] == 'AN' ){
						$saldoDispensacion = 0; 
						$esArticuloNecesidad = true;
					}
				}
			}
			/******************************************************************************************************/
			

			
			
			
			//Cantidad a dispensar
			//Cantidad a dispensar
			//$descontarDispensaciones solo es verdadera si tiene traslado desde uregncias el dia anterior
			//Se calcula la cantidad a dispensar como si fuera la primera vez en caso de que el paciente el dia anterior
			//venga de urgencias
//			if( false && $descontarDispensaciones ){
//				$cantidadADispensar = calcularCantidadGrabar( date( "Y-m-d" ), $info['Kadhin'], 2, true );
//			}
//			else 
			if($saldoDispensacion == 0){
				$cantidadADispensar = $info['Kadcdi'];
			} else {
				$cantidadADispensar = $info['Kadcdi'] + $saldoDispensacion;
			}
			
			$noEnviar = $info['Kadess'];
			$diasTratamiento = $info['Kaddia'];

			/* Si no adiciona del dia anterior por dosis deberá hacerse lo siguiente:
			 * -No enviar activo
			 * -Sin cantidad a dispensar
			 * -Sin dosis a aplicar
			 * -Colocar los dias maximos de tratamiento en el kardex para que el articulo SE ELIMINE AUTOMATICAMENTE
			 */
			if($noAdicionaPorDosis && isset($diasTratamiento) && $diasTratamiento == "" && $info['Kaddma'] != ""){
				$noEnviar = "on";
				$cantidadADispensar = "0";

				/*Los dias de tratamiento se asignarán asi:
				 * El calculo es el siguiente:
				 * Cantidades diarias = 24 / Frecuencia
				 * Cantidad dias que cumbre esa dosis maximas = dosis maximas articulo / cantidades diarias
				 */
				$cantidadesDiarias = "";
				$arrAplicaciones = obtenerVectorAplicacionMedicamentos($fecha,$info['Kadfin'],$info['Kadhin'],$info['periodicidad']);

				foreach($arrAplicaciones as $aplic){
					if(isset($aplic) && $aplic == "*"){
						$cantidadesDiarias++;
					}
				}

				if($cantidadesDiarias != 0){
					$diasTratamiento = intval($info['Kaddma']/$cantidadesDiarias);
					
					if($diasTratamiento <= 0){
						$noAdicionaPorDosis = false;
					}

					//Si se cumplieron los dias de suministro, no se incluyen en el detalle a cargar
					if(isset($info['Kaddia']) && $info['Kaddia'] != ""){
						$vecFechaKardex = explode("-",$fecha);
						$diasFaltantes = intval($info['Kaddia']) - $diasTratamiento;

						if($diasFaltantes <= 0){
							$adicionar = false;
							$noAdicionaPorDosis = false;
						}
					}
				}
			}
			
//			ECHO "<BR>.........sALDO A DISPENSASAR: ".$saldoDispensacion;
			if($adicionar || $noAdicionaPorDosis){
			
				/******************************************************************************************************
				 * Septiembre 02 de 2011 
				 * Si el articulo es a necesidad se busca si hay saldo de articulo, si hay saldo no se envia
				 *
				 * Septiembre 14 de 2011
				 * Por la modificacion de cargos de pda, esta parte se desactiva.  La modifiacion a cargos de pda es:
				 * Si un medicamento es a necesidad y no tiene saldo en piso se pide la cantidad necesaria para una dosis
				 ******************************************************************************************************/
				if( false && $esArticuloNecesidad ){
				
					if( $info['Kadori'] == "SF" ){
						$ccoSaldos = $centroCostosServicioFarmaceutico;
					}
					
					if( $info['Kadori'] == "CM" ){
						$ccoSaldos = $centroCostosServicioFarmaceutico;
					}
					
					$sqlSaldo = "SELECT
									*
								 FROM
									{$wbasedato}_000004 a
								 WHERE
									spahis = '{$info['Kadhis']}'
									AND spaing = '{$info['Kading']}'
									AND spaart = '{$info['Kadart']}'
									AND spacco = '$ccoSaldos'
									AND spauen > spausa
								 ";
								 
					$resSaldo = mysql_query( $sqlSaldo, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
					$numrowsSaldo = mysql_num_rows( $resSaldo );
					
					if( $numrowsSaldo > 0 ){
						$noEnviar = 'on';
					}
				}
				/******************************************************************************************************/
				
				/****************************************************************************************************************************************************************
				 * Julio 14 de 2011
				 * 
				 * Busco el sobrante de la cantidad cargada del diá anterior para sumarla a la actual
				 * 
				 ****************************************************************************************************************************************************************/
				$info['Kadron'] = '';
				$info['Kadfro'] = '0000-00-00';
				$auxiliarHoraTraslado = $horaTraslado;
				
				//Busco si hubo traslado el dia actual
				$horaTrasladoHoyAux = consultarHoraTrasladoUrgencias( $conex, $wbasedato, $historia, $ingreso, $fechaGrabacion );
				
				$auxTieneCpx = $tieneCpx;
				
				//Si hay traslado el día actual no creo regleta, esto para que lo genere la PDA
				if( $horaTrasladoHoyAux ){
					$tieneCpx = false;
				}
				
				if( $tieneCpx ){
					
					if( !$horaTraslado ){ 
						$horaTraslado = consultarHoraTraslado( $conex, $wbasedato, $historia, $ingreso, $info['Kadfec'] );
						
						$esTrasladoUrgencia = false;
					}
					else{
						$esTrasladoUrgencia = true;
					}
					
					$infoTipoArticulo = consultarinfotipoarticulosKardex( $conex, $wbasedato );
				
					if( !empty($info['Kadcpx']) ){	//Si ya se ha generado la regleta
						
						$vacioCpx = false;
						if( empty($info['Kadcpx'] ) ){
							$vacioCpx = true;
						}
						
						/************************************************************************************
						 * Septiembre 28 de 2011
						 ************************************************************************************/
						//Si el paciente fue trasladado el dia anterior, debo ver cuantas dosis demas fueron cargadas para el dia actual
						$canCargadaHoraCorte = 0;
						
						$fueReemplazado = false;
						if( trim( $info[ 'Kadaan' ] ) != '' ){
							$explodeRee = explode( ",", $info[ 'Kadaan' ] );
							
							if( !empty( $explodeRee[1] ) && $explodeRee[1] == $info['Kadfec'] ){
								$fueReemplazado = true;
							}
						}
						
						if( $horaTraslado && !empty( $info['Kadreg'] ) && !$fueReemplazado ){
							
							if( $esTrasladoUrgencia ){	//El traslado es del dia anterior a la creacion del kardex
								 
								list( $horaPar ) = explode( ":", $horaTraslado );
								
								if( $horaPar >= 0 ){	//Noviembre 11 de 2011

									$horaPar = intval( $horaPar/2 )*2;

									if( $horaPar < 10 ){
										if( $horaPar != 0 ){
											$horaPar = "0$horaPar:00:00";
										}
										else{
											$horaPar = false;
										}
									}
									else{
										$horaPar = "$horaPar:00:00";
									}

									//Calculo cuanto fue la cantidad cargada hasta la hora de corte
									$canCargadaHoraCorte = 0;
									if( $horaPar ){
										$canCargadaHoraCorte = cantidadTotalDispensadaRonda( $info['Kadcpx'], $horaPar );
									}
								}
								// else{	//Noviembre 11 de 2011
									
									// //Si el medicamento comienza despues de la hora de traslado no se calcula hasta la hora de dispensacion
									// //Esto por que el medicamento ya esta correcto
									// if( strtotime( $info['Kadfec']." $horaTraslado" ) > strtotime( $info['Kadfin']." ".$info['Kadhin'] ) ){
										// //Calculo cuanto fue la cantidad cargada hasta la hora de corte
										// $canCargadaHoraCorte = cantidadTotalDispensadaRonda( $info['Kadcpx'], "$horaCorteDispensacion:00:00" );
									// }
								// }
							}
							else{
								//Calculo cuanto fue la cantidad cargada hasta la hora de corte
								$canCargadaHoraCorte = cantidadTotalDispensadaRonda( $info['Kadcpx'], "$horaCorteDispensacion:00:00" );
							}						
							
							//Le resto el saldo del dia anterior
							$canCargadaHoraCorte -= $info['Kadsad'];
							
							if( $canCargadaHoraCorte < 0 ){
								$canCargadaHoraCorte = 0;
							}
							
							$info['Kaddis'] += $canCargadaHoraCorte;
						}
						/************************************************************************************/
						
						$canTotalACargar = calcularCantidadTotalACargarPorDia( $info['Kadcpx'] );
						$canTotalDispensada = calcularCantidadTotalDispensadaPorDia( $info['Kadcpx'] );
						$canCargadaAyer2 = calcularCantidadTotalADispensadaDia( $info['Kadcpx'] );
						$canCargadaAyer3 = cantidadTotalDispensadaRonda( $info['Kadcpx'], "00:00:00" );
						
						$canADispensarAyer = cantidadTotalADispensarRonda( $info['Kadcpx'], "00:00:00" );
						
						$info['Kadcpx'] = crearAplicacionesCargadasPorHorasKardex( $info['Kadcpx'], $info['Kaddis'] );
						$canCargadaAyer = cantidadTotalDispensadaRonda( $info['Kadcpx'], "00:00:00" );
						
						/************************************************************************************************************************
						 * Creando regleta
						 ************************************************************************************************************************/
						$vectorAplicacion = obtenerVectorAplicacionMedicamentos( $fechaGrabacion, $info['Kadfin'], $info['Kadhin'], $info['periodicidad'] );
						$vectorAplicacion2 = obtenerVectorAplicacionMedicamentos( date( "Y-m-d", strtotime( $fechaGrabacion )+$diasDispensacion*24*3600 ), $info['Kadfin'], $info['Kadhin'], $info['periodicidad'] );
						$vectorAplicacion2 = arreglarVectorKardex( $vectorAplicacion2 );
						
						$quitarUnoARegleta = 25;
						if( count($vectorAplicacion2) == 25 ){
							$quitarUnoARegleta = 24;
						}
						
						foreach( $vectorAplicacion2 as $keyB => $valueB ){
							$vectorAplicacion[ $quitarUnoARegleta ] = $valueB;
							$quitarUnoARegleta++;
						}
						
						$horasAplicacionDia = crearVectorAplicaciones( $vectorAplicacion, $infoTipoArticulo[ $info[ 'Kadpro' ] ]['tiempoPreparacion'], $info['Kadcfr']/$info['Kadcma'], intval( ( strtotime( "1970-01-01 ".$infoTipoArticulo[ $info[ 'Kadpro' ] ]['horaCaroteDispensacion'] ) - strtotime( "1970-01-01 00:00:00" ) )/3600 ) );
						/************************************************************************************************************************/

						if( ($canTotalDispensada - $canCargadaAyer3) > 0 ){
							$horasAplicacionDia = crearAplicacionesCargadasPorHorasKardex( $horasAplicacionDia,  ($canTotalDispensada - $canCargadaAyer3) );
						}
						
						if( $info['Kaddis'] - $canCargadaAyer > 0 ){
							$horasAplicacionDia = crearAplicacionesCargadasPorHorasKardex( $horasAplicacionDia, $info['Kaddis'] - ($canTotalDispensada - $canCargadaAyer3) - $canCargadaAyer);
						}					

						$info['Kadcpx'] = $horasAplicacionDia;
						
						list( $info['Kadron'], $info['Kadfro'] ) = explode( "|", consultarUltimaRondaDispensadaKardex( $info['Kadcpx'] ) );
						
						/**************************************************************************************************************
						 * Noviembre 1 de 2011
						 **************************************************************************************************************/
						if( !empty( $info['Kadron'] ) ){
							
							if( empty( $info['Kadfro'] ) ){
								$info['Kadfro'] = date( "Y-m-d", strtotime( trim( $fechaGrabacion )." 00:00:00" ) + 3600*24 );
							}
							else{
								$info['Kadfro'] = $fechaGrabacion;
							}
						}
						/**************************************************************************************************************/
						
						if( !$esArticuloNecesidad && !$esDeControl && $noEnviar != 'on' ){	//Septiembre 02 de 2011. Si es a necesidad o de control no debe crearse los saldo pendientes del dia anterior	//Mayo 23 de 2012, si el medicamento esta como no enviar no se generea saldo pendiente del dìa anterior
							if( $canADispensarAyer - ceil( $canCargadaAyer2 ) > 0 ){
								$info['Kadcpx'] = "Ant-".( ($canTotalACargar - $canCargadaAyer2)-($canTotalDispensada - $canCargadaAyer3)-($canTotalACargar-$canADispensarAyer) )."-0,".$info['Kadcpx'];
							}
						}
						
						if( $vacioCpx ){
							if( $info['Kadfin'] == date( "Y-m-d" ) && $info['Kadhin'] == "00:00:00" && $info['Kaddis'] == 0 ){
								$info['Kadcpx'] = "Ant-".($info['Kadcfr']/$info['Kadcma'])."-0,".$info['Kadcpx'];
							}
						}
					}
					else{	//Si no se ha generado la regleta
						
						//Si el campo Kadcpx esta vacio significa que recien empezo el ciclo de produccion
						//Se crea la regleta y se carga lo necesario para el dia actual
						//Para ello se tiene en cuenta que la dispensacion se hace desde el dia anterior hasta la hora de corte
						
						/************************************************************************************************************************
						 * Creando regleta para el dia anterior
						 ************************************************************************************************************************/
						$vectorAplicacion = obtenerVectorAplicacionMedicamentos( date( "Y-m-d", strtotime( $fechaGrabacion." 00:00:00" )-24*3600 ), $info['Kadfin'], $info['Kadhin'], $info['periodicidad'] );
						$vectorAplicacion2 = obtenerVectorAplicacionMedicamentos( $fechaGrabacion, $info['Kadfin'], $info['Kadhin'], $info['periodicidad'] );
						$vectorAplicacion2 = arreglarVectorKardex( $vectorAplicacion2 );
						
						$quitarUnoARegleta = 25;
						if( count($vectorAplicacion2) == 25 ){
							$quitarUnoARegleta = 24;
						}

						foreach( $vectorAplicacion2 as $keyB => $valueB ){
							$vectorAplicacion[$quitarUnoARegleta] = $valueB;
							$quitarUnoARegleta++;
						}						
						
						$horasAplicacionDia = crearVectorAplicaciones( $vectorAplicacion, $infoTipoArticulo[ $tipoProtocolo ]['tiempoPreparacion'], $info['Kadcfr']/$info['Kadcma'], intval( ( strtotime( "1970-01-01 ".$infoTipoArticulo[ $tipoProtocolo ]['horaCaroteDispensacion'] ) - strtotime( "1970-01-01 00:00:00" ) )/3600 ) );
						/************************************************************************************************************************/
						
						//Busco hasta donde alcanza las cantidades a dispensar
						$stringAnt = "";
						if( !$horaTraslado ){
							//Calculo la cantidad a dispensar hasta las hora de corte
							if( !empty( $info['Kadreg'] ) ){
								$canADispensarTemp1 = cantidadTotalADispensarRonda( $horasAplicacionDia, "$horaCorteDispensacion:00:00" );
							}
							else{
								$canADispensarTemp1 = 0;
							}
							
							//Calculo la cantidad a dispensar hasta las 24 horas
							$canADispensarTemp2 = cantidadTotalADispensarRonda( $horasAplicacionDia, "00:00:00" );
							
							//La diferencia indica cuanto era la cantidad total a dispensar entre la hora de corte y media noche del mismo dia
							$canADispensarDesdeCorteA24 = $canADispensarTemp2 - $canADispensarTemp1;
							
							//Calculo cuanto hay para cargar para el dia actual
							$totalACargarDiaActual = $info['Kaddis'] - $info['Kadsad'] - $canADispensarDesdeCorteA24 + cantidadDispensadaRondaKardex( $horasAplicacionDia, "00:00:00" );
						}
						else{	//Si hubo traslado
							
							$auxhoraTraslado = $horaTraslado;
							
							//Busco solo la hora, sin minutos y segundos
							list( $horaTraslado ) = explode( ":", $horaTraslado );
							
							$tmpDispensacion = 2; //consultarTiempoDispensacion( $conex, "01" );
							
							//Consulto la hora par mas cercana anterior
							$horaTraslado = intval( $horaTraslado/$tmpDispensacion )*$tmpDispensacion;
							
							//Creo la hora correctamente
							if( $horaTraslado < 10 ){
								if( $horaTraslado != 0 ){
									$horaTraslado = "0$horaTraslado:00:00";
								}
								else{
									$horaTraslado = false;
								}
							}
							else{
								if( $horaTraslado == 24 ){
									$horaTraslado .= "00:00:00";
								}
								else{
									$horaTraslado .= ":00:00";
								}
							}
							
							if( empty( $info['Kaddis'] ) ){	//Si no se dispenso dia anterior
							
								//Calculo cuanto se debe dispensar hasta la hora de corte
								$canADispensarTemp1 = cantidadTotalADispensarRonda( $horasAplicacionDia, "00:00:00" );
								
								//Calculo cuanto se debe dispensar hasta la hora par mas cercana
								$canADispensarAntesRecibo = cantidadTotalADispensarRonda( $horasAplicacionDia, $horaTraslado );
								
								//Calculo la cantidad que no se dispensó el día anterior
								$cantidadFaltante = $canADispensarTemp1 - $canADispensarAntesRecibo;
								
								//Creo string que indica cuanto se dejo de dispensar el dia anterior
								if( $cantidadFaltante > 0 ){
									$stringAnt = "Ant-".$cantidadFaltante."-0,";
								}

								//Como hubo traslado el dia anterior dejo la hora en 0
								//Esto para calcular la cantidad anterior correcta
								if( $horaTraslado ){
									$horaTraslado = "00:00:00";
								}
								
								$totalACargarDiaActual = 0;
								
								$horaTraslado = $auxhoraTraslado;
							}
							else{	//Si se dispenso dia anterior
								
								if( empty( $info['Kadreg'] ) ){	//Para cuando el articulo es creado la primera vez
									
									//Calculo cuanto se debe cargar en el dia actual
									$canADispensarTemp1 = cantidadTotalADispensarRonda( $horasAplicacionDia, "00:00:00" );
									
									$totalACargarDiaActual = $info['Kaddis'] - $canADispensarTemp1;
									
									//Si da negativo significa que hay saldo por grabar del dia anterior
									if( $totalACargarDiaActual < 0 ){
										$stringAnt = "Ant-".abs($totalACargarDiaActual)."-0,";
										$totalACargarDiaActual = 0;
									}
								}
								else{	//No es primera vez
								
									if( $esTrasladoUrgencia ){
									
										$fechorIncioMedicamento = strtotime( "{$info['Kadfin']} {$info['Kadhin']}" );
			
										if( time() > $fechorIncioMedicamento ){
											$ultimoSuministro = suministroAntesFechaCorte( $info['Kadfec'], "$horaTraslado", $info['Kadfin'], $info['Kadhin'], $info['periodicidad'] );
										}
										else{
											$ultimoSuministro = $fechorIncioMedicamento;	//Octubre 12 de 2011
										}
										
										$tiempoHastaDiaSiguiente = strtotime( $info['Kadfec']." $horaCorteDispensacion:00:00" );
										
										$tempSaldo = intval( ( $tiempoHastaDiaSiguiente - $ultimoSuministro )/( $info['periodicidad']*3600 ) );
										
										//Si es menor a 0 indica que el traslado es posterior a la hora de corte
										if( $tempSaldo < 0 ){
											
											$ultimoSuministro = suministroAntesFechaCorte( $info['Kadfec'], "$horaCorteDispensacion:00:00", $info['Kadfin'], $info['Kadhin'], $info['periodicidad'] );
										
											$info['Kaddis'] += intval( ( strtotime( $info['Kadfec']." $horaTraslado" ) - $ultimoSuministro + 5 )/( $info['periodicidad']*3600 ) );
										}
										else{
											$info['Kadsad'] += $tempSaldo;
										}
									}
									
									//Calculo cuanto se debe cargar a partir de la hora de corte
									$canADispensarTemp1 = cantidadTotalADispensarRonda( $horasAplicacionDia, "00:00:00" );
									
									//Calculo cuanto se debe cargar en el dia actual
									$canADispensarTemp1 -= cantidadTotalADispensarRonda( $horasAplicacionDia, "$horaCorteDispensacion:00:00" );
									
									$totalACargarDiaActual = $info['Kaddis'] - $canADispensarTemp1 - $info['Kadsad'];
									
									//Si da negativo significa que hay saldo por grabar del dia anterior
									if( $totalACargarDiaActual < 0 ){
										$stringAnt = "Ant-".abs($totalACargarDiaActual)."-0,";
										$totalACargarDiaActual = 0;
									}	
								}
							
								$horaTraslado = $auxhoraTraslado;
							}
						}
						
						/************************************************************************************************************************
						 * Creando regleta para el dia actual
						 ************************************************************************************************************************/
						$vectorAplicacion = obtenerVectorAplicacionMedicamentos( $fechaGrabacion, $info['Kadfin'], $info['Kadhin'], $info['periodicidad'] );
						$vectorAplicacion2 = obtenerVectorAplicacionMedicamentos( date( "Y-m-d", strtotime( $fechaGrabacion )+24*3600 ), $info['Kadfin'], $info['Kadhin'], $info['periodicidad'] );
						$vectorAplicacion2 = arreglarVectorKardex( $vectorAplicacion2 );
						
						$quitarUnoARegleta = 25;
						if( count($vectorAplicacion2) == 25 ){
							$quitarUnoARegleta = 24;
						}
		
						foreach( $vectorAplicacion2 as $keyB => $valueB ){
							$vectorAplicacion[$quitarUnoARegleta] = $valueB;
							$quitarUnoARegleta++;
						}
						
						$horasAplicacionDia = crearVectorAplicaciones( $vectorAplicacion, $infoTipoArticulo[ $tipoProtocolo ]['tiempoPreparacion'], $info['Kadcfr']/$info['Kadcma'], intval( ( strtotime( "1970-01-01 ".$infoTipoArticulo[ $tipoProtocolo ]['horaCaroteDispensacion'] ) - strtotime( "1970-01-01 00:00:00" ) )/3600 ) );
						/************************************************************************************************************************/
						
						if( $totalACargarDiaActual > 0 ){
							$horasAplicacionDia = crearAplicacionesCargadasPorHorasKardex( $horasAplicacionDia, $totalACargarDiaActual );
						}
						
						$info['Kadcpx'] = $stringAnt.$horasAplicacionDia;
						
						list( $info['Kadron'], $info['Kadfro'] ) = explode( "|", consultarUltimaRondaDispensadaKardex( $info['Kadcpx'] ) );
						
						/**************************************************************************************************************
						 * Noviembre 1 de 2011
						 **************************************************************************************************************/
						if( !empty( $info['Kadron'] ) ){
						
							if( empty( $info['Kadfro'] ) ){								
								$info['Kadfro'] = date( "Y-m-d", strtotime( trim( $fechaGrabacion )." 00:00:00" ) + 3600*24 );
							}
							else{
								$info['Kadfro'] = $fechaGrabacion;
							}
						}
						/**************************************************************************************************************/
					}
				}
				else{
					$info['Kadcpx'] = '';
				}
				
				$tieneCpx = $auxTieneCpx;
				
				$horaTraslado = $auxiliarHoraTraslado;
				/****************************************************************************************************************************************************************/
				
				/**************************************************************************************************************
				 * Septiembre 15 de 2011
				 **************************************************************************************************************/
				if( $tieneCpx ){
					$esArticuloNutricion = esArticuloNutricion( $conex, $wcenmez, $info['Kadart'] );
					
					//Si es un articulo de nutrición y comienza antes del día actual se desconfirma
					if( $esArticuloNutricion && strtotime( $info['Kadfin']." ".$info['Kadhin'] ) < strtotime( $fecha." 00:00:00" ) ){
						$confirmacionPreparacion = 'off';
					}
					else{
						$confirmacionPreparacion = $info[ 'Kadcon' ];
					}
				}
				else{
					$confirmacionPreparacion = 'off';
				}
				/**************************************************************************************************************/
				
				$articulos[] = $info;
				
				$info['Fecha_data'] = $auxFecha;
				$info['hora_data'] = $auxHora;
				
				$info['Kadobs'] = str_replace( "\\", "\\\\", $info['Kadobs'] );	//Marzo 3 de 2011
				$info['Kadobs'] = str_replace( "'", "\'", $info['Kadobs'] );	//Marzo 3 de 2011
				
				//Si el articulo fue aplicado en el dia anterior (kadfec) resto uno
				if( !empty( $info['Kadaan'] ) ){
				
					list( $articuloAnterior, $fechaReemplazo ) = explode( ",", $info['Kadaan'] );
					
					if( $fechaReemplazo == $info['Kadfec'] ){
			
						$fueAplicadoHoy = esAplicado( $conex, $wbasedato, $info['Kadhis'], $info['Kading'], $articuloAnterior, $fechaReemplazo );
						
						if( $fueAplicadoHoy && esAplicado( $conex, $wbasedato, $info['Kadhis'], $info['Kading'], $info['Kadart'], $fechaReemplazo ) ){
							$info['Kadcda']--;
						}
					}
				}
				
				$q = "INSERT INTO ".$wbasedato."_000060
		   					(Medico,Fecha_data,hora_data,Kadhis,Kading,Kadart,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kadcan,Kaddis,Kaduma,Kadcma,Kadhdi,Kadsal,Kadcdi,Kadpri,Kadpro,Kadcco,Kadare,Kadsad,Kadnar,kadreg,Kadusu,Kadfir,Kadcpx,Kadron,Kadfro,Kadaan,Kadcda,Kadcdt,Kadido, Kadusp, Kadpen, Kadule, Kadfle, Kadhle, Kadctr, Kadlev, Kaddoa, Kadimp, Kadlog, Kadnes, seguridad)
		   				VALUES
		   				   ('{$info['Medico']}','{$info['Fecha_data']}','{$info['hora_data']}','{$info['Kadhis']}',
		   					'{$info['Kading']}','{$info['Kadart']}','{$info['Kadcfr']}','{$info['Kadufr']}','$diasTratamiento','{$info['Kadest']}','$noEnviar','{$info['Kadper']}','{$info['Kadffa']}',
		   					'{$info['Kadfin']}','{$info['Kadhin']}','{$info['Kadvia']}','{$fechaGrabacion}','$confirmacionPreparacion','{$info['Kadobs']}','{$info['Kadori']}','{$info['Kadsus']}','{$info['Kadcnd']}',
		   					'{$info['Kaddma']}','$cantGrabar','$cantidadDispensada','{$info['Kaduma']}','{$info['Kadcma']}','{$horaDispensacion}','{$info['Kadsal']}','$cantidadADispensar','{$info['Kadpri']}',
		   					'{$info['Kadpro']}','{$info['Kadcco']}','{$info['Kadare']}','$saldoDispensacion','{$info['Kadnar']}','{$info['id']}','{$info['Kadusu']}','{$info['Kadfir']}','{$info['Kadcpx']}','{$info['Kadron']}','{$info['Kadfro']}','{$info['Kadaan']}','{$info['Kadcda']}','{$info['Kadcdt']}','{$info['Kadido']}','{$info['Kadusp']}','{$info['Kadpen']}','{$info['Kadule']}','{$info['Kadfle']}','{$info['Kadhle']}','{$info['Kadctr']}','{$info['Kadlev']}','{$info['Kaddoa']}','{$info['Kadimp']}','{$info['Kadlog']}','{$info['Kadnes']}','{$info['seguridad']}')";

				$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
				
				//Carga los articulos del la extensión del detalle del kardex a la temporal
				$sqlExt = "INSERT INTO ".$wbasedato."_000209
							(Medico  , Fecha_data  , Hora_data  , Ekxhis, Ekxing,   Ekxfec    , Ekxart, Ekxido, Ekxest, Ekxpro, Ekxtra, Ekxped, Ekxin1, Ekxin2, Ekxayu, Ekxaut, Ekxjus, Ekxfau, Ekxhau, Ekxmau, Ekxjau, Seguridad  )
						SELECT
							 a.Medico, a.Fecha_data, a.Hora_data, Ekxhis, Ekxing, '".$fecha."', Ekxart, Ekxido, Ekxest, Ekxpro, Ekxtra, Ekxped, Ekxin1, Ekxin2, Ekxayu, Ekxaut, Ekxjus, Ekxfau, Ekxhau, Ekxmau, Ekxjau, a.Seguridad
						FROM
							".$wbasedato."_000208 a, ".$wbasedato."_000060 b
						WHERE
							Kadhis = '".$historia."'
							AND Kading = '".$ingreso."'
							AND Kadfec = '".$fecha."'
							AND Kadart = '".$info['Kadart']."'
							AND Kadido = '".$info['Kadido']."'
							AND Ekxhis = Kadhis
							AND Ekxing = Kading
							AND Ekxfec = DATE_SUB(Kadfec,INTERVAL 1 DAY)
							AND Kadart = Ekxart
							AND Kadido = Ekxido
						";
				
				$res = mysql_query( $sqlExt, $conex ) or die( mysql_errno()." - Error en el query $sqlExt - ".mysql_error() );
			}
		}
	}
	
	verificacionArticulosGuardados( $conex, $wbasedato, "000060", $articulos, "Kardex dia anterior a temporal" );	//Mayo 20 de 2011 
}

function cargarMedicosAnteriorATemporal($historia,$ingreso,$fecha,$fechaGrabacion){
	global $wbasedato;
	global $conex;	
		
	$q2 = " SELECT Medico,Fecha_data,hora_data,Mettdo,Metdoc,Methis,Meting,'$fechaGrabacion',Metest,Metint,Metesp,Metusu,Metfir,seguridad 
		      FROM ".$wbasedato."_000063
		     WHERE Methis = '$historia'
			   AND Meting = '$ingreso'
			   AND Metfek = '$fechaGrabacion'
			   AND Metest = 'on'";
	$res2 = mysql_query($q2, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());
	$num2 = mysql_num_rows($res2);
	
	if($num2 == 0){
	
		$q = "INSERT INTO ".$wbasedato."_000063
				  (Medico,Fecha_data,hora_data,Mettdo,Metdoc,Methis,Meting,Metfek,Metest,Metint,Metesp,Metusu,Metfir,seguridad)
			SELECT Medico,Fecha_data,hora_data,Mettdo,Metdoc,Methis,Meting,'$fechaGrabacion',Metest,Metint,Metesp,Metusu,Metfir,seguridad 
			  FROM ".$wbasedato."_000047
			 WHERE Methis = '$historia'
			   AND Meting = '$ingreso'
			   AND Metest = 'on'
			   AND Metfek = DATE_SUB('".$fecha."',INTERVAL 1 DAY)";
		$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	
	}
}

function cargarDietasATemporal($historia,$ingreso,$fecha){
	global $wbasedato;
	global $conex;

	$q = "INSERT INTO ".$wbasedato."_000064
		   	(Medico,Fecha_data,hora_data,Dikcod,Dikhis,Diking,Dikfec,Dikest,Dikusu,Dikfir,Dikusp,Dikpen,Dikule,Dikfle,Dikhle,seguridad)
		SELECT 
			 Medico,Fecha_data,hora_data,Dikcod,Dikhis,Diking,Dikfec,Dikest,Dikusu,Dikfir,Dikusp,Dikpen,Dikule,Dikfle,Dikhle,seguridad
		FROM 
			".$wbasedato."_000052
		WHERE 
			Dikhis = '$historia'
			AND Diking = '$ingreso'
			AND Dikfec = '$fecha'";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

	//Borrar
	$q = "DELETE FROM
			".$wbasedato."_000052
		WHERE 
			Dikhis = '$historia'
			AND Diking = '$ingreso'
			AND Dikfec = '$fecha'";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
}

function cargarDietasAnteriorATemporal($historia,$ingreso,$fecha,$fechaGrabacion){
	global $wbasedato;
	global $conex;

	
	$q1 = "SELECT Medico,Fecha_data,hora_data,Dikcod,Dikhis,Diking,'$fechaGrabacion',Dikest,Dikusu,Dikfir,Dikusp,Dikpen,Dikule,Dikfle,Dikhle,seguridad
		     FROM ".$wbasedato."_000064
		    WHERE Dikhis = '$historia'
			  AND Diking = '$ingreso'
			  AND Dikfec = '$fechaGrabacion'";
	$res1 = mysql_query($q1, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q1 . " - " . mysql_error());
	$num1 = mysql_num_rows($res1);
	
	if($num1 == 0){	
	
		$q = "INSERT INTO ".$wbasedato."_000064
				  (Medico,Fecha_data,hora_data,Dikcod,Dikhis,Diking,Dikfec,Dikest,Dikusu,Dikfir,Dikusp,Dikpen,Dikule,Dikfle,Dikhle,seguridad)
			SELECT Medico,Fecha_data,hora_data,Dikcod,Dikhis,Diking,'$fechaGrabacion',Dikest,Dikusu,Dikfir,Dikusp,Dikpen,Dikule,Dikfle,Dikhle,seguridad
			  FROM ".$wbasedato."_000052
			 WHERE Dikhis = '$historia'
			   AND Diking = '$ingreso'
			   AND Dikfec = DATE_SUB('".$fecha."',INTERVAL 1 DAY)";
		$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	
	}
}

function cargarExamenesATemporal($historia,$ingreso,$fecha,$fechaGrabacion){
	global $wbasedato;
	global $conex;

	$q = "INSERT INTO ".$wbasedato."_000061
		   	(Medico,Fecha_data,hora_data,Ekahis,Ekaing,Ekacod,Ekaest,Ekaobs,Ekafes,Ekafec,Ekajus,Ekausu,Ekafir,seguridad)
		SELECT 
			 Medico,Fecha_data,hora_data,Ekahis,Ekaing,Ekacod,Ekaest,Ekaobs,Ekafes,'$fechaGrabacion',Ekajus,Ekausu,Ekafir,seguridad 
		FROM 
			".$wbasedato."_000050
		WHERE 
			Ekahis = '$historia'
			AND Ekaing = '$ingreso'
			AND Ekafec = '$fecha'";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

	//Borrar
	$q = "DELETE FROM
			".$wbasedato."_000050
		WHERE 
			Ekahis = '$historia'
			AND Ekaing = '$ingreso'
			AND Ekafec = '$fecha'";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
}

function cargarExamenesAnteriorATemporal($historia,$ingreso,$fecha,$fechaGrabacion){
	global $wbasedato;
	global $conex;

	$q = "INSERT INTO ".$wbasedato."_000061
		   	(Medico,Fecha_data,hora_data,Ekahis,Ekaing,Ekacod,Ekaest,Ekaobs,Ekafes,Ekafec,Ekajus,Ekausu,Ekafir,seguridad)
		SELECT 
			 Medico,Fecha_data,hora_data,Ekahis,Ekaing,Ekacod,Ekaest,Ekaobs,Ekafes,'$fechaGrabacion',Ekajus,Ekausu,Ekafir,seguridad 
		FROM 
			".$wbasedato."_000050
		WHERE 
			Ekahis = '$historia'
			AND Ekaing = '$ingreso'
			AND Ekafec = DATE_SUB('".$fecha."',INTERVAL 1 DAY)";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
}

/******************************************************************************************************
 * Consulta todas las ordenes que tenga el paciente
 * 
 * @param $historia
 * @param $ingreso
 * @param $fecha
 * @param $datosAdicionales
 * @return unknown_type
 ******************************************************************************************************/
function consultarOrdenesHCE($historia,$ingreso,$fecha,&$datosAdicionales,$detalt=false, $ccoPaciente){
	global $wbasedato;
	global $conex;
	global $codigoAyudaHospitalaria;
	global $wbasedatohce;
	global $wemp_pmla;
	
	global $usuario;
	
	if( empty($wemp_pmla) )
		$wemp_pmla = '01';
	
	$coleccion = array();
	$datosAdicionales = array();

	$condicionAlta = "";
	if($detalt)
		$condicionAlta = " AND Detalt = 'on' ";
	else
		$condicionAlta = " AND Detalt != 'on' ";
	
	$ccoUrgencias = consultarCcoUrgencias();
	
	//Si el centro de costos del paciente es igual a urgencias agrega las ordenes con estado diferente de pendiente.
	if($ccoPaciente == $ccoUrgencias){
	
		$q_realizados = " UNION SELECT
				Ordhis,Ording,Ordtor,Ordnro,Ordobs,Ordesp,Ordest,Ordfir,Dettor,Detnro,Detcod,Detesi,Detrdo,Detest,Detfec,Detjus,d.descripcion as Cconom,c.Descripcion,Protocolo, Detite, Tipoestudio,Ordusu,Detusu,Detalt,Detimp,Detfmo,Dethmo,Tiprju, '2' as estado, Codcups,Detpen, Deteex, Ordanx, Ordurl, Ordana, Detjoc, Ordple, Eexpen, Detplc, Eexcan, Tiputm, Detutm, Dethci, Deturl, Deturp, Detftm, Dethtm
			FROM 
				{$wbasedatohce}_000027 LEFT JOIN ".$wbasedato."_000011 ON Ccocod = Ordtor, {$wbasedatohce}_000028, {$wbasedatohce}_000047 c, {$wbasedatohce}_000015 d,".$wbasedato."_000045
			WHERE 
				Ordhis = '$historia' 
				AND Ording = '$ingreso'
				AND Ordest = 'on'
				AND Ordtor = Dettor
				AND Ordnro = Detnro
				AND Detest = 'on'	
				".$condicionAlta."
				AND c.Codigo = Detcod
				AND Tipoestudio = d.Codigo
				AND Detesi = Eexcod
				AND Eexmeh = 'on'
				AND timestamp(DATE_SUB( NOW() , INTERVAL 24 HOUR ) ) < timestamp(concat(Detfmo,' ', Dethmo ))
			UNION
			SELECT
				Ordhis,Ording,Ordtor,Ordnro,Ordobs,Ordesp,Ordest,Ordfir,Dettor,Detnro,Detcod,Detesi,Detrdo,Detest,Detfec,Detjus,d.descripcion as Cconom,c.Descripcion,Protocolo, Detite, Tipoestudio,Ordusu,Detusu,Detalt,Detimp,Detfmo,Dethmo,Tiprju, '2' as estado, Codcups,Detpen, Deteex, Ordanx, Ordurl, Ordana, Detjoc, Ordple, Eexpen, Detplc, Eexcan, Tiputm, Detutm, Dethci, Deturl, Deturp, Detftm, Dethtm
			FROM 
				{$wbasedatohce}_000027 LEFT JOIN ".$wbasedato."_000011 ON Ccocod = Ordtor, {$wbasedatohce}_000028, {$wbasedatohce}_000017 c,  {$wbasedatohce}_000015 d, ".$wbasedato."_000045
			WHERE 
				Ordhis = '$historia' 
				AND Ording = '$ingreso'
				AND Ordest = 'on'
				AND Ordtor = Dettor
				AND Ordnro = Detnro
				AND Detest = 'on'
				AND Eexmeh = 'on'				
				".$condicionAlta."
				AND c.Codigo = Detcod
				AND Tipoestudio = d.Codigo
				AND nuevo = 'on'
				AND Detesi = Eexcod 
				AND timestamp(DATE_SUB( NOW() , INTERVAL 24 HOUR ) ) < timestamp(concat(Detfmo,' ', Dethmo ))";
		
	}
	
	//Consulta las ordenes asociadas al paciente que tengan estado pendiente, autorizado o pendiente de realizar.
	$q = "SELECT
			Ordhis,Ording,Ordtor,Ordnro,Ordobs,Ordesp,Ordest,Ordfir,Dettor,Detnro,Detcod,Detesi,Detrdo,Detest,Detfec,Detjus,d.descripcion as Cconom,c.Descripcion,'' as Protocolo, Detite, Tipoestudio,Ordusu,Detusu,Detalt,Detimp,Detfmo,Dethmo,Tiprju, '1' as estado, Codcups,Detpen, Deteex, Ordanx, Ordurl, Ordana, Detjoc, Ordple, Eexpen, Detplc, Eexcan, Tiputm, Detutm, Dethci, Deturl, Deturp, Detftm, Dethtm
		FROM 
			{$wbasedatohce}_000027 LEFT JOIN ".$wbasedato."_000011 ON Ccocod = Ordtor, {$wbasedatohce}_000028, {$wbasedatohce}_000047 c, {$wbasedatohce}_000015 d,".$wbasedato."_000045
		WHERE 
			Ordhis = '$historia' 
			AND Ording = '$ingreso'
			AND Ordest = 'on'
			AND Ordtor = Dettor
			AND Ordnro = Detnro
			AND Detest = 'on'	
			".$condicionAlta."
			AND c.Codigo = Detcod
			AND Tipoestudio = d.Codigo
			AND Detesi = Eexcod
			AND Eexmeh != 'on'
		UNION
		SELECT
			Ordhis,Ording,Ordtor,Ordnro,Ordobs,Ordesp,Ordest,Ordfir,Dettor,Detnro,Detcod,Detesi,Detrdo,Detest,Detfec,Detjus,d.descripcion as Cconom,c.Descripcion,Protocolo, Detite, Tipoestudio,Ordusu,Detusu,Detalt,Detimp,Detfmo,Dethmo,Tiprju, '1' as estado, Codcups,Detpen, Deteex, Ordanx, Ordurl, Ordana, Detjoc, Ordple, Eexpen, Detplc, Eexcan, Tiputm, Detutm, Dethci, Deturl, Deturp, Detftm, Dethtm
		FROM 
			{$wbasedatohce}_000027 LEFT JOIN ".$wbasedato."_000011 ON Ccocod = Ordtor, {$wbasedatohce}_000028, {$wbasedatohce}_000017 c,  {$wbasedatohce}_000015 d, ".$wbasedato."_000045
		WHERE 
			Ordhis = '$historia' 
			AND Ording = '$ingreso'
			AND Ordest = 'on'
			AND Ordtor = Dettor
			AND Ordnro = Detnro
			AND Detest = 'on'	
			".$condicionAlta."
			AND c.Codigo = Detcod
			AND Tipoestudio = d.Codigo
			AND nuevo = 'on'
			AND Detesi = Eexcod
			AND Eexmeh != 'on'
			$q_realizados
			ORDER BY Ordtor,Ordnro,estado ";
	
	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);
	
	//Busco si una orden tiene examenes pendientes
	$examenesPendientes = [];
	$rows 				= [];
	while( $info = mysql_fetch_array($res) ){
		
		if( !isset( $examenesPendientes[ $info['Ordtor'] ][ $info['Ordnro'] ] ) )
			$examenesPendientes[ $info['Ordtor'] ][ $info['Ordnro'] ] = false;
		
		if( ( $ccoPaciente == $ccoUrgencias ) || $info['Eexpen'] == 'on' ){
			$examenesPendientes[ $info['Ordtor'] ][ $info['Ordnro'] ] = true;
		}
		
		$rows[] = $info;
	}
	
	// $res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	// $num = mysql_num_rows($res);

	//Si un tipo de orden no deja mover el estado, dejo todos los campos que intervienen en la 
	//interoperabilidad en vacio, esto para que no se vea reflejado a la enfermera ningún cambio
	//y permite a la enfermera modificar los estados sin problemas
	// $estadoPorTipoOrden = consultarAliasPorAplicacion( $conex, $wemp_pmla, "permitirCambiarEstadoInteroperabilidadPorTipoOrden" );

	// $estadoPorTipoOrden = explode( "-", $estadoPorTipoOrden );
	
	$estadoPorTipoOrden = ccoConInteroperabilidadLaboratorio( $conex, $wbasedato, $historia, $ingreso );
	
	if ($num > 0)
	{
		$cont1 = 0;

		// while ($cont1 < $num){
		foreach ($rows as $info){
			$cont1++;
				
			$detalle = new ExamenHCEDTO();

			//Ordfec,Ordhor,Ordhis,Ording,Ordtor,Ordnro,Ordobs,Ordesp,Ordest,Ordfir,Dettor,Detnro,Detcod,Detesi,Detrdo,Detest
				
			// $info = mysql_fetch_array($res);
			
			$mostrarAlertaNoOfertado = true;
			
			if( !$examenesPendientes[ $info['Ordtor'] ][ $info['Ordnro'] ] )
				continue;
			
			$estadoPorTipoOrden2 = array_merge( $estadoPorTipoOrden, ccoConInteroperabilidadPorEstudio( $conex, $wbasedato, $historia, $ingreso, $info['Ordtor'], $info['Codcups'] ) );
			
			// $permiteModEst = in_array( $info['Ordtor'], $estadoPorTipoOrden ) ? false : true;
			$permiteModEst = in_array( $info['Ordtor'], $estadoPorTipoOrden2 ) ? true : false;
			
			if( !$permiteModEst ){
				$info['Ordurl'] = '';
				$info['Deteex'] = '';
				$info['Detjoc'] = '';
				$info['Detfme'] = '0000-00-00';
				$info['Dethme'] = '00:00:00';
				$info['Detcor'] = 'off';
				$info['Detplc'] = '';
				// $info['Detutm'] = '';
				$info['Dethci'] = '00:00:00';
				$info['Deturl'] = '';
				$info['Deturp'] = '';
				$info['Tiputm'] = 'off';
				
				$mostrarAlertaNoOfertado = false;
			}
			
			if( !$usuario->esEnfermeraRolHCE ){
				$info['Ordurl'] = '';
				$info['Deturl'] = '';
				$info['Deturp'] = '';
			}

			//Encabezado de orden
			$detalle->historia = $historia;
			$detalle->ingreso = $ingreso;
				
			$detalle->fecha = @$info['Ordfec'];
			$detalle->hora = @$info['Ordhor'];
			$detalle->tipoDeOrden = $info['Ordtor'];
			$detalle->numeroDeOrden = $info['Ordnro'];
			$detalle->observacionesOrden = $info['Ordobs'];
			$detalle->estadoOrden = $info['Ordesp'];
			$detalle->estadoRegistroOrden = $info['Ordest'];
			$detalle->firmaOrden = $info['Ordfir'];
			$detalle->nombreExamen = strtoupper( $info['Descripcion'] );
			$detalle->nombreCentroCostos = @$info['Cconom'];
			$detalle->codigoExamen = $info['Detcod'];
			$detalle->estadoExamen = $info['Detesi'];
			$detalle->resultadoExamen = $info['Detrdo'];
			$detalle->estadoRegistroExamen = $info['Detest'];
			$detalle->fechaARealizar = $info['Detfec'];		
			$detalle->justificacion = $info['Detjus'];
			$detalle->pendienteLectura = $info['Detpen'];
			
			$traer_protocolo = traer_protocolo_examen($wbasedatohce, $info['Codcups']);
			
			$detalle->protocoloPreparacion = $traer_protocolo;
			$detalle->detnro = $info['Detnro'];
			$detalle->nroItem = $info['Detite'];
			
			$detalle->tipoEstudio = $info['Tipoestudio'];
			
			$detalle->altaExamen = $info['Detalt'];
			$detalle->imprimirExamen = $info['Detimp'];

			$detalle->creadorOrden = $info['Ordusu'];
			$detalle->creadorItem = $info['Detusu'];
			
			$detalle->requiereJustificacion = $info['Tiprju'];
			$detalle->bitacoraGestion = consultarBitacora( $conex, $wbasedato, $historia, $ingreso, $detalle->detnro, $detalle->nroItem );
			
			
			$detalle->estadoExterno = $info['Deteex'];
			
			$detalle->descripcionEstadoExterno = $detalle->consultarDescripcionEstadoExterno( $conex, $wbasedato );
			
			$detalle->anexarOrden = strtolower( $info['Ordanx'] ) == 'on';
			
			$detalle->anexadaAOrden = $info['Ordana'];
			
			$detalle->justificacionOrdenCancelada = trim( $info['Detjoc'] );
			
			//Indica si el médico no ha leído el resultado del examen
			$detalle->pendienteLecturaMedico = strtolower( $info['Ordple'] ) == 'on';
			
			//Indica si el médico no ha leído una orden cancelada por parte de laboratorio
			$detalle->pendienteLecturaEstudioCancelado = strtolower( $info['Detplc'] ) == 'on'; // && strtolower( $info['Eexcan'] ) == 'on';
			
			//Indica si el tipo de orden solicita que usuario tomó la muestra
			$detalle->solicitaUsuarioTomaMuestra = strtolower( $info['Tiputm'] ) == 'on';
			
			
			$usuarioTomaMuestra = '';
			if( !empty($info['Detutm']) ){
				
				//Buscar en la tabla de usuario que cco le pertenece al usuario.
				$q_user = "SELECT Descripcion
							 FROM usuarios
							WHERE Codigo = '".$info['Detutm']."'";
				
				$res_user = mysql_query($q_user, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q_user . " - " . mysql_error());
				
				if( $rows = mysql_fetch_array( $res_user ) ){
					$usuarioTomaMuestra = $rows['Descripcion'];
				}
				else{
					$usuarioTomaMuestra = $info['Detutm'];
				}
				
				$usuarioTomaMuestra .= "<br>".$info['Detftm']." ".$info['Dethtm'];
			}
			
			//Indica el usuario que toma la muestra
			$detalle->usuarioTomaMuestra = $usuarioTomaMuestra;
			
			
			//Si el estado externo no permite tomar muestra, cambia la propiedad solicitaUsuarioTomaMuestra a false (no deja tomar muestra)
			$detalle->permiteTomarMuestra( $conex, $wbasedato, $permiteModEst );
			
			$detalle->horaCita = strtolower( $info['Dethci'] );
			
			$detalle->urlImagenPorEstudio = strtolower( $info['Deturl'] );
			$detalle->urlReportePorEstudio = strtolower( $info['Deturp'] );
			
			$detalle->comentarios = "";
			$detalle->esCupOfertado = false;
			
			$comentarios = consultarComentarioPorInteroperabilidad( $conex, $wbasedato, $detalle->tipoDeOrden, $detalle->detnro, $detalle->nroItem  );
			
			$textCita = "";
			$txtComentario = '';
			
			if( $permiteModEst && count($comentarios) > 0 ){
				
				$txtComentario .= "<b>Comentarios:</b>";
				
				foreach( $comentarios as $datoComenario ){
					$txtComentario .= "<br><b>".$datoComenario['fecha']." ".$datoComenario['hora']."</b><br>".$datoComenario['comentario'];
				}
			}
			
			if( !empty( $detalle->horaCita ) && $detalle->horaCita != '00:00:00' ){
				
				$sala = '';
				
				//Consultando la sala en que se realizará la cita
				//Buscar en la tabla de usuario que cco le pertenece al usuario.
				$sql = "SELECT b.Saldes
							 FROM ".$wbasedato."_000268 a, ".$wbasedato."_000263 b
							WHERE a.mvctor = '".$detalle->tipoDeOrden."'
							  AND a.mvcnro = '".$detalle->detnro."'
							  AND a.mvcite = '".$detalle->nroItem."'
							  AND b.salcod = a.mvcsal";
				$resSala = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
				if( $rowsSala = mysql_fetch_array( $resSala ) ){
					$sala = $rowsSala['Saldes'];
				}
				
				
				$textCita .= "<tr>
								<td>Fecha</td><td><b>".$detalle->fechaARealizar."</b></td>
							</tr>
							<tr>
								<td>Hora</td><td><b>".$detalle->horaCita."</b></td>
							</tr>
							<tr>
								<td>Sala</td><td><b>".$sala."</b></td>
							</tr>
						";
				
			}
			
			if( !empty($txtComentario) ){
				$textCita .= "<tr><td colspan=2>$txtComentario</td></tr>";
			}
			
			if( !empty($textCita) ){
				$detalle->comentarios = "<table>$textCita</table>";
			}
			
			//Si el estado externo de algun examen es P o F, se muestra la url
			$sql = "SELECT
						*
					FROM
						".$wbasedatohce."_000027, ".$wbasedatohce."_000028
					WHERE
						Ordhis =  '$historia' 
						AND Ording = '$ingreso'
						AND Ordtor = '".$detalle->tipoDeOrden."'
						AND Ordnro = '".$detalle->numeroDeOrden."'
						AND Ordnro = Detnro
						AND Dettor = Ordtor
						AND Deteex IN ('P','F')
						AND Detest = 'on'
					";
			
			$resEF  = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
			$numEF  = mysql_num_rows($resEF);
			
			$detalle->url = "";
			if( $numEF > 0 ){
				$detalle->url = $info['Ordurl'];
			}
			
			$detalle->muestras = consultarDatosAdicionales( $conex, $wbasedato, $detalle->tipoDeOrden, $detalle->numeroDeOrden, $detalle->nroItem );
			
			$tablaOfertas 	= "";
			$campoOferta	= "";
			$campoEstado	= "";
			
			//Consulto si existe cups ofertados por tipo de orden
			$sql = "SELECT Valtoc, Valcoc, Valeoc, Valerl
					  FROM ".$wbasedato."_000267
					 WHERE valtor = '".$detalle->tipoDeOrden."'
					   AND valest = 'on'
				  GROUP BY 1,2,3";
			
			$resToOfertado 	= mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
			$numToOfertado	= mysql_num_rows($resToOfertado);
			
			$detalle->realizaUnidad	= false;
			
			if( $mostrarAlertaNoOfertado && $numToOfertado > 0 ){
				
				if( $rowsToOfertado = mysql_fetch_array( $resToOfertado ) )
				{
					$tablaOfertas 		= $rowsToOfertado['Valtoc'];
					$campoOferta		= $rowsToOfertado['Valcoc'];
					$campoEstado		= $rowsToOfertado['Valeoc'];
					$campoRealizaUnidad	= trim( $rowsToOfertado['Valerl'] );
					
					$sql = "SELECT *
							  FROM ".$tablaOfertas."
							 WHERE ".$campoOferta." = '".$info['Codcups']."'
							   AND ".$campoEstado." = 'on'";
					
					$resConOferta = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
					$numConOferta = mysql_num_rows($resConOferta);
					
					if( $numConOferta == 0 ){
						$detalle->descripcionEstadoExterno = "No ofertado";
					}
					else{
						$detalle->esCupOfertado = true;
						
						$rowCupOfertado = mysql_fetch_array( $resConOferta );
						
						if( $campoRealizaUnidad != '' && isset( $rowCupOfertado[ $campoRealizaUnidad ] ) )
							if( strtolower( $rowCupOfertado[ $campoRealizaUnidad ] ) == 'on' )
								$detalle->realizaUnidad	= true;
					}
				}
			}
			
			
			
			//Si es ayuda hospitalaria el centro de costos es hospitalario
			// if($detalle->tipoDeOrden == $codigoAyudaHospitalaria){
				// $detalle->nombreCentroCostos = "HOSPITALARIAS";
			// }
			
			
			//contando el examenes anteriores
			//$datosAdicionales Array de tres dimensiones
			//[] 1ra. dimension Tipo de origen o servicio al que pertenece
			//[] 2da. dimension Numero de orden 
			//[] 3ra. dimension Si es pendiente o no
			//Este array contiene informacion de cuantos examenes hay pendientes o diferentes a pendientes (Anteriores)
			
			$westados_ordenes = estados_ordenes($wemp_pmla, $wbasedato, $conex, $detalle->estadoExamen);
			
			if( $westados_ordenes ){
				@$datosAdicionales[ $detalle->tipoDeOrden ][ $detalle->numeroDeOrden ]['Pendientes']++;
			}
			else{
				@$datosAdicionales[ $detalle->tipoDeOrden ][ $detalle->numeroDeOrden ]['Anteriores']++;
			}
			
			//Tipos de ayudas, cooresponde al codigo Tipo Estudio
			$detalle->tipoAyudasDxs =  new tiposAyudasDxHCEDTO();
			
			$sql = "SELECT
						Codigo,Descripcion,Arc_HL7,Programa,Formato
					FROM
						".$wbasedatohce."_000015
					WHERE
						codigo = '{$info['Tipoestudio']}'
					";
			
			$resTAdx = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
			$numTAdx = mysql_num_rows($resTAdx);
	
			if( $rowsTAdx = mysql_fetch_array( $resTAdx ) ){
				
				$detalle->tipoAyudasDxs->codigo = $rowsTAdx['Codigo']; 
				$detalle->tipoAyudasDxs->descripcion = $rowsTAdx['Descripcion'];
				$detalle->tipoAyudasDxs->arc_HL7 = $rowsTAdx['Arc_HL7'];
				$detalle->tipoAyudasDxs->programa = $rowsTAdx['Programa'];
				$detalle->tipoAyudasDxs->formato = $rowsTAdx['Formato'];
				
				@$datosAdicionales[ $detalle->tipoDeOrden ][ $detalle->numeroDeOrden ]['Programa'] = $rowsTAdx['Programa']; 
			}
			
			//Fin de tipos de ayudas
			
			//Busco si el paciente tiene examenes anteriores
			$sql = "SELECT
						*
					FROM
						".$wbasedatohce."_000027, ".$wbasedatohce."_000028
					WHERE
						Ordhis =  '$historia' 
						AND Ording = '$ingreso'
						AND Ordtor = '{$info['Dettor']}'
						AND Ordnro = Detnro
						AND Dettor = Ordtor
						AND Detesi NOT IN ('P','Pendiente')
						AND Detest = 'on'
					";
			
			$resAnt = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
			$numAnt = mysql_num_rows($resAnt);
			
			if( $numAnt > 0 ){
				$detalle->tieneAnteriores = true;
			}
			else{
				$detalle->tieneAnteriores = false;
			}
			//Fin de Buscar

			$coleccion[] = $detalle;
		}
	}
	return $coleccion;
}


function cargarInfusionesATemporal($historia,$ingreso,$fecha){
	global $wbasedato;
	global $conex;

	$q = "INSERT INTO ".$wbasedato."_000062
		   	(Medico,Fecha_data,hora_data,Inkhis,Inking,Inkcon,Inkdes,Inkfec,Inkobs,Inkfes,seguridad)
		SELECT
			 Medico,Fecha_data,hora_data,Inkhis,Inking,Inkcon,Inkdes,Inkfec,Inkobs,Inkfes,seguridad
		FROM
			".$wbasedato."_000051
		WHERE
			Inkhis = '$historia'
			AND Inking = '$ingreso'
			AND Inkfec = '$fecha'";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

	//Borro
	$q = "DELETE FROM
			".$wbasedato."_000051
		WHERE
			Inkhis = '$historia'
			AND Inking = '$ingreso'
			AND Inkfec = '$fecha'";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
}

function cargarInfusionesAnteriorATemporal($historia,$ingreso,$fecha,$fechaGrabacion){
	global $wbasedato;
	global $conex;

	$q = "INSERT INTO ".$wbasedato."_000062
		   	(Medico,Fecha_data,hora_data,Inkhis,Inking,Inkcon,Inkdes,Inkfec,Inkobs,Inkfes,seguridad)
		SELECT
			 Medico,Fecha_data,hora_data,Inkhis,Inking,Inkcon,Inkdes,'$fechaGrabacion',Inkobs,Inkfes,seguridad
		FROM
			".$wbasedato."_000051
		WHERE
			Inkhis = '$historia'
			AND Inking = '$ingreso'
			AND Inkfec = DATE_SUB('".$fecha."',INTERVAL 1 DAY)";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
}


/************************************************************************************************************************************************
 * Inserta los campos de la temporal del kardex (tabla 60) a la tabla definitiva del kardex(54) y borra los datos de la temporal.
 * segun la historia e ingreso de un paciente
 * 
 * @param $historia
 * @param $ingreso
 * @param $fecha
 * @param $esPrimerKardex
 * @return unknown_type
 ************************************************************************************************************************************************/
function cargarArticulosADefinitivo( $historia, $ingreso, $fecha, $esPrimerKardex ){
	global $wbasedato;
	global $conex;
	global $usuario;		//Información de usuario

	global $centroCostosServicioFarmaceutico;
	global $codigoServicioFarmaceutico;
	global $centroCostosCentralMezclas;
	
	global $paciente;
	
	$artAprobado = false;
	$conf = false;
	if( $paciente->enUrgencias ){
		$artAprobado = true;
	}

	$horasFrecuencia = 2;

	/****************************************************************
	 * Junio 14 de 2012
	 ****************************************************************/
	$valCooquery = "";
	if( $usuario->centroCostosGrabacion != '*' ){
		$valCooquery = " AND Kadcco = '$usuario->centroCostosGrabacion' ";
	}
	/****************************************************************/
	
	$q = "SELECT
			Medico,Fecha_data,hora_data,Kadhis,Kading,Kadart,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kadcan,Kaddis,Kaduma,Kadcma,Kadhdi,Kadsal,Kadcdi,Kadpri,Kadpro,Kadcco,Kadare,Kadsad,seguridad,Kadreg,Kadron,Kadcpx,Kadfro,Kadaan,Kadcda,Kadcdt,Kadusu,Kadfir,Kadnar,Kaddan,Kadfum,Kadhum,Kadido,Kadfra,Kadfcf,Kadhcf,Kadimp,Kadalt,Kadcal,Kadusp,Kadpen,Kadule,Kadfle,Kadhle,Kadctr,Kadlev,Kaddoa,Kadlog,Kadnes
		FROM
			{$wbasedato}_000060
		WHERE
			Kadfec = '$fecha'
			AND Kadhis = '$historia'
			AND Kading = '$ingreso'
			$valCooquery";
			
	elementosGrabados( $conex, $articulos, $q );

	//Coleccion de horas de frecuencias
	$colFrecuencias = array_merge( consultarPeriodicidades("C"), consultarPeriodicidades( "I" ) );

	$res1 = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res1);

	if ($num > 0){
		$cont1 = 0;

		while ($cont1 < $num ){
			$cont1++;
			
			if( true ){
	
				$info = mysql_fetch_array($res1);
				
				//Si el articulo es de central de mezclas se confirma su preparación
				$conf = false;
				if( $artAprobado && $info['Kadori'] != $codigoServicioFarmaceutico ){
					$conf = true;
				}
	
				//La solución a esto es consultar las fracciones, si no tiene fracciones se usan dias de estabilidad cero (no tiene)
				$tarti = $centroCostosCentralMezclas;
				if($info['Kadori'] == $codigoServicioFarmaceutico){
					$tarti = $centroCostosServicioFarmaceutico;
				}
	
				$qf = "SELECT
							Defart,Defdup, Defdis, Defcco, Defdie
						FROM
							{$wbasedato}_000059
						WHERE
							Defart = '{$info['Kadart']}'
							AND Defcco = '$tarti'
							AND Defest = 'on'";
	
				$respin = mysql_query($qf, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qf . " - " . mysql_error());
				$numf = mysql_num_rows($respin);
	
				$diasEstabilidad = 0;
				$dispensable = "on";
	
				while($infofr = mysql_fetch_array($respin)){
					$diasEstabilidad 	= $infofr['Defdie'];
					$dispensable 		= $infofr['Defdis'];
				}

				//Frecuencia
				foreach ($colFrecuencias as $frecuencia){
					if($frecuencia->codigo == $info['Kadper']){
						$horasFrecuencia = $frecuencia->equivalencia;
						break;
					}
				}

				//Calculo del saldo actual con base en el anterior
				$saldo = 0;
				$cantGrabar = 0;
				$cantDispensar = 0;
				$cantidadManejo = 0;
	
				//$ccoOrigen,$diasEstabilidad,$diasTtoAcumulados,
	
				//Calculo de los dias de tratamiento actuales, Sumo 1 dia por el registro del dia actual que esta en temporal
				$diasTtoAcumulados = 0;
				$dosisTtoTotales = 0;
	
				obtenerDatosAdicionalesArticulo($info['Kadhis'],$info['Kading'],$info['Kadart'],$diasTtoAcumulados,$dosisTtoTotales);
	
				//Calculo de las cantidades por articulo
				$horasAplicacionDia = "";
				calcularSaldoActual( $conex,$wbasedato,$info['Kadhis'],$info['Kading'],$fecha,$info['Kadart'],$info['Kadfin'],$info['Kadhin'],$info['Kadcfr'],$horasFrecuencia,$info['Kaddma'],$info['Kadori'],$diasTtoAcumulados+1,$cantGrabar,$saldo,$cantDispensar,$cantidadManejo,$info['Kadsad'],$info['Kadpro'],$horasAplicacionDia, $info['Kaddia'], $info['Kadreg'] );
				//calcularSaldoActual($conex,$wbasedato,$info['Kadhis'],$info['Kading'],$fecha,$info['Kadart'],$info['Kadfin'],$info['Kadhin'],$info['Kadcfr'],$horasFrecuencia,$info['Kaddma'],$info['Kadori'],$diasTtoAcumulados+1,&$cantGrabar,&$saldo,&$cantDispensar,&$cantidadManejo,$info['Kadsad'],$info['Kadpro'],$info['Kadcpx'], $info['Kadreg'] );
				
				//No dispensable, saldos en cero
				if($dispensable == 'off' || $info['Kadess'] == 'on'){
					$cantDispensar = 0;
					$cantGrabar = 0;
					$saldo = 0;
				}
	
				$info['Kadobs'] = str_replace( "\\", "\\\\", $info['Kadobs'] ); //Marzo 3 de 2011
				$info['Kadobs'] = str_replace( "'", "\'", $info['Kadobs'] );	//Marzo 3 de 2011
				
				$info['Kadare'] = $artAprobado ? 'on': $info['Kadare'];
				$info['Kadcon'] = $conf  ? 'on': $info['Kadcon'];
				
				$q = "INSERT INTO ".$wbasedato."_000054
			   				(Medico,Fecha_data,hora_data,Kadhis,Kading,Kadart,Kadcfr,Kadufr,Kaddia,Kadest,Kadess,Kadper,Kadffa,Kadfin,Kadhin,Kadvia,Kadfec,Kadcon,Kadobs,Kadori,Kadsus,Kadcnd,Kaddma,Kadcan,Kaddis,Kaduma,Kadcma,Kadhdi,Kadsal,Kadcdi,Kadpri,Kadpro,Kadcco,Kadare,Kadsad,Kadreg,Kadcpx,Kadron,Kadfro,Kadaan,Kadcda,Kadcdt,Kadusu,Kadfir,Kadnar,Kaddan,Kadfum,Kadhum,Kadido,Kadfra,Kadfcf,Kadhcf,Kadimp,Kadalt,Kadcal,Kadusp,Kadpen,Kadule,Kadfle,Kadhle,Kadctr,Kadlev,Kaddoa,Kadlog,Kadnes,seguridad)
			   			VALUES
			   			   ('{$info['Medico']}','{$info['Fecha_data']}','{$info['hora_data']}','{$info['Kadhis']}',
			   				'{$info['Kading']}','{$info['Kadart']}','{$info['Kadcfr']}','{$info['Kadufr']}','{$info['Kaddia']}','{$info['Kadest']}','{$info['Kadess']}','{$info['Kadper']}','{$info['Kadffa']}',
			   				'{$info['Kadfin']}','{$info['Kadhin']}','{$info['Kadvia']}','{$fecha}','{$info['Kadcon']}','{$info['Kadobs']}','{$info['Kadori']}','{$info['Kadsus']}','{$info['Kadcnd']}',
			   				'{$info['Kaddma']}','{$cantGrabar}','{$info['Kaddis']}','{$info['Kaduma']}','{$cantidadManejo}','{$info['Kadhdi']}','{$saldo}','{$cantDispensar}','{$info['Kadpri']}',
			   				'{$info['Kadpro']}','{$info['Kadcco']}','{$info['Kadare']}','{$info['Kadsad']}','{$info['Kadreg']}','{$info['Kadcpx']}','{$info['Kadron']}','{$info['Kadfro']}','{$info['Kadaan']}','{$info['Kadcda']}','{$info['Kadcdt']}','{$info['Kadusu']}','{$info['Kadfir']}','{$info['Kadnar']}','{$info['Kaddan']}','{$info['Kadfum']}','{$info['Kadhum']}','{$info['Kadido']}','{$info['Kadfra']}','{$info['Kadfcf']}','{$info['Kadhcf']}','{$info['Kadimp']}','{$info['Kadalt']}','{$info['Kadcal']}','{$info['Kadusp']}','{$info['Kadpen']}','{$info['Kadule']}','{$info['Kadfle']}','{$info['Kadhle']}','{$info['Kadctr']}','{$info['Kadlev']}','{$info['Kaddoa']}','{$info['Kadlog']}','{$info['Kadnes']}','{$info['seguridad']}')";

				$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
			}
		}
	}
	
	/************************************************************************************************************************************
	 * Mayo 20 de 2011
	 * 
	 * Borro los registros que efectivamente pasaron a la tabla definitiva del kardex(000054) desde la tabla temporal
	 ************************************************************************************************************************************/
	$malos = verificacionArticulosGuardados( $conex, $wbasedato, "000054", $articulos, "Cargando articulos a definitivo" );
	
	if( count( $articulos ) > 0 ){
		
		foreach( $articulos as $key => $value ){
	
			if( !isset( $malos[$key] ) ){
						
				$sql = "SELECT 
							id 
						FROM
							".$wbasedato."_000060
						WHERE
							Kadhis = '".$historia."'
							AND Kading = '".$ingreso."'
							AND Kadart = '".$value['Kadart']."'
							AND Kadfec = '".$fecha."'
							AND Kadfin = '".$value['Kadfin']."'
							AND Kadhin = '".$value['Kadhin']."'
							AND Kadido = '".$value['Kadido']."'";
							
				$resSql = mysql_query( $sql, $conex ) or die( mysql_errno()."- Error en el query $sql - ".mysql_error() );
				$numSql = mysql_num_rows( $resSql );
				
				if( $numSql > 0 ){
				
					$rowsSql = mysql_fetch_array( $resSql );
				
					$q = "DELETE FROM
							".$wbasedato."_000060
						WHERE
							id = '".$rowsSql['id']."'";
						
					$resDel = mysql_query( $q, $conex ) or die( mysql_errno()."- Error en el query $sql - ".mysql_error() );
					
					if( mysql_affected_rows() == 0 ){
						$descripcion = "Aticulo NO ELIMINADO en temporal";
						$datos = "Kadhis: ".$historia;
						$datos .= ", Kading: ".$ingreso;
						$datos .= ", Kadart: ".$value['Kadart'];
						$datos .= ", Kadfec: ".$fecha;
						$datos .= ", Kadfin: ".$value['Kadfin'];
						$datos .= ", Kadhin: ".$value['Kadhin'];
						$datos .= ", Kadido: ".$value['Kadido'];
						$datos .= ", sql: ".str_replace( "'","\\'", $q );
						registrarAuditoriaCierreKardex( $historia, $ingreso, $usuario->codigo, "*".$descripcion."*".$datos );
					}
				}
				else{
					$descripcion = "Aticulo NO ENCONTRADO para eliminar en Temporal";
					$datos = "Kadhis: ".$historia;
					$datos .= ", Kading: ".$ingreso;
					$datos .= ", Kadart: ".$value['Kadart'];
					$datos .= ", Kadfec: ".$fecha;
					$datos .= ", Kadfin: ".$value['Kadfin'];
					$datos .= ", Kadhin: ".$value['Kadhin'];
					$datos .= ", Kadido: ".$value['Kadido'];
					$datos .= ", sql: ".str_replace( "'","\\'", $sql );
					registrarAuditoriaCierreKardex( $historia, $ingreso, $usuario->codigo, "*".$descripcion."*".$datos );
				}
			}
		}
	}
	/************************************************************************************************************************************/
	
	//Carga los articulos del la extensión del detalle del kardex a la temporal
	$sql = "INSERT INTO ".$wbasedato."_000208
				(Medico  , Fecha_data  , Hora_data  , Ekxhis, Ekxing, Ekxfec, Ekxart, Ekxido, Ekxest, Ekxpro, Ekxtra, Ekxped, Ekxin1, Ekxin2, Ekxayu, Ekxaut, Ekxjus, Ekxfau, Ekxhau, Ekxmau, Ekxjau, Seguridad  )
			SELECT
				 a.Medico, a.Fecha_data, a.Hora_data, Ekxhis, Ekxing, Ekxfec, Ekxart, Ekxido, Ekxest, Ekxpro, Ekxtra, Ekxped, Ekxin1, Ekxin2, Ekxayu, Ekxaut, Ekxjus, Ekxfau, Ekxhau, Ekxmau, Ekxjau, a.Seguridad
			FROM
				".$wbasedato."_000209 a, ".$wbasedato."_000054 b
			WHERE
				Ekxhis = '$historia'
				AND Ekxing = '$ingreso'
				AND Ekxfec = '$fecha'
				AND Kadhis = Ekxhis
				AND Kading = Ekxing
				AND Kadfec = Ekxfec
				AND Kadart = Ekxart
				AND Kadido = Ekxido 
				AND Kadido NOT IN(
							SELECT
								 c.Ekxido
							FROM
								".$wbasedato."_000208 c
							WHERE c.Ekxhis = a.Ekxhis
							  AND c.Ekxing = a.Ekxing
							  AND c.Ekxfec = a.Ekxfec
							  AND c.Ekxart = a.Ekxart
							  AND c.Ekxido = a.Ekxido
				)";
	
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	
	// if( mysql_affected_rows() > 0 ){
		
		$sql = "DELETE ".$wbasedato."_000209 FROM
					".$wbasedato."_000209, ".$wbasedato."_000054
				WHERE
					Ekxhis = '".$historia."'
					AND Ekxing = '".$ingreso."'
					AND Ekxfec = '".$fecha."'
					AND Kadhis = Ekxhis
					AND Kading = Ekxing
					AND Kadfec = Ekxfec
					AND Kadart = Ekxart
					AND Kadido = Ekxido ";
			
		$resDelEx = mysql_query( $sql, $conex ) or die( mysql_errno()."- Error en el query $sql - ".mysql_error() );
	// }
}
 
function cargarExamenesADefinitivo($historia,$ingreso,$fecha,$firmaDigital){
	global $wbasedato;
	global $conex;
	global $wbasedatohce;

	$q = "INSERT INTO ".$wbasedato."_000050
		   	(Medico,Fecha_data,hora_data,Ekahis,Ekaing,Ekacod,Ekaest,Ekafec,Ekaobs,Ekafes,Ekajus,Ekausu,Ekafir,seguridad)
		SELECT 
			 Medico,Fecha_data,hora_data,Ekahis,Ekaing,Ekacod,Ekaest,Ekafec,Ekaobs,Ekafes,Ekajus,Ekausu,Ekafir,seguridad
		FROM 
			".$wbasedato."_000061
		WHERE
			Ekahis = '$historia'
			AND Ekaing = '$ingreso'
			AND Ekafec = '$fecha'";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

	//Eliminar de la tabla temporal los registros anteriores
	$q = "DELETE FROM
			".$wbasedato."_000061
		WHERE
			Ekahis = '$historia'
			AND Ekaing = '$ingreso'
			AND Ekafec <= '$fecha'";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

	//HCE
	$numIns = mysql_affected_rows();
	if($numIns > 0 && $firmaDigital != ''){
		$q = "UPDATE
				".$wbasedatohce."_000027
			SET 
				Ordfir = '$firmaDigital'
			WHERE
				Ordhis = '$historia'
				AND Ording = '$ingreso'
				AND fecha_data = '$fecha'";

//		$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	}
}

function cargarInfusionesADefinitivo($historia,$ingreso,$fecha){
	global $wbasedato;
	global $conex;

	$q = "INSERT INTO ".$wbasedato."_000051
		   	(Medico,Fecha_data,hora_data,Inkhis,Inking,Inkcon,Inkdes,Inkfec,Inkobs,Inkfes,seguridad)
		SELECT 
			 Medico,Fecha_data,hora_data,Inkhis,Inking,Inkcon,Inkdes,Inkfec,Inkobs,Inkfes,seguridad 
		FROM 
			".$wbasedato."_000062
		WHERE 
			Inkhis = '$historia'
			AND Inking = '$ingreso'
			AND Inkfec = '$fecha'";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

	//Eliminar de la tabla temporal los registros anteriores
	$q = "DELETE FROM
			".$wbasedato."_000062
		WHERE 
			Inkhis = '$historia'
			AND Inking = '$ingreso'
			AND Inkfec <= '$fecha'";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
}

function cargarMedicoADefinitivo($historia,$ingreso,$fecha){
	global $wbasedato;
	global $conex;

	$q = "INSERT INTO ".$wbasedato."_000047
		   	(Medico,Fecha_data,hora_data,Mettdo,Metdoc,Methis,Meting,Metfek,Metest,Metint,Metesp,Metusu,Metfir,seguridad)
		SELECT 
			 Medico,Fecha_data,hora_data,Mettdo,Metdoc,Methis,Meting,Metfek,Metest,Metint,Metesp,Metusu,Metfir,seguridad
		FROM 
			".$wbasedato."_000063
		WHERE 
			Methis = '$historia'
			AND Meting = '$ingreso'
			AND Metfek = '$fecha'";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

	//Eliminar de la tabla temporal los registros anteriores
	$q = "DELETE FROM
			".$wbasedato."_000063
		WHERE 
			Methis = '$historia'
			AND Meting = '$ingreso'
			AND Metfek <= '$fecha'";

	$res = mysql_query($q, $conex) or die ("Error: ".mysql_errno()." - en el query: ".$q." - ".mysql_error());
}

function cargarDietasADefinitivo($historia,$ingreso,$fecha,$firma=''){
	global $wbasedato;
	global $conex;
	global $usuario;
	
	//actualizo firma
	if( $firma != '' ){
		$sql = "UPDATE
					{$wbasedato}_000064
				SET
					Dikfir = '$firma'
				WHERE
					Dikhis = '$historia'
					AND Diking = '$ingreso'
					AND Dikfec = '$fecha'
					AND Dikusu = '$usuario->codigo' 
				";
					
		$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
	}

	$q = "INSERT INTO ".$wbasedato."_000052
		   	(Medico,Fecha_data,hora_data,Dikcod,Dikhis,Diking,Dikfec,Dikest,Dikusu,Dikfir,Dikusp,Dikpen,Dikule,Dikfle,Dikhle,seguridad)
		SELECT 
			 Medico,Fecha_data,hora_data,Dikcod,Dikhis,Diking,Dikfec,Dikest,Dikusu,Dikfir,Dikusp,Dikpen,Dikule,Dikfle,Dikhle,seguridad
		FROM 
			".$wbasedato."_000064
		WHERE 
			Dikhis = '$historia'
			AND Diking = '$ingreso'
			AND Dikfec = '$fecha'";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

	//Eliminar de la tabla temporal los registros anteriores
	$q = "DELETE FROM
			".$wbasedato."_000064
		WHERE 
			Dikhis = '$historia'
			AND Diking = '$ingreso'
			AND Dikfec <= '$fecha'";

	$res = mysql_query($q, $conex) or die ("Error: ".mysql_errno()." - en el query: ".$q." - ".mysql_error());
}

function cargarEsquemaDextrometer($historia, $ingreso, $fechaAnterior, $fechaActual){
	global $wbasedato;
	global $conex;
	global $user;
	
	$usuario = consultarUsuarioOrdenes( substr( $user, 2 ) );

	$coleccion = array();

	//Infhis  Infing  Inffec  Infade  Inffde  Infcde
	$q = "SELECT
			Medico,Fecha_data,Hora_data,Infade,Inffde,Infcde,Seguridad
		FROM
			".$wbasedato."_000070
		WHERE 
			Infhis = '$historia'
			AND Infing = '$ingreso'
			AND Inffec = '$fechaActual'";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if ($num == 0)
	{
		//Infhis  Infing  Inffec  Infade  Inffde  Infcde
		$q = "SELECT
				Medico,Fecha_data,Hora_data,Infade,Inffde,Infcde,Seguridad
			FROM
				".$wbasedato."_000070
			WHERE 
				Infhis = '$historia'
				AND Infing = '$ingreso'
				AND Inffec = '$fechaAnterior'";


		$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
		$info = mysql_fetch_array($res);

		//if($info['Infade'] != ''){ Todo lo que venga del dia anterior para el dia siguiente.
		
			$penUsu = $usuario->codigo;
			$penPen = 'on';
			$penUsu = "";
			$penFecha = "0000-00-00";
			$penHora = "00:00:00";
			
			// if( !$usuario->esEnfermeraRolHCE ){
			if( !permiteLecturaOrdenesPendientes( $conex, "01", $usuario->codigoRolHCE ) ){
			
				$penUsu = $usuario->codigo;
				$penPen = 'off';
				$penUsu = $usuario->codigo;
				$penFecha = date( "Y-m-d" );
				$penHora = date( "H:i:s" );
			}
			
			if($info['Fecha_data']=="")
			{
				$info['Fecha_data']="0000-00-00";
			}
			
			if($info['Hora_data']=="")
			{
				$info['Hora_data']="00:00:00";
			}
		
			$q = "INSERT INTO ".$wbasedato."_000070
		   				(Medico,Fecha_data,Hora_data,Infhis,Infing,Inffec,Infade,Inffde,Infcde,Infusp,Infpen,Infule,Inffle,Infhle,Seguridad)
		   			VALUES
		   			   ('{$info['Medico']}','{$info['Fecha_data']}','{$info['Hora_data']}','{$historia}','{$ingreso}','{$fechaActual}','{$info['Infade']}','{$info['Inffde']}','{$info['Infcde']}','$penUsu','$penPen','$penUsu','$penFecha','$penHora','{$info['Seguridad']}')";

			$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
		//}
	}

	//Carga de los intervalos dextrometer
	//Medico  Fecha_data  Hora_data  Indhis  Inding  Indfec  Indime  Indima  Inddos  Indudo  Indobs  Indvia  Seguridad
	$q = "SELECT
			Indhis,Inding,Indfec,Indime, Indest
		FROM
			".$wbasedato."_000071
		WHERE
			Indhis = '$historia'
			AND Inding = '$ingreso'
			AND Indfec = '$fechaActual'";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);
	$row = mysql_fetch_array($res);

	if($num == 0){
		$q = "INSERT INTO ".$wbasedato."_000071
			   	(Medico,Fecha_data,Hora_data,Indhis,Inding,Indfec,Indime,Indima,Inddos,Indudo,Indobs,Indvia,Indusu,Indfir,Seguridad)
			SELECT
				Medico,Fecha_data,Hora_data,Indhis,Inding,'{$fechaActual}',Indime,Indima,Inddos,Indudo,Indobs,Indvia,Indusu,Indfir,Seguridad
			FROM
				".$wbasedato."_000071
			WHERE
				Indhis = '$historia'
				AND Inding = '$ingreso'
				AND Indfec = '$fechaAnterior'
				AND Indime IS NOT NULL
				AND Indime != '' AND Indime != ' '
				AND Indest != 'off'";

		$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	}
}


/**
 * Consulta del listado de examenes anteriores por HCE
 * @param $historia
 * @param $ingreso
 * @param $fecha
 * @return unknown_type
 */
function consultarExamenesAnteriorHCE($historia,$ingreso,$fecha){
	global $wbasedato;
	global $conex;
	global $wbasedatohce;

	$coleccion = array();

	$q = "SELECT * FROM (
			SELECT 
			 Ordtor,Ordnro,Ordfec,Ordhor,Ordobs,Detcod,Detesi,Detfec,Detrdo,Detest,Detjus,Cconom,Descripcion,Ordusu,Detusu
		FROM 
			".$wbasedatohce."_000028, ".$wbasedatohce."_000017, ".$wbasedatohce."_000027 LEFT JOIN ".$wbasedato."_000011 ON Ordtor = Ccocod
		WHERE 
			Ordhis = '$historia'
			AND Ording = '$ingreso'
			AND Ordfec < '$fecha'
			AND Ordtor = Dettor
			AND Codigo = Detcod
			AND Detnro = Ordnro
		ORDER BY Ordfec,Cconom,Ordtor,Ordnro,Detfec) A,
		(
			SELECT 
				Ordfec,COUNT(*) cntDia 
			FROM 
				".$wbasedatohce."_000027 cnExa 
			WHERE 
				cnExa.Ordhis = Ordhis 
				AND cnExa.Ording = Ording 
				AND cnExa.Ordtor = Ordtor
				AND cnExa.Ordnro = Ordnro
				AND cnExa.Ordfec = Ordfec 
			GROUP BY Ordfec
		) B
		WHERE A.Ordfec = B.Ordfec";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if ($num > 0){
		$cont1 = 0;
		while ($cont1 < $num){
			$cont1++;

			$detalle = new ExamenHCEDTO();
				
			$info = mysql_fetch_array($res);
				
			$detalle->historia = @$historia;
			$detalle->ingreso = @$ingreso;
			$detalle->fecha = @$info['Ordfec'];
			$detalle->hora = @$info['Ordhor'];
			$detalle->tipoDeOrden = @$info['Ordtor'];
			$detalle->numeroDeOrden = @$info['Ordnro'];
			$detalle->observacionesOrden = @$info['Ordobs'];
			$detalle->estadoOrden = @$info['Ordesp'];
			$detalle->estadoRegistroOrden = @$info['Ordest'];
			$detalle->firmaOrden = @$info['Ordfir'];
			$detalle->fechaARealizar = @$info['Detfec'];			

			$detalle->nombreCentroCostos = @$info['Cconom'];
			
			if($detalle->tipoDeOrden == "H"){
				$detalle->nombreCentroCostos = "Hospitalario";
			}
			
			$detalle->nombreExamen = @$info['Descripcion'];

			$detalle->codigoExamen = @$info['Detcod'];
			$detalle->estadoExamen = @$info['Detesi'];
			$detalle->resultadoExamen = @$info['Detrdo'];
			$detalle->estadoRegistroExamen = @$info['Detest'];
			$detalle->justificacion = @$info['Detjus'];
			
			$detalle->creadorOrden = $info[ 'Ordusu' ];
			$detalle->creadorItem = $info[ 'Detusu' ];

			$coleccion[] = $detalle;
		}
	}
	return $coleccion;
}

function consultarInfusionesTemporalKardex($historia,$ingreso,$fecha) {
	global $wbasedato;
	global $conex;

	$coleccion = array();

	$q = "SELECT
			Id,Inkcon,Inkdes,Inkobs,Inkfes
		FROM
			".$wbasedato."_000062
		WHERE
			Inkhis = '$historia'
			AND Inking = '$ingreso'
			AND Inkfec = '$fecha'";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if ($num > 0)
	{
		$cont1 = 0;

		while ($cont1 < $num){
			$cont1++;

			$detalle = new RegistroGenericoDTO();

			$info = mysql_fetch_array($res);

			$detalle->codigo 		= $info['Inkcon'];
			$detalle->descripcion 	= $info['Inkdes'];
			$detalle->observacion 	= $info['Inkobs'];
			$detalle->fecha 		= $info['Inkfes'];

			$coleccion[] = $detalle;
		}
	}
	return $coleccion;
}

function consultarInfusionesDefinitivoKardex($historia,$ingreso,$fecha) {
	global $wbasedato;
	global $conex;

	$coleccion = array();

	$q = "SELECT
			Id,Inkcon,Inkdes,Inkobs,Inkfes
		FROM
			".$wbasedato."_000051
		WHERE
			Inkhis = '$historia'
			AND Inking = '$ingreso'
			AND Inkfec = '$fecha'";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if ($num > 0)
	{
		$cont1 = 0;

		while ($cont1 < $num){
			$cont1++;

			$detalle = new RegistroGenericoDTO();

			$info = mysql_fetch_array($res);

			$detalle->codigo 		= $info['Inkcon'];
			$detalle->descripcion 	= $info['Inkdes'];
			$detalle->observacion 	= $info['Inkobs'];
			$detalle->fecha 		= $info['Inkfes'];

			$coleccion[] = $detalle;
		}
	}
	return $coleccion;
}

function consultarComponentesPorCodigo($wbasedato,$codigo,$tipoMedicamento,$unidadMedida){
	$conexion = obtenerConexionBD("matrix");

	global $codigoServicioFarmaceutico;

	$q = "SELECT
				artcod, artcom, artuni, unides, '$codigoServicioFarmaceutico' origen
			FROM
				".$wbasedato."_000026, ".$wbasedato."_000027
			WHERE
				artuni = unicod
				AND artcod LIKE '%".$codigo."%'
				AND Artuni LIKE '$unidadMedida'
				AND artest = 'on'
				AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN (SELECT Melgru FROM {$wbasedato}_000066 WHERE Melest = 'on' AND Meltip = 'L')
			ORDER BY Artcom
			LIMIT 100
		";

	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$cont1 = 0;
	$consulta = "";

	if($num > 0){
		while ($cont1 < $num)
		{
			$rs = mysql_fetch_array($res);

			$referencia = "seleccionarComponente('".$rs['artcod']."','".str_replace(" ","_",htmlentities(trim($rs[1])))."');";
			$consulta = $consulta." * <a href='#null' onClick=$referencia>".htmlentities(trim($rs[1])).'</a><br/>';
			$cont1++;
		}
	} else {
		$consulta = $consulta."<b>No se encontraron coincidencias</b>";
	}

	liberarConexionBD($conexion);

	return $consulta;
}

function consultarAlergiasDiagnosticosAnteriores($historia,&$alergiasAnteriores,&$diagnosticosAnteriores){
	global $wbasedato;
	global $conex;

	$q = "SELECT
			Fecha_data, Karhis, Karing, Karale, Kardia
		FROM
			".$wbasedato."_000053
		WHERE
			Karhis = '$historia'
		ORDER BY
			Fecha_data DESC";

	$aleAnt = "";
	$diagAnt = "";

	$acumuladorAlergias = "";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if ($num > 0)
	{
		$cont1 = 0;

		while ($cont1 < $num){
			$cont1++;

			$info = mysql_fetch_array($res);

			if(isset($info['Karale']) && !empty($info['Karale'])){
				$pos = strpos($acumuladorAlergias, "'".$info['Karale']."'");
				if($pos===false){
					$acumuladorAlergias .= "'".$info['Karale']."'";
					$alergiasAnteriores .= "-".$info['Karale']."\n";
				}
			}

			if(isset($info['Kardia']) && $info['Kardia'] != "" && $diagAnt != $info['Kardia']){
				$diagnosticosAnteriores .= "-".$info['Kardia']." \n";
			}

			$aleAnt = $info['Karale'];
			$diagAnt = $info['Kardia'];
		}
	}
}

/*
 * AJAX::Consulta medicamentos por codigo
 */
//function consultarMedicamentosPorCodigo($wbasedato,$codigo,$tipoMedicamento,$unidadMedida,$centroCostos,$gruposMedicamentos,$tipoProtocolo){
function consultarMedicamentosPorCodigo($wbasedato,$codigo,$tipoMedicamento,$unidadMedida,$centroCostos,$gruposMedicamentos,$tipoProtocolo, $ccoPaciente = ''){
	global $conex;

	$coleccion = array();
	$consulta = "";

	global $centroCostosServicioFarmaceutico;
	global $codigoServicioFarmaceutico;
	global $codigoCentralMezclas;
	global $centroCostosCentralMezclas;

	$esSF = $centroCostos == $centroCostosServicioFarmaceutico ? true : false;
	$esCM = $centroCostos == $centroCostosCentralMezclas ? true : false;

	$codigo = str_replace("-","%",$codigo);

	//*******************************Grupos que puede ver el centro de costos del usuario
	$tieneGruposIncluidos = false;
	$gruposIncluidos = "(";

	$q6 = "SELECT DISTINCT Ccogka FROM {$wbasedato}_000011 WHERE Ccoest='on' AND Ccogka != '*' AND Ccocod='$centroCostos';";
	$res6 = mysql_query($q6, $conex);

	while($rs6 = mysql_fetch_array($res6)){
		$tieneGruposIncluidos = true;
		if(strpos($rs6['Ccogka'],$gruposIncluidos) === false){
			$gruposIncluidos .= "'".str_replace(",","','",$rs6['Ccogka'])."',";
		}
	}
	$gruposIncluidos .= "'')";
	//********************************

	//Preproceso de los grupos de medicamentos.  De formato X00,Y00,Z00... a 'X00','Y00','Z00'
	$criterioGrupo = "";

	$vecGruposMedicamentos = explode(",",$gruposMedicamentos);

	$cont2 = 0;
	while($cont2 < count($vecGruposMedicamentos)){
		$criterioGrupo .= "'".$vecGruposMedicamentos[$cont2]."',";
		$cont2++;
	}
	$criterioGrupo .= "''";

	switch ($tipoProtocolo) {
		case 'A';
		case 'U';
		case 'Q':
			//Para cualquier servicio
			$q = "SELECT "
			."		Artcod, Artcom, Artuni, Unides, '$codigoServicioFarmaceutico' origen, SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru, Artfar, Artpos, Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia "
			."	FROM "
			."		{$wbasedato}_000068, {$wbasedato}_000026, {$wbasedato}_000059, {$wbasedato}_000027 "
			."	WHERE "
			."		Arktip = '$tipoProtocolo' "
			."		AND Arkest = 'on' "
			."		AND Arkcco = '$centroCostosServicioFarmaceutico' "
			."		AND Arkcod = Artcod "
			."		AND Artuni LIKE '$unidadMedida' "
			."		AND Artest = 'on' "
			."		AND Artuni = Unicod "
			."		AND artcod LIKE '%".$codigo."%' "
			."		AND Defart = Arkcod "
			."		AND Defest = 'on' ";
					if($tieneGruposIncluidos){
						$q .= " AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN $gruposIncluidos ";
					}
					$q .= " AND Defcco = Arkcco ";
					if($gruposMedicamentos != "*"){
						$q = $q."AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN (SELECT Melgru FROM {$wbasedato}_000066 WHERE Melest = 'on' AND Meltip = 'M' AND Melgru IN ($criterioGrupo)) ";
					} else {
						$q = $q."AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN (SELECT Melgru FROM {$wbasedato}_000066 WHERE Melest = 'on' AND Meltip = 'M') ";
					}

				$subConsulta = "SELECT "
							."	Artcod, Artcom, Artuni, Unides, '$codigoCentralMezclas' origen, '' Artgru, '00' Artfar, '' Artpos, Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia "
							." FROM "
							."	{$wbasedato}_000068, cenpro_000002, {$wbasedato}_000059, {$wbasedato}_000027 "
							." WHERE "
							."	artuni = unicod "
							."	AND Arktip = '$tipoProtocolo' "
							."	AND Arkest = 'on' "
							."	AND Defart = Arkcod "
							."	AND Arkcco = Defcco "
							."	AND Artuni = Unicod "
							."	AND artcod LIKE '%".$codigo."%' "
							."	AND Artuni LIKE '$unidadMedida' "
							."	AND Defest = 'on' "
							."	AND Defcco = '$centroCostosCentralMezclas' "
							."	AND artest = 'on' "
							."	AND Defart = Artcod";


				/****
				 * Si es usuario de central de mezclas SOLO se le permitirá ver lo de la central
				 */
				if($esCM){
					$q = $subConsulta;
				} else {
					if(!$tieneGruposIncluidos){
						$q = $q." UNION ".$subConsulta;
					}
				}
				$q = $q." LIMIT 100";
			break;
		case 'N':
			//Si el usuario no pertenece a SF ni a CM se consultan todos
			$q = "SELECT "
			."	Artcod, Artcom, Artuni, Unides, '$codigoServicioFarmaceutico' origen, SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru, IFNULL(Artfar,'00') Artfar, Artpos, Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia "
			." FROM "
			."	{$wbasedato}_000027, {$wbasedato}_000026, {$wbasedato}_000059 "
			." WHERE "
			."	artuni = unicod "
			."	AND artcod LIKE '%".$codigo."%' "
			."	AND Artuni LIKE '$unidadMedida' "
			."	AND artcod = Defart "
			."	AND artest = 'on' "
			."	AND Defest = 'on' ";
				if($tieneGruposIncluidos){
					$q .= " AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN $gruposIncluidos ";
				}
				$q .= " AND Artcod NOT IN (SELECT Arkcod FROM {$wbasedato}_000068 WHERE Arkcod = Artcod AND Arkest = 'on' AND Arktip != 'I' AND Arktip != 'T' AND Arktip != 'N') "
			."	AND Defcco = '$centroCostosServicioFarmaceutico' ";
			if($gruposMedicamentos != "*"){
				$q = $q."AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN (SELECT Melgru FROM {$wbasedato}_000066 WHERE Melest = 'on' AND Meltip = 'M' AND Melgru IN ($criterioGrupo))";
			} else {
				$q = $q."AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN (SELECT Melgru FROM {$wbasedato}_000066 WHERE Melest = 'on' AND Meltip = 'M')";
			}

			$subConsulta = "SELECT "
						   ."		Artcod, Artcom, Artuni, Unides, '$codigoCentralMezclas' origen, '' Artgru, '00' Artfar, '' Artpos, Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia "
						   ."	FROM "
							."	{$wbasedato}_000027, cenpro_000002, {$wbasedato}_000059 "
							." WHERE "
							."	artuni = unicod "
							."	AND artcod LIKE '%".$codigo."%' "
							."	AND Artuni LIKE '$unidadMedida' "
							."	AND artcod = Defart "
							."	AND artest = 'on' "
							."	AND Artcod NOT IN (SELECT Arkcod FROM {$wbasedato}_000068 WHERE Arkcod = Artcod AND Arkest = 'on' AND Arktip != 'I' AND Arktip != 'T' AND Arktip != 'N') "
							."	AND Defest = 'on' "
							."	AND Defcco = '$centroCostosCentralMezclas'";

			/****
			 * Si es usuario de central de mezclas SOLO se le permitirá ver lo de la central
			 */
			if($esCM){
				$q = $subConsulta;
			} else {
				if(!$tieneGruposIncluidos){
					$q = $q." UNION ".$subConsulta;
				}
			}

			$q = $q." LIMIT 100";

			break;
		default:
			$q = "SELECT "
				." Artcod, Artcom, Artuni, Unides, '$codigoServicioFarmaceutico' origen, SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru, IFNULL(Artfar,'00') Artfar, Artpos, Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia "
			." FROM "
				." {$wbasedato}_000027, {$wbasedato}_000026, {$wbasedato}_000059 "
			." WHERE "
			."	artuni = unicod "
			."	AND artcod LIKE '%".$codigo."%' "
			."	AND Artuni LIKE '$unidadMedida' "
			."	AND artcod = Defart "
			."	AND artest = 'on' "
			."	AND Defest = 'on' ";
				if($tieneGruposIncluidos){
					$q .= " AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN $gruposIncluidos ";
				}
				$q .= " AND Defcco = '$centroCostosServicioFarmaceutico' ";
			if($gruposMedicamentos != "*"){
				$q = $q."AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN (SELECT Melgru FROM {$wbasedato}_000066 WHERE Melest = 'on' AND Meltip = 'M' AND Melgru IN ($criterioGrupo)) ";
			} else {
				$q = $q."AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN (SELECT Melgru FROM {$wbasedato}_000066 WHERE Melest = 'on' AND Meltip = 'M') ";
			}

			$subConsulta = "SELECT "
							."	Artcod, Artcom, Artuni, Unides, '$codigoCentralMezclas' origen, '' Artgru, '00' Artfar, '' Artpos, Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia "
							." FROM "
								." {$wbasedato}_000027, cenpro_000002, {$wbasedato}_000059 "
							." WHERE "
							."  artuni = unicod "
							."	AND artcod LIKE '%".$codigo."%' "
							."	AND Artuni LIKE '$unidadMedida' "
							."	AND artcod = Defart "
							."	AND artest = 'on' "
							."	AND Defest = 'on' "
							."	AND Defcco = '$centroCostosCentralMezclas'";

			/****
			 * Si es usuario de central de mezclas SOLO se le permitirá ver lo de la central
			 */
			if($esCM){
				$q = $q." UNION ".$subConsulta;
			} else {
				if(!$tieneGruposIncluidos){
					$q = $q." UNION ".$subConsulta;
				}
			}
			$q = $q." LIMIT 100";
			break;
	}

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$cont1 = 0;

	if($num > 0){
		while ($cont1 < $num)
		{
			$puedeAgregar = true;

			$rs = mysql_fetch_array($res);
			$color = "red";

			$fftica = $rs['Artfar'];

			if($rs['origen'] == $codigoCentralMezclas){
				$color = "blue";
				$fftica = '00';
				if(!$esCM && !$esSF && substr(strtoupper($rs['Artcod']),0,1) == "J"){
					$puedeAgregar = false;
				}
			}

			if($puedeAgregar){
				
				$noEnviar = ( esStock( $conex, $wbasedato, $rs['Artcod'], $ccoPaciente ) == true )? 'on' : 'off';	//Abril 25 de 2011
				
				$referencia = "seleccionarMedicamento('".$rs['Artcod']."','".str_replace(" ","_",trim(htmlentities($rs[1])))."','".$rs['origen']."','".str_replace(" ","_",trim($rs['Artgru']))."','".str_replace(" ","_",trim($fftica))."','".str_replace(" ","_",trim($rs['Artuni']))."','".str_replace(" ","_",trim($rs['Artpos']))."','".str_replace(" ","_",trim($rs['Deffru']))."','".str_replace(" ","_",trim($rs['Deffra']))."','".str_replace(" ","_",trim($rs['Defven']))."','".str_replace(" ","_",trim($rs['Defdie']))."','".str_replace(" ","_",trim($rs['Defdis']))."','".str_replace(" ","_",trim($rs['Defdup']))."','".str_replace(" ","_",trim($rs['Defdim']))."','".str_replace(" ","_",trim($rs['Defdom']))."','".str_replace(" ","_",trim($rs['Defvia']))."','".$tipoProtocolo."','".$noEnviar."');";
				$consulta = $consulta."<font color=$color>*[".$rs['origen']."]<a href='#null' onclick=$referencia>".htmlentities($rs[1]).'</a></font><br/>';
			}

			$cont1++;
		}
	} else {
		$consulta = $consulta."<b>No se encontraron coincidencias</b>";
	}

	liberarConexionBD($conex);

	return $consulta;
}

function consultarComponentesPorNombre($wbasedato,$nombre,$tipoMedicamento,$unidadMedida){
	global $codigoServicioFarmaceutico;

	$conexion = obtenerConexionBD("matrix");

	if($tipoMedicamento == 'C'){
		$q = "SELECT
				artcod, artcom, artuni, unides, '$codigoServicioFarmaceutico' origen, Artfar
			FROM
				".$wbasedato."_000026, ".$wbasedato."_000027
			WHERE
				artuni = unicod
				AND artcom LIKE '%".$nombre."%'
				AND Artuni LIKE '$unidadMedida'
				AND artest = 'on'
				AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN (SELECT Melgru FROM {$wbasedato}_000066 WHERE Melest = 'on' AND Meltip = 'L')
			ORDER BY Artcom
			LIMIT 100
		";
	} else {
		$q = "SELECT
				artcod, artgen, artuni, unides, '$codigoServicioFarmaceutico' origen, Artfar
			FROM
				".$wbasedato."_000026, ".$wbasedato."_000027
			WHERE
				artuni = unicod
				AND artgen LIKE '%".$nombre."%'
				AND Artuni LIKE '$unidadMedida'
				AND artest = 'on'
				AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN ('E00')
			ORDER BY artgen
			LIMIT 100
		";
	}

	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$consulta = "";

	$cont1 = 0;

	if($num > 0){
		while ($cont1 < $num)
		{
			$rs = mysql_fetch_array($res);

			$referencia = "seleccionarComponente('".$rs['artcod']."','".str_replace(" ","_",htmlentities(trim($rs[1])))."');";
			$consulta = $consulta." * <a href='#null' onClick=$referencia>".htmlentities(trim($rs[1])).'</a><br/>';
			$cont1++;
		}
	} else {
		$consulta = $consulta."<b>No se encontraron coincidencias</b>";
	}

	liberarConexionBD($conexion);

	return $consulta;
}

/********************************************************************************************************
 * AJAX::Consulta medicamentos por nombre
 * 
 * Modificaciones
 * 
 * Abril 25 de 2011	Se agrega campo ccoPaciente
 ********************************************************************************************************/
//function consultarMedicamentosPorNombre($wbasedato,$nombre,$tipoMedicamento,$unidadMedida,$centroCostos,$gruposMedicamentos,$tipoProtocolo){
function consultarMedicamentosPorNombre($wbasedato,$nombre,$tipoMedicamento,$unidadMedida,$centroCostos,$gruposMedicamentos,$tipoProtocolo, $ccoPaciente = '' ){
	global $conex;

	global $centroCostosServicioFarmaceutico;
	global $codigoServicioFarmaceutico;
	global $codigoCentralMezclas;
	global $centroCostosCentralMezclas;

	$esSF = $centroCostos == $centroCostosServicioFarmaceutico ? true : false;
	$esCM = $centroCostos == $centroCostosCentralMezclas ? true : false;

	$nombre = str_replace("-","%",$nombre);

	//*******************************Grupos que puede ver el centro de costos del usuario
	$tieneGruposIncluidos = false;
	$gruposIncluidos = "(";

	$q6 = "SELECT DISTINCT Ccogka FROM {$wbasedato}_000011 WHERE Ccoest='on' AND Ccogka != '*' AND Ccocod='$centroCostos';";
	$res6 = mysql_query($q6, $conex);

	while($rs6 = mysql_fetch_array($res6)){
		$tieneGruposIncluidos = true;
		if(strpos($rs6['Ccogka'],$gruposIncluidos) === false){
			$gruposIncluidos .= "'".str_replace(",","','",$rs6['Ccogka'])."',";
		}
	}
	$gruposIncluidos .= "'')";
	//********************************

	//Preproceso de los grupos de medicamentos.  De formato X00,Y00,Z00... a 'X00','Y00','Z00'
	$criterioGrupo = "";

	$vecGruposMedicamentos = explode(",",$gruposMedicamentos);

	$cont2 = 0;
	while($cont2 < count($vecGruposMedicamentos)){
		$criterioGrupo .= "'".$vecGruposMedicamentos[$cont2]."',";
		$cont2++;
	}
	$criterioGrupo .= "''";

	/*De acuerdo al $tipoProtocolo tomo los articulos de las siguientes fuentes:
	 *
	 * N:  Normal, fuente maestro del servicio farmaceutico o de central de mezclas.
	 * A:  Analgesia, el articulo se agrega a los protocolos de analgesia (tipo especial de articulo A)
	 * U:  nUtricion, el articulo se agrega a los protocolos de nutricion (tipo especial de articulos U)
	 * Q:  Quimioterapia, el articulo se agrega a los protocolos de quimioterapia (tipo especial de articulos Q)
	 */
	switch ($tipoProtocolo) {
		case 'A';
		case 'U';
		case 'Q':
			$q = "SELECT
					Artcod, Artcom, Artuni, Unides, '$codigoServicioFarmaceutico' origen, SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru, Artfar, Artpos, Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia
				FROM
				{$wbasedato}_000068, {$wbasedato}_000026, {$wbasedato}_000059, {$wbasedato}_000027
				WHERE
					Arktip = '$tipoProtocolo'
					AND Arkest = 'on'
					AND Arkcco = '$centroCostosServicioFarmaceutico'
					AND Arkcod = Artcod ";
				if($tieneGruposIncluidos){
					$q .= " AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN $gruposIncluidos ";
				}
				$q .= " AND Artuni LIKE '$unidadMedida'
					AND Artest = 'on' ";
				if($tipoMedicamento == 'C'){
					$q = $q."AND artcom LIKE '%".$nombre."%' ";
				} else {
					$q = $q."AND artgen LIKE '%".$nombre."%' ";
				}
				$q = $q."AND Unicod = Artuni
					AND Defart = Arkcod
					AND Defest = 'on'
					AND Defcco = Arkcco ";
				if($gruposMedicamentos != "*"){
					$q = $q."AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN (SELECT Melgru FROM {$wbasedato}_000066 WHERE Melest = 'on' AND Meltip = 'M' AND Melgru IN ($criterioGrupo)) ";
				} else {
					$q = $q."AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN (SELECT Melgru FROM {$wbasedato}_000066 WHERE Melest = 'on' AND Meltip = 'M') ";
				}
					
				$subConsulta = "SELECT
								Artcod, Artcom, Artuni, Unides, '$codigoCentralMezclas' origen, '' Artgru, '00' Artfar, '' Artpos, Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia
							FROM
							{$wbasedato}_000068, cenpro_000002, {$wbasedato}_000059, {$wbasedato}_000027
							WHERE
								artuni = unicod
								AND Arktip = '$tipoProtocolo'
								AND Arkest = 'on'
								AND Defart = Arkcod
								AND Arkcco = Defcco
								AND Artgen LIKE '%".$nombre."%'
								AND Artuni LIKE '$unidadMedida'
								AND Defest = 'on'
								AND Defcco = '$centroCostosCentralMezclas'
								AND artest = 'on'
								AND Defart = Artcod	";
							/****
							 * Si es usuario de central de mezclas SOLO se le permitirá ver lo de la central
							 */
							if($esCM){
								$q = $subConsulta;
							} else {
								if(!$tieneGruposIncluidos){
									$q = $q." UNION ".$subConsulta;
								}
							}
							$q = $q."LIMIT 100";
							break;
		case 'N':
			if($tipoMedicamento == 'C'){
				$q = "SELECT
							Artcod, Artcom, Artuni, Unides, '$codigoServicioFarmaceutico' origen, SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru, IFNULL(Artfar,'00') Artfar, Artpos, Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia
						FROM
						{$wbasedato}_000026, {$wbasedato}_000059, {$wbasedato}_000027
						WHERE
							artuni = unicod
							AND artcom LIKE '%".$nombre."%'
							AND Artuni LIKE '$unidadMedida'
							AND Defest = 'on'
							AND Defcco = '$centroCostosServicioFarmaceutico'
							AND artest = 'on' ";
						if($tieneGruposIncluidos){
							$q .= " AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN $gruposIncluidos ";
						}
						$q .= " AND Artcod NOT IN (SELECT Arkcod FROM {$wbasedato}_000068 WHERE Arkcod = Artcod AND Arkest = 'on' AND Arktip != 'I')
							AND Defart = Artcod ";
						if($gruposMedicamentos != "*"){
							$q = $q."AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN (SELECT Melgru FROM {$wbasedato}_000066 WHERE Melest = 'on' AND Meltip = 'M' AND Melgru IN ($criterioGrupo)) ";
						} else {
							$q = $q."AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN (SELECT Melgru FROM {$wbasedato}_000066 WHERE Melest = 'on' AND Meltip = 'M') ";
						}
							
						$subConsulta = "SELECT
									Artcod, Artcom, Artuni, Unides, '$codigoCentralMezclas' origen, '' Artgru, '00' Artfar, '' Artpos, Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia
								FROM
									cenpro_000002, {$wbasedato}_000059, {$wbasedato}_000027
								WHERE
									artuni = unicod
									AND artcom LIKE '%".$nombre."%'
									AND Artuni LIKE '$unidadMedida'
									AND Defest = 'on'
									AND Artcod NOT IN (SELECT Arkcod FROM {$wbasedato}_000068 WHERE Arkcod = Artcod AND Arkest = 'on' AND Arktip != 'I')
									AND Defcco = '$centroCostosCentralMezclas'
									AND artest = 'on'
									AND Defart = Artcod";				

						/****
						 * Si es usuario de central de mezclas SOLO se le permitirá ver lo de la central
						 */
						if($esCM){
							$q = $subConsulta;
						} else {
							if(!$tieneGruposIncluidos){
								$q = $q." UNION ".$subConsulta;
							}
						}
						$q = $q. " LIMIT 100";
			} else {
				$q = "SELECT
							Artcod, Artgen, Artuni, Unides, '$codigoServicioFarmaceutico' origen, SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru, IFNULL(Artfar,'00') Artfar, Artpos, Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia
						FROM
						{$wbasedato}_000026, {$wbasedato}_000059, {$wbasedato}_000027
						WHERE
							artuni = unicod
							AND artgen LIKE '%".$nombre."%'
							AND Artuni LIKE '$unidadMedida'
							AND Defart = Artcod
							AND artest = 'on' ";
						if($tieneGruposIncluidos){
							$q .= " AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN $gruposIncluidos ";
						}
						$q .= " AND Artcod NOT IN (SELECT Arkcod FROM {$wbasedato}_000068 WHERE Arkcod = Artcod AND Arkest = 'on' AND Arktip != 'I')
							AND Defest = 'on'
							AND Defcco = '$centroCostosServicioFarmaceutico' ";
						if($gruposMedicamentos != "*"){
							$q = $q."AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN (SELECT Melgru FROM {$wbasedato}_000066 WHERE Melest = 'on' AND Meltip = 'M' AND Melgru IN ($criterioGrupo))";
						} else {
							$q = $q."AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN (SELECT Melgru FROM {$wbasedato}_000066 WHERE Melest = 'on' AND Meltip = 'M') ";
						}
							
						$subConsulta = "SELECT
									Artcod, Artcom, Artuni, Unides, '$codigoCentralMezclas' origen, '' Artgru, '00' Artfar, '' Artpos, Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia
								FROM
									cenpro_000002, {$wbasedato}_000059, {$wbasedato}_000027
								WHERE
									artuni = unicod
									AND artgen LIKE '%".$nombre."%'
									AND Artuni LIKE '$unidadMedida'
									AND Defest = 'on'
									AND Artcod NOT IN (SELECT Arkcod FROM {$wbasedato}_000068 WHERE Arkcod = Artcod AND Arkest = 'on' AND Arktip != 'I')
									AND Defcco = '$centroCostosCentralMezclas'
									AND artest = 'on'
									AND Defart = Artcod";
						/****
						 * Si es usuario de central de mezclas SOLO se le permitirá ver lo de la central
						 */
						if($esCM){
							$q = $subConsulta;
						} else {
							if(!$tieneGruposIncluidos){
								$q = $q." UNION ".$subConsulta;
							}
						}
						$q = $q. " LIMIT 100";
			}
			break;
		default:
			if($tipoMedicamento == 'C'){
				$q = "SELECT
					Artcod, Artcom, Artuni, Unides, '$codigoServicioFarmaceutico' origen, SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru, IFNULL(Artfar,'00') Artfar, Artpos, Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia
				FROM 
				{$wbasedato}_000026, {$wbasedato}_000059, {$wbasedato}_000027
				WHERE
					artuni = unicod 
					AND artcom LIKE '%".$nombre."%'
					AND Artuni LIKE '$unidadMedida'
					AND Defest = 'on' 
					AND Defcco = '$centroCostosServicioFarmaceutico'
					AND artest = 'on' ";
				if($tieneGruposIncluidos){
					$q .= " AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN $gruposIncluidos ";
				}
				$q .= " AND Defart = Artcod ";
				if($gruposMedicamentos != "*"){
					$q = $q."AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN (SELECT Melgru FROM {$wbasedato}_000066 WHERE Melest = 'on' AND Meltip = 'M' AND Melgru IN ($criterioGrupo)) ";
				} else {
					$q = $q."AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN (SELECT Melgru FROM {$wbasedato}_000066 WHERE Melest = 'on' AND Meltip = 'M') ";
				}

				$subConsulta = "SELECT
									Artcod, Artcom, Artuni, Unides, '$codigoCentralMezclas' origen, '' Artgru, '00' Artfar, '' Artpos, Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia
								FROM 
									cenpro_000002, {$wbasedato}_000059, {$wbasedato}_000027
								WHERE
									artuni = unicod 
									AND artcom LIKE '%".$nombre."%'
									AND Artuni LIKE '$unidadMedida'
									AND Defest = 'on' 
									AND Defcco = '$centroCostosCentralMezclas'
									AND artest = 'on'
									AND Defart = Artcod";

				/****
				 * Si es usuario de central de mezclas SOLO se le permitirá ver lo de la central
				 */
				if($esCM){
					$q = $subConsulta;
				} else {
					if(!$tieneGruposIncluidos){
						$q = $q." UNION ".$subConsulta;
					}
				}
				$q = $q. " LIMIT 100";
			} else {
				$q = "SELECT
				Artcod, Artgen, Artuni, Unides, '$codigoServicioFarmaceutico' origen, SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru, IFNULL(Artfar,'00') Artfar, Artpos, Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia
			FROM 
			{$wbasedato}_000026, {$wbasedato}_000059, {$wbasedato}_000027
			WHERE
				artuni = unicod 
				AND artgen LIKE '%".$nombre."%'
				AND Artuni LIKE '$unidadMedida'
				AND Defart = Artcod
				AND artest = 'on'
				AND Defest = 'on' ";
			if($tieneGruposIncluidos){
				$q .= " AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN $gruposIncluidos ";
			}
			$q .= " AND Defcco = '$centroCostosServicioFarmaceutico' ";
			if($gruposMedicamentos != "*"){
				$q = $q."AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN (SELECT Melgru FROM {$wbasedato}_000066 WHERE Melest = 'on' AND Meltip = 'M' AND Melgru IN ($criterioGrupo)) ";
			} else {
				$q = $q."AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN (SELECT Melgru FROM {$wbasedato}_000066 WHERE Melest = 'on' AND Meltip = 'M') ";
			}
				
			$subConsulta = "SELECT
								Artcod, Artcom, Artuni, Unides, '$codigoCentralMezclas' origen, '' Artgru, '00' Artfar, '' Artpos, Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia
							FROM 
								cenpro_000002, {$wbasedato}_000059, {$wbasedato}_000027
							WHERE
								artuni = unicod 
								AND artgen LIKE '%".$nombre."%'
								AND Artuni LIKE '$unidadMedida'
								AND Defest = 'on' 
								AND Defcco = '$centroCostosCentralMezclas'
								AND artest = 'on'
								AND Defart = Artcod"; 
			/****
			 * Si es usuario de central de mezclas SOLO se le permitirá ver lo de la central
			 */
			if($esCM){
				$q = $subConsulta;
			} else {
				if(!$tieneGruposIncluidos){
					$q = $q." UNION ".$subConsulta;
				}
			}
			$q = $q. " LIMIT 100";
			}
			break;
	}

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$consulta = "";

	$cont1 = 0;

	if($num > 0){
		while ($cont1 < $num)
		{
			$rs = mysql_fetch_array($res);
				
			$fftica = $rs['Artfar'];
				
			$color = "red";
			if($rs['origen'] == $codigoCentralMezclas){
				$color = "blue";
				$fftica = "00";
			}
			
			$noEnviar = ( esStock( $conex, $wbasedato, $rs['Artcod'], $ccoPaciente ) == true )? 'on' : 'off';	//Abril 25 de 2011
				
			$referencia = "seleccionarMedicamento('".$rs['Artcod']."','".str_replace(" ","_",trim(htmlentities($rs[1])))."','".$rs['origen']."','".str_replace(" ","_",trim($rs['Artgru']))."','".str_replace(" ","_",trim($fftica))."','".trim($rs['Artuni'])."','".str_replace(" ","_",trim($rs['Artpos']))."','".str_replace(" ","_",trim($rs['Deffru']))."','".str_replace(" ","_",trim($rs['Deffra']))."','".str_replace(" ","_",trim($rs['Defven']))."','".str_replace(" ","_",trim($rs['Defdie']))."','".str_replace(" ","_",trim($rs['Defdis']))."','".str_replace(" ","_",trim($rs['Defdup']))."','".str_replace(" ","_",trim($rs['Defdim']))."','".str_replace(" ","_",trim($rs['Defdom']))."','".str_replace(" ","_",trim($rs['Defvia']))."','".$tipoProtocolo."','".$noEnviar."');";
				
			$consulta = $consulta."<font color=$color>*[".$rs['origen']."]<a href='#null' onclick=$referencia>".htmlentities($rs[1]).'</a></font><br/>';
			$cont1++;
		}
	} else {
		$consulta = $consulta."<b>No se encontraron coincidencias</b>";
	}

	liberarConexionBD($conex);

	return $consulta;
}

function consultarHistorialCambiosKardex($historia,$ingreso,$fecha){
	global $wbasedato;
	global $conex;
	global $wemp_pmla;

	$whce = consultarAliasPorAplicacion( $conex, $wemp_pmla, "hce" );

	$coleccion = array();

	$q = "SELECT
			Fecha_data,Hora_data,Kaudes,Kaumen,SUBSTRING(Seguridad FROM INSTR(Seguridad,'-')+1) codigoUsuario, Descripcion
		FROM
			".$wbasedato."_000055, usuarios
		WHERE
			Kauhis = '$historia'
			AND Kauing = '$ingreso'
			AND ".$wbasedato."_000055.Fecha_data <= '$fecha'
			AND Codigo = SUBSTRING(Seguridad FROM INSTR(Seguridad,'-')+1)
		ORDER BY
			Fecha_data DESC, Hora_data DESC";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if ($num > 0)
	{
		$cont1 = 0;

		while ($cont1 < $num){
			$cont1++;

			$cambio = new cambioKardexDTO();

			$info = mysql_fetch_array($res);
			
			$sql = "SELECT Rolcod, Roldes
					  FROM {$whce}_000020, {$whce}_000019
					 WHERE usucod = '".$info['codigoUsuario']."'
					   AND usurol = rolcod
					 ";
			
			$resRol = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
			
			$codigoRolHce = '';
			$descripcionRolHCE = '';
			if( $rowRol = mysql_fetch_array($resRol) ){
				$codigoRolHce = $rowRol['Rolcod'];
				$descripcionRolHCE = $rowRol['Roldes'];
			}

			$cambio->historia = $historia;
			$cambio->ingreso = $ingreso;
			$cambio->fecha = $info['Fecha_data'];
			$cambio->hora = $info['Hora_data'];
			$cambio->descripcion = $info['Kaudes'];
			$cambio->mensaje = $info['Kaumen'];
			$cambio->usuario = $info['codigoUsuario']." - ".$info['Descripcion'];
			$cambio->codigoRolHce = $codigoRolHce;
			$cambio->descripcionRolHCE = $descripcionRolHCE;

			$coleccion[] = $cambio;
		}
	}
	return $coleccion;
}

function consultarArchivosDia($historia,$ingreso,$fecha){
	global $wbasedato;
	global $conex;

	$coleccion = array();

	$clave = obtenerMensaje("MSJ_ARCHIVO_CARGADO");

	$q = "SELECT
			Fecha_data,Hora_data,Kaudes
		FROM
			".$wbasedato."_000055
		WHERE
			Kauhis = '$historia'
			AND Kauing = '$ingreso'
			AND ".$wbasedato."_000055.Fecha_data = '$fecha'
			AND Kaumen = '$clave'";


	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if ($num > 0)
	{
		$cont1 = 0;

		while ($cont1 < $num){
			$cont1++;

			$cambio = new cambioKardexDTO();

			$info = mysql_fetch_array($res);

			$cambio->historia = $historia;
			$cambio->ingreso = $ingreso;
			$cambio->fecha = $info['Fecha_data'];
			$cambio->hora = $info['Hora_data'];
			$cambio->descripcion = $info['Kaudes'];

			$coleccion[] = $cambio;
		}
	}
	return $coleccion;
}

/**
 * AJAX: Insercion de medico tratante
 *
 * REGLAS:
 *
 * 1. Solamente se permite un medico responsable a la vez por ingreso un solo Mtrtra en on por ingreso
 * 2. Inicialmente el medico se asociará a través de la admision
 * 3. La asociacion/desasociacion se realiza a través de la marca Mtrest
 * 4. Los medicos asociados que no tengan Mtrtra en on SON TODOS interconsultantes
 *
 * @param unknown_type $wbasedato
 * @param unknown_type $tipoDocumento
 * @param unknown_type $numeroDocumento
 * @param unknown_type $historia
 * @param unknown_type $ingreso
 * @param unknown_type $usuario
 * @return unknown
 */
function insertarMedicoTratante($wbasedato,$tipoDocumento,$numeroDocumento,$historia,$ingreso,$usuario,$fecha,$idRegistro,$tratante,$codigoEspecialidad,$codigoMatrix){
	
	$conexion = obtenerConexionBD("matrix");
	$codigo = 1;

	//Selecciono el medico
	$q2 = "SELECT *
			 FROM ".$wbasedato."_000063
			WHERE Mettdo = '$tipoDocumento'
			  AND Metdoc = '$numeroDocumento'
			  AND Methis = '$historia'
			  AND Meting = '$ingreso'
			  AND Metesp = '$codigoEspecialidad'
			  AND Metest = 'on'";
	$res2 = mysql_query($q2, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());
	$num2 = mysql_num_rows($res2);

	if($num2 == 0){
		$q = "INSERT INTO ".$wbasedato."_000063 (
				Medico,Fecha_data,Hora_data,Mettdo,Metdoc,Methis,Meting,Metest,Metfek,Metint,Metesp,Seguridad ) VALUES
			('movhos','".date("Y-m-d")."','".date("H:i:s")."','".$tipoDocumento."','".$numeroDocumento."','".$historia."','".$ingreso."','on','$fecha','$tratante','$codigoEspecialidad','A-$codigoMatrix')";

		$audNuevo = "$tipoDocumento - $numeroDocumento";
		$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

		$auditoria = new AuditoriaDTO();

		$auditoria->historia = $historia;
		$auditoria->ingreso = $ingreso;
		$auditoria->descripcion = $audNuevo;
		$auditoria->fechaKardex = $fecha;
		$auditoria->mensaje = obtenerMensaje('MSJ_MEDICO_ASOCIADO');
		$auditoria->seguridad = $usuario;

		registrarAuditoriaKardex($conexion,$wbasedato,$auditoria);

		liberarConexionBD($conexion);
		$codigo = 2;
	}
	return $codigo;
	
	
	// $conexion = obtenerConexionBD("matrix");
	// $codigo = 1;
	// global $wbasedatohce;

	// $tieneMedicoResponsable = false;
	// $medicoExiste = false;
	// $medicoActivo = false;

	// $medicos = array();

	// //Consulta del medico por ingreso
	// $q = "SELECT
			// Mtrhis,Mtring,Mtrmed,Mtrest,Mtrtra
		// FROM 
			// ".$wbasedatohce."_000022
		// WHERE 
			// Mtrhis = '$historia'
			// AND Mtring = '$ingreso'";


	// $res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	// $num = mysql_num_rows($res);

	// //Medicos tratantes todos
	// while($rs = mysql_fetch_array($res)){
		// $medicos[$rs['Mtrmed']]['estado'] 	= $rs['Mtrest'];
		// $medicos[$rs['Mtrmed']]['tratante'] = $rs['Mtrtra'];

		// //El registro del medico se encuentra asociado previamente
		// if($codigoMatrix == $rs['Mtrmed']){
			// $medicoExiste = true;
				
			// if($rs['Mtrest'] == "on"){
				// $medicoActivo = true;
			// }
		// }

		// //Verificacion de existencia de responsable
		// if($rs['Mtrest'] == 'on' && $rs['Mtrtra'] == 'on'){
			// $tieneMedicoResponsable = true;
		// }
	// }

	// //	echo $medicoExiste ? "si existe":"no existe";
	// //	echo $tieneMedicoResponsable ? "si responsable":"no responsable";

	// /********
	 // * EVALUACION de todas las posibles combinaciones de medico tratante
	 // */
	// $caso = "";
	// if($medicoExiste){
		// if($medicoActivo){
			// if($tratante == "on"){
				// if(!$tieneMedicoResponsable){
					// $caso = "1";
				// }
			// } else {
				// $caso = "2";
			// }
		// } else {  //Medico inactivo
			// if($tratante == "on"){
				// if(!$tieneMedicoResponsable){
					// $caso = "5";
				// }
			// } else {
				// $caso ="4";
			// }
		// }
	// } else { // NO Existe medico
		// if($tratante == "on"){
			// if(!$tieneMedicoResponsable){
				// $caso = "3";
			// }
		// } else {
			// $caso = "3";
		// }
	// }
	// //	echo "Caso::::".$caso;

	// switch ($caso){
		// case '1':	//Medico tratante en on
			// $q = "UPDATE
					// ".$wbasedatohce."_000022
				// SET
					// Mtrtra = 'on'
				// WHERE 
					// Mtrhis = '$historia'
					// AND Mtring = '$ingreso'
					// AND Mtrmed = '$codigoMatrix'";
			// $codigo = 2;
			// break;
		// case '2':	//Ya existe un medico asociado
			// $q="";
			// $codigo = 1;
			// break;
		// case '3':	//Insertar medico
			// $q = "INSERT INTO ".$wbasedatohce."_000022(
				// Medico,Fecha_data,Hora_data,Mtrhis,Mtring,Mtrmed,Mtrest,Mtrtra,Seguridad) VALUES
			// ('movhos','".date("Y-m-d")."','".date("H:i:s")."','".$historia."','".$ingreso."','".$codigoMatrix."','on','$tratante','A-$usuario')";
				
			// $audNuevo = "$codigoMatrix";
			// $codigo = 2;
			// break;
		// case '4':	//Actualizar activo on y tratante off
			// $q = "UPDATE
					// ".$wbasedatohce."_000022
				// SET
					// Mtrtra = 'off',
					// Mtrest = 'on'
				// WHERE 
					// Mtrhis = '$historia'
					// AND Mtring = '$ingreso'
					// AND Mtrmed = '$codigoMatrix'";
			// $codigo = 2;
			// break;
		// case '5':	//Actualizar activo en on y tratante en on
			// $q = "UPDATE
					// ".$wbasedatohce."_000022
				// SET
					// Mtrtra = 'on',
					// Mtrest = 'on'
				// WHERE 
					// Mtrhis = '$historia'
					// AND Mtring = '$ingreso'
					// AND Mtrmed = '$codigoMatrix'";
			// $codigo = 2;
			// break;
		// default:
			// //No pueden haber dos medicos tratantes al tiempo
			// $codigo = 3;
			// break;
	// }

	// if($q != ""){
		// $res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	// }

	// //Selecciono el medico  Medico  Fecha_data  Hora_data  Mtrhis  Mtring  Mtrmed  Mtrest  Mtrtra  Seguridad
	// $num2 = mysql_affected_rows();

	// if($num2 == 0){
		// $auditoria = new AuditoriaDTO();

		// $auditoria->historia = $historia;
		// $auditoria->ingreso = $ingreso;
		// $auditoria->descripcion = $audNuevo;
		// $auditoria->fechaKardex = $fecha;
		// $auditoria->mensaje = obtenerMensaje('MSJ_MEDICO_ASOCIADO');
		// $auditoria->seguridad = $usuario;

		// registrarAuditoriaKardex($conexion,$wbasedato,$auditoria);

		// liberarConexionBD($conexion);
		// $codigo = 2;
	// }
	// return $codigo;
	
	
	
}

function limpiarString($texto)
{
      $textoLimpio = preg_replace('([^A-Za-z0-9\s])', '', $texto);	     					
      return $textoLimpio;
}

function grabarNuevoExamen($wemp_pmla,$basedatos,$nombre,$tipoServicio,$especialidad){
	global $conex;
	global $codigoAyudaHospitalaria;
	global $whce;
	global $user;
	
	list( $aaaa, $key ) = explode( "-", $user );

	$esHospitalario = "off";
	$consecutivo = "1";
	$auxConsecutivoAyudaHospitalaria = "1";

	$conExamenes = consultarAliasPorAplicacion($conex, $wemp_pmla, 'ConsecutivoExamenes');
	$conExamenes++;
	
	$nombre = trim($nombre); //Limpio de espacios adelante y atras el nombre nuevo del examen.
	$nombre = limpiarString($nombre);  //Se deja solo las letras, numeros y espacios en blanco.
	
	//Valido que el nombre no exista, con el tipo de orden seleccionada.
	$q = "SELECT a.Codigo, a.Tipoestudio, b.Descripcion
			FROM {$whce}_000047 a, {$whce}_000015 b
		   WHERE a.descripcion = '".$nombre."'
			 AND a.Estado = 'on'
			 AND tipoestudio = '".$tipoServicio."'
			 AND tipoestudio = b.codigo
		   UNION
		  SELECT a.Codigo, a.Tipoestudio, b.Descripcion
			FROM {$whce}_000017 a, {$whce}_000015 b
		   WHERE a.descripcion = '".$nombre."'
			 AND Nuevo = 'on'
			 AND a.Estado = 'on'
			 AND tipoestudio = '".$tipoServicio."'
			 AND tipoestudio = b.codigo";			
	$resExi = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$numExi = mysql_num_rows($resExi);
	
	if( $numExi == 0){


		//Valido que el nombre no exista, coan cualquirer tipo de servicio (tipo de ordene).
		$q1 = "SELECT a.Codigo, a.Tipoestudio, b.Descripcion
				FROM {$whce}_000047 a, {$whce}_000015 b
			   WHERE a.descripcion = '".$nombre."'
				 AND a.Estado = 'on'
				 AND tipoestudio = b.codigo
			   UNION
			  SELECT a.Codigo, a.Tipoestudio, b.Descripcion
				FROM {$whce}_000017 a, {$whce}_000015 b
			   WHERE a.descripcion = '".$nombre."'
				 AND Nuevo = 'on'
				 AND a.Estado = 'on'
				 AND tipoestudio = b.codigo";			
		$resExi1 = mysql_query($q1, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q1 . " - " . mysql_error());
		$numExi1 = mysql_num_rows($resExi1);
		
		if($numExi1 == 0){	
		
		// Se consulta si el consecutivo de examenes que nos da root_000051 no existe
		$q = "SELECT Codigo 
			    FROM ".$whce."_000017
			   WHERE Codigo = '".$conExamenes."'";
		$resMax = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
		$numMax = mysql_num_rows($resMax);
		
		// Si el consecutivo e examenes existe siga consultando hasta que encuentre uno que no exista
		if($numMax>0) 
		{
			do
			{
				$conExamenes++;
				$q = "SELECT
						Codigo 
					FROM
						".$whce."_000017
					WHERE
						Codigo = '".$conExamenes."'";
			
				$resMax = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
				$numMax = mysql_num_rows($resMax);

			} while( $numMax > 0);
		}

		// Consulto el servicio asociado a el tipo de estudio
		$q = "SELECT
				Servicio 
			FROM
				".$whce."_000017
			WHERE
				Tipoestudio = '".$tipoServicio."'
			AND Estado = 'on';";
			
		$q = "SELECT
				Tipser as Servicio 
			FROM
				".$whce."_000015
			WHERE
				Codigo = '".$tipoServicio."'
			AND Estado = 'on';";
		$resSer = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
		$numSer = mysql_num_rows($resSer);	
		$rowSer = mysql_fetch_array($resSer);
		
		// Defino datos a guardar
		$medico = 'hce'; 
		$fecha_data = date('Y-m-d');
		$hora_data = date('H:i:s');
		$codigo = $conExamenes;
		$descripcion = strtoupper( utf8_decode( $nombre ) );
		$tipoestudio = $tipoServicio;
		$servicio = $rowSer['Servicio'];
		$anatomia = '';
		$codcups = $conExamenes;
		$protocolo = '';
		$estado = 'on';
		$clase = '';
		$noPos = '';
		$nuevo = 'on';
		$seguridad = "C-$key";

		$q = "	INSERT INTO 
					".$whce."_000017
					(Medico,Fecha_data,Hora_data,Codigo,Descripcion,Servicio,Tipoestudio,Anatomia,Codcups,Protocolo,Estado,Clase,NoPos,Nuevo,Seguridad)	
				VALUES
					('$medico','$fecha_data','$hora_data','$codigo','$descripcion','$servicio','$tipoestudio','$anatomia','$codcups','$protocolo','$estado','$clase','$noPos','$nuevo','$seguridad')";
		$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
		
		$q = "	UPDATE 
					root_000051
				SET
					Detval = '".$conExamenes."'
				WHERE 
					Detemp = '".$wemp_pmla."'
				AND Detapl = 'ConsecutivoExamenes' ";
		$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
		
		}else
			{
			
			$rowsExi1 = mysql_fetch_array( $resExi1 );
		
			echo "000|El nombre de examen ya existe para ".$rowsExi1[ 'Descripcion' ].", debe seleccionarlo de la lista para ese tipo de orden.";
			return;
			
		}
	}
	else{
		
		$rowsExi = mysql_fetch_array( $resExi );
		
		echo "000|El nombre de examen ya existe para ".$rowsExi[ 'Descripcion' ].", debe seleccionarlo de la lista para ese tipo de orden.";
		return;
		
	}
	
	$q = "SELECT
			b.Codigo,b.Descripcion,Servicio,Tipoestudio,Anatomia,Codcups,b.Estado,Ccocor cons,a.Descripcion as Cconom, tiprju as reqJus, NoPos, Tipgoi
		FROM
			".$whce."_000015 a, ".$whce."_000017 b LEFT JOIN {$basedatos}_000011 c ON Ccocod = Servicio
		WHERE
			b.Estado = 'on'			
			AND b.Codigo = '$codigo'
			AND Tipoestudio LIKE '$tipoServicio'
			AND Tipoestudio = a.codigo
			AND Tipoestudio NOT IN (
				SELECT
					Toetip
				FROM
					{$whce}_000045
				WHERE
					Toeesp != '".$especialidad."' 
				AND Toeest = 'on'			
				)	
			AND nuevo = 'on'
		UNION
		SELECT
			b.Codigo,b.Descripcion,Servicio,Tipoestudio,Anatomia,Codcups,b.Estado,Ccocor cons,a.Descripcion as Cconom, tiprju as reqJus, NoPos, Tipgoi
		FROM
			".$whce."_000015 a, {$whce}_000047 b LEFT JOIN {$basedatos}_000011 c ON Ccocod = Servicio
		WHERE
			b.Estado = 'on'			
			AND b.Codigo = '$codigo'
			AND Tipoestudio LIKE '$tipoServicio'
			AND Tipoestudio = a.codigo
			AND Tipoestudio NOT IN (
				SELECT
					Toetip
				FROM
					{$whce}_000045
				WHERE
					Toeesp != '".$especialidad."' 
				AND Toeest = 'on'			
				)
			AND nuevo = 'off'
			;";
	
	
	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	//Consecutivo de ayudas hospitalarias
	//NO QUEMAR EL NRO EMPRESA
	$q2 = "SELECT
				Detval 
			FROM 
				root_000051
			WHERE
				Detemp = '$wemp_pmla'			
				AND Detapl = 'consecutivoAyudasHospitalarias';";

	$res2 = mysql_query($q2, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());
	$num2 = mysql_num_rows($res2);

	if($rs2 = mysql_fetch_array($res2)){
		$consecutivo = $rs2['Detval'];
		$auxConsecutivoAyudaHospitalaria = $rs2['Detval']; 
	}

	while ($rs = mysql_fetch_array($res)){
		//		$referencia = "seleccionarAyudaDiagnostica('".$rs['Servicio']."','".$rs['Codigo']."','".str_replace(" ","_",trim(htmlentities($rs['Descripcion'])))."','".str_replace(" ","_",trim(htmlentities($rs['Tipoestudio'])))."','".str_replace(" ","_",trim(htmlentities($rs['Anatomia'])))."','".str_replace(" ","_",trim(htmlentities($rs['Codcups'])))."','".str_replace(" ","_",trim(htmlentities($rs['cons'])))."','".str_replace(" ","_",trim(htmlentities($rs['Cconom'])))."');";
		//		$consulta = $consulta."<a href='#null' onclick=$referencia>".htmlentities($rs['Descripcion']).'</a><br/>';

		// if(!empty($rs['Servicio']) && $rs['Servicio'] == $codigoAyudaHospitalaria){
		if(!empty($rs['Tipoestudio']) && $rs['Tipoestudio'] == $codigoAyudaHospitalaria){
			$esHospitalario = "on";
			$consecutivo = $auxConsecutivoAyudaHospitalaria;
		} else {
			$consecutivo = @$rs['cons']+1;
		}
		
		if( empty( $rs['reqJus'] ) ){
			$rs['reqJus'] = "off";
		}

		// echo htmlentities(@$rs['Descripcion'])."|".@$rs['Servicio']."|".@$rs['Codigo']."|".str_replace(" ","_",trim(htmlentities(@$rs['Descripcion'])))."|".str_replace(" ","_",trim(htmlentities(@$rs['Tipoestudio'])))."|".str_replace(" ","_",trim(htmlentities(@$rs['Anatomia'])))."|".str_replace(" ","_",trim(htmlentities(@$rs['Codcups'])))."|".@$consecutivo."|".str_replace(" ","_",trim(htmlentities(@$rs['Cconom'])))."|".@$esHospitalario."|".@$rs['reqJus']."|".@$rs['NoPos']."\n";
		echo utf8_encode( (@($rs['Descripcion']) )."|".str_replace(" ","_",trim(htmlentities(@$rs['Tipoestudio'])))."|".@$rs['Codigo']."|".str_replace(" ","_",(trim(@$rs['Descripcion'])) )."|".str_replace(" ","_",trim(htmlentities(@$rs['Tipoestudio'])))."|".str_replace(" ","_",trim(htmlentities(@$rs['Anatomia'])))."|".str_replace(" ","_",trim(htmlentities(@$rs['Codcups'])))."|".@$consecutivo."|".str_replace(" ","_",trim(htmlentities(@$rs['Cconom'])))."|".@$esHospitalario."|".@$rs['reqJus']."|".@$rs['NoPos']."|".@$rs['Tipgoi']."|\n");
	}
	//	return $consulta;
}

/***
 * función que verifica si tiene oferta para realizar examen
 * Si el tipo de orden no está configurado para realizar examen se dejar ordenar(tiene oferta)
 * Si el tipo de orden está configurado para realizar examen y el examen (cup) no está ofertado no se puede ordenar(no tiene oferta)
 * Si el tipo de orden está configurado para realizar examen y el examen (cup) está ofertado se deja ordenar(tiene oferta)
 */
function tieneOfertaAyudaDx($wemp_pmla, $conex, $whce, $tipoOrden, $cup, $cco )
{
	$val = [
				'result' 			=> true, 
				'datosAdicionales' 	=> [], 
				'esOfertado' 		=> false,
				'realizaUnidad'		=> false,	//Indica si debe mostrar al médico una modal preguntando si el estudio lo realiza la unidad en que se encuentra el paciente o no
			];
	
	$wcliame = consultarAliasPorAplicacion( $conexion, $wemp_pmla, "cliame" );	
	$wmovhos = consultarAliasPorAplicacion( $conexion, $wemp_pmla, "movhos" );	
	
	//Consulto si existe cups ofertados por tipo de orden
	$sql = "SELECT Valtoc, Valcoc, Valeoc, Valerl
					  FROM ".$wmovhos."_000267
					 WHERE valtor = '".$tipoOrden."'
					   AND valest = 'on'
				  GROUP BY 1,2,3, 4";
	
	$resToOfertado 	= mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
	$num 			= mysql_num_rows($resToOfertado);
	
	if( $rowsToOfertado 	= mysql_fetch_array( $resToOfertado ) ){
		$tablaOfertas 		= $rowsToOfertado['Valtoc'];
		$campoOferta		= $rowsToOfertado['Valcoc'];
		$campoEstado		= $rowsToOfertado['Valeoc'];
		$campoRealizaUnidad	= trim( $rowsToOfertado['Valerl'] );
		
		if( $campoRealizaUnidad == 'NO APLICA' || $campoRealizaUnidad == '.' ){
			$campoRealizaUnidad = '';
		}
	}
	
	//Si el tipo de orden está configurado para ofertas se revisa si el cup está ofertado
	if( $num > 0 ){
		
		// $ofertasActivas 		= consultarAliasPorAplicacion( $conexion, $wemp_pmla, "ofertasActivas" );
		// $ofertasActivasPorOrden = explode(",", $ofertasActivas );
		
		// $tipoOrdenOfertado = in_array( $tipoOrden, $ofertasActivasPorOrden );
		
		$estadoPorTipoOrden = tieneCcoInteroperabilidadLaboratorio( $conex, $wmovhos, $cco );
		$permiteModEst = in_array( $tipoOrden, $estadoPorTipoOrden ) ? true : false;
		
		$muestraDesactivaPorOrden 		= consultarAliasPorAplicacion( $conexion, $wemp_pmla, "desactivarMuestrasPorTipoOrden" );
		$arrayMuestraDesactivaPorOrden = explode(",", $muestraDesactivaPorOrden );
		
		$muestraDesactiva = in_array( $tipoOrden, $arrayMuestraDesactivaPorOrden );
		
		if( !$muestraDesactiva && !$permiteModEst ){
			$muestraDesactiva = true;
		}
		
		// if( !$tipoOrdenOfertado )
		if( true )
		{
			$sql = "SELECT *
					  FROM ".$tablaOfertas."
					 WHERE ".$campoOferta." = '".$cup."'
					   AND ".$campoEstado." = 'on'";
			
			$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
			$num = mysql_num_rows($res);
			
			//Si el cup está ofertado se revisa si necesita datos adicionales
			if( $num > 0 ){
				
				$val['esOfertado'] 		= true;
				
				$rowCupOfertado = mysql_fetch_array( $res );
				$nroMuestras 	= !empty( $rowCupOfertado['Pronro'] ) ? $rowCupOfertado['Pronro'] : 0;
				
				if( $campoRealizaUnidad != '' && isset( $rowCupOfertado[ $campoRealizaUnidad ] ) )
					if( $rowCupOfertado[ $campoRealizaUnidad ] == 'on' )
						$val['realizaUnidad'] 	= true;
				
				$sql = "SELECT Medico, Fecha_data, Hora_data, Valtor, Valtab, Valccu, Valcam, Valdca, Valmen, Valord, Valest, Seguridad
						  FROM ".$wmovhos."_000267
						 WHERE valtor = '".$tipoOrden."'
						   AND valest = 'on'
						   AND Valtab != ''
						   AND Valccu != ''
						   AND Valcam != ''
						   AND Valdca != ''
						   AND Valmen != ''
					  ORDER BY valord ASC";
				
				$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
				$num = mysql_num_rows($res);
				
				if( !$muestraDesactiva && $num > 0 ){
					
					while( $rows = mysql_fetch_array( $res ) ){
						
						//Debe ser la misma tabla
						$tabla = $rows['Valtab'];
						
						//Como es la misma tabla el campo de cup es el mismo
						$campocup = $rows['Valccu'];
						
						//Los campos
						$campos[] = [ 
										'codigo' 	  => $rows['Valcam'], 
										'descripcion' => $rows['Valdca'], 
										'mensaje' 	  => $rows['Valmen'],
									];
									
						$orderByCampos[] = $rows['Valdca'];
						
					}

					//Consulto los datos adicionales
					$sql = "SELECT * 
							  FROM ".$tabla." tb1
							 WHERE tb1.".$campocup." = '".$cup."'
						  ORDER BY ".implode( ",", $orderByCampos );
							 
					$res = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
					$num = mysql_num_rows($res);
					
					$datosAdicionales = [];
					
					while( $rows = mysql_fetch_array( $res ) ){
						$da = &$datosAdicionales;
						
						foreach( $campos as $campo ){
							if( !isset( $da[ $campo['mensaje'] ] ) ){
								$da[ $campo['mensaje'] ] = [];
							}
							
							$valAdd = [ 
										'codigo' 		=> $rows[ $campo[ 'codigo' ] ],
										'descripcion' 	=> $rows[ $campo[ 'descripcion' ] ],
									 ];
							
							$clave = false;
							foreach( $da[ $campo['mensaje'] ] as $key => $value ){
								
								$comparar = [ 
												'codigo' 		=> $value[ 'codigo' ],
												'descripcion' 	=> $value[ 'descripcion' ],
											 ];
								
								if( $comparar == $valAdd ){
									$clave = $key;
									break;
								}
							}
							
							if( $clave === false ){
								$da[ $campo['mensaje'] ][] = $valAdd;
								$clave = count( $da[ $campo['mensaje'] ] )-1;
							}
							
							$da = &$da[ $campo['mensaje'] ][ $clave ];
						}
					}
					
					// echo "<pre>"; var_dump( $datosAdicionales ); echo "</pre>";
					// echo json_encode( $datosAdicionales );
					$val['datosAdicionales'] = $datosAdicionales;
				}
				
				$val['datosAdicionales']['nroMuestras'] = $nroMuestras;
			}
			// else{
				// //Si el examen (cup )no está ofertado no se deja ordenar
				// $val['result'] = false;
			// }
		}
		
	}
	
	$val['result'] = true; //Todas las ordenes siempre se deben poder ordenar, siempre está ofertado
	
	return $val;
}


function consultarAyudasDiagnosticasPorNombre($basedatos,$nombre,$unidadRealiza, $cco, $tipoServicio = '%' ){
	global $conex;
	global $codigoAyudaHospitalaria;
	global $whce;
	global $wemp_pmla;

	$esHospitalario = "off";
	$consecutivo = "1";
	$auxConsecutivoAyudaHospitalaria = "1";	
	
	$q = "SELECT a.Codigo,a.Descripcion,Tipoestudio as Servicio,Tipoestudio,Anatomia,Codcups,a.Estado,Ccocor cons,c.Descripcion as Cconom, tiprju as reqJus, NoPos, Tipgoi as Tipgoi 
			FROM {$whce}_000047 a LEFT JOIN {$basedatos}_000011 b ON Ccocod = Servicio, {$whce}_000015 c
		   WHERE a.Estado = 'on'			
			 AND Servicio LIKE '%$unidadRealiza%'
			 AND ( a.Descripcion LIKE '%$nombre%' OR Codcups = '$nombre' )
			 AND Tipoestudio LIKE '$tipoServicio'
			 AND Tipoestudio = c.codigo
		   UNION
		  SELECT a.Codigo,a.Descripcion,Tipoestudio as Servicio,Tipoestudio,Anatomia,Codcups,a.Estado,Ccocor cons,c.Descripcion as Cconom, tiprju as reqJus, NoPos, Tipgoi as Tipgoi 
			FROM {$whce}_000017 a LEFT JOIN {$basedatos}_000011 b ON Ccocod = Servicio, {$whce}_000015 c
		   WHERE a.Estado = 'on'			
			 AND Servicio LIKE '%$unidadRealiza%'
			 AND ( a.Descripcion LIKE '%$nombre%' OR Codcups = '$nombre' )
			 AND Tipoestudio LIKE '$tipoServicio'
			 AND Tipoestudio = c.codigo 	
			 AND Nuevo = 'on' ";	
	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	//Consecutivo de ayudas hospitalarias
	//NO QUEMAR EL NRO EMPRESA
	$q2 = "SELECT
				Detval 
			FROM 
				root_000051
			WHERE
				Detemp = '".$wemp_pmla."'			
				AND Detapl = 'consecutivoAyudasHospitalarias';";

	$res2 = mysql_query($q2, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());
	$num2 = mysql_num_rows($res2);

	if($rs2 = mysql_fetch_array($res2)){
		$consecutivo = $rs2['Detval'];
		$auxConsecutivoAyudaHospitalaria = $rs2['Detval']; 
	}

	while ($rs = mysql_fetch_array($res)){
		//		$referencia = "seleccionarAyudaDiagnostica('".$rs['Servicio']."','".$rs['Codigo']."','".str_replace(" ","_",trim(htmlentities($rs['Descripcion'])))."','".str_replace(" ","_",trim(htmlentities($rs['Tipoestudio'])))."','".str_replace(" ","_",trim(htmlentities($rs['Anatomia'])))."','".str_replace(" ","_",trim(htmlentities($rs['Codcups'])))."','".str_replace(" ","_",trim(htmlentities($rs['cons'])))."','".str_replace(" ","_",trim(htmlentities($rs['Cconom'])))."');";
		//		$consulta = $consulta."<a href='#null' onclick=$referencia>".htmlentities($rs['Descripcion']).'</a><br/>';
		
		//Se revisa si el examen tiene oferta, si no tiene oferta no se deja ordenar
		$tieneOferta = tieneOfertaAyudaDx( $wemp_pmla, $conex, $whce, $rs['Tipoestudio'], $rs['Codcups'], $cco );
		if( !$tieneOferta['result'] )
			continue;

		if(!empty($rs['Servicio']) && $rs['Servicio'] == $codigoAyudaHospitalaria){
			$esHospitalario = "on";
			$consecutivo = $auxConsecutivoAyudaHospitalaria;
		} else {
			$consecutivo = @$rs['cons']+1;
		}
		
		if( empty( $rs['reqJus'] ) ){
			$rs['reqJus'] = "off";
		}
		
		// $rs['Descripcion'] = htmlentities( utf8_encode($rs['Descripcion']) );
		
		echo (@$rs['Descripcion'])."|".@$rs['Servicio']."|".@$rs['Codigo']."|".str_replace(" ","_",trim(@$rs['Descripcion']))."|".str_replace(" ","_",trim(htmlentities(@$rs['Tipoestudio'])))."|".str_replace(" ","_",trim(htmlentities(@$rs['Anatomia'])))."|".str_replace(" ","_",trim(htmlentities(@$rs['Codcups'])))."|".@$consecutivo."|".str_replace(" ","_",trim(htmlentities(@$rs['Cconom'])))."|".@$esHospitalario."|".@$rs['reqJus']."|".@$rs['NoPos']."|".@$rs['Tipgoi']."|".json_encode($tieneOferta['datosAdicionales'])."|".$tieneOferta['esOfertado']."|".( $tieneOferta['realizaUnidad'] ? 'on' : 'off' )."\n";
	}
	//	return $consulta;
}



 function consultarAyudasDiagnosticasPorCodigo($basedatos,$codigo,$unidadRealiza, $cco ){
	global $conex;
	global $codigoAyudaHospitalaria;
	global $whce;
	global $wemp_pmla;
	global $wbasedatohce;

	$esHospitalario = "off";
	$consecutivo = "1";
	$auxConsecutivoAyudaHospitalaria = "1";
	
	$consulta = "";

	// $q = "SELECT
			// Codigo,Descripcion,Servicio,Tipoestudio,Anatomia,Codcups,Estado,Ccocor cons,Cconom, NoPos 
		// FROM
			// ".$wbasedatohce."_000017 LEFT JOIN {$basedatos}_000011 ON Ccocod = Servicio
		// WHERE
			// Estado = 'on'			
			// AND Servicio LIKE '%$unidadRealiza%'
			// AND Codigo = '$codigo'
		// ;";

	// $q = "SELECT
			// Codigo,Descripcion,Servicio,Tipoestudio,Anatomia,Codcups,Estado,Ccocor cons,Cconom, NoPos 
		// FROM
			// ".$wbasedatohce."_000017 LEFT JOIN {$basedatos}_000011 ON Ccocod = Servicio
		// WHERE
			// Estado = 'on'			
			// AND Servicio LIKE '%$unidadRealiza%'
			// AND Codigo = '$codigo'
			// AND Tipoestudio IN (SELECT codigo FROM ".$wbasedatohce."_000015 c WHERE c.codigo = Tipoestudio)
		// ;"; 
	
	// $q = "SELECT
			// Codigo,Descripcion,Servicio,Tipoestudio,Anatomia,Codcups,Estado,Ccocor cons,Cconom, (SELECT tiprju FROM {$whce}_000015 c WHERE c.codigo = Tipoestudio) reqJus, NoPos 
		// FROM
			// {$whce}_000047 LEFT JOIN {$basedatos}_000011 ON Ccocod = Servicio
		// WHERE
			// Estado = 'on'			
			// AND Servicio LIKE '%$unidadRealiza%'
			// AND Codigo = '$codigo'
			// AND Tipoestudio IN (SELECT codigo FROM {$whce}_000015 c WHERE c.codigo = Tipoestudio)
		// UNION
		// SELECT
			// Codigo,Descripcion,Servicio,Tipoestudio,Anatomia,Codcups,Estado,Ccocor cons,Cconom, (SELECT tiprju FROM {$whce}_000015 c WHERE c.codigo = Tipoestudio) reqJus, NoPos 
		// FROM
			// {$whce}_000017 LEFT JOIN {$basedatos}_000011 ON Ccocod = Servicio
		// WHERE
			// Estado = 'on'			
			// AND Servicio LIKE '%$unidadRealiza%'
			// AND Codigo = '$codigo'
			// AND Tipoestudio IN (SELECT codigo FROM {$whce}_000015 c WHERE c.codigo = Tipoestudio)
			// AND nuevo = 'on'
		// ;";
		
	$q = "SELECT
			a.Codigo,a.Descripcion,Tipoestudio as Servicio,Tipoestudio,Anatomia,Codcups,a.Estado,Ccocor cons,c.Descripcion as Cconom, tiprju as reqJus, NoPos, Tipgoi as Tipgoi 
		FROM
			{$whce}_000047 a LEFT JOIN {$basedatos}_000011 b ON Ccocod = Servicio, {$whce}_000015 c
		WHERE
			a.Estado = 'on'			
			AND Servicio LIKE '%$unidadRealiza%'
			AND a.Codigo = '$codigo'
			AND Tipoestudio = c.codigo
			AND Tipoestudio NOT IN (
				SELECT
					Toetip
				FROM
					{$whce}_000045
				WHERE
					Toeesp != '".$especialidad."' 
				AND Toeest = 'on'			
				)				
			;";	
	
	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	//Consecutivo de ayudas hospitalarias
	//NO QUEMAR EL NRO EMPRESA
	$q2 = "SELECT
				Detval 
			FROM 
				root_000051
			WHERE
				Detemp = '".$wemp_pmla."'			
				AND Detapl = 'consecutivoAyudasHospitalarias';";

	$res2 = mysql_query($q2, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());
	$num2 = mysql_num_rows($res2);

	if($rs2 = mysql_fetch_array($res2)){
		$consecutivo = $rs2['Detval'];
		$auxConsecutivoAyudaHospitalaria = $rs2['Detval']; 
	}

	while ($rs = mysql_fetch_array($res)){
		//		$referencia = "seleccionarAyudaDiagnostica('".$rs['Servicio']."','".$rs['Codigo']."','".str_replace(" ","_",trim(htmlentities($rs['Descripcion'])))."','".str_replace(" ","_",trim(htmlentities($rs['Tipoestudio'])))."','".str_replace(" ","_",trim(htmlentities($rs['Anatomia'])))."','".str_replace(" ","_",trim(htmlentities($rs['Codcups'])))."','".str_replace(" ","_",trim(htmlentities($rs['cons'])))."','".str_replace(" ","_",trim(htmlentities($rs['Cconom'])))."');";
		//		$consulta = $consulta."<a href='#null' onclick=$referencia>".htmlentities($rs['Descripcion']).'</a><br/>';
		
		//Se revisa si el examen tiene oferta, si no tiene oferta no se deja ordenar
		$tieneOferta = tieneOfertaAyudaDx( $wemp_pmla, $conex, $whce, $rs['Tipoestudio'], $rs['Codcups'], $cco );
		if( !$tieneOferta['result'] )
			continue;

		if(!empty($rs['Servicio']) && $rs['Servicio'] == $codigoAyudaHospitalaria){
			$esHospitalario = "on";
			$consecutivo = $auxConsecutivoAyudaHospitalaria;
		} else {
			$consecutivo = @$rs['cons'];
		}
		
		if( empty( $rs['reqJus'] ) ){
			$rs['reqJus'] = "off";
		}

		$consulta = htmlentities(@$rs['Descripcion'])."|".@$rs['Servicio']."|".@$rs['Codigo']."|".str_replace(" ","_",trim(htmlentities(@$rs['Descripcion'])))."|".str_replace(" ","_",trim(htmlentities(@$rs['Tipoestudio'])))."|".str_replace(" ","_",trim(htmlentities(@$rs['Anatomia'])))."|".str_replace(" ","_",trim(htmlentities(@$rs['Codcups'])))."|".@$consecutivo."|".str_replace(" ","_",trim(htmlentities(@$rs['Cconom'])))."|".@$esHospitalario."|".@$rs['reqJus']."|".@$rs['NoPos']."||".json_encode($tieneOferta['datosAdicionales'])."|".$tieneOferta['esOfertado']."|".( $tieneOferta['realizaUnidad'] ? 'on' : 'off' )."\n";
	}
	return $consulta;
}

  
/**
 *
 * @param $basedatos
 * @param $historia
 * @param $ingreso
 * @param $fecha
 * @param $codUsuario
 * @param $centroCostos
 * @param $consecutivoOrden
 * @return unknown_type
 */
function cancelarOrdenHCE($basedatos,$historia,$ingreso,$fecha,$codUsuario,$centroCostos,$consecutivoOrden){
	global $conex;
	$consulta = "";
	global $wbasedatohce;

	//Inactivar el encabezado de la orden
	$q = "UPDATE ".$wbasedatohce."_000027 SET
			 Ordest = 'off'
		WHERE
			Ordhis = '$historia'  
			AND Ording = '$ingreso' 
			AND Ordtor = '$centroCostos' 
			AND Ordnro = '$consecutivoOrden';";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

	//Inactivar el detalle de la orden
	$q = "UPDATE ".$wbasedatohce."_000028 SET
			 Detest = 'off'
		WHERE
			Dettor = '$centroCostos'
			AND Detnro = '$consecutivoOrden';";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	
	if( mysql_affected_rows() > 0 ){
		//Cancelacion de la orden
		$auditoria = new AuditoriaDTO();
	
		$auditoria->historia = $historia;
		$auditoria->ingreso = $ingreso;
		$auditoria->fechaKardex = $fecha;
		$auditoria->mensaje = obtenerMensaje('MSJ_ORDEN_CANCELADA');
		$auditoria->seguridad = $codUsuario;
		$auditoria->descripcion = "$centroCostos,$consecutivoOrden";
	
		registrarAuditoriaKardex($conex,$basedatos,$auditoria);
	}

	
	$q = "SELECT 
			  Arc_HL7, c.codigo as codigo
		  FROM
			  ".$wbasedatohce."_000028 a, ".$wbasedatohce."_000015 b, ".$wbasedatohce."_000017 c
		  WHERE
			  detcod = c.codigo
			  AND tipoestudio = b.codigo
			  AND Dettor = '$centroCostos'
			  AND Detnro = '$consecutivoOrden'
			  AND Arc_HL7 != ''
			  AND Arc_HL7 != 'NO APLICA'
		 ;";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	
	for(;$rows = mysql_fetch_array( $res ); ){
		
		$sql = "SELECT 
			 		id
		  		FROM
			  		".$wbasedatohce."_{$rows['Arc_HL7']}
		  		WHERE
				  	hl7des = '$centroCostos'
				  	AND hl7nor = '$consecutivoOrden'
		 		;";  //echo ".....<pre>$sql</pre>";
		
		$res1 = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
		
		for(; $rowsHL7 = mysql_fetch_array( $res1 ); ){
			cancelarDatosHL7( $conex, "hce", $rows['Arc_HL7'], $rowsHL7['id'] );
		}
	}
	
	liberarConexionBD($conex);

	$consulta = "1";
	return $consulta;
}

function grabarOrdenHCE($basedatos,$historia,$ingreso,$fecha,$codUsuario,$centroCostos,$consecutivoOrden,$observacionesOrden){
	global $conex;
	global $wbasedatohce;
	$consulta = "";
	$hora = date("H:i:s");
	
	//Inactivar el encabezado de la orden
	$q = "UPDATE ".$wbasedatohce."_000027 SET
			 Ordobs = CONCAT(Ordobs,'\r\n','"."Observacion añadida el $fecha a las $hora:\r\n$observacionesOrden"."')
		WHERE
			Ordhis = '$historia'  
			AND Ording = '$ingreso' 
			AND Ordtor = '$centroCostos' 
			AND Ordnro = '$consecutivoOrden';";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

	//Auditoria
	$auditoria = new AuditoriaDTO();

	$auditoria->historia = $historia;
	$auditoria->ingreso = $ingreso;
	$auditoria->fechaKardex = $fecha;
	$auditoria->mensaje = obtenerMensaje('MSJ_OBSERVACIONES_ORDEN_MODIFICADAS');
	$auditoria->seguridad = $usuario;

	registrarAuditoriaKardex($conex,$basedatos,$auditoria);

	liberarConexionBD($conex);

	$consulta = "1";
	return $consulta;
}

// function mostrarDetalleOrdenes($wemp_pmla,$wempresa,$wbasedato,$whis,$wing,$wfecini,$wfecfin,$wtiposerv,$wprocedimiento,$westadodet)
function mostrarDetalleOrdenes($wemp_pmla,$wempresa,$wbasedato,$whis,$wing,$wfecini,$wfecfin,$wtiposerv,$wprocedimiento,$westadodet,$contExamenes)
{
	  global $conex;
	  global $arrayParaCrearJsAgrupados;
	  global $procedimientosAgrupados;
	  
	  global $usuario;
		
	  //Traigo todas las Ordenes del Servicio seleccionado y de la historia ingreso dado y que esten 'Realizadas'
	  $q = " SELECT A.ordfec, A.ordhor, B.detcod, C.descripcion, B.detrdo, D.Arc_HL7, D.Programa, D.Formato, A.ordnro, B.detite, B.detesi, A.Ordtor, D.Descripcion as Cconom, B.Dettor, B.detfec, B.Detjus, Ordple, Ordurl, Detjoc, Deteex, Eexpen, Eexcan, Detplc, Deturl, Deturp, Dethci, Codcups "
		  ."   FROM ".$wempresa."_000027 A, ".$wempresa."_000028 B, ".$wempresa."_000017 C, ".$wempresa."_000015 D, ".$wbasedato."_000045 E "
		  ."  WHERE A.ordtor      = B.dettor "
		  ."    AND A.ordnro      = B.detnro "		  
		  ."    AND A.ordest      = 'on' "
		  ."	AND B.detest  	  = 'on' "
		  ."    AND B.detcod      = C.codigo "
		  ."    AND C.tipoestudio = D.codigo "
		  ."    AND B.detesi 	  = E.Eexcod "
		  ."    AND E.Eexmeh 	  = 'on'"
		  ."	AND C.Nuevo = 'on' "
		  ."    AND A.ordhis      = '".$whis."'"
		  ."    AND A.ording      = '".$wing."'"
		  ."  UNION "
		  ." SELECT A.ordfec, A.ordhor, B.detcod, C.descripcion, B.detrdo, D.Arc_HL7, D.Programa, D.Formato, A.ordnro, B.detite, B.detesi, A.Ordtor, D.Descripcion as Cconom, B.Dettor, B.detfec, B.Detjus, Ordple, Ordurl, Detjoc, Deteex, Eexpen, Eexcan, Detplc, Deturl, Deturp, Dethci, Codcups "
		  ."   FROM ".$wempresa."_000027 A, ".$wempresa."_000028 B, ".$wempresa."_000047 C, ".$wempresa."_000015 D, ".$wbasedato."_000045 E "
		  ."  WHERE A.ordtor      = B.dettor "
		  ."    AND A.ordnro      = B.detnro "		  
		  ."    AND A.ordest      = 'on' "
		  ."	AND B.detest  	  = 'on' "
		  ."    AND B.detcod      = C.codigo "
		  ."    AND C.tipoestudio = D.codigo "
		  ."    AND B.detesi 	  = E.Eexcod "
		  ."    AND E.Eexmeh 	  = 'on'"
		  ."    AND A.ordhis      = '".$whis."'"
		  ."    AND A.ording      = '".$wing."'"
		  ."  ORDER BY 1 desc ";
	  $res = mysql_query( $q, $conex ) or die( mysql_errno()." - Error en el query $q - ".mysql_error());
	  $res1 = mysql_query( $q, $conex ) or die( mysql_errno()." - Error en el query $q - ".mysql_error());
	  $num = mysql_num_rows($res);
	  
	  $array_ordenes_ant_new= array();
	  
	  
	  $array_ordenes_ant 	= array();
	  $array_icon_verde 	= array();
	  $array_icon_rojo 		= array();
	  $ordenesFinalizadas 	= array();
	  $rows_array 			= array();
	  
	  // $estadoPorTipoOrden = consultarAliasPorAplicacion( $conex, $wemp_pmla, "permitirCambiarEstadoInteroperabilidadPorTipoOrden" );
	  
	  // $estadoPorTipoOrden = explode( "-", $estadoPorTipoOrden );
	  
	  $estadoPorTipoOrden = ccoConInteroperabilidadLaboratorio( $conex, $wbasedato, $whis, $wing );
	   
	  while($rows = mysql_fetch_assoc($res)){
		  
		$mostrarAlertaNoOfertado = true;
	  
		$estadoPorTipoOrden2 = array_merge( $estadoPorTipoOrden, ccoConInteroperabilidadPorEstudio( $conex, $wbasedato, $whis, $wing, $rows['Ordtor'], $rows['Codcups'] ) );
		  
		// $permiteModEst = in_array( $rows['Ordtor'], $estadoPorTipoOrden ) ? false : true;
		$permiteModEst = in_array( $rows['Ordtor'], $estadoPorTipoOrden2 ) ? true : false;

		if( !$permiteModEst ){
			$rows['Ordurl'] = '';
			$rows['Deteex'] = '';
			$rows['Detjoc'] = '';
			// $rows['Detfme'] = '0000-00-00';
			// $rows['Dethme'] = '00:00:00';
			// $rows['Detcor'] = 'off';
			$rows['Detplc'] = '';
			// $rows['Detutm'] = '';
			$rows['Dethci'] = '00:00:00';
			$rows['Deturl'] = '';
			$rows['Deturp'] = '';
			
			$mostrarAlertaNoOfertado = false;
		}
		
		if( !$usuario->esEnfermeraRolHCE ){
			$rows['Ordurl'] = '';
			$rows['Deturl'] = '';
			$rows['Deturp'] = '';
		}
		  
		$rows['Eexcan'] == strtolower( $rows['Eexcan'] );
		$rows['Detplc'] == strtolower( $rows['Detplc'] );
		
		//Si no existe en el array se crea el array siempre como false
		if( !isset( $ordenesFinalizadas[ $rows['ordtor'] ][ $rows['ordnro'] ] ) ) 
			$ordenesFinalizadas[ $rows['ordtor'] ][ $rows['ordnro'] ] = false;
		
		//Se marca las ordenes que tengan al menos un examen pendiente
		if( $rows['Eexpen'] == 'on' ) 
			$ordenesFinalizadas[ $rows['ordtor'] ][ $rows['ordnro'] ] = true;
		
		$rows_array[] = $rows;
	  }
	  
	  // while($row_array = mysql_fetch_assoc($res)){
	  foreach($rows_array as $row_array ){
		
		//Si hay al menos un procedimiento o examen pendiente no se muestra la orden como finalizada
		if( $ordenesFinalizadas[ $row_array['ordtor'] ][ $row_array['ordnro'] ] )
			continue;
		
		if( !empty($row_array['Ordurl']) && ( $row_array['Deteex'] == 'P' || $row_array['Deteex'] == 'F' ) ){

			if( $row_array['Ordple'] == 'on' ){
				$array_icon_verde[$row_array['detfec']] = true;
			}
		}
		elseif( $row_array['Detplc'] == 'on' && ( !empty($row_array['Deturl']) || !empty($row_array['Deturp']) )){
			$array_icon_verde[$row_array['detfec']] = true;
		}
		
		// if( !empty($row_array['Ordurl']) && ( $row_array['Deteex'] == 'P' || $row_array['Deteex'] == 'F' ) ){

			if( $row_array['Eexcan'] == 'on' && $row_array['Detplc'] == 'on' ){
				$array_icon_rojo[$row_array['detfec']] = true;
			}
		// }
	  
		if(!array_key_exists($row_array['detfec'], $array_ordenes_ant)){
			$array_ordenes_ant[$row_array['detfec']][] = $row_array;
		}
		else{
			$array_ordenes_ant[$row_array['detfec']][] = $row_array;
		}
		
		if( !isset($array_ordenes_ant_new[ $row_array['detfec'] ][ $row_array['ordtor'] ][ $row_array['ordnro'] ]) ){
			$array_ordenes_ant_new[ $row_array['detfec'] ][ $row_array['ordtor'] ][ $row_array['ordnro'] ][] = $row_array;
		}
		else{
			$array_ordenes_ant_new[ $row_array['detfec'] ][ $row_array['ordtor'] ][ $row_array['ordnro'] ][] = $row_array;
		}
	  
	  }
	// echo "<div align=left>";
	// echo "<pre>";	
	// print_r($array_ordenes_ant);
	// echo "</pre>";	
	// echo "</div>";
		
	  echo "<center>";
	  echo "<table>";
	  echo "<tr>";	    
	  echo "<td valign='middle' colspan=3><input class='textoNormal' type='text' placeholder='Buscar' name='wprocedimiento' id='wprocedimiento' value='".$wprocedimiento."' size='81'></td>";	  
	  echo "<td width='80' valign='middle'></td>";	  
	  echo "</tr>";
	  echo "</table>";
	  echo "</center>";
	  echo "<center>";

	  $i=1;
	foreach($array_ordenes_ant_new as $key => $array_ordenes_finales)
	{
		$icon = "";
		if( $array_icon_verde[$key] ){
			$icon = "<span style='background-color: green; color: white; display: inline-flex; width: 10px; height: 10px; justify-content: center; border-radius: 50%; font-size: 7pt; opacity: 1;'><span>";
		}
		
		$iconred = "";
		if( $array_icon_rojo[$key] ){
			$iconred = "<span class='fondorojo' style='color: white; display: inline-flex; width: 10px; height: 10px; justify-content: center; border-radius: 50%; font-size: 7pt; opacity: 1;'><span>";
		}
		  
		echo "<div style=''><a href='javascript:' onclick='ver_ordenes_anteriores(\"$key\");' style='cursor_pointer;font-size:12pt;'>$key</a>$icon $iconred</div>";
		echo "<table id='ordenes_anteriores_".$key."' style='display:none'>";
		echo "<tr class='encabezadoTabla'>";		 
		echo "<td><b>Nro Orden</b></td>";
		echo "<td><b>Tipo</b></td>";
		echo "<td><b>Procedimiento</b></td>";
		echo "<td><b>Justificaci&oacute;n</b></td>";
		echo "<td><b>Estado</b></td>";
		echo "</tr>";
		  
		foreach( $array_ordenes_finales as $ordenes_final){
			
			foreach( $ordenes_final as $array_ordenes_final ){
				
				$mostrar = true;
				
				$ordenes_por_tor = count( $array_ordenes_final );
				$ordenes_por_nor = count( $array_ordenes_final );
				
				if (isset($wclase2) && $wclase2 == "fila1")
					$wclase2 = "fila2";
				 else 
					$wclase2 = "fila1";
				
				foreach($array_ordenes_final as $key1 => $row){
				 
					 $wproord = $row['descripcion'];
					 $westord = $row['detesi'];
					 $wtor = $row['Dettor'];
					 $wcco = $row['Dettor'];
					 $wtipord = $row['Cconom'];		 
					 $wjustiproc = $row['Detjus'];		 
					 $wurl = $row['Ordurl'];		 			//Url del resultado por orden
					 $wurl_por_estudio = $row['Deturl'];		 //Url de la imagen del resultado por estudio
					 $wrep_por_estudio = $row['Deturp'];		//Url del reporte por estudio 
					 $esEstadoCancelado = strtolower( $row['Eexcan'] ) == 'on';
					 $esPendienteLecturaCancelado = strtolower( $row['Detplc'] ) == 'on';
					 
					 if (isset($wclase) && $wclase == "fila1")
						$wclase = "fila2";
					 else 
						$wclase = "fila1";
							  
					  echo "<tr class='".$wclase." find' >";
					  
					  if( $mostrar ){
						  echo "<td class='".$wclase2."' style='text-align:center;' rowspan='".$ordenes_por_tor."'>".$row['ordnro']."</td>";
						  echo "<td class='".$wclase2."' rowspan='".$ordenes_por_nor."'>".$wtipord."</td>";
					  }
					  $mostrar = false;
					 
					 // 2012-06-26
					 // Se concatena al final con la variable $i para asegurar que no coincida ningún nombre de los DIV's
					 $wnomdiv = $row['ordfec']."-".$row['ordhor']."-".$row['detcod']."-".$i;   //Nombre del DIV
						 
					 echo "<td>";   
					 echo "<a href='#null' onclick=intercalarOrdenAnterior('".$wnomdiv."');>".$row['descripcion']."</a>";

					 echo "<div id='".$wnomdiv."' style='display:none'>";
					 echo "<table align='center' border=0>";
								
					 //Formatos
					 // 1: Descriptivo                  ej: Patologia, Mamografia, Endoscopia, Cardiología (hasta que no se tome por HL7), etc.
					 // 2: Descriptivo con Imagen       ej: Imagenología (TAC, RX) con HL7, etc.
					 // 3: Por valores y con referencia ej: Laboratorio Clínico
					 
					 $wtabla = $row['Arc_HL7'];             //Archivo en el que se almacena el resultado, si tiene valor es porque es HL7, este valor esta en la tabla hce_000015
					 $wformatoVista = $row['Formato'];      //Formato en que se ve el resultado, Viene de la tabla hce_000015
					 $wnor  = $row['ordnro'];             //Numero de orden
					 $wite  = $row['detite'];             //Numero de Orden es el numero de orden seguido de un guion y la fila correspodiente al examen o procedimiento
					 
					 switch ($wformatoVista)
						{
						  case "1":  
						  
								if (trim($wtabla)=="" or strtoupper(trim($wtabla)) == "NO APLICA") 
								 {
								   //Muestra el Resultado
								   echo "<tr class='encabezadoTabla' align='center'>";
								   echo "<td align=center><textarea cols=81 rows=5 readonly>".$row['detrdo']."</textarea></td>";
								   echo "</tr>";
								 }
								else 
								   traer_resultado($wtabla, $wcco, $whis, $wing, $wnor, $wite);
						  break;
							  
						  case "2":    
						  
							  $wresultado = traer_resultado($wtabla, $wcco, $whis, $wing, $wnor, $wite);
							  
							  //Muestra el Resultado
							  echo "<tr class='encabezadoTabla' align='center'>";
							  echo "<td align=center><textarea cols=81 rows=5 name=wrdo readonly>".$wresultado."</textarea></td>";
							  echo "</tr>";
							 // 2012-06-26
							 // Se comenta porque aun no existe una tabla o campo de donde tomar la imagen
							 //echo "<tr><td><A HREF='Entrega_de_turno_enfermeria.php?wemp_pmla=".$wemp_pmla."&wcco=".$wcco."&wfec=".$wfecant."' class=tipo4V>Ver Imagen</A></td></tr>";	
							  
						  break;
							  
						  case "3":
						 
							  $wresultado = traer_resultado($wtabla, $wcco, $whis, $wing, $wnor, $wite);
							  $wresultado_parciado = mostrar_resultado($wresultado);
							  
							  //Muestra el Resultado
							  //echo "<tr class='encabezadoTabla' align='center'>";
							  //echo "<td align=center><textarea rows=22 cols=140 name=wrdo readonly>".$wresultado_parciado."</textarea></td>";
							  //echo "</tr>";
						  
						  break;
							  
						  default: 
							  echo "<tr class='encabezadoTabla' align='center'>";
							  echo "<td align=center><textarea cols=81 rows=5 name=wrdo readonly>".$row['detrdo']."</textarea></td>"; //Muestra el Resultado
							  echo "</tr>";
						  break;
					}  
						
				 echo "</table>";
				 echo "</div>";
				 
				$nombre_estado = consultarDescripcionEstado($westord); // Trae el nombre del examen.
				 
				$classBlink = "";
				$attrPLE 	= "";
				$extra = $nombre_estado; 
				
				//Se revisa si tiene resultado por orden
				// if( !empty($wurl) && ( $row['Deteex'] == 'P' || $row['Deteex'] == 'F' ) )
				if( !empty($wurl) ){
					
					if( $row['Ordple'] == 'on' ){
						$classBlink = 'blink';
						$attrPLE 	= "ple='".$wtor."-".$wnor."'";
					}
					// $extra = "<div><a $attrPLE href='#null' class='blink-".$wtor."-".$wnor." ver-orden $classBlink' onClick='abrirVentanaVerAnteriores(\"".$wurl."\", \"".$wtor."\",\"".$wnor."\")'><span style='color:green;'>Ver resultado</span></a></div>";
					$extra = "<div><a $attrPLE href='#null' class='blink-".$wtor."-".$wnor." ver-orden $classBlink' onMouseOver='abrirVentanaVerAnteriores(\"".$wurl."\", \"".$wtor."\",\"".$wnor."\")'><span style='color:green;'>$nombre_estado</span></a></div>";
				}
				
				//Se revisa si tiene resultados por estudio
				if( !empty( $wurl_por_estudio ) || !empty( $wrep_por_estudio ) ){
									
					$classBlink = '';
					$attrPLE = '';
					if( $esPendienteLecturaCancelado ){
						$classBlink = 'blink';
						$attrPLE 	= "ple='".$wtor."-".$wnor."-".$wite."'";
					}
					
					// $extra .= "<div><a $attrPLE href='#null' class='blink-".$wtor."-".$wnor." ver-orden $classBlink' onClick='marcarLeidoEstudioCancelado( this, \"".$row['Deturl']."\" );'><span style='color:green;'>Ver imagen</span></a></div>";
					$extra = "<div><a $attrPLE href='#null' class='blink-".$wtor."-".$wnor." ver-orden $classBlink' onmouseover='marcarLeidoEstudioCancelado( this, \"".$row['Deturl']."\" );'><span style='color:green;'>$nombre_estado</span></a></div>";
				}
				
				
				//Se busca si fue cancelado
				$comentarios = consultarComentarioPorInteroperabilidad( $conex, $wbasedato, $wtor, $wnor, $wite  );
			
				$textCita = "";
				$txtComentario = '';
				
				if( count($comentarios) > 0 ){
					
					$txtComentario .= "<b>Comentarios:</b>";
					
					foreach( $comentarios as $datoComenario ){
						$txtComentario .= "<br><b>".$datoComenario['fecha']." ".$datoComenario['hora']."</b><br>".$datoComenario['comentario'];
					}
					
					$txtComentario = "<tr><td colspan=2>$txtComentario</td></tr>";
				}
				
				
				if( !empty( $row['Dethci'] ) && $row['Dethci'] != '00:00:00' ){
				
					$sala = '';
					
					//Consultando la sala en que se realizará la cita
					//Buscar en la tabla de usuario que cco le pertenece al usuario.
					$sql = "SELECT b.Saldes
								 FROM ".$wbasedato."_000268 a, ".$wbasedato."_000263 b
								WHERE a.mvctor = '".$wtor."'
								  AND a.mvcnro = '".$wnor."'
								  AND a.mvcite = '".$wite."'
								  AND b.salcod = a.mvcsal";
					$resSala = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
					if( $rowsSala = mysql_fetch_array( $resSala ) ){
						$sala = $rowsSala['Saldes'];
					}
					
					
					$txtComentario = "<tr>
									<td>Fecha</td><td><b>".$row['detfec']."</b></td>
								</tr>
								<tr>
									<td>Hora</td><td><b>".$row['Dethci']."</b></td>
								</tr>
								<tr>
									<td>Sala</td><td><b>".$sala."</b></td>
								</tr>
							".$txtComentario;
					
				}
				
				if( !empty($txtComentario) )
					$txtComentario = "<table>$txtComentario</table>";
				
				
				if( !empty( $row['Detjoc'] ) || !empty( $txtComentario ) ){
					$extra .= "<span style='display:block;font-weight:bold;' class='msg_tooltip' title='".$row['Detjoc'].( ( !empty( $row['Detjoc'] ) && !empty( $txtComentario ) ) ? "<br>" : '' ).$txtComentario."'><img src='../../images/medical/root/info.png' width='20px'/></span>";
				}
				 
				$nombre_estado = consultarDescripcionEstado($westord); // Trae el nombre del examen.
				 
				 echo "</td>";
				 echo "<td>".$wjustiproc ."</td>";
				 echo "<td ".( $esEstadoCancelado ?  "class=fondorojo" : '' )."><span ".( ( $esEstadoCancelado && $esPendienteLecturaCancelado ) ? "class='blink' onmouseover='marcarLeidoEstudioCancelado( this );'  plecancelado='".$wtor."-".$wnor."-".$wite."'" : '' ).">$extra</span></td>";
				 echo "</tr>";
				 $i++;
				
					if( isset( $arrayParaCrearJsAgrupados[ $wcco."-".$wnor."-".$wite ] ) && isset( $procedimientosAgrupados) )
					{
						$existeEnArrayAgrupados=false;
						foreach($procedimientosAgrupados as $tipoProc => $Proc)
						{
							foreach($Proc as $item => $valueProc)
							{
								if($valueProc['codigo']==$row['detcod'] && $arrayParaCrearJsAgrupados[ $wcco."-".$wnor."-".$wite ][0] == $tipoProc)
								{
									$existeEnArrayAgrupados=true;
									break 2;
								}
							}
						}

						if($existeEnArrayAgrupados==false)
						{
							$tipoOrdenAgruNum = $arrayParaCrearJsAgrupados[ $wcco."-".$wnor."-".$wite ];
							
							$procedimientosAgrupados[ $tipoOrdenAgruNum[0] ][] = array(
								'codigo' => $row['detcod'],
								'consecutivo' => $contExamenes,
								'tipo' => $tipoOrdenAgruNum[1],
								'cantidad' => $tipoOrdenAgruNum[2],
								'justificacion' => $tipoOrdenAgruNum[3],
								'estadoProced' => $tipoOrdenAgruNum[4],
								'medicamentos' => $tipoOrdenAgruNum[5],
								'imprimir' => $tipoOrdenAgruNum[6]
							);
						}
						
					}
				 
				}
				
			}
		}
		
		echo "</table>";
	}
	  echo "</center>";	


		// //Imperesion de ordenes anteriores individualmente
	  // echo "<center>";
	  // echo "<table>";
	  // echo "<tr>";	    
	  // echo "<td valign='middle' colspan=3><input class='textoNormal' type='text' placeholder='Buscar' name='wprocedimiento' id='wprocedimiento' value='".$wprocedimiento."' size='81'></td>";	  
	  // echo "<td width='80' valign='middle'></td>";	  
	  // echo "</tr>";
	  // echo "</table>";
	  // echo "</center>";
	  // echo "<center>";

	  // $i=1;
	  // foreach($array_ordenes_ant as $key => $array_ordenes_final)
		// {
		  // $icon = "";
		  // if( $array_icon_verde[$key] ){
			  // $icon = "<span style='background-color: green; color: white; display: inline-flex; width: 10px; height: 10px; justify-content: center; border-radius: 50%; font-size: 7pt; opacity: 1;'><span>";
		  // }
		  
		  // echo "<div style=''><a href='javascript:' onclick='ver_ordenes_anteriores(\"$key\");' style='cursor_pointer;font-size:12pt;'>$key</a>$icon</div>";
		  // echo "<table id='ordenes_anteriores_".$key."' style='display:none'>";
		  // echo "<tr class='encabezadoTabla'>";		 
		  // echo "<td><b>Nro Orden</b></td>";
		  // echo "<td><b>Tipo</b></td>";
		  // echo "<td><b>Procedimiento</b></td>";
		  // echo "<td><b>Justificaci&oacute;n</b></td>";
		  // echo "<td><b>Estado</b></td>";
		  // echo "</tr>";
		  
		 // foreach($array_ordenes_final as $key1 => $row){
		 
			 // $wproord = $row['descripcion'];
			 // $westord = $row['detesi'];
			 // $wtor = $row['Dettor'];
			 // $wcco = $row['Dettor'];
			 // $wtipord = $row['Cconom'];		 
			 // $wjustiproc = $row['Detjus'];		 
			 // $wurl = $row['Ordurl'];		 
			 
			 // if (isset($wclase) && $wclase == "fila1")
				// $wclase = "fila2";
			   // else 
				  // $wclase = "fila1";
					  
			  // echo "<tr class='".$wclase." find' >";
			  // echo "<td style='text-align:center;'>".$row['ordnro']."</td>";
			  // echo "<td>".$wtipord."</td>";
			 
			 // // 2012-06-26
			 // // Se concatena al final con la variable $i para asegurar que no coincida ningún nombre de los DIV's
			 // $wnomdiv = $row['ordfec']."-".$row['ordhor']."-".$row['detcod']."-".$i;   //Nombre del DIV
				 
			 // echo "<td>";   
			 // echo "<a href='#null' onclick=intercalarOrdenAnterior('".$wnomdiv."');>".$row['descripcion']."</a>";

			 // echo "<div id='".$wnomdiv."' style='display:none'>";
			 // echo "<table align='center' border=0>";
						
			 // //Formatos
			 // // 1: Descriptivo                  ej: Patologia, Mamografia, Endoscopia, Cardiología (hasta que no se tome por HL7), etc.
			 // // 2: Descriptivo con Imagen       ej: Imagenología (TAC, RX) con HL7, etc.
			 // // 3: Por valores y con referencia ej: Laboratorio Clínico
			 
			 // $wtabla = $row['Arc_HL7'];             //Archivo en el que se almacena el resultado, si tiene valor es porque es HL7, este valor esta en la tabla hce_000015
			 // $wformatoVista = $row['Formato'];      //Formato en que se ve el resultado, Viene de la tabla hce_000015
			 // $wnor  = $row['ordnro'];             //Numero de orden
			 // $wite  = $row['detite'];             //Numero de Orden es el numero de orden seguido de un guion y la fila correspodiente al examen o procedimiento
			 
			 // switch ($wformatoVista)
				// {
				  // case "1":  
				  
						// if (trim($wtabla)=="" or strtoupper(trim($wtabla)) == "NO APLICA") 
						 // {
						   // //Muestra el Resultado
						   // echo "<tr class='encabezadoTabla' align='center'>";
						   // echo "<td align=center><textarea cols=81 rows=5 readonly>".$row['detrdo']."</textarea></td>";
						   // echo "</tr>";
						 // }
						// else 
						   // traer_resultado($wtabla, $wcco, $whis, $wing, $wnor, $wite);
				  // break;
					  
				  // case "2":    
				  
					  // $wresultado = traer_resultado($wtabla, $wcco, $whis, $wing, $wnor, $wite);
					  
					  // //Muestra el Resultado
					  // echo "<tr class='encabezadoTabla' align='center'>";
					  // echo "<td align=center><textarea cols=81 rows=5 name=wrdo readonly>".$wresultado."</textarea></td>";
					  // echo "</tr>";
					 // // 2012-06-26
					 // // Se comenta porque aun no existe una tabla o campo de donde tomar la imagen
					 // //echo "<tr><td><A HREF='Entrega_de_turno_enfermeria.php?wemp_pmla=".$wemp_pmla."&wcco=".$wcco."&wfec=".$wfecant."' class=tipo4V>Ver Imagen</A></td></tr>";	
					  
				  // break;
					  
				  // case "3":
				 
					  // $wresultado = traer_resultado($wtabla, $wcco, $whis, $wing, $wnor, $wite);
					  // $wresultado_parciado = mostrar_resultado($wresultado);
					  
					  // //Muestra el Resultado
					  // //echo "<tr class='encabezadoTabla' align='center'>";
					  // //echo "<td align=center><textarea rows=22 cols=140 name=wrdo readonly>".$wresultado_parciado."</textarea></td>";
					  // //echo "</tr>";
				  
				  // break;
					  
				  // default: 
					  // echo "<tr class='encabezadoTabla' align='center'>";
					  // echo "<td align=center><textarea cols=81 rows=5 name=wrdo readonly>".$row['detrdo']."</textarea></td>"; //Muestra el Resultado
					  // echo "</tr>";
				  // break;
			// }  
				
		 // echo "</table>";
		 // echo "</div>";
		 
		// $classBlink = "";
		// $attrPLE 	= "";
		// $extra = "";
		// if( !empty($wurl) && ( $row['Deteex'] == 'P' || $row['Deteex'] == 'F' ) ){
			
			// if( $row['Ordple'] == 'on' ){
				// $classBlink = 'blink';
				// $attrPLE 	= "ple='".$wtor."-".$wnor."'";
			// }
			// $extra = "<div><a $attrPLE href='#null' class='blink-".$wtor."-".$wnor." ver-orden $classBlink' onClick='abrirVentanaVerAnteriores(\"".$wurl."\", \"".$wtor."\",\"".$wnor."\")'><span style='color:green;'>Ver resultado</span></a></div>";
		// }
		
		// if( !empty( $row['Detjoc'] ) ){
			// $extra = "<span style='display:block;font-weight:bold;' class='msg_tooltip' title='".$row['Detjoc']."'><img src='../../images/medical/root/info.png' width='20px'/></span>";
		// }
		 
		 // $nombre_estado = consultarDescripcionEstado($westord); // Trae el nombre del examen.
		 
		 // echo "</td>";
		 // echo "<td>".$wjustiproc ."</td>";
		 // echo "<td>".$nombre_estado."$extra</td>";
		 // echo "</tr>";
		 // $i++;
		
			// if( isset( $arrayParaCrearJsAgrupados[ $wcco."-".$wnor."-".$wite ] ) && isset( $procedimientosAgrupados) )
			// {
				// $existeEnArrayAgrupados=false;
				// foreach($procedimientosAgrupados as $tipoProc => $Proc)
				// {
					// foreach($Proc as $item => $valueProc)
					// {
						// if($valueProc['codigo']==$row['detcod'] && $arrayParaCrearJsAgrupados[ $wcco."-".$wnor."-".$wite ][0] == $tipoProc)
						// {
							// $existeEnArrayAgrupados=true;
							// break 2;
						// }
					// }
				// }

				// if($existeEnArrayAgrupados==false)
				// {
					// $tipoOrdenAgruNum = $arrayParaCrearJsAgrupados[ $wcco."-".$wnor."-".$wite ];
					
					// $procedimientosAgrupados[ $tipoOrdenAgruNum[0] ][] = array(
						// 'codigo' => $row['detcod'],
						// 'consecutivo' => $contExamenes,
						// 'tipo' => $tipoOrdenAgruNum[1],
						// 'cantidad' => $tipoOrdenAgruNum[2],
						// 'justificacion' => $tipoOrdenAgruNum[3],
						// 'estadoProced' => $tipoOrdenAgruNum[4],
						// 'medicamentos' => $tipoOrdenAgruNum[5],
						// 'imprimir' => $tipoOrdenAgruNum[6]
					// );
				// }
				
			// }
		 
		// }
		
		// echo "</table>";
	// }
	  // echo "</center>";	
}

function consultarComponenteLEV($basedatos,$descripcion){
	global $conex;

	$coleccion = array();

	$q = "SELECT
			Levcod,Levnom,Levcon,Levvol,Levest
		FROM
		{$basedatos}_000075
		WHERE
			Levnom LIKE '%$descripcion%'
			AND Levest = 'on'";

		$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
		$num = mysql_num_rows($res);

		while($info = mysql_fetch_array($res)){
			echo $info['Levnom']." [".$info['Levcon']."] en ".$info['Levvol']."\n";
		}
}

/************************************************************************************************************************
 * Calcula la cantidad a grabar para un medicamento
 * 
 * @param $fechaHoy
 * @param $fechaInicio
 * @param $horaInicioSuministro
 * @param $horasFrecuencia
 * @param $esPrimeraVez
 * @return unknown_type
 * 
 * Modificaciones
 * Marzo 8 de 2011	(Edwin MG)	La variable $fechaHoy se manda por parametro, queda con la fecha del kardex
 ************************************************************************************************************************/
function calcularCantidadGrabar( $fechaHoy,$fechaInicio,$horaInicioSuministro,$horasFrecuencia,$esPrimeraVez, $dosisMaximas, $aplicacionesAnteriores, $aplicacionesPorSaldo ){
	
	/************************************************************************************************************************
	 * Se cambia está función por un calculo más sencillo y poder manejar tiempos de dispensación mayores a un día
	 * ya que clínica del sur tiene un tiempo de dispensación de 7 días
	 ************************************************************************************************************************/
	
	global $horaCorteDispensacion;
	global $diasDispensacion;
	
	if( empty( $diasDispensacion ) )
		$diasDispensacion = 1;
	
	$cantidad = 0;
	
	$vecHoraInicioSuministro	= explode(":",$horaInicioSuministro);
	$vecFechaInicioSuministro	= explode("-",$fechaInicio);
	
	//Si no hay frecuencia dejo por defecto dos horas para hacer calculos y no se haga un ciclo infinito
	if( $horasFrecuencia == 0 ){
		$horasFrecuencia = 2*3600;
	}
	
	$fechaTempDiaSiguiente = strtotime( $fechaHoy." $horaCorteDispensacion:00:00" ) + $diasDispensacion*(24*60*60);
	$fechaActualHoraInicio = mktime($horaInicioSuministro,0,0,$vecFechaInicioSuministro[1],$vecFechaInicioSuministro[2],$vecFechaInicioSuministro[0]);
	
	if( $esPrimeraVez )
		$fechaHoyUnix = strtotime( $fechaHoy." 00:00:00");
	else{
		$fechaHoyUnix = strtotime( $fechaHoy." $horaCorteDispensacion:00:00" ) + ($diasDispensacion-1)*(24*60*60);
	}
	
	//Sí hay dosis máximas reviso cuando dosis máximas faltan por aplicar
	if( $dosisMaximas != '' && $dosisMaximas != 0 ){
		$dosisMaximas = $dosisMaximas - $aplicacionesAnteriores - $aplicacionesPorSaldo;
		
		if( $dosisMaximas < 0 )
			$dosisMaximas = 0;
	}
	else{
		$dosisMaximas = false;
	}
	
	//Recorro todas las horas de aplicación del articulo, desde fecha de inicio hasta la fecha final de acuerdo a la frecuencia
	for( $i = $fechaActualHoraInicio; $i <= $fechaTempDiaSiguiente; $i += $horasFrecuencia*3600 ){
		
		//Si la hora de aplicación es mayor a la fecha de inicio, significa que debe aplicar
		if( $i > $fechaHoyUnix ){
			$cantidad++;
			
			//Si hay dosis máxima verifico que no supere la dosis máxima
			if( $dosisMaximas ){
				if( $dosisMaximas <= $cantidad ){
					$cantidad = $dosisMaximas;
					break;
				}
			}
		}
	}
	
	return $cantidad;
}

// function calcularCantidadGrabar( $fechaHoy,$fechaInicio,$horaInicioSuministro,$horasFrecuencia,$esPrimeraVez, $dosisMaximas, $aplicacionesAnteriores, $aplicacionesPorSaldo ){
	// global $horaCorteDispensacion;

	// $horasDia = 24;
	// $cantidad = 0;
	// $cocienteHoras = 0;

// //	$fechaHoy = date("Y-m-d");
	// $fechaAyer = date( "Y-m-d", strtotime($fechaHoy)-24*3600 );

	// //Indicadores
	// $esAnteriorAHoraSuministro = false;
	// $esHoy = false;

	// //Hora de inicio entera
	// $vecHoraInicioSuministro	= explode(":",$horaInicioSuministro);
	// $vecFechaInicioSuministro	= explode("-",$fechaInicio);
	// $horaInicioInt 				= intval($vecHoraInicioSuministro[0]);

// //	if($horaInicioInt == 0){
// //		$horaInicioInt = 24;
// //	}

	// //Si la hora de inicio es mayor a las 16 se tiene en cuenta la frecuencia
// //	$fechaTempDiaSiguiente = mktime($horaCorteDispensacion,0,0,date("m"),date("d"),date("Y")) + (24*60*60);
// //	$fechaActualHoraInicio = mktime($horaInicioSuministro,0,0,date("m"),date("d"),date("Y"));

	// $fechaTempDiaSiguiente = mktime($horaCorteDispensacion,0,0,$vecFechaInicioSuministro[1],$vecFechaInicioSuministro[2],$vecFechaInicioSuministro[0]) + (24*60*60);
	// $fechaActualHoraInicio = mktime($horaInicioSuministro,0,0,$vecFechaInicioSuministro[1],$vecFechaInicioSuministro[2],$vecFechaInicioSuministro[0]);

	// $fechaHoraInicio = mktime(0,0,0,$vecFechaInicioSuministro[1],$vecFechaInicioSuministro[2],$vecFechaInicioSuministro[0]);

	// $vecFechaHoy	= explode("-",$fechaHoy);

	// $diferenciaHoras = ($fechaTempDiaSiguiente - $fechaActualHoraInicio);
	// $diferenciaHoras = intval($diferenciaHoras / 3600); 	//60 (minutos) * 60 (horas)
	// $diferenciaSuministroInicio = intval($horaCorteDispensacion-$horaInicioInt);
	// $diferenciaInicioSuministro = intval($horaInicioInt-$horaCorteDispensacion);

	// //Diferencia de horas entre el dia actual y la fecha de inicio
	// $timeActual = mktime(0,0,0,$vecFechaHoy[1],$vecFechaHoy[2],$vecFechaHoy[0]);
	// $diferenciaTotal = intval(($fechaHoraInicio-$timeActual) / 3600);
	// /*****************************************************************************************
	 // * Son cuatro condiciones a controlar:
	 // * 1.Menor o igual a la hora maxima suministro
	 // * 2.Despues de la hora maxima de suministro
	 // * 3.La fecha de inicio es de hoy
	 // * 4.Primera vez del articulo en un kardex
	 // *****************************************************************************************/
	// if($horaInicioInt <= $horaCorteDispensacion){
		// $esAnteriorAHoraSuministro = true;
	// }

	// if(trim($fechaInicio) == trim($fechaHoy)){
		// $esHoy = true;
	// }

	// $esta = in_array("*",obtenerVectorAplicacionMedicamentos($fechaHoy, $fechaInicio, $horaInicioSuministro, $horasFrecuencia));
	
	// if($horasFrecuencia==0)
		// $horasFrecuencia = 1;
	
	// if($esPrimeraVez){
		// if($esAnteriorAHoraSuministro && $esHoy){
			// $cocienteHoras = intval(($horasDia + ($horaCorteDispensacion-$horaInicioInt))/$horasFrecuencia) + 1;
		// }

		// if($esAnteriorAHoraSuministro && !$esHoy){
			// $cocienteHoras = intval($diferenciaSuministroInicio/$horasFrecuencia) + 1;

			// if($horaInicioInt > 8 && $horasFrecuencia > 8){	//Junio 10 de 2011, condicion original: $horaInicioInt > 8 && $horasFrecuencia >= 8
				// $cocienteHoras = 1;
			// }
		// }

		// if(!$esAnteriorAHoraSuministro && $esHoy){
			// $cocienteHoras = intval(($horasDia - $diferenciaInicioSuministro)/$horasFrecuencia) + 1;
		// }

		// if(!$esHoy){
			// if(!$esAnteriorAHoraSuministro){
				// $cocienteHoras = 0;
			// } else {
				// if($diferenciaTotal >= 48){
					// $cocienteHoras = 0;
				// }
			// }
		// }
	// } else {
		// if( $fechaHoy >= $fechaInicio  ){ 			//Diciembre 16 de 2010
// //			if( $horasFrecuencia <= $horasDia ){		//Si la frecuencia es hasta 24 horas aplica esto
			// if( $horasFrecuencia <= (($fechaTempDiaSiguiente - $fechaActualHoraInicio)/3600) ){		//Si la frecuencia es hasta 24 horas aplica esto
// //				echo "<br>...........Dif horas: ".(($fechaTempDiaSiguiente - $fechaActualHoraInicio)/3600);
				// $cocienteHoras = (($fechaTempDiaSiguiente - $fechaActualHoraInicio)/3600) / $horasFrecuencia;
// //				$cocienteHoras = $horasDia / $horasFrecuencia;
			// } else {
				// if($esta){  //Si la frecuencia es de mas de 24 horas
					// $cocienteHoras = 1;
				// } else {
					// $cocienteHoras = 0;
				// }
			// }
		// }		//Diciembre 16 de 2010
	// }

	// $cocienteHorasEntero = intval($cocienteHoras);
	// $cantidad = $cocienteHorasEntero;
	
	
	// /****************************************************************************************************************
	 // * Enero 05 de 2011
	 // ****************************************************************************************************************/
	// //$aplicacionesAnteriores = consultarAplicacionesArticuloPaciente( $conexion, $wbasedato, $idRegDiaAnterior );
	
	// //Si la dosis maxima es menor que la cantidad a grabar, la cantidad a grabar seran la dosis maximas
	// if( $dosisMaximas != '' && $dosisMaximas != 0 && $dosisMaximas - $aplicacionesAnteriores - $aplicacionesPorSaldo < $cantidad ){
		// $cantidad = $dosisMaximas - $aplicacionesAnteriores - $aplicacionesPorSaldo;
	// }
	
	// if( $cantidad < 0 ){
		// $cantidad = 0;
	// }
	// /******************************************************************************************************************/

	// return $cantidad;
// }

function consultarCantidadAcumuladaDispensada($conex,$wbasedato,$historia,$ingreso,$codigoArticulo){
	$cantidad = "";

	/*En algunos casos las devoluciones no se marcan adecuadamente en el kadcdi por eso se encuentran cantidades demas
	$q = "SELECT
			SUM(Kadcdi) canAcumulada
		FROM
			{$wbasedato}_000054
		WHERE
			Kadhis = '$historia'
			AND Kading = '$ingreso'
			AND Kadart = '$codigoArticulo'
			AND Kadest = 'on'";*/

	$q = "SELECT
			IFNULL(SUM(Aplcan),0) canAcumulada
		FROM
			{$wbasedato}_000015
		WHERE
			Aplhis 		= '$historia'
			AND Apling  = '$ingreso'
			AND Aplart  = '$codigoArticulo'
			AND Aplest  = 'on'";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: $q - " . mysql_error());
	$num = mysql_num_rows($res);

	while($info = mysql_fetch_array($res)){
		$cantidad = $info['canAcumulada'];
	}
	return $cantidad;
}


function calcularSaldoActual($conexion,$wbasedato,$historia,$ingreso,$fechaKardex,$codArticulo,$fechaInicio,$horaInicio,$cantDosis,$horasFrecuencia,$dosisMaximas,$ccoOrigen,$diasTtoAcumulados,&$cantGrabar,&$saldoNuevo,&$cantDispensar,&$cantManejo,$saldoDispensacion, $tipoProtocolo, &$horasAplicacionDia,$diasTto,$idRegDiaAnterior = '' ){
	
	global $codigoCentralMezclas;
	global $centroCostosServicioFarmaceutico;
	global $centroCostosCentralMezclas;
	global $horaCorteDispensacion;
	
	global $diasDispensacion;
	
	$diasDispensacion = consultarDiasDispensacion( $conexion, $wbasedato, $historia, $ingreso );

	//Variables
	$saldoAnterior = 0;
	$saldoNuevo = 0;
	$dispensarNuevo = false;
	$fraccionesTotales = 0;
	$factor = 1;
	
	if( $tipoProtocolo == "U" ){
		$tipoProtocolo = "DA";
	}

	if( $idRegDiaAnterior != '' ){
		//Consulta del saldo anterior del articulo
					
		$q = "SELECT
					Kadart,Kadsal,Kadfec,Kadfin,Kadhin,Kadori,Kadhdi,Kaddis,Kadcnd, Kadcdi
				FROM
					{$wbasedato}_000054
				WHERE
					id = '$idRegDiaAnterior'
				";
				
		$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
		$num = mysql_num_rows($res);
	}
	else{
		$num = 0; 
	}

	if($num > 0){
		$fila = mysql_fetch_array($res);
	}

	//La solución a esto es consultar las fracciones, si no tiene fracciones se usan dias de estabilidad cero (no tiene)
	$tarti = $centroCostosCentralMezclas;
	
	if( $ccoOrigen == "SF" ){
		$tarti = $centroCostosServicioFarmaceutico;
	}

	$qf = "SELECT
			Defart, Deffra, Defdup, Defdis, Defcco, Defdie
		FROM
			{$wbasedato}_000059
		WHERE
			Defart = '$codArticulo'
			AND Defcco = '$tarti'
			AND Defest = 'on';"; 

	$respin = mysql_query($qf, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $qf . " - " . mysql_error());
	$numf = mysql_num_rows($respin);

	$diasEstabilidad = "0";
	$dispensable = "on";
	$cantidadFracciones = "1";

	while($infofr = mysql_fetch_array($respin)){
		$diasEstabilidad 	= $infofr['Defdie'];
		$dispensable 		= $infofr['Defdis'];
		$cantidadFracciones = $infofr['Deffra'];
	}
	
	$fechaUsar = $fechaInicio;
	$horaUsar = $horaInicio;
	$dejarSaldoArticulo = true;
	
	/******************************************************************************
	 * Marzo 26 de 2012
	 * Calculo el total de dosis correspondientes por días de tratamiento
	 ******************************************************************************/
	//Calculo cuantas dosis maximas son por dias de tratamiento en caso de tener
	if( !empty( $diasTto ) ){
		$dosisPorDtto = strtotime( $fechaInicio." 00:00:00" ) + $diasTto*24*3600;
		$dosisPorDtto = intval( ( $dosisPorDtto - strtotime( $fechaInicio." ".$horaInicio ) )/($horasFrecuencia*3600 ) ) + 1;
		
		$dosisMaximas = $dosisPorDtto;
	}
	/******************************************************************************/
	
	$esPrimeraVez = esPrimeraVez( $conexion, $wbasedato, $historia, $ingreso, $codArticulo, $idRegDiaAnterior, $fechaKardex, $fechaInicio, $horaInicio, $horasFrecuencia, $fechaUsar, $horaUsar, $dejarSaldoArticulo );

	//Marzo 26 de 2012
	//Agrego dosis maximas y dias de tratamiento en la funcion 
	$aplicacionesAnteriores = consultarAplicacionesArticuloPaciente( $conexion, $wbasedato, $idRegDiaAnterior );
	
	$cantGrabar = calcularCantidadGrabar( $fechaKardex, $fechaUsar, $horaUsar, $horasFrecuencia, $esPrimeraVez, $dosisMaximas, $aplicacionesAnteriores, intval( $saldoDispensacion/($cantDosis/$cantidadFracciones) ) );	//Enero 14 de 2011
	
	/****************************************************************************************************************
	 * creando string con las aplicaciones de las hora 
	 * @var unknown_type
	 ****************************************************************************************************************/
	$info = consultarinfotipoarticulosKardex( $conexion, $wbasedato );
	
	$vectorAplicacion = obtenerVectorAplicacionMedicamentos( $fechaKardex, $fechaUsar, $horaUsar, $horasFrecuencia );
	$vectorAplicacion2 = obtenerVectorAplicacionMedicamentos( date( "Y-m-d", strtotime( $fechaKardex )+24*3600 ), $fechaUsar, $horaUsar, $horasFrecuencia );

	$vectorAplicacion2 = arreglarVectorKardex( $vectorAplicacion2 );

	$quitarUnoARegleta = 25;
	if( count($vectorAplicacion2) == 25 ){
		$quitarUnoARegleta = 24;
	}			
	
	foreach( $vectorAplicacion2 as $keyB => $valueB ){
		$vectorAplicacion[$quitarUnoARegleta] = $valueB;
		$quitarUnoARegleta++;
	}

	$horasAplicacionDia = crearVectorAplicaciones( $vectorAplicacion, $info[ $tipoProtocolo ]['tiempoPreparacion'], $cantDosis/$cantidadFracciones, intval( ( strtotime( "1970-01-01 ".$info[ $tipoProtocolo ]['horaCaroteDispensacion'] ) - strtotime( "1970-01-01 00:00:00" ) )/3600 ) );
	/****************************************************************************************************************/
			
	/****************************************************************************************************************
	 * Abril 25 de 2011
	 * Si el medicamento tiene condicion a necesidad, el saldo de articulo es 0 si no se dispenso completamente
	 ****************************************************************************************************************/
	if( $num > 0 ){
		
		$sql = " SELECT Contip "
		      ."   FROM ".$wbasedato."_000042 "      //Tabla condiciones de administracion
			  ."  WHERE concod = '".$fila['Kadcnd']."'";
			  
		$resAN = mysql_query( $sql, $conexion ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
		$numrowsAN = mysql_num_rows( $resAN );
			  
		if( $numrowsAN > 0 ){
			$rowsAn = mysql_fetch_array( $resAN );
	
			if( $rowsAn['Contip'] == "AN" && ($fila['Kadcdi']-$fila['Kaddis']) > 0){
				$fila['Kadsal'] = 0;
			}
		}
	}
	/****************************************************************************************************************/	  
	
	if( !$dejarSaldoArticulo ){	//Abril 27 de 2011. Si el paciente viene de urgencia o cirugia, el saldo del articulo del día anterior es 0
		$fila['Kadsal'] = 0;
	}
	
	// /****************************************************************************************************************
	 // * Enero 05 de 2011
	 // ****************************************************************************************************************/
	// $aplicacionesAnteriores = consultarAplicacionesArticuloPaciente( $conexion, $wbasedato, $idRegDiaAnterior );
	
	// //Si la dosis maxima es menor que la cantidad a grabar, la cantidad a grabar seran la dosis maximas
// //	if($dosisMaximas != '' && $dosisMaximas != 0 && $dosisMaximas < $cantGrabar){
	// if($dosisMaximas != '' && $dosisMaximas != 0 && $dosisMaximas - $aplicacionesAnteriores - $saldoDispensacion < $cantGrabar){
		// $cantGrabar = $dosisMaximas - $aplicacionesAnteriores - $saldoDispensacion;
	// }
	
	// if( $cantGrabar < 0 ){
		// $cantGrabar = 0;
	// }
	// /******************************************************************************************************************/
	
	$dosisTemporal = (double)($cantDosis * $cantGrabar);

	if( isset($fila['Kadsal']) && $codArticulo == trim( $fila['Kadart'] ) ){	//Mayo 2 de 2012
		$saldoAnterior = (double)($fila['Kadsal']);
	}
	else{
		$saldoAnterior = 0;
	}
	
	$fraccionesTotales = (double)($cantidadFracciones);
	$cantManejo = $fraccionesTotales;

	//Se incluyen los dias de estabilidad:
	//Si el origen del articulo es central de mezclas y los dias de tratamiento acumulados, superan los dias de estabilidad,se hace el saldo a cero (pide completo)
	if($ccoOrigen == $codigoCentralMezclas && intval($diasEstabilidad) > 0 && (intval($diasTtoAcumulados) % intval($diasEstabilidad) == 0)){
		$saldoAnterior = 0;
	}

	//Fracciones totales
	if($fraccionesTotales < $dosisTemporal){
		$factor = ceil((double)(round(($dosisTemporal-$saldoAnterior) / $fraccionesTotales,1)));	//Marzo 1 de 2011, se adiciona el round para que calcule correctamente las fracciones
	}
	
	if($saldoAnterior < $dosisTemporal){
		$dispensarNuevo = true;
		$saldoNuevo = ($saldoAnterior + ($fraccionesTotales * $factor)) - $dosisTemporal;
	}else{
		$saldoNuevo = $saldoAnterior - $dosisTemporal;
	}

	if($dispensarNuevo){
		$cantDispensar = $factor;
	}
	
	$cantDispensar += $saldoDispensacion;
}

/************************************************************************************************************************************************
 * Graba un articulo en el detalle del kardex.  Si existe lo actualiza caso contrario inserta
 *
 * Retorna un codigo de estado que puede caer en uno de los siguientes:
 *
 * 0->No inserto el registro
 * 1->Creo un nuevo item de detalle en el kardex
 * 2->Actualizo un item del detalle en el kardex
 *
 * @param unknown_type $wbasedato
 * @param unknown_type $historia
 * @param unknown_type $ingreso
 * @param unknown_type $codArticulo
 * @param unknown_type $cantDosis
 * @param unknown_type $unDosis
 * @param unknown_type $per
 * @param unknown_type $fmaFtica
 * @param unknown_type $fini
 * @param unknown_type $hini
 * @param unknown_type $ffin
 * @param unknown_type $via
 * @param unknown_type $conf
 * @param unknown_type $dtto
 * @param unknown_type $obs
 * @param unknown_type $usuario
 * @return unknown
 ************************************************************************************************************************************************/
function grabarArticuloDetalle($wbasedato,$historia,$ingreso,$fechaKardex,$codArticulo,$cantDosis,$unDosis,$per,$fmaFtica,$fini,$hini,$via,$conf,$dtto,$obs,$origenArticulo,$codUsuario,$condicion,$dosisMax,$cantGrabar,$unidadManejo,$cantidadManejo,$primerKardex,$horasFrecuencia,$fInicioAnt,$hInicioAnt,$noDispensar,$tipoProtocolo,$centroCostosGrabacion,$prioridad,$cantidadAlta,$impresion,$deAlta,$nombreArticulo,$familia,$firma,$artdosisAdaptada,$id_original,$artnoEsteril,$profilaxis,$tratamiento,$esPediatrico,$conInsumo1,$conInsumo2,$porProtocolo, $wdrautorizado, $wjusparaautorizar ){
	
	global $horaCorteDispensacion;	
	global $whce;	
	global $usuario;	
	global $wemp_pmla;
	
	global $codigoCentralMezclas;
	global $centroCostosServicioFarmaceutico;
	
	global $diasDispensacion;
	
	$diasDispensacion = consultarDiasDispensacion( $conexion, $wbasedato, $historia, $ingreso );
	
	$fInicioAnt = trim( $fInicioAnt );
	
	
	$usuario = consultarUsuarioOrdenes($codUsuario);
	
	$accionesPestana = consultarAccionesPestana(3);
	
	$conexion = obtenerConexionBD("matrix");
	$wcenmez = consultarAliasPorAplicacion( $conexion, $wemp_pmla, "cenmez" );	
	$horasFrecuencia = consultarFrecuencia( $conexion, $wbasedato, $horasFrecuencia );
	$fini = trim($fini);
	$obs = utf8_decode($obs);
	//Se encripta la contraseña y se guarda encriptada.
	$firma = sha1($firma);
	
	
	// $esDeAyudaDx = $porProtocolo == 'on' ? true: false;
	
	//Los LEV se dejan grabar en ordenes
	// if( $codArticulo == "LQ0000" ){
		// return 1;
	// }

	//Consulto si el paciente está en urgencia
	//si está en urgencia el medicamento queda automáticamente aprobado
	$pacPaciente = consultarInfoPacienteOrdenHCEPorHistoria( $conexion, $wbasedato, $historia );
	
	$ccoAyudaDx = '';
	$esDeAyudaDx = false;
	if( $pacPaciente->esDeAyudaDx && !$esDePiso  ){
		$ccoAyudaDx = $pacPaciente->servicioActual;
		$esDeAyudaDx = true;
		$noDispensar = $porProtocolo == 'on' ? 'true': $noDispensar;
	}

	$gruposNoVisibles = array();
	if( !$pacPaciente->enUrgencias ){
		$gruposNoVisibles = consultarAliasPorAplicacion( $conexion, "01", "gruposNoVisiblesPerfil" );
		$gruposNoVisibles = explode( ',', $gruposNoVisibles );
	}

	$esLQ = 'off';
	//Esto se hace por que el tipo de protocolo LQ(liquido endovenoso - lev ) no existe y fue creado para separar los medicamentos que pertenecen a un LEV
	//los insumos de un LEV son tipos de protocolo normal
	if( $tipoProtocolo == 'LQ' ){
		$tipoProtocolo = "N";
		$esLQ = 'on';
	}
	
	if( $esLQ == 'on' ){

		if( !$accionesPestana[ "3.1" ]->leer ){
			$puedeGrabarIC = permisosModificarLEVsIC( $conexion, $wbasedato, 'IC', $usuario->codigoRolHCE, $pacPaciente->servicioActual );
			$puedeGrabarLEV = permisosModificarLEVsIC( $conexion, $wbasedato, 'LEV', $usuario->codigoRolHCE, $pacPaciente->servicioActual );
			
			if( $puedeGrabarLEV || $puedeGrabarIC  ){
				$accionesPestana[ "3.1" ]->leer = true;
			}
		}
	}
	
	//Si es una insulina y tiene permisos para crear dextrometer
	//Entonces le permite agregar el articulo al kardex
	$frecuenciaArticulo = consultarPeriodicidadesPorCodigo( $conexion, $wbasedato, $per );
	
	if( $frecuenciaArticulo->esTipoInsulina ){
		$accionesPestanaDextrometer = consultarAccionesPestana(6);
		if( $accionesPestanaDextrometer["6.1"]->leer 
			&& $accionesPestanaDextrometer["6.2"]->leer 
			&& $accionesPestanaDextrometer["6.3"]->leer 
		){
			$accionesPestana[ "3.1" ]->leer = true;
		}
	}
	
	$nombreArticulo = '';
	
	//Confirmada preparación.
	$conf == "true" ? $conf = 'on' : $conf = 'off';
	$noDispensar == "true" ? $noDispensar = 'on' : $noDispensar = 'off';
	$artdosisAdaptada == "true" ? $artdosisAdaptada = 'on' : $artdosisAdaptada = 'off'; //Si el articulo se marco como dosis adaptada se registra en on.
	$artnoEsteril == "true" ? $artnoEsteril = 'on' : $artnoEsteril = 'off'; //Si el articulo se marco como NE se registra en on.
	$multiplicable = false;
	$fhInicialIgual = false;
	$existe = false;
	$esPrimerKardex = false;
	$estado = "0";
	$saldo = 0;
	$cantGrabar = 0;
	$cantDispensar = 0;
	$limiteCtc = false;
	$saldoDispensacion = 0;

	$cantidadAutorizadaCtc 	= "";
	$cantidadUtilizadaCtc 	= "";
	$unidadesCantidadesCtc 	= "";
	$artAprobado = "off";	//Indica si el medicamento es aprobado o no
	
	$esArticuloNutricion = esArticuloNutricion( $conexion, $wcenmez, $codArticulo );
	
	$ccoLac = '1120';
	$esArtLactario = false;
	if( $tipoProtocolo != 'LQ' && esArticuloLactario($conexion, $wbasedato, $codArticulo ) ){
		$tipoProtocolo = "N";
		$centroCostosGrabacion = $ccoLac;
		$esArtLactario = true;
		$artAprobado = "on";
	}
	
	//Consulto si la familia es de control
	$sql = "SELECT Famcod
			  FROM {$wbasedato}_000114
			 WHERE Famnom = '$familia'
			   AND famest = 'on'
			";
			
	$resFamCtr = mysql_query( $sql, $conexion ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	
	$famControl = '';
	if( $rows = mysql_fetch_array( $resFamCtr ) ){
		$famControl = $rows[ 'Famcod' ];
	}
	
	if( $pacPaciente->enUrgencias ){
		$artAprobado = "on";
		
		//Si el articulo es de central de mezclas se confirma su preparación
		if($origenArticulo != "SF"){
			$conf = 'on';
		}
	}
	
	//Modificación Abril 18 de 2016. Solo es confirmado una NPT si es articulo nuevo
	//Si el articulo es una nutricion se confirma automaticamente.
	// if($esArticuloNutricion){
		// $conf = 'on';
	// }
	

	if(!empty($nombreArticulo) && substr($nombreArticulo,0,1) == "*"){
		$nombreArticulo = substr($nombreArticulo,1);
	} else {
		$nombreArticulo = "";
	}
	
	$auxHorasFrecuencia = $horasFrecuencia;
	
	$cambioFecHorInicio = false;

	//Cuando los articulos son multiples se usa la hora de actualizacion como referente
	$horaActualizacion = "";

	/**********************************************************************************
	* Septiembre 20 de 2012
	*
	* Si hay días de tratamiento se convierten a dosis máxima. Los días de tratamiento deben
	* contar desde la hora de inicio del medicamento
	*
	*
	* Modificado: Octubre 25 de 2012. quito dosis adicional
	**********************************************************************************/
   if( !empty( $dtto ) ){
		   
		//Convierto los días de tratamiento a dosis máxima
		// $dosisMax = floor( ($dtto*24)/$horasFrecuencia ) + 1;        //El adicional de uno es debido a que debe contar la dosis inicial
		// $dosisMax = floor( ($dtto*24)/$horasFrecuencia );        //Octubre 25 de 2012
	   
		$dosisMax = 0;
		$dtto = (integer) $dtto;

		if( $horasFrecuencia > 0 ){
			for( $i = 0; $i < $dtto*24; $i += $horasFrecuencia ){
				$dosisMax++;
			}
		}
		
		$dtto = '';
   }
   /**********************************************************************************/
 
	if(!empty($fInicioAnt) && !empty($hInicioAnt)){
		
		//Junio 13 de 2012. Modifico consulta, no tengo en cuenta el centro de grabacion del articulo
		$q = "SELECT
				Kadart, Kadcfr, Kadufr, Kaddia, Kadest, Kadess, Kadper, Kadffa, Kadfin, Kadhin, Kadvia, Kadfec, Kadcon, Kadobs, Kadsus, Kadori, Kadcnd, Kaddma, Kadcan, Kaduma, Kadcma, Kadsad, Kaddis, Kadcdi, Kadreg, Kadcpx, Kadron, Kadfro, Kadaan, Kadcda, Kadcdt,Kaddan,Kadfum,Kadhum, Kadido, Kadfra, Kadfcf, Kadhcf, Kadfir
			FROM
				{$wbasedato}_000054
			WHERE
				Kadart = '$codArticulo'
				AND Kadfec = '$fechaKardex'
				AND Kadhis = '$historia'
				AND Kading = '$ingreso'
				AND Kadpro = '$tipoProtocolo'
				AND Kadfin = '$fInicioAnt'
				AND Kadhin = '$hInicioAnt'
				AND Kadido = '$id_original'";
		
		$q .= " UNION "; //Marzo 14 de 2011
		$q .= "SELECT
				Kadart, Kadcfr, Kadufr, Kaddia, Kadest, Kadess, Kadper, Kadffa, Kadfin, Kadhin, Kadvia, Kadfec, Kadcon, Kadobs, Kadsus, Kadori, Kadcnd, Kaddma, Kadcan, Kaduma, Kadcma, Kadsad, Kaddis, Kadcdi, Kadreg, Kadcpx, Kadron, Kadfro, Kadaan, Kadcda, Kadcdt, Kaddan, Kadfum, Kadhum, Kadido, Kadfra, Kadfcf, Kadhcf, Kadfir
			FROM
				{$wbasedato}_000060
			WHERE
				Kadart = '$codArticulo'
				AND Kadfec = '$fechaKardex'
				AND Kadhis = '$historia'
				AND Kading = '$ingreso'
				AND Kadpro = '$tipoProtocolo'
				AND Kadfin = '$fInicioAnt'
				AND Kadhin = '$hInicioAnt'
				AND Kadido = '$id_original'";
		
		$control = "A";		
		
	} else {
		$q = "SELECT
				Kadart, Kadcfr, Kadufr, Kaddia, Kadest, Kadess, Kadper, Kadffa, Kadfin, Kadhin, Kadvia, Kadfec, Kadcon, Kadobs, Kadsus, Kadori, Kadcnd, Kaddma, Kadcan, Kaduma, Kadcma, Kaddis, Kadcdi, Kadsad, Kadreg, Kadcpx, Kadron, Kadfro, Kadaan, Kadcda, Kadcdt,Kaddan,Kadfum,Kadhum, Kadido, Kadfra, Kadfcf, Kadhcf, Kadfir
			FROM
				{$wbasedato}_000060
			WHERE
				Kadart = '$codArticulo'
				AND Kadfec = '$fechaKardex'
				AND Kadhis = '$historia'
				AND Kading = '$ingreso'
				AND Kadpro = '$tipoProtocolo'
				AND Kadido = '$id_original'";
		
		$control = "B";
	}

	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$fila = mysql_fetch_array($res);
	$num = mysql_num_rows($res);
	
	$guardar = "Creacion/modif de articulo $codArticulo - $id_original - $codUsuario - $control-$num = ".print_r($q,true).PHP_EOL;	
	seguimiento($guardar);
	
	//La solución a esto es consultar las fracciones, si no tiene fracciones se usan dias de estabilidad cero (no tiene)
	$tarti = $centroCostosCentralMezclas;
	if($origenArticulo == "SF"){
		$tarti = $centroCostosServicioFarmaceutico;
	}

	$qf = "SELECT
			Defart, Deffra, Defdup, Defdis, Defcco, Defdie
		FROM
			{$wbasedato}_000059
		WHERE
			Defart = '$codArticulo'
			AND Defcco = '$tarti'
			AND Defest = 'on';";

	$respin = mysql_query($qf, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $qf . " - " . mysql_error());
	$numf = mysql_num_rows($respin);

	$diasEstabilidad = "0";
	$dispensable = "on";
	$cantidadFracciones = "1";
	$duplicable = "on";

	while($infofr = mysql_fetch_array($respin)){
		$diasEstabilidad 	= $infofr['Defdie'];
		$dispensable 		= $infofr['Defdis'];
		$cantidadFracciones = $infofr['Deffra'];
		$duplicable 		= $infofr['Defdup'];
	}

	//Existencia del articulo
	if($num > 0){
		$existe = true;
		
		//Si el usuario que esta en el programa no tiene firma se deja la firma actual
		if( empty($firma)  ){
			$firma = $fila['Kadfir'];
		}
		
	}

	//El articulo es multiplicable, se pueden grabar duplicados varias veces
	if($duplicable == 'on'){
		$multiplicable = true;
	}

	//Fecha y hora de inicio anterior son iguales a fecha y hora de inicio digitada
	if($hInicioAnt == $hini && $fini == $fInicioAnt){
		$fhInicialIgual = true;
	}

	if($primerKardex == "S"){
		$esPrimerKardex = true;
	}

	//Calculo de los dias de tratamiento actuales, Sumo 1 dia por el registro del dia actual que esta en temporal
	$diasTtoAcumulados = 0;
	$dosisTtoTotales = 0;
	obtenerDatosAdicionalesArticulo($historia,$ingreso,$codArticulo,$diasTtoAcumulados,$dosisTtoTotales);
	
	/************************************************************************************
	 * Marzo 26 de 2012
	 ************************************************************************************/
	 //Si hay cambio de frecuencia y no se ha modificado fecha y hora de inicio
	 //se debe calcular a partir de la ultima aplicacion de la fecha vieja
	if($existe){
		if( $fila['Kadper'] != $per ){
			
			$fechaHoraInicioAnterior = strtotime( trim( $fInicioAnt )." ".trim( $hInicioAnt ) );
			$fechaHoraInicioActual = strtotime( trim( $fini )." ".trim( $hini ) );
			
			
			//Si no se encuentra la fecha y hora de inicio
			if( $fechaHoraInicioActual == $fechaHoraInicioActual ){
			
				//Calculo la fecha y hora de la ultima aplicacion
				$ultimoSuministro = suministroAntesFechaCorte( date( "Y-m-d" ), date( "H:i:s" ), trim( $fini ), trim( $hini ), consultarFrecuencia( $conexion, $wbasedato, $fila['Kadper'] ) );
				
				if( $ultimoSuministro ){
					
					//Calculo ronda actual
					$auxfechaUnix = strtotime( "1970-01-01 00:00:00" );
					$rondaActual = intval( ( time()-$auxfechaUnix )/(2*3600) )*2*3600 + $auxfechaUnix;	//Ok
					
					if( $rondaActual - $ultimoSuministro < consultarFrecuencia( $conexion, $wbasedato, $per )*3600 ){
						$fini = date( "Y-m-d", $ultimoSuministro );
						$hini = date( "H:i:s", $ultimoSuministro );
						
						$cambioFecHorInicio = true;
					}
				}
				else{
				}
			}
		}
	}
	/************************************************************************************/

	/****************************************************************************************************************
	 * Mayo 23 de 2012
	 *
	 * Si el medicamento estaba como no enviar y lo cambian a enviar, genero el saldo del día anterior 
	 * y ademas venga de días anteriores y no se ha cambiado ni fecha ni hora de inicio ni frecuencia
	 ****************************************************************************************************************/
	$activacionNoEnviar = false;
	if($existe){
	
		if( $fila['Kadess'] == 'on' && $fila[ 'Kadreg' ] != '' ){
		
			$activacionNoEnviar = true;

			if( $fila['Kadper'] == $per && trim( $fini ) == $fila[ 'Kadfin' ] && substr( trim( $hini ),0,2 ) == substr( $fila[ 'Kadhin' ], 0, 2 ) && $fechaKardex != $fila[ 'Kadfin' ] 
				&& time() <= strtotime( "$fechaKardex $horaCorteDispensacion:00:00" )
			){

				//Calculo siguiente hora de aplicacion desde el momento de cambio
				$siguienteSuministro = suministroAntesFechaCorte( $fechaKardex , date( "H:00:00" ), trim( $fini ), trim( $hini ), $horasFrecuencia );
				
				//Si es verdadero significa que si hay fecha y hora de inicio anterior
				if( $siguienteSuministro ){
					
					//Aumento una frecuencia, ya que no se puede pedir la ronda actual
					$siguienteSuministro += $horasFrecuencia*3600;
					
					//Calculo el saldo del día anterior 
					//$fila[ 'Kadsad' ] = calcularCantidadGrabar( $fechaKardex, $fechaUsar, $horaUsar, $horasFrecuencia, $esPrimeraVez, $dosisMaximas, $aplicacionesAnteriores, intval( $saldoDispensacion/($cantDosis/$cantidadFracciones) ) );
					$fila[ 'Kadsad' ] = calcularCantidadGrabar( date( "Y-m-d", strtotime( $fechaKardex." 00:00:00" )-24*3600 ), date( "Y-m-d", $siguienteSuministro ), date( "H:i:s", $siguienteSuministro ), $horasFrecuencia, true, '', '', '' );
				
					$fila[ 'Kadsad' ] = floor( $fila[ 'Kadsad' ]*( $fila[ 'Kadcfr' ]/$fila[ 'Kadcma' ] ) );
					//$fila[ 'Kaddis' ] = 0;
					
					//Calculo la cantidad de aplicaciones
					$fila[ 'Kadcan' ] = calcularCantidadGrabar( $fechaKardex, $fila[ 'Kadfin' ], $fila[ 'Kadhin' ], consultarFrecuencia( $conexion, $wbasedato, $fila[ 'Kadper' ] ), false, '', '', '' );
				}
			}
			else{

				//Calculo siguiente hora de aplicacion desde el momento de cambio
				//$siguienteSuministro = suministroAntesFechaCorte( $fechaKardex ,gmdate( "H:00:00", floor( date( "H" )/2 )*2*3600 ), trim( $fini ), trim( $hini ), $horasFrecuencia );
				$siguienteSuministro = suministroAntesFechaCorte( $fechaKardex ,gmdate( "H:00:00", floor( date( "H" )/2 )*2*3600 ), $fila[ 'Kadfin' ], $fila[ 'Kadhin' ], consultarFrecuencia( $conexion, $wbasedato, $fila[ 'Kadper' ] ) );
				
				//Si es verdadero significa que si hay fecha y hora de inicio anterior
				if( $siguienteSuministro ){
				
					$siguienteSuministro += $horasFrecuencia*3600;
					
					//$fila[ 'Kadcan' ] = calcularCantidadGrabar( $fechaKardex, $horaCorteDispensacion.":00:00", date( "Y-m-d", $siguienteSuministro ), date( "H:i:s", $siguienteSuministro ), $horasFrecuencia, false, '', 0, 0 );
					$fila[ 'Kadcan' ] = calcularCantidadGrabar( $fechaKardex, date( "Y-m-d", $siguienteSuministro ), date( "H:i:s", $siguienteSuministro ), consultarFrecuencia( $conexion, $wbasedato, $fila[ 'Kadper' ] ), true, '', '', '' );
					//$fila[ 'Kaddis' ] = 0;
				}
				
				$fila[ 'Kadsad' ] = 0;
			}
		}
	}
	/****************************************************************************************************************/

	// exit( "fin7777999......".$horasFrecuencia  );	
	// echo "...reg Anterior: ".$fila[ 'Kadreg' ];
	//Calculo del saldo actual con base en el anterior
	$horasAplicacionDia = "";
	// calcularSaldoActual($conexion,$wbasedato,$historia,$ingreso,$fechaKardex,$codArticulo,$fInicioAnt,$hInicioAnt,$cantDosis,$horasFrecuencia,$dosisMax,( empty( $fila['Kadori'] ) )? $origenArticulo: $fila['Kadori'],$diasTtoAcumulados+1,&$cantGrabar,&$saldo,&$cantDispensar,&$cantidadManejo,$fila['Kadsad'], $tipoProtocolo,$horasAplicacionDia, $fila['Kadreg'] );
	calcularSaldoActual($conexion,$wbasedato,$historia,$ingreso,$fechaKardex,$codArticulo,trim($fini)       ,substr( trim( $hini ),0,2 ).":00:00"       ,$cantDosis,$horasFrecuencia,$dosisMax    ,( empty( $fila['Kadori'] ) )? $origenArticulo: $fila['Kadori'],$diasTtoAcumulados+1,$cantGrabar,  $saldo   ,$cantDispensar,$cantidadManejo,$fila['Kadsad']   , $tipoProtocolo, $horasAplicacionDia , $dtto,$fila['Kadreg']       );

 // calcularSaldoActual($conexion,$wbasedato,$historia,$ingreso,$fechaKardex,$codArticulo,    $fechaInicio  ,$horaInicio                                ,$cantDosis,$horasFrecuencia,$dosisMaximas,$ccoOrigen                                                    ,$diasTtoAcumulados  ,&$cantGrabar,&$saldoNuevo,&$cantDispensar,&$cantManejo    ,$saldoDispensacion, $tipoProtocolo, &$horasAplicacionDia,$diasTto,$idRegDiaAnterior = '' )
	
	// if($dispensable == 'off' || $noDispensar == 'on'){
		// $cantGrabar = 0;
		// $saldo = 0;
		// $cantDispensar = 0;
	// }
	
	//Si el articulo se encuentra suspendido no puede modificarlo.
	if(@$fila['Kadsus'] != 'on'){
	
		if($dispensable == 'off' || $noDispensar == 'on'){
			$cantGrabar = 0;
			$saldo = 0;
			$cantDispensar = 0;
		}
		
		/**********************************************************************
		 * Julio 24 de 2012
		 *
		 * Todos los articulos de lactario deben quedar siempre aprobados
		 **********************************************************************/
		$aprobado = 'off';
		
		//Consulto el grupo del medicamento
		$sqlGrupo = "SELECT
						Artgru
					 FROM
						{$wbasedato}_000026
					 WHERE
						artcod = '$codArticulo'
					";
					
		$resGrupo = mysql_query( $sqlGrupo, $conexion ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
		$numGrupo = mysql_num_rows( $resGrupo );
		
		if( $numGrupo > 0 ){
		
			$rowGrupo = mysql_fetch_array( $resGrupo );			
			
			list( $rowGrupo[ 'Artgru' ] ) = explode( "-", $rowGrupo[ 'Artgru' ] );
			
			
			//Si son articulos que no se ven en el perfil no se dispensa, por tanto se guarda 
			//siempre como no enviar para evitar que se vea en reportes
			if( in_array( $rowGrupo[ 'Artgru' ], $gruposNoVisibles ) ){
				$cantGrabar = 0;
				$saldo = 0;
				$cantDispensar = 0;
				$noDispensar = "on";
			}
			
			//Consulto si el articulo pertenece a lactario
			$sql = "SELECT
						Ccogka
					FROM
						{$wbasedato}_000011
					WHERE
						ccolac = 'on'
						AND ccoest = 'on'
						AND Ccogka != '*'
					";
					
			$resArtLacatrio = mysql_query( $sql, $conexion ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
			$numLac = mysql_num_rows( $resArtLacatrio );
			
			if( $numLac > 0 ){
				$rows = mysql_fetch_array( $resArtLacatrio );
				
				$artsLactario = explode( ",", $rows['Ccogka'] );
				
				foreach( $artsLactario as $keyLactario => $valueLactario ){
				
					if( strtoupper( $rowGrupo[ 'Artgru' ] ) == strtoupper( $valueLactario ) ){
						$aprobado = 'on';
						break;
					}
				}
			}
		}
		/**********************************************************************/
		
		
//
		//Si el articulo es duplicable y la fecha y hora de inicio son diferentes siempre insert
//		if(!$existe || ($existe && $multiplicable && !$fhInicialIgual)){
		if(!$existe){
			
			if( $accionesPestana[ "3.1" ]->leer ){	//Esto indica si puede crear medicamentos
			
				if( $id_original == 0 ){
				
					$audAnterior = "";
					
					if( !tieneCpxPorHistoria( $conexion, $wbasedato, $historia, $ingreso ) ){
						$horasAplicacionDia = "";
					}
					else{
						//Octbure 26 de 2011
						//Si el articulo comienza a media noche, debe mostrar
						if( $fechaKardex == trim( $fini ) && substr( trim( $hini ), 0, 2 ) == "00" ){
							$horasAplicacionDia = "Ant-".round($cantDosis/$cantidadFracciones,3)."-0,".$horasAplicacionDia;
						}
					}
					
					$pendientePorLactario = 'on';
					if( $esArtLactario ){
						$pendientePorLactario = 'off';
					}
					
					//Si es articulo de nutrición y apenas se va a agregar pasa confimrado
					//Esto no ocurre para la actualización
					//Al momento de actualizar un articulo es como se halla dejado
					if($esArticuloNutricion){
						$conf = 'on';
					}

					//Si la pestaña no es de alta inserta en la tabla movhos_000060 y si el paciente es diferente de urgencias insertará en la movhos_000168.
					if($deAlta != 'on'){
						
						//Busco el codigo para articulo nuevo
						$q_log_n1 = "SELECT Logcod
									FROM ".$wbasedato."_000174
									WHERE Lognue = 'on'
									  AND Logest = 'on'";
						$res_log_n1 = mysql_query($q_log_n1, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q_log_n1 . " - " . mysql_error());
						$row_log_n1 = mysql_fetch_array($res_log_n1);
						$cod_log_nuevo1 = $row_log_n1['Logcod'];
						
						$obs = mysqli_real_escape_string($conexion,$obs);
					
						$q = "INSERT INTO ".$wbasedato."_000060
								(Medico  ,Fecha_data         ,    Hora_data      ,  Kadhis   , Kading   ,     Kadart   , Kadcfr     ,   Kadufr , Kaddia, Kadest,    Kadess    ,  Kadper,   Kadffa  , Kadfin, Kadhin, Kadvia,      Kadfec      , Kadcon, Kadobs,   Kadori        , Kadsus,   Kadcnd   , Kaddma    ,   Kadcan    ,     Kaduma    ,     Kadcma      , Kaddis, Kadhdi , Kadsal,      Kadcdi    ,   Kadpri   ,     Kadpro     ,        Kadcco          ,   Kadare     ,      Kadsad        , Kadnar          , Kadreg,   Kadusu    ,       Kadcpx        ,    Kadcal     ,  Kadimp    , Kadalt  ,    Kadusp    ,        Kadpen           ,    Kadctr    , Kadlev , Kadfir , Kaddoa           , Kadnes         ,      Kadlog     , Seguridad     )
							VALUES
								('movhos','".date("Y-m-d")."','".date("H:i:s")."','$historia','$ingreso','$codArticulo','$cantDosis','$unDosis','$dtto', 'on'  ,'$noDispensar',  '$per','$fmaFtica','$fini','$hini', '$via','".$fechaKardex."','$conf','$obs' ,'$origenArticulo',  'off','$condicion','$dosisMax','$cantGrabar','$unidadManejo','$cantidadManejo',  '0'  ,'00:00','$saldo','$cantDispensar','$prioridad','$tipoProtocolo','$centroCostosGrabacion','$artAprobado','$saldoDispensacion','$nombreArticulo',   ''  ,'$codUsuario','$horasAplicacionDia','$cantidadAlta','$impresion','$deAlta', '$codUsuario', '$pendientePorLactario' , '$famControl', '$esLQ','$firma','$artdosisAdaptada','$artnoEsteril','$cod_log_nuevo1','A-$codUsuario')";
						
						//Se crea query para insertar los datos en la extensión de la tabla temporal
						//a este query le falta el filtro de kadido que se agrega más adelante
						$sql_ext = "INSERT INTO ".$wbasedato."_000209
										( Medico , Fecha_data  , Hora_data  , Ekxhis, Ekxing, Ekxfec, Ekxart, Ekxido, Ekxest,    Ekxpro    ,    Ekxtra     ,     Ekxped     ,   Ekxin1     ,   Ekxin2     ,    Ekxayu     ,     Ekxaut     ,        Ekxjus       , Seguridad   )
									SELECT
										 b.Medico, b.Fecha_data, b.Hora_data, Kadhis, Kading, Kadfec, Kadart, Kadido, Kadest, '$profilaxis', '$tratamiento', '$esPediatrico', '$conInsumo1', '$conInsumo2', '$ccoAyudaDx', '$wdrautorizado', '$wjusparaautorizar', b.Seguridad
									FROM
										".$wbasedato."_000060 b
									WHERE
										Kadhis = '".$historia."'
										AND Kading = '".$ingreso."'
										AND Kadfec = '".$fechaKardex."'
										AND Kadart = '".$codArticulo."'
										";
					
						if(!$pacPaciente->enUrgencias){
					
							//Insertar medicamento en la tabla de medicamentos de alta.		
							$q_alta = "INSERT INTO ".$wbasedato."_000168
									(Medico  ,Fecha_data         ,    Hora_data      ,  Kadhis   , Kading   ,     Kadart   , Kadcfr     ,   Kadufr , Kaddia, Kadest,    Kadess    ,  Kadper,   Kadffa  , Kadfin, Kadhin, Kadvia,      Kadfec      , Kadcon, Kadobs,   Kadori        , Kadsus,   Kadcnd   , Kaddma    ,   Kadcan    ,     Kaduma    ,     Kadcma      , Kaddis, Kadhdi , Kadsal,      Kadcdi    ,   Kadpri   ,     Kadpro     ,        Kadcco          ,   Kadare     ,      Kadsad        , Kadnar          , Kadreg,   Kadusu    ,       Kadcpx        ,    Kadcal     ,  Kadimp    , Kadalt  ,    Kadusp    , Kadpen,    Kadctr    , Kadlev,   Kadfir, Seguridad)
								VALUES
									('movhos','".date("Y-m-d")."','".date("H:i:s")."','$historia','$ingreso','$codArticulo','$cantDosis','$unDosis','$dtto', 'on'  ,'$noDispensar',  '$per','$fmaFtica','$fini','$hini', '$via','".$fechaKardex."','$conf','$obs' ,'$origenArticulo',  'off','$condicion','$dosisMax','$cantGrabar','$unidadManejo','$cantidadManejo',  '0'  ,'00:00','$saldo','$cantDispensar','$prioridad','$tipoProtocolo','$centroCostosGrabacion','$artAprobado','$saldoDispensacion','$nombreArticulo',   ''  ,'$codUsuario','$horasAplicacionDia','$cantidadAlta','$impresion','on', '$codUsuario',  'on' ,       '$famControl','$esLQ', '$firma', 'A-$codUsuario')";
							
						}
						
						if(!existeEncabezadoKardex($historia,$ingreso,$fechaKardex)){	
							//Crea el encabezado del kardex si no existe.		
							crearEncabezadoKardexCerrar( $historia, $ingreso, $firma, 'off', $fechaKardex );
						}
						
						//Si articulo de lactio se crea su respectivo encabezado en caso de no existir
						if( $esArtLactario ){
							$auxCcoUsu = $usuario->centroCostosGrabacion;
							$usuario->centroCostosGrabacion = $ccoLac;
							if(!existeEncabezadoKardex($historia,$ingreso,$fechaKardex)){	
								//Crea el encabezado del kardex si no existe.		
								crearEncabezadoKardexCerrar( $historia, $ingreso, $firma, 'off', $fechaKardex, $ccoLac );
							}
							$usuario->centroCostosGrabacion = $auxCcoUsu;
						}
					
					}
					else			
					//Si el paciente es de urgencias y el medicamento es de alta insertara para el paciente.
					{			
						//Insertar medicamento en la tabla de medicamentos de alta.		
						$q_alta = "INSERT INTO ".$wbasedato."_000168
								(Medico  ,Fecha_data         ,    Hora_data      ,  Kadhis   , Kading   ,     Kadart   , Kadcfr     ,   Kadufr , Kaddia, Kadest,    Kadess    ,  Kadper,   Kadffa  , Kadfin, Kadhin, Kadvia,      Kadfec      , Kadcon, Kadobs,   Kadori        , Kadsus,   Kadcnd   , Kaddma    ,   Kadcan    ,     Kaduma    ,     Kadcma      , Kaddis, Kadhdi , Kadsal,      Kadcdi    ,   Kadpri   ,     Kadpro     ,        Kadcco          ,   Kadare     ,      Kadsad        , Kadnar          , Kadreg,   Kadusu    ,       Kadcpx        ,    Kadcal     ,  Kadimp    , Kadalt  ,    Kadusp    , Kadpen,    Kadctr    , Kadlev , Kadfir, Seguridad)
							VALUES
								('movhos','".date("Y-m-d")."','".date("H:i:s")."','$historia','$ingreso','$codArticulo','$cantDosis','$unDosis','$dtto', 'on'  ,'$noDispensar',  '$per','$fmaFtica','$fini','$hini', '$via','".$fechaKardex."','$conf','$obs' ,'$origenArticulo',  'off','$condicion','$dosisMax','$cantGrabar','$unidadManejo','$cantidadManejo',  '0'  ,'00:00','$saldo','$cantDispensar','$prioridad','$tipoProtocolo','$centroCostosGrabacion','$artAprobado','$saldoDispensacion','$nombreArticulo',   ''  ,'$codUsuario','$horasAplicacionDia','$cantidadAlta','$impresion','on', '$codUsuario',  'on' ,     '$famControl', '$esLQ','$firma','A-$codUsuario')";
					
						
						if(!existeEncabezadoKardex($historia,$ingreso,$fechaKardex)){
							//Crea el encabezado del kardex si no existe.		
							crearEncabezadoKardexCerrar( $historia, $ingreso, $firma, 'off', $fechaKardex );
						}
					
						//Si articulo de lactio se crea su respectivo encabezado en caso de no existir
						if( $esArtLactario ){
							$auxCcoUsu = $usuario->centroCostosGrabacion;
							$usuario->centroCostosGrabacion = $ccoLac;
							if(!existeEncabezadoKardex($historia,$ingreso,$fechaKardex)){	
								//Crea el encabezado del kardex si no existe.		
								crearEncabezadoKardexCerrar( $historia, $ingreso, $firma, 'off', $fechaKardex, $ccoLac );
							}
							$usuario->centroCostosGrabacion = $auxCcoUsu;
						}
					}
					
					$estado = "1";
				}
				else{
				
					$des = "*No se encontró artículo a actualizar*";
					$des .= "Kadart:$codArticulo,";
					$des .= "Kadfec:$fechaKardex,";
					$des .= "Kadhis:$historia,";
					$des .= "Kadhis:$historia,";
					$des .= "Kading:$ingreso,";
					$des .= "Kadpro:$tipoProtocolo,";
					$des .= "Kadfin:$fInicioAnt,";
					$des .= "Kadhin:$hInicioAnt,";
					$des .= "Kadido:$id_original";
					
					registrarAuditoriaCierreKardex( $historia, $ingreso, $codUsuario, $des );
					
					//Consulto el nombre generico del articulo
					$sql = "SELECT Artgen
							  FROM {$wbasedato}_000026
							 WHERE artcod = '$codArticulo'
							";
							
					$resGen = mysql_query( $sql, $conexion ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
					$rowGen = mysql_fetch_array( $resGen  );
					
					
					return "No se pudo actualizar el articulo $codArticulo - ".$rowGen[ 'Artgen' ];
				}
			}
			else{
				return "No puede crear medicamentos, favor cierre las ordenes y vuelva a intentarlo.";
			}
		}
		else {
			
			$esDA = consultarSiProductoDA($conexion,$wcenmez,$fila['Kadart']);
			if($fila['Kadori']=="CM" && $esDA)
			{
				// la dosis debe ser la dosis de movhos_000060 y no con el calculo de la dosis sin purga
				$cantDosis = $fila['Kadcfr'];
				$unDosis= $fila['Kadufr'];
				$fmaFtica = $fila['Kadffa'];
				
			}
			
			
			$fila['Kadobs'] = str_replace( "\\", "\\\\", $fila['Kadobs'] );	//Marzo 3 de 2011
			$fila['Kadobs'] = str_replace( "'", "\'", $fila['Kadobs'] );	//Marzo 3 de 2011
			
			$audAnterior = "A:".$fila['Kadart'].",".$fila['Kadcfr'].",".$fila['Kadufr'].",".$fila['Kadper'].",".$fila['Kadffa'].",".$fila['Kadfin'].",".$fila['Kadhin'].",".$fila['Kadvia'].",".$fila['Kadcon'].",".$fila['Kaddia'].",".$fila['Kadobs'].",".$fila['Kadori'].",".$fila['Kadcnd'].",".$fila['Kaddma'].",".$fila['Kadcan'].",".$fila['Kaduma'].",".$fila['Kadcma'].",".$fila['Kaddoa'].",".$fila['Kadnes'].",".$codUsuario;
			
			
			
			/********************************************************************************************************************************************
			 * Marzo 06 de 2012
			 * Si hay cambio en el medicamento, y tiene saldo, recalculo saldo
			 ********************************************************************************************************************************************/
			
			
			//Si no hubo cambio por fecha y hora de inicio dejo la ronda actual como la ronda antrior a la fecha y hora de inicio
			if( !$cambioFecHorInicio ){
				//Calculo ronda actual
				$auxfechaUnix = strtotime( "1970-01-01 00:00:00" );
				$rondaActual = intval( ( time()-$auxfechaUnix )/(2*3600) )*2*3600 + $auxfechaUnix;	//Ok
			}
			else{
				//Si hubo cambio dejo la ronda actual como la inmediamente anterior a la fecha y hora de inicio
				$rondaActual = strtotime( trim( $fini )." ".trim( $hini ) ) - 2*3600;
				// echo "\n...ronda Actual: ".date( "Y-m-d H:i:s", $rondaActual );
				// $fila[ 'Kadcan' ] = $cantGrabar;
			}
			
			$saldoDeDispensacionAnterior = $fila['Kadsad'];
			
			$fechaCorteActual = strtotime( "$fechaKardex $horaCorteDispensacion:00:00" );
			$fechaHoraInicioAnterior = strtotime( trim( $fInicioAnt )." ".trim( $hInicioAnt ) );
			
			$fechaHoraInicioActual = strtotime( trim( $fini )." ".trim( $hini ) );
			// $fechaHoraInicioActual = intval( ( time() - strtotime( "1970-01-01 00:00:00" ) )/2*3600 )*2*3600 + strtotime( "1970-01-01 00:00:00" );
			
			$auxHorasFrecuencia = consultarFrecuencia( $conexion, $wbasedato, $fila['Kadper'] );
			
			//Si es Modificado por fecha y hora, frecuencia o cantidad de dosis
			if( $fechaHoraInicioAnterior != $fechaHoraInicioActual //&& !empty( $fila['Kadsad'] ) 
				|| $fila['Kadper'] != $per
				|| $fila[ 'Kadcfr' ] != $cantDosis
			){
			
				
				//Consulto la ultima ronda de aplicacion de acuero a la fecha y hora de inicio nueva
				$ultimoSuministroDiaSiguienteNuevo = suministroAntesFechaCorte( date( "Y-m-d", strtotime( $fechaKardex." 00:00:00" )+24*3600 ), "$horaCorteDispensacion:00:00", trim( $fini ), trim( $hini ), $horasFrecuencia );
				
				//Calculo la fecha y hora final de terminacion de medicamento por dosis maximas
				if( !empty( $dosisMax ) ){
					$auxSN = $fechaHoraInicioActual + ($dosisMax-1)*$horasFrecuencia*3600;
					$ultimoSuministroDiaSiguienteNuevo = min( $auxSN, $ultimoSuministroDiaSiguienteNuevo );
				}
				
				//Calculo la fecha y hora final de terminacion de medicamento por dias de tratamiento
				if( !empty( $dtto ) ){
					$auxSN = strtotime( date( "Y-m-d 00:00:00", $fechaHoraInicioActual ) ) + ( $dtto )*24*3600;
					
					//Esto da el total de aplicaciones por dosis maximas
					$auxSN = intval( ( $auxSN - $ultimoSuministroDiaSiguienteNuevo )/( $horasFrecuencia*3600 ) );
					
					$auxSN = $fechaHoraInicioActual + ($auxSN)*$horasFrecuencia*3600;
					
					$ultimoSuministroDiaSiguienteNuevo = min( $auxSN, $ultimoSuministroDiaSiguienteNuevo );
				}
				
				//Resto el total de aplicaciones calculadas para saber la hora de inicio tomada inicialmente
				$fechorIniNuevo = $ultimoSuministroDiaSiguienteNuevo - ($cantGrabar-1)*$horasFrecuencia*3600; //Ok
				
				//Busco la hora de inicio real
				//Si se cambio la fecha y hora de inicio esa es la hora de cambio real
				if( $fechaHoraInicioAnterior != $fechaHoraInicioActual ){
					$ultimoSuministroDiaActualViejo = $fechaHoraInicioActual;
				}
				else{
					//Si no se cambio fecha y hora de inicio, es la siguiten hora de aplicacion para el medicamento
					
					//Calculo ronda actual
					// $auxfechaUnix = strtotime( "1970-01-01 00:00:00" );
					// $fechaHoraInicioActual = intval( ( time()-$auxfechaUnix )/(2*3600) )*2*3600 + $auxfechaUnix;	//Ok
					
					// //Calculo ronda actual
					// $auxfechaUnix = strtotime( "1970-01-01 00:00:00" );
					// $rondaActual = intval( ( time()-$auxfechaUnix )/(2*3600) )*2*3600 + $auxfechaUnix;	//Ok
					
					//Busco ultima hora de aplicacion antes de la ronda actual
					$ultimoSuministroDiaActualViejo = suministroAntesFechaCorte( date( "Y-m-d", $rondaActual ), date( "H:i:s", $rondaActual ), date( "Y-m-d", $fechaHoraInicioAnterior ), date( "H:i:s", $fechaHoraInicioAnterior ), $horasFrecuencia );
		

					//Si ultimoSuministroDiaActualViejo es falso significa que el medicamento comienza posterior a la ronda actual
					if( !$ultimoSuministroDiaActualViejo ){
						$ultimoSuministroDiaActualViejo = $fechaHoraInicioAnterior;
					}
					
					
					//Como esta era la aplicacion anterior a la ronda actual anterior, calculo la nuevo
					//Solo si es anterior a la ronda actual
					if( $rondaActual >= $ultimoSuministroDiaActualViejo ){
						$ultimoSuministroDiaActualViejo += $horasFrecuencia*3600;
					}
				}
				
				
				//Calculo la cantidad de aplicaciones hasta el día siguiente
				$cantAplicacionesReal = 0;
				if( $ultimoSuministroDiaSiguienteNuevo >= $ultimoSuministroDiaActualViejo ){	//Marzo 9 de 2012, no tenía el =, solo esta el >
					$cantAplicacionesReal = ( $ultimoSuministroDiaSiguienteNuevo - $ultimoSuministroDiaActualViejo )/($horasFrecuencia*3600) + 1;
					
					// echo "\n\n....cantAplicacionesReal = ( ultimoSuministroDiaSiguienteNuevo - ultimoSuministroDiaActualViejo )/(horasFrecuencia*3600) + 1;";
					// echo "\n\n....$cantAplicacionesReal = ( $ultimoSuministroDiaSiguienteNuevo - $ultimoSuministroDiaActualViejo )/($auxHorasFrecuencia*3600) + 1;";
				}
				
				//Calculo la cantidad necesaria hasta el dia siguiente
				$cantNecesariaHastaHoraCorteDiaSiguiente = ceil( $cantAplicacionesReal*($cantDosis/$cantidadManejo) );

				//Si hay diferencia esta pertenece al saldo de dispensacion
				$auxSaldoDispensacion = $cantNecesariaHastaHoraCorteDiaSiguiente - ( $cantDispensar - $saldoDeDispensacionAnterior );
				// echo "\n\n....auxSaldoDispensacion = cantNecesariaHastaHoraCorteDiaSiguiente - ( cantDispensar - saldoDeDispensacionAnterior );";
				// echo "\n....$auxSaldoDispensacion = $cantNecesariaHastaHoraCorteDiaSiguiente - ( $cantDispensar - $saldoDeDispensacionAnterior );";

				
				/*************************************************************************************************
				 * Calculo cuantas aplicaciones hay antes del cambio de parametros para el articulo
				 *************************************************************************************************/
				//Primero miro cuantas aplicaciones se dejaron de dispensar
				$totalAplicacionesPorSaldo = $saldoDeDispensacionAnterior/($fila[ 'Kadcfr' ]/$fila['Kadcma']);
				
				//Consulta las aplicaciones hasta el dia acutal a la hora de corte
				$ultimoSuministroHoyCorteDispensacion = suministroAntesFechaCorte( "$fechaKardex", "$horaCorteDispensacion:00:00", trim( $fila['Kadfin'] ), trim( $fila['Kadhin'] ), $auxHorasFrecuencia );
				
				//Resto el total de aplicaciones que hay por saldo
				$ultimoSuministroHoyCorteDispensacion = $ultimoSuministroHoyCorteDispensacion - ($totalAplicacionesPorSaldo-1)*$auxHorasFrecuencia*3600;	//Ok
				
				//Calculo cuantas aplicaciones estan por fuera del rango
				//fecha inicial de cambio y fecha final de corte dia actual
				$totAplicaciones = 0;
				
				// //Calculo ronda actual
				// $auxfechaUnix = strtotime( "1970-01-01 00:00:00" );
				// $rondaActual = intval( ( time()-$auxfechaUnix )/(2*3600) )*2*3600 + $auxfechaUnix;	//Ok
				
								
				//=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
				// Calculo cuantas aplicaciones hay antes del cambio de parametros para el articulo
				//
				// Calculando el saldo fijo del articulo
				//=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
				
				/**
				Lo forma de calculo es la siguiente:
				
				Calculo cuantas aplicaciones hay hasta el día siguiente a partir de la ronda actual hasta el día siguiente
				a este calculo le resto la cantidad calculada segun lo datos anteriores
				La diferencia de los dos los resto al saldo que aparece del articulo
				El resultado se tiene que dejar en el saldo, ya que el resultado indica cuanto saldo se debe dejar
				*/
				
				//Calculo ronda actual
				
				
				
				//Consulto las aplicaciones hasta la fecha y hora final de aplicacion
				//Esta es, hasta el día siguiente a la hora de cambio o segun la dosis maximas o dias de tratamiento
				$fechaFinalizacionMedicamento = strtotime( "$fechaKardex $horaCorteDispensacion:00:00" ) + 24*3600;
				
				//Si hay dosis maximas
				if( !empty( $fila['Kaddma'] ) ){
					$fechaFinalizacionMedicamento = min( $fechaHoraInicioAnterior + ($fila['Kaddma']-1)*$auxHorasFrecuencia*3600, 
														 $fechaFinalizacionMedicamento );
				}
				
				//fecha y hora de finalizacion del medicamento
				$ultimoSuministroFecHorFinalMed = suministroAntesFechaCorte( date( "Y-m-d" , $fechaFinalizacionMedicamento ), 
																		     date( "H:i:s", $fechaFinalizacionMedicamento ), 
																		     trim( $fila['Kadfin'] ), 
																		     trim( $fila['Kadhin'] ), 
																		     $auxHorasFrecuencia );
				
				//Ultimo suministro antes de la ronda actual
				$ultimoSuministroRondaActual = suministroAntesFechaCorte( date( "Y-m-d" , $rondaActual ), 
																		     date( "H:i:s", $rondaActual ), 
																		     trim( $fila['Kadfin'] ), 
																		     trim( $fila['Kadhin'] ), 
																		     $auxHorasFrecuencia );
				
				//Si es falso es por que la fecha de inicio del medicamento es posterior
				//por tanto debe se igual a la fecha de inicio del medicamento
				if( !$ultimoSuministroRondaActual ){
					$ultimoSuministroRondaActual = $fechaHoraInicioAnterior;
				}
																			 
				if( $ultimoSuministroRondaActual <= $rondaActual ){
					$ultimoSuministroRondaActual += $auxHorasFrecuencia*3600;
				}
				
				//Teniendo la fecha final de medicamentos Calculo el total de aplicaciones desde la ronda actual hasta
				//fecha finalizacion de medicamentos
				$totAplAux = 0;
				// echo "\n.....ultimoSuministroFecHorFinalMed: ".date( "Y-m-d H:i:s", $ultimoSuministroFecHorFinalMed );
				// echo "\n.....ultimoSuministroRondaActual: ".date( "Y-m-d H:i:s", $ultimoSuministroRondaActual );
				if( $ultimoSuministroFecHorFinalMed >= $ultimoSuministroRondaActual && $ultimoSuministroRondaActual >= $fechaHoraInicioAnterior ){
					$totAplAux = ( $ultimoSuministroFecHorFinalMed - $ultimoSuministroRondaActual )/($auxHorasFrecuencia*3600) + 1;
					// echo "\n\n....totAplAux";
					// echo "\n....$totAplAux";
				}
				
				// echo "\n\n....1: totAplAux";
				// echo "\n....2: $totAplAux";
				
				// $totalArticulosAux = $totAplAux*$fila[ 'Kadcfr' ]/$fila[ 'Kadcma' ];
				
				$totalArticulosAux = ( $totAplAux - $fila[ 'Kadcan' ] )*$fila[ 'Kadcfr' ]/$fila[ 'Kadcma' ];
				// echo "\n\ntotalArticulosAux = ( totAplAux - fila[ 'Kadcan' ] )*{fila[ 'Kadcfr' ]/fila[ 'Kadcma' ];";
				// echo "\n$totalArticulosAux = ( $totAplAux - {$fila[ 'Kadcan' ]} )*{$fila[ 'Kadcfr' ]}/{$fila[ 'Kadcma' ]};";

				$auxSaldoCant = ceil( $fila[ 'Kadsad' ] - $totalArticulosAux );
				// $auxSaldoCant = $fila[ 'Kadsad' ] - ( $totalArticulosAux - ( $fila[ 'Kadcdi' ] - $fila[ 'Kadsad' ] ) );
				
				// echo "\n\n....auxSaldoCant = ceil( fila[ 'Kadsad' ] - totalArticulosAux )";
				// echo "\n....$auxSaldoCant = ceil( {$fila[ 'Kadsad' ]} - $totalArticulosAux )";
				
				//Si este saldo es negativo significa que ya habían dispensado esa cantidad
				if( $auxSaldoCant < 0 ){
				
					$fila[ 'Kaddis' ] += abs($auxSaldoCant);
					$auxSaldoCant = 0;
				}
				// echo "\n....dis1: ".$fila[ 'Kaddis' ];
				//=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
			
				
				/********************************************************************************/
				
				
				
				//Si la dispensacion es negativa significa ese valor pertenece al saldo de dispensacion del dia anterior
				if( $fila['Kaddis'] < 0 ){
					// $saldoDeDispensacionAnterior += $fila['Kaddis']*(-1);
					$fila['Kaddis'] = 0;
				}
				
				$saldoDeDispensacionAnterior = $auxSaldoCant + $auxSaldoDispensacion;
				// echo "\n\n....saldoDeDispensacionAnterior = auxSaldoCant + auxSaldoDispensacion";
				// echo "\n....$saldoDeDispensacionAnterior = $auxSaldoCant + $auxSaldoDispensacion";
			}
			/********************************************************************************************************************************************/

			
			/********************************************************************************************************************************************
			 * Julio 15 de 2011
			 * 
			 * Si se ha cambiado la frecuencia, o la dosis, o la fecha y hora de inicio se cambia el campo kadcpx
			 ********************************************************************************************************************************************/
			if( tieneCpxPorHistoria( $conexion, $wbasedato, $historia, $ingreso ) ){
			
				//Busco la cantidad no cargada ayer
				$sinCargarAnterior = "";
				$fila['Kadcpx'] = trim($fila['Kadcpx']);
				if( !empty( $fila['Kadcpx'] ) ){
					$exp1 = explode( ",", $fila['Kadcpx'] );
					$exp2 = explode( "-", $exp1[0] );
					
					if( $exp2[0] == "Ant" ){
						$sinCargarAnterior = "Ant-".$exp2[1]."-0,";
					}
				}

				if( ( trim( $fInicioAnt ) != trim($fini) || ( trim( $fInicioAnt ) == trim( $fini ) && trim( $hini ) != trim( $hInicioAnt ) ) ) //Verificando cambio de fecha y hora de inicio
					|| $fila['Kadcfr'] != $cantDosis	//verifico si se cambio la cantidad de dosis
					|| $fila['Kadper'] != $per			//verifico frecuencia diferente
					|| $fila['Kadcma'] != $cantidadManejo			//verifico cantidad de manejo
				){
					$horasAplicacionDia = "";
					$fila['Kadron'] = '';
					$fila['Kadfro'] = '';
					
					
					
					/****************************************************************************************************************
					 * creando string con las aplicaciones de las hora 
					 * @var unknown_type
					 ****************************************************************************************************************/
					$info = consultarinfotipoarticulosKardex( $conexion, $wbasedato );
					
					//Creando la regleta
					$vectorAplicacion = obtenerVectorAplicacionMedicamentos( $fechaKardex, trim( $fini ), $hini, $horasFrecuencia );
					$vectorAplicacion2 = obtenerVectorAplicacionMedicamentos( date( "Y-m-d", strtotime( $fechaKardex." 00:00:00" )+24*3600 ), trim( $fini ), $hini, $horasFrecuencia );
					$vectorAplicacion2 = arreglarVectorKardex( $vectorAplicacion2 );

					$quitarUnoARegleta = 25;
					if( count($vectorAplicacion2) == 25 ){
						$quitarUnoARegleta = 24;
					}			
					
					foreach( $vectorAplicacion2 as $keyB => $valueB ){
						$vectorAplicacion[$quitarUnoARegleta] = $valueB;
						$quitarUnoARegleta++;
					}
									
					$horasAplicacionDia = crearVectorAplicaciones( $vectorAplicacion, $info[ $tipoProtocolo ]['tiempoPreparacion'], $cantDosis/$cantidadManejo, intval( ( strtotime( "1970-01-01 ".$info[ $tipoProtocolo ]['horaCaroteDispensacion'] ) - strtotime( "1970-01-01 00:00:00" ) )/3600 ) );
					
					
					
					/****************************************************************************************************************************************************************
					 * Septiembre 20 de 2011
					 *
					 * Consulto cuanto es cantidad de dosis que se deben cargar al paciente
					 *
					 * Reglas
					 * - Si no se modifica fecha y hora de inicio significa que cualquier dosis antes de la hora actual se debe quedar como cargada
					 * - Se debe sumar al cantidad a dispensar (cdi) la cantidad dispensada (dis) que hay hasta el momento 
					 ****************************************************************************************************************************************************************/

					if( $rondaActual < strtotime( date( "Y-m-d 00:00:00" ) ) ){
						$rondaActual = strtotime( date( "Y-m-d 00:00:00" ) );
					}
					
					if( !( trim( $fInicioAnt ) != trim( $fini ) || ( trim( $fInicioAnt ) == trim( $fini ) && trim( $hini ) != trim( $hInicioAnt ) ) ) ){ //Si no han modificado fecha y hora de inicio
						//Consultar ultima ronda que pudo ser cargada segun la hora actual
						$ultimaRonda = ( intval( date( "H", $rondaActual )/2 )*2 );
					}
					else{
						//Busco la hora de inicio nueva
						list( $ultimaRonda ) = explode( ":", $hini );
						// $fini = trim( $fini );
						if( trim( $fini ) == date( "Y-m-d", $rondaActual ) ){	//Si la fecha de inicio es la misma que la actual
						
							if( $ultimaRonda > date( "H", $rondaActual ) ){	//Si la hora de inicio es mayor a la actual
								
								$ultimaRonda = ( intval( date( "H", $rondaActual )/2 )*2 );	//Dejo la ultima hora par como hora de cambio								
							}
							else{	//Si la hora de inicio es antes a la actual
								$ultimaRonda -= 2;	//Quito dos horas, esto por que la hora de inicio puede tener medicamentos a favor para la nueva hora
							}
						}
						else{	//Si la fecha de inicio es en otro dia
							
							//Consultar ultima ronda que pudo ser cargada segun la hora actual
							$ultimaRonda = ( intval( date( "H", $rondaActual )/2 )*2 );
						}
					}
					
					//Creo la hora correctamente en formato hora:min:seg
					if( $ultimaRonda >= 10 ){
						$ultimaRonda = $ultimaRonda.":00:00";
					}
					else{
						$ultimaRonda = "0".$ultimaRonda.":00:00";
					}
					
					if( date( "H", $rondaActual ) >= 2 ){
					
						//Busco si hay posibles cantidades cargadas despues de la hora actual						
						//Busco la cantidad total cargada durante el dia segun la regleta anterior
						$cantidadCargada = calcularCantidadTotalDispensadaPorDia( $fila['Kadcpx'] );
						
						//Busco la cantidad cargada hasta la ronda actual calculada
						$cantidadCargadaHastaRonda = cantidadTotalDispensadaRonda( $fila['Kadcpx'], $ultimaRonda );
						
						//Esta diferencia indica cuanto hay para cargar a la nueva regleta
						$saldoRegletaAnterior = $cantidadCargada - $cantidadCargadaHastaRonda;
						
						//Consulto cuanto es la cantidad total a dispensar hasta la ultima ronda
						$cantidadTotalADispensar = cantidadTotalADispensarRonda( $horasAplicacionDia, $ultimaRonda );
						
						$totalACargar = $cantidadTotalADispensar + $saldoRegletaAnterior;
						
						$fila['Kaddis'] = intval( $totalACargar );
						/****************************************************************************************************************************************************************/
						
						//Dejando la cantidad pedida del dia anterior como estaba
						$horasAplicacionDia = $sinCargarAnterior.$horasAplicacionDia;
					}
					else{
						$totalACargar = cantidadTotalDispensadaRonda( $fila['Kadcpx'], $ultimaRonda );
					}
						
					//Dejando la regleta con la cantidad dispensada
					//$horasAplicacionDia = crearAplicacionesCargadasPorHorasKardex( $horasAplicacionDia, $fila['Kaddis'] );
					$horasAplicacionDia = crearAplicacionesCargadasPorHorasKardex( $horasAplicacionDia, $totalACargar );
					
					list( $fila['Kadron'], $fila['Kadfro'] ) = explode( "|", consultarUltimaRondaDispensadaKardex( $horasAplicacionDia ) );
					
					/**************************************************************************************************************
					 * Noviembre 1 de 2011
					 **************************************************************************************************************/
					if( !empty( $fila['Kadron'] ) ){
						
						if( empty( $fila['Kadfro'] ) ){
							$fila['Kadfro'] = date( "Y-m-d", strtotime( trim( $fechaKardex )." 00:00:00" ) + 3600*24 );
						}
						else{
							$fila['Kadfro'] = $fechaKardex;
						}
					}
					/**************************************************************************************************************
					 * Fin de noviembre 1
					/**************************************************************************************************************/
					/********************************************************************************/
				}
				else{
					$horasAplicacionDia = $fila['Kadcpx'];
				}
			}
			else{
				$horasAplicacionDia = '';				
			}
			/********************************************************************************************************************************************/
			
			/************************************************************************************************************************************
			 * Febrero 20 de 2012
			 *
			 * Si la cnatidad de dosis fue modificada, guardo la ultima cantidad de dosis y la fecha y hora de modificacion
			 ************************************************************************************************************************************/
			if( $fila[ 'Kadcfr' ] != $cantDosis ){
				$cantidadDosisAnterior = $fila[ 'Kadcfr' ];
				$fechaUltimaModificacion = date( "Y-m-d" );
				$horaUltimaModificacion = date( "H:i:s" );
			}
			else{
				$cantidadDosisAnterior = $fila[ 'Kaddan' ];
				$fechaUltimaModificacion = $fila[ 'Kadfum' ];
				$horaUltimaModificacion = $fila[ 'Kadhum' ];
			}
			/************************************************************************************************************************************/
			
			/************************************************************************************************************************************
			 * Febrero 23 de 2012
			 *
			 * Si cambia la frecuencia, registro la frecuencia anterior y la fecha y hora de cambio
			 ************************************************************************************************************************************/
			if( $fila['Kadper'] != $per ){
				$frecuenciaAnterior = $fila[ 'Kadper' ];
				$fcFrecuencia = date( "Y-m-d" );
				$hcFrecuencia = date( "H:i:s" );
			}
			else{
				$frecuenciaAnterior = $fila[ 'Kadfra' ];
				$fcFrecuencia = $fila[ 'Kadfcf' ];
				$hcFrecuencia = $fila[ 'Kadhcf' ];
			}
			/************************************************************************************************************************************/
			
			// $saldoDeDispensacionAnterior = -1000;
			if( $saldoDeDispensacionAnterior < 0 ){
				$cantDispensar += abs( $saldoDeDispensacionAnterior );
				$saldoDeDispensacionAnterior = 0;
			}
			
			// $fila['Kaddis'] = -1000;
			if( !empty($fila['Kaddis']) && $fila['Kaddis'] < 0  ){
				$fila['Kaddis'] = 0;
			}
			
			// $cantDispensar = -1000;
			if( $cantDispensar < 0 ){
				$cantDispensar = 0;
			}
				
			// echo "...dis an update: {$fila['Kaddis']}";
			
			
			
			/************************************************************************
			 * Mayo 23 de 2012
			 ************************************************************************/
			if($dispensable == 'off' || $noDispensar == 'on'){
				$cantGrabar = 0;
				$saldo = 0;
				$cantDispensar = 0;
				$saldoDeDispensacionAnterior = 0;
			}
			/************************************************************************/
			
			//Se verifica si el usuario puede firmar, si es asi se actualizara la firma para el paciente 
			$puedeFirmar = puedeFirmarPorCodigo( $conexion, $whce, $codUsuario );
			$array_datos_firma = explode("-", $puedeFirmar);
			$estado_firma = $array_datos_firma[0];
			$firma_encriptada = $array_datos_firma[1];
			
			$strKadusu = "";
			$strKadfir = "";
			if( $estado_firma == 'on' ){
				$strKadusu = " Kadusu = '$codUsuario', ";
				$strKadfir = " Kadfir = '$firma_encriptada', ";
			}
			
			//Verifico que el articulo a actualizar no exista en la tabla definitiva
			//De ser así se elimina de la tabla definitiva y se deja en el log(tabla aud_cierre_kardex)
			verificarRegistroEnDefinitiva( $conexion, $wbasedato, $historia, $ingreso, $codArticulo, $fechaKardex, $hInicioAnt, $fInicioAnt, $id_original, $codUsuario );
			
			//Busco el codigo para articulo modificado
			$q_log_m = "SELECT Logcod
						  FROM ".$wbasedato."_000174
						 WHERE Logmod = 'on'
						   AND Logest = 'on'";
			$res_log_m = mysql_query($q_log_m, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q_log_m . " - " . mysql_error());
			$row_log_m = mysql_fetch_array($res_log_m);
			$cod_modificacion = $row_log_m['Logcod'];
			
			$obs = mysqli_real_escape_string($conexion,$obs);
			
			//Junio 14 de 2012. No actulizo el cco del articulo
			$q = "UPDATE ".$wbasedato."_000060 SET
					Kadcfr = '$cantDosis',
					Kadufr = '$unDosis',
					Kaddia = '$dtto',
					Kadper = '$per',
					Kadcnd = '$condicion',
					Kadffa = '$fmaFtica',
					Kadfin = '$fini',
					Kadhin = '$hini',
					Kadvia = '$via',
					Kaddma = '$dosisMax',
					Kadcon = '$conf',
					Kadcan = '$cantGrabar',
					Kaduma = '$unidadManejo',
					Kadcma = '$cantidadManejo',
					Kadobs = '$obs',
					Kadpri = '$prioridad',
					Kadsal = '$saldo',
					Kadcdi = '$cantDispensar',
					Kadess = '$noDispensar',
					Kadare = '$artAprobado', 
					Kadcpx = '$horasAplicacionDia',
					Kadron = '{$fila['Kadron']}',
					Kadfro = '{$fila['Kadfro']}',
					Kaddis = '{$fila['Kaddis']}',
					$strKadusu
					$strKadfir
					Kaddan = '$cantidadDosisAnterior',
					Kadfum = '$fechaUltimaModificacion',
					Kadhum = '$horaUltimaModificacion',
					Kadsad = '$saldoDeDispensacionAnterior',
					Kadfra = '$frecuenciaAnterior',
					Kadfcf = '$fcFrecuencia',
					Kadhcf = '$hcFrecuencia',
					Kadcal = '$cantidadAlta',
					Kadimp = '$impresion',
					Kaddoa = '$artdosisAdaptada',
					Kadnes = '$artnoEsteril',
					Kadlog = '$cod_modificacion'
				WHERE
					Kadhis = '$historia'
					AND Kading = '$ingreso'
					AND Kadart = '$codArticulo'
					AND Kadfec = '$fechaKardex'
					AND Kadhin = '$hInicioAnt'
					AND Kadpro = '$tipoProtocolo'
					AND Kadfin = '$fInicioAnt'
					AND Kadido = '$id_original'
					";
					
			//Se crea query para insertar los datos en la extensión de la tabla temporal
			//a este query le falta el filtro de kadido que se agrega más adelante
			$sql_ext = "UPDATE ".$wbasedato."_000209
						   SET Ekxpro = '".$profilaxis."',
							   Ekxtra = '".$tratamiento."'
						WHERE
							Ekxhis = '".$historia."'
							AND Ekxing = '".$ingreso."'
							AND Ekxfec = '".$fechaKardex."'
							AND Ekxart = '".$codArticulo."'
							AND Ekxido = '".$id_original."'
						";

			$estado = "2";
			
			
			//Actualiza la tabla de medicamentos de alta
			$q_alta = "UPDATE ".$wbasedato."_000168 SET
					Kadcfr = '$cantDosis',
					Kadufr = '$unDosis',
					Kaddia = '$dtto',
					Kadper = '$per',
					Kadcnd = '$condicion',
					Kadffa = '$fmaFtica',
					Kadfin = '$fini',
					Kadhin = '$hini',
					Kadvia = '$via',
					Kaddma = '$dosisMax',
					Kadcon = '$conf',
					Kadcan = '$cantGrabar',
					Kaduma = '$unidadManejo',
					Kadcma = '$cantidadManejo',
					Kadobs = '$obs',
					Kadpri = '$prioridad',
					Kadsal = '$saldo',
					Kadcdi = '$cantDispensar',
					Kadess = '$noDispensar',
					Kadare = '$artAprobado', 
					Kadcpx = '$horasAplicacionDia',
					Kadron = '{$fila['Kadron']}',
					Kadfro = '{$fila['Kadfro']}',
					Kaddis = '{$fila['Kaddis']}',
					$strKadusu
					$strKadfir
					Kaddan = '$cantidadDosisAnterior',
					Kadfum = '$fechaUltimaModificacion',
					Kadhum = '$horaUltimaModificacion',
					Kadsad = '$saldoDeDispensacionAnterior',
					Kadfra = '$frecuenciaAnterior',
					Kadfcf = '$fcFrecuencia',
					Kadhcf = '$hcFrecuencia',
					Kadcal = '$cantidadAlta',
					Kadimp = '$impresion'
				WHERE
					Kadhis = '$historia'
					AND Kading = '$ingreso'
					AND Kadart = '$codArticulo'
					AND Kadfec = '$fechaKardex'
					AND Kadhin = '$hInicioAnt'
					AND Kadpro = '$tipoProtocolo'
					AND Kadfin = '$fInicioAnt'";

			$estado = "2";

			//Si el articulo esta completamente dispensado y la fecha y hora de inicio cambian, se muestra un mensaje de sobrante o faltante
			if(($fInicioAnt != $fila['Kadfin'] && $hInicioAnt != $fila['Kadhin']) && $fila['Kaddis'] == $fila['Kadcdi']){
				$estado = "4*".$fila['Kaddis']."*".$fila['Kadcdi'];
			}
		}
		
		$actTemporal = false;
		$idOriginal = false;
		//Si la pestaña no es de alta inserta el articulo, y si es paciente no es de urgencias inserta el medicamento en el detalle de alta.
		if($deAlta != 'on'){
						
			$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
			
			if( $estado == "1" ){
				$idOriginal = mysql_insert_id();
			}
			
			//Si es articulo nuevo y si es de nutricion, queda marcado como leido para que salga en el perfil.
			if( $esArticuloNutricion and $estado == "1" /*$id_original == 0*/ ){
			
				$fecha = date( "Y-m-d" );
				$hora = date( "H:i:s" );
				
				//Marco los campos como leídos ya que es un medicamento nutricion.
				$sql = " UPDATE ".$wbasedato."_000060
							SET Kadpen = 'off',
								Kadule = '$codUsuario',
								Kadfle = '$fecha',
								Kadhle = '$hora',
								Kadido = '$idOriginal'
						  WHERE Kadhis = '$historia'
							AND Kading = '$ingreso'
							AND Kadart = '$codArticulo'
							AND Kadfec = '$fechaKardex'
							AND Kadhin = '$hini'
							AND Kadpro = '$tipoProtocolo'
							AND Kadfin = '$fini'
							AND id = '$idOriginal'
							";		
							
				$res = mysql_query( $sql, $conexion ) or die( mysql_error()." - Error en el query $sql - ".mysql_errno() );
			}

			if( mysql_affected_rows() > 0 ){
				$actTemporal = true;
			}
			
			if(!$pacPaciente->enUrgencias){
			
				//Insertar medicamento en la tabla de medicamentos de alta.		
				$res_alta = mysql_query($q_alta, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q_alta . " - " . mysql_error());
			
			}
		
		//Si la pestaña es de alta siempre se inserta.		
		}
		else{
		
			//Insertar medicamento en la tabla de medicamentos de alta.		
			$res_alta = mysql_query($q_alta, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q_alta . " - " . mysql_error());
		
		}
		
		
		if( $estado == "1" ){
			
			if( $idOriginal !== false && $actTemporal ){
				
				// $idOriginal = mysql_insert_id();
				
				//Busco el codigo para articulo nuevo
				$q_log_n = "SELECT Logcod
							FROM ".$wbasedato."_000174
							WHERE Lognue = 'on'
							  AND Logest = 'on'";
				$res_log_n = mysql_query($q_log_n, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q_log_n . " - " . mysql_error());
				$row_log_n = mysql_fetch_array($res_log_n);
				$cod_log_nuevo = $row_log_n['Logcod'];
				
				$sql = "UPDATE ".$wbasedato."_000060 
						SET
							kadido = '$idOriginal', kadlog = '$cod_log_nuevo'
						WHERE
							id = '$idOriginal'
						";
				
				$res = mysql_query($sql, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error() );
				
				/*************************************************************************************************************************************************
				 * Julio 5 de 2016
				 *************************************************************************************************************************************************/
				//Inserto los datos necesario de la tabla extendida
				//Agrego el filtro que hace falta para la extensión
				$sql_ext .= " AND Kadido = '".$idOriginal."' ";
				$res = mysql_query ( $sql_ext, $conexion ) or die  ( "Error: " . mysql_errno() . " - en el query: " . $sql_ext . " - " . mysql_error() );
				/************************************************************************************************************************************************/
			}
		}
		else{
			$idOriginal = $fila[ 'Kadido' ];
			
			if( $actTemporal ){
			
				//Junio 14 de 2012. No actulizo el cco del articulo
				$q = "UPDATE ".$wbasedato."_000060 SET
						Kadusp = '$codUsuario',
						Kadpen = 'on',
						Kadule = '',
						Kadfle = '0000-00-00',
						Kadhle = ''
					WHERE
						Kadhis = '$historia'
						AND Kading = '$ingreso'
						AND Kadart = '$codArticulo'
						AND Kadfec = '$fechaKardex'
						AND Kadhin = '$hini'
						AND Kadpro = '$tipoProtocolo'
						AND Kadfin = '$fini'
						AND Kadido = '$id_original'
					";
						
				$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error() );
			}
			else{
				$des = "*No se actualizo articulo*";
				$des .= "Kadart:$codArticulo,";
				$des .= "Kadfec:$fechaKardex,";
				$des .= "Kadhis:$historia,";
				$des .= "Kadhis:$historia,";
				$des .= "Kading:$ingreso,";
				$des .= "Kadpro:$tipoProtocolo,";
				$des .= "Kadfin:$fInicioAnt,";
				$des .= "Kadhin:$hInicioAnt,";
				$des .= "Kadido:$id_original";
				
				registrarAuditoriaCierreKardex( $historia, $ingreso, $codUsuario, $des );					
			}
			
			/*************************************************************************************************************************************************
			 * Julio 5 de 2016
			 *************************************************************************************************************************************************/
			//Inserto los datos necesario de la tabla extendida
			//Agrego el filtro que hace falta para la extensión
			$res = mysql_query ( $sql_ext, $conexion ) or die  ( "Error: " . mysql_errno() . " - en el query: " . $sql_ext . " - " . mysql_error() );
			/************************************************************************************************************************************************/
		}

		$audNuevo = "N:$codArticulo,$cantDosis,$unDosis,$per,$fini,$hini,$via,$conf,$dtto,$obs,$origenArticulo,$condicion,$dosisMax,$cantGrabar,$cantidadManejo,$artdosisAdaptada,$codUsuario";

		$mensajeAuditoria = "";
		switch ($estado){
			case "1":
				$mensajeAuditoria = obtenerMensaje('MSJ_ARTICULO_CREADO');
				break;
			case "2":
				$mensajeAuditoria = obtenerMensaje('MSJ_ARTICULO_ACTUALIZADO');
				break;
			default:
				$mensajeAuditoria = obtenerMensaje('MSJ_ARTICULO_ACTUALIZADO');
				break;
		}

		//Registro de auditoria
		$auditoria = new AuditoriaDTO();

		$auditoria->historia = $historia;
		$auditoria->ingreso = $ingreso;
		$auditoria->descripcion = "$audAnterior \n\n$audNuevo";
		$auditoria->fechaKardex = $fechaKardex;
		$auditoria->mensaje = $mensajeAuditoria;
		$auditoria->seguridad = $codUsuario;
		$auditoria->idOriginal = $idOriginal;

		registrarAuditoriaKardex($conexion,$wbasedato,$auditoria);

		/******************************************
		 * 	MOVIMIENTOS DEL CTC
		 ******************************************/
		$q2 = "SELECT Ctccau,Ctccus,Ctcuca FROM {$wbasedato}_000095 WHERE Ctchis = '".$historia."' AND Ctcing = '".$ingreso."' AND Ctcart = '".$codArticulo."'";
		$res2 = mysql_query($q2, $conexion) or die ("Error: " . mysql_errno() . " - en el query: $q2 - " . mysql_error());

		while($info2 = mysql_fetch_array($res2)){
			$cantidadAutorizadaCtc 	= $info2['Ctccau'];
			$cantidadUtilizadaCtc 	= consultarCantidadAcumuladaDispensada($conexion,$wbasedato,$historia,$ingreso,$codArticulo);
			$unidadesCantidadesCtc 	= $info2['Ctcuca'];

			//****************************Actualizacion de datos CTC
			$q3 = "UPDATE {$wbasedato}_000095 SET Ctccus = '$cantidadUtilizadaCtc' WHERE Ctchis = '".$historia."' AND Ctcing = '".$ingreso."' AND Ctcart = '".$codArticulo."'";
			$res3 = mysql_query($q3, $conexion) or die ("Error: " . mysql_errno() . " - en el query: $q3 - " . mysql_error());
			//***************************
		}
		//***************************

		//liberarConexionBD($conexion);
	} else {
		$estado = "3";
	}
	return $estado."*".$idOriginal."*".( $cambioFecHorInicio ? "1" : "0" )."*".$fini."*".$hini;
}


function consultarAlergias($historia,$ingreso,$fecha){
	global $wbasedato;
	global $conex;

	$coleccion = array();

	$q = "SELECT
			Fecha_data,Karale
		FROM 
			".$wbasedato."_000053
		WHERE 
			Karhis = '$historia'
			AND Karing = '$ingreso'
			AND Fecha_data < '$fecha'
			AND Karale != ''
		GROUP BY Karale";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	if ($num > 0)
	{
		$cont1 = 0;

		while ($cont1 < $num){
			$cont1++;

			$registro = new RegistroGenericoDTO();

			$info = mysql_fetch_array($res);

			$registro->codigo = $historia."-".$ingreso;
			$registro->descripcion = $info['Fecha_data'];
			$registro->observacion = $info['Karale'];

			$coleccion[] = $registro;
		}
	}
	return $coleccion;
}

function grabarArticuloDetallePerfil($wbasedato,$historia,$ingreso,$fechaKardex,$codArticulo,$dtto,$obs,$codUsuario,$via,$dosisMaximas,$prioridad,$fechaInicio,$horaInicio,$autorizadoCtc){
	$conexion = obtenerConexionBD("matrix");

	$estado = "0";
	$audAnterior = "";
	$audNuevo = "";

	//Primero verifico si ya existe el artículo en el detalle del kardex para saber si es insert o update
	$q = "SELECT
				Kadart, Kaddia, Kadobs, Kadvia, Kaddma, Kaduma, Kadcdi
			FROM
				".$wbasedato."_000054
			WHERE
				 Kadhis = '$historia'
				 AND Kading = '$ingreso'
				 AND Kadart = '$codArticulo'";

	$res 	= mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$fila 	= mysql_fetch_array($res);
	$num 	= mysql_num_rows($res);

	//Si existe el registro ACTUALIZO caso contrario INSERTO
	if($num > 0){
		$audAnterior = "A:".$fila['Kadart'].",".$fila['Kaddia'].",".$fila['Kadobs'].",".$fila['Kadvia'].",".$fila['Kaddma'].",".$fila['Kadpri'];
		
		/**********************************************************************************
		* Septiembre 20 de 2012
		*
		* Si hay días de tratamiento se convierten a dosis máxima. Los días de tratamiento deben
		* contar desde la hora de inicio del medicamento
		*
		*
		* Modificado: Octubre 25 de 2012. quito dosis adicional
		**********************************************************************************/
	   if( !empty( $dtto ) ){
			   
			   //Convierto los días de tratamiento a dosis máxima
			   // $dosisMax = floor( ($dtto*24)/$horasFrecuencia ) + 1;        //El adicional de uno es debido a que debe contar la dosis inicial
			   $dosisMax = floor( ($dtto*24)/$horasFrecuencia );        //Octubre 25 de 2012
			   
			   $dtto = '';
	   }
	   /**********************************************************************************/
		
		/************************************************************************************************************************
		 * Noviembre 16 de 2011
		 * Se pretende recalcular la cantidad a pedir de acuerdo a la dosis maxima
		 * Nota: copia del codigo que se encuentra en la funcion calcularSaldoActual con fecha de Enero 05 de 2011
		 ************************************************************************************************************************/
		//calcularSaldoActual($conexion,$wbasedato,$historia,$ingreso,$fechaKardex,$codArticulo,$fInicioAnt ,$hInicioAnt,    $cantDosis ,$horasFrecuencia                                            ,   $dosisMax ,( empty( $fila['Kadori'] ) )? $origenArticulo: $fila['Kadori'],$diasTtoAcumulados+1,&$cantGrabar,&$saldo,&$cantDispensar,&$cantidadManejo,$fila['Kadsad'], $tipoProtocolo ,$horasAplicacionDia, $fila['Kadreg'] );
		  calcularSaldoActual($conexion,$wbasedato,$historia,$ingreso,$fechaKardex,$codArticulo,$fechaInicio,$horaInicio,$fila['Kadcfr'], consultarFrecuencia( $conexion,$wbasedato,$fila['Kadper'] ),$dosisMaximas,$fila['Kadori']                                               ,$dtto+1             ,$cantGrabar,$saldo,$cantDispensar,$fila['Kadcma'],$fila['Kadsad'], $fila['Kadpro'],$horasAplicacionDia, $dtto, $fila['Kadreg'] );
		  
		/************************************************************************************************************************/

		$q = "UPDATE ".$wbasedato."_000054 SET
				Kaddia = '$dtto',
				Kadobs = '$obs',
				Kaddma = '$dosisMaximas',
				Kadvia = '$via',
				Kadpri = '$prioridad',
				Kadcan = '$cantGrabar',
				Kadcdi = '$cantDispensar'
			WHERE
				Kadhis = '$historia'
				AND Kading = '$ingreso'
				AND Kadart = '$codArticulo'
				AND Kadfec = '$fechaKardex'
				AND Kadfin = '$fechaInicio'
				AND Kadhin = '$horaInicio'";

		$estado = "2";
	}
	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

	//Generación de auditoria cambio / creación
	$audNuevo = "N:".$codArticulo.",".$dtto.",".$obs.",".$obs.",".$via.",".$dosisMaximas.",$autorizadoCtc";

	$mensajeAuditoria = "";

	switch ($estado){
		case "2":
			$mensajeAuditoria = obtenerMensaje('MSJ_ARTICULO_MODIFICADO_DESDE_PERFIL');
			break;
		default:
			$mensajeAuditoria = obtenerMensaje('MSJ_ARTICULO_NO_MODIFICADO_DESDE_PERFIL');
			break;
	}

	//Registro de auditoria
	$auditoria = new AuditoriaDTO();

	$auditoria->historia = $historia;
	$auditoria->ingreso = $ingreso;
	$auditoria->descripcion = "$audAnterior $audNuevo";
	$auditoria->fechaKardex = $fechaKardex;
	$auditoria->mensaje = $mensajeAuditoria;
	$auditoria->seguridad = $codUsuario;
	$auditoria->idOriginal = $fila['Kadido'];

	registrarAuditoriaKardex($conexion,$wbasedato,$auditoria);

	//Movimiento de CTC
	$estado2 = "";

	//Actualizacion del valor disponible de ctc
	if(isset($autorizadoCtc) && !empty($autorizadoCtc)){
		$cantidadUsadaCtc = consultarCantidadAcumuladaDispensada($conexion,$wbasedato,$historia,$ingreso,$codArticulo);

		$q4 = "SELECT * FROM ".$wbasedato."_000095 WHERE Ctchis = '$historia' AND Ctcing = '$ingreso' AND Ctcart = '$codArticulo';";
		$res4 = mysql_query($q4, $conexion) or die ("Error: ".mysql_errno()." - en el query: $q4 - ".mysql_error());
		$num4 = mysql_num_rows($res4);

		if($num4 > 0){
			$q2 = "UPDATE ".$wbasedato."_000095 SET
				   	Ctccau = '$autorizadoCtc',
					Ctccus = '$cantidadUsadaCtc'
				WHERE
					Ctchis = '$historia'
					AND Ctcing = '$ingreso'
					AND Ctcart = '$codArticulo'";

			$res2 = mysql_query($q2, $conexion) or die ("Error: ".mysql_errno()." - en el query: $q2 - ".mysql_error());
			$estado2 = "2";
		} else {
			$q3 = "INSERT INTO ".$wbasedato."_000095
				(Medico,Fecha_data,Hora_data,Ctchis,Ctcing,Ctcart,Ctccau,Ctccus,Ctcuca,Seguridad)
			VALUES
				('movhos','".date("Y-m-d")."','".date("H:i:s")."','$historia','$ingreso','$codArticulo','$autorizadoCtc','$cantidadUsadaCtc','{$fila['Kaduma']}','A-$usuario')";

			$res3 = mysql_query($q3, $conexion) or die ("Error: ".mysql_errno()." - en el query: $q3 - ".mysql_error());
			$estado2 = "1";
		}

		switch ($estado2){
			case "1":
				$mensajeAuditoria = obtenerMensaje('MSJ_CANTIDAD_CTC_CREADA');
				break;
			case "2":
				$mensajeAuditoria = obtenerMensaje('MSJ_CANTIDAD_CTC_MODIFICADA');
				break;
			default:
				$mensajeAuditoria = obtenerMensaje('MSJ_CANTIDAD_CTC_NO_ALTERADA');
				break;
		}

		//Registro de auditoria
		$auditoria = new AuditoriaDTO();

		$auditoria->historia = $historia;
		$auditoria->ingreso = $ingreso;
		$auditoria->descripcion = "$audAnterior $audNuevo";
		$auditoria->fechaKardex = $fechaKardex;
		$auditoria->mensaje = $mensajeAuditoria;
		$auditoria->seguridad = $codUsuario;

		registrarAuditoriaKardex($conexion,$wbasedato,$auditoria);

		$estado .= "|".$cantidadUsadaCtc;
	}
	liberarConexionBD($conexion);

	return $estado;
}

/**
 * Condiciones del reemplazo:
 * 
 * 1.No se permitirá si el saldo de la tabla 4 es diferente de cero (Entradas != Salidas {Por aplicacion, descarte o devolucion})
 * 2.Se debe comparar lo pedido por el kardex (P), lo despachado y el saldo.
 * 3.P=D=S Insert 
 * 4.P=0=0 Update
 * 5.Cualquier otra variante de D Y S no puede reemplazar.
 * 
 * @param $wbasedatos
 * @param $historia
 * @param $ingreso
 * @param $fechaKardex
 * @param $codArticulo
 * @param $codArticuloNuevo
 * @param $dtto
 * @param $obs
 * @param $unidadDosis
 * @param $formaFarm
 * @param $origen
 * @param $fechaInicio
 * @param $horaInicio
 * @param $usuario
 * @return unknown_type
 */
function reemplazarArticuloDetallePerfil($wbasedatos,$historia,$ingreso,$fechaKardex,$codArticulo,$codArticuloNuevo,$dtto,$obs,$unidadDosis,$formaFarm,$origen,$fechaInicio,$horaInicio,$usuario){

	global $codigoServicioFarmaceutico;
	global $centroCostosServicioFarmaceutico;
	global $codigoCentralMezclas;
	global $centroCostosCentralMezclas;

	global $protocoloNormal;
	
	global $horaCorteDispensacion;
	
	$formaFarm = trim( $formaFarm );
	
	if( empty( $formaFarm ) ){
		$formaFarm = '00';
	}
	
	$suspendido = '';	//Mensaje si el articulo fue suspendido

	$conexion = obtenerConexionBD("matrix");
	$estado = "0";
	$tipoProtocolo = $protocoloNormal;
	$puedeGrabar = true;

	$q = "SELECT
				*
			FROM
				".$wbasedatos."_000054
			WHERE
				 Kadhis = '$historia'
				 AND Kading = '$ingreso'
				 AND Kadfec = '$fechaKardex'
				 AND Kadart = '$codArticulo'
				 AND Kadfin = '$fechaInicio'
				 AND Kadhin = '$horaInicio'
			";

	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$fila = mysql_fetch_array($res);
	$num = mysql_num_rows($res);

	//BUSCA R EL TIPO DE ARTICULO EN EL MAESTRO UNICO TABLA 68 A QUE TIPO DE PROTOCOLO PERTENECE
	$centroCostos = "";

	if($origen == $codigoServicioFarmaceutico){
		$centroCostos = $centroCostosServicioFarmaceutico;
	}

	if($origen == $codigoCentralMezclas){
		$centroCostos = $centroCostosCentralMezclas;
	}

	//Tipo del protocolo
	$q2 = "SELECT
				Arktip
			FROM
				".$wbasedatos."_000068
			WHERE
				 Arkcod = '$codArticuloNuevo'
				 AND Arkest = 'on'
				 AND Arkcco = '$centroCostos'";

	$res2 = mysql_query($q2, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());
	$num2 = mysql_num_rows($res2);

	if($num2 > 0){
		$fila2 = mysql_fetch_array($res2);
		if( strlen( trim( $fila2['Arktip'] ) ) == 1 ){	//Para que sea visible en las pestañas del kardex, la longitud debe ser = 1
			$tipoProtocolo = $fila2['Arktip'];
		}
	}

	//Fracciones
	$q3 = "SELECT
				Deffra,Deffru,Defart,Defven,Defdie,Defdis,Defdup,Defvia
			FROM
				{$wbasedatos}_000059
			WHERE
				Defest = 'on'
				AND Defart = '$codArticuloNuevo'
				AND Defcco = '$centroCostos'
			GROUP BY
				Defart";

	$res3 = mysql_query($q3, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q3 . " - " . mysql_error());
	$num3 = mysql_num_rows($res3);

	if($num3 > 0){
		$fila3 = mysql_fetch_array($res3);
		
		$fila3['Defvia'] = trim( $fila3['Defvia'] );
		
		if( strtoupper( $fila3['Defvia'] ) == "NO APLICA"  ){
			$fila3['Defvia'] = '';
		}
		
		$viasArticuloNuevo = explode( ",", $fila3['Defvia'] );
	}

	$audAnterior = "";
	if($num > 0){
		$audAnterior = "A:".$fila['Kadart'].",".$fila['Kaddia'].",".$fila['Kadufr'].",".$fila['Kadffa'].",".$fila['Kadori'].",".$fila['Kadobs'];

		//Si el articulo existe pero no es duplicable no puede grabarse
		if(isset($fila3['Defdup']) && !empty($fila3['Defdup']) && $fila3['Defdup'] == "off"){

			$qNvo = "SELECT
						Kadart, Kaddia, Kadufr, Kadffa, Kadori, Kadobs
					FROM
						".$wbasedatos."_000054
					WHERE
						Kadhis = '$historia'
						AND Kading = '$ingreso'
						AND Kadart = '$codArticuloNuevo'
						AND Kadfec = '$fechaKardex'";

			$resNvo = mysql_query($qNvo, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $qNvo . " - " . mysql_error());
			$filaNvo = mysql_fetch_array($resNvo);
			$numNvo = mysql_num_rows($resNvo);

			if($numNvo > 0){
				$puedeGrabar = false;
			}
		}
	} else {
		$puedeGrabar = false;
	}
	
	/************************************************************
	 * Enero 05 de 2011
	 ************************************************************/
	$cantidadFraccion = $fila['Kadcfr'];
	$cantidadDispensar = $fila['Kadcdi'];
	$cantidadSaldoAnterior = $fila['Kadsad'];
	$cantidadDispensada = $fila['Kaddis'];
	$saldoDelArticulo = $fila['Kadsal'];
	$cantidadDosis = $fila['Kadcan'];
	$dosisMaxima = trim( $fila['Kaddma'] );
	
	$esGenerico = esArticuloGenerico( $conexion, $wbasedatos, "cenpro", $codArticulo );
	
	//Si el articulo que se va a reemplazar es generico se debe cambiar la cantidad de fracción
	//según la definición de fracciones
	if( $puedeGrabar ){
		if( $esGenerico && $num > 0 && $num3 > 0 ){
			$cantidadFraccion = $fila['Kadcfr']/$fila['Kadcma']*$fila3['Deffra'];
		}
		elseif( $num > 0 && $num3 > 0 ){	//Enero 12 de 2011
			//Si el articulo es no generico, se debe calcular la dosis con respecto a la cantidad de dosis a aplicar del articulo viejo
			if( true || $fila['Kadcfr'] >= $fila3['Deffra'] ){
				
				if( trim($fila['Kadufr']) != trim($fila3['Deffru']) ){	//Febrero 21 de 2011
					
					$cantidadFraccion = ceil( $fila['Kadcfr']/$fila['Kadcma'] )*$fila3['Deffra'];	//Enero 24 de 2011
					
					if( esTipoGenerico( $conexion, $wbasedatos, "cenpro", $codArticuloNuevo ) && $cantidadFraccion != $fila3['Deffra'] ){
//						$cantidadFraccion = ceil( $fila['Kadcfr']/$fila3['Deffra'] )*$fila3['Deffra'];
						$cantidadFraccion = (1)*$fila3['Deffra'];
					}

					$cantidadDispensar = ceil( ( $cantidadFraccion/$fila3['Deffra'] )*( $fila['Kadcan'] ) );
				
					$cantidadDispensar += $cantidadSaldoAnterior;
					
					$saldoDelArticulo = ($cantidadDispensar-$cantidadSaldoAnterior)*$fila3['Deffra']-$fila['Kadcan']*$cantidadFraccion;
				}
				else{
					//echo "<br>.....cant antes: ".($fila['Kadcma']*$fila['Kaddis']/$fila3['Deffra']);
					
					$cantidadDispensada = ceil( $fila['Kadcma']*$fila['Kaddis']/$fila3['Deffra'] );
					
					//echo "<br>.....cant despues: ".$cantidadDispensada.":::";
					
					/************************************************************************************************************
					 * Marzo 15 de 2011
					 * 
					 * Si el articulo es de un tipo  generico se debe gastar toda la bolsa
					 ************************************************************************************************************/
					if( esTipoGenerico( $conexion, $wbasedatos, "cenpro", $codArticuloNuevo ) && $cantidadFraccion != $fila3['Deffra'] ){
//						$cantidadFraccion = ceil( $fila['Kadcfr']/$fila3['Deffra'] )*$fila3['Deffra'];
						$cantidadFraccion = (1)*$fila3['Deffra'];
					}
					/************************************************************************************************************/

//					$cantidadDispensar = ceil( $fila['Kadcfr']/$fila3['Deffra']*( $fila['Kadcan'] ) );
					$cantidadDispensar = ceil( $cantidadFraccion/$fila3['Deffra']*( $fila['Kadcan'] ) );

					$cantidadSaldoAnterior = ceil( $fila['Kadsad']*$fila['Kadcma']/$fila3['Deffra'] );

					$cantidadDispensar += $cantidadSaldoAnterior;

					$saldoDelArticulo = ($cantidadDispensar-$cantidadSaldoAnterior)*$fila3['Deffra']-$fila['Kadcan']*$cantidadFraccion;
				}
			}
		} //Fin de Enero 12 de 2011
	}
	/************************************************************/
	
	/***********************************************************************************************
	 * Octubre 4 de 2011
	 *
	 * - No se permite hacer reemplazo de medicamentos si
	 * - El paciente esta en un centro de costos que NO maneja ciclos de produccion
	 *   y ya se ha sido dispensado
	 * - El paciente esta en un centro de costos que maneja ciclos de produccion
	 *   y para la siguiente ronda ya se ha dispensado algo, si no se ha dispensado, mostrar un
	 *   mensaje que diga que puede dispensar a partir de la siguiente ronda
	 ***********************************************************************************************/
	/******************************************************************************************
	 * Octubre 4 de 2011
	 ******************************************************************************************/			
	$tieneCpx = tieneCpxPorHistoria( $conexion, $wbasedatos, $historia, $ingreso );
	
	if( $tieneCpx && !empty( $fila[ 'Kadcpx' ] ) ){

		if( !empty( $fila[ 'Kadcpx' ] ) ){
			
			$timeActual = time()-3600*2;
	
			// if( date( "H", $timeActual ) > 2 && date( "Y-m-d", $timeActual ) == date( "Y-m-d" )  )
			if( date( "Y-m-d", $timeActual ) == date( "Y-m-d" )  ){
			
				//Consulto ronda actual
				$rondaActual = intval( date( "H", $timeActual )/2 )*2;
				$rondaActualPosterior = intval( date( "H" )/2 )*2;
				
				if( $rondaActual < 10 ){
					$rondaActual = "0$rondaActual:00:00";
				}
				else{
					if( $rondaActual == 24 ){
						$rondaActual = "00:00:00";
					}
					else{
						$rondaActual = "$rondaActual:00:00";
					}
				}
				
				//Consulto ronda poterior
				if( $rondaActualPosterior < 10 ){					
					$rondaActualPosterior = "0$rondaActualPosterior:00:00";
				}
				else{
					if( $rondaActual == 24 ){
						$rondaActualPosterior = "00:00:00";
					}
					else{
						$rondaActualPosterior = "$rondaActualPosterior:00:00";
					}
				}
				
				$kadcpx = nuevaDosis( $cantidadFraccion/$fila3['Deffra'], $fila['Kadcpx'] );
				
				// list( $kadron, $kadfro ) = explode( "|", consultarUltimaRondaDispensadaKardex( $kadcpx ) );
				list(  $fila['Kadron'], $fila['Kadfro'] ) = explode( "|", consultarUltimaRondaDispensadaKardex( $fila['Kadcpx'] ) );
				
				//Coloco la ronda correcta para kadfro
				if( !empty( $fila['Kadron'] ) ){
					
					//Si es vacio, significa que la fecha corresponde al dia siguiente
					if( empty( $fila['Kadfro'] ) ){
						$fila['Kadfro'] = date( "Y-m-d", strtotime( "$fechaKardex 00:00:00" )+24*3600 );
					}
					else{
						$fila['Kadfro'] = $fechaKardex;
					}
				}
				
				// echo $fila['Kadron'], '....aslfjdflsf....'.$fila['Kadfro'];
				if( !empty( $fila['Kadron'] ) &&  $fila['Kadfro'] == date("Y-m-d") ){
				
					if( $fila['Kadron']*1 > substr( $rondaActual,0 ,2 )*1 ){
						$cantidadDispensada = cantidadTotalADispensarRonda( $kadcpx, $rondaActualPosterior );
					}
					elseif( $rondaActual != "00:00:00" ){
						$cantidadDispensada = cantidadTotalADispensarRonda( $kadcpx, $rondaActual );// + cantidadDispensadaRondaKardex( $fila['Kadcpx'], $rondaActualPosterior );
					}
					elseif( substr( $kadcpx, 0, 3 ) == "Ant" ){	//Quito el saldo del dia anterior
						$cantidadDispensada = cantidadTotalADispensarRonda( $kadcpx, "Ant" );
					}
				}
				elseif( $rondaActual != "00:00:00" ){
					$cantidadDispensada = cantidadTotalADispensarRonda( $kadcpx, $rondaActual );// + cantidadDispensadaRondaKardex( $fila['Kadcpx'], $rondaActualPosterior );
				}
				elseif( substr( $kadcpx, 0, 3 ) == "Ant" ){	//Quito el saldo del dia anterior
					$cantidadDispensada = cantidadTotalADispensarRonda( $kadcpx, "Ant" );
				}
				
				$cantidadDispensada = intval( $cantidadDispensada );
				
				$kadcpx = crearAplicacionesCargadasPorHorasKardex( $kadcpx, $cantidadDispensada );
				
				/************************************************************************
				 * Noviembre 29 de 2011
				 *
				 * - Miro que la cantidad a dispensar sea suficiente 
				 ************************************************************************/
				
				//Si el saldo es 0 y no tiene registro del dia anterior (Kadreg), significa que viene de un cco que no maneja ciclos de produccion
				//y por tanto hay que recalcular saldos de dispensacion del dia anterior
				if( empty( $fila['Kadsad'] ) ||  trim( $fila['Kadsad'] ) == '' ){
				
					if( !empty( $fila[ 'Kadron' ] ) && trim( $fila['Kadron'] ) != '' /* && trim( $fila['Kadron'] ) != "00" */ ){
						
						//Busco la cantidad dispensada hasta la ronda del medicamento anterior
						//Esto por que ya puede haber una cantidad dispensada y de esta forma traduzco cuanto fue con respecto al medicamento nuevo
						if( $fila['Kadfro'] == $fila['Kadfec'] ){
							$cantidadDispensadaMedAnterior = intval( cantidadTotalADispensarRonda( $kadcpx, $fila['Kadron'].":00:00" ) );
						}
						else{
							if( $fila[ 'Kadron' ] = "00" ){
								$cantidadDispensadaMedAnterior = intval( cantidadTotalADispensarRonda( $kadcpx, "00:00:00" ) );
							}
							else{
								$cantidadDispensadaMedAnterior = intval( cantidadTotalADispensarRonda( $kadcpx, "" ) );
							}
						}
				
						$cantidadDispensada = $cantidadDispensada - $cantidadDispensadaMedAnterior;
												//   (                 aplicaciones med anterior                     )*$cantidadArticuloPorDosis
						$cantidadDispensada += intval( intval( ( $fila[ 'Kaddis' ]*$fila['Kadcma'] )/$fila['Kadcfr'] )*($cantidadFraccion/$fila3['Deffra']) );	//Transformo la cantidad dispensada del medicamento anterior por el nuevo, para mantener la relacion
					
						if( $cantidadDispensada < 0 ){
							$cantidadSaldoAnterior += $cantidadDispensada*(-1);
							$cantidadDispensada = 0;
						}
					}
				}
				
				/************************************************************************/
				
				list( $kadron, $kadfro ) = explode( "|", consultarUltimaRondaDispensadaKardex( $kadcpx ) );
				
				/**************************************************************************************************************			
				 * Noviembre 1 de 2011
				 **************************************************************************************************************/
				if( !empty( $kadron ) ){
							
					if( empty( $kadfro ) ){
						$kadfro = date( "Y-m-d", strtotime( trim( $fechaKardex )." 00:00:00" ) + 3600*24 );
					}
					else{
						$kadfro = $fechaKardex;
					}
				}
				/**************************************************************************************************************/
				
				//calcularCantidadGrabar( $fechaHoy,$fechaInicio,$horaInicioSuministro,$horasFrecuencia,$esPrimeraVez );
			}
			else{	//Si el reemplazo es hecho antes de las 2 de la mañana del dia actual, significa que no hay que cargar nada nuevo
				$kadcpx = nuevaDosis( $cantidadFraccion/$fila3['Deffra'], $fila['Kadcpx'] );
				
				if( substr( $kadcpx, 0, 3 ) == "Ant" && $fila['Kaddis'] > 0 ){	//Quito el saldo del dia anterior
					$cantidadDispensada = cantidadTotalADispensarRonda( $kadcpx, "Ant" );
					$kadcpx = crearAplicacionesCargadasPorHorasKardex( $kadcpx, $cantidadDispensada );
				}
				else{
					$cantidadDispensada = 0;
				}				
				
				$kadron = "";
				$kadfro = "0000-00-00";
			}
		}
		else{
			$kadcpx = "";
			$kadron = "";
			$kadfro = "";
		}
	}
	else{
		
		$kadcpx = '';
		$kadron = '';
		$kadfro = "";
		
		//Calculo cuantas dosis faltan hasta el dia siguiente
		
		//Consulto la frecuencia
		$frecuencia = consultarFrecuencia( $conexion, $wbasedatos, $fila['Kadper'] );
		
		$fechorIncioMedicamento = strtotime( "{$fila['Kadfin']} {$fila['Kadhin']}" );
		
		/****************************************************************************************************
		 * Febrero 16 de 2012
		 *
		 * Calculo la cantidad a dispensar hasta el día siguiente
		 * El calculo general es el siguiente:
		 * - Se calcula siempre la ultima ronda de aplicacion antes de la hora de corte del día siguiente
		 * - Calculo cuantas aplicaciones o suministros se le aplican al paciente desde la ronda de reemplazo
		 *   hasta la última ronda de aplicacion
		 * - Si la ronda de reemplazo es una ronda de aplicación, se busca si el medicamento fue dispensado
		 *   para esa ronda segun el kardex, adicionar una aplicacion al calculo o no, esta adición cubre
		 *   la primera aplicación.
		 *
		 * Fromula: aplicaciones: (Fecha y hora de cambio - Fecha y hora final)/frecuencia + adicional
		 *					 	  0 >= adicional <= 1
		 ****************************************************************************************************/
		//Calculo la ronda actual
		$time = time() - strtotime( "1970-01-01 00:00:00" );
		$timeActual = ceil( $time/(2*3600) )*2*3600 - 2*3600 + strtotime( "1970-01-01 00:00:00" );
		
		if( date( "Y-m-d", $timeActual ) != date( "Y-m-d" ) ){
			$timeActual = strtotime( date( "Y-m-d 00:00:00" ) );
		}
		
		//Calculo el tiempo hasta la hora de corete del día siguiente
		$tiempoHastaDiaSiguiente = strtotime( date( "Y-m-d", $timeActual+24*3600)." $horaCorteDispensacion:00:00" );
		
		//Busco la ulitma hora de dispensacion del dia siguiente
		$ultimoSuministroDiaSiguiente = suministroAntesFechaCorte( date("Y-m-d", $tiempoHastaDiaSiguiente ), date( "H:i:s", $tiempoHastaDiaSiguiente ), $fila['Kadfin'], $fila['Kadhin'], $frecuencia );
		
		//Si tiene dosis maxima calculo hasta cuando es
		if( !empty( $dosisMaxima ) ){
			//Si tiene dosis Maximas, el ultimo suministro o aplicacion es el minimo entre la fecha de terminacion del medicamento y el dia siguiente
			$ultimoSuministroDiaSiguiente = min( $ultimoSuministroDiaSiguiente, $fechorIncioMedicamento + ($dosisMaxima-1)*$frecuencia*3600 );
		}
		
		//Calculo cuantas aplicaciones se dejaron de dispensar
		$cantDosisSinDispensar = ceil( $cantidadSaldoAnterior/( $cantidadFraccion/$fila3['Deffra'] ) );
		
		//Calculo cuantas dosis se dispensaron
		$cantDosisDispensadas = intval( $cantidadDispensada/( $cantidadFraccion/$fila3['Deffra'] ) );
		
		//Calculo de la ultima aplicación según la dispensación
		$comienzoDiaActual = $ultimoSuministroDiaSiguiente - ($cantidadDosis + $cantDosisSinDispensar - $cantDosisDispensadas)*$frecuencia*3600;
		
		if( $timeActual > $fechorIncioMedicamento ){
			$ultimoSuministro = $timeActual;
		}
		else{
		
			$ultimoSuministro = $fechorIncioMedicamento;
			
			//Si la hora de reemplazo es antes de la hora de inicio del medicamento
			//siempre se tiene que agregar uno
			if( $timeActual < $fechorIncioMedicamento ){
				$adicional = 1;
			}
		}
		
		//Si existe adicional es por que ya se calculo con anterioridad y por tanto
		//no se tiene que volver a calcular
		if( !isset($adicional) ){
			$adicional = 0;
			if( $ultimoSuministro > $comienzoDiaActual && ( $ultimoSuministro-$fechorIncioMedicamento )%($frecuencia*3600) == 0 ){
				$adicional = 1;
			}
		}
		
		$totalAplicaciones = ceil( ( $ultimoSuministroDiaSiguiente - $ultimoSuministro )/($frecuencia*3600) );
		
		//Total de articulos que faltan desde el momento de reemplazo hasta el dia siguiente
		$cantTotal = ceil( $totalAplicaciones*($cantidadFraccion/$fila3['Deffra']) + $adicional*($cantidadFraccion/$fila3['Deffra']) );
		
		//Calculo la cantidad total a dispensar segun las aplicaciones
		$cantTotalSegunAplicaciones = ceil( $cantidadDosis*($cantidadFraccion/$fila3['Deffra']) );
		/****************************************************************************************************/
		
		/************************************************************************************************
		 * Febrero 16 de 2012
		 *
		 * Calculo cuanto es la cantidad a dispensar, la cantidad dispensada y el saldo del día anterior
		 ************************************************************************************************/
		
		//Calculo cuanto queda del saldo del dia anterior
		$auxCanSalAnterior = $cantTotalSegunAplicaciones - $cantTotal;
		
		//Si es negativo significa que tiene saldo del dia anterior de lo contrario no
		if( $auxCanSalAnterior < 0 ){
			$cantidadSaldoAnterior = $auxCanSalAnterior*(-1);
			$cantidadDispensada = 0;
		}
		else{
			$cantidadSaldoAnterior = 0;
			
			//Dejo la cantidad dispensada en 0
			$cantidadDispensada = 0;
			
			//Calculo cuanto fue dispensado
			if( $auxCanSalAnterior > 0 ){
				$cantidadDispensada = $auxCanSalAnterior;
			}
		}
		
		$cantidadDispensar = $cantTotalSegunAplicaciones + $cantidadSaldoAnterior;
		/************************************************************************************************/
		
		//Si tiene cpx significa que no tiene regleta y procedo a crearla
		if( $tieneCpx ){
		
			$infoTipoArticulo = consultarinfotipoarticulosKardex( $conexion, $wbasedatos );
			
			/************************************************************************************************************************
			 * Creando regleta
			 ************************************************************************************************************************/
			$frecuencia = consultarFrecuencia( $conexion, $wbasedatos, $fila['Kadper'] );
			
			$vectorAplicacion =  obtenerVectorAplicacionMedicamentos( date("Y-m-d", $timeActual ), trim( $fechaInicio ), trim( $horaInicio ), $frecuencia );
			$vectorAplicacion2 = obtenerVectorAplicacionMedicamentos( date( "Y-m-d", $timeActual+24*3600 ), trim( $fechaInicio ), trim( $horaInicio ), $frecuencia );
			$vectorAplicacion2 = arreglarVectorKardex( $vectorAplicacion2 );
			
			$quitarUnoARegleta = 25;
			if( count($vectorAplicacion2) == 25 ){
				$quitarUnoARegleta = 24;
			}
			
			foreach( $vectorAplicacion2 as $keyB => $valueB ){
				$vectorAplicacion[ $quitarUnoARegleta ] = $valueB;
				$quitarUnoARegleta++;
			}
			
			$kadcpx = crearVectorAplicaciones( $vectorAplicacion, $infoTipoArticulo[ $tipoProtocolo ]['tiempoPreparacion'], $cantidadFraccion/$fila3['Deffra'], intval( ( strtotime( "1970-01-01 ".$infoTipoArticulo[ $tipoProtocolo ]['horaCaroteDispensacion'] ) - strtotime( "1970-01-01 00:00:00" ) )/3600 ) );
			/************************************************************************************************************************/
			
			//Si pide medicamento para las 00:00:00 del dia actual creo el saldo del dia anterior
			if( strtotime( date( "Y-m-d 00:00:00" ) ) - strtotime( $fila[ 'Kadfin' ]." ".$fila[ 'Kadhin' ] ) >= 0 && abs( strtotime( date( "Y-m-d 00:00:00" ) ) - strtotime( $fila[ 'Kadfin' ]." ".$fila[ 'Kadhin' ] ) )%$frecuencia == 0 ){
				$kadcpx = "Ant-".round( $cantidadFraccion/$fila3['Deffra'], 3 )."-0,".$kadcpx;
			}
			
			$kadcpx = crearAplicacionesCargadasPorHorasKardex( $kadcpx, $cantidadDispensada );
			
			list( $kadron, $kadfro ) = explode( "|", consultarUltimaRondaDispensadaKardex( $kadcpx ) );
			
			/**************************************************************************************************************
			 * Noviembre 1 de 2011
			 **************************************************************************************************************/
			if( !empty( $kadron ) ){
						
				if( empty( $kadfro ) ){
					$kadfro = date( "Y-m-d", strtotime( trim( $fechaKardex )." 00:00:00" ) + 3600*24 );
				}
				else{
					$kadfro = $fechaKardex;
				}
			}
			/**************************************************************************************************************/
		}
	}
	/******************************************************************************************/
	
	/******************************************************************************************
	 * Octubre 27 de 2011
	 * - Si el articulo no tiene la misma via que el original no se puede reemplazar
	 ******************************************************************************************/
	$fila3['Defvia'] = trim( $fila3['Defvia'] );
	 
	if( strtoupper( $fila3['Defvia'] ) == "NO APLICA" ){
		$fila3['Defvia'] = '';
	}
	
	if( $origen == $codigoServicioFarmaceutico ){
		if( !empty( $fila3['Defvia'] ) ){
			
			$conViaIgual = false;
			foreach( $viasArticuloNuevo as $viasKey => $viasValue ){
				if( trim( $viasValue ) == trim( $fila['Kadvia'] ) ){
					$conViaIgual = true;
				}
			}
			
			if( !$conViaIgual ){
				$puedeGrabar = false;
				$estado = "6";	//Indica que no tiene la misma via que el original
			}
		}
		else{
			$estado = "7";	//Indica que no tiene vias registradas, debe tener una
			$puedeGrabar = false;
		}
	}
	/******************************************************************************************/
	 
	//Si existe el registro ACTUALIZO caso contrario INSERTO
	if($puedeGrabar){
		
		/************************************************************************
		 * Enero 12 de 2011 
		 ************************************************************************/
		$q = "SELECT
					*
				FROM
					".$wbasedatos."_000054
				WHERE
				 	Kadhis = '$historia'
				 	AND Kading = '$ingreso'
				 	AND Kadfec = '$fechaKardex'
				 	AND Kadart = '$codArticuloNuevo'
				 	AND Kadfin = '$fechaInicio'
				 	AND Kadhin = '$horaInicio'";
		
		$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
		$numrows = mysql_num_rows( $res );
		
		if( $numrows <= 0 ){
			$fecha = $fila['Fecha_data'];
			$hora = $fila['Hora_data'];
			
			/******************************************************************************************
			 * Junio 30 de 2011
			 ******************************************************************************************/
			//Consulto unidad de manejo del articulo nuevo
			
			if( $origen == $codigoServicioFarmaceutico ){
			
				$sql = "SELECT
							Artuni
						FROM
							{$wbasedatos}_000026
						WHERE
							artcod = '$codArticuloNuevo'
							";
			}
			else{

				$sql = "SELECT
							Artuni
						FROM
							cenpro_000002
						WHERE
							artcod = '$codArticuloNuevo'
						";
			}
			
			$res = mysql_query( $sql, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
			
			if( $rowsUma = mysql_fetch_array( $res ) ){
				$uniMan = $rowsUma[ 'Artuni' ]; 
			}
			/******************************************************************************************/
			
			obtenerDatosAdicionalesArticulo($historia,$ingreso,$codArticulo,$diasTtoAcumulados,$dosisTtoTotales);
			
			$dosisTtoTotales += $fila['Kadcdt'];
			$diasTtoAcumulados += $fila['Kadcda'];
			
			//Inserto registro nuevo
			$q = "INSERT INTO {$wbasedatos}_000054(     Medico   , Fecha_data, Hora_data,    Kadhis  ,  Kading   ,     Kadart         ,       Kadcma        ,  Kaduma  ,  Kaddia, Kadest, Kadess,       Kadper       ,    Kadffa   ,       Kadfin  ,   Kadhin     ,        Kadvia      ,      Kadfec   , Kadcon, Kadobs,  Kadori  , Kadsus,       Kadcnd       ,       Kaddma      ,       Kadcan        ,       Kaddis         ,       Kadcfr       ,      Kadufr   ,        Kadhdi       ,      Kadsal        ,       Kadcdi        ,      Kadpri        ,    Kadpro       ,        Kadcco      , Kadare,          Kadsad        ,       Kadnar       ,        Kadreg      ,  Kadcpx  ,  Kadron  ,  Kadfro  ,          Kadaan                 ,       Kadcda        ,        Kadcdt     ,     Kadimp     ,   Kadalt     ,   Kadcal,  Seguridad         )
											VALUES( '$wbasedatos',  '$fecha' ,  '$hora' , '$historia', '$ingreso', '$codArticuloNuevo', '{$fila3['Deffra']}', '$uniMan', '$dtto',  'on' , 'off' , '{$fila['Kadper']}', '$formaFarm', '$fechaInicio', '$horaInicio', '{$fila['Kadvia']}', '$fechaKardex',  'on' , '$obs', '$origen',	 'off', '{$fila['Kadcnd']}', '{$fila['Kaddma']}', '{$fila['Kadcan']}', '$cantidadDispensada', '$cantidadFraccion', '$unidadDosis', '{$fila['Kadhdi']}', '$saldoDelArticulo', '$cantidadDispensar', '{$fila['Kadpri']}', '$tipoProtocolo', '{$fila['Kadcco']}',  'on' , '$cantidadSaldoAnterior', '{$fila['Kadnar']}', '{$fila['Kadreg']}', '$kadcpx', '$kadron', '$kadfro', '$codArticulo,".$fechaKardex."', '$diasTtoAcumulados', '$dosisTtoTotales', '{$fila['Kadimp']}', '{$fila['Kadalt']}', '{$fila['Kadcal']}','{$fila['Seguridad']}' ) ";

			$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
			
			//registro el id original
			$idOriginal = mysql_insert_id();
			
			$q = "UPDATE
					{$wbasedatos}_000054
				  SET
				  	Kadido = '$idOriginal'
				  WHERE
				  	id = '$idOriginal'
				 ";

			$res = mysql_query($q, $conexion) or die ( "Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

			//Suspendo el registro del articulo viejo
			$q = "UPDATE
					{$wbasedatos}_000054
				  SET
				  	Kadsus = 'on'
				  WHERE
				  	id = '{$fila['id']}'
				 ";

			$res = mysql_query($q, $conexion) or die ( "Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
			
			
			//crenado el mensaje de articulo suspendido
			$suspendido = ",".obtenerMensaje('MSJ_SUSPENDER_MEDICAMENTO');
			
			$suspendido .= ":".$fila['Kadart'];
			
			$estado = "1";
		}
		else{

			if( $numrows == 1 ){
				
				$rowsRepetidos = mysql_fetch_array( $res );
				
				if( $rowsRepetidos['Kadsus'] == 'on' && $rowsRepetidos['Kadper'] == $fila['Kadper'] ){
				
					obtenerDatosAdicionalesArticulo($historia,$ingreso,$codArticuloNuevo,$diasTtoAcumulados,$dosisTtoTotales);
					$dosisTtoTotales = $fila['Kadcdt'];
					
					//obtenerDatosAdicionalesArticulo($historia,$ingreso,$codArticulo,&$diasTtoAcumulados,&$dosisTtoTotales);
					$diasTtoAcumulados = 0;
					
					if( !empty( $fila['Kadaan'] ) ){
					
						list( $articuloAnterior, $fechaReemplazo ) = explode( ",", $fila['Kadaan'] );
						
						if( $fechaReemplazo == date( "Y-m-d" ) ){
							
							if( esAplicado( $conexion, $wbasedatos, $historia, $ingreso, $fila['Kadart'], $fechaReemplazo ) ){
								$diasTtoAcumulados++;
							}						
						}
					}
					
					$q = "UPDATE
							{$wbasedatos}_000054
						  SET
						  	Kadsus = 'on'
						  WHERE
						  	id = '{$fila['id']}'
						 ";
	
					$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
					
					$q = "UPDATE
							{$wbasedatos}_000054
						  SET
						  	Kadsus = 'off',
						  	Kadcan = '$cantidadDosis',
							Kadcfr = '$cantidadFraccion',
							Kadcdi = '$cantidadDispensar',
							Kadsad = '$cantidadSaldoAnterior',
							Kaddis = '$cantidadDispensada',
							Kadare = 'on',
							Kadcpx = '$kadcpx',
							Kadron = '$kadron',
							Kadfro = '$kadfro',
							Kadaan = '$codArticulo,".$fechaKardex."',
							Kadcda = '$diasTtoAcumulados',
							Kadcdt = '$dosisTtoTotales'
						  WHERE
						  	id = '{$rowsRepetidos['id']}'
						 ";
	
					$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
					
					$idOriginal = $rowsRepetidos['Kadido'];
					
					$estado = "1";
				}
				else{
					$estado = "5";
				}
			}
			else{
				$estado = "5";
			}
		}
		/************************************************************
		 *                   Fin Enero 12 de 2011
		/************************************************************/
		
	} else {
		
		if( $estado != "6" && $estado != "7" ){
			$estado = "4";
		}
	}

	//Generación de auditoria cambio / creación
	$audNuevo = "N:".$codArticuloNuevo.",".$dtto.",".$unidadDosis.",".$formaFarm.",".$origen.",".$dtto.",".$obs;

	$mensajeAuditoria = "";

	switch ($estado){
		case "1":
			$mensajeAuditoria = obtenerMensaje('MSJ_ARTICULO_REEMPLAZADO_DESDE_PERFIL');
			break;
		default:
			$mensajeAuditoria = obtenerMensaje('MSJ_ARTICULO_NO_MODIFICADO_DESDE_PERFIL');
			break;
	}

	//Registro de auditoria
	$auditoria = new AuditoriaDTO();

	$auditoria->historia = $historia;
	$auditoria->ingreso = $ingreso;
	$auditoria->descripcion = "$audAnterior $audNuevo $suspendido";
	$auditoria->fechaKardex = $fechaKardex;
	$auditoria->mensaje = $mensajeAuditoria;
	$auditoria->seguridad = $usuario;
	$auditoria->idOriginal = $idOriginal;

	registrarAuditoriaKardex($conexion,$wbasedatos,$auditoria);

	liberarConexionBD($conexion);
	
	if( $tieneCpx && $estado == "1" ){	//Octubre 10 de 2011
		$estado = "8";
		$estado .= "|".$cantidadFraccion."|".$cantidadDispensar."|".$cantidadSaldoAnterior;//.$lastRonda; //Enero 05 de 2011
	}
	else{
		$estado .= "|".$cantidadFraccion."|".$cantidadDispensar."|".$cantidadSaldoAnterior; //Enero 05 de 2011
	}

	return $estado;	 
}


//Consulta de los medicos por especialidad
function consultarMedicosPorEspecialidad($basedatos,$especialidad){
	$conexion = obtenerConexionBD("matrix");

	//Relacion muchos a muchos
	/*
	$q = "SELECT
			Meddoc,Medtdo,Medno1,Medno2,Medap1,Medap2
		FROM
  			{$basedatos}_000065, {$basedatos}_000048
  		WHERE
  			Esmcod = '".$especialidad."'
  			AND Meddoc = Esmndo
  			AND Medtdo = Esmtdo
		ORDER by Medap1,Medno1";
	*/

	//...
	$q = "SELECT Meddoc,Medtdo,Medno1,Medno2,Medap1,Medap2,Meduma,Esmcod AS Medesp 
			FROM ".$basedatos."_000065,".$basedatos."_000048 
		   WHERE Esmcod='".$especialidad."'
			 AND Medtdo=Esmtdo
			 AND Meddoc=Esmndo
			 AND Medest='on'
		ORDER BY Medap1,Medno1;";

	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$consulta = "<select name='wselmed' id='wselmed' class='seleccionNormal'>";

	$consulta = $consulta."<option value=''>Seleccionar medico...</option>";

	$cont1 = 0;

	if($num > 0){
		while ($cont1 < $num)
		{
			$rs = mysql_fetch_array($res);

			$consulta = $consulta."<option value='".$rs['Medtdo']."-".$rs['Meddoc']."-".htmlentities($rs['Medap1'])." ".htmlentities($rs['Medap2']).", ".htmlentities($rs['Medno1'])." ".htmlentities($rs['Medno2'])."-".$rs['Medesp']."'>".htmlentities($rs['Medap1']." ".$rs['Medap2'].", ".$rs['Medno1']." ".$rs['Medno2'])."</option>";

			$cont1++;
		}
	} else {
		$consulta = $consulta."<option value=''>No hay medicos con la especialidad seleccionable</option>";
	}
	$consulta = $consulta."</select>";

	return $consulta;
}

/**
 * 
 * @param $wbasedato
 * @param $historia
 * @param $ingreso
 * @param $fecha
 * @param $codigoExamen
 * @param $nombreExamen
 * @param $observaciones
 * @param $estadoExamen
 * @param $fechaDeSolicitado
 * @param $usuario
 * @param $consecutivoOrden
 * @param $firma
 * @param $observacionesOrden
 * @param $justificacion
 * @param $consecutivoExamen //Codigo del procedimiento.
 * @param $numeroItem
 * @return unknown_type
 */
function grabarExamenKardex($wbasedato,$historia,$ingreso,$fecha,$codigoExamen,$nombreExamen,$observaciones,$estadoExamen,$fechaDeSolicitado,$usuario,$consecutivoOrden,$firma,$observacionesOrden,$justificacion,$consecutivoExamen,$numeroItem,$impExamen,$altExamen,$firmHCE, $datosAdicionales, $ordenAnexa, $esOfertado, $usuarioTomaMuestra, $cco = '' ){

	global $whce;
	global $wemp_pmla;

	$conexion = obtenerConexionBD("matrix");
	$estado = "0";	
	
	//Indica si hay interoperabilidad por tipo de orden
	$hayInteroperabilidad = hayInteroperabilidadPorTipoDeOrden( $conexion, $wbasedato, $codigoExamen );
	
	//Si hay interoperabilidad el estado de envio de mensaje es activo (on), caso contrario es off
	$estadoEnvioMsgHL7 = 'on';
	if( !$hayInteroperabilidad ){
		$estadoEnvioMsgHL7 	= 'off';	//Este se usa al actualizar registro
		$esOfertado			= 'off';	//Este se usa al insertar registro nuevo
	}

	//Inserción en Ordenes de HCE

	//Verifico que exista EL ENCABEZADO DE LA orden
	$q = "SELECT
				Fecha_data,Hora_data,Ordfec,Ordhor,Ordhis,Ording,Ordtor,Ordnro,Ordobs,Ordesp,Ordest,Ordfir,Seguridad  
			FROM
				{$whce}_000027
			WHERE
				Ordtor = '$codigoExamen'
				AND Ordhis = '$historia'
				AND Ording = '$ingreso'
				AND Ordnro = '$consecutivoOrden'";
	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$fila = mysql_fetch_array($res);
	$num = mysql_num_rows($res);

	//Si existe el registro ACTUALIZO caso contrario INSERTO
	if($num == 0){
		
		if($codigoExamen == "H"){
		
			$sqlCons = "SELECT Detval as Ccocor
						  FROM root_000051
						 WHERE Detemp = '".$wemp_pmla."' 
						   AND Detapl = 'consecutivoAyudasHospitalarias';";
		}
		else {
									   
			$sqlCons = "SELECT Ccocor
						  FROM ".$whce."_000047 a, ".$wbasedato."_000011 b, ".$whce."_000015 c
						 WHERE a.Codigo = '$consecutivoExamen'
						   AND tipser = Ccocod
						   AND tipoestudio = c.codigo
						 UNION 
						SELECT Ccocor
						  FROM ".$whce."_000017 a, ".$wbasedato."_000011 b, ".$whce."_000015 c
						 WHERE a.Codigo = '$consecutivoExamen'
						   AND tipser = Ccocod
						   AND nuevo = 'on'
						   AND tipoestudio = c.codigo
						   "; 
		}
		
		$resCons = mysql_query($sqlCons, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $sqlCons . " - " . mysql_error());
			
		if( $rowsCons = mysql_fetch_array( $resCons ) ){
			$consecutivoOrden = $rowsCons[ 'Ccocor' ]+1;
		}
		else{
			return "Error en el consecutivo de la orden.";
		}
	
		
		$estado = "1";
		
		$audAnterior = "";
		
		$q = "INSERT INTO {$whce}_000027
				(Medico,Fecha_data,Hora_data,Ordfec,Ordhor,Ordhis,Ording,Ordtor,Ordnro,Ordobs,Ordesp,Ordest,Ordfir,Ordusu,Ordana, Ordcco,Seguridad)
			VALUES 
				('$whce','".date("Y-m-d")."','".date("H:i:s")."','$fecha','".date("H:i:s")."','$historia','$ingreso','$codigoExamen','$consecutivoOrden','$observacionesOrden','P','on','$firma','$usuario','".$ordenAnexa."','".$cco."','C-$whce')";

		//Solo cuando la orden es nueva se incrementan los consecutivos

		if($codigoExamen == "H"){
			$qInc = "UPDATE root_000051 SET
						Detval = Detval + 1
					WHERE 
						Detemp = '".$wemp_pmla."' 
						AND Detapl = 'consecutivoAyudasHospitalarias';";
			$resInc = mysql_query($qInc, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $qInc . " - " . mysql_error());
			
		} else {
								
			$qInc = "UPDATE ".$whce."_000047 a, ".$wbasedato."_000011 b, ".$whce."_000015 c SET
							Ccocor = Ccocor + 1
					  WHERE a.Codigo = '$consecutivoExamen'
					    AND tipser = Ccocod
					    AND tipoestudio = c.codigo;";
			$resInc = mysql_query($qInc, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $qInc . " - " . mysql_error());
			$actualiza = mysql_affected_rows();
			
			//Si el examen no esta en la tabla hce_000047, entonces lo busca en la tabla hce_000017
			if($actualiza == 0){
				
				$qInc = "UPDATE ".$whce."_000017 a, ".$wbasedato."_000011 b, ".$whce."_000015 c SET
							Ccocor = Ccocor + 1
						  WHERE a.Codigo = '$consecutivoExamen'
							AND tipser = Ccocod
							AND tipoestudio = c.codigo;";
				$resInc = mysql_query($qInc, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $qInc . " - " . mysql_error());
				
			}
		}

	} else 
	{
		
		$estado = "2";
		
//		$audAnterior = "A:".$codigoExamen.",".$consecutivoOrden.",".$fila['Ekaest'].",".$fila['Ekaobs'].",".$fila['Ekafes'].",".$fila['Ekajus'];

		$updateOrdenAnexa = '';
		if(!empty($ordenAnexa)){
			$updateOrdenAnexa = ",Ordana = '".$ordenAnexa."'";
		}
		
		if(!empty($observacionesOrden)){
			$hora = date("H:i:s");
				
			$q = "UPDATE {$whce}_000027 SET
					Ordobs = CONCAT(Ordobs,'\r\n','"."Observacion añadida el $fecha a las $hora:\r\n$observacionesOrden"."'),
					Ordest = 'on'
					$updateOrdenAnexa
				WHERE
					Ordhis = '$historia'
					AND Ording = '$ingreso'
					AND Ordtor = '$codigoExamen'
					AND Ordnro = '$consecutivoOrden'";
		} else {
			$q = "UPDATE {$whce}_000027 SET
					Ordest = 'on'
					$updateOrdenAnexa
				WHERE
					Ordhis = '$historia'
					AND Ording = '$ingreso'
					AND Ordtor = '$codigoExamen'
					AND Ordnro = '$consecutivoOrden'";
		}
	}
	
	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

	
	//Verifico que exista EL DETALLE de la orden (el examen en particular)
	$q = "SELECT
				a.Fecha_data,a.Hora_data,Dettor,Detnro,Detcod,Detesi,Detrdo,Detest,Detjus,Detfec,a.Seguridad, Descripcion, Detfir, Detutm
			FROM	
				{$wbasedato}_000159 a, {$whce}_000047 b
			WHERE 
				Dettor = '$codigoExamen'
				AND Detnro = '$consecutivoOrden'
				AND Detcod = '$consecutivoExamen'
				AND Detite = '$numeroItem'
				AND Detcod = codigo
			UNION
		  SELECT
				a.Fecha_data,a.Hora_data,Dettor,Detnro,Detcod,Detesi,Detrdo,Detest,Detjus,Detfec,a.Seguridad, Descripcion, Detfir, Detutm
			FROM	
				{$wbasedato}_000159 a, {$whce}_000017 b
			WHERE 
				Dettor = '$codigoExamen'
				AND Detnro = '$consecutivoOrden'
				AND Detcod = '$consecutivoExamen'
				AND Detite = '$numeroItem'
				AND Detcod = codigo
				AND nuevo = 'on'
			";

//	echo "Existe examen::".$q;
	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$fila = mysql_fetch_array($res);
	$num = mysql_num_rows($res);

	$item = 1;
	
	if( $numeroItem == 0 ){

		//Busco el consecutivo del item basado en item maximo.
		$sql = "SELECT MAX(Detite) as item
				  FROM {$wbasedato}_000159
				 WHERE dettor = '$codigoExamen'
				   AND detnro = '$consecutivoOrden'";
		$resItem = mysql_query($sql, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
		$numItem = mysql_num_rows($resItem);
		$filaItem = mysql_fetch_array($resItem);

		if( $numItem > 0 ){
			$item = $filaItem['item']+1;
		}
	}
	
	$justificacion = mysqli_real_escape_string($conexion,$justificacion);

	$qrep = "SELECT
				Fecha_data,Hora_data,Dettor,Detnro,Detcod,Detesi,Detrdo,Detest,Detjus,Detfec,Detfir,Seguridad  
			FROM	
				{$wbasedato}_000159
			WHERE 
				Dettor = '$codigoExamen'
				AND Detnro = '$consecutivoOrden'
				AND Detcod = '$consecutivoExamen'
				AND Detesi = '$estadoExamen'
				AND Detest = 'on'
				AND Detfec = '$fechaDeSolicitado'
				AND Detjus = '".utf8_decode( $justificacion )."'
				AND Detusu = '$usuario'
				AND Detite = '$numeroItem'
				AND Detifh = '$firmHCE'
				AND Detfir = '$firma'
				AND Detutm = '$usuarioTomaMuestra'
				";

//	echo "Existe examen::".$q;
	$resrep = mysql_query($qrep, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $qrep . " - " . mysql_error());
	$numrep = mysql_num_rows($resrep);


	if($numrep==0)
	{
		
		//Si existe el registro ACTUALIZO caso contrario INSERTO
		if($num == 0){
			$audNuevo = "N:".$codigoExamen.",".$consecutivoOrden.",".$item.",".str_replace( "_", " ", $nombreExamen ).",".$estadoExamen.",".utf8_decode( $justificacion ).",".$fechaDeSolicitado;
			$audNuevo = "";
			
			$numeroItem = $item;
			
			$estado = "1";
			
			//Busco el codigo para articulo nuevo
			$q_log_n1 = "SELECT Logcod
						FROM ".$wbasedato."_000174
						WHERE Lognue = 'on'
						  AND Logest = 'on'";
			$res_log_n1 = mysql_query($q_log_n1, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q_log_n1 . " - " . mysql_error());
			$row_log_n1 = mysql_fetch_array($res_log_n1);
			$cod_log_nuevo1 = $row_log_n1['Logcod'];
			
			
			$q = "INSERT INTO {$wbasedato}_000159
					(Medico,Fecha_data,Hora_data,Dettor,Detnro,Detcod,Detesi,Detrdo,Detfec,Detest,Detjus,Detite,Detusu,Detfir,Detimp,Detalt,Detifh,Detusp, Detpen,Detlog,Detenv,Detutm,Detcco,Seguridad)
				VALUES 
					('$wbasedato','".date("Y-m-d")."','".date("H:i:s")."','$codigoExamen','$consecutivoOrden','$consecutivoExamen','$estadoExamen','','$fechaDeSolicitado','on','".utf8_decode( $justificacion )."','$item','$usuario','','$impExamen','$altExamen','$firmHCE','$usuario','on','".$cod_log_nuevo1."','".$esOfertado."','".$usuarioTomaMuestra."','".$cco."','C-$wbasedato')";
					
			$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
			
				// var_dump( $datosAdicionales );
			
			if( count( $datosAdicionales ) > 0 )
			{
				$wcliame = consultarAliasPorAplicacion( $conex, $wemp_pmla, "cliame" );
				foreach( $datosAdicionales as $key => $dat ){
					// echo "<pre>dat"; var_dump($dat); echo "</pre>"; 
					// echo "<pre>key";  var_dump($key); echo "<pre>"; 
					$sad = "INSERT INTO {$wbasedato}_000258
							(Medico,Fecha_data,Hora_data, Saotor, Saonro, Saoite, Saocns, Saocor, Saodor, Saocsa, Saodsa, Saoest, Seguridad)
						VALUES 
							('$wcliame','".date("Y-m-d")."','".date("H:i:s")."','$codigoExamen','$consecutivoOrden',$item, ".( $key+1 ).",'".$dat->{'Tipo de muestra'}->codigo."','".$dat->{'Tipo de muestra'}->descripcion."','".$dat->{'Sitio anatomico'}->codigo."','".$dat->{'Sitio anatomico'}->descripcion."','on','C-$wcliame')";
							
					$resAd = mysql_query($sad, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $sad . " - " . mysql_error());
				}
			}
		}
		else {
			
			$estado = "2";
			
			// $filaRep = mysql_fetch_array($resrep);
			$updateExtra = "";
			if( empty( $fila['Detfir'] ) ){
				$estado = "1";
				$updateExtra = ", Fecha_data = '".date("Y-m-d")."', Hora_data ='".date("H:i:s")."' ";
				$audAnterior = "";
				$audNuevo = "N:".$codigoExamen.",".$consecutivoOrden.",".$numeroItem.",".str_replace( "_", " ", $nombreExamen ).",".$estadoExamen.",".utf8_decode( $justificacion ).",".$fechaDeSolicitado;
			}
			else{
				$audAnterior = "A:".$codigoExamen.",".$consecutivoOrden.",".$numeroItem.",".$fila['Descripcion'].",".$fila['Detesi'].",".$fila['Detjus'].",".$fila['Detfec'];
				$audNuevo = "N:".$codigoExamen.",".$consecutivoOrden.",".$numeroItem.",".str_replace( "_", " ", $nombreExamen ).",".$estadoExamen.",".utf8_decode( $justificacion ).",".$fechaDeSolicitado;
				
				//Si el usuario que esta en el programa no tiene firma se deja la firma actual
				if( empty($firma)  ){
					$firma = $fila['Detfir'];
				}
			}
			
			$q = "UPDATE {$wbasedato}_000159 SET
					Detfec = '$fechaDeSolicitado',
					Detjus = '".utf8_decode( $justificacion )."',
					Detesi = '$estadoExamen',
					Detusu = '$usuario',
					Detfir = '$firma',
					Detalt = '$altExamen',
					Detimp = '$impExamen',
					Detest = 'on',
					Detifh = '$firmHCE',
					Detfmo = '".date("Y-m-d")."',
					Dethmo = '".date("H:i:s")."',
					Detenv = ".( !empty( $usuarioTomaMuestra ) || $fechaDeSolicitado != $fila['Detfec'] || ( $estadoExamen == 'C' && $estadoExamen != $fila['Detesi'] ) ? "'".$estadoEnvioMsgHL7."'" : 'Detenv' ).",
					Detutm = ".( !empty( $usuarioTomaMuestra && empty( $fila['Detutm'] ) ) ? "'".$usuarioTomaMuestra."'" : 'Detutm' ).",
					Detftm = ".( !empty( $usuarioTomaMuestra && empty( $fila['Detutm'] ) ) ? "'".$fecha."'" : 'Detftm' ).", 
					Dethtm = ".( !empty( $usuarioTomaMuestra && empty( $fila['Detutm'] ) ) ? "'".date("H:i:s")."'" : 'Dethtm' )." 
					$updateExtra
				WHERE
					Dettor = '$codigoExamen'
					AND Detnro = '$consecutivoOrden'
					AND Detcod = '$consecutivoExamen'
					AND Detite = '$numeroItem'
				";
				
			$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
			
			if( mysql_affected_rows() > 0 ){
			
				@$clUser = consultarUsuarioOrdenes($usuario);
			
				//Pongo los valores por defecto
				$vlPendiente = 'on';
				$vlUsuarioLectura = '';
				$vlFechaLectura = '0000-00-00';
				$vlHoraLectura = '00:00:00';
				
				// if( $clUser->esEnfermeraRolHCE ){
				if( permiteLecturaOrdenesPendientes( $conexion, "01", $clUser->codigoRolHCE ) ){
					//Pongo los valores por defecto
					$vlPendiente = 'off';
					$vlUsuarioLectura = "$usuario";
					$vlFechaLectura = date( "Y-m-d" );
					$vlHoraLectura = date( "H:i:s" );
				}
			
				$modificacionProcedimiento = "";
				if($estado == "2")
				{
					//Busco el codigo para articulo modificado
					$q_log_m = "SELECT Logcod
								  FROM ".$wbasedato."_000174
								 WHERE Logmod = 'on'
								   AND Logest = 'on'";
					$res_log_m = mysql_query($q_log_m, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q_log_m . " - " . mysql_error());
					$row_log_m = mysql_fetch_array($res_log_m);
					$cod_modificacion = $row_log_m['Logcod'];
					
					$modificacionProcedimiento = ",Detlog = '".$cod_modificacion."'";
				}
				
				
				
				$q = "UPDATE {$wbasedato}_000159 SET
						Detusp = '$usuario',
						Detpen = '$vlPendiente',
						Detule = '$vlUsuarioLectura',
						Detfle = '$vlFechaLectura',
						Dethle = '$vlHoraLectura'
						".$modificacionProcedimiento."
					WHERE
						Dettor = '$codigoExamen'
						AND Detnro = '$consecutivoOrden'
						AND Detcod = '$consecutivoExamen'
						AND Detite = '$numeroItem'
					";
				
				$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
				
				
				/************************************************************************************
				 * Mayo 20 de 2020
				 * Se agrega auditoria para toma de muestras desde ordenes
				 ************************************************************************************/
				if( !empty( $usuarioTomaMuestra ) && empty( $fila['Detutm'] ) ){
					
					//Registro de auditoria
					$auditoria = new AuditoriaDTO();

					$auditoria->historia 	= $historia;
					$auditoria->ingreso 	= $ingreso;
					$auditoria->descripcion = $codigoExamen."-".$consecutivoOrden."-".$numeroItem.",".$consecutivoExamen.",".str_replace( "_", " ", $nombreExamen ).",".$usuario;
					$auditoria->fechaKardex = $fecha;
					$auditoria->mensaje 	= obtenerMensaje( "TOMA_MUESTRAS_ORDENES" );
					$auditoria->seguridad 	= $usuario;
					$auditoria->idOriginal 	= '';

					registrarAuditoriaKardex( $conexion, $wbasedato, $auditoria );
				}
				/************************************************************************************/
				
			}
		}
	//	echo "Detalle::".$q;
	}
	
	//Generación de auditoria cambio / creación
//	$audNuevo = "N:".$codigoExamen.",".$estadoExamen.",".$observaciones.",".$fechaDeSolicitado;

	$mensajeAuditoria = "";

	switch ($estado){
		case "1":
			$mensajeAuditoria = obtenerMensaje('MSJ_EXAMEN_CREADO');
			break;
		case "2":
			$mensajeAuditoria = obtenerMensaje('MSJ_EXAMEN_ACTUALIZADO');
			break;
		default:
			$mensajeAuditoria = obtenerMensaje('MSJ_EXAMEN_NO_CREADO');
			$mensajeAuditoria = "";
			break;

	}

	//Registro de auditoria
	$auditoria = new AuditoriaDTO();

	$auditoria->historia = $historia;
	$auditoria->ingreso = $ingreso;
	$auditoria->descripcion = "$audAnterior $audNuevo";
	$auditoria->fechaKardex = $fecha;
	$auditoria->mensaje = $mensajeAuditoria;
	$auditoria->seguridad = $usuario;

	if( trim( $auditoria->descripcion ) != "" ){
		registrarAuditoriaKardex($conexion,$wbasedato,$auditoria);
	}
	
	//A tener en cuenta
	// - $codigoExamen corresponde al servicio de la tabla 17
	// - $consecutivoOrden corresponde al numero de la orden
	// - $consecutivoExamen corresponde al codigo del examen de la 17
	//echo ".......consecutivoExamen: \n".$consecutivoExamen." .... consecutivoOrden:".$consecutivoOrden." \n ........ codigoExamen: ".$codigoExamen;
	datosHL7( $conexion, $wbasedato, $whce, $historia, $ingreso, $consecutivoExamen, $consecutivoOrden, $codigoExamen, $numeroItem, $estadoExamen, $usuario );
	
	liberarConexionBD($conexion);

	return $estado."|$consecutivoOrden|$numeroItem";	//Noviembre 08 de 2012
}

function eliminarArticuloDetalle($wbasedato,$historia,$ingreso,$fecha,$codArticulo,$usuario,$fechaInicio,$horaInicio,$altaArticulo, $idOriginal){
	$conexion = obtenerConexionBD("matrix");

	$estado = "0";

	//Primero verifico si ya existe el artículo en el detalle del kardex para saber si es INSERT o UPDATE
	$q = "SELECT
				Kadart, Kadcfr, Kadufr, Kaddia, Kadest, Kadess, Kadper, Kadffa, Kadfin, Kadhin, Kadvia, Kadfec, Kadcon, Kadobs, Kadsus, Kadcnd, Kaddma, Kaddis, Kaduma, Kadcma, Defdup, Kadido, Kadimp, Kadalt
			FROM
				".$wbasedato."_000060, {$wbasedato}_000059
			WHERE
				 Kadhis = '$historia'
				 AND Kading = '$ingreso'
				 AND Kadart = '$codArticulo'
				 AND Kadart = Defart
				 AND Kadido = '$idOriginal'
				 AND Kadfec = '$fecha'";

	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$fila = mysql_fetch_array($res);
	$num = mysql_num_rows($res);

	if( $num > 0 ){
	
		$audAnterior = "A:".$codArticulo.",".$fila['Kadcfr'].",".$fila['Kadufr'].",".$fila['Kaddia'].",".$fila['Kadest'].",".$fila['Kadess'].",".$fila['Kadfin'].",".$fila['Kadhin'].",".$fila['Kadper'].",".$fila['Kadvia'].",".$fila['Kadfes'].",".$fila['Kadhes'].",".$fila['Kadcon'].",".$fila['Kadobs'].",".$fila['Kadsus'].",".$fila['Kadcnd'].",".$fila['Kaddma'].",".$fila['Kaddis'].",".$fila['Kadcma'].",".$fila['Kaduma'];

		if($altaArticulo=='1')
		{
			
			$q = "DELETE FROM
						".$wbasedato."_000168
					WHERE
						Kadhis = '$historia'
						AND Kading = '$ingreso'
						AND Kadart = '$codArticulo'";
		}
		else
		{
			
			//Si el articulo no es duplicable, borro por codigo de articulo
			if($fila['Defdup'] != 'on'){
				$q = "DELETE FROM
						".$wbasedato."_000060
					WHERE
						Kadhis = '$historia'
						AND Kading = '$ingreso'
						AND Kadart = '$codArticulo'
						AND Kadfec = '$fecha'";
			} else {
				$q = "DELETE FROM
						".$wbasedato."_000060
					WHERE
						Kadhis = '$historia'
						AND Kading = '$ingreso'
						AND Kadart = '$codArticulo'
						AND Kadfec = '$fecha'
						AND Kadfin = '$fechaInicio'
						AND Kadhin = '$horaInicio'
						AND Kadido = '$idOriginal'
						";
			}
		}
		
		$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

		if( mysql_affected_rows() > 1 ){
			registrarAuditoriaCierreKardex( $historia, $ingreso, $usuario, "*Mas de un articulo eliminado*|Kadart:$codArticulo-Kadfec:$fecha-Kadfin:$fechaInicio-Kadhin:$horaInicio|" );	//Mayo 20 de 2011
		}

		$mensajeAuditoria = obtenerMensaje('MSJ_ARTICULO_ELIMINADO');

		//Registro de auditoria
		$auditoria = new AuditoriaDTO();

		$auditoria->historia = $historia;
		$auditoria->ingreso = $ingreso;
		$auditoria->descripcion = "$audAnterior";
		$auditoria->fechaKardex = $fecha;
		$auditoria->mensaje = $mensajeAuditoria;
		$auditoria->seguridad = $usuario;
		$auditoria->idOriginal = $fila['Kadido'];

		registrarAuditoriaKardex($conexion,$wbasedato,$auditoria);

		liberarConexionBD($conexion);
	}

	// return $q;
}

function consultarEsquemaInsulinaPorCodigo($basedatos,$codigo, $art ){
	
	global $wemp_pmla;
	
	$conexion = obtenerConexionBD("matrix");
	
	//Seb busca los codigos que sean personalizados
	$frecuenciasPersonalizadas = consultarAliasPorAplicacion( $conexion, $wemp_pmla, "frecDextrometerPersonalizado" );
	$frecuenciasPersonalizadas = explode( ",", $frecuenciasPersonalizadas );
	
	$esCodigoPersonalizado = in_array( $codigo, $frecuenciasPersonalizadas );

	$q = "SELECT
			Esdcod,Esdest,Esdime,Esdima,Esddos,Esdudo,(SELECT Unides FROM {$basedatos}_000027 WHERE Unicod = Esdudo) unDosis,Esdobs,Esdvia,(SELECT Viades FROM {$basedatos}_000040 WHERE Viacod = Esdvia) via 
		FROM 
			{$basedatos}_000069
  		WHERE 
  			Esdest = 'on'
  			AND Esdcod = '$codigo'
		ORDER by
			Esdime";

	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);
	
	//Consulto la información necesaria para el medicamento
	$sql = "SELECT Defvia, Deffru
			  FROM ".$basedatos."_000059 a, ".$basedatos."_000011 b
			 WHERE a.Defart = '".$art."'
			   AND a.Defest = 'on'
			   AND a.Defcco = b.ccocod
			   AND b.Ccoima = 'off'
			   AND b.Ccotra = 'on'
			   AND b.Ccofac = 'on'";

	$resInfoArt = mysql_query($sql, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
	$numInfoArt = mysql_num_rows($resInfoArt);
	
	$hayInfoArt = false;
	if( $numInfoArt > 0 ){
		if( $rowsInfoArt = mysql_fetch_array( $resInfoArt ) ){
			$viasDispArt = explode( ",", strtoupper( trim( $rowsInfoArt[ 'Defvia' ] ) ) );
			$unidadArt = strtoupper( trim( $rowsInfoArt[ 'Deffru' ] ) );
			$hayInfoArt = true;
		}
	}
	
	//Seleccion de unidades de manejo
	$q2 = "SELECT
			Unicod, Unides
		FROM
			".$basedatos."_000027
		WHERE
			Uniest = 'on'
		ORDER BY
			Unicod;";

	$colUnidades = array();

	$res2 = mysql_query($q2, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());
	$num2 = mysql_num_rows($res2);

	$cont1 = 0;

	while($cont1 < $num2)
	{
		$info = mysql_fetch_array($res2);

		//Si no hay información adicional de medicamento o
		//hay información del medicmaneto y existe la via
		//agrego la unidad de fraccion
		$unidad = new RegistroGenericoDTO();

		$unidad->codigo = $info['Unicod'];
		$unidad->descripcion = $info['Unides'];
		
		//Propiedades adicionales para mostrar en pantalla
		@$unidad->style = "";
			
		// if( !$hayInfoArt || ( $hayInfoArt && strtoupper( $info['Unicod'] ) == $unidadArt ) ){
		if( $hayInfoArt && strtoupper( $info['Unicod'] ) != $unidadArt ){
			$unidad->style = "style='display:none' disabled";
		}
		
		$colUnidades[] = $unidad;
		
		$cont1++;
	}

	//Seleccion de vias de suministro
	$q3 = "SELECT
			Viacod, Viades
		FROM
			".$basedatos."_000040
		ORDER BY
			Viades ASC;";

	$colVias = array();

	$res3 = mysql_query($q3, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q3 . " - " . mysql_error());
	$num3 = mysql_num_rows($res3);

	$cont1 = 0;
	while($cont1 < $num3)
	{
		$info = mysql_fetch_array($res3);

		$via = new RegistroGenericoDTO();

		$via->codigo = $info['Viacod'];
		$via->descripcion = $info['Viades'];
		
		//Esta variable la dejo para darle propiedades al mostrar el html
		$via->style = "";
		
		//Si no hay información adicional de medicamento o
		//hay información del medicmaneto y existe la via
		//agrego la vía
		// if( !$hayInfoArt || ( $hayInfoArt && in_array( strtoupper( $info['Viacod'] ), $viasDispArt ) ) ){
		if( $hayInfoArt && !in_array( strtoupper( $info['Viacod'] ), $viasDispArt ) ){
			$via->style = "style='display:none' disabled";
		}
		
		$colVias[] = $via;
		
		$cont1++;
	}

	$consulta = "<table>";

	$ocultarFilaObservaciones = "style='display:none'";
	
	if( !$esCodigoPersonalizado )
		$consulta = $consulta."<tr class=encabezadoTabla align=center><td>M&iacute;nimo</td><td>M&aacute;ximo</td><td>Dosis</td><td>V&iacute;a</td><td $ocultarFilaObservaciones>Observaciones</td><td style='display:none'>Acciones</td></tr>";
	else
		$consulta = $consulta."<tr class=encabezadoTabla align=center><td>M&iacute;nimo</td><td>M&aacute;ximo</td><td>Dosis</td><td>V&iacute;a</td><td $ocultarFilaObservaciones>Observaciones</td><td>Acciones</td></tr>";

	$cont1 = 0;

	if($num > 0){
		
		$clase = "fila2";
		while ($cont1 < $num)
		{
			$rs = mysql_fetch_array($res);

			if( $cont1 == 0 ){
				/******************************************************************************************
				 * Creando  fila oculta para poder adicionar con mayor facilidad los datos
				 ******************************************************************************************/
				$consulta = $consulta."<tr class=fila1 align=center style='display:none' id='filaCero'>";

				$consulta = $consulta."<td><INPUT type='text' id='wdexRanMin' value='0' style='width:70' onfocus='return setValorRango( this )' onchange='return changeRangoDextrometer(this)' onKeyPress='return validarEntradaEntera(event);'></td>";
				$consulta = $consulta."<td><INPUT type='text' id='wdexRanMax' value='0' style='width:70' onfocus='return setValorRango( this )' onchange='return changeRangoDextrometer(this)' onKeyPress='return validarEntradaEntera(event);'></td>";
				$consulta = $consulta."<td><input type='text' id='wdexint' value='0' size=5 maxlength=6 class='textoNormal' onKeyPress='return validarEntradaEntera(event);' onchange=''> ";

				//Seleccion de unidades de medida
				$consulta = $consulta."<select id='wdexseludo' class=seleccionNormal>";

				foreach ($colUnidades as $unidad){
					if($unidad->codigo == $rs['Esdudo']){
						$consulta = $consulta."<option value='$unidad->codigo' selected>".htmlentities(ucfirst(strtolower($unidad->descripcion)))."</option>";
					} else {
						$consulta = $consulta."<option value='$unidad->codigo' ".$unidad->style.">".htmlentities(ucfirst(strtolower($unidad->descripcion)))."</option>";
					}
				}

				$consulta = $consulta."</select>";
				$consulta = $consulta."</td>";
				
				$consulta = $consulta."<td>";

				//Seleccion de unidades de medida
				$consulta = $consulta."<select id='wdexselvia' class=seleccionNormal>";

				foreach ($colVias as $via){
					if($via->codigo == $rs['Esdvia']){
						$consulta = $consulta."<option value='$via->codigo' selected>".htmlentities($via->descripcion)."</option>";
					} else {
						$consulta = $consulta."<option value='$via->codigo' ".$via->style.">".htmlentities($via->descripcion)."</option>";
					}
				}
				$consulta = $consulta."</select>";
				$consulta = $consulta."</td>";

				$consulta = $consulta."<td $ocultarFilaObservaciones><input type='text' id='wdexobs' value='' size=40 maxlength=40 class='textoNormal'></td>";
				
				$agregarAcciones = "<td>";
				$agregarAcciones = $agregarAcciones."<INPUT type='button' value='Agregar' name='btDexAgregar' onClick='agergarFilaDextormeter();'>";
				$agregarAcciones = $agregarAcciones."<INPUT type='button' value='Eliminar' name='btDexEliminar' onClick='eliminarFilaDextrometer( this );'>";
				$agregarAcciones = $agregarAcciones."</td>";
				
				$consulta = $consulta .$agregarAcciones;

				$consulta = $consulta."</tr>";
				/******************************************************************************************/
			}
		
			if($clase=="fila1"){
				$clase = "fila2";
			} else {
				$clase = "fila1";
			}

			$consulta = $consulta."<tr class=$clase align=center>";
			
			if( $esCodigoPersonalizado ){
				$consulta = $consulta."<td><INPUT type='text' id='wdexRanMin$cont1' value='0' style='width:70' onfocus='return setValorRango( this )' onchange='return changeRangoDextrometer(this)' onKeyPress='return validarEntradaEntera(event);'></td>";
				$consulta = $consulta."<td><INPUT type='text' id='wdexRanMax$cont1' value='1' style='width:70' onfocus='return setValorRango( this )' onchange='return changeRangoDextrometer(this)' onKeyPress='return validarEntradaEntera(event);'></td>";
			}
			else{
				$consulta = $consulta."<td>{$rs['Esdime']}</td>";
				$consulta = $consulta."<td>{$rs['Esdima']}</td>";
			}
			
			$consulta = $consulta."<td><input type='text' id='wdexint$cont1' value='{$rs['Esddos']}' size=5 maxlength=6 class='textoNormal' onKeyPress='return validarEntradaEntera(event);' onchange=';'> ";
			

			//Seleccion de unidades de medida
			$consulta = $consulta."<select id='wdexseludo$cont1' class=seleccionNormal>";

			foreach ($colUnidades as $unidad){
				if($unidad->codigo == $rs['Esdudo']){
					$consulta = $consulta."<option value='$unidad->codigo' selected>".htmlentities(ucfirst(strtolower($unidad->descripcion)))."</option>";
				} else {
					$consulta = $consulta."<option value='$unidad->codigo' ".$unidad->style.">".htmlentities(ucfirst(strtolower($unidad->descripcion)))."</option>";
				}
			}

			$consulta = $consulta."</select>";
			$consulta = $consulta."</td>";

			$consulta = $consulta."<td>";

			//Seleccion de unidades de medida
			$consulta = $consulta."<select id='wdexselvia$cont1' class=seleccionNormal>";

			foreach ($colVias as $via){
				if($via->codigo == $rs['Esdvia']){
					$consulta = $consulta."<option value='$via->codigo' selected>".htmlentities($via->descripcion)."</option>";
				} else {
					$consulta = $consulta."<option value='$via->codigo' ".$via->style.">".htmlentities($via->descripcion)."</option>";
				}
			}
			$consulta = $consulta."</select>";
			$consulta = $consulta."</td>";

			$consulta = $consulta."<td $ocultarFilaObservaciones><input type='text' id='wdexobs$cont1' value='{$rs['Esdobs']}' size=40 maxlength=40 class='textoNormal'></td>";
			
			/******************************************************************************************
			 * Botones para agregar o eliminar fila
			 ******************************************************************************************/
			if( $esCodigoPersonalizado )
				$consulta = $consulta.$agregarAcciones;
			/******************************************************************************************/
			
			$consulta = $consulta."</tr>";

			$cont1++;
		}
	}
	$consulta = $consulta."<input type='hidden' id='contDextrometerPred' value='$cont1'>";
	$consulta = $consulta."<input type='hidden' id='esDexPersonalizado' value='".( $esCodigoPersonalizado ? 'on' : 'off' )."'>";
	$consulta = $consulta."</table>";

	return $consulta;
}

/************************************************************************************************************************
 * Desactiva un item de la orden
 * 
 * @param $wbasedato
 * @param $historia
 * @param $ingreso
 * @param $fecha
 * @param $codigoExamen
 * @param $usuario
 * @param $numeroOrden
 * @param $numeroItem
 * @return unknown_type
 * 
 * Modificaciones
 * 
 * Enero 27 de 2011
 * - Se modifica para que se elimine las ordenes de HCE.
 ************************************************************************************************************************/
function eliminarExamenKardex($wbasedato,$historia,$ingreso,$fecha,$codigoExamen,$numeroOrden,$usuario,$numeroItem ){
	
	global $whce;
	
	$conexion = obtenerConexionBD("matrix");

	$estado = "0";

	//Primero verifico si ya existe el artículo en el detalle del kardex para saber si es INSERT o UPDATE
	$q = "SELECT
				Ekacod,Ekahis,Ekaing,Ekafec,Ekaest,Ekaobs,Ekafes
			FROM
				".$wbasedato."_000061
			WHERE
				 Ekacod = '$codigoExamen'
				 AND Ekahis = '$historia'
				 AND Ekaing = '$ingreso'
				 AND Ekafec = '$fecha'";

	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$fila = mysql_fetch_array($res);
	$num = mysql_num_rows($res);

	$audAnterior = "A:".$fila['Ekacod'].",".$numeroOrden.",".$numeroItem.",".$fila['Ekaest'].",".$fila['Ekaobs'].",".$fila['Ekafes'];

	//Si existe el registro ACTUALIZO caso contrario INSERTO
	$q = "DELETE FROM
				".$wbasedato."_000061
			WHERE
				Ekacod = '$codigoExamen'
				AND Ekahis = '$historia'
				AND Ekaing = '$ingreso'
				AND Ekafec = '$fecha'";

	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

	$mensajeAuditoria = obtenerMensaje('MSJ_EXAMEN_ELIMINADO');

	//Registro de auditoria
	$auditoria = new AuditoriaDTO();

	$auditoria->historia = $historia;
	$auditoria->ingreso = $ingreso;
	$auditoria->descripcion = "$audAnterior";
	$auditoria->fechaKardex = $fecha;
	$auditoria->mensaje = $mensajeAuditoria;
	$auditoria->seguridad = $usuario;

	registrarAuditoriaKardex($conexion,$wbasedato,$auditoria);
	
	
	//Desactivando HL7 para la orden
	$q = "SELECT 
			  Arc_HL7, c.codigo as codigo, a.id as id
		  FROM
			  {$wbasedato}_000159 a, {$whce}_000015 b, {$whce}_000017 c
		  WHERE
			  detcod = c.codigo
			  AND tipoestudio = b.codigo
			  AND Dettor = '$codigoExamen'
			  AND Detnro = '$numeroOrden'
			  AND Detite = '$numeroItem'
		 ;";
		 
	//Desactivando HL7 para la orden
	$q = "SELECT 
			  Arc_HL7, c.codigo as codigo, a.id as id
		  FROM
			  {$wbasedato}_000159 a, {$whce}_000015 b, {$whce}_000047 c
		  WHERE
			  detcod = c.codigo
			  AND tipoestudio = b.codigo
			  AND Dettor = '$codigoExamen'
			  AND Detnro = '$numeroOrden'
			  AND Detite = '$numeroItem'
		UNION
		SELECT 
			  Arc_HL7, c.codigo as codigo, a.id as id
		  FROM
			  {$wbasedato}_000159 a, {$whce}_000015 b, {$whce}_000017 c
		  WHERE
			  detcod = c.codigo
			  AND tipoestudio = b.codigo
			  AND Dettor = '$codigoExamen'
			  AND Detnro = '$numeroOrden'
			  AND Detite = '$numeroItem'
		 ;";

	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	
	if( $rows = mysql_fetch_array( $res ) ){
		
		$sql = "UPDATE
					{$wbasedato}_000159
				SET
					Detest = 'off'
				WHERE
					id = '{$rows['id']}'
				";

		$res = mysql_query( $sql, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
		
		if( trim( $rows['Arc_HL7'] ) != '' && trim(  $rows['Arc_HL7'] ) != 'NO APLICA' ){
			
			$sql = "SELECT 
				 		id
			  		FROM
				  		{$whce}_{$rows['Arc_HL7']}
			  		WHERE
			  			hl7his = '$historia'
					  	AND hl7ing = '$ingreso'
					  	AND hl7des = '$codigoExamen'
					  	AND hl7nor = '$numeroOrden'
					  	AND hl7nit = '$numeroOrden-$numeroItem'
			 		;";
			
			$res = mysql_query($sql, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
			
			for(; $rowsHL7 = mysql_fetch_array( $res ); ){
				cancelarDatosHL7( $conexion, $whce, $rows['Arc_HL7'], $rowsHL7['id'] );
			}
		}
	}
	
	liberarConexionBD($conexion);

	$estado = "1";

	return $estado;
}

function eliminarInfusionKardex($wbasedato,$historia,$ingreso,$fecha,$componentes,$consecutivo,$usuario){
	$conexion = obtenerConexionBD("matrix");

	$estado = "0";

	//Primero verifico si ya existe el artículo en el detalle del kardex para saber si es INSERT o UPDATE
	$q = "SELECT
				Inkhis,Inking,Inkfec,Inkcon,Inkdes,Inkobs
			FROM
				".$wbasedato."_000062
			WHERE
				 Inkhis = '$historia'
				 AND Inking = '$ingreso'
				 AND Inkfec = '$fecha'
				 AND Inkcon = '$consecutivo'";

	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$fila = mysql_fetch_array($res);
	$num = mysql_num_rows($res);

	$audAnterior = "A:".$fila['Inkcon'].",".$fila['Inkdes'].",".$fila['Inkobs'];

	//Si existe el registro ACTUALIZO caso contrario INSERTO
	$q = "DELETE FROM
				".$wbasedato."_000062
			WHERE
				Inkhis = '$historia'
				AND Inking = '$ingreso'
				AND Inkfec = '$fecha'
				AND Inkcon = '$consecutivo'";

	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

	$mensajeAuditoria = obtenerMensaje('MSJ_INFUSION_ELIMINADA');

	//Registro de auditoria
	$auditoria = new AuditoriaDTO();

	$auditoria->historia = $historia;
	$auditoria->ingreso = $ingreso;
	$auditoria->descripcion = "$audAnterior";
	$auditoria->fechaKardex = $fecha;
	$auditoria->mensaje = $mensajeAuditoria;
	$auditoria->seguridad = $usuario;

	registrarAuditoriaKardex($conexion,$wbasedato,$auditoria);

	liberarConexionBD($conexion);

	$estado = "1";

	return $estado;
}

function eliminarMedicoTratante($wbasedato,$historia,$ingreso,$usuario,$cedula_medico,$fecha){
	
	$conexion = obtenerConexionBD("matrix");	
		
	global $wbasedatohce;
	$estado = "0";

	$audAnterior = "A:".$cedula_medico;

	//Mtrhis  Mtring  Mtrmed  Mtrest
	$q = "UPDATE ".$wbasedato."_000063
			 SET Metest = 'off'  
		   WHERE Methis = '".$historia."'
			 AND Meting = '".$ingreso."'
			 AND Metdoc = '".$cedula_medico."'";
	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$mensajeAuditoria = obtenerMensaje('MSJ_MEDICO_RETIRADO');

	//Registro de auditoria
	$auditoria = new AuditoriaDTO();

	$auditoria->historia = $historia;
	$auditoria->ingreso = $ingreso;
	$auditoria->descripcion = "$audAnterior";
	$auditoria->fechaKardex = $fecha;
	$auditoria->mensaje = $mensajeAuditoria;
	$auditoria->seguridad = $usuario;

	registrarAuditoriaKardex($conexion,$wbasedato,$auditoria);

	liberarConexionBD($conexion);

	$estado = "1";

	return $estado;
}

function actualizarAlergiaPorFecha($basedatos,$historia,$ingreso,$fecha,$descripcion,$usuario){
	$conexion = obtenerConexionBD("matrix");

	$estado = "0";

	$q = "UPDATE ".$basedatos."_000053 SET
				Karale = '$descripcion'
			WHERE
				Fecha_data = '$fecha'
				AND	Karhis = '$historia'
				AND Karing = '$ingreso'";

	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

	$mensajeAuditoria = obtenerMensaje('MSJ_ALERGIA_MODIFICADA');

	//Registro de auditoria
	$auditoria = new AuditoriaDTO();

	$auditoria->historia = $historia;
	$auditoria->ingreso = $ingreso;
	$auditoria->descripcion = "N: ".$descripcion;
	$auditoria->fechaKardex = $fecha;
	$auditoria->mensaje = $mensajeAuditoria;
	$auditoria->seguridad = $usuario;

	registrarAuditoriaKardex($conexion,$basedatos,$auditoria);

	liberarConexionBD($conexion);

	$estado = "1";

	return $estado;
}

function grabarEsquemaDextrometer($basedatos,$historia,$ingreso,$fecha,$codInsulina,$frecuencia,$codEsquema,$arrDosis,$arrUDosis,$arrVia,$arrObservaciones,$usuario, $actualizaIntervalos, $arrMin, $arrMax ){
	
	global $user;
	global $wemp_pmla;
	
	$conexion = obtenerConexionBD("matrix");
	
	$clUsuario = consultarUsuarioOrdenes( $usuario );

	$estado = "0";
	
	//Seb busca los codigos que sean personalizados
	$frecuenciasPersonalizadas = consultarAliasPorAplicacion( $conexion, $wemp_pmla, "frecDextrometerPersonalizado" );
	$frecuenciasPersonalizadas = explode( ",", $frecuenciasPersonalizadas );
	
	$esCodigoPersonalizado = in_array( $codEsquema, $frecuenciasPersonalizadas );
	
	$hayCambio = false;

	//Seleccion del esquema dextrometer para obtener los intervalos
	$q2 = "SELECT
				Esdime,Esdima,Esddos,Esdudo,Esdobs,Esdvia  
			FROM 
			{$basedatos}_000069
			WHERE
				Esdest = 'on'
				AND Esdcod = '$codEsquema'
			ORDER BY 
				Esdime;";

	$res2 = mysql_query($q2, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());
	$num2 = mysql_num_rows($res2);

	// if( $clUsuario->esEnfermeraRolHCE ){
	if( permiteLecturaOrdenesPendientes( $conexion, "01", $clUsuario->codigoRolHCE ) ){
	
		//Existe el codigo del dextrometer
		$q = "UPDATE {$basedatos}_000070 SET	
					Infade = '$codInsulina',
					Inffde = '$frecuencia',
					Infcde = '$codEsquema',		
					Infusp = '".$usuario."',
					Infpen = 'off',
					Infule = '".$usuario."',
					Inffle = '".date( "Y-m-d" )."',
					Infhle = '".date( "H:i:s" )."'
				WHERE
					Infhis = '$historia'
					AND Infing = '$ingreso'
					AND Inffec = '$fecha'";
	}
	else{
	
		//Existe el codigo del dextrometer
		$sql = "SELECT * FROM {$basedatos}_000070
				WHERE
					Infhis = '$historia'
					AND Infing = '$ingreso'
					AND Inffec = '$fecha'
					AND Infade = '$codInsulina'
					AND Inffde = '$frecuencia'
					AND Infcde = '$codEsquema'
					";
					
		$resChange = mysql_query( $sql, $conexion ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
		$numChange = mysql_num_rows( $resChange );
	
		if( $numChange == 0 ){
		
			//Existe el codigo del dextrometer
			$q = "UPDATE {$basedatos}_000070 SET
						Infade = '$codInsulina',
						Inffde = '$frecuencia',
						Infcde = '$codEsquema',
						Infusp = '".$usuario."',
						Infpen = 'on',
						Infule = '',
						Inffle = '0000-00-00',
						Infhle = '00:00:00'
					WHERE
						Infhis = '$historia'
						AND Infing = '$ingreso'
						AND Inffec = '$fecha'";
		}
		else{
		
			//Existe el codigo del dextrometer
			$q = "UPDATE {$basedatos}_000070 SET
						Infade = '$codInsulina',
						Inffde = '$frecuencia',
						Infcde = '$codEsquema'
					WHERE
						Infhis = '$historia'
						AND Infing = '$ingreso'
						AND Inffec = '$fecha'";
		}
	}

	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$existe = mysql_affected_rows();

	$descripcion = "$codInsulina,$frecuencia,$codEsquema";

	if($existe <= 0){
	
		// if( $clUsuario->esEnfermeraRolHCE ){
		if( permiteLecturaOrdenesPendientes( $conexion, "01", $clUsuario->codigoRolHCE ) ){
			// exit( "fin....33333" );
			$qIns="INSERT INTO {$basedatos}_000070 (
					Medico, Fecha_data, Hora_data, Infhis, Infing, Inffec, Infade, Inffde, Infcde, Infusp, Infpen, Infule, Inffle, Infhle, Seguridad)
				VALUES
					('movhos','".date("Y-m-d")."','".date("H:i:s")."','".$historia."','".$ingreso."','".$fecha."','".$codInsulina."','$frecuencia','$codEsquema','".$usuario."','off','".$usuario."','".date( "Y-m-d" )."','".date( "H:i:s" )."','A-$usuario')";
		}
		else{
			// exit( "fin....4444" );
			$qIns = "INSERT INTO ".$basedatos."_000070 (Medico, Fecha_data, Hora_data, Infhis, Infing, Inffec, Infade, Inffde, Infcde, Infusp, Infpen, Seguridad)
				VALUES('movhos','".date("Y-m-d")."','".date("H:i:s")."','".$historia."','".$ingreso."','".$fecha."','".$codInsulina."','".$frecuencia."','".$codEsquema."','".$usuario."','on','A-".$usuario."')";
			
		}
// echo "<br>qIns: ".$qIns; exit( "099adsfasfasdf....1111...." );
		$resIns = mysql_query($qIns, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $qIns . " - " . mysql_error());
		
		//Si todo está vacío es por que va a insertar el día anterior
		if( !empty( $codInsulina ) && !empty( $frecuencia ) && !empty( $codEsquema ) ){
		
			//Comparo el registro con el del día anterior
			$slqC = "SELECT * 
					FROM {$basedatos}_000070 a, {$basedatos}_000070 b
					WHERE
						a.Infhis = b.Infhis
						AND a.Infing = b.Infing
						AND a.Inffec = '".date( "Y-m-d" )."'
						AND b.Inffec = '".date( "Y-m-d", time() - 24*3600 )."'
						AND a.Infhis = '$historia'
						AND a.Infing = '$ingreso'
						AND a.Infade = b.Infade
						AND a.Inffde = b.Inffde
						AND a.Infcde = b.Infcde
					";
					
			$resC = mysql_query( $slqC, $conexion ) or die("Error: " . mysql_errno() . " - en el query: " . $qIns . " - " . mysql_error());
			$num = mysql_num_rows( resC );
					
			if( $num == 0 ){
				$hayCambio = true;
			}
		}
	}
	else{
		$hayCambio = true;
	}

	if($actualizaIntervalos == "on"){
		//Borra los intervalos eventuales que existan
		$qDel="DELETE FROM
		{$basedatos}_000071
			WHERE
				Indhis = '$historia'	
				AND Inding = '$ingreso'
				AND Indfec = '$fecha'
			";

		$resDel = mysql_query($qDel, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $qDel . " - " . mysql_error());

		if( !$esCodigoPersonalizado ){
			$cont1 = 0;

			//Los datos de los inputs y selects llegan serializados separados por | (pipe)
			$vecDosis 			= explode("|",$arrDosis);
			$vecUDosis			= explode("|",$arrUDosis);
			$vecVia 			= explode("|",$arrVia);
			$vecObservaciones 	= explode("|",$arrObservaciones);

			while($cont1 < $num2)
			{
				$info = mysql_fetch_array($res2);

				$qInt="INSERT INTO {$basedatos}_000071 (
					Medico, Fecha_data, Hora_data, Indhis, Inding, Indfec, Indime, Indima, Inddos, Indudo, Indobs, Indvia,Indusu,Seguridad)
				VALUES
					('movhos','".date("Y-m-d")."','".date("H:i:s")."','".$historia."','".$ingreso."','".$fecha."','".$info['Esdime']."','".$info['Esdima']."','".$vecDosis[$cont1]."','".$vecUDosis[$cont1]."','".$vecObservaciones[$cont1]."','".$vecVia[$cont1]."','".$usuario."','A-$usuario')";

				$resInt = mysql_query($qInt, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $qInt . " - " . mysql_error());

				$cont1++;
				
				$hayCambio = true;
			}
		}
		else{
			$cont1 = 0;

			//Los datos de los inputs y selects llegan serializados separados por | (pipe)
			$vecDosis 			= explode("|",$arrDosis);
			$vecUDosis			= explode("|",$arrUDosis);
			$vecVia 			= explode("|",$arrVia);
			$vecObservaciones 	= explode("|",$arrObservaciones);
			$min			 	= explode("|",$arrMin);
			$max 				= explode("|",$arrMax);
			
			$numPredefinido = count($vecDosis)-1;	//Con uno menos por que siempre hay uno vacio

			while($cont1 < $numPredefinido)
			{
				$qInt="INSERT INTO {$basedatos}_000071 (
					Medico, Fecha_data, Hora_data, Indhis, Inding, Indfec, Indime, Indima, Inddos, Indudo, Indobs, Indvia,Indusu,Seguridad)
				VALUES
					('movhos','".date("Y-m-d")."','".date("H:i:s")."','".$historia."','".$ingreso."','".$fecha."','".$min[$cont1]."','".$max[$cont1]."','".$vecDosis[$cont1]."','".$vecUDosis[$cont1]."','".$vecObservaciones[$cont1]."','".$vecVia[$cont1]."','".$usuario."','A-$usuario')";

				$resInt = mysql_query($qInt, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $qInt . " - " . mysql_error());

				$cont1++;
				
				$hayCambio = true;
			}
		}
	}

	if( $hayCambio ){
		$mensajeAuditoria = obtenerMensaje('MSJ_ESQUEMA_GRABADO');

		//Registro de auditoria
		$auditoria = new AuditoriaDTO();

		$auditoria->historia = $historia;
		$auditoria->ingreso = $ingreso;
		$auditoria->descripcion = "N: ".$descripcion;
		$auditoria->fechaKardex = $fecha;
		$auditoria->mensaje = $mensajeAuditoria;
		$auditoria->seguridad = $usuario;

		registrarAuditoriaKardex($conexion,$basedatos,$auditoria);
	}

	liberarConexionBD($conexion);

	$estado = "1";

	return $estado;
}

function insertarDietaKardex($wbasedato,$historia,$ingreso,$usuario,$fecha,$idRegistro){
	$conexion = obtenerConexionBD("matrix");

	$q = "INSERT INTO ".$wbasedato."_000064(
				Medico,Fecha_data,Hora_data,Dikcod,Dikhis,Diking,Dikfec,Dikest,Dikusu,Dikusp,Dikpen,Seguridad)
			VALUES
				('movhos','".date("Y-m-d")."','".date("H:i:s")."','".$idRegistro."','".$historia."','".$ingreso."','$fecha','on','$usuario','$usuario','on','A-$usuario')";

	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$audNuevo = "N: $idRegistro";

	//Auditoria
	$mensajeAuditoria = obtenerMensaje('MSJ_DIETA_ASOCIADA');

	//Registro de auditoria
	$auditoria = new AuditoriaDTO();

	$auditoria->historia = $historia;
	$auditoria->ingreso = $ingreso;
	$auditoria->descripcion = "$audNuevo";
	$auditoria->fechaKardex = $fecha;
	$auditoria->mensaje = $mensajeAuditoria;
	$auditoria->seguridad = $usuario;

	registrarAuditoriaKardex($conexion,$wbasedato,$auditoria);

	liberarConexionBD($conexion);

	return "1";
}

function eliminarDietaKardex($wbasedato,$historia,$ingreso,$usuario,$idRegistro,$fecha){
	$conexion = obtenerConexionBD("matrix");

	$estado = "0";

	//Primero verifico si ya existe el artículo en el detalle del kardex para saber si es INSERT o UPDATE
	$q = "SELECT
				Dikcod,Dikhis,Diking,Dikfec,Dikest
			FROM
				".$wbasedato."_000064
			WHERE
				Dikcod = '$idRegistro'
				AND Dikhis = '$historia'
				AND Diking = '$ingreso'
				AND Dikfec = '$fecha'";

	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$fila = mysql_fetch_array($res);
	$num = mysql_num_rows($res);

	$audAnterior = "A: ".$fila['Dikcod'];

	$q = "DELETE FROM
				".$wbasedato."_000064
			WHERE
				Dikcod = '$idRegistro'
				AND Dikhis = '$historia'
				AND Diking = '$ingreso'
				AND Dikest = 'on'";

	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

	$mensajeAuditoria = obtenerMensaje('MSJ_DIETA_RETIRADA');

	//Registro de auditoria
	$auditoria = new AuditoriaDTO();

	$auditoria->historia = $historia;
	$auditoria->ingreso = $ingreso;
	$auditoria->descripcion = "$audAnterior";
	$auditoria->fechaKardex = $fecha;
	$auditoria->mensaje = $mensajeAuditoria;
	$auditoria->seguridad = $usuario;

	registrarAuditoriaKardex($conexion,$wbasedato,$auditoria);

	liberarConexionBD($conexion);

	$estado = "1";

	return $estado;
}
function eliminarEsquemaDextrometer($basedatos,$historia,$ingreso,$fecha,$codInsulina,$usuario,$codEsquema){
	$conexion = obtenerConexionBD("matrix");

	$estado = "0";
	
	if($codEsquema == ""){
	
	$q = "UPDATE
				{$basedatos}_000070
			SET				 
				Infcde = ''		
			WHERE
				Infhis = '$historia'
				AND Infing = '$ingreso'  
				AND Inffec = '$fecha';";
	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	
	}
	
	$audAnterior = "A: $codInsulina";

	$q = "UPDATE
				{$basedatos}_000071
			SET
				Indest = 'off'
			WHERE
				Indhis = '$historia'
				AND Inding = '$ingreso'
				AND Indfec = '$fecha';";

	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

	if( mysql_affected_rows() > 0 ){
		$mensajeAuditoria = obtenerMensaje('MSJ_ESQUEMA_ELIMINADO');

		//Registro de auditoria
		$auditoria = new AuditoriaDTO();

		$auditoria->historia = $historia;
		$auditoria->ingreso = $ingreso;
		$auditoria->descripcion = "$audAnterior";
		$auditoria->fechaKardex = $fecha;
		$auditoria->mensaje = $mensajeAuditoria;
		$auditoria->seguridad = $usuario;

		registrarAuditoriaKardex($conexion,$basedatos,$auditoria);

		liberarConexionBD($conexion);
	}

	$estado = "1";

	return $estado;
 }

function consultarClases($idArbol){
	global $wbasedato;
	global $conex;
	
	$coleccion = array();
	
	$q = "SELECT Clacod, Clades  
			FROM ".$wbasedato."_000072 
		   WHERE Claarb = '$idArbol'
			 AND Claest = 'on'
		ORDER BY Claord ";
	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$cont1 = 0;
	if($num > 0 ){
		while($cont1 <= $num)
		{
			$info = mysql_fetch_array($res);

			$registro = new RegistroSimple();

			$registro->codigo = $info['Clacod'];
			$registro->descripcion = $info['Clades'];

			$cont1++;

			$coleccion[] = $registro;
		}
	}
	return $coleccion;
}

/**
 * El nivel A (primer nivel ya debe estar construido)
 * @param $basedatos
 * @param $nivelA
 * @param $nivelB
 * @param $nivelC
 * @param $nivelD
 * @param $usuario
 * @return unknown_type
 */
function consultarNiveles($basedatos,$nivelA,$nivelB,$nivelC,$nivelD){
	$conexion = obtenerConexionBD("matrix");
	$rama = "";

	//Nivel 1 - Si viene con valor nivelA y el resto no
	if(isset($nivelA) && $nivelA != '' && (!isset($nivelB) || $nivelB == '') && (!isset($nivelC) || $nivelC == '') && (!isset($nivelD) || $nivelD == '')){
		$q = "SELECT
				Prkcod n1, Prkcon n2, '' n3, '' n4, Prkdes des 
			FROM 
				".$basedatos."_000073
			WHERE
				Prkcod = '$nivelA'
				AND Prkest = 'on'
			ORDER BY
				Prkdes;";

		$rama = 1;
	}

	//Nivel 2 - Si viene con valor nivelA, nivelB y el resto no
	if(isset($nivelA) && $nivelA != '' && $nivelB != '' && isset($nivelB) && (!isset($nivelC) || $nivelC == '') && (!isset($nivelD) || $nivelD == '')){
		$q = "SELECT
				Sekcod n1, Sekpri n2, Sekcon n3, '' n4,Sekdes des 
			FROM 
				".$basedatos."_000074
			WHERE
				Sekcod = '$nivelA'
				AND Sekpri = '$nivelB'
			ORDER BY
				Sekdes;";

		$rama = 2;
	}

	//Nivel 3 - Si viene con valor nivelA, nivelB, nivelC y el resto no
	if(isset($nivelA) && $nivelA != '' && isset($nivelB) && $nivelB != '' && isset($nivelC) && $nivelC != '' && (!isset($nivelD) || $nivelD == '')){
		$q = "SELECT
					Tekcod n1, Tekpri n2, Tekseg n3, Tekcon n4, Tekdes des
				FROM
					".$basedatos."_000080
				WHERE
					Tekcod = '$nivelA'
					AND Tekpri = '$nivelB'
					AND Tekseg = '$nivelC'
				ORDER BY
					Tekdes;";

		$rama = 3;
	}

	//Nivel 4 - Si viene con valor nivelA, nivelB, nivelC y nivelD
	if(isset($nivelA) && $nivelA != '' && isset($nivelB) && $nivelB != '' && isset($nivelC) && $nivelC != '' && isset($nivelD) && $nivelD != ''){
		$q = "SELECT
					Cukcod n1, Cukpri n2, Cukseg n3, Cukter n4, Cukcon con, Cukdes des
				FROM
					".$basedatos."_000081
				WHERE
					Cukcod = '$nivelA'
					AND Cukpri = '$nivelB'
					AND Cukseg = '$nivelC'
					AND Cukter = '$nivelD'
				ORDER BY
					Cukdes;";

		$rama = 4;
	}

	$coleccion = array();

	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);


	$cont1 = 0;
	if($num > 0 ){
		while($cont1 < $num)
		{
			$info = mysql_fetch_array($res);

			$id = "{$info['n1']}-{$info['n2']}-{$info['n3']}-{$info['n4']}";

			switch ($rama){ //Verifico si el siguiente nivel tiene ramas
				case '1':
					$q2 = "SELECT
								COUNT(*) cnt2, Sekcod cod2, Sekcon con2, Sekdes des2 
							FROM 
							{$basedatos}_000074
							WHERE 
								Sekcod = '{$info['n1']}'
								AND Sekpri = '{$info['n2']}' 
							GROUP BY 
								Sekcod, Sekcon";
							break;
				case '2':
					$q2 = "SELECT
								COUNT(*) cnt2, Tekcod cod2, Tekcon con2, Tekdes des2 
							FROM 
							{$basedatos}_000080
							WHERE 
								Tekcod = '{$info['n1']}'
								AND Tekpri = '{$info['n2']}'
								AND Tekseg = '{$info['n3']}' 
							GROUP BY 
								Tekcod, Tekcon";
							break;
				case '3':
					$q2 = "SELECT
								COUNT(*) cnt2, Cukcod cod2, Cukcon con2, Cukdes des2 
							FROM 
							{$basedatos}_000081
							WHERE 
								Cukcod = '{$info['n1']}'
								AND Cukpri = '{$info['n2']}'
								AND Cukseg = '{$info['n3']}'
								AND Cukter = '{$info['n4']}' 
							GROUP BY 
								Cukcod, Cukcon";
							break;
				case '4':
					$q2 = "SELECT
								COUNT(*) cnt2, Cukcod cod2, Cukcon con2, Cukdes des2 
							FROM 
							{$basedatos}_000081
							WHERE 
								Id = 0 
							GROUP BY 
								Cukcod, Cukcon";
							break;
				default:
					break;
						
			}

			$res2 = mysql_query($q2, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());
			$num2 = mysql_num_rows($res2);
				
			if($num2 > 0){
				$rama = "R";
				$info2 = mysql_fetch_array($res2);

				echo "<li id='$rama$id'><span>".htmlentities($info['des'])."</span>";
				echo "<ul class='ajax'>";
				echo "<li id='Ajax{$rama}{$id}'>{url:../../../include/movhos/kardex.inc.php?tree_id=1&consultaAjaxKardex=24&nivelA=".$info['n1']."&nivelB=".$info['n2']."&nivelC=".$info['n3']."&nivelD=".$info['n4']."&basedatos=$basedatos}</li>";
				echo "</ul>";
				echo "</li>";
			} else {
				$rama = "H";

				//Hojas finales
				echo "<li id='$rama$id'><span class='text'>".htmlentities($info['des'])."</span></li>";
			}
			$cont1++;
		}
	}
}

function registrarAuditoriaKardex($conexion,$wbasedato, $auditoria){

	$auditoria->descripcion = mysqli_real_escape_string($conexion,$auditoria->descripcion);
	
	$q = "INSERT INTO ".$wbasedato."_000055
				(Medico, Fecha_data, Hora_data, Kauhis, Kauing, Kaudes, Kaufec, Kaumen, Kauido, Seguridad)
			VALUES
				('movhos','".date("Y-m-d")."','".date("H:i:s")."','$auditoria->historia','$auditoria->ingreso','$auditoria->descripcion','$auditoria->fechaKardex','$auditoria->mensaje','$auditoria->idOriginal','A-$auditoria->seguridad')";

	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
}

function grabarInfusionKardex($wbasedato,$historia,$ingreso,$fecha,$componentes,$consecutivo,$observaciones,$usuario,$fechaSolicitud){
	$conexion = obtenerConexionBD("matrix");
	$estado = "0";

	//Primero verifico si ya existe el registro en el detalle para saber si es insert o update
	$q = "SELECT
				Fecha_data, Hora_data, Inkhis, Inking, Inkfec, Inkcon, Inkdes, Inkobs, Inkfes, Seguridad
			FROM
				".$wbasedato."_000062
			WHERE 
				Inkhis = '$historia'
				AND Inking = '$ingreso'
				AND Inkfec = '$fecha'
				AND Inkcon = '$consecutivo'";

	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$fila = mysql_fetch_array($res);
	$num = mysql_num_rows($res);

	//Si existe el registro ACTUALIZO caso contrario INSERTO
	if($num == 0){
		$audAnterior = "";
			
		$q = "INSERT INTO ".$wbasedato."_000062
				(Medico, Fecha_data,Hora_data, Inkhis, Inking, Inkfec, Inkdes, Inkcon, Inkobs, Inkfes, Seguridad)
			VALUES 
				('movhos','".date("Y-m-d")."','".date("H:i:s")."','$historia','$ingreso','$fecha','$componentes','$consecutivo','$observaciones','$fechaSolicitud','A-$usuario')";

		$estado = "1";
	} else {
		$audAnterior = "A:".$fila['Inkcon'].",".$fila['Inkdes'].",".$fila['Inkobs'].",".$fila['Inkfes'];

		$q = "UPDATE ".$wbasedato."_000062 SET
				Inkdes = '$componentes',
				Inkobs = '$observaciones',
				Inkfes = '$fechaSolicitud'
			WHERE 
				Inkhis = '$historia'
				AND Inking = '$ingreso'
				AND Inkfec = '$fecha'
				AND Inkcon = '$consecutivo'";
			
		$estado = "2";
	}
	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

	//Generación de auditoria cambio / creación
	$audNuevo = "N:$consecutivo,$componentes,$observaciones";

	$mensajeAuditoria = "";

	switch ($estado){
		case "1":
			$mensajeAuditoria = obtenerMensaje('MSJ_INFUSION_CREADA');
			break;
		case "2":
			$mensajeAuditoria = obtenerMensaje('MSJ_INFUSION_ACTUALIZADA');
			break;
		default:
			$mensajeAuditoria = obtenerMensaje('MSJ_INFUSION_NO_CREADA');
			break;
	}

	$q = "INSERT INTO ".$wbasedato."_000055
				(Medico, Fecha_data, Hora_data, Kauhis, Kauing, Kaufec, Kaudes, Kaumen, Seguridad)
			VALUES 
				('movhos','".$fecha."','".date("H:i:s")."','$historia','$ingreso','$fecha','$audAnterior $audNuevo','$mensajeAuditoria','A-$usuario')";

	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	liberarConexionBD($conexion);

	return $estado;
}

function suspenderMedicamentoKardex($wbasedato,$historia,$ingreso,$codigoArticulo,$fecha,$estadoSuspension,$fechaInicio,$horaInicio,$usuario,$idOriginal){
	$conexion = obtenerConexionBD("matrix");
	$estado = "0";
	
	$activacion = "";
	$setAprobado = '';
	if($estadoSuspension == 'off'){
		
		//Busco el codigo para la activacion ya que el estado es "off"
		$q = "SELECT Logcod
				FROM ".$wbasedato."_000174
				WHERE Logact = 'on'
				  AND Logest = 'on'";
		$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
		$row = mysql_fetch_array($res);
		$cod_activacion = $row['Logcod'];
		$activacion = ", Kadlog = '$cod_activacion'";
		$setAprobado = ", Kadare='off'";
	}
	else{
		
		//Busco el codigo para la inactivacion ya que el estado es "on"
		$q = "SELECT Logcod
				FROM ".$wbasedato."_000174
				WHERE Logsus = 'on'
				  AND Logest = 'on'";
		$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
		$row = mysql_fetch_array($res);
		$cod_activacion = $row['Logcod'];
		$activacion = ", Kadlog = '$cod_activacion'";
		
	}
	
	
	$q = "UPDATE ".$wbasedato."_000060 SET
				Kadsus = '$estadoSuspension'
				$setAprobado
			WHERE 
				Kadhis = '$historia'
				AND Kading = '$ingreso'
				AND Kadfec = '$fecha'
				AND Kadfin = '$fechaInicio'
				AND Kadhin = '$horaInicio'
				AND Kadart = '$codigoArticulo'
				AND Kadido = '$idOriginal'
				";

	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());	
	$guardar = "suspendido $codigoArticulo - $idOriginal - $usuario = ".print_r($q,true).PHP_EOL;	
	seguimiento($guardar);
	
	$estado = "0";
	// $idOriginal = 0;
	if( mysql_affected_rows() > 0 ){
	
		$estado = "1";		
		
		//Marca el articulo como pendiente.
		$q = "UPDATE ".$wbasedato."_000060 SET
				Kadusp = '$codUsuario',
				Kadpen = 'on' 
				$activacion,
				Kadule = '',
				Kadfle = '0000-00-00',
				Kadhle = ''
			WHERE
				Kadhis = '$historia'
				AND Kading = '$ingreso'
				AND Kadart = '$codigoArticulo'
				AND Kadfec = '$fecha'
				AND Kadhin = '$horaInicio'				
				AND Kadfin = '$fechaInicio'
				AND Kadido = '$idOriginal'";
				
		$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error() );
	}
	else{
		$estadoSuspension = "onoff";
	}
	
	

	$audAnterior = "$codigoArticulo";
	$audNuevo = "";

	//Generación de auditoria cambio / creación
	$mensajeAuditoria = "";

	switch ($estadoSuspension){
		case "on":
			$mensajeAuditoria = obtenerMensaje('MSJ_SUSPENDER_MEDICAMENTO');
			break;
		case "off":
			$mensajeAuditoria = obtenerMensaje('MSJ_ACTIVAR_MEDICAMENTO');
			break;
		default:
			$mensajeAuditoria = obtenerMensaje('MSJ_SUPENSION_NO_MODIFICADA');
			break;
	}

	//Registro de auditoria
	$auditoria = new AuditoriaDTO();

	$auditoria->historia = $historia;
	$auditoria->ingreso = $ingreso;
	$auditoria->descripcion = "$audAnterior";
	$auditoria->fechaKardex = $fecha;
	$auditoria->mensaje = $mensajeAuditoria;
	$auditoria->seguridad = $usuario;
	$auditoria->idOriginal = $idOriginal;

	registrarAuditoriaKardex($conexion,$wbasedato,$auditoria);

	liberarConexionBD($conexion);

	return $estado;
}


function actualizarImpresion($wbasedato,$historia,$ingreso,$fecha){
	$conexion = obtenerConexionBD("matrix");
	$estado = "0";

	$q = " UPDATE ".$wbasedato."_000060 SET
				Kadimp = 'on'
			WHERE 
				Kadhis = '$historia'
				AND Kading = '$ingreso'
				AND Kadfec = '$fecha'
				AND Kadest = 'on'";
	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

	$num_affect = mysql_affected_rows();
	if($num_affect==0)
	{
		$q = " UPDATE ".$wbasedato."_000054 SET
					Kadimp = 'on'
				WHERE 
					Kadhis = '$historia'
					AND Kading = '$ingreso'
					AND Kadfec = '$fecha'
					AND Kadest = 'on'";
		$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	}

	$estado = "1";

	liberarConexionBD($conexion);

	return $estado;
}

function actualizarImpMedicamento($wbasedato,$articuloImp,$historia,$ingreso,$codigoArticulo,$fecha,$fechaInicio,$horaInicio){
	$conexion = obtenerConexionBD("matrix");
	$estado = "0";

	$q = "UPDATE ".$wbasedato."_000060 SET
				Kadimp = '$articuloImp'
			WHERE 
				Kadhis = '$historia'
				AND Kading = '$ingreso'
				AND Kadfec = '$fecha'
				AND Kadart = '$codigoArticulo'";

	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

	$num_affect = mysql_affected_rows();
	if($num_affect==0)
	{
		$q = "UPDATE ".$wbasedato."_000054 SET
					Kadimp = '$articuloImp'
				WHERE 
					Kadhis = '$historia'
					AND Kading = '$ingreso'
					AND Kadfec = '$fecha'
					AND Kadart = '$codigoArticulo'";

		$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	}
	
	$estado = "1";

	liberarConexionBD($conexion);

	return $estado;
}

function actualizarIndicaciones($wbasedato,$historia,$ingreso,$fecha,$indicaciones){
	$conexion = obtenerConexionBD("matrix");
	$estado = "0";
	
	$indicaciones = utf8_decode($indicaciones);
	
	$indicaciones_text = sanear_string($indicaciones);
	
	//Consulto el id Original
	$sql = "SELECT id
			FROM
				".$wbasedato."_000053
			WHERE 
				Karhis = '$historia'
				AND Karing = '$ingreso'
				AND Karest = 'on'
				AND Fecha_data = '$fecha'";
	
	$res = mysql_query($sql, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
	$numrows = mysql_num_rows( $res );
		
	if($numrows>0)
	{
		$q = "UPDATE ".$wbasedato."_000053 SET
					Karegr = '$indicaciones_text'
				WHERE 
					Karhis = '$historia'
					AND Karing = '$ingreso'
					AND Karest = 'on'
					AND Fecha_data = '$fecha'";
		$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	}
	else
	{
		//Consulto el id Original
		$sql = "SELECT id
				FROM
					".$wbasedato."_000053
				WHERE 
					Karhis = '$historia'
					AND Karing = '$ingreso'
					AND Karest = 'on'
				ORDER BY id DESC
				LIMIT 1";
		
		$res = mysql_query($sql, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
		$row = mysql_fetch_array( $res );
		$numrows = mysql_num_rows( $res );
		
		if($numrows>0)
		{
			$q = "UPDATE ".$wbasedato."_000053 SET
						Karegr = '$indicaciones_text'
					WHERE 
						id = '".$row['id']."'";
			$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
		}
	}
	
	$estado = "1";

	liberarConexionBD($conexion);

	return $estado;
}


function actualizarAltaExamen($wbasedato,$imprimirExamen,$codigoExamen,$fecha,$tipo_orden,$numero_orden,$nroItem){
	
	global $wbasedatohce;
	$conexion = obtenerConexionBD("matrix");
	$estado = "0";

	$q = "UPDATE ".$wbasedatohce."_000028 SET
				Detimp = '$imprimirExamen'
			WHERE 
				Dettor = '$tipo_orden'
				AND Detnro = '$numero_orden'
				AND Detcod = '$codigoExamen'
				AND Detite = '$nroItem'
				AND Detfec = '$fecha'";

	$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	
	$estado = "1";

	liberarConexionBD($conexion);

	return $estado;
}


function consultarPestanas(){
	global $conex;
	global $wbasedato;

	$q = "SELECT
				Pescod, Pesnom, Pesest, Pespro, Pespos, Pestab
			FROM
				{$wbasedato}_000075
			WHERE
				Pesest = 'on'
			ORDER BY
				Pespos";

	$res 	= mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num 	= mysql_num_rows($res);

	if ($num > 0)
	{
		$cont1 = 0;

		while ($cont1 < $num){
			$cont1++;

			$pestana = new pestanaKardexDTO();

			$info = mysql_fetch_array($res);

			$pestana->codigoPestana 	= $info['Pescod'];
			$pestana->nombrePestana 	= $info['Pesnom'];
			$pestana->estado 			= $info['Pesest'];
			$pestana->posicion 			= $info['Pespro'];
			$pestana->rutaScript 		= $info['Pespos'];
			$pestana->tablaGrabacion 	= $info['Pestab'];

			$coleccion[] = $pestana;
		}
	}
	return $coleccion;
}
/**
 * Lista los centros de costos hospitalarios
 *
 * @param unknown_type $seleccionCco
 * @param unknown_type $funcion
 */
function centrosCostosHospitalariosOcupados(){
	global $conex;
	global $wbasedato;

  	$q = "SELECT
				ccocod, UPPER(Cconom)
			FROM
				".$wbasedato."_000011,
			(
				SELECT
					Habcco
				FROM
					".$wbasedato."_000020
				WHERE
					Habdis='off'
				GROUP BY
					Habcco
			) a
			WHERE
  				Ccohos = 'on'
  				AND Ccoing = 'off'
  				AND Ccoest = 'on'
  				AND a.Habcco = ccocod
  			UNION
				SELECT
					Ccocod, UPPER(Cconom)
				FROM
					".$wbasedato."_000011
				WHERE
					Ccourg = 'on'
			ORDER by 1;";
	 
	$res1 = mysql_query($q,$conex);
	$num1 = mysql_num_rows($res1);

	$coleccion = array();
	 
	if ($num1 > 0 )
	{
		for ($i=1;$i<=$num1;$i++)
		{
			$cco = new centroCostosDTO();
			$row1 = mysql_fetch_array($res1);

			$cco->codigo = $row1[0];
			$cco->nombre = $row1[1];
				
			$coleccion[] = $cco;
		}
	}
	return $coleccion;
}

function validarFirmaElectronica($basedatos,$usuario,$firma){
	
	global $wemp_pmla;
	
	$conexion = obtenerConexionBD("matrix");
	$wbasedatohce = consultarAliasPorAplicacion($conexion, $wemp_pmla, "hce");
	
	$estado = "";

	$q = "SELECT
			Usucod,Usucla
		FROM 
			".$wbasedatohce."_000020 
		WHERE 
			Usucod = '".$usuario."' 
			AND Usucla = '".$firma."' 
			AND Usuest = 'on';";

	$res = mysql_query($q, $conexion);
	$num = mysql_num_rows($res);

	if($num > 0){
		$estado = "1";
	} else {
		if(!empty($firma)){
			$estado = "2";
		}
	}

	return $estado;
}

function consultarHabitacionPacienteServicio($basedatos,$servicio){
	
	global $wemp_pmla;
	$conexion = obtenerConexionBD("matrix");
	
	$tablaHabitaciones = consultarTablaHabitaciones( $conexion, $basedatos, $servicio );

	$q = "SELECT
			Habcod, Habcco, Habhis, Habing,
			(SELECT CONCAT(pacno1,' ', pacno2,' ', pacap1,' ', pacap2) FROM root_000036, root_000037 WHERE oriced = pacced AND oriori = '01' AND orihis = Habhis AND oriing = Habing AND Oritid = Pactid) nombre
		FROM
			{$tablaHabitaciones}
		WHERE
			Habcco = '$servicio'
			AND Habdis = 'off'
			AND Habhis != ''
			AND Habest = 'on'
		UNION
		SELECT 'Urgencias'Habcod, Ubisac Habcco, Ubihis Habhis, Ubiing Habing, IFNULL((
		SELECT CONCAT( pacno1, ' ', pacno2, ' ', pacap1, ' ', pacap2 )
		FROM root_000036, root_000037
		WHERE oriced = pacced AND oriori = '$wemp_pmla' AND orihis = Ubihis AND oriing = Ubiing AND Oritid = Pactid ) , '')nombre
		FROM
			{$basedatos}_000018, {$basedatos}_000011
		WHERE
			Ccourg = 'on'
			AND Ccocod = Ubisac
			AND Ccoest = 'on'
			AND Ccocod = '$servicio'
			AND {$basedatos}_000018.fecha_data >= DATE_FORMAT(DATE_SUB(NOW(),INTERVAL 2 DAY),'%Y-%m-%d')
		ORDER by 1,5;";

	$res = mysql_query($q, $conexion);
	$num = mysql_num_rows($res);

	//Con select
//	$consulta = "<select name='wselhab' onclick='seleccionHabitacionPaciente();' class='textoNormal'>";
//	$consulta = $consulta."<option value=''>Seleccione</option>";
//
//	$cont1 = 0;
//
//	if($num > 0){
//		while ($cont1 < $num)
//		{
//			$rs = mysql_fetch_array($res);
//
//			if(isset($rs['nombre']) && $rs['nombre'] != ''){
//				$consulta = $consulta."<option value='".$rs['Habhis']."'>".$rs['Habcod']." - ".$rs['nombre']."</option>";
//			}
//			$cont1++;
//		}
//	} else {
//		$consulta = $consulta."<option value=''>No hay habitaciones disponibles</option>";
//	}
//	$consulta = $consulta."</select>";

	//Con tabla
	$consulta = "<table>";

	$cont1 = 0;
	$clase = 'fila1';

	if($num > 0){
		$consulta = $consulta."<tr class=encabezadoTabla align=center>";
		$consulta = $consulta."<td>Habitacion</td>";
		$consulta = $consulta."<td>Historia</td>";
		$consulta = $consulta."<td>Paciente</td>";
		$consulta = $consulta."<td>Accion</td>";
		$consulta = $consulta."</tr>";

		while ($cont1 < $num)
		{
			$rs = mysql_fetch_array($res);

			if(isset($rs['nombre']) && $rs['nombre'] != ''){
				$consulta = $consulta."<tr class='$clase'>";
				if($clase == 'fila2'){
					$clase = 'fila1';
				} else {
					$clase = 'fila2';
				}

				$consulta = $consulta."<td align=center>".$rs['Habcod']."</td>";
				$consulta = $consulta."<td align=center>".$rs['Habhis']."-".$rs['Habing']."</td>";
				$consulta = $consulta."<td>".$rs['nombre']."</td>";
				$consulta = $consulta."<td><a href='irAKardex(\"{$rs['Habhis']}\");'>Ir a kardex</a></td>";
				$consulta = $consulta."</tr>";
			}
			$cont1++;
		}
	} else {
		$consulta = $consulta."<tr><td colspan=3 class=encabezadoTabla>No se encontraron pacientes</td></tr>";
	}
	$consulta = $consulta."</table>";

//	liberarConexionBD($conexion);

	return $consulta;
}

function consultarUsuarioOrdenes($codigo)
{
	global $conex;	
	global $esquemaBDHce;
	global $wbasedato;
	global $codigoAplicacion;
	global $centroCostosServicioFarmaceutico;
	global $centroCostosCentralMezclas;
	global $wemp_pmla;
	global $tipoDocumento;
	global $wcedula;
	global $historia;
	global $ingreso;
	
	// if( empty( $codigo ) ){
		// // $codigo = substr( $_SESSION[ 'user' ], strpos( '-' ) + 1 );
		// $codigo = substr( $_SESSION[ 'user' ], (strpos($_SESSION[ 'user' ], "-") + 1), strlen($_SESSION[ 'user' ]));
	// }
	
	$wbasedato = consultarAliasPorAplicacion( $conex, $wemp_pmla, "movhos" );
	
	if($historia !='' and $ingreso != ''){
		$paciente = consultarInfoPacienteOrdenHCEPorHistoriaIngreso($conex, $wbasedato, $historia, $ingreso);
	}else{
		$paciente = consultarInfoPacienteOrdenHCE($tipoDocumento,$wcedula);
	}

	$fechaActual = date( "Y-m-d" );
	
	//Buscar en la tabla de usuario que cco le pertenece al usuario.
	$qMed = "SELECT *
			   FROM ".$wbasedato."_000048
			  WHERE Meduma = '".$codigo."'				
			    AND Medest = 'on'";
	$resMed = mysql_query($qMed, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qMed . " - " . mysql_error());
	$rowMed = mysql_fetch_array($resMed);
	
	//Buscar en la tabla de usuario que cco le pertenece al usuario.
	$q_user = "SELECT Descripcion, Empresa
			     FROM usuarios
			    WHERE Codigo = '".$codigo."'				
			      AND Activo = 'A'";
	$res_user = mysql_query($q_user, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q_user . " - " . mysql_error());
	$row_user = mysql_fetch_array($res_user);
	
	//Consulta el rol del usuario por el codigo.
	$q2 = "SELECT Usucla,Usurol,Roldes,Rolemp, Rolenf, Rolmed
		     FROM {$esquemaBDHce}_000020,{$esquemaBDHce}_000019
		    WHERE Usucod = '".$codigo."'
			  AND Rolcod = Usurol
			  AND Usuest = 'on'
			  AND Rolest = Usuest
			  AND Usufve > '".$fechaActual."'";
			  //AND NOW() < Usufve";
	$res2 = mysql_query($q2, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());
	$row2 = mysql_fetch_array($res2);	
	$wrol_usuario = $row2['Usurol'];
	
	//Verifica que el rol del usuario tenga la opcion de ordenes relacionada (hce_000026 Tabla de programas anexos a hce)
	$q_opc_ord = "SELECT Rrppro  
					FROM {$esquemaBDHce}_000026
				   WHERE Rrprol = '".$wrol_usuario."'
					 AND Rrppro = 'ordenes'";
	$res_opc_ord = mysql_query($q_opc_ord, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q_opc_ord . " - " . mysql_error());
	$row_rol = mysql_fetch_array($res_opc_ord);	
	
	//Buscar la informacion del centro de costos, segun el ultimo centro de costos del paciente.
	$q = "SELECT Ccocod,Cconom,Ccohos,Ccogka,Ccopek,Ccouct,Ccolac,Ccocir,Ccoing,Ccourg,Ccoior   
			FROM ".$wbasedato."_000011
		   WHERE Ccocod = '".$paciente->servicioActual."'";
	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$consulta = new UsuarioOrden();
	
	//Verifico si tiene firma vencida
	//Esta es la fila del usuario por rol, si no es falso significa que la firma no se ha vencido y tiene codigo y rol activo
	if( $row2 ){
		$consulta->tieneFirmaVencida = false;
	}

	$cont1 = 0;
	
	//Verifica los datos del centro de costos asociado al paciente.
	//Verifica si el rol del usuario actual si esta activo 
	if($num > 0 and $row_rol['Rrppro'] == 'ordenes')
	{
	
		$consulta->registradoMedico = true;
		if( !$rowMed ){
			$consulta->registradoMedico = false;
		}
		
		$rs = mysql_fetch_array($res);		

		$consulta->codigo = $codigo;
		$consulta->descripcion = $row_user['Descripcion'];
		$consulta->empresa = $row_user['Empresa'];
		$consulta->centroCostos = $rs['Ccocod'];

		//Nombre del centro de costos
		if(isset($rs['Cconom']) && !empty($rs['Cconom'])){
			$consulta->nombreCentroCostos = $rs['Cconom'];
		} else {
			$consulta->nombreCentroCostos = "";
		}

		//Es hospitalario o no
		// if(isset($rs['Ccohos']) && !empty($rs['Ccohos']) && ($rs['Ccohos'] == 'on' || $rs['Ccocir'] == 'on'  || $rs['Ccourg'] == 'on' )){	//Abril 1 de 2013. Si el servicio es de urgencia también se debe grabar con *
		if( !empty($rs['Ccolac']) && ($rs['Ccolac'] != 'on') ){	//Abril 1 de 2013. Si el servicio es de urgencia también se debe grabar con *
			$consulta->centroCostosHospitalario = true;
			$consulta->centroCostosGrabacion = "*";
		}
		else {
			$consulta->centroCostosHospitalario = false;
			$consulta->centroCostosGrabacion = $consulta->centroCostos;
		}

		//Pestañas
		if(isset($rs['Ccopek']) && !empty($rs['Ccopek']) && $rs['Ccopek'] != 'NO APLICA'){
			$consulta->pestanasKardex = $rs['Ccopek'];
		} else {
			$consulta->pestanasKardex = "*";
		}

		//Grupos medicamentos
		if(isset($rs['Ccogka']) && !empty($rs['Ccogka']) && $rs['Ccogka'] != 'NO APLICA'){
			$consulta->gruposMedicamentos = $rs['Ccogka'];
		} else {
			$consulta->gruposMedicamentos = "*";
		}
		
		if( isset($rs['Ccocir']) && $rs['Ccocir'] == 'on' ){
			$consulta->esCcoCirugia = true;
		}
		
		if( isset($rs['Ccoing']) && $rs['Ccoing'] == 'on' ){
			$consulta->esCcoIngreso = true;
		}
		
		if( isset($rs['Ccourg']) && $rs['Ccourg'] == 'on' ){
			$consulta->esCcoUrgencias = true;
		}

		//Grupos de medicamentos formateados para ser usados en queries y clausulas tipo IN Ej.  Campo IN ('LTR','LTQ')
		if(isset($rs['Ccogka']) && !empty($rs['Ccogka']) && $rs['Ccogka'] != 'NO APLICA'){
			$gruposIncluidos = "(";
				
			if($rs['Ccogka'] != "*"){
				$vecGrupos = explode(",",$rs['Ccogka']);
				$cuenta = count($vecGrupos);
				$cont1 = 0;
				foreach ($vecGrupos as $grupo){
					$gruposIncluidos .= "'".str_replace(",","','",$grupo)."'";
					if($cont1 < $cuenta-1){
						$gruposIncluidos .= ",";
					}
					$cont1++;
				}
			}
			$gruposIncluidos .= ")";
			$consulta->gruposMedicamentosQuery = $gruposIncluidos;
		} else {
			$consulta->gruposMedicamentosQuery = "('')";
		}

		//Usuario es de central de mezclas
		$consulta->esUsuarioSF = ($consulta->centroCostos == $centroCostosServicioFarmaceutico) ? true : false;

		//Usuario es de servicio farmaceutico
		$consulta->esUsuarioCM = ($consulta->centroCostos == $centroCostosCentralMezclas) ? true : false;

		//Usuario tiene permisos de modificar ctc
		if (strpos($rs['Ccouct'], $consulta->codigo) !== false) {
			$consulta->esUsuarioCTC = true;
		} else {
			$consulta->esUsuarioCTC = false;
		}

		//Usuario es de lactario
		if(isset($rs['Ccolac']) && !empty($rs['Ccolac']) && $rs['Ccolac'] == 'on'){
			$consulta->esUsuarioLactario = true;
		} else {
			$consulta->esUsuarioLactario = false;
		}

		//***CONSULTAS DEL ESQUEMA DE HCE
		//Rolcod  Roldes  Rolatr  Rolemp  Rolest
		$q2 = "SELECT
				Usucla,Usurol,Roldes,Rolemp, Rolenf, Rolmed
			FROM 
			{$esquemaBDHce}_000020,{$esquemaBDHce}_000019
			WHERE
				Usucod = '".$consulta->codigo."'
				AND Rolcod = Usurol
				AND Usuest = 'on'
				AND Rolest = Usuest
				AND Usufve > '".$fechaActual."'";
				//AND NOW() < Usufve";

		$res2 = mysql_query($q2, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q2 . " - " . mysql_error());
		$num2 = mysql_num_rows($res2);

		if($num2 > 0)
		{
			$rs2 = mysql_fetch_array($res2);
				
			$consulta->codigoRolHCE = $rs2['Usurol'];
			$consulta->nombreRolHCE = $rs2['Roldes'];
			$consulta->esEnfermeraRolHCE = $rs2['Rolenf'] == 'on' ? true: false;
			$consulta->esMedicoRolHCE = $rs2['Rolmed'] == 'on' ? true: false ;
				
			if($rs2['Rolemp'] != '' && $rs2['Rolemp'] != 'NO APLICA'){
				$consulta->codigoEmpresaAgrupada = $rs2['Rolemp'];
			} else {
				$consulta->codigoEmpresaAgrupada = "*";
			}
				
			//Pronom  Proest
			//Rrprol  Rrppro  Rrpopc  Rrpgra  Rrpest
			//Oprpro  Oprnop  Oprdop  Oprest
			$q3 = "SELECT
					Rrprol,Rrpnpe,Pronom,(Rrpopc+0) as Rrpopc,Rrpgra,Oprdop,Oprmod,Oprord*1 as Oprord
				FROM 
				{$esquemaBDHce}_000026,{$esquemaBDHce}_000023,{$esquemaBDHce}_000024
				WHERE
					Pronom = '".$codigoAplicacion."' 
					AND Rrprol = '$consulta->codigoRolHCE'
					AND Proest = 'on'
					AND Rrpest = Proest
					AND Oprest = Proest
					AND Rrppro = Pronom
					AND Oprpro = Pronom
					AND Oprnop = Rrpopc
				ORDER BY
					Oprord asc";

			$res3 = mysql_query($q3, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q3 . " - " . mysql_error());
			$num3 = mysql_num_rows($res3);

			//			Pestañas ordenes HCE.  Nomenclatura:  CODIGO|NOMBRE|GRABA(on/off)
			while($rs3 = mysql_fetch_array($res3)){
				// 2012-08-03
				// Se cambió $rs3['Rrpnpe'] por $rs3['Oprdop'] ya que se necesita que el nombre de las pestañas 
				// esté definido por la tabla hce_000024 y no por hce_000026
				// 2015-02-09
				//Se vuelve a utilizar el campo Rrpnpe por peticion de Juan Carlos
				$consulta->pestanasHCE .= $rs3['Rrpopc']."|".$rs3['Rrpnpe']."|".$rs3['Rrpgra'].";";
				$consulta->permisosPestanas[ $rs3['Rrpopc'] ]['modifica'] = ( $rs3['Oprmod'] == "on" ) ? true: false;	//Indica si el medico puede modificar
			}
				
			//Empresas agrupadas
			if($consulta->codigoEmpresaAgrupada != "*"){
				
				$q4 = "SELECT
							Empdes,Empemp 
						FROM 
							{$esquemaBDHce}_000025
						WHERE
							Empcod = '$consulta->codigoEmpresaAgrupada'
							AND Empest = 'on'";

				$res4 = mysql_query($q4, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q4 . " - " . mysql_error());
				$num4 = mysql_num_rows($res4);
					
				//Pestañas ordenes HCE.  Nomenclatura:  NITS SEPARADOS POR COMA
				while($rs4 = mysql_fetch_array($res4)){
					$consulta->empresasAgrupadas = $rs4['Empemp'];
					$consulta->nombreEmpresaAgrupada = $rs4['Empdes'];
				}
			} else {
				$consulta->empresasAgrupadas = "*";
				$consulta->nombreEmpresaAgrupada = "TODAS LAS EMPRESAS";
			}

			//Consulta de posibilidad de firmar si el rol lo permite
			$q4 = "SELECT
						Prorol,Proprg,Profir  
					FROM 
						{$esquemaBDHce}_000030
					WHERE
						Proprg = '".$codigoAplicacion."' 
						AND Prorol = '$consulta->codigoRolHCE'";

			$res4 = mysql_query($q4, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q4 . " - " . mysql_error());
			$num4 = mysql_num_rows($res4);

			//Pestañas ordenes HCE.  Nomenclatura:  CODIGO|NOMBRE|GRABA(on/off)
			$consulta->firmaElectronicamente = false;
			if($rs4 = mysql_fetch_array($res4)){
				$consulta->firmaElectronicamente = $rs4['Profir'] == "on" ? true : false;
			}
		}
	}
	return $consulta;
}



/*
 * AJAX::ConsultarArticulosPorNombre
 */
function consultarArticulos($wbasedato,$wemp_pmla,$criterio,$ccoPaciente){
	//Variable que se necesitan
	$centroCostos = "1183";
	$criterio = strtoupper($criterio);
	
	global $conex;

	$coleccion = array();
	$consulta = "";

	global $centroCostosServicioFarmaceutico;
	global $codigoServicioFarmaceutico;
	global $codigoCentralMezclas;
	global $centroCostosCentralMezclas;
	
	global $protocoloNormal;
	
	$wcenmez = consultarAliasPorAplicacion( $conex, $wemp_pmla, "cenmez" );

	$esSF = $centroCostos == $centroCostosServicioFarmaceutico ? true : false;
	$esCM = $centroCostos == $centroCostosCentralMezclas ? true : false;

	@$codigo = str_replace("-","%",$codigo);

	$observacionesDA = "";
	
	$tipoArticulo = "";
	$tipoGenerico = "";
	$parametrosFijosArticuloGenerico = array();
	
	//*******************************Grupos que puede ver el centro de costos del usuario
	$tieneGruposIncluidos = false;
	$gruposIncluidos = "(";

	$q6 = "SELECT DISTINCT Ccogka FROM {$wbasedato}_000011 WHERE Ccoest='on' AND Ccogka != '*' AND Ccocod='$centroCostos';";
	$res6 = mysql_query($q6, $conex);

	while($rs6 = mysql_fetch_array($res6)){
		$tieneGruposIncluidos = true;
		if(strpos($rs6['Ccogka'],$gruposIncluidos) === false){
			$gruposIncluidos .= "'".str_replace(",","','",$rs6['Ccogka'])."',";
		}
	}
	$gruposIncluidos .= "'')";
	//********************************

	//Preproceso de los grupos de medicamentos.  De formato X00,Y00,Z00... a 'X00','Y00','Z00'
	$criterioGrupo = "";
	@$vecGruposMedicamentos = explode(",",$gruposMedicamentos);

	$cont2 = 0;
	while($cont2 < count($vecGruposMedicamentos)){
		$criterioGrupo .= "'".$vecGruposMedicamentos[$cont2]."',";
		$cont2++;
	}
	$criterioGrupo .= "''";

	/*La consulta de medicamentos o articulos tiene los siguientes elementos:
	 * -Criterios aplicados:  Codigo, Nombre generico, Nombre comercial
	 * -Tipo protocolo
	 * 
	 */
	
	//Con el fin de obtener los genericos se tendra en cuenta unicamente la primera palabra de la consulta antes del espacio
	$vecCriterio = explode("%",$criterio);
	$criterioCM = $vecCriterio[0];
	
	//Por codigo
	$qSfCod = "SELECT "
	." 		Artcod, Artcom, Artgen, Artuni, Unides, '$codigoServicioFarmaceutico' origen, SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru, IFNULL(Artfar,'00') Artfar, Artpos, '' Arttip , Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia "
	." FROM "
	." 		{$wbasedato}_000027, {$wbasedato}_000026, {$wbasedato}_000059 "
	." WHERE "
	."		artuni = unicod "
	."		AND artcod LIKE '%".$criterio."%' "
	."		AND artcod = Defart "
	."		AND artest = 'on' "
	."		AND Defest = 'on' ";

	$qCmCod = "SELECT "
	."	Artcod, Artcom, Artgen, Artuni, Unides, '$codigoCentralMezclas' origen, '' Artgru, '00' Artfar, '' Artpos, Arttip , Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia "
	." FROM "
	." {$wbasedato}_000027, {$wcenmez}_000002, {$wbasedato}_000059 "
	." WHERE "
	."  artuni = unicod "
	."	AND artcod LIKE '%".$criterioCM."%' "
	."	AND artcod = Defart "
	."	AND artest = 'on' "
	."	AND Defest = 'on' ";

	//Por nombre generico
	$qSfGen = "SELECT "
	." 		Artcod, Artcom, Artgen, Artuni, Unides, '$codigoServicioFarmaceutico' origen, SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru, IFNULL(Artfar,'00') Artfar, Artpos, '' Arttip, Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia "
	." FROM "
	." 		{$wbasedato}_000027, {$wbasedato}_000026, {$wbasedato}_000059 "
	." WHERE "
	."		artuni = unicod "
	."		AND Artgen LIKE '%".$criterio."%' "
	."		AND artcod = Defart "
	."		AND artest = 'on' "
	."		AND Defest = 'on' ";

	$qCmGen = "SELECT "
	."	Artcod, Artcom, Artgen, Artuni, Unides, '$codigoCentralMezclas' origen, '' Artgru, '00' Artfar, '' Artpos, Arttip , Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia "
	." FROM "
	." {$wbasedato}_000027, {$wcenmez}_000002, {$wbasedato}_000059 "
	." WHERE "
	."  artuni = unicod "
	."	AND Artgen LIKE '%".$criterioCM."%' "
	."	AND artcod = Defart "
	."	AND artest = 'on' "
	."	AND Defest = 'on' ";
	
	//Por nombre comercial
	$qSfCom = "SELECT "
	." 		Artcod, Artcom, Artgen, Artuni, Unides, '$codigoServicioFarmaceutico' origen, SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru, IFNULL(Artfar,'00') Artfar, Artpos, '' Arttip , Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia "
	." FROM "
	." 		{$wbasedato}_000027, {$wbasedato}_000026, {$wbasedato}_000059 "
	." WHERE "
	."		artuni = unicod "
	."		AND Artcom LIKE '%".$criterio."%' "
	."		AND artcod = Defart "
	."		AND artest = 'on' "
	."		AND Defest = 'on' ";

	$qCmCom = "SELECT "
	."	Artcod, Artcom, Artgen, Artuni, Unides, '$codigoCentralMezclas' origen, '' Artgru, '00' Artfar, '' Artpos, Arttip, Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia "
	." FROM "
	." {$wbasedato}_000027, {$wcenmez}_000002, {$wbasedato}_000059 "
	." WHERE "
	."  artuni = unicod "
	."	AND Artcom LIKE '%".$criterioCM."%' "
	."	AND artcod = Defart "
	."	AND artest = 'on' "
	."	AND Defest = 'on' ";
	
	$q = $qSfCod;
	$q.= " UNION ".$qCmCod;
	$q.= " UNION ".$qSfGen;
	$q.= " UNION ".$qCmGen;
	$q.= " UNION ".$qSfCom;
	$q.= " UNION ".$qCmCom;
	
	//Si es usuario de central de mezclas SOLO se le permitirá ver lo de la central
//	if($esCM){
//		$q = $q." UNION ".$subConsulta;
//	} else {
//		if(!$tieneGruposIncluidos){
//			$q = $q." UNION ".$subConsulta;
//		}
//	}
	$q = $q." LIMIT 100";
	
//	echo $q;
	
//	$q = "SELECT "
//				." Artcod, Artcom, Artuni, Unides, '$codigoServicioFarmaceutico' origen, SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru, IFNULL(Artfar,'00') Artfar, Artpos, Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia "
//			." FROM "
//				." {$wbasedato}_000027, {$wbasedato}_000026, {$wbasedato}_000059 "
//			." WHERE "
//			."	artuni = unicod "
//			."	AND artcod LIKE '%".$codigo."%' "
//			."	AND Artuni LIKE '$unidadMedida' "
//			."	AND artcod = Defart "
//			."	AND artest = 'on' "
//			."	AND Defest = 'on' ";
//				if($tieneGruposIncluidos){
//					$q .= " AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN $gruposIncluidos ";
//				}
//				$q .= " AND Defcco = '$centroCostosServicioFarmaceutico' ";
//			if($gruposMedicamentos != "*"){
//				$q = $q."AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN (SELECT Melgru FROM {$wbasedato}_000066 WHERE Melest = 'on' AND Meltip = 'M' AND Melgru IN ($criterioGrupo)) ";
//			} else {
//				$q = $q."AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN (SELECT Melgru FROM {$wbasedato}_000066 WHERE Melest = 'on' AND Meltip = 'M') ";
//			}
//
//			$subConsulta = "SELECT "
//							."	Artcod, Artcom, Artuni, Unides, '$codigoCentralMezclas' origen, '' Artgru, '00' Artfar, '' Artpos, Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia "
//							." FROM "
//								." {$wbasedato}_000027, cenpro_000002, {$wbasedato}_000059 "
//							." WHERE "
//							."  artuni = unicod "
//							."	AND artcod LIKE '%".$codigo."%' "
//							."	AND Artuni LIKE '$unidadMedida' "
//							."	AND artcod = Defart "
//							."	AND artest = 'on' "
//							."	AND Defest = 'on' "
//							."	AND Defcco = '$centroCostosCentralMezclas'";
//
//			 //Si es usuario de central de mezclas SOLO se le permitirá ver lo de la central
//			if($esCM){
//				$q = $q." UNION ".$subConsulta;
//			} else {
//				if(!$tieneGruposIncluidos){
//					$q = $q." UNION ".$subConsulta;
//				}
//			}
//			$q = $q." LIMIT 100";
//			break;
//	echo $q;
	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$cont1 = 0;
	$agrupoGenericos = false;
	$abreVentanaModal = "";
	
	if($num > 0){
		$codigoGenericoArticulo = "";
		
		while ($cont1 < $num)
		{
			$tieneParametrosFijos = "N";
			$nombreArticuloGenerico = "";
			$puedeAgregar = true;
			
			$rs = mysql_fetch_array($res);
			
			$tipoProtocolo = $protocoloNormal;
			$tipoArticuloMedicamentoLiquido = "M";
			$tipoGenerico = "";
			$tipoArticulo = "1";
			$borrar = "";
			
			// //Consulta del tipo al que pertenece
			// $qTipLM = "SELECT Meltip FROM {$wbasedato}_000066 WHERE Melgru = '{$rs['Artgru']}' AND Melest='on' ";
			// $resTipLM = mysql_query($qTipLM, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qTipLM . " - " . mysql_error());
			// if($infoTipLM = mysql_fetch_array($resTipLM)){
				// $tipoArticuloMedicamentoLiquido = $infoTipLM['Meltip'];
			// }
			
			//Consulta del protocolo al que pertenece el articulo
			$qProt = "SELECT Arkcod,Arkest,Arkcco,Arktip FROM {$wbasedato}_000068 WHERE Arkcod = '{$rs['Artcod']}'";
			$resProt = mysql_query($qProt, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qProt . " - " . mysql_error());
			if($infoProt = mysql_fetch_array($resProt)){
				$tipoProtocolo = $infoProt['Arktip'];
			}
			
			$color = "red";
			$fftica = $rs['Artfar'];

			//CLASIFICACION DE LOS ARTICULOS
			
			/*TIPOS DE ARTICULOS
			 * 1.  Articulos del maestro de SF
			 * 2.  Articulos del maestro de CM
			 * 3.  Articulos genericos NU,QT,DA dependiendo del tipo en la tabla 68 y la 2
			 * 4.  
			 */
			if($rs['origen'] == $codigoServicioFarmaceutico){ 		//No tiene genéricos
				$tipoGenerico = "";
			}
			
			//On
			/*
					echo "Tipo gen: ".$qTipGen."<br>";
					echo "rs: ".$rs['origen']."<br>";
					echo "central M : ".$codigoCentralMezclas."<br>";
					echo "tipo: ".$rs['Arttip']."<br>";
					*/
			
			if($rs['origen'] == $codigoCentralMezclas){  			//Puede tener genéricos
				//Consulta del tipo al que pertenece
				$tipoCentralMezclas = $rs['Arttip'];
				
				if(!empty($tipoCentralMezclas)){
					$qTipGen = "SELECT Arkcod, Tiptpr, Tipdes FROM {$wcenmez}_000001, {$wbasedato}_000068 WHERE Tipcod = '{$tipoCentralMezclas}' AND Arktip = Tiptpr";
					$resTipGen = mysql_query($qTipGen, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qTipGen . " - " . mysql_error());
					if($infoTipGen = mysql_fetch_array($resTipGen)){
						$tipoGenerico = $infoTipGen['Tiptpr'];
						$codigoGenericoArticulo = $infoTipGen['Arkcod'];
						$articuloGenerico = true;
					} else {
						$articuloGenerico = false;
					}
				} else {
					$qTipGen = "SELECT Arkcod, Arktip FROM {$wbasedato}_000068, {$wbasedato}_000098 WHERE Arkcod = '{$rs['Artcod']}' AND Cartip = Arktip";
					
					$resTipGen = mysql_query($qTipGen, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qTipGen . " - " . mysql_error());
					if($infoTipGen = mysql_fetch_array($resTipGen)){
						$tipoGenerico = $infoTipGen['Arktip'];
						$codigoGenericoArticulo = $infoTipGen['Arkcod'];
						$articuloGenerico = true;
					} else {
						$articuloGenerico = false;
					}
				}
				
				if($articuloGenerico){
					//Partip  Parcdo  Parudo  Parnen  Parfre  Parvia  Parcon  Parcnf  Pardim  Pardom  Parobs
					$qParametros = "SELECT Parcdo,Parudo,Parnen,Parfre,Parvia,Parcon,Parcnf,Pardim,Pardom,Parobs FROM {$wbasedato}_000097 WHERE Partip = '{$tipoGenerico}';";
					$resParametros = mysql_query($qParametros, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qParametros . " - " . mysql_error());
					if($infoParametros = mysql_fetch_array($resParametros)){
						$tieneParametrosFijos = "S";

						$parametrosFijosArticuloGenerico[0] = $infoParametros['Parcdo'];		//Cantidad de dosis
						$parametrosFijosArticuloGenerico[1] = $infoParametros['Parudo'];		//Unidad de dosis
						$parametrosFijosArticuloGenerico[2] = $infoParametros['Parnen'];		//No enviar
						$parametrosFijosArticuloGenerico[3] = $infoParametros['Parfre'];		//Frecuencia
						$parametrosFijosArticuloGenerico[4] = $infoParametros['Parvia'];		//Vias de administracion
						$parametrosFijosArticuloGenerico[5] = $infoParametros['Parcon'];		//Condicion de suministro
						$parametrosFijosArticuloGenerico[6] = $infoParametros['Parcnf'];		//Confirmada preparacion
						$parametrosFijosArticuloGenerico[7] = $infoParametros['Pardim'];		//Dias maximos tratamiento
						$parametrosFijosArticuloGenerico[8] = $infoParametros['Pardom'];		//Dosis maximas tratamiento
						$parametrosFijosArticuloGenerico[9] = $infoParametros['Parobs'];		//Observaciones
					}
				}
			}
			
			//Si tiene componentes asociados en la tabla de componentes por tipo, mostrará los tipos
			$qComp = "SELECT Cartip,Carcod,Carcco,Cardis FROM {$wbasedato}_000098 WHERE Cartip = '{$tipoGenerico}';";
			$resComp = mysql_query($qComp, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qComp . " - " . mysql_error());
			$componentesTipo = "";
			$tieneComponentes = false;
			while($infoComp = mysql_fetch_array($resComp)){
				if($infoComp['Carcco'] == $centroCostosServicioFarmaceutico ){
					$qArt = "SELECT Artcom,Artgen FROM {$wbasedato}_000026 WHERE Artcod = '{$infoComp['Carcod']}';";
				} else {
					$qArt = "SELECT Artcom,Artgen FROM {$wcenmez}_000002 WHERE Artcod = '{$infoComp['Carcod']}';";
				}
				$resArt = mysql_query($qArt, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qArt . " - " . mysql_error());
				if($infoArt = mysql_fetch_array($resArt)){
					$componentesTipo .= $infoComp['Carcod']."**";
					$componentesTipo .= $infoComp['Cardis']."**";
					$componentesTipo .= utf8_decode($infoArt['Artcom'])."**";
					$componentesTipo .= utf8_decode($infoArt['Artgen']).";";
				}
				$tieneComponentes = true;
			}
			
			if(str_replace("%"," ",$codigo)){
				$nombreArticuloPersonalizado = "S";
			}
			
			//Clasificacion por tipo
			if($tipoArticuloMedicamentoLiquido == "L"){
				$tipoArticulo = "2";
			}
			
			//Casos posibles de tipo de articulo
			switch($tipoArticulo){
				case '1':	//Articulo generico
					$borrar .= " generico";
 					break;
				case '2':	//Articulo liquido
					$borrar .= " liquido";
					break;
				default:	//Articulo normal
					$borrar .= " normal";
					break;
			}

			
			if(@$articuloGenerico){
				
				// 2012-07-25
				// Se modificaron las asignaciones a las variables para que tomen el nombre del articulo y no el criterio de busqueda
				// ya que e criterio en la nueva busqueda por amilia siempre va a ser un codig, no un nombre
				@$articuloCodigoConsulta = $rs['Artcod'];  // $codigoGenericoArticulo;
				@$articuloNombreGenerico = "*".$rs['Artgen'];  // "*".str_replace("%"," ",$rs['Artgen']);
				@$articuloNombreComercial = $rs['Artcom'];  // $criterioCM
				
				$nombreArticuloGenerico = $articuloNombreGenerico;
				
				if(!$agrupoGenericos){
					$agrupoGenericos = true;
					$puedeAgregar = true;
				} else {
					$puedeAgregar = false;
				}
			} else {
				$articuloCodigoConsulta = $rs['Artcod'];
				$articuloNombreGenerico = $rs['Artgen'];
				$articuloNombreComercial = $rs['Artcom'];
			}
			
			//Consulto el nombre del principio articulo 
			$qPac = "SELECT Paccod, Pacdes, Pacest 
						FROM {$wbasedato}_000114, {$wbasedato}_000115, {$wbasedato}_000176, {$wbasedato}_000181
					   WHERE Relart = '{$rs['Artcod']}'
					     AND Famcod = Relfam
						 AND Relest = 'on'
						 AND Parfam = Famcod
						 AND Parpac = Paccod
						 AND Parest = 'on'
					 ";
			$resPac = mysql_query($qPac, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qPac . " - " . mysql_error());
			$principioActivo = "";
			$codigoPrincipioActivo = "";
			while($infoPact = mysql_fetch_array($resPac))
			{
				$principioActivo .= ",".$infoPact['Pacdes'];
				$codigoPrincipioActivo .= ",".$infoPact['Paccod'];
			}
			
			//Los articulos J deben ser pedidos genericos por central
//			if($rs['origen'] == $codigoCentralMezclas){
//				$color = "blue";
//				$fftica = '00';
//				if(!$esCM && !$esSF && substr(strtoupper($rs['Artcod']),0,1) == "J"){
//					$puedeAgregar = false;
//				}
//			}
				
			/*FORMATO DE LA RESPUESTA PARA EL AUTOCOMPLETE:
			 * Argumentos:
			 * 
			 * 0: Como se muestra en el autocomplete
			 * 1: Codigo del articulo
			 * 2: Nombre comercial del articulo
			 * 3: Nombre genérico del articulo
			 * 4: Tipo protocolo
			 * 5: (M)edicamento o (L)iquido
			 * 6: Es generico
			 * 7: Origen
			 * 8: Grupo de medicamento
			 * 9: Forma farmaceutica
			 * 10:Unidad
			 * 11:POS
			 * 12:Unidad de fraccion
			 * 13:Cantidad de fracciones
			 * 14:Vencimiento
			 * 15:Dias de estabilidad
			 * 16:Es dispensable
			 * 17:Es duplicable
			 * 18:Dias maximos sugeridos
			 * 19:Dosis maximas sugeridas
			 * 20:Via
			 * 21:Abre ventana parametrizada ----
			 * 22:Cantidad de dosis
			 * 23:Unidad de dosis
			 * 24:No enviar
			 * 25:Frecuencia
			 * 26:Vias de administracion
			 * 27:Condicion de suministro
			 * 28:Confirmada preparacion
			 * 29:Dias maximos tratamiento
			 * 30:Dosis maximas tratamiento
			 * 31:Observaciones adicionales
			 * 32:Componentes asociados al tipo
			 * 33:Observaciones si es Dosis Adaptada
			 */
			if($puedeAgregar)
			{
				if($tieneComponentes){
					$abreVentanaModal = "S";
				} else {
					$abreVentanaModal = "N";
				}
				
				$noEnviar = ( esStock( $conex, $wbasedato, $rs['Artcod'], $ccoPaciente ) == true )? 'on' : 'off';
				
//				$referencia = "seleccionarMedicamento('".$rs['Artcod']."','".str_replace(" ","_",trim(htmlentities($rs[1])))."','".$rs['origen']."','".str_replace(" ","_",trim($rs['Artgru']))."','".str_replace(" ","_",trim($fftica))."','".str_replace(" ","_",trim($rs['Artuni']))."','".str_replace(" ","_",trim($rs['Artpos']))."','".str_replace(" ","_",trim($rs['Deffru']))."','".str_replace(" ","_",trim($rs['Deffra']))."','".str_replace(" ","_",trim($rs['Defven']))."','".str_replace(" ","_",trim($rs['Defdie']))."','".str_replace(" ","_",trim($rs['Defdis']))."','".str_replace(" ","_",trim($rs['Defdup']))."','".str_replace(" ","_",trim($rs['Defdim']))."','".str_replace(" ","_",trim($rs['Defdom']))."','".str_replace(" ","_",trim($rs['Defvia']))."','".$tipoProtocolo."');";
				$consulta .= "<font color=gray><b>Generico:</b></font> ".htmlentities($articuloNombreGenerico)." <font color=gray><b>Comercial:</b></font> ".htmlentities($articuloNombreComercial).
				"|".strtoupper($articuloCodigoConsulta).
				"|".htmlentities($articuloNombreGenerico).
				"|".htmlentities($articuloNombreComercial).
				"|".$tipoProtocolo.
				"|".$tipoArticuloMedicamentoLiquido.
				"|".$tipoGenerico.
				"|".$rs['origen'].
				"|".$rs['Artgru'].
				"|".$rs['Artfar'].
				"|".$rs['Artuni'].
				"|".$rs['Artpos'].
				"|".$rs['Deffru'].
				"|".$rs['Deffra'].
				"|".$rs['Defven'].
				"|".$rs['Defdie'].
				"|".$rs['Defdis'].
				"|".$rs['Defdup'].
				"|".$rs['Defdim'].
				"|".$rs['Defdom'].
				"|".$rs['Defvia'].
				"|".$abreVentanaModal.
				"|".@$parametrosFijosArticuloGenerico[0].
				"|".@$parametrosFijosArticuloGenerico[1].
				"|".@$parametrosFijosArticuloGenerico[2].
				"|".@$parametrosFijosArticuloGenerico[3].
				"|".@$parametrosFijosArticuloGenerico[4].
				"|".@$parametrosFijosArticuloGenerico[5].
				"|".@$parametrosFijosArticuloGenerico[6].
				"|".@$parametrosFijosArticuloGenerico[7].
				"|".@$parametrosFijosArticuloGenerico[8].
				"|".@$parametrosFijosArticuloGenerico[9].
				"|".@$componentesTipo.
				"|".@$noEnviar.
				"|".@$observacionesDA.
				"|".@$codigoPrincipioActivo.
				"|".@$principioActivo.
				"\n";
			}
			
			$cont1++;
		}
	} else {
		$consulta = $consulta."No se encontraron coincidencias";
	}

	liberarConexionBD($conex);

	return $consulta;
}


/*
 * AJAX::ConsultarArticulosPorNombre
 */
function prepararDivisor( $numero )
{
	if($numero==0)
		$numero = 1;
	else
		$numero = $numero*1;
	
	return $numero;
}	

/*
 * AJAX::ConsultarArticulosPorNombre
 */
function consultarArticulosFamilia( $wbasedato, $wcenmez, $criterio, $ccoPaciente, $presentacion, $medida, $dosis, $administracion, $eps, $bsq, $his, $ing ){

	global $conex;
	global $wemp_pmla;
	
	$wcliame = consultarAliasPorAplicacion( $conex, $wemp_pmla, "facturacion" );

	$pesMedicamentosBD = consultarAliasPorAplicacion( $conex, $wemp_pmla, "pesMedicamentos" );
	$expPesMedicamentosBD = explode( ";", $pesMedicamentosBD );
	
	$gruposAntibioticos = consultarAliasPorAplicacion( $conex, $wemp_pmla, "gruposMedicamentosAntibioticos" );
	$gruposAntibioticos = explode( ",", $gruposAntibioticos );
			
	$validarTarifa 	= consultarAliasPorAplicacion( $conex, $wemp_pmla, 'validarPrescripcionConTarifa' );
	$validarTarifa 	= $validarTarifa == 'on';
	
	
	$indexArPes = 0;
	foreach( $expPesMedicamentosBD as $keyPesMed => $valuePesMed ){
		
		$expDatos = explode( "-", $valuePesMed );
		
		if( $indexArPes > 0 ){
			$arTiposProtocolos[] = explode( ",", $expDatos[1] );
			$arTiposPertenecientes[] = explode( ",", $expDatos[2] );
			$arPesMedicamentos[] = count($arPesMedicamentos) + 11;
			$arNomPes[] = $expDatos[0];	//Nombre pestaña
		}
		else{
			$arTiposProtocolos[] = Array( 0 => "N" );
			$arTiposPertenecientes[] = explode( ",", $expDatos[2] );
			$arPesMedicamentos[] = 3;
			$arNomPes[] = "Medicamentos";	//Nombre pestaña
		}
		
		$indexArPes++;
	}

	//Variable que se necesitan
	$centroCostos = "1183";
	$criterio = strtoupper($criterio);
	//echo $ccoPaciente;
	$ccoUrgencias = consultarCcoUrgencias();
	$esCcoPacienteUrgencias = $ccoPaciente == $ccoUrgencias;

	$coleccion = array();
	$consulta = "";

	global $centroCostosServicioFarmaceutico;
	global $codigoServicioFarmaceutico;
	global $codigoCentralMezclas;
	global $centroCostosCentralMezclas;
	
	global $protocoloNormal;

	$esSF = $centroCostos == $centroCostosServicioFarmaceutico ? true : false;
	$esCM = $centroCostos == $centroCostosCentralMezclas ? true : false;

	$dosis_exacta = true;
	$articulo_pos = true;
	
	@$codigo = str_replace("-","%",$codigo);

	$tipoArticulo = "";
	$tipoGenerico = "";

	$observacionesDA = "";

	// Variables para guardar el último artículo que mas se acerca a los criterios de búsqueda
	$articulo_encontrado = "";
	$articulo_pos_encontrado = "";
	$unidadesRequeridas_encontrado = -1;
	$dosisCubiertas_encontrado = -1;
	$dosis_exacta_encontrado = false;
	
	//*******************************Grupos que puede ver el centro de costos del usuario
	$tieneGruposIncluidos = false;
	$gruposIncluidos = "(";

	$q6 = "SELECT DISTINCT Ccogka FROM {$wbasedato}_000011 WHERE Ccoest='on' AND Ccogka != '*' AND Ccocod='$centroCostos';";
	$res6 = mysql_query($q6, $conex);

	// Define los grupos de medicamentos que puede ver el centro de costos en el kardex
	while($rs6 = mysql_fetch_array($res6))
	{
		$tieneGruposIncluidos = true;
		if(strpos($rs6['Ccogka'],$gruposIncluidos) === false)
		{
			$gruposIncluidos .= "'".str_replace(",","','",$rs6['Ccogka'])."',";
		}
	}
	$gruposIncluidos .= "'')";
	//********************************

	//Preproceso de los grupos de medicamentos.  De formato X00,Y00,Z00... a 'X00','Y00','Z00'
	$criterioGrupo = "";
	@$vecGruposMedicamentos = explode(",",$gruposMedicamentos);

	$cont2 = 0;
	while($cont2 < count($vecGruposMedicamentos))
	{
		$criterioGrupo .= "'".$vecGruposMedicamentos[$cont2]."',";
		$cont2++;
	}
	$criterioGrupo .= "''";
	
	
	/************************************************************************************************
	 * Consulto el código de la familia
	 ************************************************************************************************/
	$sqlFamCod = "SELECT Famcod 
				  FROM {$wbasedato}_000114
				  WHERE Famnom = '$criterio'";
				  
	$res = mysql_query( $sqlFamCod, $conex ) or die( mysql_errno()." - Error en el query $sqlFamCod - ".mysql_error() );
	$codigoFamiliaMaestro = "";
	if( $rowsFamCod = mysql_fetch_array( $res ) ){
		$codigoFamiliaMaestro = $rowsFamCod[ 'Famcod' ];
	}
	/************************************************************************************************/
	
	/************************************************************************************************************************************************
	 * Si el paciente tiene eps, su buscará los medicamentos POS que cumplan con los criterios de busqueda (familia, presentacion, unidad)
	 * tiene como prioridad los medicamentos POS que en cuyo nombre generico o comercial tengan la busqueda escrita por el usuario
	 *
	 * Nota: No se toma en cuenta los de CM por que no se muestran en la busqueda para el usuario
	 ************************************************************************************************************************************************/
	$whereAdd = '';
	
	if( true || $eps == 'on' ){
	
		$pos = Array();
		$pos[ 'P' ] = Array( 0 => Array(), 1 => Array() );
		$pos[ 'N' ] = Array( 0 => Array(), 1 => Array() );
		$hayDosisExacta = false;
		
		//Si lo que se esta buscando es un articulo en especifico, lo buscara en la tabla movhos_000026 y 
		//utilizara la primera consulta que filtra por artcod(movhos_000026) en relacion con la tabla 114 y 115.		
		$sqlFiltro="  SELECT
							Artcod, Artcom, Artgen, Famnom, Famcod, Artpos, Relcon
						FROM
							{$wbasedato}_000114 a,
							{$wbasedato}_000115 c,
							{$wbasedato}_000026 d,
							{$wbasedato}_000059 e
						WHERE
							Famcod = Relfam
							AND Relest = 'on'
							AND Artcod = '$bsq'
							AND Artcod = Relart
							AND Artest = 'on'
							AND defart = artcod
							AND defest = 'on'
							AND defcco = '".$centroCostosServicioFarmaceutico."'
							AND FIND_IN_SET( '".$administracion."', defvia ) > 0
							";
		$resFiltro = mysql_query( $sqlFiltro, $conex ) or die( mysql_errno()." - Error en el query $sqlFiltro - ".mysql_error() );
		$numFiltro = mysql_num_rows($resFiltro);
		
		if($numFiltro == 0){
		
			$sqlFiltro= " SELECT
								Artcod, Artcom, Artgen, Famnom, Famcod, Artpos, Relcon
							FROM
								{$wbasedato}_000114 a,
								{$wbasedato}_000115 c,
								{$wbasedato}_000026 d,
								{$wbasedato}_000059 e
							WHERE
								Famcod = '$codigoFamiliaMaestro'
								AND Famcod = Relfam
								AND Reluni LIKE '$medida'
								AND Artpco LIKE '$presentacion'
								AND Relest = 'on'
								AND Artcod = Relart
								AND Artcod = Defart
								AND Defest = 'on'					
								AND Artest = 'on'
								AND FIND_IN_SET( '".$administracion."', defvia ) > 0
							ORDER BY Artgen, Artcom, Artpos DESC, Relcon DESC";
			$resFiltro = mysql_query( $sqlFiltro, $conex ) or die( mysql_errno()." - Error en el query $sqlFiltro - ".mysql_error() );
			$numFiltro = mysql_num_rows( $resFiltro );
			
		}
		
		
		if( $numFiltro > 0 ){
		
			//Organizo un Array cómo un árbol, 
			//El primer nivel indica si un articulo es POS (P) o No Pos (N)
			//El segundo nivel indica si tiene dosis exacta (D) o no (N)
			//El tercer nivel indica si el articulo en su nombre generico o comercial contiene el nombre de la palabra en el buscador de medicamentos de ordenes (variabel $bsq)
			for( $i = 0; $rowsFiltro = mysql_fetch_array( $resFiltro ); $i++ ){
				
				$rowsFiltro[ 'Relcon' ] = str_replace( ".000", "", $rowsFiltro[ 'Relcon' ] );
			
				if( $rowsFiltro[ 'Relcon' ] == $dosis || $dosis*1000%($rowsFiltro[ 'Relcon' ]*1000) == 0 ){
					// $dosExacta = 'D';
					$dosExacta = 'F';	//Indica que es una fracción
					if( $rowsFiltro[ 'Relcon' ] == $dosis ){
						$dosExacta = 'D';
					}
					
					$hayDosisExacta = true;
				}
				else{
					$dosExacta = 'N';
				}
				
				if( $rowsFiltro[ 'Artpos' ] == 'N' ||  $eps != 'on' ){
					if( stripos( $rowsFiltro[ 'Artcom' ], $bsq ) !== false || stripos( $rowsFiltro[ 'Artgen' ], $bsq ) !== false ){
						$pos[ 'N' ][ $dosExacta ][ 1 ][] = $rowsFiltro[ 'Artcod' ];
					}
					else{
						$pos[ 'N' ][ $dosExacta ][ 0 ][] = $rowsFiltro[ 'Artcod' ];
					}
				}
				else{
					if( stripos( $rowsFiltro[ 'Artcom' ], $bsq ) !== false || stripos( $rowsFiltro[ 'Artgen' ], $bsq ) !== false ){
						$pos[ 'P' ][ $dosExacta ][ 1 ][] = $rowsFiltro[ 'Artcod' ];
					}
					else{
						$pos[ 'P' ][ $dosExacta ][ 0 ][] = $rowsFiltro[ 'Artcod' ];
					}
				}
			}
			
			//Miro si hay coincidencias con dosis exacta
			if( $hayDosisExacta ){
				// $dosExacta = 'D';
				if( count( $pos[ 'P' ][ 'D' ] ) > 0 ){
					$dosExacta = 'D';
				}
				else if( count( $pos[ 'P' ][ 'F' ] ) > 0 ){
					$dosExacta = 'F';
				}
				else if( count( $pos[ 'P' ][ 'N' ] ) > 0 ){
					$dosExacta = 'N';
				}
				else if( count( $pos[ 'N' ][ 'D' ] ) > 0 ){
					$dosExacta = 'D';
				}
				else if( count( $pos[ 'N' ][ 'F' ] ) > 0 ){
					$dosExacta = 'F';
				}
				else{
					$dosExacta = 'N';
				}
			}
			else{
				$dosExacta = 'N';
			}
			
			//Si un paciente tiene EPS se debe eligir un medicamento POS
			//Por tanto busco en el array de Pos si hay uno
			//y coincida con el nombre generico o comercial
			if( count( $pos[ 'P' ][ $dosExacta ][ 1 ] ) > 0 ){
				$idxPos = 'P';
				$idxNom = 1;
			}
			elseif(count( $pos[ 'P' ][ $dosExacta ][ 0 ] ) > 0){
				$idxPos = 'P';
				$idxNom = 0;
			}
			elseif(count( $pos[ 'N' ][ $dosExacta ][ 1 ] ) > 0){
				$idxPos = 'N';
				$idxNom = 1;
			}
			elseif(count( $pos[ 'N' ][ $dosExacta ][ 0 ] ) > 0){
				$idxPos = 'N';
				$idxNom = 0;
			}
			
			$inAdd = '';
			//Creo el string que corresponde a una sentencia IN en SQL
			foreach( $pos[ $idxPos ][ $dosExacta ][ $idxNom ] as $key => $value ){
				$inAdd .= ",'$value'";
			}
			
			if( !empty($inAdd) ){
				$whereAdd = "AND relart IN( ".substr( $inAdd, 1 )." )";
			}
		}
	}
	/************************************************************************************************************************************************/
		
	
	/*
	----------- DESCRIPCION DE LAS TABLAS PARA LA SIGUIENTE CONSULTA ---------------
	{$wbasedato}_000114 -> Maestro de familias de medicamentos (Fam)
	{$wbasedato}_000027 -> Maestro de unidades (Uni)
	{$wbasedato}_000115 -> Relación familias de medicamentos con unidades (Rel)
	{$wbasedato}_000026 -> Maestro de artículos (Art)
	{$wbasedato}_000059 -> Definición fracciones artículos (Def)
	{$wbasedato}_000046 -> Formas farmacéuticas (Ffa)
	{$wbasedato}_000040 -> Vías de administración (Ffa)
	{$wcenmez}_000002 -> Maestro de artículos de Central de Mezclas (Art)
	---------------------------------------------------------------------------------
	*/
	
		
		
	 // Se consultan los medicamentos que cumplan con los criterios seleccionados
	 //Famnom  LIKE '$criterio'
	$sql = "( SELECT
				Artcod, Artcom, Artgen, Artuni, Unides, '$codigoServicioFarmaceutico' origen, SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru, IFNULL(Artfar,'00') Artfar, Artpos, '' Arttip, Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia, 0 Defmin, 1000000 Defmax, Famctr
			FROM
				{$wbasedato}_000114 a, 
				{$wbasedato}_000027 b,
				{$wbasedato}_000115 c,
				{$wbasedato}_000026 d,
				{$wbasedato}_000059 e,
				{$wbasedato}_000175 f
			WHERE
				Famcod = '$codigoFamiliaMaestro'
				AND Famcod = Relfam
				AND Deffru LIKE '$medida'
				AND Artpco LIKE '$presentacion'
				AND Relcon = '$dosis'
				AND Relpre = Unicod
				AND Relest = 'on'
				AND Artcod = Relart
				AND Artest = 'on'
				AND Artcod = Defart 
				$whereAdd
				AND Defest = 'on' 
				AND Artpco != '' 
				AND Artpco = Pcocod )
			UNION
			( SELECT
				Artcod, Artcom, Artgen, Artuni, Unides, '$codigoCentralMezclas' origen, '' Artgru, '00' Artfar, '' Artpos, Arttip , Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia, 0 Defmin, 1000000 Defmax, Famctr
			FROM
				{$wbasedato}_000114 a, 
				{$wbasedato}_000027 b,
				{$wbasedato}_000115 c,
				{$wcenmez}_000002 d,
				{$wcenmez}_000001 g,
				{$wbasedato}_000059 e
			WHERE
				Famcod = '$codigoFamiliaMaestro'
				AND Famcod = Relfam
				AND Deffru LIKE '$medida'
				AND Relcon = '$dosis'
				AND Relpre = Unicod
				AND Relest = 'on'
				AND Artcod = Relart
				AND Artest = 'on'
				AND Arttip = Tipcod
				AND Tipcdo != 'on'
				AND Artcod = Defart 
				AND EXISTS ( SELECT unicod FROM  {$wbasedato}_000027 f WHERE f.unicod = '$presentacion' AND f.unipda = 'on' )
				AND Defest = 'on' )
			";

	
			
	// Se consultan los medicamentos que cumplan con los criterios seleccionados, excepto la dosis
	$sql2 = "( SELECT
				Artcod, Artcom, Artgen, Artuni, g.Unides, '$codigoServicioFarmaceutico' origen, SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru, IFNULL(Artfar,'00') Artfar, Artpos, '' Arttip, Deffra*1 as Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia, 0 Defmin, 1000000 Defmax, g.Unipda, Famctr
			FROM
				{$wbasedato}_000114 a, 
				{$wbasedato}_000027 b,
				{$wbasedato}_000115 c,
				{$wbasedato}_000026 d,
				{$wbasedato}_000059 e,
				{$wbasedato}_000046 f,
				{$wbasedato}_000027 g
			WHERE
				Famcod = '$codigoFamiliaMaestro'
				AND Famcod = Relfam
				AND Deffru LIKE '$medida'
				AND Artpco LIKE '$presentacion'
				AND Deffru = b.Unicod
				AND Artuni = g.Unicod
				AND Relest = 'on'
				AND Artcod = Relart
				AND Artest = 'on'
				AND Artcod = Defart 
				AND Artpco != '' 
				$whereAdd
				AND Defest = 'on' )
			UNION
			( SELECT
				Artcod, Artcom, Artgen, Artuni, g.Unides, '$codigoCentralMezclas' origen, '' Artgru, '00' Artfar, '' Artpos, Arttip , Deffra*1 as Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia, 0 Defmin, 1000000 Defmax, g.Unipda, Famctr
			FROM
				{$wbasedato}_000114 a, 
				{$wbasedato}_000027 b,
				{$wbasedato}_000115 c,
				{$wcenmez}_000002 d,
				{$wbasedato}_000059 e,
				{$wbasedato}_000046 f,
				{$wbasedato}_000027 g
			WHERE
				Famcod = '$codigoFamiliaMaestro'
				AND Famcod = Relfam
				AND Deffru LIKE '$medida'
				AND trim( Artuni ) LIKE '$presentacion'
				AND Deffru = b.Unicod
				AND Artuni = g.Unicod
				AND Relest = 'on'
				AND Artcod = Relart
				AND Artest = 'on'
				$whereAdd
				AND Artcod NOT IN (SELECT b.artcod FROM {$wbasedato}_000026 b WHERE b.artcod = relart ) 
				AND Artcod = Defart 
				AND Defest = 'on' )
			ORDER BY Deffra
			";	
	
	// 2012-07-09
	// Se agregó ORDER BY Famund DESC para poder ordenar según la unidad destacada para la familia de medicamentos

	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$num = mysql_num_rows( $res );

	// Declaro valor inicial para el código del articulo que se busca
	// Se pone -1 para que no arroje resgistros si no se encuentra en el query final 
	$articulo_encontrado = -1;
	
	// Inicializó el array que va a contener los datos de los artículos candidatos a ser seleccionados
	// $articulosEncontrados = array();
	
	// Declaro valor inicial para las variables que me dirá que artículo se acerca mas a la dosis pedida
	$auxUnidadesRequeridas = -1;
	$auxDosisCubiertas = -1;
	$retornar = "";
	// Si no se encontró articulos con dosis exacta, se pasa a consultar sin dosis ($sql2)
	if($num == 0)
	{
		$res = mysql_query( $sql2, $conex ) or die( mysql_errno()." - Error en el query $sql2 - ".mysql_error() );
		$num = mysql_num_rows( $res );
		// Se desactiva el indicador de dosis exacta
		$dosis_exacta = false;
	}

	// Contador para los ciclos del while
	$cont = 0;
	$esFamiliaControl = false;

	// Si hay un articulo o más
	if($num > 0)
	{
		// while($rs = mysql_fetch_array($res))
		for( $i = 0; $rs = mysql_fetch_array($res); $i++ )
		{
			//Si la familia es de control y el articulo es genérico, se asume que el artículo es de control
			if( $i == 0 && $rs['Famctr'] == 'on' ){
				$esFamiliaControl = true;
			}
		
			// Se asigna la cantidad de fracciones del artículo
			$fraccionArticulo = $rs['Deffra'];
			
			// Si la dosis no es exacta se definen variables para uso en la definición
			// del artíclo con la dosis mas adecuada
			if(!$dosis_exacta)
			{
				// Se define si las fracciones son múltiplo de la dosis
				// $multiploDosis = ($dosis*1)%prepararDivisor($fraccionArticulo);
				// Es una división modular, se hace de está forma por que el operador % no funciona bien cuando se trabaja con fracciones
				// El operador % es un operador binario y por tanto solo funciona bien con números enteros
				$multiploDosis = ($dosis*1)-floor(($dosis*1)/prepararDivisor($fraccionArticulo));
				
				//Se saca fracción
				//$multiploFraccion = ($fraccionArticulo*1)%prepararDivisor($dosis);
				// Es una división modular, se hace de está forma por que el operador % no funciona bien cuando se trabaja con fracciones
				// El operador % es un operador binario y por tanto solo funciona bien con números enteros
				$multiploFraccion = ($fraccionArticulo*1)-floor(($fraccionArticulo*1)/prepararDivisor($dosis));
				
				// Se define las unidades requerida para cubir la dosis y
				// las dosis cubiertas por la fracción del artículo
				$unidadesRequeridas = ($dosis*1)/prepararDivisor($fraccionArticulo);
				$dosisCubiertas = ($fraccionArticulo*1)/prepararDivisor($dosis);
				
				//Junio 8 de 2014
				//Se deja estos valores con saldo para que nunca busque articulos multiplos o divisires de una dosis
				// Se define si las fracciones son múltiplo de la dosis
				if( $multiploFraccion == 0 ){
					if( $rs['Unipda'] == 'on' ){
						$multiploDosis = 1;
						$multiploFraccion = 1;
					}
				}
			}
		
			// Si encontro una sola conincidencia
			if($num == 1)
			{
				// Si se encuentra un solo registro y es dosis exacta no es necesario hacer evaluación de fracciones 
				// y este se lleva como resultado de la búsqueda
				if($dosis_exacta || $rs['Unipda'] != 'on')
				{
					$articulo_encontrado = $rs['Artcod'];
					break;
				}
				else
				{
					$prefijoArticulo = substr($rs['Artcod'], 0, 2);
					if($prefijoArticulo=="DA" || $prefijoArticulo=="LQ")
					{
						$articulo_encontrado = $prefijoArticulo."0000";
						break;
					}
					
					// Si la dosis es múltiplo de las fracciones o viceversa
					if($multiploDosis==0 || $multiploFraccion==0)
					{
						// Si las unidades a pedir estan en el rango de máximo y mínimo
						if(($dosis*1)>=($rs['Defmin']*1) && ($dosis)*1<=($rs['Defmax']*1))
						{
							// Si es primera vez que pasa o las unidades requeridas son menores a las anteriormente guardadas
							if($auxUnidadesRequeridas == -1 || $unidadesRequeridas < $auxUnidadesRequeridas)
							{
								$auxUnidadesRequeridas = $unidadesRequeridas;
								$articulo_encontrado = $rs['Artcod'];
							}
						} 
						// Si la fracción del artículo es superior a la dosis
						else if($dosisCubiertas>1)
						{
							// Si es primera vez que pasa o las unidades requeridas son menores a las anteriormente guardadas
							if($auxDosisCubiertas == -1 || $dosisCubiertas < $auxDosisCubiertas)
							{
								$auxDosisCubiertas = $dosisCubiertas;
								$articulo_encontrado = $rs['Artcod'];
							}
						}
					}
				}	
			}
			// Si se encontraron varias conincidencias
			elseif($num > 1)
			{
				// comienza la evaluación de selección cuando son varios artículos los que coinciden

				if($rs['Artpos']!='P')
					$articulo_pos = false;
					
				// Si es dosis exacta y es POS no es necesario hacer evaluación de fracciones 
				// y este se lleva como resultado de la búsqueda, se finaliza el ciclo
				if($dosis_exacta && $articulo_pos)
				{
					$articulo_encontrado = $rs['Artcod'];
					// return $articulo_encontrado;
					break;
				}
				// Si es dosis exacta y es articulo NO POS
				// Se toma como articulo encontrado pero se sigue buscando si hay uno POS
				elseif($dosis_exacta && !$articulo_pos)
				{
					$articulo_encontrado = $rs['Artcod'];
					$articulo_pos_encontrado = $rs['Artpos'];
					$unidadesRequeridas_encontrado = -1;
					$dosisCubiertas_encontrado = -1;
					$dosis_exacta_encontrado = true;
				}
				// Si no es dosis exacta asi sea POS o NO POS
				else
				{
					// Si hasta ahora no se ha encontrado dosis exacta
					if(!$dosis_exacta_encontrado)
					{
						if(true ||$articulo_pos_encontrado!='P')
						{
							// Si la dosis es múltiplo de las fracciones o viceversa
							// if($multiploDosis==0 || $multiploFraccion==0)
							if($multiploDosis==0)
							{
								// Si las unidades a pedir estan en el rango de máximo y mínimo
								if( ($dosis*1)>=($rs['Defmin']*1) && ($dosis)*1<=($rs['Defmax']*1))
								{
									// Si es primera vez que pasa o las unidades requeridas son menores a las anteriormente guardadas
									// if($auxUnidadesRequeridas == -1 || $unidadesRequeridas < $auxUnidadesRequeridas)
									if($auxUnidadesRequeridas == -1 || $unidadesRequeridas < $auxUnidadesRequeridas)
									{
										$auxUnidadesRequeridas = $unidadesRequeridas;
										$articulo_encontrado = $rs['Artcod'];
										$articulo_pos_encontrado = $rs['Artpos'];
										$unidadesRequeridas_encontrado = $unidadesRequeridas;
										$dosisCubiertas_encontrado = $dosisCubiertas;
										$dosis_exacta_encontrado = false;
									}
								} 
								// Si la fracción del artículo es superior a la dosis
								else if($dosisCubiertas>1)
								{
									// Si es primera vez que pasa o las unidades requeridas son menores a las anteriormente guardadas
									if($auxDosisCubiertas == -1 || $dosisCubiertas < $auxDosisCubiertas)
									{
										$auxDosisCubiertas = $dosisCubiertas;
										$articulo_encontrado = $rs['Artcod'];
										$articulo_pos_encontrado = $rs['Artpos'];
										$unidadesRequeridas_encontrado = $unidadesRequeridas;
										$dosisCubiertas_encontrado = $dosisCubiertas;
										$dosis_exacta_encontrado = false;
									}
								}
							}
							elseif( $rs['Unipda'] != 'on' ){
								if( $i == 0 ){
									$articulo_encontrado = $rs['Artcod'];
									$fracionAnterior = $rs['Deffra']*1;
								}
								else{
									if( $rs['Deffra']*1 > $dosis*1 && $fracionAnterior < $dosis ){
										$articulo_encontrado = $rs['Artcod'];
										$fracionAnterior = $rs['Deffra']*1;
									}
									elseif( $rs['Deffra']*1 < $dosis*1 ){
										$articulo_encontrado = $rs['Artcod'];
										$fracionAnterior = $rs['Deffra']*1;
									}
								}
							}
						}
					}
				}	
			}
		}
		
		if($articulo_encontrado==-1)
		{
			// Si no se encontro artículo que cumpla con la dosis
			// Se crea una dosis Adaptada
			$articulo_encontrado = "DA0000";
			$observacionesDA = $criterio." ".$dosis." ".$medida;
		}
						
		//Con el fin de obtener los genericos se tendra en cuenta unicamente la primera palabra de la consulta antes del espacio
		//$vecCriterio = explode("%",$articulo_encontrado);
		//$articulo_encontradoCM = $vecCriterio[0];
		
		// Se obtienen los datos del articulo encontrado
		$qCod = " ( SELECT "
		." 		Artcod, Artcom, Artgen, Artuni, Unides, '$codigoServicioFarmaceutico' origen, SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru, IFNULL(Artfar,'00') Artfar, Artpos, '' Arttip , Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia, '' Tiptpr, Defcmp, Defcpa, Defcsa, Artfat "
		." FROM "
		." 		{$wbasedato}_000027, {$wbasedato}_000026, {$wbasedato}_000059, {$wbasedato}_000114, {$wbasedato}_000115 "
		." WHERE "
		."			Artcod = '".$articulo_encontrado."' "
		."		AND Artest = 'on' "
		."		AND Artuni = Unicod "
		."		AND Artcod = Defart "
		."		AND Defest = 'on' "
		."		AND Relart = Artcod "
		."		AND Relfam = Famcod "
		.") ";

		$qCod .= " UNION ";
		
		$qCod .= " ( SELECT "
		."	Artcod, Artcom, Artgen, Artuni, Unides, '$codigoCentralMezclas' origen, '' Artgru, '00' Artfar, '' Artpos, Arttip , Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia, Tiptpr, Defcmp, Defcpa, Defcsa, '' as Artfat "
		." FROM "
		." {$wbasedato}_000027, {$wcenmez}_000002, {$wbasedato}_000059, {$wbasedato}_000114, {$wbasedato}_000176, {$wbasedato}_000115, {$wcenmez}_000001 "
		." WHERE "
		."		Artcod = '".$articulo_encontrado."' "
		."	AND Artest = 'on' "
		."  AND Artuni = Unicod "
		."	AND Artcod = Defart "
		."	AND Arttip = tipcod "
		."	AND tipcdo != 'on' "
		."	AND Defest = 'on' "
		."	AND Relart = Artcod "
		."	AND Relfam = Famcod "
		.") ";

		$resart = mysql_query( $qCod, $conex ) or die( mysql_errno()." - Error en el query $qCod - ".mysql_error() );
		$numart = mysql_num_rows( $resart );
		
	}
	else
	{
		$numart = 0;
	}

	
	$cont1 = 0;
	$agrupoGenericos = false;
	$abreVentanaModal = "";
	
	if($numart > 0)
	{

			$codigoGenericoArticulo = "";


			
			$tieneParametrosFijos = "N";
			$nombreArticuloGenerico = "";
			$puedeAgregar = true;
			
			$rs = mysql_fetch_array($resart);
			
			$tipoProtocolo = $protocoloNormal;
			$tipoArticuloMedicamentoLiquido = "M";
			$tipoGenerico = "";
			$tipoArticulo = "1";
			$borrar = "";
			
			// Junio 02 de 2016. Se comenta para que no tenga en cuenta la configuracion de articulos tipo liquido
			// //Consulta del tipo al que pertenece
			// $qTipLM = "SELECT Meltip FROM {$wbasedato}_000066 WHERE Melgru = '{$rs['Artgru']}' AND Melest='on' ";
			// $resTipLM = mysql_query($qTipLM, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qTipLM . " - " . mysql_error());
			// if($infoTipLM = mysql_fetch_array($resTipLM))
			// {
				// $tipoArticuloMedicamentoLiquido = $infoTipLM['Meltip'];
			// }
			
			//Consulta del protocolo al que pertenece el articulo
			$qProt = "SELECT Arkcod,Arkest,Arkcco,Arktip FROM {$wbasedato}_000068 WHERE Arkcod = '{$rs['Artcod']}'";
			$resProt = mysql_query($qProt, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qProt . " - " . mysql_error());
			if($infoProt = mysql_fetch_array($resProt))
			{
				$tipoProtocolo = $infoProt['Arktip'];
			}
			
			$color = "red";
			$fftica = $rs['Artfar'];

			//CLASIFICACION DE LOS ARTICULOS
			
			/*TIPOS DE ARTICULOS
			 * 1.  Articulos del maestro de SF
			 * 2.  Articulos del maestro de CM
			 * 3.  Articulos genericos NU,QT,DA dependiendo del tipo en la tabla 68 y la 2
			 * 4.  
			 */
			if($rs['origen'] == $codigoServicioFarmaceutico){ 		//No tiene genéricos
				$tipoGenerico = "";
			}
			
			//On
			/*
			echo "Tipo gen: ".$qTipGen."<br>";
			echo "rs: ".$rs['origen']."<br>";
			echo "central M : ".$codigoCentralMezclas."<br>";
			echo "tipo: ".$rs['Arttip']."<br>";
			*/
	
			$esNutricion = false;
	
			if($rs['origen'] == $codigoCentralMezclas)
			{  			//Puede tener genéricos
				//Consulta del tipo al que pertenece
				$tipoCentralMezclas = $rs['Arttip'];
				
				if(!empty($tipoCentralMezclas))
				{
					//Agosto 5 de 2014
					$tipoProtocolo = $rs['Tiptpr'];
				
					$qTipGen = "SELECT Arkcod, Tiptpr, Tipdes FROM {$wcenmez}_000001, {$wbasedato}_000068 WHERE Tipcod = '{$tipoCentralMezclas}' AND Arktip = Tiptpr AND Arkcod = '{$rs[ 'Artcod' ]}'";
					$resTipGen = mysql_query($qTipGen, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qTipGen . " - " . mysql_error());
					if($infoTipGen = mysql_fetch_array($resTipGen)){
						$tipoGenerico = $infoTipGen['Tiptpr'];
						$codigoGenericoArticulo = $infoTipGen['Arkcod'];
						$articuloGenerico = true;
						
						if($infoTipGen['Tiptpr'] == "NU")
						{
							$esNutricion = true;
						}
					} else {
						$articuloGenerico = false;
					}
					
					// if( esProductoControl( $conex, $wbasedato, $wcenmez, $rs[ 'Artcod' ] ) ){
						// $rs[ 'Artgru' ] = 'CTR';
					// }
					
				} else {
					$qTipGen = "SELECT Arkcod, Arktip FROM {$wbasedato}_000068, {$wbasedato}_000098 WHERE Arkcod = '{$rs['Artcod']}' AND Cartip = Arktip AND Carest = 'on'";
					$resTipGen = mysql_query($qTipGen, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qTipGen . " - " . mysql_error());
					if($infoTipGen = mysql_fetch_array($resTipGen)){
						$tipoGenerico = $infoTipGen['Arktip'];
						$codigoGenericoArticulo = $infoTipGen['Arkcod'];
						$articuloGenerico = true;
					} else {
						$articuloGenerico = false;
					}
				}
				
				if($articuloGenerico)
				{
					//Partip  Parcdo  Parudo  Parnen  Parfre  Parvia  Parcon  Parcnf  Pardim  Pardom  Parobs
					$qParametros = "SELECT Parcdo,Parudo,Parnen,Parfre,Parvia,Parcon,Parcnf,Pardim,Pardom,Parobs FROM {$wbasedato}_000097 WHERE Partip = '{$tipoGenerico}';";
					$resParametros = mysql_query($qParametros, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qParametros . " - " . mysql_error());
					if($infoParametros = mysql_fetch_array($resParametros))
					{
						$tieneParametrosFijos = "S";

						$parametrosFijosArticuloGenerico[0] = $infoParametros['Parcdo'];		//Cantidad de dosis
						$parametrosFijosArticuloGenerico[1] = $infoParametros['Parudo'];		//Unidad de dosis
						$parametrosFijosArticuloGenerico[2] = $infoParametros['Parnen'];		//No enviar
						$parametrosFijosArticuloGenerico[3] = $infoParametros['Parfre'];		//Frecuencia
						$parametrosFijosArticuloGenerico[4] = $infoParametros['Parvia'];		//Vias de administracion
						$parametrosFijosArticuloGenerico[5] = $infoParametros['Parcon'];		//Condicion de suministro
						$parametrosFijosArticuloGenerico[6] = $infoParametros['Parcnf'];		//Confirmada preparacion
						$parametrosFijosArticuloGenerico[7] = $infoParametros['Pardim'];		//Dias maximos tratamiento
						$parametrosFijosArticuloGenerico[8] = $infoParametros['Pardom'];		//Dosis maximas tratamiento
						$parametrosFijosArticuloGenerico[9] = $infoParametros['Parobs'];		//Observaciones
					}
				}
			}
			
			// //Si tiene componentes asociados en la tabla de componentes por tipo, mostrará los tipos
			// $qComp = "SELECT Cartip,Carcod,Carcco,Cardis, Artgen, Carnal, Carpna
						// FROM {$wbasedato}_000098, {$wbasedato}_000026
					   // WHERE Cartip = '{$tipoGenerico}' 
						 // AND Carcod = artcod
						 // AND Artest = 'on'
						 // AND Carest = 'on'
					   // UNION
					  // SELECT Cartip,Carcod,Carcco,Cardis, Artgen, Carnal, Carpna
						// FROM {$wbasedato}_000098, {$wcenmez}_000002, {$wcenmez}_000001
					   // WHERE Cartip = '{$tipoGenerico}' 
						 // AND Carcod = artcod
						 // AND Artest = 'on'
						 // AND Carest = 'on'
						 // AND arttip = tipcod
						 // AND tipcod != 'on'
					// ORDER BY artgen
						 // ";
						 
			// $resComp = mysql_query($qComp, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qComp . " - " . mysql_error());
			// $componentesTipo = "";
			// $tieneComponentes = false;
			// while($infoComp = mysql_fetch_array($resComp))
			// {	
				// $infoComp['Carnal'] = trim( $infoComp['Carnal'] );
		
				// $qArt = " SELECT Artcom, Artgen, Deffra, Deffru, Defcco 
							// FROM {$wbasedato}_000026, {$wbasedato}_000059, {$wbasedato}_000011 
						   // WHERE Artcod = '".$infoComp['Carcod']."'
							 // AND Artest = 'on'
							 // AND Artcod = Defart
							 // AND Defest = 'on'
							 // AND Ccocod = Defcco
							 // AND Ccofac = 'on'
							 // AND Ccotra = 'on'
						// ORDER BY Defcco;";
				
				// $resArt = mysql_query($qArt, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qArt . " - " . mysql_error());
				// $numArt = mysql_num_rows( $resArt );
				
				// /*******************************************************************************************************************
				 // * Se hace lo siguiente:
				 // * Un articulo puede estar configurado para uno o dos cco en particular
				 // * La prioridad la toma según el cco de la consulta inmeditamente anterior.
				 // * Si solo se encuentra un registro se toma este por defecto, esto se puede hacer por ser
				 // * el mismo articulo sin importar el cco  al que pertenezca. Los que cumplen que el articulo
				 // * se encuentre en ambas tablas de maestro de articulos(movhos_000026, cenpro_000002), se llaman codificados.
				 // ******************************************************************************************************************/
				// $infoArt = false;
				// if( $numArt > 0 ){
					// //Si es el único registro se toma ese
					// if( $numArt == 1 ){
						// $infoArt = mysql_fetch_array($resArt);
					// }
					// else{
						// while($infoArt2 = mysql_fetch_array($resArt)){
							// if( $infoArt2[ 'Defcco' ] == $infoComp[ 'Carcco' ] ){
								// $infoArt = $infoArt2;
							// }
						// }
					// }
				// }
				
				// if( $infoArt )
				// {
					// //Si tiene nombre alterno y el articulo permite nombre alterno, dejo el nombre alterno
					// $infoArt['Artgen'] = !empty($infoComp['Carnal']) && $infoComp['Carpna'] == 'on' ? $infoComp['Carnal'] : $infoComp['Artgen'];
					
					// $componentesTipo .= $infoComp['Carcod']."**";
					// $componentesTipo .= $infoComp['Cardis']."**";
					// $componentesTipo .= utf8_decode($infoArt['Artcom'])."**";
					// $componentesTipo .= utf8_decode($infoArt['Artgen'])."**";
					// $componentesTipo .= utf8_decode($infoArt['Deffra'])."**";
					// $componentesTipo .= utf8_decode($infoArt['Deffru'])."**;";
				// }
				// else{
					
					// //Si tiene nombre alterno y el articulo permite nombre alterno, dejo el nombre alterno
					// $infoArt['Artgen'] = !empty($infoComp['Carnal']) && $infoComp['Carpna'] == 'on' ? $infoComp['Carnal'] : $infoComp['Artgen'];
					
					// $msg = "El articulo <b>".strtoupper( $infoComp['Carcod']."-".$infoComp['Artgen'] )."</b> no se encuentra configurado en la tabla de <b>DEFINICION DE ARTICULOS</b>";
					
					// $componentesTipo .= $infoComp['Carcod']."**";
					// $componentesTipo .= $infoComp['Cardis']."**";
					// $componentesTipo .= "**";
					// $componentesTipo .= "**";
					// $componentesTipo .= "**";
					// $componentesTipo .= "**";
					// $componentesTipo .= utf8_decode($msg).";";
				// }
				
				// $tieneComponentes = true;
			// }
			
			// //return $componentesTipo;
			
			$infoNutriciones="";
			$tieneNutriciones = false;
			
			// var_dump($esNutricion);
			if(!$esNutricion)
			{
				//Si tiene componentes asociados en la tabla de componentes por tipo, mostrará los tipos
				$qComp = "SELECT Cartip,Carcod,Carcco,Cardis, Artgen, Carnal, Carpna
							FROM {$wbasedato}_000098, {$wbasedato}_000026
						   WHERE Cartip = '{$tipoGenerico}' 
							 AND Carcod = artcod
							 AND Artest = 'on'
							 AND Carest = 'on'
						   UNION
						  SELECT Cartip,Carcod,Carcco,Cardis, Artgen, Carnal, Carpna
							FROM {$wbasedato}_000098, {$wcenmez}_000002, {$wcenmez}_000001
						   WHERE Cartip = '{$tipoGenerico}' 
							 AND Carcod = artcod
							 AND Artest = 'on'
							 AND Carest = 'on'
							 AND arttip = tipcod
							 AND tipcod != 'on'
						ORDER BY artgen
							 ";
				// var_dump($qComp);
				$resComp = mysql_query($qComp, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qComp . " - " . mysql_error());
				
				while($infoComp = mysql_fetch_array($resComp))
				{	
					$infoComp['Carnal'] = trim( $infoComp['Carnal'] );
			
					$qArt = " SELECT Artcom, Artgen, Deffra, Deffru, Defcco 
								FROM {$wbasedato}_000026, {$wbasedato}_000059, {$wbasedato}_000011 
							   WHERE Artcod = '".$infoComp['Carcod']."'
								 AND Artest = 'on'
								 AND Artcod = Defart
								 AND Defest = 'on'
								 AND Ccocod = Defcco
								 AND Ccofac = 'on'
								 AND Ccotra = 'on'
							ORDER BY Defcco;";
					// var_dump($qArt);
					$resArt = mysql_query($qArt, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qArt . " - " . mysql_error());
					$numArt = mysql_num_rows( $resArt );
					
					/*******************************************************************************************************************
					 * Se hace lo siguiente:
					 * Un articulo puede estar configurado para uno o dos cco en particular
					 * La prioridad la toma según el cco de la consulta inmeditamente anterior.
					 * Si solo se encuentra un registro se toma este por defecto, esto se puede hacer por ser
					 * el mismo articulo sin importar el cco  al que pertenezca. Los que cumplen que el articulo
					 * se encuentre en ambas tablas de maestro de articulos(movhos_000026, cenpro_000002), se llaman codificados.
					 ******************************************************************************************************************/
					$infoArt = false;
					if( $numArt > 0 ){
						//Si es el único registro se toma ese
						if( $numArt == 1 ){
							$infoArt = mysql_fetch_array($resArt);
						}
						else{
							while($infoArt2 = mysql_fetch_array($resArt)){
								if( $infoArt2[ 'Defcco' ] == $infoComp[ 'Carcco' ] ){
									$infoArt = $infoArt2;
								}
							}
						}
					}
					
					if( $infoArt )
					{
						//Si tiene nombre alterno y el articulo permite nombre alterno, dejo el nombre alterno
						$infoArt['Artgen'] = !empty($infoComp['Carnal']) && $infoComp['Carpna'] == 'on' ? $infoComp['Carnal'] : $infoComp['Artgen'];
						
						$componentesTipo .= $infoComp['Carcod']."**";
						$componentesTipo .= $infoComp['Cardis']."**";
						$componentesTipo .= utf8_decode($infoArt['Artcom'])."**";
						$componentesTipo .= utf8_decode($infoArt['Artgen'])."**";
						$componentesTipo .= utf8_decode($infoArt['Deffra'])."**";
						$componentesTipo .= utf8_decode($infoArt['Deffru'])."**;";
					}
					else{
						
						//Si tiene nombre alterno y el articulo permite nombre alterno, dejo el nombre alterno
						$infoArt['Artgen'] = !empty($infoComp['Carnal']) && $infoComp['Carpna'] == 'on' ? $infoComp['Carnal'] : $infoComp['Artgen'];
						
						$msg = "El articulo <b>".strtoupper( $infoComp['Carcod']."-".$infoComp['Artgen'] )."</b> no se encuentra configurado en la tabla de <b>DEFINICION DE ARTICULOS</b>";
						
						$componentesTipo .= $infoComp['Carcod']."**";
						$componentesTipo .= $infoComp['Cardis']."**";
						$componentesTipo .= "**";
						$componentesTipo .= "**";
						$componentesTipo .= "**";
						$componentesTipo .= "**";
						$componentesTipo .= utf8_decode($msg).";";
					}
					
					$tieneComponentes = true;
					// var_dump($tieneComponentes);
				}
			}
			else
			{
				$qNutriciones  = " SELECT Inscod,Insdes,Inscon,Insreq,Insfop,Insord,Condes,Requni
									 FROM ".$wbasedato."_000210,".$wcenmez."_000002,".$wbasedato."_000211,".$wbasedato."_000212
									WHERE Inscod=Artcod
									  AND Insest='on'
									  AND Artest='on'
									  AND Insreq=Reqcod
									  AND Inscon=Concod
								 ORDER BY Insord;";
				
				$resNutriciones = mysql_query($qNutriciones, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qNutriciones . " - " . mysql_error());
				
				$infoNutriciones="";
				while($rowsNutriciones = mysql_fetch_array($resNutriciones))
				{	
					$infoNutriciones .= $rowsNutriciones['Inscod']."**";
					$infoNutriciones .= utf8_decode($rowsNutriciones['Insdes'])."**";
					$infoNutriciones .= utf8_decode($rowsNutriciones['Inscon'])."**";
					$infoNutriciones .= utf8_decode($rowsNutriciones['Insreq'])."**";
					// $infoNutriciones .= utf8_decode($rowsNutriciones['Insvfv'])."**";
					$infoNutriciones .= utf8_decode($rowsNutriciones['Insfop'])."**";
					$infoNutriciones .= utf8_decode($rowsNutriciones['Insord'])."**";
					$infoNutriciones .= utf8_decode($rowsNutriciones['Condes'])."**";
					$infoNutriciones .= utf8_decode($rowsNutriciones['Requni'])."**;";
					
					$tieneNutriciones = true;
				}
			}
			
			//return $componentesTipo;


			if(str_replace("%"," ",$codigo)){
				$nombreArticuloPersonalizado = "S";
			}
			
			//Clasificacion por tipo
			if($tipoArticuloMedicamentoLiquido == "L"){
				$tipoArticulo = "2";
			}
			
			//Casos posibles de tipo de articulo
			switch($tipoArticulo){
				case '1':	//Articulo generico
					$borrar .= " generico";
 					break;
				case '2':	//Articulo liquido
					$borrar .= " liquido";
					break;
				default:	//Articulo normal
					$borrar .= " normal";
					break;
			}

			if(@$articuloGenerico)
			{	
				// //Si es familia de control y es generico se considera articulo de control
				// if( $esFamiliaControl ){
					// $rs['Artgru'] = "CTR";
				// }
			
				// 2012-07-25
				// Se modificaron las asignaciones a las variables para que tomen el nombre del articulo y no el criterio de busqueda
				// ya que el criterio en la nueva busqueda por familia siempre va a ser un codigo, no un nombre
				@$articuloCodigoConsulta = $rs['Artcod'];  // $codigoGenericoArticulo;
				@$articuloNombreGenerico = "*".$rs['Artgen'];  // "*".str_replace("%"," ",$rs['Artgen']);
				@$articuloNombreComercial = $rs['Artcom'];  // $criterioCM
				
				$nombreArticuloGenerico = $articuloNombreGenerico;
				
				if(!$agrupoGenericos)
				{
					$agrupoGenericos = true;
					$puedeAgregar = true;
				} 
				else 
				{
					$puedeAgregar = false;
				}
			} 
			else 
			{
				$articuloCodigoConsulta = $rs['Artcod'];
				$articuloNombreGenerico = $rs['Artgen'];
				$articuloNombreComercial = $rs['Artcom'];
			}
			
			//Consulto los principios activos pertenecientes a la familia
			$qPac = "SELECT Paccod, Pacdes, Pacest 
						FROM {$wbasedato}_000181 a,{$wbasedato}_000176 b
					   WHERE Parfam = '".$codigoFamiliaMaestro."'
						 AND Parpac = Paccod
					     AND Parest = 'on'
					";
			
			$desPrincipioActivo = '';
			$codPrincipioActivo = '';
			$resPac = mysql_query($qPac, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qPac . " - " . mysql_error());
			while($infoPact = mysql_fetch_array($resPac))
			{
				$desPrincipioActivo .= ",".$infoPact['Pacdes'];
				$codPrincipioActivo .= ",".$infoPact['Paccod'];
			}
			$desPrincipioActivo = substr( $desPrincipioActivo, 1 );
			$codPrincipioActivo = substr( $codPrincipioActivo, 1 );
			
				
			/*FORMATO DE LA RESPUESTA PARA EL AUTOCOMPLETE:
			 * Argumentos:
			 * 
			 * 0: Como se muestra en el autocomplete
			 * 1: Codigo del articulo
			 * 2: Nombre comercial del articulo
			 * 3: Nombre genérico del articulo
			 * 4: Tipo protocolo
			 * 5: (M)edicamento o (L)iquido
			 * 6: Es generico
			 * 7: Origen
			 * 8: Grupo de medicamento
			 * 9: Forma farmaceutica
			 * 10:Unidad
			 * 11:POS
			 * 12:Unidad de fraccion
			 * 13:Cantidad de fracciones
			 * 14:Vencimiento
			 * 15:Dias de estabilidad
			 * 16:Es dispensable
			 * 17:Es duplicable
			 * 18:Dias maximos sugeridos
			 * 19:Dosis maximas sugeridas
			 * 20:Via
			 * 21:Abre ventana parametrizada ----
			 * 22:Cantidad de dosis
			 * 23:Unidad de dosis
			 * 24:No enviar
			 * 25:Frecuencia
			 * 26:Vias de administracion
			 * 27:Condicion de suministro
			 * 28:Confirmada preparacion
			 * 29:Dias maximos tratamiento
			 * 30:Dosis maximas tratamiento
			 * 31:Observaciones adicionales
			 * 32:Componentes asociados al tipo
			 * 33:Observaciones si es Dosis Adaptada
			 * 35:Codigo principio activo
			 * 36:Descricion principio activo
			 * 37:Es Antibiotico
			 * 38:
			 * 39:Es Antibiotico
			 * 40:Es Antibiotico
			 * 41:Es Antibiotico
			 */
			
			if($puedeAgregar)
			{
				if($tieneComponentes || $tieneNutriciones)
				{
					$abreVentanaModal = "S";
				} 
				else 
				{
					$abreVentanaModal = "N";
				}
				
				$esAntibiotico = in_array( $rs['Artgru'], $gruposAntibioticos ) ? 'on':'off';
				
				//Si es familia de control y es generico se considera articulo de control
				if( $esFamiliaControl ){
					$rs['Artgru'] = "CTR";
				}
				
				/***************************************************************************************************
				 * Cambios de tipo de protocolo
				 * De acuerdo al tipo de protocolo se cambia para que aparezca en una pestaña
				 ***************************************************************************************************/
				// if( $rs['origen'] == "CM" ){
					// $tipoProtocolo = "U";
				// }
				// else{
					// $tipoProtocolo = "N";
				// }
				foreach( $arTiposPertenecientes as $keyTipos => $valueTipos ){
					$keyTipo = array_search( $tipoProtocolo, $valueTipos ) ;
					
					if( $keyTipo !== false ){
						$tipoProtocolo = $arTiposProtocolos[ $keyTipos ][0];	//Siempre es la posición 0
						break;
					}
				}
				// $arTiposPertenecientes[] = explode( ",", $expDatos[2] );
				// echo "asdfasfasfasf......".$tipoProtocolo;
				/***************************************************************************************************/
				
				$noEnviar = ( esStock( $conex, $wbasedato, $rs['Artcod'], $ccoPaciente ) == true )? 'on' : 'off';
				
				$famAtc = '';
				//Consulto los principios activos pertenecientes a la familia
				$sql = "SELECT Atccod, Atcdes
							FROM {$wbasedato}_000280 
						   WHERE Atccod IN ( '".implode( "','", explode( ",", $rs['Artfat'] ) )."' )
							 AND Atcest = 'on'
						";
				
				$boolAtc = false;
				$resAtc = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
				while($rowsAtc = mysql_fetch_array($resAtc))
				{
					if( $boolAtc ) 
						$famAtc .= "@@";
					
					$famAtc .= $rowsAtc['Atccod']."-".utf8_encode( htmlentities($rowsAtc['Atcdes']) );
					
					$boolAtc = true;
				}
				
				//Por defecto tiene tarifa
				$con_tarifa = 'on';
				if( !$articuloGenerico ){
					if( $validarTarifa ){
						
						$infopac 	 = informacionPaciente( $conex, $wemp_pmla, $his, $ing );
						$tieneTarifa = articuloTieneTarifa( $conex, $wcliame, $wbasedato, $articuloCodigoConsulta, $infopac['tarifa'] );
						
						if( !$tieneTarifa ){
							$con_tarifa = 'off';
						}
					}
				}
				
				$consulta .= "<font color=gray><b>Generico:</b></font> ".htmlentities($articuloNombreGenerico)." <font color=gray><b>Comercial:</b></font> ".htmlentities($articuloNombreComercial).
				"|".strtoupper($articuloCodigoConsulta).
				"|".htmlentities($articuloNombreGenerico).
				"|".htmlentities($articuloNombreComercial).
				"|".$tipoProtocolo.
				"|".$tipoArticuloMedicamentoLiquido.
				"|".$tipoGenerico.
				"|".$rs['origen'].
				"|".$rs['Artgru'].
				"|".$rs['Artfar'].
				"|".$rs['Artuni'].
				"|".$rs['Artpos'].
				"|".$rs['Deffru'].
				"|".$rs['Deffra'].
				"|".$rs['Defven'].
				"|".$rs['Defdie'].
				"|".$rs['Defdis'].
				"|".$rs['Defdup'].
				"|".$rs['Defdim'].
				"|".$rs['Defdom'].
				"|".$rs['Defvia'].
				"|".$abreVentanaModal.
				"|".@$parametrosFijosArticuloGenerico[0].
				"|".@$parametrosFijosArticuloGenerico[1].
				"|".@$parametrosFijosArticuloGenerico[2].
				"|".@$parametrosFijosArticuloGenerico[3].
				"|".@$parametrosFijosArticuloGenerico[4].
				"|".@$parametrosFijosArticuloGenerico[5].
				"|".@$parametrosFijosArticuloGenerico[6].
				"|".@$parametrosFijosArticuloGenerico[7].
				"|".@$parametrosFijosArticuloGenerico[8].
				"|".@$parametrosFijosArticuloGenerico[9].
				"|".@$componentesTipo.
				"|".@$noEnviar.
				"|".@$observacionesDA.
				"|".@$codPrincipioActivo.
				"|".@$desPrincipioActivo.
				"|".@$esAntibiotico.
				"|".@$infoNutriciones.
				"|".$rs['Defcmp'].
				"|".$rs['Defcpa'].
				"|".$rs['Defcsa'].
				"|".$famAtc.
				"|".$con_tarifa.
				"\n";
			}
			
			$cont1++;
	} 
	else 
	{
		$consulta = $consulta."No se encontraron coincidencias";
	}

	liberarConexionBD($conex);

	return $consulta;
}


/*
 * AJAX::ConsultarArticulosPorNombre
 */
function consultarArticulosProtocolo( $wbasedato, $wcenmez, $criterio, $ccoPaciente, $dosis, $administracion ){
	//Variable que se necesitan
	$centroCostos = "1183";
	$criterio = strtoupper($criterio);
	
	global $conex;
	global $wemp_pmla;
	
	
	$pesMedicamentosBD = consultarAliasPorAplicacion( $conex, $wemp_pmla, "pesMedicamentos" );
	$expPesMedicamentosBD = explode( ";", $pesMedicamentosBD );
	
	$gruposAntibioticos = consultarAliasPorAplicacion( $conex, $wemp_pmla, "gruposMedicamentosAntibioticos" );
	$gruposAntibioticos = explode( ",", $gruposAntibioticos );
			
	$indexArPes = 0;
	foreach( $expPesMedicamentosBD as $keyPesMed => $valuePesMed ){
		
		$expDatos = explode( "-", $valuePesMed );
		
		if( $indexArPes > 0 ){
			$arTiposProtocolos[] = explode( ",", $expDatos[1] );
			$arTiposPertenecientes[] = explode( ",", $expDatos[2] );
			$arPesMedicamentos[] = count($arPesMedicamentos) + 11;
			$arNomPes[] = $expDatos[0];	//Nombre pestaña
		}
		else{
			$arTiposProtocolos[] = Array( 0 => "N" );
			$arTiposPertenecientes[] = explode( ",", $expDatos[2] );
			$arPesMedicamentos[] = 3;
			$arNomPes[] = "Medicamentos";	//Nombre pestaña
		}
		
		$indexArPes++;
	}
	
	
	$coleccion = array();
	$consulta = "";

	global $centroCostosServicioFarmaceutico;
	global $codigoServicioFarmaceutico;
	global $codigoCentralMezclas;
	global $centroCostosCentralMezclas;
	
	global $protocoloNormal;

	$esSF = $centroCostos == $centroCostosServicioFarmaceutico ? true : false;
	$esCM = $centroCostos == $centroCostosCentralMezclas ? true : false;
	
	$ccoUrgencias = consultarCcoUrgencias();
	$esCcoPacienteUrgencias = $ccoPaciente == $ccoUrgencias;

	$dosis_exacta = true;
	$articulo_pos = true;
	
	@$codigo = str_replace("-","%",$codigo);

	$tipoArticulo = "";
	$tipoGenerico = "";

	$observacionesDA = "";
	
	// Variables para guardar el último artículo que mas se acerca a los criterios de búsqueda
	$articulo_encontrado = "";

	//*******************************Grupos que puede ver el centro de costos del usuario
	$tieneGruposIncluidos = false;
	$gruposIncluidos = "(";

	$q6 = "SELECT DISTINCT Ccogka FROM {$wbasedato}_000011 WHERE Ccoest='on' AND Ccogka != '*' AND Ccocod='$centroCostos';";
	$res6 = mysql_query($q6, $conex);

	// Define los grupos de medicamentos que puede ver el centro de costos en el kardex
	while($rs6 = mysql_fetch_array($res6)){
		$tieneGruposIncluidos = true;
		if(strpos($rs6['Ccogka'],$gruposIncluidos) === false){
			$gruposIncluidos .= "'".str_replace(",","','",$rs6['Ccogka'])."',";
		}
	}
	$gruposIncluidos .= "'')";
	//********************************

	 // Se consultan los medicamentos que cumplan con los criterios seleccionados, excepto la dosis
	 $sql = "( SELECT
				Artcod, Artcom, Artgen, Artuni, Unides, '$codigoServicioFarmaceutico' origen, SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru, IFNULL(Artfar,'00') Artfar, Artpos, '' Arttip, Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia, 0 Defmin, 10000 Defmax
			FROM
				{$wbasedato}_000026 a,
				{$wbasedato}_000027 b,
				{$wbasedato}_000059 c
			WHERE 
					Artcod = '".$criterio."'
				AND Artest = 'on'
				AND Artuni = Unicod
				AND Artcod = Defart
				AND Defest = 'on' )
			UNION
			( SELECT
				Artcod, Artcom, Artgen, Artuni, Unides, '$codigoCentralMezclas' origen, '' Artgru, '00' Artfar, '' Artpos, Arttip , Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia, 0 Defmin, 10000 Defmax
			FROM
				{$wcenmez}_000002 a,
				{$wbasedato}_000027 b,
				{$wbasedato}_000059 c
			WHERE	
					Artcod = '".$criterio."'
				AND Artcod NOT IN (SELECT d.Artcod FROM {$wbasedato}_000026 d WHERE d.Artcod = a.Artcod ) 
				AND Artest = 'on'
				AND Artuni = Unicod
				AND Artcod = Defart
				AND Defest = 'on' )
			";
	
	 // Se consultan los medicamentos que cumplan con los criterios seleccionados, excepto la dosis
	 $sql = "( SELECT
				Artcod, Artcom, Artgen, Unicod as Artuni, Unides, '$codigoServicioFarmaceutico' origen, SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru, Artuni as Artfar, Artpos, '' Arttip, Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia, 0 Defmin, 10000 Defmax
			FROM
				{$wbasedato}_000026 a,
				{$wbasedato}_000027 b,
				{$wbasedato}_000059 c
			WHERE 
					Artcod = '".$criterio."'
				AND Artest = 'on'
				AND Deffru = Unicod
				AND Artcod = Defart
				AND Defest = 'on' )
			UNION
			( SELECT
				Artcod, Artcom, Artgen, Unicod as Artuni, Unides, '$codigoCentralMezclas' origen, '' Artgru, Artuni as Artfar, '' Artpos, Arttip , Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia, 0 Defmin, 10000 Defmax
			FROM
				{$wcenmez}_000002 a,
				{$wbasedato}_000027 b,
				{$wbasedato}_000059 c
			WHERE	
					Artcod = '".$criterio."'
				AND Artcod NOT IN (SELECT d.Artcod FROM {$wbasedato}_000026 d WHERE d.Artcod = a.Artcod ) 
				AND Artest = 'on'
				AND Deffru = Unicod
				AND Artcod = Defart
				AND Defest = 'on' )
			";

	// 2012-07-09
	// Se agregó ORDER BY Famund DESC para poder ordenar según la unidad destacada para la familia de medicamentos

	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$num = mysql_num_rows( $res );

	// Si hay un articulo o más
	if($num > 0)
	{
		$rs = mysql_fetch_array($res);
		
		// Se asigna la cantidad de fracciones del artículo
		$fraccionArticulo = $rs['Deffra'];
		
		// Si se encuentra un solo registro y es dosis exacta no es necesario hacer evaluación de fracciones 
		// y este se lleva como resultado de la búsqueda
		if($dosis_exacta)
		{
			$articulo_encontrado = $rs['Artcod'];
		}
		else
		{
			// Si la dosis es múltiplo de las fracciones o viceversa
			if($multiploDosis==0 || $multiploFraccion==0)
			{
				// Si las unidades a pedir estan en el rango de máximo y mínimo
				if(($dosis*1)>=($rs['Defmin']*1) && ($dosis)*1<=($rs['Defmax']*1))
				{
					// Si es primera vez que pasa o las unidades requeridas son menores a las anteriormente guardadas
					if($auxUnidadesRequeridas == -1 || $unidadesRequeridas < $auxUnidadesRequeridas)
					{
						$auxUnidadesRequeridas = $unidadesRequeridas;
						$articulo_encontrado = $rs['Artcod'];
					}
				} 
				// Si la fracción del artículo es superior a la dosis
				else if($dosisCubiertas>1)
				{
					// Si es primera vez que pasa o las unidades requeridas son menores a las anteriormente guardadas
					if($auxDosisCubiertas == -1 || $dosisCubiertas < $auxDosisCubiertas)
					{
						$auxDosisCubiertas = $dosisCubiertas;
						$articulo_encontrado = $rs['Artcod'];
					}
				}
			}
		}	

		if($articulo_encontrado==-1)
		{
			// Si no se encontro artículo que cumpla con la dosis
			// Se crea una dosis Adaptada
			$articulo_encontrado = "DA0000";
		}
						
		//Con el fin de obtener los genericos se tendra en cuenta unicamente la primera palabra de la consulta antes del espacio
		//$vecCriterio = explode("%",$articulo_encontrado);
		//$articulo_encontradoCM = $vecCriterio[0];
		
		// // Se obtienen los datos del articulo encontrado
		// $qCod = " ( SELECT "
		// ." 		Artcod, Artcom, Artgen, Artuni, Unides, '$codigoServicioFarmaceutico' origen, SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru, IFNULL(Artfar,'00') Artfar, Artpos, '' Arttip , Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia "
		// ." FROM "
		// ." 		{$wbasedato}_000027, {$wbasedato}_000026, {$wbasedato}_000059 "
		// ." WHERE "
		// ."			Artuni = Unicod "
		// ."		AND Artcod = '".$articulo_encontrado."' "
		// ."		AND Artcod = Defart "
		// ."		AND Artest = 'on' "
		// ."		AND Defest = 'on' ) ";

		// $qCod .= " UNION ";
		
		// $qCod .= " ( SELECT "
		// ."	Artcod, Artcom, Artgen, Artuni, Unides, '$codigoCentralMezclas' origen, '' Artgru, '00' Artfar, '' Artpos, Arttip , Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia "
		// ." FROM "
		// ." {$wbasedato}_000027, cenpro_000002, {$wbasedato}_000059 "
		// ." WHERE "
		// ."  	Artuni = Unicod "
		// ."	AND Artcod = '".$articulo_encontrado."' "
		// ."	AND Artcod = Defart "
		// ."	AND Artest = 'on' "
		// ."	AND Defest = 'on' ) ";
		
		
		// Se obtienen los datos del articulo encontrado
		$qCod = " ( SELECT "
		." 		Artcod, Artcom, Artgen, Deffru as Artuni, Unides, '$codigoServicioFarmaceutico' origen, SUBSTRING_INDEX( Artgru, '-', 1 ) Artgru, Artuni as Artfar, Artpos, '' Arttip , Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia, Famcod,Artfat "
		." FROM "
		." 		{$wbasedato}_000027, {$wbasedato}_000026, {$wbasedato}_000059 , {$wbasedato}_000114, {$wbasedato}_000115 "
		." WHERE "
		."			Artuni = Unicod "
		."		AND Artcod = '".$articulo_encontrado."' "
		."		AND Artcod = Defart "
		."		AND Artest = 'on' "
		."		AND Relart = Artcod "
		."		AND Relfam = Famcod "
		."		AND Defest = 'on' ) ";

		$qCod .= " UNION ";
		
		$qCod .= " ( SELECT "
		."	Artcod, Artcom, Artgen, Deffru as Artuni, Unides, '$codigoCentralMezclas' origen, '' Artgru, Artuni as Artfar, '' Artpos, Arttip , Deffra, Deffru, Defven, Defdie, Defdis, Defdup, Defdim, Defdom, Defvia, Famcod, '' as Artfat "
		." FROM "
		." {$wbasedato}_000027, {$wcenmez}_000002, {$wbasedato}_000059, {$wbasedato}_000114, {$wbasedato}_000115 "
		." WHERE "
		."  	Artuni = Unicod "
		."	AND Artcod = '".$articulo_encontrado."' "
		."	AND Artcod = Defart "
		."	AND Artest = 'on' "
		."	AND Relart = Artcod "
		."	AND Relfam = Famcod "
		."	AND Defest = 'on' ) ";


		$resart = mysql_query( $qCod, $conex ) or die( mysql_errno()." - Error en el query $qCod - ".mysql_error() );
		$numart = mysql_num_rows( $resart );
		
	}
	else
	{
		$numart = 0;
	}

	$cont1 = 0;
	$agrupoGenericos = false;
	$abreVentanaModal = "";
	
	if($numart > 0)
	{

			$codigoGenericoArticulo = "";


			
			$tieneParametrosFijos = "N";
			$nombreArticuloGenerico = "";
			$puedeAgregar = true;
			
			$rs = mysql_fetch_array($resart);
			
			$tipoProtocolo = $protocoloNormal;
			$tipoArticuloMedicamentoLiquido = "M";
			$tipoGenerico = "";
			$tipoArticulo = "1";
			$borrar = "";
			
			// //Consulta del tipo al que pertenece
			// $qTipLM = "SELECT Meltip FROM {$wbasedato}_000066 WHERE Melgru = '{$rs['Artgru']}' AND Melest='on' ";
			// $resTipLM = mysql_query($qTipLM, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qTipLM . " - " . mysql_error());
			// if($infoTipLM = mysql_fetch_array($resTipLM)){
				// $tipoArticuloMedicamentoLiquido = $infoTipLM['Meltip'];
			// }
			
			//Consulta del protocolo al que pertenece el articulo
			$qProt = "SELECT Arkcod,Arkest,Arkcco,Arktip FROM {$wbasedato}_000068 WHERE Arkcod = '{$rs['Artcod']}'";
			$resProt = mysql_query($qProt, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qProt . " - " . mysql_error());
			if($infoProt = mysql_fetch_array($resProt)){
				$tipoProtocolo = $infoProt['Arktip'];
			}
			
			$color = "red";
			$fftica = $rs['Artfar'];

			//CLASIFICACION DE LOS ARTICULOS
			
			/*TIPOS DE ARTICULOS
			 * 1.  Articulos del maestro de SF
			 * 2.  Articulos del maestro de CM
			 * 3.  Articulos genericos NU,QT,DA dependiendo del tipo en la tabla 68 y la 2
			 * 4.  
			 */
			if($rs['origen'] == $codigoServicioFarmaceutico){ 		//No tiene genéricos
				$tipoGenerico = "";
			}
			
			//On
			/*
			echo "Tipo gen: ".$qTipGen."<br>";
			echo "rs: ".$rs['origen']."<br>";
			echo "central M : ".$codigoCentralMezclas."<br>";
			echo "tipo: ".$rs['Arttip']."<br>";
			*/
	
			if($rs['origen'] == $codigoCentralMezclas)
			{  			//Puede tener genéricos
				//Consulta del tipo al que pertenece
				$tipoCentralMezclas = $rs['Arttip'];
				
				if(!empty($tipoCentralMezclas))
				{
					$qTipGen = "SELECT Arkcod, Tiptpr, Tipdes FROM ".$wcenmez."_000001, {$wbasedato}_000068 WHERE Tipcod = '{$tipoCentralMezclas}' AND Arktip = Tiptpr";
					$resTipGen = mysql_query($qTipGen, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qTipGen . " - " . mysql_error());
					if($infoTipGen = mysql_fetch_array($resTipGen)){
						$tipoGenerico = $infoTipGen['Tiptpr'];
						$codigoGenericoArticulo = $infoTipGen['Arkcod'];
						$articuloGenerico = true;
					} else {
						$articuloGenerico = false;
					}
				} else {
					$qTipGen = "SELECT Arkcod, Arktip FROM {$wbasedato}_000068, {$wbasedato}_000098 WHERE Arkcod = '{$rs['Artcod']}' AND Cartip = Arktip";
					
					$resTipGen = mysql_query($qTipGen, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qTipGen . " - " . mysql_error());
					if($infoTipGen = mysql_fetch_array($resTipGen)){
						$tipoGenerico = $infoTipGen['Arktip'];
						$codigoGenericoArticulo = $infoTipGen['Arkcod'];
						$articuloGenerico = true;
					} else {
						$articuloGenerico = false;
					}
				}
				
				if($articuloGenerico)
				{
					//Partip  Parcdo  Parudo  Parnen  Parfre  Parvia  Parcon  Parcnf  Pardim  Pardom  Parobs
					$qParametros = "SELECT Parcdo,Parudo,Parnen,Parfre,Parvia,Parcon,Parcnf,Pardim,Pardom,Parobs FROM {$wbasedato}_000097 WHERE Partip = '{$tipoGenerico}';";
					$resParametros = mysql_query($qParametros, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qParametros . " - " . mysql_error());
					if($infoParametros = mysql_fetch_array($resParametros))
					{
						$tieneParametrosFijos = "S";

						$parametrosFijosArticuloGenerico[0] = $infoParametros['Parcdo'];		//Cantidad de dosis
						$parametrosFijosArticuloGenerico[1] = $infoParametros['Parudo'];		//Unidad de dosis
						$parametrosFijosArticuloGenerico[2] = $infoParametros['Parnen'];		//No enviar
						$parametrosFijosArticuloGenerico[3] = $infoParametros['Parfre'];		//Frecuencia
						$parametrosFijosArticuloGenerico[4] = $infoParametros['Parvia'];		//Vias de administracion
						$parametrosFijosArticuloGenerico[5] = $infoParametros['Parcon'];		//Condicion de suministro
						$parametrosFijosArticuloGenerico[6] = $infoParametros['Parcnf'];		//Confirmada preparacion
						$parametrosFijosArticuloGenerico[7] = $infoParametros['Pardim'];		//Dias maximos tratamiento
						$parametrosFijosArticuloGenerico[8] = $infoParametros['Pardom'];		//Dosis maximas tratamiento
						$parametrosFijosArticuloGenerico[9] = $infoParametros['Parobs'];		//Observaciones
					}
				}
			}
			
			//Si tiene componentes asociados en la tabla de componentes por tipo, mostrará los tipos
			$qComp = "SELECT Cartip,Carcod,Carcco,Cardis FROM {$wbasedato}_000098 WHERE Cartip = '{$tipoGenerico}';";
			$resComp = mysql_query($qComp, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qComp . " - " . mysql_error());
			$componentesTipo = "";
			$tieneComponentes = false;
			while($infoComp = mysql_fetch_array($resComp))
			{
				if($infoComp['Carcco'] == $centroCostosServicioFarmaceutico ){
					$qArt = "SELECT Artcom,Artgen FROM {$wbasedato}_000026 WHERE Artcod = '{$infoComp['Carcod']}';";
				} else {
					$qArt = "SELECT Artcom,Artgen FROM {$wcenmez}_000002 WHERE Artcod = '{$infoComp['Carcod']}';";
				}
				$resArt = mysql_query($qArt, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $qArt . " - " . mysql_error());
				if($infoArt = mysql_fetch_array($resArt)){
					$componentesTipo .= $infoComp['Carcod']."**";
					$componentesTipo .= $infoComp['Cardis']."**";
					$componentesTipo .= utf8_decode($infoArt['Artcom'])."**";
					$componentesTipo .= utf8_decode($infoArt['Artgen']).";";
				}
				$tieneComponentes = true;
			}
			
			if(str_replace("%"," ",$codigo)){
				$nombreArticuloPersonalizado = "S";
			}
			
			//Clasificacion por tipo
			if($tipoArticuloMedicamentoLiquido == "L"){
				$tipoArticulo = "2";
			}
			
			//Casos posibles de tipo de articulo
			switch($tipoArticulo){
				case '1':	//Articulo generico
					$borrar .= " generico";
 					break;
				case '2':	//Articulo liquido
					$borrar .= " liquido";
					break;
				default:	//Articulo normal
					$borrar .= " normal";
					break;
			}

			
			if(@$articuloGenerico){
				
				// 2012-07-25
				// Se modificaron las asignaciones a las variables para que tomen el nombre del articulo y no el criterio de busqueda
				// ya que el criterio en la nueva busqueda por familia siempre va a ser un codigo, no un nombre
				@$articuloCodigoConsulta = $rs['Artcod'];  // $codigoGenericoArticulo;
				@$articuloNombreGenerico = "*".$rs['Artgen'];  // "*".str_replace("%"," ",$rs['Artgen']);
				@$articuloNombreComercial = $rs['Artcom'];  // $criterioCM
				
				$nombreArticuloGenerico = $articuloNombreGenerico;
				
				if(!$agrupoGenericos){
					$agrupoGenericos = true;
					$puedeAgregar = true;
				} else {
					$puedeAgregar = false;
				}
			} else {
				$articuloCodigoConsulta = $rs['Artcod'];
				$articuloNombreGenerico = $rs['Artgen'];
				$articuloNombreComercial = $rs['Artcom'];
			}
			
				
			/*FORMATO DE LA RESPUESTA PARA EL AUTOCOMPLETE:
			 * Argumentos:
			 * 
			 * 0: Como se muestra en el autocomplete
			 * 1: Codigo del articulo
			 * 2: Nombre comercial del articulo
			 * 3: Nombre genérico del articulo
			 * 4: Tipo protocolo
			 * 5: (M)edicamento o (L)iquido
			 * 6: Es generico
			 * 7: Origen
			 * 8: Grupo de medicamento
			 * 9: Forma farmaceutica
			 * 10:Unidad
			 * 11:POS
			 * 12:Unidad de fraccion
			 * 13:Cantidad de fracciones
			 * 14:Vencimiento
			 * 15:Dias de estabilidad
			 * 16:Es dispensable
			 * 17:Es duplicable
			 * 18:Dias maximos sugeridos
			 * 19:Dosis maximas sugeridas
			 * 20:Via
			 * 21:Abre ventana parametrizada ----
			 * 22:Cantidad de dosis
			 * 23:Unidad de dosis
			 * 24:No enviar
			 * 25:Frecuencia
			 * 26:Vias de administracion
			 * 27:Condicion de suministro
			 * 28:Confirmada preparacion
			 * 29:Dias maximos tratamiento
			 * 30:Dosis maximas tratamiento
			 * 31:Observaciones adicionales
			 * 32:Componentes asociados al tipo
			 * 33:Observaciones si es Dosis Adaptada
			 */
			
			if($rs['Artfar']=="" || $rs['Artfar']==" " || trim($rs['Artfar'])==".")
				$rs['Artfar'] = "00";
				
				
			$resFam = consultarPrincipiosActivosPorFamilia( $conex, $wbasedato, $rs['Famcod'] );
			$codsFam = codigosPrincipiosActivos( $resFam );
			$dessFam = codigosPrincipiosActivos( $resFam, false );
			$principioActivo = $codsFam;
			
			if($puedeAgregar)
			{
				if($tieneComponentes){
					$abreVentanaModal = "S";
				} else {
					$abreVentanaModal = "N";
				}
				
				/***************************************************************************************************
				 * Cambios de tipo de protocolo
				 * De acuerdo al tipo de protocolo se cambia para que aparezca en una pestaña
				 ***************************************************************************************************/
				foreach( $arTiposPertenecientes as $keyTipos => $valueTipos ){
					$keyTipo = array_search( $tipoProtocolo, $valueTipos ) ;
					
					if( $keyTipo !== false ){
						$tipoProtocolo = $arTiposProtocolos[ $keyTipos ][0];	//Siempre es la posición 0
						break;
					}
				}
				// $arTiposPertenecientes[] = explode( ",", $expDatos[2] );
				// echo "asdfasfasfasf......".$tipoProtocolo;
				/***************************************************************************************************/
				
				$noEnviar = ( esStock( $conex, $wbasedato, $rs['Artcod'], $ccoPaciente ) == true )? 'on' : 'off';
				
				$esAntibiotico = in_array( $rs['Artgru'], $gruposAntibioticos ) ? 'on': 'off';
				
				//Miro si el articulo es de control
				$gruposDeControl =  consultarAliasPorAplicacion( $conex, $wemp_pmla, "gruposControl" );
				$esDeControl = ( array_search( $rs['Artgru'], explode( ",", $gruposDeControl ) ) !== false ) ? true : false ;
				if( $esDeControl ){
					$rs['Artgru'] = "CTR";
				}
				
				$famAtc = '';
				//Consulto los principios activos pertenecientes a la familia
				$sql = "SELECT Atccod, Atcdes
							FROM {$wbasedato}_000280 
						   WHERE Atccod IN ( '".implode( "','", explode( ",", $rs['Artfat'] ) )."' )
							 AND Atcest = 'on'
						";
				
				$boolAtc = false;
				$resAtc = mysql_query($sql, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $sql . " - " . mysql_error());
				while($rowsAtc = mysql_fetch_array($resAtc))
				{
					if( $boolAtc ) 
						$famAtc .= ",";
					
					$famAtc .= $rowsAtc['Atccod']."-".utf8_encode( htmlentities($rowsAtc['Atcdes']) );
					
					$boolAtc = true;
				}
				
				$consulta .= "<font color=gray><b>Generico:</b></font> ".htmlentities($articuloNombreGenerico)." <font color=gray><b>Comercial:</b></font> ".htmlentities($articuloNombreComercial).
				"|".strtoupper($articuloCodigoConsulta).
				"|".htmlentities($articuloNombreGenerico).
				"|".htmlentities($articuloNombreComercial).
				"|".$tipoProtocolo.
				"|".$tipoArticuloMedicamentoLiquido.
				"|".$tipoGenerico.
				"|".$rs['origen'].
				"|".$rs['Artgru'].
				"|".$rs['Artfar'].
				"|".$rs['Artuni'].
				"|".$rs['Artpos'].
				"|".$rs['Deffru'].
				"|".$rs['Deffra'].
				"|".$rs['Defven'].
				"|".$rs['Defdie'].
				"|".$rs['Defdis'].
				"|".$rs['Defdup'].
				"|".$rs['Defdim'].
				"|".$rs['Defdom'].
				"|".$rs['Defvia'].
				"|".$abreVentanaModal.
				"|".@$parametrosFijosArticuloGenerico[0].
				"|".@$parametrosFijosArticuloGenerico[1].
				"|".@$parametrosFijosArticuloGenerico[2].
				"|".@$parametrosFijosArticuloGenerico[3].
				"|".@$parametrosFijosArticuloGenerico[4].
				"|".@$parametrosFijosArticuloGenerico[5].
				"|".@$parametrosFijosArticuloGenerico[6].
				"|".@$parametrosFijosArticuloGenerico[7].
				"|".@$parametrosFijosArticuloGenerico[8].
				"|".@$parametrosFijosArticuloGenerico[9].
				"|".@$componentesTipo.
				"|".@$noEnviar.
				"|".@$observacionesDA.
				"|".@$dessFam.
				"|".@$principioActivo.
				"|".@$esAntibiotico.
				"\n";
			}
			
			$cont1++;
	} 
	else 
	{
		$consulta = $consulta."No se encontraron coincidencias";
	}

	liberarConexionBD($conex);

	return $consulta;
}


/*
 * AJAX::ConsultarArticulosPorNombre
 */
// function consultarProtocolo($wbasedato,$protocolo){
function consultarProtocolo($wbasedato,$protocolo,$cco,$codUsuario){

	$protocolo = $protocolo;
	
	global $conex;
	global $usuario;

	$coleccion = array();
	$consulta = "";

	// Se consulta la especialidad del médico
	$sql =  " SELECT Esmcod
				FROM ".$wbasedato."_000048,".$wbasedato."_000065
			   WHERE Meduma = '".$codUsuario."'
				 AND Medest = 'on'
				 AND Esmtdo=Medtdo
				 AND Esmndo=Meddoc;";
	
	$resEspecialidad =  mysql_query($sql,$conex) or die ("Error: ".mysql_errno()." - en el query: ".$sql." - ".mysql_error());
	$numEspecialidad = mysql_num_rows($resEspecialidad);	
	
	$arrayEspecialidades = array();
	if($numEspecialidad > 0)
	{
		while($rowEspecialidad = mysql_fetch_array($resEspecialidad))
		{
			$arrayEspecialidades[] = $rowEspecialidad['Esmcod'];
		}
	}
	
	$especialidades = implode("','",$arrayEspecialidades);
	
	// Se consultan los datos del protocolo
	$sql =  " SELECT Dprcod, Dprfre, Dprvia, Dprcnd, Dprdos, Dprobs, Dprpes, Dprjus, Dprete, Dprese, Promed, Proesp, Procco, Prondi
				FROM {$wbasedato}_000137, {$wbasedato}_000138
			   WHERE Pronom = '".$protocolo."'
				 AND Proest = 'on'
				 AND Protip = 'Ordenes'
				 AND Procod = Dprpro
				 AND Dprest = 'on' ";

	$sql1 = $sql." AND Promed = '".$codUsuario."'
				   AND Proesp IN ('".$especialidades."') ";
	$res1 = mysql_query( $sql1, $conex ) or die( mysql_errno()." - Error en el query $sql1 - ".mysql_error() );
	$num1 = mysql_num_rows( $res1 );
	if($num1>0)
		$sql = $sql1;
	else
	{
		$sql2 = $sql." AND Promed = '".$codUsuario."'
					   AND Proesp = '*' ";
		$res2 = mysql_query( $sql2, $conex ) or die( mysql_errno()." - Error en el query $sql2 - ".mysql_error() );
		$num2 = mysql_num_rows( $res2 );
		if($num2>0)
			$sql = $sql2;
		else
		{
			$sql3 = $sql." AND Promed = '*'
						   AND Proesp IN ('".$especialidades."') ";
			$res3 = mysql_query( $sql3, $conex ) or die( mysql_errno()." - Error en el query $sql3 - ".mysql_error() );
			$num3 = mysql_num_rows( $res3 );
			if($num3>0)
				$sql = $sql3;
			else
			{
				$sql4 = $sql." AND Promed = '*'
							   AND Proesp = '*' ";
				$res4 = mysql_query( $sql4, $conex ) or die( mysql_errno()." - Error en el query $sql4 - ".mysql_error() );
				$num4 = mysql_num_rows( $res4 );
				if($num3>0)
					$sql = $sql4;
			}
		}
	}
	
	$res = mysql_query( $sql, $conex ) or die( mysql_errno()." - Error en el query $sql - ".mysql_error() );
	$num = mysql_num_rows( $res );
	
	$arrayDetalleProtocolo = array();
	
	// Si se encontró protocolo
	if($num > 0)
	{
		while($rs = mysql_fetch_array($res))
		{
			if($rs['Procco']=="*" || $rs['Procco']==$cco)	
			{
				
				if (!array_key_exists($rs['Dprcod']."-".$rs['Dprpes'], $arrayDetalleProtocolo))
				{
					$consulta .= 
					$rs['Dprcod'].
					"|".$rs['Dprfre'].
					"|".$rs['Dprvia'].
					"|".$rs['Dprcnd'].
					"|".$rs['Dprdos'].
					"|".$rs['Dprobs'].
					"|".$rs['Dprpes'].
					"|".$rs['Dprjus'].
					"|".$rs['Dprete'].
					"|".$rs['Dprese'].
					"|".$rs['Prondi'].
					"\\";
					
					$arrayDetalleProtocolo[$rs['Dprcod']."-".$rs['Dprpes']] = $rs['Dprcod'];
				}
				
			}
			
			// $consulta .= 
			// $rs['Dprcod'].
			// "|".$rs['Dprfre'].
			// "|".$rs['Dprvia'].
			// "|".$rs['Dprcnd'].
			// "|".$rs['Dprdos'].
			// "|".$rs['Dprobs'].
			// "|".$rs['Dprpes'].
			// "|".$rs['Dprjus'].
			// "|".$rs['Dprete'].
			// "|".$rs['Dprese'].
			// "\\";
		}
	} 
	else 
	{
		$consulta = $consulta."No se encontraron coincidencias";
	}

	liberarConexionBD($conex);

	return $consulta;
}



function grabarEstadoAprobacionArticulos($basedatos,$historia,$ingreso,$fecha,$codigosArticulos,$estadoAprobacion,$codUsuario){
	$conexion = obtenerConexionBD("matrix");

	$estado = "0";

	$centroCostos = "%";
	$vecArticulos = explode("|",$codigosArticulos);

	foreach ($vecArticulos as $articulo){
		$vecArticulo = explode(";",$articulo);

		if(!empty($vecArticulo[0])){
			$q = "UPDATE {$basedatos}_000054 SET
					Kadare = '$estadoAprobacion'
				WHERE
					Kadhis = '$historia'
					AND Kading = '$ingreso'
					AND Kadfec = '$fecha'
					AND Kadart = '$vecArticulo[0]'
					AND Kadori = '$vecArticulo[1]'
					AND Kadfin = '$vecArticulo[2]'
					AND Kadhin = '$vecArticulo[3]';";

			$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());

			if( $estadoAprobacion != 'on' ){
				$mensajeAuditoria = obtenerMensaje('MSJ_ARTICULO_DESAPROBADO');
			}
			else{
				$mensajeAuditoria = obtenerMensaje('MSJ_ARTICULO_APROBADO');
			}
			
			//Consulto idOriginal
			$q = "SELECT * 
				  FROM
					{$basedatos}_000054
				 WHERE
					Kadhis = '$historia'
					AND Kading = '$ingreso'
					AND Kadfec = '$fecha'
					AND Kadart = '$vecArticulo[0]'
					AND Kadori = '$vecArticulo[1]'
					AND Kadfin = '$vecArticulo[2]'
					AND Kadhin = '$vecArticulo[3]';";

			$res = mysql_query($q, $conexion) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
			$numrows = mysql_num_rows( $res );
			
			if( $numrows > 0 ){
				$rows = mysql_fetch_array( $res );
				$idOriginal = $rows[ 'Kadido' ];
			}

			//Registro de auditoria
			$auditoria = new AuditoriaDTO();

			$auditoria->historia = $historia;
			$auditoria->ingreso = $ingreso;
			$auditoria->descripcion = "$vecArticulo[0],$vecArticulo[1],$vecArticulo[2],$vecArticulo[3]";
			$auditoria->fechaKardex = $fecha;
			$auditoria->mensaje = $mensajeAuditoria;
			$auditoria->seguridad = $codUsuario;
			$auditoria->idOriginal = $idOriginal;

			registrarAuditoriaKardex($conexion,$basedatos,$auditoria);
			
			$estado = "1";
		}
	}
	liberarConexionBD($conexion);
	return $estado;
}
function consultarComponentesTipoLev(){
	global $codigoServicioFarmaceutico;
	global $conex;
	global $wbasedato;

	$q = "SELECT
				artcod, artcom, artuni, unides, '$codigoServicioFarmaceutico' origen, Artfar
			FROM
				{$wbasedato}_000026, {$wbasedato}_000027
			WHERE
				artuni = unicod
				AND artest = 'on'
				AND SUBSTRING_INDEX( Artgru, '-', 1 ) IN (SELECT Melgru FROM {$wbasedato}_000066 WHERE Melest = 'on' AND Meltip = 'L')
			ORDER BY Artcom";

	$res = mysql_query($q, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q . " - " . mysql_error());
	$num = mysql_num_rows($res);

	$consulta = "";

	$cont1 = 0;

	if($num > 0){
		while ($cont1 < $num)
		{
			$rs = mysql_fetch_array($res);

			$referencia = "adicionarComponenteArticulo('".$rs['artcod']."','".str_replace(" ","_",htmlentities(trim($rs[1])))."');";
			$consulta = $consulta." * <a href='#null' onClick=$referencia>".htmlentities(trim($rs[1])).'</a><br/>';
			$cont1++;
		}
	} else {
		$consulta = $consulta."<b>No se encontraron coincidencias</b>";
	}
	return $consulta;
}
/*********************************************************************************************************************************
 * 						SECCION PARA INCLUIR EL USO DE CONSULTAR MEDIANTE AJAX
 * ****MODO DE USO
 * **1.  Hacer la invocación a este php cuando se haga la invocación asíncrona en el objeto xmlhttprequest
 * **	Ej: ajax.open("POST", "../../../include/root/comun.php",true);
 * **2.  Enviar por parametro en esta invocacion
 * **	Ej: ajax.send("consultaAjax=01&basedatos="+document.forms.forma.wbasedato.value+"&parametro1=" + document.forms.forma.parametro1.value);
 **********************************************************************************************************************************/
//Consultas ajax.
if(isset($consultaAjaxKardex)){

	if( empty($whce) && !empty($wemp_pmla) ){
		$whce = consultarAliasPorAplicacion($conex, $wemp_pmla, 'hce');
	}
	
	if( empty($wbasedatohce) && !empty($wemp_pmla) ){
		$wbasedatohce = consultarAliasPorAplicacion($conex, $wemp_pmla, 'hce');
	}
		
	if( empty($basedatos) && !empty($wemp_pmla) ){
		$basedatos = consultarAliasPorAplicacion($conex, $wemp_pmla, 'movhos');
	}
	

	switch($consultaAjaxKardex){
		case 1:
			echo grabarArticuloDetalle($basedatos,$historia,$ingreso,$fechaKardex,$codArticulo,$cantDosis,$unDosis,$per,$fmaFtica,$fini,$hini,$via,$conf,$dtto,$obs,$origenArticulo,$codUsuario,$condicion,$dosMax,$cantGrabar,$unidadManejo,$cantidadManejo,$primerKardex,$horasFrecuencia,$fIniAnt,$hIniAnt,$noDispensar,$tipoProtocolo,$centroCostosGrabacion,$prioridad,$wcantidadAlta,$wimpresion,$walta,$nombreArticulo,$familia,$firma,$artdosisAdaptada,$idoriginal,$artnoEsteril,$profilaxis,$tratamiento,$esPediatrico,$conInsumo1,$conInsumo2,$porProtocolo,$wdrautorizado,$wjusparaautorizar);
			break;
		case 2:
			if(!isset($tipoProtocolo)){
				$tipoProtocolo = "";
			}
			echo consultarMedicamentosPorCodigo($basedatos,prepararCriterio($codigo),$tipoMedicamento,$unidadMedida,$centroCostos,$gruposMedicamentos,$tipoProtocolo, @$ccoPaciente);
			break;
		case 3:
			if(!isset($tipoProtocolo)){
				$tipoProtocolo = "";
			}
				
			echo consultarMedicamentosPorNombre($basedatos,prepararCriterio($nombre),$tipoMedicamento,$unidadMedida,$centroCostos,$gruposMedicamentos,$tipoProtocolo, @$ccoPaciente);
			break;
		case 4:
			echo eliminarArticuloDetalle($basedatos,$historia,$ingreso,$fecha,$codArticulo,$codUsuario,$fechaInicio,$horaInicio,$altaArticulo, $idOriginal );
			break;
		case 5:
			echo consultarEsquemaInsulinaPorCodigo($basedatos,$codigo,$art );
			break;
		case 6:
			echo insertarMedicoTratante($basedatos,$tipoDocumento,$numeroDocumento,$historia,$ingreso,$codUsuario,$fecha,$idRegistro,$tratante,$codigoEspecialidad,$codigoMatrix);
			break;
		case 7:
			// echo json_decode( $datosAdicionales );
			echo grabarExamenKardex($basedatos,$historia,$ingreso,$fecha,$codigoExamen,$nombreExamen,$observaciones,$estado,$fechaDeSolicitado,$codUsuario,$consecutivoOrden,$firma,$observacionesOrden,$justificacion,$consecutivoExamen,$numeroItem,$impExamen,$altExamen, $firmHCE, json_decode( $datosAdicionales ), $ordenAnexa, $esOfertado == 1 ? 'on' : 'off', $usuarioTomaMuestra, $cco );
			break;
		case 8:
			echo eliminarExamenKardex($basedatos,$historia,$ingreso,$fecha,$codExamen,$consecutivoOrden,$codUsuario,$numeroItem);
//			echo eliminarExamenKardex($basedatos,$historia,$ingreso,$fecha,$codExamen,$consecutivoExamen,$consecutivoOrden,$codUsuario,$numeroItem);
			break;
		case 9:
			echo consultarComponentesPorCodigo($basedatos,$codigo,$tipoMedicamento,$unidadMedida);
			break;
		case 10:
			echo consultarComponentesPorNombre($basedatos,$nombre,$tipoMedicamento,$unidadMedida);
			break;
		case 11:
			echo grabarInfusionKardex($basedatos,$historia,$ingreso,$fecha,$componentes,$consecutivo,$observaciones,$codUsuario,$fechaSolicitud);
			break;
		case 12:
			echo eliminarInfusionKardex($basedatos,$historia,$ingreso,$fecha,$componentes,$consecutivo,$codUsuario);
			break;
		case 13:
			echo eliminarMedicoTratante($basedatos,$historia,$ingreso,$codUsuario,$cedula_medico,$fecha);
			break;
		case 14:
			echo insertarDietaKardex($basedatos,$historia,$ingreso,$codUsuario,$fecha,$idRegistro);
			break;
		case 15:
			echo eliminarDietaKardex($basedatos,$historia,$ingreso,$codUsuario,$idRegistro,$fecha);
			break;
		case 16:
			echo suspenderMedicamentoKardex($basedatos,$historia,$ingreso,$codigoArticulo,$fecha,$estado,$fechaInicio,$horaInicio,$codUsuario,$idOriginal);
			break;
		case 17:
			echo grabarArticuloDetallePerfil($basedatos,$historia,$ingreso,$fechaKardex,$codArticulo,$dtto,$obs,$codUsuario,$via,$dosisMaximas,$prioridad,$fechaInicio,$horaInicio,$autorizadoCtc);
			break;
		case 18:
			echo reemplazarArticuloDetallePerfil($basedatos,$historia,$ingreso,$fechaKardex,$codArticulo,$codArticuloNuevo,$dtto,$obs,$unidadDosis,$formaFarm,$origen,$fechaInicio,$horaInicio,$codUsuario);
			break;
		case 19:
			echo consultarMedicosPorEspecialidad($basedatos,$especialidad);
			break;
		case 20:
			echo marcarAprobacionRegente($basedatos,$historia,$ingreso,$fecha,$estado,$codUsuario);
			break;
		case 21:
			echo actualizarAlergiaPorFecha($basedatos,$historia,$ingreso,$fecha,$descripcion,$codUsuario);
			break;
		case 22:
			echo grabarEsquemaDextrometer($basedatos,$historia,$ingreso,$fecha,$codInsulina,$frecuencia,$codEsquema,$arrDosis,$arrUDosis,$arrVia,$arrObservaciones,$codUsuario,$actualizaIntervalos, $min, $max );
			break;
		case 23:
			echo eliminarEsquemaDextrometer($basedatos,$historia,$ingreso,$fecha,$codInsulina,$codUsuario,$codEsquema);
			break;
		case 24:
			//			echo consultarNiveles($basedatos,$historia,$ingreso,$fecha,$codInsulina,$usuario);
			if(!isset($nivelB)){
				$nivelB = '';
			}

			if(!isset($nivelC)){
				$nivelC = '';
			}

			if(!isset($nivelD)){
				$nivelD = '';
			}

			echo consultarNiveles($basedatos,$nivelA,$nivelB,$nivelC,$nivelD);
			break;
		case 25:
			echo @consultarHabitacionPacienteServicio($basedatos,$servicio);
			break;
		case 26:
			echo validarFirmaElectronica($basedatos,$usuarioHce,$firma);
			break;
		case 27:
			if(isset($_GET)){
				$q = strtolower( utf8_decode( $_GET["q"] ) );
			}else{
				$q = strtolower( utf8_decode( $HTTP_GET_VARS["q"]) );
			}

			echo consultarAyudasDiagnosticasPorNombre($basedatos,prepararCriterio($q),@$unidadRealiza,$ccoPaciente,$tipoServicio,$especialidad,$ordenAnexa);
			break;
		case 28:
			echo cancelarOrdenHCE($basedatos,$historia,$ingreso,$fecha,$codUsuario,$centroCostos,$consecutivoOrden);
			break;
		case 29:
			echo grabarOrdenHCE($basedatos,$historia,$ingreso,$fecha,$codUsuario,$centroCostos,$consecutivoOrden,$observacionesOrden);
			break;
		case 30:
		
			if( !isset( $q ) ){
				if(isset($_GET)){
					$q = strtolower($_GET["q"]);
				}else{
					$q = strtolower($HTTP_GET_VARS["q"]);
					// $q = strtolower($_GET["q"]);
				}
			}
				
			echo consultarArticulos($basedatos, $wemp_pmla,prepararCriterio($q), $ccoPaciente );
			break;
			
		case 31:
			echo consultarFamiliaMedicamentos( $conex, $basedatos, $wcenmez, utf8_decode( $q ), $historia, $ingreso );
			break;
			
		case 32:
			echo cargarMedicamentosActivosAnterior( $conex, $wbasedato, $wcenmez, $historia, $ingreso, $cco, $fecha );
			break;
			
		case 33:
			mostrarDetalleOrdenes($wemp_pmla,$wempresa,$wbasedato,$whis,$wing,$wfecini,$wfecfin,$wtiposerv,$wprocedimiento,$westadodet);
			break;
		
		case 34:
			filtrarFamiliaMedicamentos($conex, $basedatos, $wcenmez, $familia, $presentacion, $unidad, $bsq );
			break;
		
		case 35:
		
			if( !isset( $q ) ){
				if(isset($_GET)){
					$q = strtolower($_GET["q"]);
				}else{
					$q = strtolower($HTTP_GET_VARS["q"]);
				}
			}

			echo consultarArticulosFamilia($basedatos,$cenmez, utf8_decode( $q ), $ccoPaciente, $pre, $med, $dos, $adm, $eps, $bsq, $his, $ing );
			break;
			
		case 36:
		
			if( !isset( $q ) ){
				if(isset($_GET)){
					$q = strtolower($_GET["q"]);
				}else{
					$q = strtolower($HTTP_GET_VARS["q"]);
				}
			}
			echo consultarArticulosProtocolo($basedatos,$cenmez,prepararCriterio($q), $ccoPaciente, $dos, $adm );
			break;

		case 37:
		
			if( !isset( $protocolo ) ){
				if(isset($_GET)){
					$protocolo = $_GET["protocolo"];
				}else{
					$protocolo = $HTTP_GET_VARS["protocolo"];
				}
			}
			// echo consultarProtocolo($basedatos,$protocolo,$tipo);
			echo consultarProtocolo($basedatos,$protocolo,$cco,$codUsuario);
			break;

		case 38:
			echo consultarAyudasDiagnosticasPorCodigo($basedatos,$ayd_cod,@$unidadRealiza, $ccoPaciente );
			break;
			
		case 39:
			echo actualizarImpMedicamento($basedatos,$articuloAlta,$whis,$wing,$codigoArticulo,$wfecha,$wfecini,$wfecfin);
			break;
			
		case 40:
			echo actualizarAltaExamen($basedatos,$imprimirExamen,$wcodigo_examen,$wfecha,$wtipo_orden,$wnumero_orden,$nroItem);
			break;

		case 41:
			$windicaiones = sanear_string($windicaiones);
			echo actualizarIndicaciones($basedatos,$historia,$ingreso,$wfecha,$windicaiones);
			break;

		case 42:
			echo actualizarImpresion($basedatos,$whis,$wing,$wfec);
			break;
			
		case 44:
			echo grabarNuevoExamen($wemp_pmla,$basedatos,$descripcion,$tipoServicio,$especialidad);
			break;
			
		case 46:
			echo consultarResumenHistoria($wemp_pmla,$basedatoshce,$whistoria,$wingreso);
			break;
			
		case 47:
			echo consultarFormularioTipoOrden($basedatoshce,$wtipo);
			break;
		
		case 49:
			//echo consultarAyudasDiagnosticasPorTipo($basedatos,$tipoServicio,$especialidad);
			echo grabarNuevoExamen($wemp_pmla,$basedatos,$descripcion,$tipoServicio,$especialidad);
			break;
			
		case 50:
			echo consultarFormularioHCE($basedatoshce,$formTipoOrden,$historia,$ingreso);
			break;
			
		case 51:
			echo borrarFormularioHCE($basedatoshce,$wcco,$historia,$ingreso, $firmHce);
			break;
		
		case 53: 
			echo consultarDxCie10( $q );
			break;
			
		case 55:
			cargarProcedimientosTemporalADetalle( $his, $ing );
			break;
		
		case 56:
			validarusuarioycontrasena( $wemp_pmla, $wusuario, $wpassword );
			break;
			
		case 57:
			$wAjaxEditable = $weditable == 'on' ? true: false;
			salirsigrabar( $wemp_pmla, $whistoria, $wingreso, $wfechagrabacion, $tipoDocumento,$wcedula, $wAjaxEditable, $pestanasVistas );
			break;
			
		case 58:
			$historia = $his;
			$ingreso = $ing;
			marcarRegistrosLeidos( $conex, $basedatos, $whce, $codigo, $his, $ing, $pestanasVistas );
			break;
			
		case 59:
			imprimirArtAlta( $wemp_pmla, $whistoria, $wingreso, $wfechagrabacion, $wbasedato, $wbasedatohce, $whce, $wcedula, $tipoDocumento, $wusuario, $codigoArticulo, $imprimirArtAlta);
			break;
			
		case 60:
			imprimirExamenAlta( $wemp_pmla, $whistoria, $wingreso, $wfechagrabacion, $wbasedato, $wbasedatohce, $whce, $wcedula, $tipoDocumento, $wusuario, $codigoArticulo, $imprimirExamen, $tipoDeOrden, $numeroDeOrden, $nroItem);
			break;
		
		case 61:
			echo consultarDxs( $conex, $wemp_pmla, $whce, $whis, $wing );
			break;
			
		case 62:
			grabarAuditoriaArtSinCTC( $wemp_pmla, $whistoria, $wingreso, $wfechagrabacion, $wbasedato, $wbasedatohce, $whce, $wcedula, $tipoDocumento, $wusuario, $codigo_articulo);
			break;
			
		case 63:
			grabarAuditoriaProcSinCTC( $wemp_pmla, $whistoria, $wingreso, $wfechagrabacion, $wbasedato, $wbasedatohce, $whce, $wcedula, $tipoDocumento, $wusuario, $codigo_procedimiento, $nombreExamen);
			break;
		
		case 64:
            cambiar_estado_examen($wemp_pmla, $wmovhos, $wfec, $wexam, $wing, $wfechadataexamen, $whoradataexamen, $wfechagk, $whis, $wordennro, $wordite, $westado, $wid, $wcco, $whce, $wcontrol_ordenes, $wtexto_examen, $westado_registro, $wuser);
            break;
			
		case 65:
            registrarLiquidosEndovenosos( $conex, $wbasedato, $his, $ing, $codLev, $idolev, $codIns, $idoIns, $esEle, $volEle, $volDil, $fecSol, $volTot, $codFdi, $valFdi, $esInf, $insDca, $insCdc, $sinSol );
            break;
			
		case 66:
            actualizarInsLiquidosEndovenoso( $conex, $wbasedato, $his, $ing, $codLev, $idolev, $codIns, $idoIns, $esEle, $volEle, $volDil, $fecSol, $volTot, $codFdi, $valFdi, $esInf, $wuser, $insDca, $insCdc );
            break;
			
		case 67:
            eliminarInsLiquidosEndovenoso( $conex, $wbasedato, $his, $ing, $codLev, $idolev, $codIns, $idoIns, $esEle, $volEle, $volDil, $fecSol, $volTot, $codFdi, $valFdi, $esInf, $wuser, $insDca, $insCdc );
            break;
			
		case 68:
			pintarModalProcedimientosAgrupados($wemp_pmla, $basedatoshce,$agrupados,$wtipo,$Grabado,$contprocedAgrupados,$editable);
			break;	
			
		case 69:
			pintarFilaProcedimientosAgrupados($tipoOrden,$wuser,$contadorProcAgr,$wcedula,$tipoDocumento,$wemp_pmla,$agrupados,$renglon);
			break;
		
		case 70:
			GrabarProcedimientosAgrupados($wemp_pmla, $basedatos,$historia,$ingreso,$tipoOrden,$NroOrden,$fechaOrdAgr,$wuser,$detalles,$justificaciones,$imprimir);
			break;	
		case 71:
			ModificarProcedimientosAgrupados($wemp_pmla, $basedatos,$historia,$ingreso,$tipoOrden,$fechaOrdAgr,$wuser,$detalles,$justificaciones);
			break;	
		case 72:
			modificarTrProcedimientosAgrupados($historia,$ingreso,$agrupados,$tipoOrdenAgrup,$contadorActualAgrup);
			break;	
		case 73:
			consultarAplicacionMedicamentoPorProcAgrupado($historia,$ingreso,$medicamento,$ido);
			break;		
		case 74:
			pintarModalNutricionesParenteralesNPT($wemp_pmla,$wcenmez,$idx,$tipoprotocolo,$historia,$ingreso,$accion,$arrayInsumos,$peso,$tiempoInfusion,$purga,$volumenTotal,$observaciones);
			break;		
		case 75:
			grabarInsumosNutricionesParenteralesNPT($wemp_pmla,$basedatos,$historia,$ingreso,$wuser,$arrayInsumosNPT,$idProtocolo,$ido,$codArticulo,$peso,$tiempoInfusion,$purga,$volumenTotal,$observaciones);
			break;			
		case 76:
			cargarUltimaNPTordenada($wemp_pmla,$basedatos,$historia,$ingreso,$articulo,$ido);
			break;		
		case 77:
			abrirModalNutricionesParenteralesNPT($wemp_pmla,$wcenmez,$historia,$ingreso,$articulo,$ido,$realizada,$codigoReal,$peso,$tiempoInfusion,$purga,$volumenTotal,$observaciones,$reemplazada);
			
		case 78:
			$rp = verificarCTCs( $conex, $wbasedato, $his, $ing, $datos, $user, $navegador, $wemp_pmla );
			echo json_encode( $rp );
			break;
			
		case 79:
			//Actualiza el parametro en root_000051 de la version del navegador de Mozilla
			$rp = actulizarVesionNavegador( $conex, $wemp_pmla, $version );
			echo json_encode( $rp );
			break;
			
		case 80:
			$wasunto 			= "Actualizar navegador ".$_SERVER[ 'REMOTE_ADDR' ];
			$mensaje 			= "Por favor actualizar el navegador mozilla de la terminal con la siguiente IP: ".$_SERVER[ 'REMOTE_ADDR' ];
			$altbody 			= "";
			$email        		= consultarAliasPorAplicacion( $conex, $wemp_pmla, "emailpmla");
			$email        		= explode("--", $email );
			$wremitente			= array( 'email'	=> $email[0],
										 'password' => $email[1],
										 'from' 	=> $email[0],
										 'fromName' => 'Clinica las americas',
								 );
			// $wdestinatario[]	= $email[0];
			$wdestinatario[]	= consultarAliasPorAplicacion( $conex, $wemp_pmla, "emailSoporte");
			$rp = sendToEmail($wasunto,$mensaje,$altbody,$wremitente,$wdestinatario);
			echo json_encode( $rp );
			break;
		case 81:
			abrirCTCcontributivo($wemp_pmla,$whistoria,$wingreso,$codMedico,$cadenaCTCcontributivo);
			break;
			
		case 82:
			cambiarEstadoDeDispensacionParaLEVIC($conex, $wbasedato, $his, $ing );
			break;
			
		case 83:
			$medControl = consultarArticuloControlAImprimir( $conex, $wbasedato, $wcenmez, $wemp_pmla, $whistoria, $wingreso, $fechaKardex );
			echo json_encode($medControl);
			break;
			
		case 84:
			if( !isset( $q ) ){
				if(isset($_GET)){
					$q = strtolower($_GET["q"]);
				}else{
					$q = strtolower($HTTP_GET_VARS["q"]);
				}
			}
			
			$json = consultarDiagnosticos( $conex, $q, false );
			
			echo $json;
			break;
		case 85:
		
			$data = guardarCTCcontributivo($wemp_pmla,$whistoria,$wingreso,$codMedico,$cadenaCTCcontributivo,$consecutivoMipres);
			$data = utf8_encode($data);
			echo json_encode($data);
			break;
			return;
			
		case 'consultarAuditoria':
		
			if( !isset( $mostrarRol ) )
				$mostrarRol = false;
		
			$data = consultarAuditoria( $whistoria, $wingreso, $mostrarRol );
			echo json_encode($data);
			break;
			
		case 'consultarArticulosAnterior':
			
			//Detalle de medicamentos anteriores
			$colDetalleAnteriorKardex = consultarDetalleMedicamentosAnterioresKardex( $historia, $ingreso, $wfecha, $protocolo == 'LQ' ? '%' : $protocolo, true );
			$cantidadElementosAnteriores = count($colDetalleAnteriorKardex);
			
			consultarLEV( $colDetalleAnteriorLQ, $colDetalleAnteriorKardex );
			$cantidadElementosAnteriores = count($colDetalleAnteriorKardex);
			
			if( $protocolo == 'LQ' ){
				$colDetalleAnteriorKardex = $colDetalleAnteriorLQ;
				$cantidadElementosAnteriores = count($colDetalleAnteriorKardex);
			}

			if( $cantidadElementosAnteriores > 0 ){
				
				$colCondicionesSuministroInsulinas = consultarPeriodicidades( 'I' );
				$colPeriodicidades = consultarPeriodicidades();
				$colCondicionesSuministro = consultarCondicionesSuministroMedicamentos("");
				$colFormasFarmaceuticas = consultarUnidadesMedida();
				$colVias = consultarViasAdministracion();
				$colUnidades = consultarUnidadesMedida();
				
				if( $protocolo == 'LQ' ){
					vista_desplegarListaArticulosLEVHistorial( $conex, $wbasedato, $wbasedatohce, $wemp_pmla, $colDetalleAnteriorKardex, $historia, $ingreso, $wfecha, $accionesPestana2,$indicePestana, $usuario, $protocolo,false );
				}
				else{
					// $funcionOnclickAbrirNPT = consultarSiEsNutricionNPT($wbasedato,$articulo->historia,$articulo->ingreso,$articulo->consultarCodigoArticulo(),$articulo->idOriginal);
					// var_dump($colPeriodicidades);
					// var_dump($$colCondicionesSuministroInsulinas);
					vista_desplegarListaArticulosHistorial($colDetalleAnteriorKardex,$protocolo,$colUnidades,array_merge( $colPeriodicidades, $colCondicionesSuministroInsulinas ),$colCondicionesSuministro,$colFormasFarmaceuticas,$colVias, $wbasedato);
				}
			}
			else{
				echo '<br><span class="subtituloPagina2" align="center">';
				echo "No hay medicamentos anteriores";
				echo "</span>";
				echo "<div id='medAnt'>";
				echo "</div>";
			}
			
		break;
		
		case 'ordenTrabajoLaboratorio':
			crearMensajesHL7OLM( $conex, $wemp_pmla, $wbasedato, $historia, $ingreso, $wusuario );
		break;
			
		case 'actualizarOrdenLeidaMedico':
			$val = actualizarOrdenLeida( $conex, $whce, $wbasedato, $historia, $ingreso, $wusuario, $tipoOrden, $nroOrden );
			
			echo $val ? '1': '0';
		break;
		
		case 'actualizarEstudioCanceladoLeido':
			$val = actualizarEstudioLeido( $conex, $whce, $wbasedato, $wusuario, $tipoOrden, $nroOrden, $item );
			echo $val ? '1': '0';
		break;
		
		case 'imagenologiaHiruko':
			enviarOrdenesAAgendar( $conex, $whce, $wbasedato, $historia, $ingreso );
		break;
			
		case 'tomarMuestra':
		
			if( count($ordenes) > 0 ){
				
				$respuestas = [];
				
				foreach( $ordenes as $key => $value ){
					
					$msg = "";
					
					$tomaMuestra = tomarMuestrasDesdeGestion( $conex, $whce, $wmovhos, $value['tor'], $value['nor'], $value['item'], $wuser );
					
					if( !$tomaMuestra['error'] ){
						
						$q1 = "SELECT Descripcion
								 FROM usuarios 
								WHERE Codigo = '".$tomaMuestra['user']."'";
						
						$res = mysql_query($q1, $conex) or die ("Error: " . mysql_errno() . " - en el query: " . $q1 . " - " . mysql_error());
						
						$descripcion_usuario = $tomaMuestra['user'];
						
						if( $rows = mysql_fetch_array($res) ){
							$descripcion_usuario = $rows['Descripcion'];
						}
						
						if( $tomaMuestra['user'] != $wuser ){
							//Consulto el nombre del estudio
							$nombreEstudio 	= consultarEstudioPorOrdenClinica( $conex, $whce, $value['tor'], $value['nor'], $value['item'] );
							$msg 			= utf8_encode( "La toma de muestra para el estudio ".$nombreEstudio." ya fue realizada por el usuario: ".$descripcion_usuario );
						}
						
						$respuestas[] = [
								'tor'  => $value['tor'],
								'nor'  => $value['nor'],
								'item' => $value['item'],
								'desc' => utf8_encode( $descripcion_usuario ),
								'fecha'=> $tomaMuestra['fecha'],
								'hora' => $tomaMuestra['hora'],
								'msg'  => $msg,
								'error'=> 0,
							];
					}
					else{
						$respuestas[] = [
								'tor'  => $value['tor'],
								'nor'  => $value['nor'],
								'item' => $value['item'],
								'desc' => '',
								'fecha'=> '',
								'hora' => '',
								'msg'  => 'No se realizó la toma de muestra.',
								'error'=> 1,
							];
					}
				}
				
				echo json_encode( $respuestas );
				
			}
		
		break;
		
		case 'enviarMensajesFaltantes':
			enviarALaboratorioHL7Faltantes( $conex, $wemp_pmla, $wmovhos, $whce, $usuario );
		break;
			
		default :
			break;
	}
}
?>