<?php
include_once("conex.php");/* ***************** REDIRECCIÓN PÁGINAS FONDOS CLÍNICA ***************************************** ****************************** DESCRIPCIÓN *************************************************** * Permite redireccionar a la página del fondo mutuo o del fondo de empleados según los parámetros  * recibidos. La redirección la hace enviando la cédula del usuario encriptada de modo que solo éste  * pueda ver su extracto en línea * Este script también registra las visitas realizadas a las páginas en la tabla 000002 de los fondos ************************************************************************************************* * Autor: John M. Cadavid. G. * Fecha creacion: 2012-11-20 ************************************************************************************************* * MODIFICACIONES ************************************************************************************************* * 2013-05-09 - Se modificó el valor de la variable $servidor, de modo que ya no lleve la IP sino * la URL fondo.lasamericas.com.co; que es la URL visible desde afuera, asi los uaurios podrán ingresar  * a la página desde cualquier lugar **************************************************************************************************/  session_start(); if(!isset($_SESSION['user'])) {	echo "Error - No se encontró usuario activo en Matrix."; } else { 	// Se realiza la conexión a matrix	
	
		/******************************************************************************/	/******************************* INCIO DE FUNCIONES ***************************/	/******************************************************************************/	// Función de encriptación	// Permite enviar la cédula del visitante ecriptada en la URL de la página	function encrypt($string) {	   return base64_encode($string);	}	// Obtiene la IP del PC del usuario	function getIP(){		if( isset( $_SERVER['HTTP_X_FORWARDED_FOR'] )) $ip = $_SERVER['HTTP_X_FORWARDED_FOR'];		else if( isset( $_SERVER ['HTTP_VIA'] ))  $ip = $_SERVER['HTTP_VIA'];		else if( isset( $_SERVER ['REMOTE_ADDR'] ))  $ip = $_SERVER['REMOTE_ADDR'];		else $ip = null ;		return $ip;	}		// Establece la ubicación actual del visitante	// Si está en la empresa o afuera	function obtener_localizacion()	{		$ip = getIP();		$red = "132.1.16.1";		$mascara = "255.255.0.0";		// Dividimos en octetos		$octip = explode(".",$ip);		$octnet = explode(".",$red);		$octmask = explode(".",$mascara);		// Comparamos con AND binario		for ($i=0;$i<4;$i++) {				$a = (int)$octip[$i] & (int)$octmask[$i];				$b = (int)$octnet[$i] & (int)$octmask[$i];				if ($a != $b) return "Externa";		}		return "Interna";	}		// Graba los datos de estadísticas del ingreso del usuario a la página	function grabar_estadisticas_visita($codigo,$documento_id,$empresa,$pagina,$fecha,$hora,$localizacion)	{		global $conex;				$contador = 1;		$ip = getIP();		// Consulto si el usuario ya ha ingresado hoy a la página desde la misma ubicación		$query  = "SELECT Esvcon ";		$query .= "  FROM fondos_000002 ";		$query .= " WHERE Esvusu = '".$codigo."' ";		$query .= "   AND Esvpag = '".$pagina."' ";		$query .= "   AND Esvloc = '".$localizacion."' ";		$query .= "   AND Fecha_data = '".$fecha."' ";		$rsVisita = mysql_query($query,$conex);		$numVisita = mysql_num_rows($rsVisita);		$rowVisita = mysql_fetch_array($rsVisita);				// Si el usuario ya ha ingresado hoy a la página desde la misma ubiación		if($numVisita == 0)		{			// Grabo datos de primer ingreso del usuario para hoy			$query  = "	INSERT  INTO  fondos_000002 ";			$query .= " 		( Medico, Fecha_data, Hora_data, Esvusu, Esvced, Esvemp, Esvpag, Esvloc, Esvcon, Esvdip, Esvest, Seguridad  ) ";			$query .= " VALUES  ( 'fondos', '".$fecha."', '".$hora."', '".$codigo."', '".$documento_id."', '".$empresa."', '".$pagina."', '".$localizacion."', ".$contador.", '".$ip."', 'on', 'C-fondos'  )";			$rs = mysql_query($query,$conex);		}			else		{			$contador = ($rowVisita['Esvcon']*1) + 1;			// Actualizó el contador de ingresos del usuario para hoy			$query  = "	UPDATE fondos_000002 ";			$query .= "    SET Hora_data = '".$hora."', Esvcon = ".$contador." ";			$query .= "  WHERE Esvusu = '".$codigo."' ";			$query .= "    AND Esvpag = '".$pagina."' ";			$query .= "    AND Esvloc = '".$localizacion."' ";			$query .= "    AND Fecha_data = '".$fecha."' ";			$rs = mysql_query($query,$conex);		}	}	/******************************************************************************/	/******************************** FIN DE FUNCIONES ****************************/	/******************************************************************************/			// Documento de identificacion del usuario	$documento_id = "";		// Pagina de redirección	$pagina = "fmutuo";		// Si viene otra pagina de redireccion establecido asignela	if(isset($_GET['pag']) && $_GET['pag']!="")		$pagina = $_GET['pag'];	elseif(isset($_POST['pag']) && $_POST['pag']!="")		$pagina = $_POST['pag'];		// Si viene un documento de usuario establecido asignelo	if(isset($_GET['ide']) && $_GET['ide']!="")		$documento_id = $_GET['ide'];	elseif(isset($_POST['ide']) && $_POST['ide']!="")		$documento_id = $_POST['ide'];		// Se obtiene el código del usuario	$pos = strpos($user,"-");	$wusuario = substr($user,$pos+1,strlen($user)); 		// Establce el servidor donde está alojada la página web	//$servidor = $_SERVER['SERVER_NAME'];	$servidor = '132.1.21.0';	$servidor = '132.1.18.20';	$servidor = 'fondo.lasamericas.com.co';	//$tbInfoEmpleado = 'talhuma_000013';		// Segun el usuario y empresa de éste consulto la tabla 	// de información de empleados correspondiente a esa empresa	$query  = "SELECT Detval ";	$query .= "  FROM usuarios, root_000051 ";	$query .= " WHERE Codigo = '".$wusuario."' ";	$query .= "   AND Activo = 'A' ";	$query .= "   AND Empresa = Detemp ";	$query .= "   AND Detapl = 'informacion_empleados' ";	$rsEmpresa = mysql_query($query,$conex);	$numEmpresa = mysql_num_rows($rsEmpresa);	if($numEmpresa > 0)	{		// Obtengo la tabla de información de empleados que se debe consultar		$rowEmpresa = mysql_fetch_array($rsEmpresa);		$tbInfoEmpleado = $rowEmpresa['Detval'];	}		// Consulto la cédula del empleado	$query  = "SELECT Ideced, Ideuse, Empresa  ";	$query .= "  FROM usuarios, $tbInfoEmpleado ";	$query .= " WHERE Codigo = '".$wusuario."' ";	$query .= "   AND ( ( CONCAT(Codigo,'-',Empresa) = Ideuse OR  CONCAT(SUBSTRING(Codigo,3),'-',Empresa) = Ideuse)";	$query .= "   OR ( Codigo = Ideuse OR  SUBSTRING(Codigo,3) = Ideuse) ) ";		$query .= "   AND Ideest = 'on' ";	$query .= "   AND Activo = 'A' ";	$rs = mysql_query($query,$conex);	$num = mysql_num_rows($rs);	if($num > 0)	{		// Obtengo la cédula del empleado		$row = mysql_fetch_array($rs);		$documento_id = $row['Ideced'];		$codigo = $row['Ideuse'];		$empresa = $row['Empresa'];	}		// Se encripta el documento del usuario	$docenc = encrypt($documento_id);		// Si existe documento de usuario se graban las estadísticas de visita 	// y se redirecciona a la página especificada	if($documento_id!="")	{				// Consulto datos de la empresa		$query  = "SELECT Empcod, Empdes ";		$query .= "  FROM root_000050 ";		$query .= " WHERE Empcod = '".$empresa."' ";		$rs = mysql_query($query,$conex);		$num = mysql_num_rows($rs);		if($num > 0)		{			// Obtengo el códigoy descripción de la empresa			$row = mysql_fetch_array($rs);			$empresa = $row['Empcod']."-".$row['Empdes'];		}				$localizacion = obtener_localizacion();				// Se obtiene la fecha actual		$fecha = date("Y-m-d");		$hora = date("H:i:s");				// Guardo el registro de la visita del empleado a la página		grabar_estadisticas_visita($codigo,$documento_id,$empresa,$pagina,$fecha,$hora,$localizacion);				header('Location: http://'.$servidor.'/'.$pagina.'/index.php?wuser='.$docenc.'');	}	else	{		echo "No se encontró la información del usuario en Matrix, por favor vuelva a entrar al Sistema e intente de nuevo entrar a esta página";	}	}?>