<html>
<head>
  <title>MATRIX Odontograma</title>
    <style type="text/css">
    	//body{background:white url(portal.gif) transparent center no-repeat scroll;}
    	#tipo1{color:#000066;background:#FFFFFF;font-size:7pt;font-family:Tahoma;font-weight:bold;}
    	#tipo2{color:#000066;background:#FFFFFF;font-size:7pt;font-family:Tahoma;font-weight:bold;}
    	.tipo3{color:#000066;background:#FFFFFF;font-size:7pt;font-family:Tahoma;font-weight:bold;text-align:left;}
    	.tipo4{color:#000066;background:#dddddd;font-size:6pt;font-family:Tahoma;font-weight:bold;text-align:center;}
    	#tipo5{color:#000066;background:#FFFFFF;font-size:10pt;font-family:Tahoma;font-weight:bold;}
    	.tipo6{color:#000066;background:#FFFFFF;font-size:10pt;font-family:Tahoma;font-weight:bold;text-align:center;}
    	#tipo7{color:#FFFFFF;background:#000066;font-size:12pt;font-family:Tahoma;font-weight:bold;width:30em;}
    	#tipo8{color:#99CCFF;background:#000066;font-size:6pt;font-family:Tahoma;font-weight:bold;}
    	#tipo9{color:#000066;background:#dddddd;font-size:7pt;font-family:Tahoma;font-weight:bold;text-align:center;}
    	
    	#tipo10{color:#000066;background:#999999;font-size:8pt;font-family:Tahoma;font-weight:bold;text-align:center;}
    	#tipo10A{color:#000066;background:#999999;font-size:8pt;font-family:Tahoma;font-weight:bold;text-align:left;}
    	#tipo10B{color:#000066;background:#999999;font-size:8pt;font-family:Tahoma;font-weight:bold;text-align:right;}
    	
    	#tipo11{color:#000066;background:#cccccc;font-size:9pt;font-family:Tahoma;font-weight:bold;text-align:center;}
    	#tipo12{color:#000066;background:#cccccc;font-size:13pt;font-family:Tahoma;font-weight:bold;text-align:center;}
    	#tipo13{color:#000066;background:#cccccc;font-size:7pt;font-family:Tahoma;font-weight:bold;text-align:center;}
    	
    	#tipo14{color:#000066;background:#FF0000;font-size:7pt;font-family:Tahoma;font-weight:bold;text-align:center;}
    	#tipo15{color:#000066;background:#CC99FF;font-size:7pt;font-family:Tahoma;font-weight:bold;text-align:center;}
    	
    	#tipo16A{color:#000066;background:#99CCFF;font-size:7pt;font-family:Tahoma;font-weight:bold;text-align:center;}
    	#tipo16B{color:#000066;background:#99CCFF;font-size:7pt;font-family:Tahoma;font-weight:bold;text-align:left;}
    	#tipo16C{color:#000066;background:#99CCFF;font-size:7pt;font-family:Tahoma;font-weight:bold;text-align:right;}
    	
    	#tipo17A{color:#000066;background:#FFFFFF;font-size:7pt;font-family:Tahoma;font-weight:bold;text-align:center;}
    	#tipo17B{color:#000066;background:#FFFFFF;font-size:7pt;font-family:Tahoma;font-weight:bold;text-align:left;}
    	#tipo17C{color:#000066;background:#FFFFFF;font-size:7pt;font-family:Tahoma;font-weight:bold;text-align:right;}
    	
		
    	#tipo18A{color:#000000;background:#99CCFF;font-size:9pt;font-family:Tahoma;font-weight:bold;text-align:left;}
    	#tipo18B{color:#000000;background:#CC99FF;font-size:9pt;font-family:Tahoma;font-weight:bold;text-align:left;}
    	#tipo18C{color:#000000;background:#FFFFFF;font-size:9pt;font-family:Tahoma;font-weight:bold;text-align:center;}
    	
    	#tipo19{color:#000066;background:#cccccc;font-size:8pt;font-family:Tahoma;font-weight:bold;text-align:left;}
    	#tipo20{color:#000066;background:#cccccc;font-size:8pt;font-family:Tahoma;font-weight:bold;text-align:right;}
    	
    	#tipo21A{color:#000000;background:#CC99FF;font-size:7pt;font-family:Tahoma;font-weight:bold;text-align:center;}
    	#tipo21B{color:#000000;background:#CC99FF;font-size:7pt;font-family:Tahoma;font-weight:bold;text-align:left;}
    	#tipo21C{color:#000000;background:#CC99FF;font-size:7pt;font-family:Tahoma;font-weight:bold;text-align:right;}
    	
    	#tipo22A{color:#000000;background:#FFCC66;font-size:7pt;font-family:Tahoma;font-weight:bold;text-align:center;}
    	#tipo22B{color:#000000;background:#FFCC66;font-size:7pt;font-family:Tahoma;font-weight:bold;text-align:left;}
    	#tipo22C{color:#000000;background:#FFCC66;font-size:7pt;font-family:Tahoma;font-weight:bold;text-align:right;}
    	
    	#tipoG00{color:#000066;background:#FFFFFF;font-size:7pt;font-family:Tahoma;font-weight:bold;table-layout:fixed;text-align:center;}
    	#tipoG01{color:#000066;background:#FFFFFF;font-size:7pt;font-family:Tahoma;font-weight:bold;width:2.5em;text-align:center;height:2.5em;}
    	#tipoG02{color:#000066;background:#FF0000;font-size:7pt;font-family:Tahoma;font-weight:bold;width:2.5em;text-align:center;height:2.5em;}
    	#tipoG03{color:#000066;background:#000099;font-size:7pt;font-family:Tahoma;font-weight:bold;width:2.5em;text-align:center;height:2.5em;}
    	#tipoG04{color:#000066;background:#00FFFF;font-size:7pt;font-family:Tahoma;font-weight:bold;width:2.5em;text-align:center;height:2.5em;}
    	#tipoG05{color:#000066;background:#cccccc;font-size:7pt;font-family:Tahoma;font-weight:bold;width:2.5em;text-align:center;height:2.5em;}
    	#tipoG06{color:#000066;background:#999999;font-size:7pt;font-family:Tahoma;font-weight:bold;width:2.5em;text-align:center;height:2.5em;}
    	
    	#tipoG54{color:#000066;background:#DDDDDD;font-size:6pt;font-family:Tahoma;font-weight:bold;width:6.4em;text-align:center;height:2.5em;}
    	#tipoG11{color:#FFFFFF;background:#99CCFF;font-size:5pt;font-family:Tahoma;font-weight:bold;width:6.4em;text-align:center;height:2.5em;}
    	#tipoG21{color:#FFFFFF;background:#CC3333;font-size:5pt;font-family:Tahoma;font-weight:bold;width:6.4em;text-align:center;height:2.5em;}
    	#tipoG32{color:#FF0000;background:#FFFF66;font-size:5pt;font-family:Tahoma;font-weight:bold;width:6.4em;text-align:center;height:2.5em;}
    	#tipoG33{color:#006600;background:#FFFF66;font-size:5pt;font-family:Tahoma;font-weight:bold;width:6.4em;text-align:center;height:2.5em;}
    	#tipoG34{color:#000066;background:#FFFF66;font-size:5pt;font-family:Tahoma;font-weight:bold;width:6.4em;text-align:center;height:2.5em;}
    	#tipoG42{color:#FF0000;background:#00CC66;font-size:5pt;font-family:Tahoma;font-weight:bold;width:6.4em;text-align:center;height:2.5em;}
    	#tipoG41{color:#FFFFFF;background:#00CC66;font-size:5pt;font-family:Tahoma;font-weight:bold;width:6.4em;text-align:center;height:2.5em;}
    	#tipoG44{color:#000066;background:#00CC66;font-size:5pt;font-family:Tahoma;font-weight:bold;width:6.4em;text-align:center;height:2.5em;}
    	
    	#tipoM00{color:#000066;background:#FFFFFF;font-size:7pt;font-family:Tahoma;font-weight:bold;table-layout:fixed;text-align:center;}
    	#tipoM01{color:#000066;background:#DDDDDD;font-size:7pt;font-family:Tahoma;font-weight:bold;width:20em;text-align:left;height:2.5em;}
    	#tipoM02{color:#000066;background:#99CCFF;font-size:7pt;font-family:Tahoma;font-weight:bold;width:20em;text-align:left;height:2.5em;}
    	
    </style>
</head>
<body onload=ira() BGCOLOR="FFFFFF" oncontextmenu = "return true" onselectstart = "return true" ondragstart = "return true">
<BODY TEXT="#000066">
<script type="text/javascript">
<!--
	function enter()
	{
		document.forms.soe.submit();
	}
//-->
</script>

<?php
include_once("conex.php");
function array_s($item,&$actividad,$k,$ubicacion)
{
	$it1=substr($item,0,strpos($item," "))." Real.";
	for ($j=0;$j<=$k;$j++)
	{
		if($it1 == $actividad[$j][3] and $actividad[$j][7] == 0 and $actividad[$j][4] == $ubicacion)
		{
			$actividad[$j][7]=1;
			return true;
		}
	}
	return false;
}

function buscar(&$thoot,$diente,$fecha,$hora,$actividad,&$p1)
{
	for ($i=0;$i<=$p1;$i++)
		if($thoot[$i][0] == $diente and $thoot[$i][1] == $fecha and $thoot[$i][2] == $hora and $thoot[$i][3] == $actividad)
			return true;
}
session_start();
if(!isset($_SESSION['user']))
	echo "error";
else
{
	$key = substr($user,2,strlen($user));
	echo "<form name='soe' action='Odontograma.php' method=post>";
	if(isset($addX))
		unset($add);
	

	

	if(isset($wegrT))
	{
		$query = "select Parmei, Pardxi, Pareta, Parcae, Parmee, Partdx, Pardxn, Parpro, Paresp, Parser from soe_000120 where Parcco='".$wsei."' and parest='on' ";
		$errA = mysql_query($query,$conex) or die("ERROR CONSULTANDO ARCHIVO DE PARAMETROS INGRESO AMBULATORIO : ".mysql_errno().":".mysql_error());
		$numA = mysql_num_rows($errA);
		if ($numA > 0)
		{
			$fecha = date("Y-m-d");
			$hora = (string)date("H:i:s");
			$query = "lock table soe_000100 LOW_PRIORITY WRITE, soe_000108 LOW_PRIORITY WRITE, soe_000109 LOW_PRIORITY WRITE, soe_000110 LOW_PRIORITY WRITE, soe_000111 LOW_PRIORITY WRITE, soe_000112 LOW_PRIORITY WRITE  ";
			$err1 = mysql_query($query,$conex) or die("ERROR BLOQUEANDO TABLAS : ".mysql_errno().":".mysql_error());
			$rowA = mysql_fetch_array($errA);
			$query = "insert soe_000108 (medico,fecha_data,hora_data, Egrhis, Egring, Egrmei, Egrdxi, Egrfee, Egrhoe, Egrest, Egrcae, Egrmee, Egrcom, seguridad) values ('soe','".$fecha."','".$hora."','".$whis."','".$wing."','".$rowA[0]."','".$rowA[1]."','".$fecha."','".$hora."',".$rowA[2].",'".$rowA[3]."','".$rowA[4]."','off','C-soe')";
			$err1 = mysql_query($query,$conex) or die("ERROR GRABANDO EN 108 EGRESOS AMBULATORIOS : ".mysql_errno().":".mysql_error());
			$wswdx=0;
			for ($i=1;$i<=$se1;$i++)
			{
				if($wdata1[$i][0] != "01")
				{
					$wswdx++;
	 				if($wswdx == 1)
						$query = "insert soe_000109 (medico,fecha_data,hora_data, Diahis, Diaing, Diacod, Diatip, Dianue, seguridad) values ('soe','".$fecha."','".$hora."','".$whis."','".$wing."','".$wdata1[$i][1]."','".$rowA[5]."','".$rowA[6]."','C-soe')";
					else
						$query = "insert soe_000109 (medico,fecha_data,hora_data, Diahis, Diaing, Diacod, Diatip, Dianue, seguridad) values ('soe','".$fecha."','".$hora."','".$whis."','".$wing."','".$wdata1[$i][1]."','S','".$rowA[6]."','C-soe')";
					$err1 = mysql_query($query,$conex) or die("ERROR GRABANDO EN 109 DIAGNOSTICOS AMBULATORIOS : ".mysql_errno().":".mysql_error());
				}
			}
			if($wswdx == 0)
			{
				$query = "insert soe_000109 (medico,fecha_data,hora_data, Diahis, Diaing, Diacod, Diatip, Dianue, seguridad) values ('soe','".$fecha."','".$hora."','".$whis."','".$wing."','".$rowA[1]."','".$rowA[5]."','".$rowA[6]."','C-soe')";
				$err1 = mysql_query($query,$conex) or die("ERROR GRABANDO EN 109 DIAGNOSTICOS AMBULATORIOS : ".mysql_errno().":".mysql_error());
			}
			$query = "insert soe_000110 (medico,fecha_data,hora_data, Prohis, Proing, Procod, seguridad) values ('soe','".$fecha."','".$hora."','".$whis."','".$wing."','".$rowA[7]."','C-soe')";
			$err1 = mysql_query($query,$conex) or die("ERROR GRABANDO EN 110 PROCEDIMIENTOS AMBULATORIOS : ".mysql_errno().":".mysql_error());
			$query = "insert soe_000111 (medico,fecha_data,hora_data, Esphis, Esping, Espcod, seguridad) values ('soe','".$fecha."','".$hora."','".$whis."','".$wing."','".$rowA[8]."','C-soe')";
			$err1 = mysql_query($query,$conex) or die("ERROR GRABANDO EN 111 ESPECIALIDADES AMBULATORIAS : ".mysql_errno().":".mysql_error());
			$query = "insert soe_000112 (medico,fecha_data,hora_data, Serhis, Sering, Sercod, seguridad) values ('soe','".$fecha."','".$hora."','".$whis."','".$wing."','".$rowA[9]."','C-soe')";
			$err1 = mysql_query($query,$conex) or die("ERROR GRABANDO EN 112 SERVICIOS AMBULATORIOS : ".mysql_errno().":".mysql_error());
			$query = "UPDATE soe_000100 set Pacact='off' where Pachis = '".$whis."'";
			$err1 = mysql_query($query,$conex) or die("ERROR INACTIVANDO PACIENTE EN ARCHIVO 100 : ".mysql_errno().":".mysql_error());
			$query = " UNLOCK TABLES";
			$err1 = mysql_query($query,$conex) or die("ERROR DESBLOQUEANDO TABLAS : ".mysql_errno().":".mysql_error());
			unset($paciente);
		}
	}
	if(isset($ok1) and $actividad != "" and $W != ".")
	{
		$ubicacion="N/A";
		$fecha = date("Y-m-d");
		$hora = (string)date("H:i:s");
		$query = "insert soe_000130 (medico,fecha_data,hora_data, Identificacion, Fecha, Hora, Diente, Actividad, Ubicacion, Comentarios, Odontologo, seguridad) values ('soe','".$fecha."','".$hora."','".$paciente."','".$fecha."','".$hora."',99,'".$actividad."','".$ubicacion."','".$W."','".$key."','C-soe')";
		$err2 = mysql_query($query,$conex) or die(mysql_errno().":".mysql_error());
		unset($ok);
		unset($R);
	}
	if(isset($ok))
	{
		$wpre=0;
		for ($h=0;$h<$num;$h++)
			for ($l=0;$l<35;$l++)
				if(isset($M[$h-1][$l]))
				{
					if(($e != "Otra : " or ($e == "Otra : " and $A1 != "")) and (isset($U[0]) or isset($U[1]) or isset($U[2]) or isset($U[3]) or isset($U[4]) or isset($U[5]) or isset($U[6]) or isset($U[7])))
					{
						if($e == "Otra : ")
							$actividad=$A1;
						else
							$actividad=$e;
						$ubicacion="";
						if(isset($U[6]))
							$ubicacion="Todas";
						elseif(isset($U[7]))
									$ubicacion="N/A";
								else
								{
									if(isset($U[0]))
										$ubicacion .="Mesi/";
									if(isset($U[1]))
										$ubicacion .="Oclu/";
									if(isset($U[2]))
										$ubicacion .="Dist/";
									if(isset($U[3]))
										$ubicacion .="Vest/";
									if(isset($U[4]))
										$ubicacion .="Ling/";
									if(isset($U[5]))
										$ubicacion .="Cerv/";
								}
						$fecha = date("Y-m-d");
						$hora = (string)date("H:i:s");
						
						if(isset($PRE) and $wpre == 0)
						{
							$wpre=1;
							$C=" PREEXISTENTE -- ".$C;
						}
						$query = "insert soe_000130 (medico,fecha_data,hora_data, Identificacion, Fecha, Hora, Diente, Actividad, Ubicacion, Comentarios, Odontologo, seguridad) values ('soe','".$fecha."','".$hora."','".$paciente."','".$fecha."','".$hora."','".$E[$h-1][$l]."','".$actividad."','".$ubicacion."','".$C."','".$key."','C-soe')";
						$err2 = mysql_query($query,$conex) or die(mysql_errno().":".mysql_error());
					}
				}
	}
	if(isset($ok))
		unset($R);
	if(!isset($paciente))
	{
		if(isset($numA))
		{
			echo "<center><table border=0 aling=center>";
			echo "<tr><td align=center colspan=2><b>PROMOTORA MEDICA LAS AMERICAS S.A.<b></td></tr>";
			echo "<tr><td align=center colspan=2>ACTUALIZACION DE ODONTOGRAMA X PACIENTE</td></tr>";
			echo "<tr><td id=tipo18A><IMG SRC='/matrix/images/medical/root/feliz.ico'></TD><TD id=tipo18A>PACIENTE ".$dat." EGRESADO !!!!!</td></tr>";
			echo "</table><br><br></center>";
		}
		echo "<center><table border=0>";
		echo "<tr><td align=center colspan=2><b>PROMOTORA MEDICA LAS AMERICAS S.A.<b></td></tr>";
		echo "<tr><td align=center colspan=2>ACTUALIZACION DE ODONTOGRAMA X PACIENTE</td></tr>";
		echo "<tr><td bgcolor=#cccccc align=center>Paciente</td>";
		echo "<td bgcolor=#cccccc align=center><input type='TEXT' name='paciente' size=12 maxlength=12></td></tr>";
		echo "<tr><td bgcolor=#cccccc  colspan=2 align=center><input type='submit' value='ENTER'></td></tr></table>";
	}
	else
	{
		if(isset($add))
		{
			?>
			<script>
				function ira(){document.soe.add.focus();}
			</script>
			<?php
		}
		elseif(isset($addX))
			{
				?>
				<script>
					function ira(){document.soe.addX.focus();}
				</script>
				<?php
			}
			else
			{
				?>
				<script>
					function ira(){document.soe.Data.focus();}
				</script>
				<?php
			}
		if(!isset($wsw1))
		{
			$wsw1=0;
			$query = "select Pactdo, Pacdoc, Pacap1, Pacap2, Pacno1, Pacno2, Pachis, Ingtar, Ingsei, max(Ingnin) from soe_000100,soe_000101 ";
			$query .= " where pacdoc = '".$paciente."'";
			$query .= "   and pachis = inghis ";
			$query .= "   and Pacact = 'on' ";
			$query .= " group by Pactdo, Pacdoc, Pacap1, Pacap2, Pacno1, Pacno2, Pachis, Ingtar, Ingsei ";
			$err = mysql_query($query,$conex);
			$num1 = mysql_num_rows($err);
			if($num1 > 0)
			{
				$row1 = mysql_fetch_array($err);
				$nom=$row1[0]."-".$row1[1]." ".$row1[2]." ".$row1[3]." ".$row1[4]." ".$row1[5];
				$wsw1=1;
				$whis=$row1[6];
				$wtar=$row1[7];
				$wsei=$row1[8];
				$wing=$row1[9];
				$dat=$row1[6]."-".$row1[9];
			}
		}
		if($wsw1 > 0)
		{
			$separador="&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp";
			echo "<table border=0 align=center>";
			echo "<tr><td id=tipo12 align=center valign=middle><IMG SRC='/MATRIX/images/medical/root/clinica.jpg' ></td><td id=tipo12 align=center colspan=49 valign=middle>PROMOTORA MEDICA LAS AMERICAS S.A. - SALUD ORAL ESPECIALIZADA (SOE)</td></tr>";
			echo "<tr><td id=tipo11 colspan=50 >ACTUALIZACION DE ODONTOGRAMA X PACIENTE &nbsp&nbspVer. 2008-06-06</td></tr>";
			echo "<tr><td id=tipo9 colspan=50><b>PACIENTE : ".$nom." / HISTORIA Y NRO INGRESO : ".$dat."</b></td></tr>";
			echo "<tr><td id=tipo10 colspan=50><b>ODONTOGRAMA</td></tr>";
			echo "<tr><td id=tipo9 colspan=50><input type='checkbox' name='clean' onclick='enter()'> Limpiar</td></tr>";
			echo "<tr><td id=tipo9 colspan=50>";
			echo "<input type='checkbox' name='sel1' onclick='enter()'> Adultos 18 - 11 / ";
			echo "<input type='checkbox' name='sel2' onclick='enter()'> Adultos 48 - 41 / ";
			echo "<input type='checkbox' name='sel3' onclick='enter()'> Adultos 21 - 28 / ";
			echo "<input type='checkbox' name='sel4' onclick='enter()'> Adultos 31 - 38  ";
			echo "</td></tr>";
			echo "<tr><td id=tipo9 colspan=50>";
			echo "<input type='checkbox' name='sel5' onclick='enter()'> Menor 55 - 51 / ";
			echo "<input type='checkbox' name='sel6' onclick='enter()'> Menor 85 - 81 / ";
			echo "<input type='checkbox' name='sel7' onclick='enter()'> Menor 61 - 65 / ";
			echo "<input type='checkbox' name='sel8' onclick='enter()'> Menor 71 - 75  ";
			echo "</td></tr>";
			echo "<tr><td id=tipo10 colspan=50>DATOS : <input type='checkbox' name='Data' onclick='enter()'></td></tr>";
			$D=array();
			for ($i=1;$i<=8;$i++)
			{
				$D[$i+10]=false;
				$D[$i+20]=false;
				$D[$i+30]=false;
				$D[$i+40]=false;
				if($i < 6)
				{
					$D[$i+50]=false;
					$D[$i+60]=false;
					$D[$i+70]=false;
					$D[$i+80]=false;
				}
			}
			$S=array();
			for ($i=1;$i<=8;$i++)
			{
				$S[$i+10]=false;
				$S[$i+20]=false;
				$S[$i+30]=false;
				$S[$i+40]=false;
				if($i < 6)
				{
					$S[$i+50]=false;
					$S[$i+60]=false;
					$S[$i+70]=false;
					$S[$i+80]=false;
				}
			}
			$P=array();
			for ($i=1;$i<=8;$i++)
			{
				$P[$i+10][0]=false;
				$P[$i+20][0]=false;
				$P[$i+30][0]=false;
				$P[$i+40][0]=false;
				if($i < 6)
				{
					$P[$i+50][0]=false;
					$P[$i+60][0]=false;
					$P[$i+70][0]=false;
					$P[$i+80][0]=false;
				}
			}
			$query = "select Diente, Fecha, Hora, Actividad, Ubicacion, Comentarios, Odontologo from  soe_000130 ";
	 		$query .= " where identificacion = '".$paciente." '";
	 		$query .= " Order by Diente, Fecha desc, Hora desc";
			$err = mysql_query($query,$conex);
			$num1 = mysql_num_rows($err);
			$k="";
			$p1=-1;
			$ant=-1;
			$kn1=-1;
			$thoot=array();
			$thoot1=array();
			if($num1 > 0)
			{
				for ($i=0;$i<$num1;$i++)
				{
					$row1 = mysql_fetch_array($err);
					if($k != $row1[0])
					{
						if($i != 0)
						{
							$D[$k] = true;
							$P[$k][0] = true;
							$P[$k][1] = $ant + 1;
							$P[$k][2] = $ant + 1 + $kn;
							$ant = $ant + 1 + $kn;
							for ($j=0;$j<=$kn;$j++)
								if(substr($actividad[$kn-$j][3],strlen($actividad[$kn-$j][3])-5,5) == "Pend.")
									if(!array_s($actividad[$kn-$j][3],$actividad,$kn-$j,$actividad[$kn-$j][4]))
									{
										$S[$k] = true;
										$p1 = $p1 + 1;
										$thoot[$p1][0] = $actividad[$kn-$j][0];
										$thoot[$p1][1] = $actividad[$kn-$j][1];
										$thoot[$p1][2] = $actividad[$kn-$j][2];
										$thoot[$p1][3] = $actividad[$kn-$j][3];
									}
						}
						$actividad=array();
						$kn=-1;
						$k=$row1[0];
					}
					$kn +=1;
					$actividad[$kn][0]=$row1[0];
					$actividad[$kn][1]=$row1[1];
					$actividad[$kn][2]=$row1[2];
					$actividad[$kn][3]=$row1[3];
					$actividad[$kn][4]=$row1[4];
					$actividad[$kn][5]=$row1[5];
					$actividad[$kn][6]=$row1[6];
					$actividad[$kn][7]=0;
					$kn1 = $kn1 + 1;
					$thoot1[$kn1][0]=$row1[0];
					$thoot1[$kn1][1]=$row1[1];
					$thoot1[$kn1][2]=$row1[2];
					$thoot1[$kn1][3]=$row1[3];
					$thoot1[$kn1][4]=$row1[4];
					$thoot1[$kn1][5]=$row1[5];
					$thoot1[$kn1][6]=$row1[6];
				}
				$D[$k] = true;
				$P[$k][0] = true;
				$P[$k][1] = $ant + 1;
				$P[$k][2] = $ant + 1 + $kn;
				for ($j=0;$j<=$kn;$j++)
					if(substr($actividad[$j][3],strlen($actividad[$j][3])-5,5) ==  "Pend.")
						if(!array_s($actividad[$j][3],$actividad,$kn-$j,$actividad[$j][4]))
						{
							$S[$k] = true;
							$p1 = $p1 + 1;
							$thoot[$p1][0] = $actividad[$kn-$j][0];
							$thoot[$p1][1] = $actividad[$kn-$j][1];
							$thoot[$p1][2] = $actividad[$kn-$j][2];
							$thoot[$p1][3] = $actividad[$kn-$j][3];
						}
			}
			$row=array();
			$row[0]="----------------------------------------------------------------------";
			$row[1]="..18..17..16..15..14..13..12..11..||..21..22..23..24..25..26..27..28..";
			$row[2]="..<>..<>..<>..<>..<>..<>..<>..<>..||..<>..<>..<>..<>..<>..<>..<>..<>..";
			$row[3]="..................................||..................................";
			$row[4]="..............55..54..53..52..51..||..61..62..63..64..65..............";
			$row[5]="..............<>..<>..<>..<>..<>..||..<>..<>..<>..<>..<>..............";
			$row[6]="----------------------------------------------------------------------";
			$row[7]="..............85..84..83..82..81..||..71..72..73..74..75..............";
			$row[8]="..............<>..<>..<>..<>..<>..||..<>..<>..<>..<>..<>..............";
			$row[9]="..................................||..................................";
			$row[10]="..48..47..46..45..44..43..42..41..||..31..32..33..34..35..36..37..38..";
			$row[11]="..<>..<>..<>..<>..<>..<>..<>..<>..||..<>..<>..<>..<>..<>..<>..<>..<>..";
			$row[12]="----------------------------------------------------------------------";
			$num=13;
			$E=array();
			$wsw2=0;
			echo "<table border=0 align=center id=tipoG00>";
			for ($i=0;$i<$num;$i++)
			{
				for ($j=0;$j<35;$j++)
				{
					$E[$i][$j]=substr($row[$i],0,2);
					$row[$i] = substr($row[$i],2);
					switch ($E[$i][$j])
					{
						case "..":
							echo "<td id=tipoG01>&nbsp &nbsp </td>";
						break;
						case "<>":
							$w=$i-1;
							$SI=0;
							if(isset($sel1) and $E[$i-1][$j] >= 11 and $E[$i-1][$j] <= 18)
								$SI=1;
							elseif(isset($sel2) and $E[$i-1][$j] >= 41 and $E[$i-1][$j] <= 48)
									$SI=1;
								elseif(isset($sel3) and $E[$i-1][$j] >= 21 and $E[$i-1][$j] <= 28)
										$SI=1;
									elseif(isset($sel4) and $E[$i-1][$j] >= 31 and $E[$i-1][$j] <= 38)
											$SI=1;
										elseif(isset($sel5) and $E[$i-1][$j] >= 51 and $E[$i-1][$j] <= 55)
												$SI=1;
											elseif(isset($sel6) and $E[$i-1][$j] >= 81 and $E[$i-1][$j] <= 85)
													$SI=1;
												elseif(isset($sel7) and $E[$i-1][$j] >= 61 and $E[$i-1][$j] <= 65)
														$SI=1;
													elseif(isset($sel8) and $E[$i-1][$j] >= 71 and $E[$i-1][$j] <= 75)
															$SI=1;
							if($D[$E[$i-1][$j]])
							{
								if($S[$E[$i-1][$j]])
									$color="tipoG02";
								else
									$color="tipoG03";
								if((isset($M[$w][$j]) or $SI == 1) and !isset($clean))
								{
									$wsw2=1;
									echo "<td id=".$color."><input type='checkbox' name='M[".$w."][".$j."]' checked></td>";
								}
								else
									echo "<td id=".$color."><input type='checkbox' name='M[".$w."][".$j."]'></td>";
							}
							else
								if((isset($M[$w][$j]) or $SI == 1)and !isset($clean))
								{
									$wsw2=1;
									echo "<td id=tipoG04><input type='checkbox' name='M[".$w."][".$j."]' checked></td>";
								}
								else
									echo "<td id=tipoG04><input type='checkbox' name='M[".$w."][".$j."]'></td>";
						break;
						case "||":
							echo "<td id=tipoG01><b>|</b></td>";
						break;
						case "--":
							echo "<td id=tipoG01><b>--</b></td>";
						break;
						default:
							if(is_numeric($E[$i][$j]))
								echo "<td id=tipoG01><b>".$E[$i][$j]."</b></td>";
							else
							{
								echo "<td id=tipoG04>&nbsp &nbsp </td>";
								$wsw=1;
							}
						break;
					}
				}
				echo "</tr>";
			}
			echo "</table>";
			echo "<input type='HIDDEN' name= 'wsw1' value='".$wsw1."'>";
			echo "<input type='HIDDEN' name= 'num' value='".$num."'>";
			echo "<input type='HIDDEN' name= 'nom' value='".$nom."'>";
			echo "<input type='HIDDEN' name= 'paciente' value='".$paciente."'>";
			echo "<input type='HIDDEN' name= 'whis' value='".$whis."'>";
			echo "<input type='HIDDEN' name= 'wtar' value='".$wtar."'>";
			echo "<input type='HIDDEN' name= 'wing' value='".$wing."'>";
			echo "<input type='HIDDEN' name= 'wsei' value='".$wsei."'>";
			echo "<input type='HIDDEN' name= 'dat' value='".$dat."'>";
			
			for ($i=0;$i<$num;$i++)
				for ($j=0;$j<35;$j++)
					echo "<input type='HIDDEN' name= 'E[".$i."][".$j."]' value='".$E[$i][$j]."'>";
			$e=array();
			$e[1]="Caries ";
			$e[2]="Resina Real. ";
			$e[3]="Resina Pend. ";
			$e[4]="Amalgama Real. ";
			$e[5]="Amalgama Pend. ";
			$e[6]="Corona Real. ";
			$e[7]="Corona Pend. ";
			$e[8]="Sellante ";
			$e[9]="Endodoncia Real. ";
			$e[10]="Endodoncia Pend. ";
			$e[11]="Nucleo Real. ";
			$e[12]="Nucleo Pend. ";
			$e[13]="Provisional Real. ";
			$e[14]="Provisional Pend. ";
			$e[15]="Diente Ausente ";
			$e[16]="Exodoncia Real. ";
			$e[17]="Exodoncia Pend. ";
			$e[18]="Otra : ";
			if($wsw2 == 1)
			{
				echo "<table border=0 align=center id=tipo1>";
				$piezas="";
				for ($h=0;$h<$num;$h++)
					for ($l=0;$l<35;$l++)
						if(isset($M[$h-1][$l]))
						{
							if($piezas == "")
								$piezas .= $E[$h-1][$l];
							else
								$piezas .= "-".$E[$h-1][$l];
						}
						echo "<tr><td id=tipo10 colspan=7 align=center>PIEZA(s) DENTAL(es) : ".$piezas."</td></tr>";
						echo "<tr><td id=tipo13 colspan=2 align=center>ACTIVIDAD</font></td><td id=tipo13 colspan=3 align=center>SUPERFICIES</td><td id=tipo13 colspan=1 align=center>COMENTARIOS</td><td id=tipo13 colspan=1 align=center>PREEXISTENTE</td></tr>";
						echo "<tr><td id=tipo9 colspan=2>";
						echo "<select name='e'>";
						for ($i=1;$i<19;$i++)
						{
							echo "<option>".$e[$i]."</option>";
						}
						echo "</select>";
						echo "&nbsp<input type='TEXT' name='A1' size=20 maxlength=60><td bgcolor=#dddddd colspan=3>";
						$j=0;
						echo "<input type='checkbox' name='U[".$j."]''>Mesi ";
						$j=1;
						echo "<input type='checkbox' name='U[".$j."]''>Oclu ";
						$j=2;
						echo "<input type='checkbox' name='U[".$j."]''>Dist ";
						$j=3;
						echo "<input type='checkbox' name='U[".$j."]''>Vest ";
						$j=4;
						echo "<input type='checkbox' name='U[".$j."]''>Ling ";
						$j=5;
						echo "<input type='checkbox' name='U[".$j."]''>Cervi ";
						$j=6;
						echo "<input type='checkbox' name='U[".$j."]''>Todas ";
						$j=7;
						echo "<input type='checkbox' name='U[".$j."]''>N/A</td>";
						echo "<td id=tipo9 colspan=1><textarea name='C' cols=30 rows=2>.</textarea></td>";
						echo "<td id=tipo9 colspan=1 align=center><input type='checkbox' name='PRE'></td></tr>";
						echo "<tr><td id=tipo10 colspan=7 align=center>DATOS OK!! <input type='checkbox' name='ok' onclick='enter()'></td></tr>";
						echo "<tr><td id=tipo13 align=center>Fecha</td><td id=tipo13 align=center>Hora</td><td id=tipo13 align=center>Pieza<br>Dental</td><td id=tipo13 align=center>Actividad</td><td id=tipo13 align=center>Superficies</td><td id=tipo13 align=center>Comentarios</td><td id=tipo13 align=center>Odontologo</td></tr>";
						for ($h=0;$h<$num;$h++)
							for ($l=0;$l<35;$l++)
								if(isset($M[$h-1][$l]))
								{
									$num1=0;
									if($P[$E[$h-1][$l]][0])
									{
										$num1=1;
										for ($i=$P[$E[$h-1][$l]][1];$i<=$P[$E[$h-1][$l]][2];$i++)
										{
											echo "<tr><td id=tipo9 align=center>".$thoot1[$i][1]."</td><td id=tipo9 align=center>".$thoot1[$i][2]."</td><td id=tipo9 align=center>".$thoot1[$i][0]."</td>";
											if(strpos($thoot1[$i][3],"Pend.") === false)
												echo "<td id=tipo9>".$thoot1[$i][3]."</td>";
											else
											{
												if(buscar($thoot,$E[$h-1][$l],$thoot1[$i][1],$thoot1[$i][2],$thoot1[$i][3],$p1))
													$color="tipo14";
												else
													$color="tipo15";
												echo "<td id=".$color.">".$thoot1[$i][3]."</td>";
											}
											echo "<td id=tipo9>".$thoot1[$i][4]."</td><td id=tipo9><b>".$thoot1[$i][5]."</td><td id=tipo9>".$thoot1[$i][6]."</td></tr>";
										}
									}
									if($num1 > 0)
										echo "<tr><td id=tipo10 colspan=7 align=center>&nbsp</td></tr>";
								}
						echo"</table><br><br>";
			}
			echo"<center>";
			echo "<a href='/matrix/soe/reportes/actividades.php?paciente=".$paciente."' target='_blank' id=tipo1>. Informe General de Actividades</a><br><br>";
			echo"</center>";
			
			echo "<table border=0 align=center id=tipo1>";
			echo "<tr><td id=tipo10 colspan=6 align=center>ACTIVIDADES GENERALES</td></tr>";
			echo "<tr><td id=tipo13 colspan=2 align=center>Actividad</td><td id=tipo13 colspan=4 align=center>Comentarios</td></tr>";
			echo "<tr><td id=tipo9 colspan=2><input type='TEXT' name='actividad' size=30 maxlength=60></td><td id=tipo9 colspan=4><textarea name='W' cols=60 rows=5>.</textarea></td></tr>";
			echo "<tr><td id=tipo10 colspan=6 align=center>DATOS OK!! <input type='checkbox' name='ok1' onclick='enter()'></td></tr>";
			echo "<tr><td id=tipo13 align=center>Fecha</td><td id=tipo13 align=center>Hora</td><td id=tipo13 align=center>Actividad</td><td id=tipo13 align=center>Superficies</td><td id=tipo13 align=center>Comentarios</td><td id=tipo13 align=center>Odontologo</td></tr>";
			$query = "select Fecha, Hora, Actividad, Ubicacion, Comentarios, Odontologo from  soe_000130 ";
	 		$query .= " where identificacion = '".$paciente." '";
	 		$query .= "      and Diente = 99";
	 		$query .= " Order by Fecha desc, Hora desc";
			$err = mysql_query($query,$conex);
			$num1 = mysql_num_rows($err);
			if($num1 > 0)
			{
				for ($i=0;$i<$num1;$i++)
				{
					$row1 = mysql_fetch_array($err);
					echo "<tr><td id=tipo9 align=center>".$row1[0]."</td><td id=tipo9 align=center>".$row1[1]."</td><td id=tipo9>".$row1[2]."</td><td id=tipo9>".$row1[3]."</td><td id=tipo9>".$row1[4]."</td><td id=tipo9>".$row1[5]."</td></tr>";
				}
			}
			echo"</table><br><br>";
			
			//****************** PROCESO DE FACTURACION ***********************
			$query = "select Grucod, Grudes from soe_000004 ";
			$query .= " where gruabo = 'off' ";
			$query .= " order by grudes ";
			$err = mysql_query($query,$conex);
			$num1 = mysql_num_rows($err);
			
			if(!isset($se))
			{
				$se=0;
				$wdata=array();
			}
			else
			{
				$werr=array();
				$t=-1;
				for ($i=1;$i<=$se;$i++)
				{
					$query = "lock table soe_000100 LOW_PRIORITY WRITE, soe_000101 LOW_PRIORITY WRITE, soe_000106 LOW_PRIORITY WRITE, soe_000131 LOW_PRIORITY WRITE  ";
					$err1 = mysql_query($query,$conex) or die("ERROR BLOQUEANDO TABLAS : ".mysql_errno().":".mysql_error());
					if(!isset($wfac[$i]))
					{
						if($wdata[$i][4] == 0)
						{
							$query = "delete from soe_000131 ";
							$query .= " where Ptohis = '".$whis."' ";
							$query .= "   and Ptoing = '".$wing."' ";
							$query .= "   and Ptopro = '".$wdata[$i][2]."' ";
							$query .= "   and Ptofac = 'off' ";
							$query .= "   and Ptocon = 0 ";
							$err1 = mysql_query($query,$conex) or die("ERROR BORRANDO PRESUPUESTO : ".mysql_errno().":".mysql_error());
							$t=$t+1;
							$werr[$t]="OK! PROCEDIMIENTO BORRADO DE PRESUPUESTOS!!!";
						}
						else
						{
							$query = "update soe_000131 set Ptocan=".$wdata[$i][4];
							$query .= " where Ptohis = '".$whis."' ";
							$query .= "   and Ptoing = '".$wing."' ";
							$query .= "   and Ptopro = '".$wdata[$i][2]."' ";
							$query .= "   and Ptofac = 'off' ";
							$query .= "   and Ptocon = 0 ";
							$err1 = mysql_query($query,$conex) or die("ERROR ACTUALIZANDO PRESUPUESTO : ".mysql_errno().":".mysql_error());
						}
					}
					else
					{
						$query = "select Ptocpt, Ptoncp, Ptopro, Ptonpr, Ptocan, Ptoval from soe_000131 ";
						$query .= " where Ptohis = '".$whis."' ";
						$query .= "   and Ptoing = '".$wing."' ";
						$query .= "   and Ptopro = '".$wdata[$i][2]."' ";
						$query .= "   and Ptofac = 'on' ";
						$err1 = mysql_query($query,$conex);
						$num2 = mysql_num_rows($err1);
						$wcant=$num2+1;
						$query = "update soe_000131 set Ptocan=".$wdata[$i][4].", Ptofac='on', Ptocon=".$wcant;
						$query .= " where Ptohis = '".$whis."' ";
						$query .= "   and Ptoing = '".$wing."' ";
						$query .= "   and Ptopro = '".$wdata[$i][2]."' ";
						$query .= "   and Ptofac = 'off' ";
						$query .= "   and Ptocon = 0 ";
						$err1 = mysql_query($query,$conex) or die("ERROR ACTUALIZANDO PRESUPUESTO FACTURADO : ".mysql_errno().":".mysql_error());
						//GRABAR EN LA TABLA DE CARGOS 
						$query = "select Pacdoc, Pacap1, Pacap2, Pacno1, Pacno2, Pachis, Ingsei, Ingcem, Ingent, max(Ingnin) from soe_000100,soe_000101 ";
						$query .= " where pacdoc = '".$paciente."'";
						$query .= "   and pachis = inghis ";
						$query .= " group by Pacdoc, Pacap1, Pacap2, Pacno1, Pacno2, Pachis, Ingsei, Ingcem, Ingent ";
						$err1 = mysql_query($query,$conex);
						$num2 = mysql_num_rows($err1);
						if($num2 > 0)
						{
							$row1 = mysql_fetch_array($err1);																  
							$fecha = date("Y-m-d");
							$hora = (string)date("H:i:s");
					      	$query = " insert into soe_000106 (Medico, Fecha_data, Hora_data, Tcarusu, Tcarhis, Tcaring, Tcarfec, Tcarsin, Tcarres, Tcarno1, Tcarno2, Tcarap1, Tcarap2, Tcardoc, Tcarser, Tcarconcod, Tcarconnom, Tcarprocod, Tcarpronom, Tcartercod, Tcarternom, Tcarterpor, Tcarcan, Tcarvun, Tcarvto, Tcarrec, Tcarfac, Tcartfa, Tcarest, Tcarnmo, Tcarcmo, Tcarfex, Tcarfre, Seguridad) ";
					        $query .= "   VALUES ('soe','".$fecha."' ,'".$hora."' ,'".$key."','".$whis."' ,'".$wing."' ,'".$fecha."','".$row1[6]."','".$row1[7]."-".$row1[8]."','".$row1[3]."','".$row1[4]."' ,'".$row1[1]."','".$row1[2]."','".$row1[0]."','".$row1[6]."','".$wdata[$i][0]."','".$wdata[$i][1]."','".$wdata[$i][2]."','".$wdata[$i][3]."','".$wdata[$i][6]."','".$wdata[$i][7]."','".$wdata[$i][8]."','".$wdata[$i][4]."','".$wdata[$i][5]."','".round($wdata[$i][4]*$wdata[$i][5])."','R','S','CODIGO','on','0','0',0,0,'C-soe')";
					      	$err1 = mysql_query($query,$conex) or die ("ERROR INSERTANDO CARGOS DE FACTURACION: ".mysql_errno()." - ".mysql_error());
				      	}
				      	else
				      	{
					      	$t=$t+1;
							$werr[$t]="ERRORES EN DATOS DE PACIENTES E INGRESO!!!";
				      	}
				      	
						$t=$t+1;
						$werr[$t]="OK! PROCEDIMIENTO CARGADO EN FACTURACION!!!";
		      		}
		      		$query = " UNLOCK TABLES";
					$err1 = mysql_query($query,$conex) or die("ERROR DESBLOQUEANDO TABLAS : ".mysql_errno().":".mysql_error());
				}
				if(isset($wsec) and $wsec != "SELECCIONAR" and isset($wpro) and $wpro != "SELECCIONAR" and isset($wcan) and $wcan > 0)
				{
					$query = "select Tarvac from soe_000104 ";
					$query .= " where Tartar = '".$wtar."' ";
					$query .= "   and mid(Tarcod,1,instr(Tarcod,'-') - 1) = '".substr($wpro,0,strpos($wpro,"-"))."' ";
					$query .= "   and Tarcon = '".substr($wsec,0,strpos($wsec,"-"))."' ";
					$err1 = mysql_query($query,$conex);
					$num2 = mysql_num_rows($err);
					if($num2 > 0)
					{
						$row1 = mysql_fetch_array($err1);
						$wvalor=$row1[0];
					}
					else
						$wvalor=0;
					$query = "select Ptohis from soe_000131 ";
					$query .= " where Ptohis = '".$whis."' ";
					$query .= "   and Ptoing = '".$wing."' ";
					$query .= "   and Ptopro = '".substr($wpro,0,strpos($wpro,"-"))."' ";
					$query .= "   and Ptofac = 'off' ";
					$query .= "   and Ptocon = 0 ";
					$err1 = mysql_query($query,$conex);
					$num2 = mysql_num_rows($err1);
					if($num2 == 0)
					{
						if($wvalor > 0)
						{
							$fecha = date("Y-m-d");
							$hora = (string)date("H:i:s");
							$query = "insert soe_000131 (medico,fecha_data,hora_data, Ptohis, Ptoing, Ptocpt, Ptoncp, Ptopro, Ptonpr, Ptocan, Ptoval, Ptofac, Ptocon, seguridad) values ('soe','".$fecha."','".$hora."','".$whis."','".$wing."','".substr($wsec,0,strpos($wsec,"-"))."','".substr($wsec,strpos($wsec,"-")+1)."','".substr($wpro,0,strpos($wpro,"-"))."','".substr($wpro,strpos($wpro,"-")+1)."',".$wcan.",".$wvalor.",'off',0,'C-soe')";
							$err2 = mysql_query($query,$conex) or die(mysql_errno().":".mysql_error());
							$t=$t+1;
							$werr[$t]="OK! PROCEDIMIENTO PRESUPUESTADO!!!";
						}
						else
						{
							$t=$t+1;
							$werr[$t]="ERROR! PROCEDIMIENTO NO PRESUPUESTADO TARIFA EN CERO O NO EXISTE REVISE!!!";
						}
					}
					else
					{
						$t=$t+1;
						$werr[$t]="ESTE PROCEDIMIENTO YA SE PRESUPUESTO, MODIFIQUE LA CANTIDAD";
					}
				}
			}
			if($num1 > 0)
			{
				echo "<table border=0 align=center id=tipo1>";
				echo "<tr><td id=tipo10 colspan=5 align=center>PROCESO DE CARGOS A PRESUPUESTO </td></tr>";
				echo "<tr><td id=tipo13 align=center>SECCION</td><td id=tipo13 align=center>PROCEDIMIENTO</td><td id=tipo13 align=center>CANTIDAD</td></tr>";
				echo "<td id=tipo9 align=center>";
				echo "<select name='wsec' onchange='enter()'>";
				echo "<option>SELECCIONAR</option>";
				for ($i=0;$i<$num1;$i++)
				{
					$row = mysql_fetch_array($err);
					if(isset($wsec) and $wsec != "SELECCIONAR" and $wsec == $row[0]."-".$row[1])
						echo "<option selected>".$row[0]."-".$row[1]."</option>";
					else
						echo "<option>".$row[0]."-".$row[1]."</option>";
				}
				echo "</select></td>";
				$wval=0;
				echo "<td id=tipo9 align=center>";
				if(isset($wsec) and $wsec != "SELECCIONAR")
				{
					$query = "select Tarcod, Tarvac from soe_000104 ";
					$query .= " where Tartar = '".$wtar."' ";
					$query .= "   and Tarcon = '".substr($wsec,0,strpos($wsec,"-"))."' ";
					$query .= " order by mid(Tarcod,locate('-',Tarcod)+1) ";
					$err = mysql_query($query,$conex);
					$num = mysql_num_rows($err);
					if($num > 0)
					{
						echo "<select name='wpro'>";
						echo "<option>SELECCIONAR</option>";
						for ($i=0;$i<$num;$i++)
						{
							$row = mysql_fetch_array($err);
							echo "<option>".substr($row[0],0,80)."</option>";
						}
					}
					echo "</select></td>";
				}
				else
					echo "</td>";
				
				if(isset($wsec) and $wsec != "SELECCIONAR")
					echo "<td id=tipo9 align=center><input type='TEXT' name='wcan' size=5 maxlength=5 onblur='enter()'></td></tr>";
				else
					echo "<td id=tipo9 align=center colspan=2></td></tr>";
				if(isset($add))
					echo "<tr><td id=tipo10 colspan=5 align=center>CARGOS<input type='checkbox' name='add' checked></td></tr>";
				else
					echo "<tr><td id=tipo10 colspan=5 align=center>CARGOS<input type='checkbox' name='add'></td></tr>";
				echo "</table><br><br>";
			}
			$soedoc="";
			$soenom="ODONTOLOGO NO ESTA EN LA TABLA 51";
			$soepor=0;
			$query = "select Meddoc, Mednom, Medpor  from soe_000051 ";
			$query .= " where Medusu = '".$key."' ";
			$err3 = mysql_query($query,$conex);
			$num3 = mysql_num_rows($err3);
			if($num3 > 0)
			{
				$row3 = mysql_fetch_array($err3);
				$soedoc = $row3[0];
				$soenom = $row3[1];
				$soepor = $row3[2];
			}
			else
			{
				$soedoc1 = "";
				$soenom1 = "";
				$soepor1 = 0;
			}
			//                  0       1       2       3       4      5       6
			$query = "select Ptocpt, Ptoncp, Ptopro, Ptonpr, Ptocan, Ptoval, Grutip from soe_000131, soe_000004 ";
			$query .= " where Ptohis = '".$whis."' ";
			$query .= "   and Ptoing = '".$wing."' ";
			$query .= "   and Ptofac = 'off' ";
			$query .= "   and Ptocon = 0 ";
			$query .= "   and Ptocpt = Grucod ";
			$err1 = mysql_query($query,$conex);
			$num2 = mysql_num_rows($err1);
			if($num2 > 0)
			{
				$se=0;
				$wdata=array();
				$wsuma=0;
				echo "<table border=0 align=center id=tipo1>";
				echo "<tr><td id=tipo10 colspan=9 align=center>PROCESO DE PRESUPUESTACION - FACTURACION </td></tr>";
				echo "<tr><td id=tipo13 align=center>CODIGO</td><td id=tipo13 align=center>SECCION</td><td id=tipo13 align=center>PROCEDIMIENTO</td><td id=tipo13 align=center>DESCRIPCION</td><td id=tipo13 align=center>CANTIDAD</td><td id=tipo13 align=center>VLR. UNITARIO</td><td id=tipo13 align=center>VLR TOTAL</td><td id=tipo13 align=center>TERCERO</td><td id=tipo13 align=center>FACTURAR</td></tr>";
				for ($i=0;$i<$num2;$i++)
				{
					$row2 = mysql_fetch_array($err1);
					$se=$i+1;
					$wdata[$se][0]=$row2[0];
					$wdata[$se][1]=$row2[1];
					$wdata[$se][2]=$row2[2];
					$wdata[$se][3]=$row2[3];
					$wdata[$se][4]=$row2[4];
					$wdata[$se][5]=$row2[5];
					if($row2[6] == "C")
					{
						$wdata[$se][6]=$soedoc;
						$wdata[$se][7]=$soenom;
						$wdata[$se][8]=$soepor;
						$wsoeter = $soenom;
					}
					else
					{
						$wdata[$se][6]=$soedoc1;
						$wdata[$se][7]=$soenom1;
						$wdata[$se][8]=$soepor1;
						$wsoeter = $soenom1;
					}
					if($i % 2 != 0)
						$color="tipo17";
					else
						$color="tipo16";
					$wtotal=$wdata[$se][4] * $wdata[$se][5];
					$wsuma += $wtotal;
					echo "<tr><td id=".$color."A>".$wdata[$se][0]."</td><td id=".$color."B>".$wdata[$se][1]."</td><td id=".$color."A>".$wdata[$se][2]."</td><td id=".$color."B>".$wdata[$se][3]."</td><td id=".$color."A><input type='TEXT' name='wdata[".$se."][4]' value=".$wdata[$se][4]." size=5 maxlength=5 onblur='enter()'></td><td id=".$color."C>".number_format((double)$wdata[$se][5],0,'.',',')."</td><td id=".$color."C>".number_format((double)$wtotal,0,'.',',')."</td><td id=".$color."B>".$wsoeter."</td><td id=".$color."A><input type='checkbox' name='wfac[".$se."]'></td></tr>";
					echo "<input type='HIDDEN' name= 'wdata[".$se."][0]' value='".$wdata[$se][0]."'>";
					echo "<input type='HIDDEN' name= 'wdata[".$se."][1]' value='".$wdata[$se][1]."'>";
					echo "<input type='HIDDEN' name= 'wdata[".$se."][2]' value='".$wdata[$se][2]."'>";
					echo "<input type='HIDDEN' name= 'wdata[".$se."][3]' value='".$wdata[$se][3]."'>";
					//echo "<input type='HIDDEN' name= 'data[".$i."][4]' value='".$data[$i][4]."'>";
					echo "<input type='HIDDEN' name= 'wdata[".$se."][5]' value='".$wdata[$se][5]."'>";
					echo "<input type='HIDDEN' name= 'wdata[".$se."][6]' value='".$wdata[$se][6]."'>";
					echo "<input type='HIDDEN' name= 'wdata[".$se."][7]' value='".$wdata[$se][7]."'>";
					echo "<input type='HIDDEN' name= 'wdata[".$se."][8]' value='".$wdata[$se][8]."'>";
				}
				echo "<tr><td id=tipo10A colspan=6>TOTAL A PRESUPUESTADO<td id=tipo10B>".number_format((double)$wsuma,0,'.',',')."</td><td id=tipo10B colspan=2></td></tr>";
				echo "<tr><td id=tipo10 colspan=9>GRABAR EN CARGOS FACTURAR<input type='checkbox' name='wfacT' OnClick='enter()'></td></tr>";
				echo "</table><br><br>";
			}
			$se=$num2;
			echo "<input type='HIDDEN' name= 'se' value='".$se."'>";
			if(isset($werr) and isset($t) and $t > -1)
			{
				echo "<br><br><center><table border=0 aling=center>";
				for ($i=0;$i<=$t;$i++)
					if(substr($werr[$i],0,3) == "OK!")
					{
						echo "<tr><td id=tipo18A><IMG SRC='/matrix/images/medical/root/feliz.ico'></TD><TD id=tipo18A>".$werr[$i]."</td></tr>";
					}
					else
						echo "<tr><td id=tipo18B><IMG SRC='/matrix/images/medical/root/Malo.ico'></TD><TD id=tipo18B>".$werr[$i]."</td></tr>";
				echo "</table><br><br></center>";
			}/// CIERRE DE CICLO DE PROCESO DE FACTURACION
			
			//****************** MOTIVO DE CONSULTA Y DIAGNOSTICOS ***********************
			if(!isset($se1))
			{
				$se1=0;
				$wdata1=array();
			}
			else
			{
				$werr=array();
				$t=-1;
				$query = "lock table soe_000132 LOW_PRIORITY WRITE  ";
				$err1 = mysql_query($query,$conex) or die("ERROR BLOQUEANDO TABLAS : ".mysql_errno().":".mysql_error());
				if(!isset($wegrT))
				{
					for ($i=1;$i<=$se1;$i++)
					{
						if(isset($wdel[$i]))
						{
							$query = "delete from soe_000132 ";
							$query .= " where Mdxhis = '".$whis."' ";
							$query .= "   and Mdxing = '".$wing."' ";
							$query .= "   and Mdxcon = '".$wdata1[$i][0]."' ";
							$query .= "   and Mdxpro = '".$wdata1[$i][1]."' ";
							$err1 = mysql_query($query,$conex) or die("ERROR BORRANDO MOTIVO / DIAGNOSTICO / PLAN DE PAGO : ".mysql_errno().":".mysql_error());
							$t=$t+1;
							$werr[$t]="OK! MOTIVO / DIAGNOSTICO BORRADO !!!";
						}
						else
						{
							$query = "update soe_000132 set Mdxobs='".$wdata1[$i][3]."' ";
							$query .= " where Mdxhis = '".$whis."' ";
							$query .= "   and Mdxing = '".$wing."' ";
							$query .= "   and Mdxcon = '".$wdata1[$i][0]."' ";
							$query .= "   and Mdxpro = '".$wdata1[$i][1]."' ";
							$err1 = mysql_query($query,$conex) or die("ERROR ACTUALIZANDO MOTIVO / DIAGNOSTICO / PLAN DE PAGO  : ".mysql_errno().":".mysql_error());
						}
					} 
				}
	      		$query = " UNLOCK TABLES";
				$err1 = mysql_query($query,$conex) or die("ERROR DESBLOQUEANDO TABLAS : ".mysql_errno().":".mysql_error());
				
				if(isset($class1) and (substr($class1,0,1) == "M" or substr($class1,0,1) == "D" or substr($class1,0,1) == "P") and isset($wpro) and $wpro != "SELECCIONAR" and isset($wobs) and $wobs != "")
				{
					$query = "select Mdxcon, Mdxpro, Mdxdes, Mdxobs from soe_000132 ";
					$query .= " where Mdxhis = '".$whis."' ";
					$query .= "   and Mdxing = '".$wing."' ";
					if(substr($class1,0,1) == "M")
					{
						$wclass="01";
						$query .= "   and Mdxcon = '01' ";
					}
					
					elseif(substr($class1,0,1) == "P")
						{
							$wclass="03";
							$query .= "   and Mdxcon = '01' ";
						}
						else
						{
							$wclass="02";
							$query .= "   and Mdxcon = '02' ";
						}
					$query .= "   and Mdxpro = '".substr($wpro,0,strpos($wpro,"-"))."' ";
					$err1 = mysql_query($query,$conex);
					$num2 = mysql_num_rows($err1);
					if($num2 == 0)
					{
						$fecha = date("Y-m-d");
						$hora = (string)date("H:i:s");
						$query = "insert soe_000132 (medico,fecha_data,hora_data, Mdxhis, Mdxing, Mdxcon, Mdxpro, Mdxdes, Mdxobs, seguridad) values ('soe','".$fecha."','".$hora."','".$whis."','".$wing."','".$wclass."','".substr($wpro,0,strpos($wpro,"-"))."','".substr($wpro,strpos($wpro,"-")+1)."','".$wobs."','C-soe')";
						$err2 = mysql_query($query,$conex) or die(mysql_errno().":".mysql_error());
						$t=$t+1;
						$werr[$t]="OK! MOTIVO O DIAGNOSTICO O PLAN DE PAGO GRABADO!!!";
					}
					else
					{
						$t=$t+1;
						$werr[$t]="ESTE MOTIVO O DIAGNOSTICO O PLAN DE PAGO YA SE GRABADO!!!!";
					}
				}
			}
			
			//TABLA DE MOTIVO DE CONSULTA Y DIAGNOSTICOS
			$clases=array();
			$clases[0]="SELECCIONAR";
			$clases[1]="MOTIVO CONSULTA";
			$clases[2]="DIAGNOSTICO";
			$clases[3]="PLAN DE PAGO";
			echo "<table border=0 align=center id=tipo1>";
			echo "<tr><td id=tipo10 colspan=3 align=center>MOTIVO DE CONSULTA - PLAN DE PAGO Y DIAGNOSTICOS</td></tr>";
			echo "<tr><td id=tipo13 align=center>CLASE</td><td id=tipo13 align=center>DIAGNOSTICO / MOTIVO CONSULTA <BR> PLAN DE PAGO</td><td id=tipo13 align=center>OBSERVACION</td></tr>";
			echo "<td id=tipo9 align=center>";
			echo "<select name='class1'>";
			for ($i=0;$i<4;$i++)
			{
				$row = mysql_fetch_array($err);
				if(isset($class1) and $class1 == $clases[$i])
					echo "<option selected>".$clases[$i]."</option>";
				else
					echo "<option>".$clases[$i]."</option>";
			}
			echo "</select><br>";
			if(isset($wsel))
				echo "<input type='TEXT' name='wsel' size=20 maxlength=40 value='".$wsel."' onblur='enter()'></td>";
			else
				echo "<input type='TEXT' name='wsel' size=20 maxlength=40 onblur='enter()'></td>";
			$wval=0;
			echo "<td id=tipo9 align=center>";
			if(isset($class1) and (substr($class1,0,1) == "M" or substr($class1,0,1) == "D" or substr($class1,0,1) == "P"))
			{
				if(substr($class1,0,1) == "M")
				{
					$query = "select Codigo, Descripcion  from root_000011 ";
					$query .= " where Codigo = 'MC01' ";
				}
				elseif(substr($class1,0,1) == "P")
					{
						$query = "select Codigo, Descripcion  from root_000011 ";
						$query .= " where Codigo = 'PAGO' ";
					}
					else
					{
						$query = "select Codigo, Descripcion  from root_000011 ";
						$query .= " where Descripcion LIKE  '%".$wsel."%' ";
						$query .= " order by Descripcion ";
					}
				$err = mysql_query($query,$conex);
				$num = mysql_num_rows($err);
				if($num > 0)
				{
					echo "<select name='wpro'  OnChange='enter()'>";
					echo "<option>SELECCIONAR</option>";
					for ($i=0;$i<$num;$i++)
					{
						$row = mysql_fetch_array($err);
						if(isset($wpro) and substr($wpro,0,strpos($wpro,"-")) == $row[0])
							echo "<option selected>".$row[0]."-".$row[1]."</option>";
						else
							echo "<option>".$row[0]."-".$row[1]."</option>";
					}
					echo "</select>";
				}
				echo "</td>";
			}
			else
				echo "</td>";
			if(isset($wpro) and $wpro != "SELECCIONAR")
				echo "<td id=tipo9 align=center><textarea name='wobs' cols=35 rows=5 class=tipo3 OnChange='enter()'></textarea></td></tr>";
			else
				echo "<td id=tipo9 align=center></td></tr>";
			if(isset($addX))
				echo "<tr><td id=tipo10 colspan=5 align=center>DIAGNOSTICOS<input type='checkbox' name='addX' checked></td></tr>";
			else
				echo "<tr><td id=tipo10 colspan=5 align=center>DIAGNOSTICOS<input type='checkbox' name='addX'></td></tr>";
			echo "</table><br><br>";
			// FIN TABLA DE MOTIVO DE CONSULTA Y DIAGNOSTICOS	
				
			$query = "select Mdxcon, Mdxpro, Mdxdes, Mdxobs from soe_000132 ";
			$query .= " where Mdxhis = '".$whis."' ";
			$query .= "   and Mdxing = '".$wing."' ";
			$err1 = mysql_query($query,$conex);
			$num2 = mysql_num_rows($err1);
			if($num2 > 0)
			{
				$se=0;
				$wdata=array();
				$wsuma=0;
				echo "<table border=0 align=center id=tipo1>";
				echo "<tr><td id=tipo10 colspan=8 align=center>MOTIVO DE CONSULTA Y DIAGNOSTICOS</td></tr>";
				echo "<tr><td id=tipo13 align=center>CONCEPTO</td><td id=tipo13 align=center>MOTIVO/DIAGNOSTICO</td><td id=tipo13 align=center>DESCRIPCION</td><td id=tipo13 align=center>OBSERVACION</td><td id=tipo13 align=center>BORRAR</td></tr>";
				for ($i=0;$i<$num2;$i++)
				{
					$row2 = mysql_fetch_array($err1);
					$se1=$i+1;
					$wdata1[$se1][0]=$row2[0];
					$wdata1[$se1][1]=$row2[1];
					$wdata1[$se1][2]=$row2[2];
					$wdata1[$se1][3]=$row2[3];
					if($wdata1[$se1][0] == "01")
						$color="tipo21";
					else
						if($wdata1[$se1][0] == "03")
							$color="tipo22";
						else
							if($i % 2 != 0)
								$color="tipo17";
							else
								$color="tipo16";
					echo "<tr><td id=".$color."A>".$wdata1[$se1][0]."</td><td id=".$color."A>".$wdata1[$se1][1]."</td><td id=".$color."B>".$wdata1[$se1][2]."</td><td id=".$color."A><textarea name='wdata1[".$se1."][3]' cols=60 rows=3 class=tipo3 onblur='enter()'>".$wdata1[$se1][3]."</textarea></td><td id=".$color."A><input type='checkbox' name='wdel[".$se1."]' OnClick='enter()'></td></tr>";
					echo "<input type='HIDDEN' name= 'wdata1[".$se1."][0]' value='".$wdata1[$se1][0]."'>";
					echo "<input type='HIDDEN' name= 'wdata1[".$se1."][1]' value='".$wdata1[$se1][1]."'>";
					echo "<input type='HIDDEN' name= 'wdata1[".$se1."][2]' value='".$wdata1[$se1][2]."'>";
				}
				echo "<tr><td id=tipo10 colspan=8>GRABAR EGRESO DEL PACIENTE<input type='checkbox' name='wegrT' OnClick='enter()'></td></tr>";
				echo "</table><br><br>";
			}
			$se1=$num2;
			echo "<input type='HIDDEN' name= 'se1' value='".$se1."'>";
			if(isset($werr) and isset($t) and $t > -1)
			{
				echo "<br><br><center><table border=0 aling=center>";
				for ($i=0;$i<=$t;$i++)
					if(substr($werr[$i],0,3) == "OK!")
					{
						echo "<tr><td id=tipo18A><IMG SRC='/matrix/images/medical/root/feliz.ico'></TD><TD id=tipo18A>".$werr[$i]."</td></tr>";
					}
					else
						echo "<tr><td id=tipo18B><IMG SRC='/matrix/images/medical/root/Malo.ico'></TD><TD id=tipo18B>".$werr[$i]."</td></tr>";
				echo "</table><br><br></center>";
			}/// CIERRE DE CICLO DE PROCESO DE FACTURACION
			
		} /// CIERRE DE CICLO DE VERIFICACION DE EXISTENCIA DE PACIENTE
		else
		{
			echo "<br><br><center><table border=0 aling=center>";
			echo "<tr><td align=center colspan=2><b>PROMOTORA MEDICA LAS AMERICAS S.A.<b></td></tr>";
			echo "<tr><td align=center colspan=2>ACTUALIZACION DE ODONTOGRAMA X PACIENTE</td></tr>";
			echo "<tr><td id=tipo18B><IMG SRC='/matrix/images/medical/root/Malo.ico'></TD><TD id=tipo18B>PACIENTE NO EXISTE O ESTA INACTIVO !!!!!</td></tr>";
			echo "<tr><td align=center colspan=2><input type='submit' value='ENTER'></td></tr>";
			echo "</table><br><br></center>";
		}
	}
}
?>
</body>
</html>